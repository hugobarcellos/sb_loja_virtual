[0m14:03:41.195110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4C7F13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4F1603D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B77BD30>]}


============================== 14:03:41.203622 | 2fd4bc1e-9a8e-4940-acf9-047ac4413aab ==============================
[0m14:03:41.203622 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:03:41.203622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\HTK1511\\.dbt', 'log_path': 'logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt init dbt_shibaribrasil', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:03:41.203622 [debug] [MainThread]: Starter project path: c:\users\htk1511\appdata\local\programs\python\python38\lib\site-packages\dbt\include\starter_project
[0m14:03:41.236090 [info ] [MainThread]: 
Your new dbt project "dbt_shibaribrasil" was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don't hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!

[0m14:03:41.236090 [info ] [MainThread]: Setting up your profile.
[0m14:04:41.944399 [info ] [MainThread]: Profile dbt_shibaribrasil written to C:\Users\HTK1511\.dbt\profiles.yml using target's profile_template.yml and your supplied values. Run 'dbt debug' to validate the connection.
[0m14:04:41.944399 [debug] [MainThread]: Command `dbt init` succeeded at 14:04:41.944399 after 60.81 seconds
[0m14:04:41.944399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4C7F13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B7508B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B750DF0>]}
[0m14:04:41.950169 [debug] [MainThread]: Flushing usage events
[0m14:11:10.949386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78A4A24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78CE0E3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78944CD60>]}


============================== 14:11:10.952387 | 54353fcf-58fa-4091-9db5-d2dcf888f2ed ==============================
[0m14:11:10.952387 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:11:10.953736 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\HTK1511\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:11:10.954248 [info ] [MainThread]: dbt version: 1.7.4
[0m14:11:10.954811 [info ] [MainThread]: python version: 3.8.10
[0m14:11:10.954811 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m14:11:10.954811 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m14:11:11.306482 [info ] [MainThread]: Using profiles dir at C:\Users\HTK1511\.dbt
[0m14:11:11.306482 [info ] [MainThread]: Using profiles.yml file at C:\Users\HTK1511\.dbt\profiles.yml
[0m14:11:11.307513 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_project.yml
[0m14:11:11.307513 [error] [MainThread]: Encountered an error:
Internal Error
  Profile should not be None if loading profile completed
[0m14:11:11.308487 [debug] [MainThread]: Command `dbt debug` failed at 14:11:11.308487 after 0.43 seconds
[0m14:11:11.308487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78A4A24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78DA578B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78DA7FFA0>]}
[0m14:11:11.309503 [debug] [MainThread]: Flushing usage events
[0m15:43:11.741179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B195AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B185396A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B18539DC0>]}


============================== 15:43:11.745929 | 426c619a-f98c-4bdc-9e81-72d4d3dab704 ==============================
[0m15:43:11.745929 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:43:11.746924 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:43:12.466269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1851C070>]}
[0m15:43:12.558209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CB04160>]}
[0m15:43:12.560203 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:43:12.567318 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:43:12.572828 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:43:12.574336 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m15:43:12.575343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CCADC10>]}
[0m15:43:13.396026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D127BE0>]}
[0m15:43:13.407152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D127EB0>]}
[0m15:43:13.408152 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:43:13.408152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CD09CD0>]}
[0m15:43:13.410151 [info ] [MainThread]: 
[0m15:43:13.410151 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:43:13.411658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:43:13.412661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:14.160451 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt-dw)
[0m15:43:14.162041 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt-dw"
"
[0m15:43:14.182015 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:43:14.186021 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt-dw: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt-dw"} */
create schema if not exists `igneous-sandbox-381622`.`dbt-dw`
  
[0m15:43:15.064474 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:bce3ed58-690b-4f0a-b0ba-bac3200d71e1&page=queryresults
[0m15:43:15.588452 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.')
[0m15:43:16.611281 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:34effebe-41b5-41f5-afec-9775f5f60d81&page=queryresults
[0m15:43:17.118211 [error] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:34effebe-41b5-41f5-afec-9775f5f60d81&page=queryresults
[0m15:43:17.120258 [debug] [ThreadPool]: BigQuery adapter: Unhandled error while running:
macro create_schema
[0m15:43:17.120258 [debug] [ThreadPool]: BigQuery adapter: Database Error
  Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:43:17.122915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:43:17.124439 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt-dw' was properly closed.
[0m15:43:17.125458 [info ] [MainThread]: 
[0m15:43:17.126461 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 3.72 seconds (3.72s).
[0m15:43:17.127458 [error] [MainThread]: Encountered an error:
Database Error
  Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:43:17.128459 [debug] [MainThread]: Command `dbt run` failed at 15:43:17.128459 after 5.45 seconds
[0m15:43:17.129460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B195AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D11EF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CFD0190>]}
[0m15:43:17.129460 [debug] [MainThread]: Flushing usage events
[0m15:43:51.803945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A48965460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A478E66A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A478E6DC0>]}


============================== 15:43:51.807971 | cef8ae93-7bf4-45d2-83da-892deadac52d ==============================
[0m15:43:51.807971 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:43:51.808968 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:43:52.319182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4AAACB80>]}
[0m15:43:52.389132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4B2A1370>]}
[0m15:43:52.390948 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:43:52.398160 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:43:52.428429 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:43:52.429043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C074E80>]}
[0m15:43:53.157971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C4D9AC0>]}
[0m15:43:53.167263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C4D9F70>]}
[0m15:43:53.168195 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:43:53.168195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C0B9D30>]}
[0m15:43:53.169193 [info ] [MainThread]: 
[0m15:43:53.170248 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:43:53.171689 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:43:53.172696 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:53.879897 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:43:53.881424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:54.627113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C3AB0D0>]}
[0m15:43:54.629128 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:43:54.630113 [info ] [MainThread]: 
[0m15:43:54.639137 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:43:54.640136 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:43:54.641135 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:43:54.641639 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:43:54.706319 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:43:54.707319 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:43:54.641639 => 15:43:54.707319
[0m15:43:54.708320 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:43:54.741926 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:43:54.749456 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:43:54.751459 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:43:55.691953 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:b2bb7859-f3d0-404c-9f65-53b9cf1b3acd&page=queryresults
[0m15:43:55.695530 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:43:55.697877 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd

[0m15:43:55.699872 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:43:54.708320 => 15:43:55.698864
[0m15:43:56.171335 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd
  
[0m15:43:56.171901 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C3D07F0>]}
[0m15:43:56.174577 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.53s]
[0m15:43:56.177194 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:43:56.182777 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:43:56.184299 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:43:56.185327 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:43:56.186376 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:43:56.187328 [info ] [MainThread]: 
[0m15:43:56.190323 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.02 seconds (3.02s).
[0m15:43:56.192770 [debug] [MainThread]: Command end result
[0m15:43:56.224287 [info ] [MainThread]: 
[0m15:43:56.227373 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:43:56.231378 [info ] [MainThread]: 
[0m15:43:56.234514 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd
  
[0m15:43:56.238696 [info ] [MainThread]: 
[0m15:43:56.241356 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:43:56.247995 [debug] [MainThread]: Command `dbt run` failed at 15:43:56.247047 after 4.51 seconds
[0m15:43:56.249463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A48965460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4B2A1370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C2D8F70>]}
[0m15:43:56.250639 [debug] [MainThread]: Flushing usage events
[0m15:46:17.770214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D832C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D72AF640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D72AFAC0>]}


============================== 15:46:17.774004 | 520f7f22-471b-4b5f-82a0-8bb4839cc9bb ==============================
[0m15:46:17.774004 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:46:17.775050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:46:18.434110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D729D100>]}
[0m15:46:18.519297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DB980100>]}
[0m15:46:18.520298 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:46:18.531859 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:46:18.638955 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:46:18.638955 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m15:46:18.656199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBC8EE80>]}
[0m15:46:18.666295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBB35790>]}
[0m15:46:18.667294 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:46:18.667294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DB9D5280>]}
[0m15:46:18.669310 [info ] [MainThread]: 
[0m15:46:18.669310 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:46:18.671299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:46:18.671811 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:19.397102 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:46:19.398116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:20.100201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA4B3A0>]}
[0m15:46:20.101198 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:46:20.101805 [info ] [MainThread]: 
[0m15:46:20.106406 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:46:20.107464 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:46:20.108413 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:46:20.108413 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:46:20.116023 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:46:20.118031 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:46:20.108413 => 15:46:20.118031
[0m15:46:20.119035 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:46:20.147592 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:46:20.149511 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:46:20.150533 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:21.038580 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:babd61c6-4db1-4280-b842-221033187c95&page=queryresults
[0m15:46:21.040573 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:21.043103 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: babd61c6-4db1-4280-b842-221033187c95

[0m15:46:21.045653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:46:20.119035 => 15:46:21.043103
[0m15:46:21.054348 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: babd61c6-4db1-4280-b842-221033187c95
  
[0m15:46:21.055860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBD31760>]}
[0m15:46:21.057875 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.95s]
[0m15:46:21.059882 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:46:21.065985 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:46:21.067120 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:46:21.068054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:46:21.068054 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:46:21.068054 [info ] [MainThread]: 
[0m15:46:21.069331 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.40 seconds (2.40s).
[0m15:46:21.070126 [debug] [MainThread]: Command end result
[0m15:46:21.089322 [info ] [MainThread]: 
[0m15:46:21.091305 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:46:21.091305 [info ] [MainThread]: 
[0m15:46:21.091305 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: babd61c6-4db1-4280-b842-221033187c95
  
[0m15:46:21.093103 [info ] [MainThread]: 
[0m15:46:21.094113 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:46:21.098121 [debug] [MainThread]: Command `dbt run` failed at 15:46:21.098121 after 3.39 seconds
[0m15:46:21.098121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D832C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA50640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA4B3A0>]}
[0m15:46:21.099115 [debug] [MainThread]: Flushing usage events
[0m15:46:44.485425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10D835460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C7B76A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C7B7DC0>]}


============================== 15:46:44.489984 | ec35f7f6-3453-45a1-93b1-69292bf85dff ==============================
[0m15:46:44.489984 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:46:44.489984 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m15:46:45.006117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E8E610>]}
[0m15:46:45.081533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C770F10>]}
[0m15:46:45.082539 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:46:45.091567 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:46:45.120299 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:46:45.121221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E6F2E0>]}
[0m15:46:45.895257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113AAE50>]}
[0m15:46:45.905316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113AAF40>]}
[0m15:46:45.905316 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:46:45.906315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E5BD60>]}
[0m15:46:45.907319 [info ] [MainThread]: 
[0m15:46:45.908152 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:46:45.909291 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:46:45.910302 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:46.675789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:46:46.679814 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:47.398016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113ABCA0>]}
[0m15:46:47.402566 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:46:47.405585 [info ] [MainThread]: 
[0m15:46:47.422019 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:46:47.424544 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:46:47.431645 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:46:47.437261 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:46:47.524322 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:46:47.525326 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:46:47.440275 => 15:46:47.525326
[0m15:46:47.526326 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:46:47.555414 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:46:47.556417 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:46:47.558424 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:48.412303 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:f5358fc2-9f34-4b11-b4f5-341201674673&page=queryresults
[0m15:46:48.414298 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:48.417341 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: f5358fc2-9f34-4b11-b4f5-341201674673

[0m15:46:48.419342 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:46:47.526326 => 15:46:48.418338
[0m15:46:48.437351 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f5358fc2-9f34-4b11-b4f5-341201674673
  
[0m15:46:48.439366 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1112A13A0>]}
[0m15:46:48.444416 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.01s]
[0m15:46:48.449989 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:46:48.459545 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:46:48.461506 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:46:48.462019 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:46:48.463031 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:46:48.463031 [info ] [MainThread]: 
[0m15:46:48.467211 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.55 seconds (2.55s).
[0m15:46:48.472406 [debug] [MainThread]: Command end result
[0m15:46:48.511282 [info ] [MainThread]: 
[0m15:46:48.511822 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:46:48.512827 [info ] [MainThread]: 
[0m15:46:48.516381 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f5358fc2-9f34-4b11-b4f5-341201674673
  
[0m15:46:48.519381 [info ] [MainThread]: 
[0m15:46:48.520364 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:46:48.522887 [debug] [MainThread]: Command `dbt run` failed at 15:46:48.521869 after 4.11 seconds
[0m15:46:48.524404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10D835460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E8E610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113B7AF0>]}
[0m15:46:48.526415 [debug] [MainThread]: Flushing usage events
[0m15:48:16.479044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559E024430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559CFAF640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559CFAFAC0>]}


============================== 15:48:16.482274 | 1a2b0f8f-20b5-4b45-b276-df5400af3316 ==============================
[0m15:48:16.482274 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:48:16.483260 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:48:16.978522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1687730>]}
[0m15:48:17.051654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A15EC460>]}
[0m15:48:17.053552 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:48:17.064436 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:48:17.092238 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:48:17.093252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A175EF40>]}
[0m15:48:17.824243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1BA7E80>]}
[0m15:48:17.832513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1BA7EE0>]}
[0m15:48:17.834021 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:48:17.834021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A163CD90>]}
[0m15:48:17.835029 [info ] [MainThread]: 
[0m15:48:17.837037 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:48:17.837975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:48:17.838982 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:19.070391 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_igneous-sandbox-381622)
[0m15:48:19.071389 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "igneous-sandbox-381622"
"
[0m15:48:19.080486 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:48:19.082014 [debug] [ThreadPool]: On create_igneous-sandbox-381622_igneous-sandbox-381622: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_igneous-sandbox-381622"} */
create schema if not exists `igneous-sandbox-381622`.`igneous-sandbox-381622`
  
[0m15:48:19.914342 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:32aa63d0-9aea-4c0c-8e25-22be0c9ef569&page=queryresults
[0m15:48:20.474611 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.')
[0m15:48:21.460562 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:684c3c3e-25f2-44ca-90ea-b4f60ab09220&page=queryresults
[0m15:48:21.934409 [error] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:684c3c3e-25f2-44ca-90ea-b4f60ab09220&page=queryresults
[0m15:48:21.937130 [debug] [ThreadPool]: BigQuery adapter: Unhandled error while running:
macro create_schema
[0m15:48:21.939155 [debug] [ThreadPool]: BigQuery adapter: Database Error
  Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:48:21.942844 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:21.944363 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_igneous-sandbox-381622' was properly closed.
[0m15:48:21.945885 [info ] [MainThread]: 
[0m15:48:21.948037 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 4.11 seconds (4.11s).
[0m15:48:21.950120 [error] [MainThread]: Encountered an error:
Database Error
  Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:48:21.953711 [debug] [MainThread]: Command `dbt run` failed at 15:48:21.952757 after 5.55 seconds
[0m15:48:21.954768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559E024430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1C18B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1B9FEE0>]}
[0m15:48:21.956338 [debug] [MainThread]: Flushing usage events
[0m15:51:43.102256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D34853D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D24042E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D2404760>]}


============================== 15:51:43.107311 | 3039e6a9-68b0-4432-afae-a8962e4d7eef ==============================
[0m15:51:43.107311 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:51:43.107311 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:51:43.599516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D2404940>]}
[0m15:51:43.667305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6AE4250>]}
[0m15:51:43.668626 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:51:43.676161 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:51:43.702979 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:51:43.702979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6B45B20>]}
[0m15:51:44.448499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6FF3850>]}
[0m15:51:44.457184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6FF3D00>]}
[0m15:51:44.458185 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:51:44.459184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6BB9550>]}
[0m15:51:44.459184 [info ] [MainThread]: 
[0m15:51:44.461184 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:51:44.462695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:51:44.462695 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:51:45.200133 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:51:45.200133 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:51:45.969357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6BACE50>]}
[0m15:51:45.970363 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:51:45.971867 [info ] [MainThread]: 
[0m15:51:45.977403 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:51:45.978401 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:51:45.979397 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:51:45.980397 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:51:46.042810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:51:46.044316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:51:45.980397 => 15:51:46.044316
[0m15:51:46.045329 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:51:46.067366 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:51:46.068362 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:51:46.069275 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:51:47.003293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:f3965339-5cdc-4ddb-b67d-39a8ca37cf80&page=queryresults
[0m15:51:47.005267 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:51:47.006823 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80

[0m15:51:47.008913 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:51:46.045329 => 15:51:47.007871
[0m15:51:47.019636 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80
  
[0m15:51:47.020691 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6C2C8B0>]}
[0m15:51:47.022314 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.04s]
[0m15:51:47.025321 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:51:47.030403 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:51:47.031453 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:51:47.032485 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:51:47.033482 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:51:47.036507 [info ] [MainThread]: 
[0m15:51:47.040528 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.58 seconds (2.58s).
[0m15:51:47.045581 [debug] [MainThread]: Command end result
[0m15:51:47.072832 [info ] [MainThread]: 
[0m15:51:47.072832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:51:47.074138 [info ] [MainThread]: 
[0m15:51:47.075160 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80
  
[0m15:51:47.076155 [info ] [MainThread]: 
[0m15:51:47.077155 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:51:47.079244 [debug] [MainThread]: Command `dbt run` failed at 15:51:47.078147 after 4.04 seconds
[0m15:51:47.079244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D34853D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6AE4250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6D6A730>]}
[0m15:51:47.080241 [debug] [MainThread]: Flushing usage events
[0m15:54:41.887402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976F4A5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E4079A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E407D30>]}


============================== 15:54:41.891401 | c201d063-655e-4293-aa53-93aa4b193861 ==============================
[0m15:54:41.891401 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:54:41.891887 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:54:42.380060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E407D90>]}
[0m15:54:42.449243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772B10940>]}
[0m15:54:42.450241 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:54:42.458229 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:54:42.492886 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:54:42.492886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772B75A30>]}
[0m15:54:43.220450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773013BB0>]}
[0m15:54:43.229075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773013FA0>]}
[0m15:54:43.229075 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:54:43.230095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772BFBD90>]}
[0m15:54:43.231602 [info ] [MainThread]: 
[0m15:54:43.231602 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:43.234122 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dbt_dw'
[0m15:54:43.235139 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:43.962144 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest("GET https://bigquery.googleapis.com/bigquery/v2/projects/dbt_dw/datasets?maxResults=10000&prettyPrint=false: Invalid project ID 'dbt_dw'. Project IDs must contain 6-63 lowercase letters, digits, or dashes. Some project IDs also include domain name separated by a colon. IDs must start with a letter and may not end with a dash.")
[0m15:54:44.998250 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:44.999316 [debug] [MainThread]: Connection 'list_dbt_dw' was properly closed.
[0m15:54:45.001301 [info ] [MainThread]: 
[0m15:54:45.003028 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 1.77 seconds (1.77s).
[0m15:54:45.005577 [error] [MainThread]: Encountered an error:
Database Error
  Invalid project ID 'dbt_dw'. Project IDs must contain 6-63 lowercase letters, digits, or dashes. Some project IDs also include domain name separated by a colon. IDs must start with a letter and may not end with a dash.
[0m15:54:45.009625 [debug] [MainThread]: Command `dbt run` failed at 15:54:45.008618 after 3.22 seconds
[0m15:54:45.010659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976F4A5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773021100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772A72DF0>]}
[0m15:54:45.011616 [debug] [MainThread]: Flushing usage events
[0m15:54:54.700609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C49ED400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C397F640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C397FAC0>]}


============================== 15:54:54.705287 | e60cb4ac-f669-4665-8edb-cfbd707325a1 ==============================
[0m15:54:54.705287 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:54:54.706231 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:54:55.297224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C395C910>]}
[0m15:54:55.370390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8124160>]}
[0m15:54:55.371390 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:54:55.380205 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:54:55.402385 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:54:55.403365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C7FE1A60>]}
[0m15:54:56.151360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8561400>]}
[0m15:54:56.160486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8561B20>]}
[0m15:54:56.161483 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:54:56.162002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C80A3E20>]}
[0m15:54:56.163064 [info ] [MainThread]: 
[0m15:54:56.163064 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:56.166191 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:54:56.166191 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:56.907634 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:54:56.907634 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:57.589903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C857A5B0>]}
[0m15:54:57.592472 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:54:57.593515 [info ] [MainThread]: 
[0m15:54:57.599985 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:54:57.599985 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:54:57.601605 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:54:57.603626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:54:57.662890 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:54:57.665405 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:54:57.605612 => 15:54:57.664397
[0m15:54:57.665405 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:54:57.687469 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:54:57.688470 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:54:57.689469 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:54:58.708374 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:4acda73e-f5ce-4fa3-93b3-34cad23a7ba7&page=queryresults
[0m15:54:58.709330 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:54:58.710402 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7

[0m15:54:58.712063 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:54:57.666408 => 15:54:58.711405
[0m15:54:58.722518 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7
  
[0m15:54:58.723513 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C83DD580>]}
[0m15:54:58.724540 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.12s]
[0m15:54:58.726734 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:54:58.730017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:58.731628 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:54:58.732643 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:54:58.732643 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:54:58.733643 [info ] [MainThread]: 
[0m15:54:58.736218 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.57 seconds (2.57s).
[0m15:54:58.739238 [debug] [MainThread]: Command end result
[0m15:54:58.752003 [info ] [MainThread]: 
[0m15:54:58.753016 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:54:58.753016 [info ] [MainThread]: 
[0m15:54:58.753016 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7
  
[0m15:54:58.755548 [info ] [MainThread]: 
[0m15:54:58.757533 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:54:58.758532 [debug] [MainThread]: Command `dbt run` failed at 15:54:58.758532 after 4.12 seconds
[0m15:54:58.758532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C49ED400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C80A3E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C85614F0>]}
[0m15:54:58.759534 [debug] [MainThread]: Flushing usage events
[0m15:58:25.102787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023877624400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5AC0>]}


============================== 15:58:25.109349 | 41ffa16b-6320-44df-b9f5-41c89e0ec7a2 ==============================
[0m15:58:25.109349 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:58:25.109349 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:58:25.638261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5DC0>]}
[0m15:58:25.711848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC8DE20>]}
[0m15:58:25.712851 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:58:25.720472 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:58:25.749544 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:58:25.750548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD4F970>]}
[0m15:58:26.505516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387B194DF0>]}
[0m15:58:26.513035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387B194D00>]}
[0m15:58:26.514543 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:58:26.515553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD74910>]}
[0m15:58:26.516560 [info ] [MainThread]: 
[0m15:58:26.517558 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:58:26.519558 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:58:26.519558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:58:27.299875 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:58:27.299875 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:58:28.190502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC1E070>]}
[0m15:58:28.192221 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:58:28.193255 [info ] [MainThread]: 
[0m15:58:28.203373 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:58:28.207404 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:58:28.209392 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:58:28.210390 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:58:28.286443 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:58:28.287444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:58:28.210390 => 15:58:28.287444
[0m15:58:28.287444 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:58:28.309495 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:58:28.310496 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:58:28.311495 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:58:29.151378 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e974060f-dfbc-489c-8a85-4a308fdbc7ba&page=queryresults
[0m15:58:29.153011 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:58:29.154555 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4

Location: us-east4
Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba

[0m15:58:29.157592 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:58:28.287444 => 15:58:29.156577
[0m15:58:29.172556 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4
  
  Location: us-east4
  Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba
  
[0m15:58:29.174991 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AEC2D60>]}
[0m15:58:29.177652 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.97s]
[0m15:58:29.180652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:58:29.187500 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:58:29.189564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:58:29.189564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:58:29.190551 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:58:29.191550 [info ] [MainThread]: 
[0m15:58:29.193147 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.67 seconds (2.67s).
[0m15:58:29.198536 [debug] [MainThread]: Command end result
[0m15:58:29.236877 [info ] [MainThread]: 
[0m15:58:29.238814 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:58:29.239820 [info ] [MainThread]: 
[0m15:58:29.243641 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4
  
  Location: us-east4
  Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba
  
[0m15:58:29.247669 [info ] [MainThread]: 
[0m15:58:29.249723 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:58:29.250714 [debug] [MainThread]: Command `dbt run` failed at 15:58:29.250714 after 4.26 seconds
[0m15:58:29.251728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023877624400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC8DE20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD4F1C0>]}
[0m15:58:29.252323 [debug] [MainThread]: Flushing usage events
[0m16:01:17.323292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA74D1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA64739D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA6473B80>]}


============================== 16:01:17.327276 | 0458d4ff-f421-491b-a9e8-0215bd71bcfe ==============================
[0m16:01:17.327276 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:01:17.328273 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models testetabela', 'send_anonymous_usage_stats': 'True'}
[0m16:01:17.820257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA645B130>]}
[0m16:01:17.896199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAB5F8B0>]}
[0m16:01:17.898109 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:01:17.905821 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:01:17.934472 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:01:17.935461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAAEAC40>]}
[0m16:01:18.713297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAB061A00>]}
[0m16:01:18.721711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAB061EB0>]}
[0m16:01:18.722723 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:01:18.722723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAAB30D0>]}
[0m16:01:18.725289 [info ] [MainThread]: 
[0m16:01:18.726244 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:01:18.727246 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:01:18.727246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:19.612733 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:01:19.615315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:20.320555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAF45DF0>]}
[0m16:01:20.322132 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:01:20.323138 [info ] [MainThread]: 
[0m16:01:20.329574 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:01:20.330585 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:01:20.332210 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:01:20.333215 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:01:20.395421 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:01:20.396422 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:01:20.333215 => 16:01:20.396422
[0m16:01:20.396422 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:01:20.419466 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:01:20.420467 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:01:20.421972 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:01:21.578505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:5d2fc881-f7d6-4d6d-8879-5dfaa1400987&page=queryresults
[0m16:01:21.582027 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:01:21.583050 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987

[0m16:01:21.587633 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:01:20.396422 => 16:01:21.584572
[0m16:01:21.607833 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987
  
[0m16:01:21.608833 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAC9AE80>]}
[0m16:01:21.609838 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.28s]
[0m16:01:21.612368 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:01:21.617899 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:21.618898 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:21.619897 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:01:21.619897 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:01:21.619897 [info ] [MainThread]: 
[0m16:01:21.622422 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.89 seconds (2.89s).
[0m16:01:21.627422 [debug] [MainThread]: Command end result
[0m16:01:21.642536 [info ] [MainThread]: 
[0m16:01:21.643539 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:01:21.645537 [info ] [MainThread]: 
[0m16:01:21.647535 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987
  
[0m16:01:21.648540 [info ] [MainThread]: 
[0m16:01:21.648540 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:01:21.650538 [debug] [MainThread]: Command `dbt run` failed at 16:01:21.650538 after 4.39 seconds
[0m16:01:21.651535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA74D1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAC27CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAE71C40>]}
[0m16:01:21.652043 [debug] [MainThread]: Flushing usage events
[0m16:03:23.120247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA72913D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA62392E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA6239760>]}


============================== 16:03:23.124215 | b0c668fa-7a21-44f4-a60f-0c75abc504f7 ==============================
[0m16:03:23.124215 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:03:23.125289 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:03:23.625441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA621CA60>]}
[0m16:03:23.689402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA9F7E50>]}
[0m16:03:23.691357 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:03:23.699381 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:03:23.778506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:03:23.778506 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:03:23.783019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAABA8310>]}
[0m16:03:23.792054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAAC8190>]}
[0m16:03:23.792054 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:03:23.792920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAAC80D0>]}
[0m16:03:23.792920 [info ] [MainThread]: 
[0m16:03:23.795485 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:03:23.797514 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:03:23.797514 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:24.500377 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:03:24.501416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:25.127508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA979340>]}
[0m16:03:25.128514 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:03:25.129576 [info ] [MainThread]: 
[0m16:03:25.135313 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:03:25.136339 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:03:25.137346 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:03:25.137346 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:03:25.148544 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:03:25.149605 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:03:25.138335 => 16:03:25.149605
[0m16:03:25.149605 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:03:25.178648 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:03:25.179707 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:03:25.180654 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:25.918504 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:03bc919a-ebee-4b6a-a967-c597897b5e3a&page=queryresults
[0m16:03:25.919610 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:25.920596 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US

Location: US
Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a

[0m16:03:25.920596 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:03:25.150568 => 16:03:25.920596
[0m16:03:25.926374 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a
  
[0m16:03:25.926374 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAABB3FA0>]}
[0m16:03:25.926374 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.79s]
[0m16:03:25.928443 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:03:25.930659 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:03:25.930659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:03:25.930659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:03:25.931657 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:03:25.931657 [info ] [MainThread]: 
[0m16:03:25.932380 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.14 seconds (2.14s).
[0m16:03:25.935409 [debug] [MainThread]: Command end result
[0m16:03:25.942792 [info ] [MainThread]: 
[0m16:03:25.945309 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:03:25.946316 [info ] [MainThread]: 
[0m16:03:25.947313 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a
  
[0m16:03:25.947313 [info ] [MainThread]: 
[0m16:03:25.948493 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:03:25.949498 [debug] [MainThread]: Command `dbt run` failed at 16:03:25.949498 after 2.89 seconds
[0m16:03:25.949498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA72913D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA9F7E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAC23FD0>]}
[0m16:03:25.949498 [debug] [MainThread]: Flushing usage events
[0m16:03:54.888290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F264C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F254479D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F25447B80>]}


============================== 16:03:54.891322 | d854b771-54a2-412a-8e26-7bbe51dd03d5 ==============================
[0m16:03:54.891322 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:03:54.892620 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models testetabela', 'send_anonymous_usage_stats': 'True'}
[0m16:03:55.408377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F2543C130>]}
[0m16:03:55.475015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29B4F8B0>]}
[0m16:03:55.476568 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:03:55.482729 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:03:55.536478 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:03:55.536478 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:03:55.540472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DD6DF0>]}
[0m16:03:55.549583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29C65A00>]}
[0m16:03:55.550604 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:03:55.550604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29C65100>]}
[0m16:03:55.552223 [info ] [MainThread]: 
[0m16:03:55.553228 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:03:55.554790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:03:55.554790 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:56.211512 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:03:56.213727 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:56.966694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DD6E80>]}
[0m16:03:56.967699 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:03:56.967699 [info ] [MainThread]: 
[0m16:03:56.979733 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:03:56.980732 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:03:56.981732 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:03:56.982236 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:03:56.989770 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:03:56.990769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:03:56.982236 => 16:03:56.990769
[0m16:03:56.990769 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:03:57.044528 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:03:57.046540 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:03:57.049543 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:57.967591 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c&page=queryresults
[0m16:03:57.968586 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:57.969586 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US

Location: US
Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c

[0m16:03:57.970585 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:03:56.991778 => 16:03:57.969586
[0m16:03:57.974619 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c
  
[0m16:03:57.976627 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DC1730>]}
[0m16:03:57.976627 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.99s]
[0m16:03:57.978136 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:03:57.980181 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:03:57.980181 [info ] [MainThread]: 
[0m16:03:57.981689 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.43 seconds (2.43s).
[0m16:03:57.982702 [debug] [MainThread]: Command end result
[0m16:03:57.989805 [info ] [MainThread]: 
[0m16:03:57.990767 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:03:57.991770 [info ] [MainThread]: 
[0m16:03:57.991770 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c
  
[0m16:03:57.991770 [info ] [MainThread]: 
[0m16:03:57.993018 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:03:57.994529 [debug] [MainThread]: Command `dbt run` failed at 16:03:57.994529 after 3.17 seconds
[0m16:03:57.995541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F264C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29A5B250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29ADBCA0>]}
[0m16:03:57.996544 [debug] [MainThread]: Flushing usage events
[0m16:04:05.331279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE790DB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE780539A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE78053D30>]}


============================== 16:04:05.335459 | 8f7a85b2-87be-4046-9a2b-a92b1542fa8f ==============================
[0m16:04:05.335459 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:04:05.336491 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:04:05.815296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6C9580>]}
[0m16:04:05.881721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C63EA60>]}
[0m16:04:05.883381 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:04:05.890444 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:04:05.897655 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:04:05.898639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6B76D0>]}
[0m16:04:06.789812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC52EB0>]}
[0m16:04:06.801438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC52E20>]}
[0m16:04:06.801438 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:04:06.802989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C7CEFA0>]}
[0m16:04:06.804509 [info ] [MainThread]: 
[0m16:04:06.805698 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:04:06.808170 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:04:06.808170 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:07.474747 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:04:07.477403 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:08.285404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC50790>]}
[0m16:04:08.288411 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:04:08.291430 [info ] [MainThread]: 
[0m16:04:08.305649 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:04:08.307652 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:04:08.310651 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:04:08.313198 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:04:08.400806 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:04:08.401805 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:04:08.319310 => 16:04:08.401805
[0m16:04:08.403118 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:04:08.427489 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:04:08.428489 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:04:08.429391 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:04:09.419615 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:21808c7b-9da6-4242-bac5-7425f6079069&page=queryresults
[0m16:04:09.859428 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cliente at [10:3]')
[0m16:04:10.462869 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3550af82-10c8-4988-bfc3-21bb4b022f5f&page=queryresults
[0m16:04:10.869149 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3550af82-10c8-4988-bfc3-21bb4b022f5f&page=queryresults
[0m16:04:10.872717 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:04:08.403118 => 16:04:10.871688
[0m16:04:10.882606 [debug] [Thread-1  ]: Database Error in model testetabela (models\1.stg\testetabela.sql)
  Unrecognized name: cliente at [10:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\testetabela.sql
[0m16:04:10.884591 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CB511C0>]}
[0m16:04:10.886653 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 2.57s]
[0m16:04:10.888646 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:04:10.890648 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:04:10.890648 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:04:10.891644 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:04:10.891644 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:04:10.892156 [info ] [MainThread]: 
[0m16:04:10.892156 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.09 seconds (4.09s).
[0m16:04:10.895714 [debug] [MainThread]: Command end result
[0m16:04:10.909299 [info ] [MainThread]: 
[0m16:04:10.909299 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:04:10.910297 [info ] [MainThread]: 
[0m16:04:10.911818 [error] [MainThread]:   Database Error in model testetabela (models\1.stg\testetabela.sql)
  Unrecognized name: cliente at [10:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\testetabela.sql
[0m16:04:10.911818 [info ] [MainThread]: 
[0m16:04:10.912829 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:04:10.915352 [debug] [MainThread]: Command `dbt run` failed at 16:04:10.914339 after 5.65 seconds
[0m16:04:10.915352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE790DB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CA5B820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6CE0D0>]}
[0m16:04:10.916347 [debug] [MainThread]: Flushing usage events
[0m16:04:31.333318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC23C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC13639D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC1363B80>]}


============================== 16:04:31.337278 | 4c75a5ea-2694-4f7d-b0ba-c1cabb224c17 ==============================
[0m16:04:31.337278 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:04:31.338404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:04:31.863026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC134C0A0>]}
[0m16:04:31.942839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5937DF0>]}
[0m16:04:31.942839 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:04:31.950610 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:04:32.046357 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:04:32.047414 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\testetabela.sql
[0m16:04:32.164439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5E78430>]}
[0m16:04:32.178532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5B64850>]}
[0m16:04:32.179535 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:04:32.180537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5B0CE80>]}
[0m16:04:32.181536 [info ] [MainThread]: 
[0m16:04:32.183077 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:04:32.184585 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:04:32.185593 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:32.799593 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:04:32.800593 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:33.501717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5A8D1C0>]}
[0m16:04:33.501717 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:04:33.502882 [info ] [MainThread]: 
[0m16:04:33.509400 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:04:33.510400 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:04:33.511403 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:04:33.511913 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:04:33.519425 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:04:33.520425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:04:33.511913 => 16:04:33.520425
[0m16:04:33.520425 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:04:33.550557 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:04:33.551559 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:04:33.553076 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:04:34.333065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:81ad8f51-35c9-4a5a-8094-1f9c7ab6ef24&page=queryresults
[0m16:04:34.829599 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:04:33.520425 => 16:04:34.828560
[0m16:04:34.830603 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC59A5A90>]}
[0m16:04:34.832174 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw.testetabela ............................ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m16:04:34.838384 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:04:34.852799 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:04:34.852799 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:04:34.852799 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:04:34.855855 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:04:34.859321 [info ] [MainThread]: 
[0m16:04:34.862865 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.68 seconds (2.68s).
[0m16:04:34.868752 [debug] [MainThread]: Command end result
[0m16:04:34.897546 [info ] [MainThread]: 
[0m16:04:34.898805 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:04:34.899906 [info ] [MainThread]: 
[0m16:04:34.901478 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:04:34.903506 [debug] [MainThread]: Command `dbt run` succeeded at 16:04:34.902510 after 3.64 seconds
[0m16:04:34.903506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC23C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5A931C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5ACDAF0>]}
[0m16:04:34.903506 [debug] [MainThread]: Flushing usage events
[0m16:06:47.000245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC68C21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB09D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB0B80>]}


============================== 16:06:47.005512 | d77a3bc3-47e3-4de0-810e-462ae5d7db7f ==============================
[0m16:06:47.005512 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:06:47.005512 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:06:47.506781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BAC130>]}
[0m16:06:47.578621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB0190>]}
[0m16:06:47.579704 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:06:47.587598 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:06:47.613574 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m16:06:47.615686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C310B50>]}
[0m16:06:48.493051 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:06:48.497626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C7B1730>]}
[0m16:06:48.506400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C7B1BE0>]}
[0m16:06:48.507401 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:06:48.507401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C38DC10>]}
[0m16:06:48.508404 [info ] [MainThread]: 
[0m16:06:48.509410 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:06:48.510422 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:06:48.510422 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:49.288624 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_stg)
[0m16:06:49.290618 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_stg"
"
[0m16:06:49.307730 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:06:49.309730 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_stg: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_stg"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_stg`
  
[0m16:06:50.098472 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87b85be2-d90e-4f80-a4a4-9d4782ea3e82&page=queryresults
[0m16:06:51.018609 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:06:51.018609 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:51.652381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C6AF940>]}
[0m16:06:51.653388 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:06:51.655390 [info ] [MainThread]: 
[0m16:06:51.666513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:06:51.670540 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.testetabela ............................. [RUN]
[0m16:06:51.676620 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:06:51.679640 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:06:51.710614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:06:51.711617 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:06:51.681641 => 16:06:51.710614
[0m16:06:51.712140 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:06:51.734720 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:06:51.736735 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:06:51.737736 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:06:52.568811 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:667f0c32-8cf1-42ca-b6f8-7c3520176a89&page=queryresults
[0m16:06:53.005458 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:06:51.712140 => 16:06:53.004494
[0m16:06:53.005458 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C6E1E50>]}
[0m16:06:53.006541 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.testetabela ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m16:06:53.007443 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:06:53.009451 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:06:53.010447 [info ] [MainThread]: 
[0m16:06:53.010447 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.50 seconds (4.50s).
[0m16:06:53.011466 [debug] [MainThread]: Command end result
[0m16:06:53.023056 [info ] [MainThread]: 
[0m16:06:53.024568 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:06:53.026579 [info ] [MainThread]: 
[0m16:06:53.027591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:06:53.030588 [debug] [MainThread]: Command `dbt run` succeeded at 16:06:53.029591 after 6.15 seconds
[0m16:06:53.030588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC68C21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C38DC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C363670>]}
[0m16:06:53.030588 [debug] [MainThread]: Flushing usage events
[0m16:18:19.737689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378586C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237847A07C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237847A04C0>]}


============================== 16:18:19.740751 | 2e97a673-c63f-45c6-a026-4e7f020cbfe8 ==============================
[0m16:18:19.740751 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:18:19.741619 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:18:19.741619 [info ] [MainThread]: dbt version: 1.7.4
[0m16:18:19.742890 [info ] [MainThread]: python version: 3.8.10
[0m16:18:19.743710 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:18:19.744728 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:18:19.745783 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil
[0m16:18:19.745783 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml
[0m16:18:19.746794 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:18:19.828518 [info ] [MainThread]: Configuration:
[0m16:18:19.828518 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m16:18:19.829521 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:18:19.829521 [info ] [MainThread]: Required dependencies:
[0m16:18:19.830521 [debug] [MainThread]: Executing "git --help"
[0m16:18:19.870409 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:18:19.870409 [debug] [MainThread]: STDERR: "b''"
[0m16:18:19.870409 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:18:19.871955 [info ] [MainThread]: Connection test skipped since no profile was found
[0m16:18:19.871955 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:18:19.873039 [info ] [MainThread]: dbt looked for a profiles.yml file in C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m16:18:19.875673 [debug] [MainThread]: Command `dbt debug` failed at 16:18:19.874610 after 0.17 seconds
[0m16:18:19.875673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378586C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237882047C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378821CF40>]}
[0m16:18:19.876625 [debug] [MainThread]: Flushing usage events
[0m16:18:29.842009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B259D460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B4EEEB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B151DFD0>]}


============================== 16:18:29.846532 | 8ddbe58a-7a8a-4d69-9b16-2be1f378525a ==============================
[0m16:18:29.846532 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:18:29.847540 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:18:29.847540 [info ] [MainThread]: dbt version: 1.7.4
[0m16:18:29.848724 [info ] [MainThread]: python version: 3.8.10
[0m16:18:29.848724 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:18:29.849731 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:18:30.238866 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:18:30.239910 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:18:30.239910 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:18:30.242455 [info ] [MainThread]: adapter type: bigquery
[0m16:18:30.242455 [info ] [MainThread]: adapter version: 1.7.2
[0m16:18:30.347885 [info ] [MainThread]: Configuration:
[0m16:18:30.348996 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:18:30.348996 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:18:30.350003 [info ] [MainThread]: Required dependencies:
[0m16:18:30.350003 [debug] [MainThread]: Executing "git --help"
[0m16:18:30.385558 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:18:30.386556 [debug] [MainThread]: STDERR: "b''"
[0m16:18:30.387558 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:18:30.388555 [info ] [MainThread]: Connection:
[0m16:18:30.388555 [info ] [MainThread]:   method: service-account
[0m16:18:30.389556 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:18:30.389556 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:18:30.390555 [info ] [MainThread]:   schema: dbt_dw
[0m16:18:30.391554 [info ] [MainThread]:   location: us-east4
[0m16:18:30.391554 [info ] [MainThread]:   priority: None
[0m16:18:30.391554 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:18:30.392894 [info ] [MainThread]:   impersonate_service_account: None
[0m16:18:30.392894 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:18:30.394403 [info ] [MainThread]:   job_retries: 1
[0m16:18:30.395414 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:18:30.396422 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:18:30.397413 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:18:30.398414 [info ] [MainThread]:   timeout_seconds: None
[0m16:18:30.398414 [info ] [MainThread]:   refresh_token: None
[0m16:18:30.399410 [info ] [MainThread]:   client_id: None
[0m16:18:30.399410 [info ] [MainThread]:   token_uri: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_region: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:18:30.400412 [info ] [MainThread]:   gcs_bucket: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_batch: None
[0m16:18:30.401917 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:18:30.401917 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:18:30.402924 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:18:30.404432 [debug] [MainThread]: On debug: select 1 as id
[0m16:18:30.681140 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m16:18:30.682756 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:18:30.684767 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Runtime Error
  Unable to generate access token, if you're using impersonate_service_account, make sure your initial account has the "roles/iam.serviceAccountTokenCreator" role on the account you are trying to impersonate.
  
  ('invalid_grant: Invalid JWT Signature.', {'error': 'invalid_grant', 'error_description': 'Invalid JWT Signature.'})

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m16:18:30.689316 [debug] [MainThread]: Command `dbt debug` failed at 16:18:30.688322 after 0.91 seconds
[0m16:18:30.689316 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:18:30.690315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B259D460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B5AFCD60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B5BCC460>]}
[0m16:18:30.690315 [debug] [MainThread]: Flushing usage events
[0m16:20:43.252890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88E151460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E890ABCBB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88D0FAFD0>]}


============================== 16:20:43.256433 | 18036055-fe7d-4974-9bb2-c48fed3333ea ==============================
[0m16:20:43.256433 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:20:43.257446 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:20:43.257446 [info ] [MainThread]: dbt version: 1.7.4
[0m16:20:43.258426 [info ] [MainThread]: python version: 3.8.10
[0m16:20:43.258426 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:20:43.259419 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:20:43.652352 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:20:43.653347 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:20:43.653347 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:20:43.654852 [info ] [MainThread]: adapter type: bigquery
[0m16:20:43.655860 [info ] [MainThread]: adapter version: 1.7.2
[0m16:20:43.764414 [info ] [MainThread]: Configuration:
[0m16:20:43.764414 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:20:43.765424 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:20:43.766422 [info ] [MainThread]: Required dependencies:
[0m16:20:43.766422 [debug] [MainThread]: Executing "git --help"
[0m16:20:43.798162 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:20:43.798162 [debug] [MainThread]: STDERR: "b''"
[0m16:20:43.799154 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:20:43.799154 [info ] [MainThread]: Connection:
[0m16:20:43.800157 [info ] [MainThread]:   method: service-account
[0m16:20:43.800157 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:20:43.800157 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:20:43.801673 [info ] [MainThread]:   schema: dbt_dw
[0m16:20:43.801673 [info ] [MainThread]:   location: us-east4
[0m16:20:43.801673 [info ] [MainThread]:   priority: None
[0m16:20:43.802730 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:20:43.802730 [info ] [MainThread]:   impersonate_service_account: None
[0m16:20:43.803936 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:20:43.805015 [info ] [MainThread]:   job_retries: 1
[0m16:20:43.805015 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:20:43.805015 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:20:43.806527 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:20:43.807590 [info ] [MainThread]:   timeout_seconds: None
[0m16:20:43.807590 [info ] [MainThread]:   refresh_token: None
[0m16:20:43.808604 [info ] [MainThread]:   client_id: None
[0m16:20:43.809551 [info ] [MainThread]:   token_uri: None
[0m16:20:43.809551 [info ] [MainThread]:   dataproc_region: None
[0m16:20:43.809551 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:20:43.810603 [info ] [MainThread]:   gcs_bucket: None
[0m16:20:43.810603 [info ] [MainThread]:   dataproc_batch: None
[0m16:20:43.811598 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:20:43.812750 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:20:43.812750 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:20:43.815715 [debug] [MainThread]: On debug: select 1 as id
[0m16:20:44.081612 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m16:20:44.083137 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:20:44.085673 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Runtime Error
  Unable to generate access token, if you're using impersonate_service_account, make sure your initial account has the "roles/iam.serviceAccountTokenCreator" role on the account you are trying to impersonate.
  
  ('invalid_grant: Invalid JWT Signature.', {'error': 'invalid_grant', 'error_description': 'Invalid JWT Signature.'})

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m16:20:44.088670 [debug] [MainThread]: Command `dbt debug` failed at 16:20:44.088670 after 0.90 seconds
[0m16:20:44.089669 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:20:44.089669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88E151460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88D0CA280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E8916F7CD0>]}
[0m16:20:44.090668 [debug] [MainThread]: Flushing usage events
[0m16:21:40.284504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021303AF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130645CC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021302A98D30>]}


============================== 16:21:40.288538 | abe9bf46-cedb-4761-833c-074349741041 ==============================
[0m16:21:40.288538 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:21:40.289279 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:21:40.289279 [info ] [MainThread]: dbt version: 1.7.4
[0m16:21:40.290383 [info ] [MainThread]: python version: 3.8.10
[0m16:21:40.290383 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:21:40.290383 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:21:40.667762 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:21:40.667762 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:21:40.668719 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:21:40.669721 [info ] [MainThread]: adapter type: bigquery
[0m16:21:40.669721 [info ] [MainThread]: adapter version: 1.7.2
[0m16:21:40.773530 [info ] [MainThread]: Configuration:
[0m16:21:40.774440 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:21:40.775482 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:21:40.775482 [info ] [MainThread]: Required dependencies:
[0m16:21:40.776444 [debug] [MainThread]: Executing "git --help"
[0m16:21:40.803286 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:21:40.803286 [debug] [MainThread]: STDERR: "b''"
[0m16:21:40.803286 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:21:40.804806 [info ] [MainThread]: Connection:
[0m16:21:40.805822 [info ] [MainThread]:   method: service-account
[0m16:21:40.806829 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:21:40.807878 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:21:40.807878 [info ] [MainThread]:   schema: dbt_dw
[0m16:21:40.808846 [info ] [MainThread]:   location: us-east4
[0m16:21:40.808846 [info ] [MainThread]:   priority: None
[0m16:21:40.809844 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:21:40.810845 [info ] [MainThread]:   impersonate_service_account: None
[0m16:21:40.810845 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:21:40.811842 [info ] [MainThread]:   job_retries: 1
[0m16:21:40.811842 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:21:40.813293 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:21:40.813293 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:21:40.813293 [info ] [MainThread]:   timeout_seconds: None
[0m16:21:40.814805 [info ] [MainThread]:   refresh_token: None
[0m16:21:40.815821 [info ] [MainThread]:   client_id: None
[0m16:21:40.816818 [info ] [MainThread]:   token_uri: None
[0m16:21:40.816818 [info ] [MainThread]:   dataproc_region: None
[0m16:21:40.817828 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:21:40.818840 [info ] [MainThread]:   gcs_bucket: None
[0m16:21:40.818840 [info ] [MainThread]:   dataproc_batch: None
[0m16:21:40.819837 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:21:40.820380 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:21:40.820380 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:21:40.821906 [debug] [MainThread]: On debug: select 1 as id
[0m16:21:42.716973 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e8240f7-3a1e-4d92-b935-a5ebc138e3d3&page=queryresults
[0m16:21:43.226776 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:21:43.228755 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:21:43.230350 [debug] [MainThread]: Command `dbt debug` succeeded at 16:21:43.229334 after 3.01 seconds
[0m16:21:43.230350 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:21:43.230350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021303AF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213070C2490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021307136CA0>]}
[0m16:21:43.231862 [debug] [MainThread]: Flushing usage events
[0m16:21:55.037612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020990D6B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098FCB07F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098FCB04F0>]}


============================== 16:21:55.040661 | 1dd28214-a494-425e-ba6b-f02a3729d365 ==============================
[0m16:21:55.040661 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:21:55.041696 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:21:55.042941 [info ] [MainThread]: dbt version: 1.7.4
[0m16:21:55.042941 [info ] [MainThread]: python version: 3.8.10
[0m16:21:55.042941 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:21:55.044449 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:21:55.045466 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil
[0m16:21:55.045466 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml
[0m16:21:55.046516 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:21:55.129641 [info ] [MainThread]: Configuration:
[0m16:21:55.129641 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m16:21:55.130578 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:21:55.130578 [info ] [MainThread]: Required dependencies:
[0m16:21:55.131577 [debug] [MainThread]: Executing "git --help"
[0m16:21:55.162008 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:21:55.163009 [debug] [MainThread]: STDERR: "b''"
[0m16:21:55.163009 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:21:55.163009 [info ] [MainThread]: Connection test skipped since no profile was found
[0m16:21:55.164523 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:21:55.164523 [info ] [MainThread]: dbt looked for a profiles.yml file in C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m16:21:55.166548 [debug] [MainThread]: Command `dbt debug` failed at 16:21:55.166548 after 0.16 seconds
[0m16:21:55.166548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020990D6B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098CAED7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020992EBBA90>]}
[0m16:21:55.166548 [debug] [MainThread]: Flushing usage events
[0m16:22:13.109793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385B195430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385BAE43A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385A1195E0>]}


============================== 16:22:13.113456 | d3ff7e5b-dc0a-4bea-bc2c-5da4deec7180 ==============================
[0m16:22:13.113456 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:22:13.114402 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:22:13.115401 [info ] [MainThread]: dbt version: 1.7.4
[0m16:22:13.116405 [info ] [MainThread]: python version: 3.8.10
[0m16:22:13.116405 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:22:13.117397 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:22:13.569708 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:22:13.570716 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:22:13.571652 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:22:13.573090 [info ] [MainThread]: adapter type: bigquery
[0m16:22:13.573615 [info ] [MainThread]: adapter version: 1.7.2
[0m16:22:13.677865 [info ] [MainThread]: Configuration:
[0m16:22:13.678866 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:22:13.679789 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:22:13.679789 [info ] [MainThread]: Required dependencies:
[0m16:22:13.679789 [debug] [MainThread]: Executing "git --help"
[0m16:22:13.708503 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:22:13.708503 [debug] [MainThread]: STDERR: "b''"
[0m16:22:13.709525 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:22:13.709525 [info ] [MainThread]: Connection:
[0m16:22:13.710501 [info ] [MainThread]:   method: service-account
[0m16:22:13.710501 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:22:13.711503 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:22:13.711503 [info ] [MainThread]:   schema: dbt_dw
[0m16:22:13.712698 [info ] [MainThread]:   location: us-east4
[0m16:22:13.712698 [info ] [MainThread]:   priority: None
[0m16:22:13.713666 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:22:13.713666 [info ] [MainThread]:   impersonate_service_account: None
[0m16:22:13.714679 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:22:13.715669 [info ] [MainThread]:   job_retries: 1
[0m16:22:13.716668 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:22:13.717669 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:22:13.717669 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:22:13.717669 [info ] [MainThread]:   timeout_seconds: None
[0m16:22:13.718675 [info ] [MainThread]:   refresh_token: None
[0m16:22:13.718675 [info ] [MainThread]:   client_id: None
[0m16:22:13.719666 [info ] [MainThread]:   token_uri: None
[0m16:22:13.719666 [info ] [MainThread]:   dataproc_region: None
[0m16:22:13.719666 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:22:13.720666 [info ] [MainThread]:   gcs_bucket: None
[0m16:22:13.720666 [info ] [MainThread]:   dataproc_batch: None
[0m16:22:13.721668 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:22:13.722175 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:22:13.722175 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:22:13.724688 [debug] [MainThread]: On debug: select 1 as id
[0m16:22:14.518722 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a61797db-38a2-4693-b276-2c2a11b7a1db&page=queryresults
[0m16:22:15.028695 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:22:15.030688 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:22:15.032807 [debug] [MainThread]: Command `dbt debug` succeeded at 16:22:15.032807 after 1.99 seconds
[0m16:22:15.033856 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:22:15.033856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385B195430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385E7BCEE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385E753400>]}
[0m16:22:15.034808 [debug] [MainThread]: Flushing usage events
[0m16:23:56.460792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D720B24430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC3D30>]}


============================== 16:23:56.464834 | 71024de1-cacb-41b8-8eb7-1f972d7bbdea ==============================
[0m16:23:56.464834 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:23:56.465842 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:23:56.944558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC4250>]}
[0m16:23:57.011611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7241B1A90>]}
[0m16:23:57.013253 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:23:57.020021 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:23:57.066411 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:23:57.067538 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:23:57.067538 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:23:57.072067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7244370D0>]}
[0m16:23:57.080631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7243726D0>]}
[0m16:23:57.081629 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:23:57.081881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724372E20>]}
[0m16:23:57.082957 [info ] [MainThread]: 
[0m16:23:57.082957 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:23:57.085619 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:23:57.085619 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:23:57.993925 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:23:57.995932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:23:58.712137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724200B50>]}
[0m16:23:58.714660 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:23:58.717195 [info ] [MainThread]: 
[0m16:23:58.730852 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:23:58.733033 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.testetabela ............................. [RUN]
[0m16:23:58.736539 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:23:58.739610 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:23:58.768736 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:23:58.773556 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:23:58.740554 => 16:23:58.772461
[0m16:23:58.775079 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:23:58.888907 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:23:58.891804 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:23:58.898947 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:23:59.830574 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f7eae62-22f6-4a7d-b254-00c9f9a95b20&page=queryresults
[0m16:24:00.303090 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:23:58.776598 => 16:24:00.303090
[0m16:24:00.303090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724524EB0>]}
[0m16:24:00.304595 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.testetabela ........................ [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m16:24:00.305603 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:24:00.309602 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:24:00.310618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:24:00.310618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:24:00.312149 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:24:00.313164 [info ] [MainThread]: 
[0m16:24:00.315696 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.23 seconds (3.23s).
[0m16:24:00.318688 [debug] [MainThread]: Command end result
[0m16:24:00.346974 [info ] [MainThread]: 
[0m16:24:00.348848 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:24:00.350982 [info ] [MainThread]: 
[0m16:24:00.351994 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:24:00.355942 [debug] [MainThread]: Command `dbt run` succeeded at 16:24:00.354842 after 3.96 seconds
[0m16:24:00.356862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D720B24430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724134C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724434FD0>]}
[0m16:24:00.358022 [debug] [MainThread]: Flushing usage events
[0m16:28:51.603456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5448CD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5451DC760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C54385A7C0>]}


============================== 16:28:51.607031 | b676423c-5d95-4df0-b285-1d6522789aee ==============================
[0m16:28:51.607031 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:28:51.608101 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m16:28:51.608101 [info ] [MainThread]: dbt version: 1.7.4
[0m16:28:51.609102 [info ] [MainThread]: python version: 3.8.10
[0m16:28:51.609102 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:28:51.610101 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:28:51.944191 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:28:51.944191 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:28:51.945114 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:28:51.946140 [info ] [MainThread]: adapter type: bigquery
[0m16:28:51.947140 [info ] [MainThread]: adapter version: 1.7.2
[0m16:28:52.037916 [info ] [MainThread]: Configuration:
[0m16:28:52.038922 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:28:52.039867 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:28:52.039867 [info ] [MainThread]: Required dependencies:
[0m16:28:52.040863 [debug] [MainThread]: Executing "git --help"
[0m16:28:52.066900 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:28:52.066900 [debug] [MainThread]: STDERR: "b''"
[0m16:28:52.066900 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:28:52.068197 [info ] [MainThread]: Connection:
[0m16:28:52.069206 [info ] [MainThread]:   method: service-account
[0m16:28:52.069206 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:28:52.070247 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:28:52.070247 [info ] [MainThread]:   schema: dbt_dw
[0m16:28:52.071203 [info ] [MainThread]:   location: us-east4
[0m16:28:52.071203 [info ] [MainThread]:   priority: None
[0m16:28:52.072201 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:28:52.072201 [info ] [MainThread]:   impersonate_service_account: None
[0m16:28:52.072201 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:28:52.073205 [info ] [MainThread]:   job_retries: 1
[0m16:28:52.073205 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:28:52.074124 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:28:52.074124 [info ] [MainThread]:   keyfile: C:\Git\key_project_sb.json
[0m16:28:52.075154 [info ] [MainThread]:   timeout_seconds: None
[0m16:28:52.075154 [info ] [MainThread]:   refresh_token: None
[0m16:28:52.076141 [info ] [MainThread]:   client_id: None
[0m16:28:52.077136 [info ] [MainThread]:   token_uri: None
[0m16:28:52.077136 [info ] [MainThread]:   dataproc_region: None
[0m16:28:52.077136 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:28:52.078137 [info ] [MainThread]:   gcs_bucket: None
[0m16:28:52.078137 [info ] [MainThread]:   dataproc_batch: None
[0m16:28:52.079160 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:28:52.079160 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:28:52.079160 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:28:52.081730 [debug] [MainThread]: On debug: select 1 as id
[0m16:28:53.107813 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11fe03d6-d242-48d5-b0c1-64db0a62ac53&page=queryresults
[0m16:28:53.716071 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:28:53.717680 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:28:53.719820 [debug] [MainThread]: Command `dbt debug` succeeded at 16:28:53.719820 after 2.19 seconds
[0m16:28:53.720741 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:28:53.721819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5448CD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C547EF39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C547F00340>]}
[0m16:28:53.722818 [debug] [MainThread]: Flushing usage events
[0m16:44:00.389459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8DDC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8CD659D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8CD65B80>]}


============================== 16:44:00.392525 | 180ed13b-0c19-4172-8167-c6b1150085fe ==============================
[0m16:44:00.392525 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:44:00.393547 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_produto', 'send_anonymous_usage_stats': 'True'}
[0m16:44:00.867351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8FF2CAC0>]}
[0m16:44:00.930799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91457550>]}
[0m16:44:00.931806 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:44:00.938349 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:44:00.944337 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:44:00.945348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91518580>]}
[0m16:44:01.773032 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:44:01.777060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA918288B0>]}
[0m16:44:01.786030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91828610>]}
[0m16:44:01.787030 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:44:01.787030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91828670>]}
[0m16:44:01.788034 [info ] [MainThread]: 
[0m16:44:01.789038 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:44:01.790038 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:44:01.791030 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:02.739993 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:44:02.740984 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:03.373479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91772D60>]}
[0m16:44:03.375762 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:44:03.378115 [info ] [MainThread]: 
[0m16:44:03.389853 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m16:44:03.391925 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m16:44:03.395006 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m16:44:03.396943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:44:03.426055 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:44:03.431003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:44:03.397941 => 16:44:03.429001
[0m16:44:03.432994 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:44:03.482911 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:44:03.483958 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:44:03.486969 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:44:04.486293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:556ccd8f-2528-4b0b-ae94-a026e205c12e&page=queryresults
[0m16:44:05.109208 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:44:03.432994 => 16:44:05.109208
[0m16:44:05.110230 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA9184C040>]}
[0m16:44:05.110230 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.72s]
[0m16:44:05.111226 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:44:05.112740 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_produto' was properly closed.
[0m16:44:05.113745 [info ] [MainThread]: 
[0m16:44:05.114750 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.33 seconds (3.33s).
[0m16:44:05.116761 [debug] [MainThread]: Command end result
[0m16:44:05.124746 [info ] [MainThread]: 
[0m16:44:05.125752 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:44:05.126752 [info ] [MainThread]: 
[0m16:44:05.127750 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:44:05.129022 [debug] [MainThread]: Command `dbt run` succeeded at 16:44:05.129022 after 4.79 seconds
[0m16:44:05.129022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8DDC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA9160EFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA918C8E20>]}
[0m16:44:05.130017 [debug] [MainThread]: Flushing usage events
[0m16:51:03.577002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F35B8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B036A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B03DC0>]}


============================== 16:51:03.581008 | cea304b0-90ed-4590-964e-4ad4f28e0e91 ==============================
[0m16:51:03.581008 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:51:03.582007 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models dm_produto', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:51:03.999544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B038E0>]}
[0m16:51:04.061302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F391FA6A0>]}
[0m16:51:04.062303 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:51:04.068787 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:51:04.162798 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m16:51:04.163798 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:51:04.163798 [debug] [MainThread]: Partial parsing: deleted file: shibaribrasil://models\1.stg\testetabela.sql
[0m16:51:04.260284 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:51:04.265185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F395409A0>]}
[0m16:51:04.273652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3933BD30>]}
[0m16:51:04.273652 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:51:04.274660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3933B310>]}
[0m16:51:04.275656 [info ] [MainThread]: 
[0m16:51:04.277188 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:51:04.279201 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:51:04.279201 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:05.157536 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_dw)
[0m16:51:05.159529 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_dw"
"
[0m16:51:05.172135 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:51:05.173146 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_dw: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_dw"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_dw`
  
[0m16:51:06.066362 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:339dc78f-3109-4fbd-8b22-98012b24b06a&page=queryresults
[0m16:51:07.010672 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:51:07.011799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:07.013712 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:51:07.015731 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:07.718447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3944F2E0>]}
[0m16:51:07.720428 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:07.721984 [info ] [MainThread]: 
[0m16:51:07.731862 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:51:07.732867 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:51:07.734864 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:51:07.735863 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:51:07.749534 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:51:07.753474 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:51:07.736870 => 16:51:07.752478
[0m16:51:07.754486 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:51:07.788244 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:51:07.789242 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:51:07.791244 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:51:08.888632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8b1be5ae-82af-4fd0-8fb7-4b4dea5f0aac&page=queryresults
[0m16:51:09.351938 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Column name cd_categoria is ambiguous at [72:12]')
[0m16:51:10.681955 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6278724e-daf2-4495-a1cd-a59be3e14d09&page=queryresults
[0m16:51:11.195063 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6278724e-daf2-4495-a1cd-a59be3e14d09&page=queryresults
[0m16:51:11.197634 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:51:07.755514 => 16:51:11.196973
[0m16:51:11.207348 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Column name cd_categoria is ambiguous at [72:12]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:11.209431 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3964F610>]}
[0m16:51:11.211414 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 3.47s]
[0m16:51:11.213368 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:51:11.220032 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:11.220988 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:11.221987 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:51:11.223045 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:11.223997 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:51:11.224981 [info ] [MainThread]: 
[0m16:51:11.227828 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.95 seconds (6.95s).
[0m16:51:11.231509 [debug] [MainThread]: Command end result
[0m16:51:11.250191 [info ] [MainThread]: 
[0m16:51:11.251200 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:51:11.252191 [info ] [MainThread]: 
[0m16:51:11.253186 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Column name cd_categoria is ambiguous at [72:12]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:11.255194 [info ] [MainThread]: 
[0m16:51:11.257193 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:51:11.260681 [debug] [MainThread]: Command `dbt run` failed at 16:51:11.260681 after 7.74 seconds
[0m16:51:11.260681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F35B8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F391FA6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F393AC0D0>]}
[0m16:51:11.261664 [debug] [MainThread]: Flushing usage events
[0m16:51:34.752024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF63562430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF625059D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF62505B80>]}


============================== 16:51:34.755079 | bc8921d9-67dd-42f6-bed6-987d3a5b3748 ==============================
[0m16:51:34.755079 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:51:34.756068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models dm_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:51:35.184181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF624EC3D0>]}
[0m16:51:35.246833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66AEB2B0>]}
[0m16:51:35.248432 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:51:35.255429 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:51:35.367041 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:51:35.367041 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:51:35.469233 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:51:35.473233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66CBB970>]}
[0m16:51:35.482181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66DA91C0>]}
[0m16:51:35.482181 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:51:35.483183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66C76400>]}
[0m16:51:35.485176 [info ] [MainThread]: 
[0m16:51:35.486179 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:51:35.488173 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:51:35.488173 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.192333 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:51:36.192333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.195349 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:51:36.196945 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.884018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66B83190>]}
[0m16:51:36.887019 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:36.888707 [info ] [MainThread]: 
[0m16:51:36.899440 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:51:36.901436 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:51:36.903359 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:51:36.905342 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:51:36.930140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:51:36.933156 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:51:36.905342 => 16:51:36.932137
[0m16:51:36.936138 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:51:36.968754 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:51:36.969755 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:51:36.971756 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:51:38.127089 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb709fad-d0ec-43af-8da7-5a9d0c4bbd9a&page=queryresults
[0m16:51:38.638873 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name ds_subcategoria not found inside a at [106:14]')
[0m16:51:39.824117 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b06a80bd-4dbd-4d75-a7c8-8de3a9436ae3&page=queryresults
[0m16:51:40.277234 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b06a80bd-4dbd-4d75-a7c8-8de3a9436ae3&page=queryresults
[0m16:51:40.279962 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:51:36.937148 => 16:51:40.278971
[0m16:51:40.287700 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Name ds_subcategoria not found inside a at [106:14]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:40.289269 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66B83190>]}
[0m16:51:40.290323 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 3.39s]
[0m16:51:40.291319 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:51:40.295332 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:40.296355 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:51:40.297328 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:51:40.297328 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:40.298337 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:51:40.298337 [info ] [MainThread]: 
[0m16:51:40.299338 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.81 seconds (4.81s).
[0m16:51:40.300337 [debug] [MainThread]: Command end result
[0m16:51:40.309993 [info ] [MainThread]: 
[0m16:51:40.311069 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:51:40.311069 [info ] [MainThread]: 
[0m16:51:40.311963 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Name ds_subcategoria not found inside a at [106:14]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:40.312964 [info ] [MainThread]: 
[0m16:51:40.312964 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:51:40.313964 [debug] [MainThread]: Command `dbt run` failed at 16:51:40.313964 after 5.62 seconds
[0m16:51:40.313964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF63562430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66AEB2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF612086D0>]}
[0m16:51:40.314996 [debug] [MainThread]: Flushing usage events
[0m16:52:14.458522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E267023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E256A42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E256A4760>]}


============================== 16:52:14.461522 | f95792b5-5f92-407c-acdf-4da83048d901 ==============================
[0m16:52:14.461522 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:52:14.462585 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models dm_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:52:14.900987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2568BA60>]}
[0m16:52:14.966691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29D8D7F0>]}
[0m16:52:14.968259 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:52:14.974334 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:52:15.052918 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:52:15.052918 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:52:15.149990 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:52:15.154620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2A197EE0>]}
[0m16:52:15.162324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29EA96D0>]}
[0m16:52:15.163367 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:52:15.164349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29CF1400>]}
[0m16:52:15.165356 [info ] [MainThread]: 
[0m16:52:15.166361 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:52:15.168329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:52:15.168329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:15.914642 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:52:15.914642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:15.945966 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:52:15.947424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:16.610625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29CF1400>]}
[0m16:52:16.611620 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:52:16.613615 [info ] [MainThread]: 
[0m16:52:16.621234 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:52:16.622224 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:52:16.624230 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:52:16.625232 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:52:16.634165 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:52:16.636168 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:52:16.625232 => 16:52:16.635169
[0m16:52:16.637173 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:52:16.664367 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:52:16.665387 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:52:16.666328 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:52:17.997499 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79ae4398-cc15-43d2-af54-368996377076&page=queryresults
[0m16:52:20.614508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:52:16.637173 => 16:52:20.614508
[0m16:52:20.615510 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2A1EEDF0>]}
[0m16:52:20.616825 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.99s]
[0m16:52:20.617864 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:52:20.619825 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:52:20.619825 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:52:20.620826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:52:20.620826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:52:20.621825 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:52:20.621825 [info ] [MainThread]: 
[0m16:52:20.622823 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.46 seconds (5.46s).
[0m16:52:20.623855 [debug] [MainThread]: Command end result
[0m16:52:20.643838 [info ] [MainThread]: 
[0m16:52:20.644878 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:52:20.646872 [info ] [MainThread]: 
[0m16:52:20.647841 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:52:20.649857 [debug] [MainThread]: Command `dbt run` succeeded at 16:52:20.649857 after 6.24 seconds
[0m16:52:20.649857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E267023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29DA9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29D568E0>]}
[0m16:52:20.650900 [debug] [MainThread]: Flushing usage events
[0m16:54:51.218571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AA3E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A93842E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9384760>]}


============================== 16:54:51.221602 | 708dc89a-a244-45ff-9e12-3e1699ac8c51 ==============================
[0m16:54:51.221602 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:54:51.222606 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_categoria_produtos', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:54:51.658566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A936CBE0>]}
[0m16:54:51.731614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9386250>]}
[0m16:54:51.732600 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:54:51.741605 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:54:51.853646 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:54:51.854647 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:54:51.854647 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_produto.sql
[0m16:54:51.964800 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:54:51.969324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5ADD5EE80>]}
[0m16:54:51.977733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5ADC14190>]}
[0m16:54:51.977733 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:54:51.978735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AD9DE880>]}
[0m16:54:51.978735 [warn ] [MainThread]: The selection criterion 'stg_categoria_produtos' does not match any nodes
[0m16:54:51.979732 [info ] [MainThread]: 
[0m16:54:51.980734 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m16:54:51.981730 [debug] [MainThread]: Command end result
[0m16:54:51.989077 [debug] [MainThread]: Command `dbt run` succeeded at 16:54:51.989077 after 0.84 seconds
[0m16:54:51.989077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AA3E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9386250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AD9C7460>]}
[0m16:54:51.990179 [debug] [MainThread]: Flushing usage events
[0m16:55:43.325346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A82ED430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A72739A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A7273D30>]}


============================== 16:55:43.329649 | eda5ad82-7e0e-44df-9b2a-c24abfaff01f ==============================
[0m16:55:43.329649 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:55:43.330649 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models stg_categoria_produtos', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:55:43.797725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A725C970>]}
[0m16:55:43.865833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB835BB0>]}
[0m16:55:43.866828 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:55:43.873369 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:55:43.943232 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:55:43.943232 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:55:43.944234 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:55:43.948979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABBF0340>]}
[0m16:55:43.957374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABB22250>]}
[0m16:55:43.957374 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:55:43.958375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB987820>]}
[0m16:55:43.958375 [warn ] [MainThread]: The selection criterion 'stg_categoria_produtos' does not match any nodes
[0m16:55:43.959373 [info ] [MainThread]: 
[0m16:55:43.960372 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m16:55:43.960372 [debug] [MainThread]: Command end result
[0m16:55:43.968396 [debug] [MainThread]: Command `dbt run` succeeded at 16:55:43.968396 after 0.70 seconds
[0m16:55:43.969473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A82ED430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB9978B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABBD1E20>]}
[0m16:55:43.969473 [debug] [MainThread]: Flushing usage events
[0m16:56:32.452507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BF10D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE0829A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE082D30>]}


============================== 16:56:32.455490 | ad6e4775-2c6b-4a88-9a72-f307cbeb1746 ==============================
[0m16:56:32.455490 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:56:32.456491 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_categoria_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:56:32.891415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE085040>]}
[0m16:56:32.950948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27826D0>]}
[0m16:56:32.952946 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:56:32.958554 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:56:33.008977 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m16:56:33.009974 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_categoria_produto.sql
[0m16:56:33.101102 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:56:33.106059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2A316A0>]}
[0m16:56:33.115058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C29F0E20>]}
[0m16:56:33.115058 [info ] [MainThread]: Found 3 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:56:33.116124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C29F0DF0>]}
[0m16:56:33.117109 [info ] [MainThread]: 
[0m16:56:33.118476 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:56:33.120567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:56:33.120567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:33.906781 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:56:33.907390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:33.948275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:56:33.948275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:34.791055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2926070>]}
[0m16:56:34.792996 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:56:34.794034 [info ] [MainThread]: 
[0m16:56:34.803507 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.805510 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:56:34.808000 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:56:34.809025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.823999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:56:34.829584 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:56:34.809025 => 16:56:34.828585
[0m16:56:34.830693 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.854169 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:56:34.856267 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:56:34.857378 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categoria_produtos`
)

select *
  from cte_categoria;


[0m16:56:35.706440 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d4dcd9c-4ea4-4930-b229-156cf5bab86b&page=queryresults
[0m16:56:35.707857 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categoria_produtos`
)

select *
  from cte_categoria;


[0m16:56:35.708912 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4

Location: us-east4
Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b

[0m16:56:35.709917 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:56:34.830693 => 16:56:35.709917
[0m16:56:35.718452 [debug] [Thread-1  ]: Runtime Error in model stg_categoria_produto (models\1.stg\stg_categoria_produto.sql)
  404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4
  
  Location: us-east4
  Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b
  
[0m16:56:35.720520 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2BF5550>]}
[0m16:56:35.721526 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_categoria_produto .......... [[31mERROR[0m in 0.91s]
[0m16:56:35.724530 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:56:35.729181 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:56:35.730173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:56:35.731180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:56:35.732175 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:56:35.733186 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_categoria_produto' was properly closed.
[0m16:56:35.734180 [info ] [MainThread]: 
[0m16:56:35.736176 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.62 seconds (2.62s).
[0m16:56:35.738780 [debug] [MainThread]: Command end result
[0m16:56:35.762697 [info ] [MainThread]: 
[0m16:56:35.764662 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:56:35.767672 [info ] [MainThread]: 
[0m16:56:35.769667 [error] [MainThread]:   Runtime Error in model stg_categoria_produto (models\1.stg\stg_categoria_produto.sql)
  404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4
  
  Location: us-east4
  Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b
  
[0m16:56:35.772672 [info ] [MainThread]: 
[0m16:56:35.773648 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:56:35.778636 [debug] [MainThread]: Command `dbt run` failed at 16:56:35.778636 after 3.39 seconds
[0m16:56:35.780720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BF10D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27826D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27D9640>]}
[0m16:56:35.780720 [debug] [MainThread]: Flushing usage events
[0m16:57:03.887269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212EE7A1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED7499D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED749B80>]}


============================== 16:57:03.890740 | 93a53c2e-3215-43c2-bfa7-0b6f6b5235da ==============================
[0m16:57:03.890740 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:57:03.891728 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_categoria_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:57:04.370074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED7468E0>]}
[0m16:57:04.434671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1DD96D0>]}
[0m16:57:04.436675 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:57:04.443132 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:57:04.544231 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:57:04.544231 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m16:57:04.545234 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_categoria_produto.sql
[0m16:57:04.707086 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:57:04.711085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F23A27C0>]}
[0m16:57:04.721087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F2005670>]}
[0m16:57:04.721087 [info ] [MainThread]: Found 3 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:57:04.722083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1ED75E0>]}
[0m16:57:04.724089 [info ] [MainThread]: 
[0m16:57:04.725083 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:57:04.727415 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:57:04.727415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:05.406807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:57:05.407805 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:05.439831 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:57:05.439831 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:06.097539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1D944C0>]}
[0m16:57:06.101549 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:57:06.104294 [info ] [MainThread]: 
[0m16:57:06.126281 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.130103 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:57:06.135173 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:57:06.137154 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.167040 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:57:06.170873 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:57:06.139357 => 16:57:06.169714
[0m16:57:06.170873 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.212030 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:57:06.212030 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:57:06.214044 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:57:07.221276 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cad0762c-4969-4a29-bff5-b8bc9d3952af&page=queryresults
[0m16:57:07.751070 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:57:06.170873 => 16:57:07.750072
[0m16:57:07.753134 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F33F9E20>]}
[0m16:57:07.755131 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m16:57:07.758652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:57:07.764779 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:57:07.765772 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:57:07.765772 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:57:07.766760 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:57:07.766760 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_categoria_produto' was properly closed.
[0m16:57:07.767772 [info ] [MainThread]: 
[0m16:57:07.769778 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.04 seconds (3.04s).
[0m16:57:07.774092 [debug] [MainThread]: Command end result
[0m16:57:07.803581 [info ] [MainThread]: 
[0m16:57:07.805578 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:57:07.806583 [info ] [MainThread]: 
[0m16:57:07.807589 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:57:07.808580 [debug] [MainThread]: Command `dbt run` succeeded at 16:57:07.808580 after 3.99 seconds
[0m16:57:07.809581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212EE7A1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1DD96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F20B39D0>]}
[0m16:57:07.810581 [debug] [MainThread]: Flushing usage events
[0m17:00:03.299660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E75BA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B186D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B18E20>]}


============================== 17:00:03.303311 | 188bcfd1-bfd3-44bf-b584-0360f891b922 ==============================
[0m17:00:03.303311 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:03.304312 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:00:03.835932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B10070>]}
[0m17:00:03.895845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792077C0>]}
[0m17:00:03.897357 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:03.904078 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:03.978517 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m17:00:03.978517 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:04.077522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7957B700>]}
[0m17:00:04.085228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E79481E20>]}
[0m17:00:04.086298 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:04.086298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E79481BE0>]}
[0m17:00:04.088800 [info ] [MainThread]: 
[0m17:00:04.088800 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:04.090843 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.090843 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:04.091816 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.091816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:04.813012 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:05.529143 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:05.531134 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_az"
"
[0m17:00:05.549388 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:05.552396 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_az: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_az"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_az`
  
[0m17:00:06.372359 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f2082fd1-d115-45a6-8687-3bf806edbb4e&page=queryresults
[0m17:00:07.317017 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:07.318062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.320064 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:07.321057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:08.009383 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:08.010467 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.663594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792376D0>]}
[0m17:00:08.664621 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.666618 [info ] [MainThread]: 
[0m17:00:08.676227 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.680036 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:08.677926 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:00:08.682948 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.683944 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.697713 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.681045 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:00:08.698818 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:00:08.699825 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:08.704824 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:08.708291 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.683944 => 17:00:08.707289
[0m17:00:08.709806 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.727305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:08.699825 => 17:00:08.727305
[0m17:00:08.728369 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:08.736308 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:08.737362 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.739369 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.739369 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.740315 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:08.760818 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:09.830881 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d9a8e403-637f-4203-a208-5affcbd0e21b&page=queryresults
[0m17:00:09.832880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4eb6af14-90fb-4371-92e6-ddea00da0b12&page=queryresults
[0m17:00:10.362035 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:08.728369 => 17:00:10.362035
[0m17:00:10.368047 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.709806 => 17:00:10.367051
[0m17:00:10.371046 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792376D0>]}
[0m17:00:10.372047 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A712E20>]}
[0m17:00:10.373076 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.67s]
[0m17:00:10.377766 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:10.374111 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.69s]
[0m17:00:10.381064 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.383038 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:10.384055 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:10.383038 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:00:10.386324 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:00:10.387424 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:10.385031 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:10.391831 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:00:10.398558 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:10.399556 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:10.403558 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:10.405557 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:10.387424 => 17:00:10.404558
[0m17:00:10.406561 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:10.417236 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.419416 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:10.399556 => 17:00:10.419416
[0m17:00:10.442433 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:10.464170 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:10.467172 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:10.469207 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:11.061528 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:11.064517 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:11.544593 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd774763-e1a8-4ba6-ab8d-c9e49251f1d1&page=queryresults
[0m17:00:11.774619 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9f187ce-b150-41f9-80c4-d30b966c5436&page=queryresults
[0m17:00:14.467327 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:10.443433 => 17:00:14.466599
[0m17:00:14.469447 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A6BA8E0>]}
[0m17:00:14.470436 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.08s]
[0m17:00:14.472353 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:14.483358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:10.406561 => 17:00:14.482399
[0m17:00:14.485419 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A6F7400>]}
[0m17:00:14.487351 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.10s]
[0m17:00:14.490390 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:14.493395 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:14.493395 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:14.494393 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:14.494393 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:00:14.496387 [info ] [MainThread]: 
[0m17:00:14.497822 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 10.41 seconds (10.41s).
[0m17:00:14.499828 [debug] [MainThread]: Command end result
[0m17:00:14.517594 [info ] [MainThread]: 
[0m17:00:14.519596 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:14.520599 [info ] [MainThread]: 
[0m17:00:14.521717 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:00:14.522704 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:14.521717 after 11.28 seconds
[0m17:00:14.522704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E75BA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E791A3B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E794B96D0>]}
[0m17:00:14.522704 [debug] [MainThread]: Flushing usage events
[0m17:00:21.769916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161552F4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275AC0>]}


============================== 17:00:21.773911 | 1f490cda-dc2d-489e-8ae2-86a1d2bcb8da ==============================
[0m17:00:21.773911 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:21.773911 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:00:22.199463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f490cda-dc2d-489e-8ae2-86a1d2bcb8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275850>]}
[0m17:00:22.260588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f490cda-dc2d-489e-8ae2-86a1d2bcb8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161589684C0>]}
[0m17:00:22.261577 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:22.268212 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:22.367129 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:22.367727 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:22.453452 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.shibaribrasil.tb_produto' (models\3.az\tb_produto.sql) depends on a node named 'dw_produto' which was not found
[0m17:00:22.454398 [debug] [MainThread]: Command `dbt run` failed at 17:00:22.454398 after 0.74 seconds
[0m17:00:22.454398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161552F4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016158919130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016158C02D90>]}
[0m17:00:22.455462 [debug] [MainThread]: Flushing usage events
[0m17:00:41.434741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CAA6D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F36A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F3DC0>]}


============================== 17:00:41.439071 | 4036ce2e-e5df-440b-9b0e-7c6a8bc5542d ==============================
[0m17:00:41.439071 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:41.439071 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:00:41.883912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CCBBBA60>]}
[0m17:00:41.946324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CD3BF400>]}
[0m17:00:41.946799 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:41.952847 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:42.000826 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:42.001827 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:42.096780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE4EE5B0>]}
[0m17:00:42.104318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE2AD970>]}
[0m17:00:42.105308 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:42.106284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE2AD880>]}
[0m17:00:42.106648 [info ] [MainThread]: 
[0m17:00:42.107703 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:42.108695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:42.109706 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:42.805587 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:00:42.805587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:42.827594 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:42.828589 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:43.623812 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:00:43.628128 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:44.240196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F3700>]}
[0m17:00:44.242192 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:44.243190 [info ] [MainThread]: 
[0m17:00:44.251192 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:44.252206 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:44.253191 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m17:00:44.254191 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:44.266216 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:44.270214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:44.255190 => 17:00:44.269214
[0m17:00:44.271221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:44.290737 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:44.943166 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:44.944169 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:00:45.669183 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e013de55-8eb9-4826-abf2-942fc09b97c3&page=queryresults
[0m17:00:47.947790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:44.272211 => 17:00:47.947790
[0m17:00:47.948875 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE559E80>]}
[0m17:00:47.949868 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.70s]
[0m17:00:47.951858 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:47.953868 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:47.953868 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:47.954860 [info ] [MainThread]: 
[0m17:00:47.955859 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.85 seconds (5.85s).
[0m17:00:47.956864 [debug] [MainThread]: Command end result
[0m17:00:47.963418 [info ] [MainThread]: 
[0m17:00:47.964355 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:47.964355 [info ] [MainThread]: 
[0m17:00:47.966811 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:00:47.968903 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:47.968903 after 6.59 seconds
[0m17:00:47.968903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CAA6D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE0B7E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE38E610>]}
[0m17:00:47.969912 [debug] [MainThread]: Flushing usage events
[0m17:01:28.273120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BB0833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA0079D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA007B80>]}


============================== 17:01:28.277142 | 3698c33f-7d60-42cf-86e3-245f083ab78d ==============================
[0m17:01:28.277142 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:28.277838 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m17:01:29.311969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA004280>]}
[0m17:01:29.378746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE701A90>]}
[0m17:01:29.380742 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:29.388168 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:29.546604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:29.547885 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:29.557088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE9940D0>]}
[0m17:01:29.570817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE97BC40>]}
[0m17:01:29.570817 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:29.573316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE97B3A0>]}
[0m17:01:29.576360 [info ] [MainThread]: 
[0m17:01:29.577896 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:29.580969 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:29.581921 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:29.582913 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:29.583975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:30.421090 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:31.141092 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:01:31.143090 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:31.144087 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:01:31.146088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:31.853638 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:01:31.853638 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:32.569679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE764070>]}
[0m17:01:32.570679 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:32.570679 [info ] [MainThread]: 
[0m17:01:32.575627 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.576683 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:01:32.577159 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:01:32.578219 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:01:32.579270 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.585246 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:32.577159 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:01:32.586151 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:01:32.586151 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:01:32.589747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:01:32.590709 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:01:32.587184 => 17:01:32.589747
[0m17:01:32.590709 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:01:32.607762 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:01:32.579270 => 17:01:32.607279
[0m17:01:32.612808 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:01:32.613816 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.618266 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:32.619316 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:32.620288 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:01:32.621321 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:01:32.644489 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:01:33.416647 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f089a11-46e3-4490-8605-8d0ae2f05ddb&page=queryresults
[0m17:01:33.431330 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4f0c5612-6cd3-4e91-aef4-e359965a07ad&page=queryresults
[0m17:01:33.805254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125726C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257164F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257164FE20>]}


============================== 17:01:33.809828 | 9dda4c23-2282-4f53-bbc6-9dbb19c7f915 ==============================
[0m17:01:33.809828 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:33.810822 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:01:33.912985 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:01:32.590709 => 17:01:33.912985
[0m17:01:33.915987 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:01:32.613816 => 17:01:33.915987
[0m17:01:33.916935 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BFA26430>]}
[0m17:01:33.917440 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BEA483A0>]}
[0m17:01:33.918520 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m17:01:33.919489 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:01:33.918520 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m17:01:33.920489 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:01:33.920489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:01:33.921487 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:01:33.921487 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:01:33.922491 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:01:33.925491 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:01:33.926480 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:01:33.922491 => 17:01:33.925491
[0m17:01:33.926791 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:01:33.933848 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:01:34.380050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257480DA90>]}
[0m17:01:34.441709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575D33550>]}
[0m17:01:34.442710 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:34.449345 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:34.492950 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:34.492950 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:34.497363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575FC2CD0>]}
[0m17:01:34.505380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575EF6A00>]}
[0m17:01:34.505380 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:34.506412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575EF6880>]}
[0m17:01:34.507655 [info ] [MainThread]: 
[0m17:01:34.508655 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:34.510628 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:34.510628 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:34.511687 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:34.511687 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:34.672912 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:01:34.675910 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:01:35.289631 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:34e733e9-0ec7-4f01-8d36-887cc1cd3de2&page=queryresults
[0m17:01:35.439189 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:36.128005 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:01:36.130021 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:36.131961 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:01:36.132957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:36.773785 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:01:36.773785 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:37.486961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575FC2DF0>]}
[0m17:01:37.489044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:37.489993 [info ] [MainThread]: 
[0m17:01:37.495997 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.497693 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:01:37.497049 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:01:37.500759 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:01:37.501749 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.499764 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:01:37.518778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:37.519785 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:01:37.520786 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:01:37.526797 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:01:37.528132 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:01:37.502712 => 17:01:37.527135
[0m17:01:37.528132 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.551326 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:37.552303 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:01:37.521731 => 17:01:37.551326
[0m17:01:37.552303 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:01:37.556754 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:01:37.557794 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:37.557794 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:01:37.559787 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:01:37.580947 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:01:37.885769 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:01:33.926791 => 17:01:37.885769
[0m17:01:37.886811 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BEA35A30>]}
[0m17:01:37.888512 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.97s]
[0m17:01:37.889624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:01:37.890525 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:01:37.891531 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:01:37.893534 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:01:37.893534 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:01:37.898013 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:01:37.899018 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:01:37.893534 => 17:01:37.898013
[0m17:01:37.899018 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:01:37.901011 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:01:38.296185 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1d34587-d914-4a4d-8960-0138fe38b8b4&page=queryresults
[0m17:01:38.401011 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d092e40e-1b4b-4479-8578-1d900dc24535&page=queryresults
[0m17:01:38.501280 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:01:38.504275 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:01:38.726083 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:01:37.552303 => 17:01:38.726083
[0m17:01:38.727084 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012576068820>]}
[0m17:01:38.727521 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m17:01:38.728514 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:01:38.728514 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:01:38.729519 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:01:38.729519 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:01:38.729519 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:01:38.733638 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:01:38.734639 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:01:38.730528 => 17:01:38.733638
[0m17:01:38.734639 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:01:38.747708 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:01:38.772054 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:01:37.529189 => 17:01:38.772054
[0m17:01:38.773054 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125760489A0>]}
[0m17:01:38.773054 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m17:01:38.774060 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:01:39.192400 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23acc0a2-3ad9-40f0-8545-28470c042f0b&page=queryresults
[0m17:01:39.562101 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:01:39.564052 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:01:40.179050 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3988d73b-d1c7-4763-bca7-f676746f885a&page=queryresults
[0m17:01:41.224421 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:01:37.899018 => 17:01:41.223418
[0m17:01:41.226372 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BFAC41C0>]}
[0m17:01:41.227753 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.33s]
[0m17:01:41.229752 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:01:41.233767 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:41.233767 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:41.234884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:41.235882 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:01:41.235882 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:41.236882 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:01:41.237662 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:01:41.237662 [info ] [MainThread]: 
[0m17:01:41.238813 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.66 seconds (11.66s).
[0m17:01:41.241810 [debug] [MainThread]: Command end result
[0m17:01:41.267968 [info ] [MainThread]: 
[0m17:01:41.269056 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:41.270043 [info ] [MainThread]: 
[0m17:01:41.270043 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:01:41.271115 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:41.271115 after 13.06 seconds
[0m17:01:41.271115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BB0833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE699A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE5DE760>]}
[0m17:01:41.271115 [debug] [MainThread]: Flushing usage events
[0m17:01:42.812521 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:01:38.735598 => 17:01:42.811564
[0m17:01:42.813579 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257705F490>]}
[0m17:01:42.815465 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.08s]
[0m17:01:42.817183 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:01:42.818540 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:01:42.820546 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:01:42.822545 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:01:42.823545 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:01:42.831167 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:01:42.833170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:01:42.824547 => 17:01:42.833170
[0m17:01:42.834178 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:01:42.837654 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:01:43.489653 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:01:43.492237 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:01:44.140803 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0c7b3a4-158b-452c-94cf-7748d6971305&page=queryresults
[0m17:01:46.116961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:01:42.834178 => 17:01:46.116961
[0m17:01:46.118407 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012577117C70>]}
[0m17:01:46.118407 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.30s]
[0m17:01:46.119442 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:01:46.121441 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:46.122634 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:01:46.122634 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:01:46.122634 [info ] [MainThread]: 
[0m17:01:46.123672 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.61 seconds (11.61s).
[0m17:01:46.123672 [debug] [MainThread]: Command end result
[0m17:01:46.131842 [info ] [MainThread]: 
[0m17:01:46.131842 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:46.132835 [info ] [MainThread]: 
[0m17:01:46.132835 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:01:46.133834 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:46.133834 after 12.38 seconds
[0m17:01:46.133834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125726C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575DFBB20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575C84820>]}
[0m17:01:46.134833 [debug] [MainThread]: Flushing usage events
[0m17:12:35.095199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D59623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D82D1BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D48FBD30>]}


============================== 17:12:35.095199 | 524b1577-3b9d-40b1-8ded-6b1eea483a41 ==============================
[0m17:12:35.095199 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:12:35.095199 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:12:35.095199 [info ] [MainThread]: dbt version: 1.7.4
[0m17:12:35.095199 [info ] [MainThread]: python version: 3.8.10
[0m17:12:35.095199 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m17:12:35.109405 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m17:12:35.479163 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m17:12:35.479163 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m17:12:35.479163 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m17:12:35.479163 [info ] [MainThread]: adapter type: bigquery
[0m17:12:35.479163 [info ] [MainThread]: adapter version: 1.7.2
[0m17:12:35.575963 [info ] [MainThread]: Configuration:
[0m17:12:35.575963 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m17:12:35.575963 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m17:12:35.575963 [info ] [MainThread]: Required dependencies:
[0m17:12:35.575963 [debug] [MainThread]: Executing "git --help"
[0m17:12:35.615736 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m17:12:35.616747 [debug] [MainThread]: STDERR: "b''"
[0m17:12:35.616747 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m17:12:35.617749 [info ] [MainThread]: Connection:
[0m17:12:35.618753 [info ] [MainThread]:   method: service-account
[0m17:12:35.618753 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m17:12:35.618753 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m17:12:35.619747 [info ] [MainThread]:   schema: dbt_dw
[0m17:12:35.619747 [info ] [MainThread]:   location: us-east4
[0m17:12:35.619747 [info ] [MainThread]:   priority: None
[0m17:12:35.619747 [info ] [MainThread]:   maximum_bytes_billed: None
[0m17:12:35.619747 [info ] [MainThread]:   impersonate_service_account: None
[0m17:12:35.619747 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   job_retries: 1
[0m17:12:35.619747 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   keyfile: C:\Git\key_project_sb.json
[0m17:12:35.619747 [info ] [MainThread]:   timeout_seconds: None
[0m17:12:35.625785 [info ] [MainThread]:   refresh_token: None
[0m17:12:35.625785 [info ] [MainThread]:   client_id: None
[0m17:12:35.626799 [info ] [MainThread]:   token_uri: None
[0m17:12:35.627797 [info ] [MainThread]:   dataproc_region: None
[0m17:12:35.627797 [info ] [MainThread]:   dataproc_cluster_name: None
[0m17:12:35.628797 [info ] [MainThread]:   gcs_bucket: None
[0m17:12:35.628797 [info ] [MainThread]:   dataproc_batch: None
[0m17:12:35.629795 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:12:35.629795 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m17:12:35.629795 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:12:35.631816 [debug] [MainThread]: On debug: select 1 as id
[0m17:12:36.496491 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13dd5e7a-722f-4ed2-8bae-a2e84d0d6789&page=queryresults
[0m17:12:36.998680 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m17:12:36.998680 [info ] [MainThread]: [32mAll checks passed![0m
[0m17:12:36.998680 [debug] [MainThread]: Command `dbt debug` succeeded at 17:12:36.998680 after 1.96 seconds
[0m17:12:36.998680 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m17:12:36.998680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D59623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D8EF0A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D8F81F10>]}
[0m17:12:36.998680 [debug] [MainThread]: Flushing usage events
[0m18:00:05.007392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019108A49430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CC640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CCAC0>]}


============================== 18:00:05.018302 | ad301add-a93a-4793-8992-f3d1e39e677b ==============================
[0m18:00:05.018302 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:05.018302 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m18:00:05.401666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CC850>]}
[0m18:00:05.460741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C0C0B20>]}
[0m18:00:05.467926 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:05.467926 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:05.467926 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m18:00:05.467926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C02F160>]}
[0m18:00:06.166971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4878B0>]}
[0m18:00:06.215473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4F39D0>]}
[0m18:00:06.215473 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:06.215473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4F3700>]}
[0m18:00:06.215473 [info ] [MainThread]: 
[0m18:00:06.215473 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:06.215473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:06.215473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:06.215473 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.215473 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.088093 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:07.823016 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:00:07.834854 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:07.834854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.834854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:08.521720 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:00:08.521720 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:09.211841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4DF580>]}
[0m18:00:09.211841 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:09.211841 [info ] [MainThread]: 
[0m18:00:09.211841 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.227585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m18:00:09.227585 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m18:00:09.227585 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m18:00:09.227585 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m18:00:09.227585 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.227585 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m18:00:09.243417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:09.243417 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m18:00:09.259508 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m18:00:09.259508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 18:00:09.227585 => 18:00:09.259508
[0m18:00:09.259508 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.270113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 18:00:09.243417 => 18:00:09.270113
[0m18:00:09.270113 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m18:00:09.355618 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m18:00:09.370086 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:09.371596 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:00:09.371596 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:09.371596 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m18:00:09.371596 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m18:00:10.286768 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e72ae9cc-3b7b-4a6a-a478-1aa20d9e36ef&page=queryresults
[0m18:00:10.286768 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d8c3af9-06ee-4813-aaec-2619d001877c&page=queryresults
[0m18:00:10.818233 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 18:00:09.259508 => 18:00:10.818233
[0m18:00:10.818233 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C281940>]}
[0m18:00:10.818233 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m18:00:10.818233 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m18:00:10.850294 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 18:00:09.291599 => 18:00:10.850294
[0m18:00:10.850294 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C2E8280>]}
[0m18:00:10.850294 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m18:00:10.850294 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m18:00:10.850294 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m18:00:10.850294 [info ] [Thread-1  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m18:00:10.850294 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.dm_produto)
[0m18:00:10.850294 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m18:00:10.866189 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m18:00:10.866189 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 18:00:10.850294 => 18:00:10.866189
[0m18:00:10.866189 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m18:00:10.897941 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:11.618256 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m18:00:11.618256 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m18:00:12.422795 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd44dca5-dd31-44cc-af16-ae5212577f46&page=queryresults
[0m18:00:16.733204 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 18:00:10.879808 => 18:00:16.733204
[0m18:00:16.733204 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C504250>]}
[0m18:00:16.733204 [info ] [Thread-1  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 5.88s]
[0m18:00:16.749406 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m18:00:16.749406 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m18:00:16.749406 [info ] [Thread-2  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m18:00:16.749406 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m18:00:16.749406 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:00:16.749406 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:00:16.749406 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:00:16.749406 => 18:00:16.749406
[0m18:00:16.749406 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:00:16.765587 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:17.455152 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:00:17.455152 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m18:00:18.172430 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9da07ae2-dc15-4119-bd4d-5ff7ec608cb8&page=queryresults
[0m18:00:20.273408 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:00:16.749406 => 18:00:20.273408
[0m18:00:20.275426 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C5D1DF0>]}
[0m18:00:20.277442 [info ] [Thread-2  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.53s]
[0m18:00:20.277442 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:00:20.283180 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m18:00:20.283180 [info ] [MainThread]: 
[0m18:00:20.283180 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 14.07 seconds (14.07s).
[0m18:00:20.283180 [debug] [MainThread]: Command end result
[0m18:00:20.315079 [info ] [MainThread]: 
[0m18:00:20.317102 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:20.319117 [info ] [MainThread]: 
[0m18:00:20.319117 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m18:00:20.319117 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:20.319117 after 15.37 seconds
[0m18:00:20.319117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019108A49430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C13A610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C555CA0>]}
[0m18:00:20.319117 [debug] [MainThread]: Flushing usage events
[0m19:00:03.720974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEC153430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D3640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D3AC0>]}


============================== 19:00:03.720974 | 772eca72-2777-4b49-8085-97dea2277281 ==============================
[0m19:00:03.720974 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:00:03.720974 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:04.070018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0BB910>]}
[0m19:00:04.137313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF885C40>]}
[0m19:00:04.139319 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:00:04.143611 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:00:04.213974 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:00:04.213974 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:00:04.213974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA52340>]}
[0m19:00:04.229094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D36D0>]}
[0m19:00:04.229094 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:00:04.229094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF74C190>]}
[0m19:00:04.229094 [info ] [MainThread]: 
[0m19:00:04.229094 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:00:04.229094 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.229094 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.229094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:04.229094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:05.084288 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:05.769765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:00:05.769765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:00:05.769765 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:05.769765 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:06.442477 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:00:06.442477 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:07.116072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA848B0>]}
[0m19:00:07.116072 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:07.116072 [info ] [MainThread]: 
[0m19:00:07.131532 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.131532 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m19:00:07.131532 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m19:00:07.131532 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m19:00:07.131532 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m19:00:07.131532 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.131532 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m19:00:07.147382 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.147382 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m19:00:07.147382 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m19:00:07.147382 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 19:00:07.131532 => 19:00:07.147382
[0m19:00:07.147382 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 19:00:07.147382 => 19:00:07.147382
[0m19:00:07.147382 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.147382 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m19:00:07.194994 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.194994 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m19:00:07.194994 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:00:07.202623 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m19:00:07.202623 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m19:00:07.210680 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m19:00:08.594532 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e4e82d2-66e6-4e55-a8b3-7c7e55192118&page=queryresults
[0m19:00:08.594532 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71fe4268-1462-446d-8a52-a19ff3a6bbbe&page=queryresults
[0m19:00:09.124575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 19:00:07.178819 => 19:00:09.124575
[0m19:00:09.139871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 19:00:07.163102 => 19:00:09.139871
[0m19:00:09.139871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFAD4FD0>]}
[0m19:00:09.139871 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDF0B3AB80>]}
[0m19:00:09.139871 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 2.01s]
[0m19:00:09.139871 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m19:00:09.139871 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 2.01s]
[0m19:00:09.139871 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m19:00:09.139871 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m19:00:09.139871 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m19:00:09.139871 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m19:00:09.139871 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m19:00:09.155868 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m19:00:09.155868 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 19:00:09.139871 => 19:00:09.155868
[0m19:00:09.155868 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m19:00:09.155868 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:09.957786 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m19:00:09.957786 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m19:00:10.648682 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c0197bf-c6ba-4404-a3b5-52508f557c33&page=queryresults
[0m19:00:12.956435 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 19:00:09.155868 => 19:00:12.956435
[0m19:00:12.956435 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA5FCA0>]}
[0m19:00:12.956435 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.82s]
[0m19:00:12.956435 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m19:00:12.956435 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m19:00:12.956435 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m19:00:12.956435 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m19:00:12.956435 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m19:00:12.972609 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m19:00:12.972609 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 19:00:12.956435 => 19:00:12.972609
[0m19:00:12.972609 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m19:00:12.972609 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:13.598442 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m19:00:13.598442 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m19:00:14.226514 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11117059-86d2-48cc-8005-8e8fa408f0f3&page=queryresults
[0m19:00:16.525816 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 19:00:12.972609 => 19:00:16.525816
[0m19:00:16.537354 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFAE7CD0>]}
[0m19:00:16.537354 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.58s]
[0m19:00:16.537354 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m19:00:16.537354 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m19:00:16.537354 [info ] [MainThread]: 
[0m19:00:16.537354 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 12.31 seconds (12.31s).
[0m19:00:16.537354 [debug] [MainThread]: Command end result
[0m19:00:16.578953 [info ] [MainThread]: 
[0m19:00:16.578953 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:16.578953 [info ] [MainThread]: 
[0m19:00:16.578953 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m19:00:16.578953 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:16.578953 after 12.92 seconds
[0m19:00:16.578953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEC153430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF74C2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF78B550>]}
[0m19:00:16.585228 [debug] [MainThread]: Flushing usage events
[0m20:00:04.523314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF02E9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C8E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C5E0>]}


============================== 20:00:04.523314 | 168c0ccb-312f-48c2-9290-93f9e352014c ==============================
[0m20:00:04.523314 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:04.523314 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:00:05.034027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF2435AF0>]}
[0m20:00:05.097599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF273EE0>]}
[0m20:00:05.097599 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:05.113327 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:05.145302 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:05.161245 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3BF1EE0>]}
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3B2E160>]}
[0m20:00:05.161245 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF39B3880>]}
[0m20:00:05.175490 [info ] [MainThread]: 
[0m20:00:05.177242 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:05.177242 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.177242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:05.177242 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.177242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.061063 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:06.748736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:00:06.748736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:00:06.748736 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.748736 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:07.438076 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:00:07.438076 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:08.143410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF38B2550>]}
[0m20:00:08.143410 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:08.143410 [info ] [MainThread]: 
[0m20:00:08.159427 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.159427 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m20:00:08.159427 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m20:00:08.159427 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m20:00:08.166746 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.159427 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m20:00:08.175133 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m20:00:08.175133 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m20:00:08.175133 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m20:00:08.188643 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.191051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 20:00:08.166746 => 20:00:08.188643
[0m20:00:08.191051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 20:00:08.175133 => 20:00:08.191051
[0m20:00:08.191051 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.191051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m20:00:08.224997 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.224997 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m20:00:08.224997 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:08.239177 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m20:00:08.270954 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m20:00:08.270954 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m20:00:09.170336 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c2d279c-6ff5-4b35-a464-bc89f4126b23&page=queryresults
[0m20:00:09.202339 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7e81f02c-6673-4b10-9da5-456116ec30aa&page=queryresults
[0m20:00:09.703946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 20:00:08.222987 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 20:00:08.191051 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3BFFB50>]}
[0m20:00:09.703946 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C979A0>]}
[0m20:00:09.703946 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m20:00:09.703946 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m20:00:09.703946 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m20:00:09.703946 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m20:00:09.703946 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m20:00:09.703946 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m20:00:09.703946 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m20:00:09.703946 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m20:00:09.703946 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m20:00:09.703946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 20:00:09.703946 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m20:00:09.719667 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:10.347597 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m20:00:10.347597 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m20:00:11.024570 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e287232c-d405-4cd0-97fb-1ec96c0a8cce&page=queryresults
[0m20:00:13.943898 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 20:00:09.703946 => 20:00:13.943898
[0m20:00:13.943898 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C8FE80>]}
[0m20:00:13.943898 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.24s]
[0m20:00:13.943898 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m20:00:13.943898 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:00:13.943898 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:00:13.943898 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m20:00:13.943898 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:00:13.943898 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:00:13.960027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:00:13.943898 => 20:00:13.960027
[0m20:00:13.961291 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:00:13.963305 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:14.647460 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:00:14.649477 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m20:00:15.292656 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:90f1957a-392a-4e23-aee9-0f4fab45be70&page=queryresults
[0m20:00:17.611708 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:00:13.961291 => 20:00:17.609693
[0m20:00:17.611708 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C8FEE0>]}
[0m20:00:17.613467 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.67s]
[0m20:00:17.613467 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:00:17.616882 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:00:17.621356 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m20:00:17.621356 [info ] [MainThread]: 
[0m20:00:17.621356 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 12.44 seconds (12.44s).
[0m20:00:17.623368 [debug] [MainThread]: Command end result
[0m20:00:17.645299 [info ] [MainThread]: 
[0m20:00:17.645299 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:00:17.645299 [info ] [MainThread]: 
[0m20:00:17.645299 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m20:00:17.645299 [debug] [MainThread]: Command `dbt run` succeeded at 20:00:17.645299 after 13.22 seconds
[0m20:00:17.645299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF02E9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF38B8130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C2E0>]}
[0m20:00:17.645299 [debug] [MainThread]: Flushing usage events
[0m21:00:04.379222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A50F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A406B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A406BE20>]}


============================== 21:00:04.382985 | 74e96246-ea25-48fa-9287-20f9684f7233 ==============================
[0m21:00:04.382985 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:04.382985 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:00:04.717087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A4059340>]}
[0m21:00:04.777861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8770AC0>]}
[0m21:00:04.777861 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:04.787277 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:04.825723 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:04.825723 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:04.825723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A01FA0>]}
[0m21:00:04.841809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A89ECFD0>]}
[0m21:00:04.841809 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:04.841809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A882FD00>]}
[0m21:00:04.841809 [info ] [MainThread]: 
[0m21:00:04.841809 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:04.841809 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.841809 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:04.858022 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.874227 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:05.898162 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:06.528758 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:00:06.528758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.528758 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:00:06.528758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:07.230830 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:00:07.232846 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:07.859829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A86FA7F0>]}
[0m21:00:07.859829 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:07.859829 [info ] [MainThread]: 
[0m21:00:07.873635 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.873635 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m21:00:07.873635 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m21:00:07.873635 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:00:07.873635 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m21:00:07.873635 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.873635 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m21:00:07.889601 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:00:07.889601 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:00:07.905399 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.905399 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:00:07.873635 => 21:00:07.905399
[0m21:00:07.905399 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.905399 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:00:07.889601 => 21:00:07.905399
[0m21:00:07.937322 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:00:07.937322 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.953418 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:00:07.953418 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:07.953418 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:00:07.985535 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:00:07.985535 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:00:08.853866 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5536ea10-36e0-4604-b372-e413f0a3e629&page=queryresults
[0m21:00:08.853866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9ba7dd82-cc6a-4258-991c-894ae2c9c3c3&page=queryresults
[0m21:00:09.341092 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:00:07.937322 => 21:00:09.340101
[0m21:00:09.341092 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A03040>]}
[0m21:00:09.344161 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:00:07.905399 => 21:00:09.343052
[0m21:00:09.345118 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8AB7BB0>]}
[0m21:00:09.344161 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m21:00:09.346158 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:00:09.345118 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m21:00:09.347102 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.347102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m21:00:09.348096 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:00:09.348503 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m21:00:09.349513 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:00:09.353513 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:00:09.353513 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:00:09.349513 => 21:00:09.353513
[0m21:00:09.353513 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:00:09.369576 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:09.980183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:00:09.996403 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:00:10.756685 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:121b4f37-e57f-4537-92bc-c9789b2a62f7&page=queryresults
[0m21:00:13.118487 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:00:09.353513 => 21:00:13.118487
[0m21:00:13.118487 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8AB7BB0>]}
[0m21:00:13.118487 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.77s]
[0m21:00:13.118487 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:00:13.134531 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m21:00:13.134531 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m21:00:13.134531 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m21:00:13.138741 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:00:13.144783 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:00:13.146795 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:00:13.138741 => 21:00:13.146795
[0m21:00:13.146795 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:00:13.152417 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:13.839391 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:00:13.841149 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:00:14.551681 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db0d4334-b525-448b-ad1a-9db871c284d1&page=queryresults
[0m21:00:16.601990 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:00:13.146795 => 21:00:16.601990
[0m21:00:16.601990 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A9FAF0>]}
[0m21:00:16.601990 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.47s]
[0m21:00:16.601990 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:00:16.610216 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:00:16.614275 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m21:00:16.614275 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m21:00:16.614275 [info ] [MainThread]: 
[0m21:00:16.614275 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.77 seconds (11.77s).
[0m21:00:16.617648 [debug] [MainThread]: Command end result
[0m21:00:16.639690 [info ] [MainThread]: 
[0m21:00:16.639690 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:00:16.639690 [info ] [MainThread]: 
[0m21:00:16.649265 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m21:00:16.649265 [debug] [MainThread]: Command `dbt run` succeeded at 21:00:16.649265 after 12.33 seconds
[0m21:00:16.649265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A50F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8678D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A864C040>]}
[0m21:00:16.649265 [debug] [MainThread]: Flushing usage events
[0m21:11:15.195158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBE425400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBD3896A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBD389DC0>]}


============================== 21:11:15.198628 | 7e3b7990-7cc0-4753-a5fe-10182248f808 ==============================
[0m21:11:15.198628 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:11:15.199627 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_composicao_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:11:15.561764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC0570B20>]}
[0m21:11:15.622048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1A929D0>]}
[0m21:11:15.623040 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:11:15.629577 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:11:15.693439 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:11:15.693439 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_composicao_produto.sql
[0m21:11:15.789917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1E69D90>]}
[0m21:11:15.799057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1BCFB50>]}
[0m21:11:15.799057 [info ] [MainThread]: Found 5 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:11:15.800165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1BCF130>]}
[0m21:11:15.801056 [info ] [MainThread]: 
[0m21:11:15.801925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:11:15.803034 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:11:15.803932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:16.585594 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:11:16.586596 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:11:16.587592 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:16.587592 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:17.220847 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:11:17.221843 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:11:17.849028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1AF1550>]}
[0m21:11:17.851047 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:11:17.853044 [info ] [MainThread]: 
[0m21:11:17.863881 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.864879 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m21:11:17.866735 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_composicao_produto'
[0m21:11:17.866735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.875690 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:11:17.877222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:11:17.867786 => 21:11:17.877222
[0m21:11:17.877222 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.902278 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:11:17.904285 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:11:17.905280 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:11:18.795880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50d92d06-725b-4951-aabb-4526b4c761e0&page=queryresults
[0m21:11:19.374828 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:11:17.878261 => 21:11:19.374828
[0m21:11:19.374828 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1E69F40>]}
[0m21:11:19.375825 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m21:11:19.376772 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:11:19.378248 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:11:19.379304 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_composicao_produto' was properly closed.
[0m21:11:19.379304 [info ] [MainThread]: 
[0m21:11:19.380250 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.58 seconds (3.58s).
[0m21:11:19.380250 [debug] [MainThread]: Command end result
[0m21:11:19.386974 [info ] [MainThread]: 
[0m21:11:19.388019 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:11:19.389016 [info ] [MainThread]: 
[0m21:11:19.389332 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:11:19.391341 [debug] [MainThread]: Command `dbt run` succeeded at 21:11:19.390386 after 4.27 seconds
[0m21:11:19.391341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBE425400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC19B2640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1D3ED60>]}
[0m21:11:19.391341 [debug] [MainThread]: Flushing usage events
[0m21:19:38.646003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FE575370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FFEF4BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FD4E3D30>]}


============================== 21:19:38.646003 | bd5b2234-2e49-4b83-9856-5c96572dadb6 ==============================
[0m21:19:38.646003 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:19:38.646003 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:19:39.030853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FD4CC880>]}
[0m21:19:39.090413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081CCAFD0>]}
[0m21:19:39.090413 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:19:39.100494 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:19:39.150331 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:19:39.150331 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:19:39.240508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081F11A60>]}
[0m21:19:39.250493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081E79D90>]}
[0m21:19:39.250493 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:19:39.250493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081E79C40>]}
[0m21:19:39.250493 [info ] [MainThread]: 
[0m21:19:39.259910 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:19:39.260547 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:19:39.260547 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.081469 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:19:40.081469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.114981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:19:40.114981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.810414 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:19:40.810414 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:41.440973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081B20610>]}
[0m21:19:41.440973 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:19:41.440973 [info ] [MainThread]: 
[0m21:19:41.455660 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.455660 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:19:41.461114 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:19:41.463208 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.475766 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:19:41.479313 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:19:41.463208 => 21:19:41.478072
[0m21:19:41.481574 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.521488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:19:41.522495 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:19:41.524495 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:19:42.861910 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1923e776-fffe-4bf9-8bc6-c22edd5f1ef6&page=queryresults
[0m21:19:44.980867 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:19:41.482583 => 21:19:44.980867
[0m21:19:44.980867 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002508200E6A0>]}
[0m21:19:44.980867 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.52s]
[0m21:19:44.980867 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:19:44.980867 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:19:44.980867 [info ] [MainThread]: 
[0m21:19:44.980867 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.72 seconds (5.72s).
[0m21:19:44.980867 [debug] [MainThread]: Command end result
[0m21:19:45.002197 [info ] [MainThread]: 
[0m21:19:45.003560 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:19:45.005668 [info ] [MainThread]: 
[0m21:19:45.006769 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:19:45.007759 [debug] [MainThread]: Command `dbt run` succeeded at 21:19:45.007759 after 6.41 seconds
[0m21:19:45.008758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FE575370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081CCAFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081B43370>]}
[0m21:19:45.008758 [debug] [MainThread]: Flushing usage events
[0m21:20:38.074048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155E8B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D858310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D858790>]}


============================== 21:20:38.076997 | 0aea6e40-3821-4fa3-acd3-546e2100cc0f ==============================
[0m21:20:38.076997 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:20:38.077506 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:20:38.422306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D83CA90>]}
[0m21:20:38.481171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215612BFA90>]}
[0m21:20:38.482166 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:20:38.487776 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:20:38.580185 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:20:38.581183 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:20:38.677798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215622C1F10>]}
[0m21:20:38.687800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215621CB3D0>]}
[0m21:20:38.687800 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:20:38.688804 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215621CB250>]}
[0m21:20:38.689795 [info ] [MainThread]: 
[0m21:20:38.689795 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:20:38.691801 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:20:38.691801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:39.409910 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:20:39.411906 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:39.413902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:20:39.414907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:40.092984 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:20:40.093983 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:20:40.824805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021561F9D2B0>]}
[0m21:20:40.827404 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:20:40.829457 [info ] [MainThread]: 
[0m21:20:40.843218 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.845221 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:20:40.848975 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:20:40.851537 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.884853 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:20:40.885853 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:20:40.853510 => 21:20:40.885853
[0m21:20:40.888335 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.906770 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:20:41.667628 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:20:41.668688 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_base_produto               as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao_base
  order by nm_produto_completo
    );
  
[0m21:20:42.049544 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad0db52a-df3e-4d72-953f-6a771f9549a3&page=queryresults
[0m21:20:42.051488 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).')
[0m21:20:42.459508 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9b1e583-b3e8-4732-9ae4-d6a7b45251ff&page=queryresults
[0m21:20:42.461469 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9b1e583-b3e8-4732-9ae4-d6a7b45251ff&page=queryresults
[0m21:20:42.463462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:20:40.889331 => 21:20:42.462461
[0m21:20:42.473340 [debug] [Thread-1  ]: Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:20:42.474349 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021562383C10>]}
[0m21:20:42.475377 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_composicao_produto .......... [[31mERROR[0m in 1.63s]
[0m21:20:42.477336 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:20:42.480335 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:20:42.480335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:20:42.480335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:20:42.481326 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:20:42.481326 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:20:42.481326 [info ] [MainThread]: 
[0m21:20:42.482377 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.79 seconds (3.79s).
[0m21:20:42.483335 [debug] [MainThread]: Command end result
[0m21:20:42.492633 [info ] [MainThread]: 
[0m21:20:42.493646 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:20:42.493646 [info ] [MainThread]: 
[0m21:20:42.494624 [error] [MainThread]:   Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:20:42.495605 [info ] [MainThread]: 
[0m21:20:42.496645 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:20:42.497599 [debug] [MainThread]: Command `dbt run` failed at 21:20:42.497599 after 4.47 seconds
[0m21:20:42.498690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155E8B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215612BFA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002156229D5B0>]}
[0m21:20:42.498690 [debug] [MainThread]: Flushing usage events
[0m21:21:07.822364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA3CD1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C679D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C67B80>]}


============================== 21:21:07.825410 | e7f0668f-eea5-43b7-85f9-710b537b078d ==============================
[0m21:21:07.825410 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:21:07.826348 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:21:08.228820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C6F9A0>]}
[0m21:21:08.293475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA73627C0>]}
[0m21:21:08.294483 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:21:08.300009 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:21:08.387771 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:21:08.388916 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:21:08.495305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA76E9430>]}
[0m21:21:08.506084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA75E87F0>]}
[0m21:21:08.506084 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:21:08.507084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA75E8700>]}
[0m21:21:08.507623 [info ] [MainThread]: 
[0m21:21:08.508783 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:21:08.510665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:21:08.510665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.190332 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:21:09.191329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.193320 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:21:09.194327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.907243 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:21:09.908342 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:10.621796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA725B3D0>]}
[0m21:21:10.622771 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:21:10.622771 [info ] [MainThread]: 
[0m21:21:10.626772 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.627767 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:21:10.627767 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:21:10.628750 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.634748 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:10.635748 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:21:10.628750 => 21:21:10.635748
[0m21:21:10.636761 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.649665 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:21:11.307595 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:11.308604 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto               as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao_base
  order by nm_produto_completo
    );
  
[0m21:21:12.054567 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7724dc48-a828-4179-b48b-f45b7ab937c8&page=queryresults
[0m21:21:12.457518 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]')
[0m21:21:13.554935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:485ce690-26e0-4115-b828-8a156f211fea&page=queryresults
[0m21:21:13.997110 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:485ce690-26e0-4115-b828-8a156f211fea&page=queryresults
[0m21:21:13.999161 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:21:10.636761 => 21:21:13.998157
[0m21:21:14.004110 [debug] [Thread-1  ]: Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:21:14.005102 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA87DDA60>]}
[0m21:21:14.005102 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_composicao_produto .......... [[31mERROR[0m in 3.38s]
[0m21:21:14.006100 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:21:14.008573 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:14.008573 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:21:14.009623 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:21:14.009623 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:21:14.010618 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:21:14.010618 [info ] [MainThread]: 
[0m21:21:14.010618 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.50 seconds (5.50s).
[0m21:21:14.011618 [debug] [MainThread]: Command end result
[0m21:21:14.027883 [info ] [MainThread]: 
[0m21:21:14.028961 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:21:14.030912 [info ] [MainThread]: 
[0m21:21:14.032949 [error] [MainThread]:   Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:21:14.033910 [info ] [MainThread]: 
[0m21:21:14.035914 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:21:14.039422 [debug] [MainThread]: Command `dbt run` failed at 21:21:14.039422 after 6.27 seconds
[0m21:21:14.040427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA3CD1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA73627C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA7783820>]}
[0m21:21:14.042416 [debug] [MainThread]: Flushing usage events
[0m21:21:47.274947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EF8BB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EE8499D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EE849B80>]}


============================== 21:21:47.277698 | a8252cdd-19fb-4f47-8627-0982d64571c6 ==============================
[0m21:21:47.277698 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:21:47.278738 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_composicao_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:21:47.624323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F1A0BB80>]}
[0m21:21:47.684957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F2F29460>]}
[0m21:21:47.685959 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:21:47.692523 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:21:47.798862 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:21:47.799866 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:21:47.899863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F32A3190>]}
[0m21:21:47.907819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31B74F0>]}
[0m21:21:47.908875 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:21:47.909812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31B7370>]}
[0m21:21:47.909812 [info ] [MainThread]: 
[0m21:21:47.910945 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:21:47.912867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:21:47.912867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:48.617680 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:21:48.619838 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:48.621833 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:21:48.622914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:49.309908 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:21:49.312849 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:50.044761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F2EBDD90>]}
[0m21:21:50.044761 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:21:50.045761 [info ] [MainThread]: 
[0m21:21:50.049092 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.049092 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:21:50.050093 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:21:50.051108 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.057483 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:50.058475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:21:50.051108 => 21:21:50.058475
[0m21:21:50.058475 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.072482 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:21:50.791518 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:50.792499 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:21:51.483836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e646e4b2-660b-409c-877a-eac26a53b271&page=queryresults
[0m21:21:56.691075 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:21:50.059488 => 21:21:56.691075
[0m21:21:56.693070 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F3393760>]}
[0m21:21:56.694062 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 103.3 KiB processed)[0m in 6.64s]
[0m21:21:56.694062 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:21:56.697057 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:56.698056 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:21:56.698056 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:21:56.699054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:21:56.699054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:21:56.699054 [info ] [MainThread]: 
[0m21:21:56.700059 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.79 seconds (8.79s).
[0m21:21:56.701058 [debug] [MainThread]: Command end result
[0m21:21:56.708149 [info ] [MainThread]: 
[0m21:21:56.709075 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:21:56.709075 [info ] [MainThread]: 
[0m21:21:56.710069 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:21:56.711087 [debug] [MainThread]: Command `dbt run` succeeded at 21:21:56.711087 after 9.49 seconds
[0m21:21:56.711087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EF8BB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F3371700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31E61F0>]}
[0m21:21:56.711087 [debug] [MainThread]: Flushing usage events
[0m21:24:22.055334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C293849460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927D59D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927D5B80>]}


============================== 21:24:22.058029 | ea6be0e2-87bc-436d-bb90-816556ba95bc ==============================
[0m21:24:22.058029 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:24:22.059044 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:24:22.412971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927CC130>]}
[0m21:24:22.473209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296E65340>]}
[0m21:24:22.474211 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:24:22.481622 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:24:22.583881 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:24:22.584879 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:24:22.679737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29720AEE0>]}
[0m21:24:22.688401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29715B430>]}
[0m21:24:22.689403 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:24:22.690343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29715B2B0>]}
[0m21:24:22.691404 [info ] [MainThread]: 
[0m21:24:22.691404 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:24:22.693402 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:24:22.693402 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:23.444152 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:24:23.445152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:23.447120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:24:23.447733 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:24.115217 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:24:24.118227 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:24:24.776622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296F2B6D0>]}
[0m21:24:24.778510 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:24:24.779526 [info ] [MainThread]: 
[0m21:24:24.787487 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.788143 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:24:24.790156 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:24:24.790156 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.805718 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:24:24.807443 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:24:24.791154 => 21:24:24.806709
[0m21:24:24.808463 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.821752 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:24:25.525561 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:24:25.526447 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:24:26.315832 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87d2edd5-dbd8-430a-836a-1533b8330a75&page=queryresults
[0m21:24:28.203298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:24:24.808463 => 21:24:28.203298
[0m21:24:28.204299 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29732C520>]}
[0m21:24:28.205297 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 103.3 KiB processed)[0m in 3.42s]
[0m21:24:28.206802 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:24:28.208570 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:24:28.209602 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:24:28.209602 [info ] [MainThread]: 
[0m21:24:28.210590 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.52 seconds (5.52s).
[0m21:24:28.211511 [debug] [MainThread]: Command end result
[0m21:24:28.219510 [info ] [MainThread]: 
[0m21:24:28.220502 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:24:28.221545 [info ] [MainThread]: 
[0m21:24:28.222531 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:24:28.222835 [debug] [MainThread]: Command `dbt run` succeeded at 21:24:28.222835 after 6.22 seconds
[0m21:24:28.223945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C293849460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296E34070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C297179D30>]}
[0m21:24:28.223945 [debug] [MainThread]: Flushing usage events
[0m21:25:48.016285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882CB6D400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAE7910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAE7B80>]}


============================== 21:25:48.018284 | 9f88bc40-db82-4222-99f5-17958702cbde ==============================
[0m21:25:48.018284 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:25:48.019303 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models dm_produto+', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:25:48.389039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAF67C0>]}
[0m21:25:48.450953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188301E2AC0>]}
[0m21:25:48.452012 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:25:48.458643 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:25:48.556059 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:25:48.557065 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m21:25:48.655615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018830537400>]}
[0m21:25:48.664315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018830467760>]}
[0m21:25:48.664315 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:25:48.665378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883043C550>]}
[0m21:25:48.666395 [info ] [MainThread]: 
[0m21:25:48.667312 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:25:48.668976 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:25:48.668976 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:48.694427 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:25:48.695431 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.046956 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:25:50.048072 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.078789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:25:50.078789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.755656 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:25:50.757654 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:25:51.454550 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188302A2460>]}
[0m21:25:51.456643 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:25:51.457432 [info ] [MainThread]: 
[0m21:25:51.465079 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:25:51.467097 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:25:51.469119 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m21:25:51.469119 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:25:51.485634 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:25:51.487119 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:25:51.470115 => 21:25:51.487119
[0m21:25:51.488126 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:25:51.504141 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:25:52.255684 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:25:52.256681 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao' ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:25:52.634969 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c40dd30-69e0-495a-a1e5-56dd99a642ae&page=queryresults
[0m21:25:52.635968 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]')
[0m21:25:53.864243 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08197888-bf96-4824-ac1c-ac4dea2233b8&page=queryresults
[0m21:25:53.866239 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08197888-bf96-4824-ac1c-ac4dea2233b8&page=queryresults
[0m21:25:53.867559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:25:51.488126 => 21:25:53.867559
[0m21:25:53.875878 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m21:25:53.877734 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018831695F10>]}
[0m21:25:53.878848 [error] [Thread-1  ]: 1 of 3 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 2.41s]
[0m21:25:53.880762 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:25:53.882751 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:25:53.882751 [info ] [Thread-2  ]: 2 of 3 SKIP relation dbt_dw_az.tb_produto ...................................... [[33mSKIP[0m]
[0m21:25:53.884205 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:25:53.886273 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:25:53.887310 [info ] [Thread-1  ]: 3 of 3 SKIP relation dbt_dw_az.tb_composicao_produto ........................... [[33mSKIP[0m]
[0m21:25:53.888870 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:25:53.892779 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:25:53.892779 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:25:53.894814 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m21:25:53.895824 [info ] [MainThread]: 
[0m21:25:53.896779 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 5.23 seconds (5.23s).
[0m21:25:53.897779 [debug] [MainThread]: Command end result
[0m21:25:53.909825 [info ] [MainThread]: 
[0m21:25:53.911832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:25:53.912830 [info ] [MainThread]: 
[0m21:25:53.915000 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m21:25:53.916017 [info ] [MainThread]: 
[0m21:25:53.916017 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=2 TOTAL=3
[0m21:25:53.917009 [debug] [MainThread]: Command `dbt run` failed at 21:25:53.917009 after 5.96 seconds
[0m21:25:53.918004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882CB6D400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188301E2AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188302896A0>]}
[0m21:25:53.918004 [debug] [MainThread]: Flushing usage events
[0m21:26:06.086859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020000D9D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200038436A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020003843DC0>]}


============================== 21:26:06.089857 | fa148bc6-8fd2-4de8-9d80-e72ca074a45a ==============================
[0m21:26:06.089857 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:26:06.091137 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models dm_produto+', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:26:06.475627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020003832BB0>]}
[0m21:26:06.536139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002000457E940>]}
[0m21:26:06.537145 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:26:06.543595 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:26:06.631776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:26:06.631776 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m21:26:06.725204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200048CCB20>]}
[0m21:26:06.734848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200046B2CA0>]}
[0m21:26:06.734848 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:26:06.735874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002000450ECA0>]}
[0m21:26:06.736848 [info ] [MainThread]: 
[0m21:26:06.737409 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:26:06.738480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:26:06.739498 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:06.761789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:26:06.762852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:07.943482 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:26:07.945492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:07.947048 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:26:07.949091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:08.618318 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:26:08.619438 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:26:09.277242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200049B3250>]}
[0m21:26:09.281364 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:26:09.283368 [info ] [MainThread]: 
[0m21:26:09.294358 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:26:09.295380 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:26:09.297365 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m21:26:09.297365 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:26:09.308818 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:26:09.309787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:26:09.298362 => 21:26:09.309787
[0m21:26:09.310790 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:26:09.320613 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:26:10.072561 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:26:10.073557 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:26:10.760413 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79b6755b-2dda-4373-8b00-1b0df65eca8d&page=queryresults
[0m21:26:13.236367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:26:09.310790 => 21:26:13.236367
[0m21:26:13.237373 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020004A0CCA0>]}
[0m21:26:13.237966 [info ] [Thread-1  ]: 1 of 3 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.94s]
[0m21:26:13.238978 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:26:13.239476 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:26:13.240484 [info ] [Thread-2  ]: 2 of 3 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m21:26:13.241482 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m21:26:13.241482 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:26:13.244589 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:26:13.245487 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:26:13.241482 => 21:26:13.244589
[0m21:26:13.245487 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:26:13.247904 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:26:13.935038 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:26:13.938038 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:26:14.651069 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6bc578ce-29d1-42b7-b782-132337dac852&page=queryresults
[0m21:26:16.640440 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:26:13.245487 => 21:26:16.640440
[0m21:26:16.642438 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020005A20CA0>]}
[0m21:26:16.643439 [info ] [Thread-2  ]: 2 of 3 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.40s]
[0m21:26:16.645452 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:26:16.646879 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.647921 [info ] [Thread-1  ]: 3 of 3 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:26:16.650921 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:26:16.651926 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.659918 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:26:16.662922 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:26:16.651926 => 21:26:16.662003
[0m21:26:16.662922 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.672451 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:26:17.328267 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:26:17.330285 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:26:17.993827 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3df1375-e1e3-47ea-b7b9-7f62d2193f15&page=queryresults
[0m21:26:20.087302 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:26:16.664010 => 21:26:20.086690
[0m21:26:20.088445 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200048AE400>]}
[0m21:26:20.089452 [info ] [Thread-1  ]: 3 of 3 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.44s]
[0m21:26:20.091392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:26:20.095335 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:26:20.096241 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:26:20.096241 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:26:20.097237 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:26:20.097960 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:26:20.097960 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:26:20.099072 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m21:26:20.099987 [info ] [MainThread]: 
[0m21:26:20.100980 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 13.36 seconds (13.36s).
[0m21:26:20.102980 [debug] [MainThread]: Command end result
[0m21:26:20.121510 [info ] [MainThread]: 
[0m21:26:20.123507 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:26:20.124506 [info ] [MainThread]: 
[0m21:26:20.125508 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m21:26:20.128072 [debug] [MainThread]: Command `dbt run` succeeded at 21:26:20.127056 after 14.10 seconds
[0m21:26:20.128072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020000D9D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200044BF220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020004839880>]}
[0m21:26:20.129072 [debug] [MainThread]: Flushing usage events
[0m22:00:03.598557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D68723D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D57F99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D57F9B80>]}


============================== 22:00:03.601591 | 305f2aab-1fc9-4c8c-99fc-fa94de359d02 ==============================
[0m22:00:03.601591 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:00:03.601591 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m22:00:03.946974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D89BAAF0>]}
[0m22:00:04.005222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9EE16A0>]}
[0m22:00:04.006228 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:00:04.012649 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:00:04.057684 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:04.057684 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:04.061692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA179670>]}
[0m22:00:04.071083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA097310>]}
[0m22:00:04.072081 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:00:04.072081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA097220>]}
[0m22:00:04.074098 [info ] [MainThread]: 
[0m22:00:04.074427 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:00:04.076450 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:04.076450 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:04.077490 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:04.099187 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:04.895428 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:05.576056 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:00:05.577715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:05.579736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:00:05.581741 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:06.226240 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:00:06.227223 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:06.997729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9F5FE50>]}
[0m22:00:07.001769 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:00:07.002778 [info ] [MainThread]: 
[0m22:00:07.009738 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.010724 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.010724 [info ] [Thread-1  ]: 1 of 6 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m22:00:07.012717 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m22:00:07.011732 [info ] [Thread-2  ]: 2 of 6 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m22:00:07.014729 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.015719 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_composicao_produto'
[0m22:00:07.022722 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:07.022722 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.025721 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:07.027719 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 22:00:07.023716 => 22:00:07.027719
[0m22:00:07.027719 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.036749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 22:00:07.016727 => 22:00:07.035806
[0m22:00:07.036749 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.058191 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:07.059198 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:07.061273 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m22:00:07.062248 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:00:07.084403 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:00:07.086753 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m22:00:07.987675 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:03178061-87ed-48e0-a935-e513986cc2a1&page=queryresults
[0m22:00:08.022223 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26a48e51-e451-44ab-b536-69c675b325e7&page=queryresults
[0m22:00:08.484547 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 22:00:07.027719 => 22:00:08.484547
[0m22:00:08.485555 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA219D00>]}
[0m22:00:08.489437 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 22:00:07.037137 => 22:00:08.489437
[0m22:00:08.490388 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1C8820>]}
[0m22:00:08.485555 [info ] [Thread-2  ]: 2 of 6 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m22:00:08.491427 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m22:00:08.491427 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m22:00:08.490388 [info ] [Thread-1  ]: 1 of 6 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m22:00:08.492656 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m22:00:08.492387 [info ] [Thread-2  ]: 3 of 6 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m22:00:08.493663 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m22:00:08.493663 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m22:00:08.495663 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m22:00:08.497172 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 22:00:08.493663 => 22:00:08.497172
[0m22:00:08.497172 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m22:00:08.499180 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m22:00:08.500184 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:08.501182 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m22:00:09.386828 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d1604a5-064f-49a1-a302-ce94e59bacb6&page=queryresults
[0m22:00:09.780159 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 22:00:08.497172 => 22:00:09.780159
[0m22:00:09.782153 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1C8820>]}
[0m22:00:09.784677 [info ] [Thread-2  ]: 3 of 6 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m22:00:09.786474 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m22:00:09.788077 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m22:00:09.789188 [info ] [Thread-1  ]: 4 of 6 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m22:00:09.791145 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.dm_produto)
[0m22:00:09.791145 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m22:00:09.796178 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m22:00:09.797572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 22:00:09.792143 => 22:00:09.797209
[0m22:00:09.797572 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m22:00:09.804668 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:10.515805 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m22:00:10.516805 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m22:00:11.121290 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c9c2352-d1dc-4970-807c-e57dd89f55ea&page=queryresults
[0m22:00:13.944269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 22:00:09.797572 => 22:00:13.943268
[0m22:00:13.944269 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1798B0>]}
[0m22:00:13.945267 [info ] [Thread-1  ]: 4 of 6 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.15s]
[0m22:00:13.946269 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m22:00:13.947269 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m22:00:13.947600 [info ] [Thread-2  ]: 5 of 6 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m22:00:13.952605 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m22:00:13.952605 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m22:00:13.955602 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m22:00:13.957201 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 22:00:13.953605 => 22:00:13.957201
[0m22:00:13.957201 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m22:00:13.959198 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:14.633165 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m22:00:14.635166 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m22:00:15.224417 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbd94d89-d117-4c1c-96a4-f560528ffc44&page=queryresults
[0m22:00:17.367261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 22:00:13.957201 => 22:00:17.367261
[0m22:00:17.368264 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DB297D60>]}
[0m22:00:17.369265 [info ] [Thread-2  ]: 5 of 6 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.42s]
[0m22:00:17.372260 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m22:00:17.373256 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.374257 [info ] [Thread-1  ]: 6 of 6 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m22:00:17.375255 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m22:00:17.375255 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.379273 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:17.380264 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 22:00:17.375255 => 22:00:17.380264
[0m22:00:17.381257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.384254 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:18.016898 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:18.018905 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m22:00:18.765270 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bc63069-0d07-4209-8404-6892716a89f9&page=queryresults
[0m22:00:21.061460 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 22:00:17.381257 => 22:00:21.060454
[0m22:00:21.063456 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DB2C8D60>]}
[0m22:00:21.064458 [info ] [Thread-1  ]: 6 of 6 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.69s]
[0m22:00:21.067201 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m22:00:21.072213 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:00:21.073289 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:21.074231 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:21.075260 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:00:21.075260 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:00:21.076220 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m22:00:21.076220 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m22:00:21.077218 [info ] [MainThread]: 
[0m22:00:21.078228 [info ] [MainThread]: Finished running 3 view models, 3 table models in 0 hours 0 minutes and 17.00 seconds (17.00s).
[0m22:00:21.081218 [debug] [MainThread]: Command end result
[0m22:00:21.103042 [info ] [MainThread]: 
[0m22:00:21.104055 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:00:21.105052 [info ] [MainThread]: 
[0m22:00:21.106061 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m22:00:21.107050 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:21.107050 after 17.57 seconds
[0m22:00:21.107050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D68723D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9EE16A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9F9C6D0>]}
[0m22:00:21.107050 [debug] [MainThread]: Flushing usage events
[0m22:35:10.588876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E4892430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E38239D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E3823B80>]}


============================== 22:35:10.592870 | 6e7c7602-ca9b-4801-9507-8a4ef0a16c41 ==============================
[0m22:35:10.592870 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:35:10.592870 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:35:11.062210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E69FBAC0>]}
[0m22:35:11.123759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7F22760>]}
[0m22:35:11.124820 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:35:11.131769 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:35:11.203397 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m22:35:11.203397 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:35:11.297696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E8329520>]}
[0m22:35:11.301599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81AB1F0>]}
[0m22:35:11.301599 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:35:11.301599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81AB220>]}
[0m22:35:11.301599 [info ] [MainThread]: 
[0m22:35:11.301599 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:35:11.301599 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:35:11.301599 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.103074 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:35:12.103074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.103074 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:35:12.103074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.752241 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:35:12.753332 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:35:13.434031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7F7B610>]}
[0m22:35:13.436586 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:35:13.437736 [info ] [MainThread]: 
[0m22:35:13.447958 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.448957 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:35:13.449963 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:35:13.451382 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.476255 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:35:13.478271 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:35:13.452400 => 22:35:13.477368
[0m22:35:13.478271 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.508182 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:35:13.508182 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:35:13.508182 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as int64)            as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as int64)                as cd_valor
          ,cast(json_value(a.json_element, '$.item') as int64)                 as ds_valor_campo
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:35:14.763304 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86ed5a13-1efe-4133-8257-3ad0a574b6b1&page=queryresults
[0m22:35:15.283681 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:35:13.479371 => 22:35:15.283681
[0m22:35:15.283681 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E93ADE80>]}
[0m22:35:15.283681 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.83s]
[0m22:35:15.283681 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:15.283681 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:35:15.283681 [info ] [MainThread]: 
[0m22:35:15.283681 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.98 seconds (3.98s).
[0m22:35:15.283681 [debug] [MainThread]: Command end result
[0m22:35:15.304978 [info ] [MainThread]: 
[0m22:35:15.304978 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:35:15.306112 [info ] [MainThread]: 
[0m22:35:15.306112 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:35:15.306112 [debug] [MainThread]: Command `dbt run` succeeded at 22:35:15.306112 after 4.81 seconds
[0m22:35:15.306112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E4892430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7FEB370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81D64F0>]}
[0m22:35:15.306112 [debug] [MainThread]: Flushing usage events
[0m22:36:00.035210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944C0813D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B0202E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B020760>]}


============================== 22:36:00.037676 | c6a2a5e2-7e24-4d83-9e77-1926d01edb96 ==============================
[0m22:36:00.037676 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:36:00.038676 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:36:00.396320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B00C0D0>]}
[0m22:36:00.455313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F69EEB0>]}
[0m22:36:00.455313 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:36:00.462165 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:36:00.562870 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:36:00.562870 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:36:00.656733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944FA826D0>]}
[0m22:36:00.665406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F85AB50>]}
[0m22:36:00.665406 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:36:00.666376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F6AAC70>]}
[0m22:36:00.667416 [info ] [MainThread]: 
[0m22:36:00.668059 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:36:00.669127 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:36:00.669127 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:01.642135 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:36:01.643136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:01.645234 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:36:01.645234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:02.382229 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:36:02.384187 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:36:03.064894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F738400>]}
[0m22:36:03.066925 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:36:03.067712 [info ] [MainThread]: 
[0m22:36:03.078002 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.079116 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:36:03.081021 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:36:03.082025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.102246 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:36:03.104243 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:36:03.083022 => 22:36:03.104243
[0m22:36:03.106271 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.127004 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:36:03.128013 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:36:03.129023 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:36:04.017979 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f9ca8ae-68ab-41fd-97e3-50edd5e34ee7&page=queryresults
[0m22:36:04.508223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:36:03.106271 => 22:36:04.508223
[0m22:36:04.509210 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944FB86FA0>]}
[0m22:36:04.510206 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m22:36:04.511144 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:04.513120 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:36:04.515171 [info ] [MainThread]: 
[0m22:36:04.515171 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.85 seconds (3.85s).
[0m22:36:04.516123 [debug] [MainThread]: Command end result
[0m22:36:04.523615 [info ] [MainThread]: 
[0m22:36:04.524600 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:36:04.525599 [info ] [MainThread]: 
[0m22:36:04.526591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:36:04.527592 [debug] [MainThread]: Command `dbt run` succeeded at 22:36:04.527592 after 4.55 seconds
[0m22:36:04.527592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944C0813D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F75E220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F9CA760>]}
[0m22:36:04.527592 [debug] [MainThread]: Flushing usage events
[0m22:40:01.076792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C9C75460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C8BF39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C8BF3D30>]}


============================== 22:40:01.080085 | 43995b8f-e682-4c1a-b6e9-31a3129fe18d ==============================
[0m22:40:01.080085 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:01.080085 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:40:01.458341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CBDC0B80>]}
[0m22:40:01.523026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD2E29D0>]}
[0m22:40:01.524133 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:01.530608 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:01.616177 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:01.617177 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:01.719011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD6387F0>]}
[0m22:40:01.728832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD3F4A60>]}
[0m22:40:01.728832 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:01.729831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD3F4A00>]}
[0m22:40:01.730848 [info ] [MainThread]: 
[0m22:40:01.731111 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:01.733171 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:01.733171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:02.414332 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:02.415325 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:02.417924 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:40:02.419043 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:03.333246 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:40:03.335232 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:04.054492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD305640>]}
[0m22:40:04.057499 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:04.059247 [info ] [MainThread]: 
[0m22:40:04.070251 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.071244 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:04.074250 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:04.075249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.093298 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:04.095302 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:04.076258 => 22:40:04.095302
[0m22:40:04.096321 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.125251 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:04.126254 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:04.127253 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
)

select *
  from cte_campo;


[0m22:40:04.952806 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2dc15d95-0484-4e4c-b97f-ed01ef46699c&page=queryresults
[0m22:40:05.483512 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_campo for WITH subquery at [35:3]')
[0m22:40:06.555465 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d241ea4-5427-49d3-bda0-2709054075de&page=queryresults
[0m22:40:06.980047 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d241ea4-5427-49d3-bda0-2709054075de&page=queryresults
[0m22:40:06.983042 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:04.096321 => 22:40:06.982041
[0m22:40:06.992043 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:06.993038 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD73B4F0>]}
[0m22:40:06.995048 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.92s]
[0m22:40:06.997046 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:07.004049 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:07.006045 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:07.008988 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:07.009978 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:07.010978 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:07.010978 [info ] [MainThread]: 
[0m22:40:07.013977 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.28 seconds (5.28s).
[0m22:40:07.016977 [debug] [MainThread]: Command end result
[0m22:40:07.035286 [info ] [MainThread]: 
[0m22:40:07.036286 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:07.036286 [info ] [MainThread]: 
[0m22:40:07.037290 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:07.037290 [info ] [MainThread]: 
[0m22:40:07.038292 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:07.039293 [debug] [MainThread]: Command `dbt run` failed at 22:40:07.039293 after 6.02 seconds
[0m22:40:07.039293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C9C75460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD2E29D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD329340>]}
[0m22:40:07.040293 [debug] [MainThread]: Flushing usage events
[0m22:40:26.910546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B570D413D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B56FCCD2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B56FCCD760>]}


============================== 22:40:26.913548 | f82c79ea-4feb-4cb0-a94d-3acd4ef03345 ==============================
[0m22:40:26.913548 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:26.914109 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:40:27.278372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B572EB0AF0>]}
[0m22:40:27.341225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5743053D0>]}
[0m22:40:27.342262 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:27.348092 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:27.468558 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:27.468558 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:27.562587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5747B8490>]}
[0m22:40:27.571414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5745BB7F0>]}
[0m22:40:27.571414 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:27.572409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5745BB670>]}
[0m22:40:27.573477 [info ] [MainThread]: 
[0m22:40:27.574402 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:27.575376 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:27.575376 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:28.349980 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:28.351012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:28.352985 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:40:28.354742 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:29.020169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:40:29.024282 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:29.671698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B574359EE0>]}
[0m22:40:29.673692 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:29.674697 [info ] [MainThread]: 
[0m22:40:29.685950 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.687040 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:29.689949 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:29.690950 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.705941 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:29.707947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:29.691951 => 22:40:29.706937
[0m22:40:29.708703 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.728819 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:29.729819 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:29.731821 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo;


[0m22:40:30.551311 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0765b92b-ffda-4aa4-b544-1259cf6981dc&page=queryresults
[0m22:40:30.980979 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_campo for WITH subquery at [35:3]')
[0m22:40:31.982764 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0cc0374a-9b48-4cc7-955f-09e9b472f5f9&page=queryresults
[0m22:40:32.332817 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0cc0374a-9b48-4cc7-955f-09e9b472f5f9&page=queryresults
[0m22:40:32.335850 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:29.708703 => 22:40:32.334857
[0m22:40:32.343046 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:32.344042 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5747DE790>]}
[0m22:40:32.346047 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.66s]
[0m22:40:32.347642 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:32.352662 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:32.353658 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:32.354701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:32.354701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:40:32.355750 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:32.355750 [info ] [MainThread]: 
[0m22:40:32.357655 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.78 seconds (4.78s).
[0m22:40:32.359656 [debug] [MainThread]: Command end result
[0m22:40:32.371145 [info ] [MainThread]: 
[0m22:40:32.372151 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:32.373148 [info ] [MainThread]: 
[0m22:40:32.374143 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:32.375145 [info ] [MainThread]: 
[0m22:40:32.376145 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:32.377146 [debug] [MainThread]: Command `dbt run` failed at 22:40:32.376145 after 5.52 seconds
[0m22:40:32.377146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B570D413D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5743053D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B57436A7F0>]}
[0m22:40:32.377146 [debug] [MainThread]: Flushing usage events
[0m22:40:39.924215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F31D113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F30CB42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F30CB4760>]}


============================== 22:40:39.926899 | 84734e52-dda3-4c7e-8883-d105d97d6661 ==============================
[0m22:40:39.926899 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:39.927958 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'send_anonymous_usage_stats': 'True'}
[0m22:40:40.288271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F33E7BBE0>]}
[0m22:40:40.348770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F352D28E0>]}
[0m22:40:40.349775 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:40.355870 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:40.442740 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:40.442740 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:40.546066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F35712850>]}
[0m22:40:40.554688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F354B5BE0>]}
[0m22:40:40.555674 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:40.555674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F3538BB20>]}
[0m22:40:40.557006 [info ] [MainThread]: 
[0m22:40:40.558044 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:40.559004 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:40.559004 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.249260 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:40:41.250300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.283050 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:41.283050 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.937922 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:40:41.939039 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:42.658035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F353C4A00>]}
[0m22:40:42.660035 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:42.662035 [info ] [MainThread]: 
[0m22:40:42.672714 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.672714 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:42.676738 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:42.676738 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.692573 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:42.694580 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:42.676738 => 22:40:42.694580
[0m22:40:42.694580 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.714190 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:42.714190 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:42.716204 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo_base;


[0m22:40:43.484443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d90beb3-c0ac-4402-bb51-27bc12a7748c&page=queryresults
[0m22:40:43.985864 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: a at [36:10]')
[0m22:40:45.010487 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3c4939a2-4aaa-4612-9f8b-e178a2490e78&page=queryresults
[0m22:40:45.418160 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3c4939a2-4aaa-4612-9f8b-e178a2490e78&page=queryresults
[0m22:40:45.420153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:42.694580 => 22:40:45.420153
[0m22:40:45.427154 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Unrecognized name: a at [36:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:45.428663 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F36813BB0>]}
[0m22:40:45.428663 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.75s]
[0m22:40:45.430122 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:45.434232 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:45.436138 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:45.436138 [info ] [MainThread]: 
[0m22:40:45.437138 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.88 seconds (4.88s).
[0m22:40:45.438500 [debug] [MainThread]: Command end result
[0m22:40:45.447974 [info ] [MainThread]: 
[0m22:40:45.448983 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:45.450075 [info ] [MainThread]: 
[0m22:40:45.450643 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Unrecognized name: a at [36:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:45.450643 [info ] [MainThread]: 
[0m22:40:45.451652 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:45.452652 [debug] [MainThread]: Command `dbt run` failed at 22:40:45.452652 after 5.58 seconds
[0m22:40:45.453652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F31D113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F352D28E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F35817D00>]}
[0m22:40:45.453652 [debug] [MainThread]: Flushing usage events
[0m22:40:55.804107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028694E05430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028693D796A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028693D79DC0>]}


============================== 22:40:55.807169 | 48e1647b-5fd3-40e7-8fca-1fedf6a11fd2 ==============================
[0m22:40:55.807169 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:55.807704 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:40:56.181116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869845E520>]}
[0m22:40:56.240825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286983538E0>]}
[0m22:40:56.241830 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:56.248482 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:56.328921 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:56.329922 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:56.425563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286987AAA00>]}
[0m22:40:56.435634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286986400D0>]}
[0m22:40:56.435634 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:56.436633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869838DD90>]}
[0m22:40:56.437633 [info ] [MainThread]: 
[0m22:40:56.438104 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:56.439109 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:56.440110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.142445 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:40:57.143442 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.145443 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:57.145443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.811545 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:40:57.813468 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:58.410862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286984CB220>]}
[0m22:40:58.413093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:58.413986 [info ] [MainThread]: 
[0m22:40:58.423480 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.424480 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:58.425480 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:58.427477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.436999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:58.438008 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:58.427477 => 22:40:58.438008
[0m22:40:58.439010 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.459426 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:58.460425 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:58.462426 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo_base;


[0m22:40:59.347065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:038a3381-8cc7-4a7d-a4f7-33ed383a6da2&page=queryresults
[0m22:40:59.873165 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:58.439010 => 22:40:59.873165
[0m22:40:59.873165 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286988D7F40>]}
[0m22:40:59.874221 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m22:40:59.875172 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:59.876177 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:59.878220 [info ] [MainThread]: 
[0m22:40:59.878220 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.44 seconds (3.44s).
[0m22:40:59.879152 [debug] [MainThread]: Command end result
[0m22:40:59.886131 [info ] [MainThread]: 
[0m22:40:59.887128 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:40:59.887128 [info ] [MainThread]: 
[0m22:40:59.888132 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:40:59.889130 [debug] [MainThread]: Command `dbt run` succeeded at 22:40:59.888132 after 4.15 seconds
[0m22:40:59.889130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028694E05430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028698502E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869839E100>]}
[0m22:40:59.889130 [debug] [MainThread]: Flushing usage events
[0m22:44:07.985527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB50CB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB40539A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB4053D30>]}


============================== 22:44:07.988541 | 7c03d8b9-0a01-4358-95e4-18afd646314e ==============================
[0m22:44:07.988541 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:44:07.988541 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:44:08.341561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8727520>]}
[0m22:44:08.401461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB862B8E0>]}
[0m22:44:08.401461 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:44:08.417404 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:44:08.510075 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:44:08.510075 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8A58A00>]}
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB89100D0>]}
[0m22:44:08.605494 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8663DC0>]}
[0m22:44:08.621273 [info ] [MainThread]: 
[0m22:44:08.621273 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:44:08.621273 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:44:08.621273 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:09.327703 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:44:09.327703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:09.327703 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:44:09.327703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:10.018385 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:44:10.020399 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:44:10.765014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB89100D0>]}
[0m22:44:10.771674 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:44:10.772796 [info ] [MainThread]: 
[0m22:44:10.779155 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.781393 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:44:10.783667 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:44:10.784656 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.792092 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:44:10.792092 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:44:10.784656 => 22:44:10.792092
[0m22:44:10.792092 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.826634 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:44:10.826994 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:44:10.826994 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select 
    cd_produto_bling,
    cd_produto,
    -- Pivoteia os campos
    MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as classificacao_produto,
    MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as ajuste_preco

from cte_campo_base
group by cd_produto_bling, cd_produto;


[0m22:44:11.822251 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07b19556-4060-4ee8-a882-09b54e998c2b&page=queryresults
[0m22:44:12.272170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:44:10.792092 => 22:44:12.272170
[0m22:44:12.272170 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB9BEE790>]}
[0m22:44:12.272170 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m22:44:12.272170 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:12.272170 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:44:12.272170 [info ] [MainThread]: 
[0m22:44:12.272170 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.65 seconds (3.65s).
[0m22:44:12.272170 [debug] [MainThread]: Command end result
[0m22:44:12.287254 [info ] [MainThread]: 
[0m22:44:12.288239 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:44:12.288239 [info ] [MainThread]: 
[0m22:44:12.289249 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:44:12.290308 [debug] [MainThread]: Command `dbt run` succeeded at 22:44:12.290308 after 4.37 seconds
[0m22:44:12.290308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB50CB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB87D6E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB866E100>]}
[0m22:44:12.290308 [debug] [MainThread]: Flushing usage events
[0m22:45:56.646976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F61F8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F006A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F00DC0>]}


============================== 22:45:56.648979 | 1b19b359-a79f-4ead-adcd-7506cf2c9617 ==============================
[0m22:45:56.648979 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:45:56.649935 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:45:56.999202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F01BB0>]}
[0m22:45:57.063395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F656C01C0>]}
[0m22:45:57.063395 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:45:57.079546 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:45:57.181178 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:45:57.181178 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:45:57.277901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F6595A0D0>]}
[0m22:45:57.287538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F657E4400>]}
[0m22:45:57.287538 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:45:57.288538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F657E43A0>]}
[0m22:45:57.289537 [info ] [MainThread]: 
[0m22:45:57.291044 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:45:57.292355 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:45:57.293356 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.152315 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:45:58.152315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.168426 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:45:58.168426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.862807 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:45:58.874385 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:45:59.579246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F6562FA30>]}
[0m22:45:59.579246 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:45:59.579246 [info ] [MainThread]: 
[0m22:45:59.597921 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.597921 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:45:59.597921 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:45:59.597921 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.627346 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:45:59.629352 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:45:59.607252 => 22:45:59.628440
[0m22:45:59.629352 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.653712 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:45:59.654818 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:45:59.655715 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        -- Pivoteia os campos
        ,MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as ds_classificacao_produto
        ,MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as fg_ajuste_preco  
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
from cte_campo_base;


[0m22:46:00.609754 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:385d704e-78f7-4aa6-8718-edb818c5b61e&page=queryresults
[0m22:46:01.124967 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]')
[0m22:46:01.619181 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d750a5c2-669e-4db9-b338-b11738cda41b&page=queryresults
[0m22:46:02.003585 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d750a5c2-669e-4db9-b338-b11738cda41b&page=queryresults
[0m22:46:02.011314 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:45:59.629352 => 22:46:02.003585
[0m22:46:02.019761 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:02.019761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65A60E80>]}
[0m22:46:02.019761 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.42s]
[0m22:46:02.024572 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:02.029412 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:46:02.029412 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:46:02.030419 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:46:02.032023 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:46:02.032023 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:46:02.032023 [info ] [MainThread]: 
[0m22:46:02.032023 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.74 seconds (4.74s).
[0m22:46:02.038259 [debug] [MainThread]: Command end result
[0m22:46:02.048709 [info ] [MainThread]: 
[0m22:46:02.049801 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:46:02.049801 [info ] [MainThread]: 
[0m22:46:02.050775 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:02.051720 [info ] [MainThread]: 
[0m22:46:02.052115 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:46:02.052115 [debug] [MainThread]: Command `dbt run` failed at 22:46:02.052115 after 5.47 seconds
[0m22:46:02.052115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F61F8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65673B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65A88280>]}
[0m22:46:02.052115 [debug] [MainThread]: Flushing usage events
[0m22:46:17.076097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023478D2A3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477CB02E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477CB0760>]}


============================== 22:46:17.079110 | 08eed5b5-54ff-46e2-ace6-989f244059db ==============================
[0m22:46:17.079110 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:46:17.079110 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:46:17.426504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477C9C0D0>]}
[0m22:46:17.490219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C393850>]}
[0m22:46:17.490219 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:46:17.490219 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:46:17.593407 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:46:17.593407 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:17.687180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C714700>]}
[0m22:46:17.692078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C4EA040>]}
[0m22:46:17.692078 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:46:17.692078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C65A790>]}
[0m22:46:17.692078 [info ] [MainThread]: 
[0m22:46:17.692078 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:46:17.692078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:46:17.692078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:18.381025 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:46:18.381025 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:18.381025 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:46:18.381025 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:19.066131 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:46:19.066131 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:46:19.713455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C31C340>]}
[0m22:46:19.713455 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:46:19.713455 [info ] [MainThread]: 
[0m22:46:19.727948 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.728963 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:46:19.731573 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:46:19.732945 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.752229 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:46:19.754234 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:46:19.733951 => 22:46:19.753233
[0m22:46:19.754234 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.777361 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:46:19.778466 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:46:19.779403 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as ds_classificacao_produto
        ,MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as fg_ajuste_preco  
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
from cte_campo_base;


[0m22:46:20.787043 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fa04f64c-dc62-420a-922e-88978b9c6fa6&page=queryresults
[0m22:46:21.205137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:46:19.755243 => 22:46:21.205137
[0m22:46:21.205137 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C801D90>]}
[0m22:46:21.205137 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m22:46:21.221194 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:21.221194 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:46:21.221194 [info ] [MainThread]: 
[0m22:46:21.225163 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.53 seconds (3.53s).
[0m22:46:21.225163 [debug] [MainThread]: Command end result
[0m22:46:21.233909 [info ] [MainThread]: 
[0m22:46:21.233909 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:46:21.233909 [info ] [MainThread]: 
[0m22:46:21.233909 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:46:21.238504 [debug] [MainThread]: Command `dbt run` succeeded at 22:46:21.238504 after 4.23 seconds
[0m22:46:21.238504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023478D2A3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347D82CF70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C65A790>]}
[0m22:46:21.239540 [debug] [MainThread]: Flushing usage events
[0m22:49:10.825601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D254C12430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253BB99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253BB9B80>]}


============================== 22:49:10.827649 | 69e59ca5-0100-4351-b6a7-7e447c2d4727 ==============================
[0m22:49:10.827649 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:49:10.828682 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:49:11.181067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253B9CA30>]}
[0m22:49:11.241730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2581CB040>]}
[0m22:49:11.242735 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:49:11.248409 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:49:11.327536 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:49:11.328639 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:49:11.428341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2585E7B20>]}
[0m22:49:11.437306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258470FA0>]}
[0m22:49:11.437890 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:49:11.437890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258253D90>]}
[0m22:49:11.439021 [info ] [MainThread]: 
[0m22:49:11.440069 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:49:11.441099 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:49:11.442036 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:12.499356 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:49:12.500328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:12.502253 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:49:12.503255 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:13.127823 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:49:13.129926 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:49:13.777389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2585E7B50>]}
[0m22:49:13.778389 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:49:13.779383 [info ] [MainThread]: 
[0m22:49:13.787393 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.787801 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:49:13.788809 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:49:13.789804 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.805470 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:49:13.808184 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:49:13.790813 => 22:49:13.807179
[0m22:49:13.809305 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.835351 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:49:13.837350 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:49:13.838359 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
  from cte_campo_base;


[0m22:49:14.655891 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ffc9ddc2-a36d-434b-8508-c2de5eee1204&page=queryresults
[0m22:49:15.174071 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:49:13.809305 => 22:49:15.174071
[0m22:49:15.175069 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258470E50>]}
[0m22:49:15.176063 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m22:49:15.177064 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:15.178406 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:49:15.179405 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:49:15.179405 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:49:15.180423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:49:15.180423 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:49:15.181406 [info ] [MainThread]: 
[0m22:49:15.182405 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.74 seconds (3.74s).
[0m22:49:15.182722 [debug] [MainThread]: Command end result
[0m22:49:15.190993 [info ] [MainThread]: 
[0m22:49:15.192986 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:49:15.193988 [info ] [MainThread]: 
[0m22:49:15.194989 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:49:15.195979 [debug] [MainThread]: Command `dbt run` succeeded at 22:49:15.195979 after 4.43 seconds
[0m22:49:15.195979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D254C12430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2586FA940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D25851FAF0>]}
[0m22:49:15.196978 [debug] [MainThread]: Flushing usage events
[0m22:50:04.328917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1EF11430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1DEA49D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1DEA4B80>]}


============================== 22:50:04.330932 | c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a ==============================
[0m22:50:04.330932 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:50:04.331919 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'send_anonymous_usage_stats': 'True'}
[0m22:50:04.797771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2107BAC0>]}
[0m22:50:04.858296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E225B66D0>]}
[0m22:50:04.859297 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:50:04.865297 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:50:04.956268 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:50:04.957272 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:50:05.050834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E22998490>]}
[0m22:50:05.059312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2279B7F0>]}
[0m22:50:05.060313 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:50:05.060313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2279B670>]}
[0m22:50:05.061311 [info ] [MainThread]: 
[0m22:50:05.062310 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:50:05.063238 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:50:05.064254 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:05.870125 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:50:05.872054 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:05.874040 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:50:05.876045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:06.537685 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:50:06.538261 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:50:07.168088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E22616C40>]}
[0m22:50:07.171105 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:50:07.173115 [info ] [MainThread]: 
[0m22:50:07.186844 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.188566 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:50:07.192552 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:50:07.194561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.226273 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:07.227885 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:50:07.195547 => 22:50:07.227885
[0m22:50:07.228896 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.264461 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:07.265460 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:50:07.267459 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(dt_ajuste_preco as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:50:08.085947 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23a15041-e87b-48c4-9ac5-558dd6482cc4&page=queryresults
[0m22:50:08.515734 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:50:07.229896 => 22:50:08.515734
[0m22:50:08.516731 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E23A52970>]}
[0m22:50:08.517384 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m22:50:08.518462 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:08.520478 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:50:08.521456 [info ] [MainThread]: 
[0m22:50:08.522463 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.46 seconds (3.46s).
[0m22:50:08.523463 [debug] [MainThread]: Command end result
[0m22:50:08.535957 [info ] [MainThread]: 
[0m22:50:08.537919 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:50:08.538915 [info ] [MainThread]: 
[0m22:50:08.540962 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:50:08.542971 [debug] [MainThread]: Command `dbt run` succeeded at 22:50:08.542971 after 4.28 seconds
[0m22:50:08.542971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1EF11430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E229BE490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2286A520>]}
[0m22:50:08.543963 [debug] [MainThread]: Flushing usage events
[0m22:50:31.768992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216868113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216857B42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216857B4760>]}


============================== 22:50:31.771990 | e7ac5189-e977-4095-bd63-8bbb07948645 ==============================
[0m22:50:31.771990 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:50:31.771990 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:50:32.132853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168579CA60>]}
[0m22:50:32.193740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689DCBCA0>]}
[0m22:50:32.194744 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:50:32.201188 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:50:32.312039 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:50:32.312039 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:50:32.404258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A1C2B20>]}
[0m22:50:32.412890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A070280>]}
[0m22:50:32.412890 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:50:32.414004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689F11970>]}
[0m22:50:32.414891 [info ] [MainThread]: 
[0m22:50:32.415896 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:50:32.417529 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:50:32.417529 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.086974 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:50:33.087612 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.089643 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:50:33.090636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.748034 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:50:33.753403 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:50:34.646582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689EEE220>]}
[0m22:50:34.648568 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:50:34.650591 [info ] [MainThread]: 
[0m22:50:34.658982 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.661088 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:50:34.662977 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:50:34.663980 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.678977 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:34.680977 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:50:34.664981 => 22:50:34.679978
[0m22:50:34.680977 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.705780 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:34.706783 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:50:34.707351 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,dt_ajuste_preco
   from cte_campo_base;


[0m22:50:35.587905 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d5d6a57-3f91-45dc-9551-d09d6d32111e&page=queryresults
[0m22:50:36.085005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:50:34.681986 => 22:50:36.085005
[0m22:50:36.086005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A2D6FD0>]}
[0m22:50:36.086005 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m22:50:36.087029 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:36.089284 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:50:36.090271 [info ] [MainThread]: 
[0m22:50:36.090680 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.67 seconds (3.67s).
[0m22:50:36.091116 [debug] [MainThread]: Command end result
[0m22:50:36.098569 [info ] [MainThread]: 
[0m22:50:36.098569 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:50:36.099567 [info ] [MainThread]: 
[0m22:50:36.100566 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:50:36.101568 [debug] [MainThread]: Command `dbt run` succeeded at 22:50:36.101568 after 4.39 seconds
[0m22:50:36.102567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216868113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689E399A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A14E880>]}
[0m22:50:36.102567 [debug] [MainThread]: Flushing usage events
[0m22:51:35.367437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DD1B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DC14D9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DC14DB80>]}


============================== 22:51:35.370955 | 6a34ca80-9fbb-4d7a-81cf-549b6bb76384 ==============================
[0m22:51:35.370955 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:51:35.370955 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:51:35.771969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DF320AC0>]}
[0m22:51:35.839442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E08466D0>]}
[0m22:51:35.840461 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:51:35.847772 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:51:35.952464 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:51:35.953458 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:36.060680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0C28490>]}
[0m22:51:36.070124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0A2B7F0>]}
[0m22:51:36.071153 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:51:36.071666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0A2B670>]}
[0m22:51:36.072679 [info ] [MainThread]: 
[0m22:51:36.073672 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:51:36.074673 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:51:36.075698 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:36.892625 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:51:36.893628 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:36.930769 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:51:36.931726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:37.569915 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:51:37.569915 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:51:38.221339 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E07C35E0>]}
[0m22:51:38.223346 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:51:38.225337 [info ] [MainThread]: 
[0m22:51:38.237996 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.240005 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:51:38.243987 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:51:38.244994 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.271986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:38.274985 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:51:38.246998 => 22:51:38.273987
[0m22:51:38.275980 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.303639 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:38.305640 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:51:38.307634 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(repalce(dt_ajuste_preco, '/', '-') as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:51:39.169850 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:355f00c4-41f9-493b-96ff-02615c01b206&page=queryresults
[0m22:51:39.532730 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Function not found: repalce; Did you mean replace? at [50:15]')
[0m22:51:40.390598 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9139e4b7-8e35-4aa5-8df1-69b20ed86b91&page=queryresults
[0m22:51:40.740170 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9139e4b7-8e35-4aa5-8df1-69b20ed86b91&page=queryresults
[0m22:51:40.743163 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:51:38.276979 => 22:51:40.742211
[0m22:51:40.749800 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Function not found: repalce; Did you mean replace? at [50:15]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:40.750797 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0C4E6A0>]}
[0m22:51:40.752800 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.51s]
[0m22:51:40.754799 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:40.758808 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:51:40.759803 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:51:40.760855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:51:40.761801 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:51:40.761801 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:51:40.762796 [info ] [MainThread]: 
[0m22:51:40.764806 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.69 seconds (4.69s).
[0m22:51:40.766797 [debug] [MainThread]: Command end result
[0m22:51:40.780409 [info ] [MainThread]: 
[0m22:51:40.781409 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:51:40.781409 [info ] [MainThread]: 
[0m22:51:40.783443 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Function not found: repalce; Did you mean replace? at [50:15]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:40.784423 [info ] [MainThread]: 
[0m22:51:40.784423 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:51:40.786423 [debug] [MainThread]: Command `dbt run` failed at 22:51:40.785424 after 5.48 seconds
[0m22:51:40.786423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DD1B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E08466D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0AC0940>]}
[0m22:51:40.786876 [debug] [MainThread]: Flushing usage events
[0m22:51:50.736222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9E139460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0C39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0C3D30>]}


============================== 22:51:50.738933 | ceaef6ae-fea4-4260-9eba-942967076913 ==============================
[0m22:51:50.738933 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:51:50.738933 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:51:51.082864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0B5B20>]}
[0m22:51:51.144653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1874250>]}
[0m22:51:51.145656 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:51:51.152246 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:51:51.251504 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:51:51.252528 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:51.347287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1B37760>]}
[0m22:51:51.355297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA18C40D0>]}
[0m22:51:51.355297 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:51:51.356858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1B28E20>]}
[0m22:51:51.356858 [info ] [MainThread]: 
[0m22:51:51.358145 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:51:51.359284 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:51:51.360300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.190640 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:51:52.191635 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.228551 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:51:52.228551 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.829269 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:51:52.832339 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:51:53.457912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA182E7F0>]}
[0m22:51:53.460028 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:51:53.460934 [info ] [MainThread]: 
[0m22:51:53.469835 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.470918 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:51:53.472861 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:51:53.473809 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.492878 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:53.494860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:51:53.474806 => 22:51:53.494860
[0m22:51:53.495857 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.518098 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:53.518098 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:51:53.520217 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(replace(dt_ajuste_preco, '/', '-') as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:51:54.314046 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39add8c0-86ee-494b-9ada-79394a5cfd95&page=queryresults
[0m22:51:54.745528 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:51:53.496871 => 22:51:54.744521
[0m22:51:54.746536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1BE6C10>]}
[0m22:51:54.747102 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m22:51:54.748164 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:54.750157 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:51:54.750157 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:51:54.750157 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:51:54.751726 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:51:54.751726 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:51:54.751726 [info ] [MainThread]: 
[0m22:51:54.752803 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.39 seconds (3.39s).
[0m22:51:54.753850 [debug] [MainThread]: Command end result
[0m22:51:54.763751 [info ] [MainThread]: 
[0m22:51:54.764747 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:51:54.766801 [info ] [MainThread]: 
[0m22:51:54.767742 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:51:54.770811 [debug] [MainThread]: Command `dbt run` succeeded at 22:51:54.769782 after 4.09 seconds
[0m22:51:54.770811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9E139460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1718130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1A6A7F0>]}
[0m22:51:54.770811 [debug] [MainThread]: Flushing usage events
[0m22:52:08.769658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4129B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D402159A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D40215D30>]}


============================== 22:52:08.774672 | f009a406-3aa0-4127-8651-3e41e9549a8c ==============================
[0m22:52:08.774672 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:52:08.775129 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:52:09.255984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D433EBA90>]}
[0m22:52:09.366782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D449124F0>]}
[0m22:52:09.367798 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:52:09.376270 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:52:09.457356 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:52:09.458854 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:52:09.571303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44CF6460>]}
[0m22:52:09.580029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44AFB6D0>]}
[0m22:52:09.581031 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:52:09.582029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44AFB670>]}
[0m22:52:09.582029 [info ] [MainThread]: 
[0m22:52:09.583026 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:52:09.585027 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:52:09.585027 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.220567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:52:10.220567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.222512 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:52:10.222512 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.841447 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:52:10.842448 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:52:11.512795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4499BA30>]}
[0m22:52:11.513795 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:52:11.514809 [info ] [MainThread]: 
[0m22:52:11.518790 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.518790 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:52:11.519790 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:52:11.519790 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.528793 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:52:11.529794 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:52:11.520796 => 22:52:11.529794
[0m22:52:11.530793 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.552340 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:52:11.553341 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:52:11.554340 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m22:52:12.341659 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2859b75b-c73c-4e1f-9163-b5f2234fed08&page=queryresults
[0m22:52:12.745383 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:52:11.530793 => 22:52:12.745383
[0m22:52:12.745383 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44D7BA90>]}
[0m22:52:12.746383 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m22:52:12.747347 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:12.748696 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:52:12.749831 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:52:12.749831 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:52:12.750824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:52:12.750824 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:52:12.750824 [info ] [MainThread]: 
[0m22:52:12.751825 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.17 seconds (3.17s).
[0m22:52:12.752735 [debug] [MainThread]: Command end result
[0m22:52:12.760123 [info ] [MainThread]: 
[0m22:52:12.761118 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:52:12.763131 [info ] [MainThread]: 
[0m22:52:12.765122 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:52:12.767149 [debug] [MainThread]: Command `dbt run` succeeded at 22:52:12.767149 after 4.06 seconds
[0m22:52:12.767149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4129B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44975310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44BCA4F0>]}
[0m22:52:12.767149 [debug] [MainThread]: Flushing usage events
[0m23:00:03.498819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B08F233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B07EA99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B07EA9B80>]}


============================== 23:00:03.500942 | 17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e ==============================
[0m23:00:03.500942 [info ] [MainThread]: Running with dbt=1.7.4
[0m23:00:03.501943 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:00:03.843063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0B06ABE0>]}
[0m23:00:03.901426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C590A00>]}
[0m23:00:03.902435 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m23:00:03.908852 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m23:00:03.953775 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:00:03.954777 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:00:03.958514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C82AEB0>]}
[0m23:00:03.966513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A29A0>]}
[0m23:00:03.966513 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m23:00:03.967102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A20A0>]}
[0m23:00:03.968155 [info ] [MainThread]: 
[0m23:00:03.969362 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:00:03.970476 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:03.971367 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:03.992160 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:03.993118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:04.816283 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:05.502102 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m23:00:05.503095 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:05.504571 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m23:00:05.505715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:06.157865 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m23:00:06.158897 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:06.817221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5DDEE0>]}
[0m23:00:06.818336 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:00:06.819285 [info ] [MainThread]: 
[0m23:00:06.827757 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.829773 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.828774 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m23:00:06.832786 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m23:00:06.833780 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.847090 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:06.830770 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m23:00:06.849102 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m23:00:06.850174 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.854199 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:06.856117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 23:00:06.850174 => 23:00:06.855165
[0m23:00:06.857104 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.857729 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 23:00:06.834778 => 23:00:06.857104
[0m23:00:06.883587 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:06.884605 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.889827 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:06.890829 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m23:00:06.892726 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m23:00:06.911892 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m23:00:06.915415 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m23:00:07.950174 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d5c69572-4cec-4607-a6f8-054eb1639de6&page=queryresults
[0m23:00:07.952082 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad9139d2-ce82-477c-8890-03e0e424dcd7&page=queryresults
[0m23:00:08.410061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 23:00:06.857729 => 23:00:08.410061
[0m23:00:08.410985 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5E27F0>]}
[0m23:00:08.414059 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 23:00:06.885075 => 23:00:08.414059
[0m23:00:08.414956 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C529760>]}
[0m23:00:08.411964 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m23:00:08.415958 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m23:00:08.415958 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.414956 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.58s]
[0m23:00:08.417589 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:08.417589 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m23:00:08.415958 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m23:00:08.418872 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m23:00:08.418872 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.421881 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:08.417589 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m23:00:08.423887 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m23:00:08.423887 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m23:00:08.428397 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m23:00:08.430358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 23:00:08.418872 => 23:00:08.429353
[0m23:00:08.430358 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.433355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:08.434355 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:08.435369 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m23:00:08.457521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 23:00:08.424894 => 23:00:08.456800
[0m23:00:08.457521 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m23:00:08.459531 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m23:00:08.461533 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:08.462537 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m23:00:09.217880 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99354433-855c-4c65-a2a1-84b0f1dc986e&page=queryresults
[0m23:00:09.262748 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:998e8d96-bd23-415b-8036-270b0957f11b&page=queryresults
[0m23:00:09.630128 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 23:00:08.430358 => 23:00:09.630128
[0m23:00:09.631113 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C82AF70>]}
[0m23:00:09.632734 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m23:00:09.634857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m23:00:09.640833 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 23:00:08.457521 => 23:00:09.640833
[0m23:00:09.642741 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D997490>]}
[0m23:00:09.642741 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m23:00:09.644376 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m23:00:09.646390 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m23:00:09.647390 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m23:00:09.649119 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m23:00:09.649119 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m23:00:09.655121 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m23:00:09.657669 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 23:00:09.650077 => 23:00:09.657021
[0m23:00:09.657669 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m23:00:09.677289 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:10.340242 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m23:00:10.341245 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m23:00:10.943490 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7146ffcf-4e55-4840-8416-e722c14bed10&page=queryresults
[0m23:00:13.467463 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 23:00:09.668278 => 23:00:13.467463
[0m23:00:13.469582 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A2BE0>]}
[0m23:00:13.470578 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.82s]
[0m23:00:13.472483 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m23:00:13.474493 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m23:00:13.475489 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m23:00:13.478044 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m23:00:13.478044 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m23:00:13.485038 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m23:00:13.487533 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 23:00:13.479043 => 23:00:13.487050
[0m23:00:13.488540 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m23:00:13.492536 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:14.118488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m23:00:14.120548 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m23:00:14.776939 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe1d4e27-7cf7-4bc6-9fea-ea9ea3a9b53e&page=queryresults
[0m23:00:16.501393 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 23:00:13.488540 => 23:00:16.500394
[0m23:00:16.503398 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D8D34F0>]}
[0m23:00:16.504399 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.03s]
[0m23:00:16.505398 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m23:00:16.507791 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.507791 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m23:00:16.509792 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m23:00:16.509792 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.514792 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:16.515789 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 23:00:16.509792 => 23:00:16.515789
[0m23:00:16.515789 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.518792 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:17.141235 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:17.143229 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m23:00:17.921848 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f7dc9fc2-1864-4f98-9e65-8a4a473dd500&page=queryresults
[0m23:00:19.935637 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 23:00:16.516791 => 23:00:19.935637
[0m23:00:19.937539 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D9C7D60>]}
[0m23:00:19.938539 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.43s]
[0m23:00:19.938857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m23:00:19.943113 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:19.943113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:19.944113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m23:00:19.946110 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m23:00:19.947110 [info ] [MainThread]: 
[0m23:00:19.947809 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 15.98 seconds (15.98s).
[0m23:00:19.951039 [debug] [MainThread]: Command end result
[0m23:00:19.966474 [info ] [MainThread]: 
[0m23:00:19.967474 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:00:19.968539 [info ] [MainThread]: 
[0m23:00:19.970155 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m23:00:19.972170 [debug] [MainThread]: Command `dbt run` succeeded at 23:00:19.971170 after 16.53 seconds
[0m23:00:19.972170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B08F233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C652DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5FD760>]}
[0m23:00:19.973168 [debug] [MainThread]: Flushing usage events
[0m00:00:04.451572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3B4744C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3A4052E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3A405760>]}


============================== 00:00:04.451572 | 73a2c17d-0661-4ec0-9efc-0423716848fd ==============================
[0m00:00:04.451572 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:00:04.451572 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:00:05.009009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3BC712E0>]}
[0m00:00:05.104957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EAE30D0>]}
[0m00:00:05.104957 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:00:05.120964 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:00:05.200366 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:00:05.200366 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:00:05.216224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED9AAC0>]}
[0m00:00:05.231860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EC4C730>]}
[0m00:00:05.231860 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:00:05.231860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EC4C6D0>]}
[0m00:00:05.231860 [info ] [MainThread]: 
[0m00:00:05.231860 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:00:05.231860 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.231860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:05.231860 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.231860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:06.158150 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:07.065932 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m00:00:07.065932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.067948 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m00:00:07.069968 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.819689 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m00:00:07.825935 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:08.554374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB57B80>]}
[0m00:00:08.554374 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:00:08.559415 [info ] [MainThread]: 
[0m00:00:08.559415 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.559415 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.559415 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m00:00:08.575384 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m00:00:08.575384 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m00:00:08.582477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.582477 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m00:00:08.607131 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.613687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.623187 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.629418 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 00:00:08.582477 => 00:00:08.626240
[0m00:00:08.629418 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 00:00:08.607131 => 00:00:08.629418
[0m00:00:08.631442 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.631442 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.723230 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.729490 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.733675 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:00:08.736368 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m00:00:08.739437 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m00:00:08.771778 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m00:00:09.675771 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51a7812a-a24e-4b49-872f-a56a1f08240e&page=queryresults
[0m00:00:09.675771 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8a654d3d-e082-4bc8-b80b-65f6b2d8ce8a&page=queryresults
[0m00:00:10.356799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 00:00:08.654846 => 00:00:10.356799
[0m00:00:10.360559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 00:00:08.631442 => 00:00:10.358549
[0m00:00:10.360559 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED7DBB0>]}
[0m00:00:10.362572 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB57B80>]}
[0m00:00:10.362572 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.78s]
[0m00:00:10.364578 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m00:00:10.362572 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.79s]
[0m00:00:10.364578 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.364578 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:10.366586 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m00:00:10.366586 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m00:00:10.368592 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m00:00:10.366586 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m00:00:10.368592 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.368592 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m00:00:10.374702 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m00:00:10.374702 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.374702 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m00:00:10.374702 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 00:00:10.368592 => 00:00:10.374702
[0m00:00:10.374702 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 00:00:10.374702 => 00:00:10.374702
[0m00:00:10.374702 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.374702 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m00:00:10.374702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.390700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m00:00:10.390700 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:10.390700 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:10.390700 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m00:00:10.423113 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m00:00:11.187937 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13ae62b1-9164-4e36-9662-2de6ba79ea0e&page=queryresults
[0m00:00:11.220128 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4b50aac-1458-4181-a2cf-d6a1f2515d05&page=queryresults
[0m00:00:11.600731 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 00:00:10.374702 => 00:00:11.600731
[0m00:00:11.600731 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED7DAC0>]}
[0m00:00:11.600731 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m00:00:11.600731 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m00:00:11.616485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 00:00:10.374702 => 00:00:11.616485
[0m00:00:11.616485 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3FF16D90>]}
[0m00:00:11.632294 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m00:00:11.632294 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m00:00:11.632294 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m00:00:11.632294 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m00:00:11.632294 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m00:00:11.632294 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m00:00:11.648061 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m00:00:11.648061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 00:00:11.632294 => 00:00:11.648061
[0m00:00:11.648061 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m00:00:11.695630 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:12.488313 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m00:00:12.488313 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m00:00:13.153870 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a740f93-3c35-4587-9f20-8a91ea72f7e2&page=queryresults
[0m00:00:16.274571 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 00:00:11.648061 => 00:00:16.274571
[0m00:00:16.276200 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EE28CA0>]}
[0m00:00:16.278317 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.64s]
[0m00:00:16.280216 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m00:00:16.281250 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m00:00:16.282319 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m00:00:16.283254 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m00:00:16.284301 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m00:00:16.289213 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m00:00:16.290208 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 00:00:16.284301 => 00:00:16.290208
[0m00:00:16.291213 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m00:00:16.291213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:17.055600 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m00:00:17.055600 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m00:00:17.765097 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3dfbf0d8-901d-4865-9df8-12cc7e244264&page=queryresults
[0m00:00:21.117761 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 00:00:16.291213 => 00:00:21.117761
[0m00:00:21.117761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EE28CA0>]}
[0m00:00:21.117761 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 4.83s]
[0m00:00:21.132297 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m00:00:21.133861 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.133861 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m00:00:21.133861 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m00:00:21.133861 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.149648 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:21.149648 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 00:00:21.133861 => 00:00:21.149648
[0m00:00:21.149648 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.149648 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:21.795760 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:21.795760 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m00:00:22.445656 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5792cd02-6460-4349-bb31-75c49f5d1b2c&page=queryresults
[0m00:00:24.367431 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 00:00:21.149648 => 00:00:24.366451
[0m00:00:24.369705 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EDEB430>]}
[0m00:00:24.371718 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.23s]
[0m00:00:24.373721 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m00:00:24.373721 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:00:24.373721 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.384330 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.386350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m00:00:24.386931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m00:00:24.387820 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m00:00:24.387820 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m00:00:24.387820 [info ] [MainThread]: 
[0m00:00:24.389584 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 19.16 seconds (19.16s).
[0m00:00:24.391602 [debug] [MainThread]: Command end result
[0m00:00:24.417801 [info ] [MainThread]: 
[0m00:00:24.417801 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:00:24.421278 [info ] [MainThread]: 
[0m00:00:24.421278 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m00:00:24.421278 [debug] [MainThread]: Command `dbt run` succeeded at 00:00:24.421278 after 20.04 seconds
[0m00:00:24.421278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3B4744C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB85880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EBC6C70>]}
[0m00:00:24.424653 [debug] [MainThread]: Flushing usage events
[0m01:00:17.268853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D437363430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9AC0>]}


============================== 01:00:17.284658 | a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b ==============================
[0m01:00:17.284658 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:00:17.284658 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:00:18.541650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9850>]}
[0m01:00:18.605586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4394AAA60>]}
[0m01:00:18.605586 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:00:18.637750 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:00:22.042262 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:00:22.042262 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:00:22.042262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC6A880>]}
[0m01:00:22.122125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AB18550>]}
[0m01:00:22.122125 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:00:22.122125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AB183D0>]}
[0m01:00:22.122125 [info ] [MainThread]: 
[0m01:00:22.130020 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:00:22.130020 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:22.130020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:22.130020 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:22.130020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:23.056713 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:23.828521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:00:23.828521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:23.828521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m01:00:23.828521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:24.549185 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m01:00:24.549185 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:25.293196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC4EAF0>]}
[0m01:00:25.295141 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:00:25.297228 [info ] [MainThread]: 
[0m01:00:25.298193 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.298193 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.298193 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m01:00:25.298193 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m01:00:25.298193 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m01:00:25.298193 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.313970 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m01:00:25.313970 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:25.329923 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.329923 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:25.329923 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 01:00:25.313970 => 01:00:25.329923
[0m01:00:25.329923 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 01:00:25.329923 => 01:00:25.329923
[0m01:00:25.329923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.329923 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.383835 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:25.383835 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:25.383835 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:00:25.393597 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m01:00:25.417682 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:00:25.421015 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m01:00:26.345801 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f36d212-ef1c-407d-af0f-2c536a9cb92d&page=queryresults
[0m01:00:26.345801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fdbdcdc-7597-4292-bf3f-2f886b39b242&page=queryresults
[0m01:00:26.808003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 01:00:25.329923 => 01:00:26.808003
[0m01:00:26.808003 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC4EAF0>]}
[0m01:00:26.808003 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m01:00:26.808003 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:26.808003 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.808003 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m01:00:26.808003 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m01:00:26.808003 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.824029 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:26.824029 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 01:00:26.808003 => 01:00:26.824029
[0m01:00:26.824029 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.824029 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:26.824029 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:26.840030 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m01:00:26.871624 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 01:00:25.377749 => 01:00:26.871624
[0m01:00:26.871624 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACF87F0>]}
[0m01:00:26.871624 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m01:00:26.871624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m01:00:26.871624 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m01:00:26.871624 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m01:00:26.879940 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m01:00:26.879940 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m01:00:26.879940 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m01:00:26.879940 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 01:00:26.879940 => 01:00:26.879940
[0m01:00:26.879940 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m01:00:26.879940 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m01:00:26.887829 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:26.887829 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m01:00:27.765239 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf24500f-dc7e-4f88-b3a4-e6da1300aad5&page=queryresults
[0m01:00:27.813944 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b32a8ef5-0cf0-405b-a8a7-b547719a0d76&page=queryresults
[0m01:00:28.214582 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 01:00:26.824029 => 01:00:28.214582
[0m01:00:28.214582 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACEBE80>]}
[0m01:00:28.214582 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m01:00:28.230440 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m01:00:28.284243 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 01:00:26.879940 => 01:00:28.284243
[0m01:00:28.284243 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACF7160>]}
[0m01:00:28.284243 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m01:00:28.284243 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m01:00:28.284243 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m01:00:28.284243 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m01:00:28.284243 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m01:00:28.284243 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m01:00:28.294891 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m01:00:28.294891 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 01:00:28.294891 => 01:00:28.294891
[0m01:00:28.294891 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m01:00:28.310794 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:29.017175 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m01:00:29.017175 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m01:00:29.709064 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96922049-727c-4aa0-9f64-6f32895e75d8&page=queryresults
[0m01:00:32.320739 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 01:00:28.294891 => 01:00:32.320739
[0m01:00:32.320739 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43BDC19A0>]}
[0m01:00:32.320739 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.04s]
[0m01:00:32.336687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m01:00:32.336687 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m01:00:32.336687 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m01:00:32.336687 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m01:00:32.336687 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m01:00:32.336687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m01:00:32.336687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 01:00:32.336687 => 01:00:32.336687
[0m01:00:32.336687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m01:00:32.352691 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:33.279210 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m01:00:33.281223 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m01:00:33.959045 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6055bb5b-dff5-4349-8da1-6095259de3df&page=queryresults
[0m01:00:36.966873 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 01:00:32.352691 => 01:00:36.964855
[0m01:00:36.966873 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43BDC19A0>]}
[0m01:00:36.968887 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 4.63s]
[0m01:00:36.970897 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m01:00:36.970897 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.972910 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m01:00:36.972910 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m01:00:36.974923 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.974923 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:36.974923 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 01:00:36.974923 => 01:00:36.974923
[0m01:00:36.974923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.987712 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:37.627553 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:37.630110 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m01:00:38.287699 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bbc7b581-7ea1-4954-b77b-e34dd37fb1e0&page=queryresults
[0m01:00:40.446590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 01:00:36.985075 => 01:00:40.446590
[0m01:00:40.448606 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AD0DD30>]}
[0m01:00:40.450620 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.48s]
[0m01:00:40.452171 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m01:00:40.454185 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:00:40.458276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m01:00:40.458276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m01:00:40.458276 [info ] [MainThread]: 
[0m01:00:40.458276 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.34 seconds (18.34s).
[0m01:00:40.462829 [debug] [MainThread]: Command end result
[0m01:00:40.490091 [info ] [MainThread]: 
[0m01:00:40.493351 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:00:40.493351 [info ] [MainThread]: 
[0m01:00:40.498251 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m01:00:40.501614 [debug] [MainThread]: Command `dbt run` succeeded at 01:00:40.498251 after 23.40 seconds
[0m01:00:40.501614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D437363430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4394AAA60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AA03130>]}
[0m01:00:40.501614 [debug] [MainThread]: Flushing usage events
[0m02:00:06.321477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296461C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964512F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964512FD30>]}


============================== 02:00:06.337186 | 0935b514-dc7b-4a46-903e-a2e09dfac3b0 ==============================
[0m02:00:06.337186 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:06.337186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:00:07.386901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964830CAC0>]}
[0m02:00:07.482311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296498316D0>]}
[0m02:00:07.482311 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:07.498334 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:07.623583 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:07.623583 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:07.633139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649ACAB20>]}
[0m02:00:07.650188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296499FD790>]}
[0m02:00:07.650188 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:07.650188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296499FD730>]}
[0m02:00:07.656975 [info ] [MainThread]: 
[0m02:00:07.656975 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:07.656975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:07.656975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:07.656975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:07.656975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:08.551298 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:09.208480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:09.208480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:09.208480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:00:09.208480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:10.081185 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:00:10.092204 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:11.000252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964989E370>]}
[0m02:00:11.015949 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:11.015949 [info ] [MainThread]: 
[0m02:00:11.024383 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.024383 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.024383 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m02:00:11.032020 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:11.032020 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.036415 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:11.036415 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m02:00:11.047988 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:11.047988 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.047988 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:11.047988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:11.032020 => 02:00:11.047988
[0m02:00:11.047988 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.095769 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:11.047988 => 02:00:11.095769
[0m02:00:11.095769 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.095769 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:11.095769 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:11.111522 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:11.111522 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m02:00:11.111522 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:11.143521 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:12.026034 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cdccdbf2-bce2-46a7-b0ed-dda539676917&page=queryresults
[0m02:00:12.026034 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:547808b3-4277-4dce-8585-03453fa69b8c&page=queryresults
[0m02:00:12.492027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:11.047988 => 02:00:12.492027
[0m02:00:12.492027 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964989E370>]}
[0m02:00:12.492027 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:11.095769 => 02:00:12.492027
[0m02:00:12.492027 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m02:00:12.507780 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296497B5C10>]}
[0m02:00:12.507780 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:12.507780 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.507780 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m02:00:12.507780 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:12.507780 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m02:00:12.507780 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:12.507780 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:12.507780 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.507780 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m02:00:12.507780 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:12.507780 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m02:00:12.507780 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:12.507780 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:12.523459 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:12.507780 => 02:00:12.523459
[0m02:00:12.523459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.523459 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:12.523459 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:12.523459 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:12.507780 => 02:00:12.523459
[0m02:00:12.523459 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:12.535490 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:12.539299 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:12.571837 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:12.571837 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:13.345206 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38bb79d0-b082-4d95-b62d-d645d0e2b832&page=queryresults
[0m02:00:13.425864 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f73721d-39a5-40e4-833f-58b39a76d8bf&page=queryresults
[0m02:00:13.822488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:12.523459 => 02:00:13.822488
[0m02:00:13.824502 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649AD4040>]}
[0m02:00:13.826515 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m02:00:13.826515 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:13.908845 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:12.523459 => 02:00:13.908845
[0m02:00:13.910858 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649AAED30>]}
[0m02:00:13.910858 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m02:00:13.910858 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:13.910858 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:13.910858 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m02:00:13.910858 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m02:00:13.910858 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:13.923038 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:13.925049 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:13.910858 => 02:00:13.925049
[0m02:00:13.927059 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:13.955036 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:14.725531 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:14.735654 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:15.618634 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef648071-530e-48b8-8792-21c6a066392b&page=queryresults
[0m02:00:18.245435 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:13.927059 => 02:00:18.243426
[0m02:00:18.245435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AC25DC0>]}
[0m02:00:18.245435 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.33s]
[0m02:00:18.245435 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:18.245435 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:18.245435 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m02:00:18.249914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m02:00:18.252423 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:18.258470 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:18.258470 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:18.252423 => 02:00:18.258470
[0m02:00:18.258470 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:18.265812 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:18.905844 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:18.907860 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m02:00:19.594331 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5c5f1efa-6d0d-4d14-bbc5-7af0c0585a7c&page=queryresults
[0m02:00:21.887754 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:18.258470 => 02:00:21.887754
[0m02:00:21.889767 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AB88400>]}
[0m02:00:21.889767 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.64s]
[0m02:00:21.891782 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:21.893794 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.893794 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m02:00:21.895807 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:21.895807 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.901843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:21.904865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:21.895807 => 02:00:21.902853
[0m02:00:21.904865 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.908893 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:22.838031 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:22.840048 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:23.495669 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:651311a0-97b9-4154-8d57-a5e47d585b23&page=queryresults
[0m02:00:25.861068 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:21.904865 => 02:00:25.861068
[0m02:00:25.863080 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AB88400>]}
[0m02:00:25.864979 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.97s]
[0m02:00:25.864979 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:25.867528 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:00:25.872124 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m02:00:25.872124 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m02:00:25.872124 [info ] [MainThread]: 
[0m02:00:25.872124 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.22 seconds (18.22s).
[0m02:00:25.874135 [debug] [MainThread]: Command end result
[0m02:00:25.895816 [info ] [MainThread]: 
[0m02:00:25.902639 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:25.902639 [info ] [MainThread]: 
[0m02:00:25.902639 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m02:00:25.902639 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:25.902639 after 19.72 seconds
[0m02:00:25.907551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296461C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296498316D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964988D4C0>]}
[0m02:00:25.907551 [debug] [MainThread]: Flushing usage events
[0m03:00:05.338831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AD6F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC67A6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC67AE20>]}


============================== 03:00:05.354594 | 161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82 ==============================
[0m03:00:05.354594 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:05.354594 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:00:06.371720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC66B220>]}
[0m03:00:06.435416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0D60A60>]}
[0m03:00:06.451386 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:06.451386 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:06.499400 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:06.499400 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:06.499400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FFAF10>]}
[0m03:00:06.515181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0F2EE80>]}
[0m03:00:06.515181 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:06.515181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0DDD310>]}
[0m03:00:06.516830 [info ] [MainThread]: 
[0m03:00:06.516830 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:06.516830 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:06.516830 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:06.516830 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:06.516830 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.522835 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.202568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:08.207159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:08.207159 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:08.207159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:08.913022 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:08.913022 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:09.632051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FDDDF0>]}
[0m03:00:09.632051 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:09.632051 [info ] [MainThread]: 
[0m03:00:09.646304 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.646304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.646304 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m03:00:09.646304 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:09.646304 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.646304 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m03:00:09.662453 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:09.662453 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:09.662453 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.678162 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:09.678162 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:09.646304 => 03:00:09.678162
[0m03:00:09.678162 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.709879 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:09.662453 => 03:00:09.709879
[0m03:00:09.725800 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.732279 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:09.749028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:09.751039 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:09.755059 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m03:00:09.806022 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:09.806022 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:10.755539 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3e6359d-5b0b-4641-bb4e-fb4b1722a557&page=queryresults
[0m03:00:11.271321 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:09.725800 => 03:00:11.271321
[0m03:00:11.271321 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:83266c30-d991-46a6-a450-062e6c5b38d5&page=queryresults
[0m03:00:11.271321 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0DB7BB0>]}
[0m03:00:11.271321 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m03:00:11.287161 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:11.287161 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.287161 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m03:00:11.287161 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:11.287161 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.295568 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:11.295568 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:11.291537 => 03:00:11.295568
[0m03:00:11.295568 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.302996 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:11.302996 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:11.302996 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:11.864876 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:09.683844 => 03:00:11.864876
[0m03:00:11.864876 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B108C610>]}
[0m03:00:11.864876 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 2.22s]
[0m03:00:11.864876 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:11.864876 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:11.864876 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m03:00:11.864876 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m03:00:11.864876 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:11.880680 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:11.880680 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:11.864876 => 03:00:11.880680
[0m03:00:11.880680 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:11.880680 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:11.880680 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:11.880680 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:12.275015 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:330b7f85-6486-4881-ae10-e319cde19e55&page=queryresults
[0m03:00:12.706880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46148dfd-456f-4cf0-9a4b-5f4927f64562&page=queryresults
[0m03:00:13.021136 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:11.295568 => 03:00:13.021136
[0m03:00:13.021136 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0F2EE20>]}
[0m03:00:13.023149 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.73s]
[0m03:00:13.023149 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:13.285380 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:11.880680 => 03:00:13.285380
[0m03:00:13.287492 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B108C610>]}
[0m03:00:13.289506 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m03:00:13.289506 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:13.291518 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:13.291518 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m03:00:13.291518 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m03:00:13.291518 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:13.291518 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:13.291518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:13.291518 => 03:00:13.291518
[0m03:00:13.303601 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:13.319720 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:14.056177 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:14.071210 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:14.732206 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76e5e3e5-6a41-4eaa-a146-ff14c387c9ff&page=queryresults
[0m03:00:17.432635 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:13.303601 => 03:00:17.430615
[0m03:00:17.432635 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B21561C0>]}
[0m03:00:17.434651 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.14s]
[0m03:00:17.437472 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:17.439213 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:17.441225 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m03:00:17.441225 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m03:00:17.443237 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:17.447150 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:17.449250 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:17.443237 => 03:00:17.449250
[0m03:00:17.450245 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:17.453249 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:18.167927 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:18.169944 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m03:00:18.850999 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:679742c3-10bf-43bb-b062-75771f7b37c5&page=queryresults
[0m03:00:20.996130 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:17.450245 => 03:00:20.996130
[0m03:00:21.005687 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B2169BB0>]}
[0m03:00:21.005687 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.56s]
[0m03:00:21.005687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:21.005687 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.005687 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m03:00:21.005687 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:21.005687 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.005687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:21.005687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:21.005687 => 03:00:21.005687
[0m03:00:21.005687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.021676 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:21.674833 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:21.674833 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:22.333618 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fc0a989-0255-4267-b5eb-df5cc03a2743&page=queryresults
[0m03:00:24.583758 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:21.005687 => 03:00:24.583758
[0m03:00:24.585772 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B2130940>]}
[0m03:00:24.587284 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.58s]
[0m03:00:24.587284 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:24.589933 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m03:00:24.594518 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m03:00:24.594518 [info ] [MainThread]: 
[0m03:00:24.594518 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.08 seconds (18.08s).
[0m03:00:24.596530 [debug] [MainThread]: Command end result
[0m03:00:24.620920 [info ] [MainThread]: 
[0m03:00:24.620920 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:24.620920 [info ] [MainThread]: 
[0m03:00:24.620920 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m03:00:24.620920 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:24.620920 after 19.35 seconds
[0m03:00:24.627691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AD6F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0D60A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FDDEE0>]}
[0m03:00:24.627691 [debug] [MainThread]: Flushing usage events
[0m04:00:18.096706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E8C073D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B979D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B97B80>]}


============================== 04:00:18.106563 | d5362b1f-df74-446a-8560-fc79905b4ac7 ==============================
[0m04:00:18.106563 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:18.108541 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m04:00:20.238797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B87FD0>]}
[0m04:00:20.374371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC280B20>]}
[0m04:00:20.376487 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:20.419241 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:23.775999 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:23.776995 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:23.782570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC51AE20>]}
[0m04:00:23.830485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC506970>]}
[0m04:00:23.831581 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:23.832583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC506910>]}
[0m04:00:23.836578 [info ] [MainThread]: 
[0m04:00:23.838576 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:23.844190 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.845190 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:23.847297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.849284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.119894 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:25.852938 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:25.854041 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.856037 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:00:25.856939 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:26.555983 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:26.558971 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:27.254451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC51AFA0>]}
[0m04:00:27.255554 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:27.256548 [info ] [MainThread]: 
[0m04:00:27.276750 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.277714 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.279756 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m04:00:27.282573 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:27.283709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.280715 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m04:00:27.298714 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:27.299739 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:27.301754 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.307597 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:27.309607 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:27.284654 => 04:00:27.309607
[0m04:00:27.310597 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.351362 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:27.302463 => 04:00:27.351362
[0m04:00:27.367420 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.370475 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:27.383996 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:27.384997 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:27.389014 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m04:00:27.427665 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:27.429735 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:28.278584 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2cc63fc2-e882-4802-94a7-7863345d629b&page=queryresults
[0m04:00:28.289395 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c8a9996e-6ce7-4970-a653-659d32601652&page=queryresults
[0m04:00:28.741655 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:27.370475 => 04:00:28.740693
[0m04:00:28.743499 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5A40A0>]}
[0m04:00:28.752412 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:27.311596 => 04:00:28.751504
[0m04:00:28.745505 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m04:00:28.755500 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC194A00>]}
[0m04:00:28.758508 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:28.761501 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.759522 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m04:00:28.763451 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m04:00:28.766416 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:28.768416 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:28.769428 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:28.771412 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.782243 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.772410 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m04:00:28.785266 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m04:00:28.787257 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:28.797359 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:28.798353 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:28.773330 => 04:00:28.798353
[0m04:00:28.799358 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.807017 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.809021 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:28.788255 => 04:00:28.809021
[0m04:00:28.811021 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:28.819026 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:28.820027 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:28.821459 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:28.865618 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:28.869558 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:29.598358 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:867ecf6a-61a8-45d0-a6db-59afdc277f14&page=queryresults
[0m04:00:29.691268 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb559296-87d2-4048-97b6-91f4db48d6be&page=queryresults
[0m04:00:30.094612 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:28.812020 => 04:00:30.093612
[0m04:00:30.095613 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5BDF10>]}
[0m04:00:30.097713 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m04:00:30.098711 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:30.100396 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:30.101411 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m04:00:30.103251 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m04:00:30.105340 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:30.123230 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:30.126234 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:30.105340 => 04:00:30.125231
[0m04:00:30.128238 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:30.134185 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:28.800347 => 04:00:30.133183
[0m04:00:30.163064 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5ED5E4FA0>]}
[0m04:00:30.165021 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:30.167115 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m04:00:30.170081 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:31.196499 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:31.197506 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:31.836122 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6d59958-d100-49e2-afbd-e59aaf83c445&page=queryresults
[0m04:00:34.389870 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:30.135175 => 04:00:34.389870
[0m04:00:34.390871 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5ED673B50>]}
[0m04:00:34.391874 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.29s]
[0m04:00:34.391874 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:34.393888 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:34.394769 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m04:00:34.396860 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m04:00:34.397861 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:34.404462 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:34.406552 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:34.398860 => 04:00:34.405562
[0m04:00:34.407558 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:34.411558 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:35.078513 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:35.080513 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m04:00:35.712912 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8eba6258-e4c9-4e0e-8c78-84563bb10c8c&page=queryresults
[0m04:00:37.635725 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:34.407558 => 04:00:37.635725
[0m04:00:37.637713 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5C1340>]}
[0m04:00:37.638705 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.24s]
[0m04:00:37.639613 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:37.640612 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.641612 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m04:00:37.642826 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:37.642826 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.647916 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:37.649826 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:37.643825 => 04:00:37.648925
[0m04:00:37.649826 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.653824 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:38.276505 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:38.279504 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:38.999790 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aef3ba05-d612-461f-8578-151de5eda99b&page=queryresults
[0m04:00:41.238051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:37.650825 => 04:00:41.237052
[0m04:00:41.241056 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC194A00>]}
[0m04:00:41.242678 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.60s]
[0m04:00:41.246672 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:41.252669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:41.254670 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:41.255672 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:41.256674 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:00:41.257673 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:41.258672 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m04:00:41.258672 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m04:00:41.259672 [info ] [MainThread]: 
[0m04:00:41.262596 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.42 seconds (17.42s).
[0m04:00:41.269716 [debug] [MainThread]: Command end result
[0m04:00:41.298384 [info ] [MainThread]: 
[0m04:00:41.300474 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:41.302182 [info ] [MainThread]: 
[0m04:00:41.303313 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m04:00:41.306305 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:41.306305 after 23.37 seconds
[0m04:00:41.308291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E8C073D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC1FB070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B97BE0>]}
[0m04:00:41.308291 [debug] [MainThread]: Flushing usage events
[0m05:00:05.159770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BADE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B9D6C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B9D6C760>]}


============================== 05:00:05.166106 | 4afc72d3-45a4-4033-aedb-30ddee6eef4c ==============================
[0m05:00:05.166106 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:05.167072 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:05.981576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE3AB8B0>]}
[0m05:00:06.039709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE338A30>]}
[0m05:00:06.041718 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:06.047425 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:06.092829 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:06.093831 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:06.096831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6ED0D0>]}
[0m05:00:06.104673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE562EE0>]}
[0m05:00:06.105674 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:06.105674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE3605B0>]}
[0m05:00:06.107779 [info ] [MainThread]: 
[0m05:00:06.108783 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:06.111772 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.112671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:06.112671 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.112671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.120801 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.790101 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:07.791111 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.793117 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:07.795106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:08.470981 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:08.473956 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:09.105594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:09.107600 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:09.109598 [info ] [MainThread]: 
[0m05:00:09.116600 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.117601 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.118600 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m05:00:09.120610 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:09.121595 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.131136 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.119610 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m05:00:09.133139 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:09.133139 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.137140 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.140145 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:09.122040 => 05:00:09.139152
[0m05:00:09.140145 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.141148 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:09.133139 => 05:00:09.140145
[0m05:00:09.165639 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.174640 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.183523 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.184429 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:09.186538 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m05:00:09.214155 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:09.217646 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:10.080189 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:55b2e082-4622-4f02-ae91-4286731f4f06&page=queryresults
[0m05:00:10.096723 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a756146f-6639-40ed-af59-7f3a03932a9c&page=queryresults
[0m05:00:10.535286 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:09.174640 => 05:00:10.535286
[0m05:00:10.536276 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE725D30>]}
[0m05:00:10.537283 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m05:00:10.538182 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.538182 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.539284 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m05:00:10.541281 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:10.542030 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.548152 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.550115 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:10.542030 => 05:00:10.549140
[0m05:00:10.550115 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.554144 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.555150 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:10.557149 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:10.621859 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:09.141842 => 05:00:10.620866
[0m05:00:10.623386 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:10.623386 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m05:00:10.624404 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.625372 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:10.626336 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m05:00:10.627397 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m05:00:10.628383 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:10.633372 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:10.634371 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:10.628383 => 05:00:10.634371
[0m05:00:10.634371 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:10.638377 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:10.639370 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:10.641368 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:11.376757 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:528b53ff-90e4-4746-8145-d3d0eeb12d22&page=queryresults
[0m05:00:11.433413 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca992188-b26e-4f31-96c9-e494e650a713&page=queryresults
[0m05:00:11.772866 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:10.635370 => 05:00:11.771869
[0m05:00:11.774872 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4A10D0>]}
[0m05:00:11.775871 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m05:00:11.776917 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:11.777922 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:11.778918 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m05:00:11.779924 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m05:00:11.780921 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:11.788822 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:11.789832 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:11.780921 => 05:00:11.789832
[0m05:00:11.789832 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:11.795825 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:12.092276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:10.551139 => 05:00:12.091273
[0m05:00:12.093278 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF827EE0>]}
[0m05:00:12.094276 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.55s]
[0m05:00:12.096272 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:12.507786 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:12.509786 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:13.194743 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c33d0dd5-32d0-4222-8e11-e3564f083caa&page=queryresults
[0m05:00:15.782845 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:11.789832 => 05:00:15.781863
[0m05:00:15.783908 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF7AA0A0>]}
[0m05:00:15.784868 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.00s]
[0m05:00:15.785866 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:15.786860 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:15.786860 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m05:00:15.787868 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m05:00:15.788865 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:15.790866 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:15.791864 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:15.788865 => 05:00:15.790866
[0m05:00:15.791864 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:15.793865 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:16.420355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:16.422926 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m05:00:17.067866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3a78f69-946f-4a4d-b138-cc32d5eac79d&page=queryresults
[0m05:00:19.348082 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:15.791864 => 05:00:19.348082
[0m05:00:19.349052 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF7AA0A0>]}
[0m05:00:19.350050 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.56s]
[0m05:00:19.351057 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:19.351057 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.352049 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m05:00:19.353050 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:19.353050 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.358099 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:19.360090 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:19.353050 => 05:00:19.360090
[0m05:00:19.361088 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.363755 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:19.955210 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:19.957214 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:20.518667 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a641007a-5969-4fba-8c01-9c36a90080fa&page=queryresults
[0m05:00:22.708396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:19.361088 => 05:00:22.708396
[0m05:00:22.710406 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:22.711409 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.36s]
[0m05:00:22.713426 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:22.716371 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:22.717375 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:22.718375 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:22.719416 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:00:22.720418 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:00:22.720418 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m05:00:22.721863 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m05:00:22.721863 [info ] [MainThread]: 
[0m05:00:22.722899 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.61 seconds (16.61s).
[0m05:00:22.726864 [debug] [MainThread]: Command end result
[0m05:00:22.739953 [info ] [MainThread]: 
[0m05:00:22.740957 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:22.740957 [info ] [MainThread]: 
[0m05:00:22.742347 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m05:00:22.744374 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:22.743370 after 17.66 seconds
[0m05:00:22.744374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BADE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6D5040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6EAFD0>]}
[0m05:00:22.745371 [debug] [MainThread]: Flushing usage events
[0m06:00:05.267887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4AFD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4C640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4CAC0>]}


============================== 06:00:05.272887 | 4c482e8a-66ac-4a77-9150-d0d950ceb005 ==============================
[0m06:00:05.272887 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:05.273889 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m06:00:06.258902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4C850>]}
[0m06:00:06.325685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4D915A00>]}
[0m06:00:06.327653 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:06.334627 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:06.392720 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:06.392720 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:06.396721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E8DACD0>]}
[0m06:00:06.405425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E80A9A0>]}
[0m06:00:06.405425 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:06.406531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E80A820>]}
[0m06:00:06.407524 [info ] [MainThread]: 
[0m06:00:06.409534 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:06.411524 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.412540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.413533 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.414531 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.256031 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.144084 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:08.145088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.147091 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:08.149052 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.844737 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:08.846729 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:09.504826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E692730>]}
[0m06:00:09.506881 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:09.507886 [info ] [MainThread]: 
[0m06:00:09.516568 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.517634 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.519633 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m06:00:09.521625 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:09.522625 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.520634 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m06:00:09.535490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.537486 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:09.537486 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.540486 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.542074 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:09.523418 => 06:00:09.542074
[0m06:00:09.543119 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.543119 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:09.538496 => 06:00:09.543119
[0m06:00:09.555139 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.571957 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.575955 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.576954 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:09.576954 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:09.579959 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:09.600743 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m06:00:10.384489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f58fa0c4-13c3-4815-af28-17bfa518ce90&page=queryresults
[0m06:00:10.392441 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13c7cf13-0b16-4314-9642-30b3b5e91714&page=queryresults
[0m06:00:10.849654 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:09.543119 => 06:00:10.849654
[0m06:00:10.850658 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E692730>]}
[0m06:00:10.851653 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m06:00:10.853652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:10.854658 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.861661 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:09.570950 => 06:00:10.860657
[0m06:00:10.865657 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E67AC10>]}
[0m06:00:10.863661 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m06:00:10.868656 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:10.867659 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m06:00:10.870661 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.872659 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:10.880671 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.881643 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:10.882458 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m06:00:10.883529 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m06:00:10.884481 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:10.892542 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:10.893537 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:10.873662 => 06:00:10.892542
[0m06:00:10.894540 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.900526 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.902294 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:10.884481 => 06:00:10.901477
[0m06:00:10.903351 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:10.909439 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:10.910433 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.912438 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:10.931486 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:10.933482 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:11.676418 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37e7c235-3d9e-49a3-9a38-30510eec22ac&page=queryresults
[0m06:00:11.678411 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a853016b-294d-4ddd-adfc-6f17b1369f31&page=queryresults
[0m06:00:12.069539 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:10.895526 => 06:00:12.068539
[0m06:00:12.070536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F97EFA0>]}
[0m06:00:12.071536 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m06:00:12.073572 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:12.115456 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:10.904358 => 06:00:12.114457
[0m06:00:12.117459 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E8BDD00>]}
[0m06:00:12.118458 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m06:00:12.120462 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:12.121456 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:12.122335 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m06:00:12.124444 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m06:00:12.125447 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:12.137347 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:12.138346 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:12.126447 => 06:00:12.138346
[0m06:00:12.139387 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:12.146115 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:12.812097 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:12.813110 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:13.430603 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a4b5994-5220-4288-b69f-eb84afe27dcf&page=queryresults
[0m06:00:15.954462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:12.139387 => 06:00:15.953459
[0m06:00:15.956460 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F9EC370>]}
[0m06:00:15.957461 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.83s]
[0m06:00:15.959463 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:15.961456 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:15.963309 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m06:00:15.965312 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m06:00:15.966309 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:15.973310 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:15.975261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:15.967310 => 06:00:15.975261
[0m06:00:15.976262 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:15.980261 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:16.613365 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:16.615345 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m06:00:17.198365 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3d29de9-7548-4ef8-8ab1-3d5c9e23931a&page=queryresults
[0m06:00:19.183796 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:15.976262 => 06:00:19.182680
[0m06:00:19.185796 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F9DAF40>]}
[0m06:00:19.186793 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.22s]
[0m06:00:19.187814 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:19.188786 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.190695 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m06:00:19.191695 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:19.191695 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.199779 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:19.202352 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:19.192797 => 06:00:19.202352
[0m06:00:19.203380 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.207373 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:20.028834 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:20.031941 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:20.583709 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1b60177-7440-4dde-bac7-a64e1b400cd5&page=queryresults
[0m06:00:23.151439 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:19.204376 => 06:00:23.150514
[0m06:00:23.153470 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4FA88F40>]}
[0m06:00:23.154491 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.96s]
[0m06:00:23.155547 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:23.159530 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:23.160526 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:23.161530 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:23.163409 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:00:23.163409 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:00:23.164507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m06:00:23.165506 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m06:00:23.166501 [info ] [MainThread]: 
[0m06:00:23.167509 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.76 seconds (16.76s).
[0m06:00:23.171502 [debug] [MainThread]: Command end result
[0m06:00:23.183407 [info ] [MainThread]: 
[0m06:00:23.184398 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:23.185299 [info ] [MainThread]: 
[0m06:00:23.187317 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m06:00:23.189312 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:23.189312 after 17.97 seconds
[0m06:00:23.191311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4AFD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4D915A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E69CDC0>]}
[0m06:00:23.192312 [debug] [MainThread]: Flushing usage events
[0m07:00:15.222113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC400A3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC3F01C8E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC3F01C5E0>]}


============================== 07:00:15.236758 | 7730b1c5-be08-4d9c-85ef-4893684c87ca ==============================
[0m07:00:15.236758 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:15.238758 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m07:00:16.959230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC421E5A00>]}
[0m07:00:17.039983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437216D0>]}
[0m07:00:17.041925 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:17.051643 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:17.288722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:17.288722 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:17.293722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC439BAB20>]}
[0m07:00:17.308565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC438ED7C0>]}
[0m07:00:17.309621 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:17.310617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC438ED6D0>]}
[0m07:00:17.312621 [info ] [MainThread]: 
[0m07:00:17.314681 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:17.317636 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:17.317636 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:17.318632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:17.318632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:18.282580 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:18.984586 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:00:18.986544 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:18.987577 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:18.989545 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:19.655149 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:00:19.659055 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:20.279666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437D73D0>]}
[0m07:00:20.280674 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:20.282507 [info ] [MainThread]: 
[0m07:00:20.297796 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.299777 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.300788 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m07:00:20.304707 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:20.302591 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m07:00:20.306721 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.308720 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:20.323761 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:20.324760 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.330761 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:20.333763 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:20.309617 => 07:00:20.332671
[0m07:00:20.334794 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.369497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:20.324760 => 07:00:20.369497
[0m07:00:20.374497 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:20.375496 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.383164 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:20.390179 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:20.393178 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m07:00:20.417176 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:20.419221 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:21.300716 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:64d34540-638d-4644-8133-ab7e0f215c6c&page=queryresults
[0m07:00:21.304631 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0178c6b1-4cb7-4212-91b8-1ec4336ef831&page=queryresults
[0m07:00:21.766871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:20.375496 => 07:00:21.766871
[0m07:00:21.766871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4399ED30>]}
[0m07:00:21.774861 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:20.334794 => 07:00:21.774861
[0m07:00:21.768856 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m07:00:21.776856 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437D73D0>]}
[0m07:00:21.777861 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:21.778864 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.778864 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m07:00:21.780861 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m07:00:21.781844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:21.782285 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:21.783306 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:21.784333 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.789287 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:21.785324 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m07:00:21.790287 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m07:00:21.791287 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:21.794413 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:21.795420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:21.785324 => 07:00:21.794413
[0m07:00:21.795420 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.798294 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:21.798294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:21.791287 => 07:00:21.798294
[0m07:00:21.799349 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:21.803658 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:21.804656 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:21.806624 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:21.836976 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:21.838937 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:22.813293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d88d7c2-2bb1-4439-b9dd-cae0e2b18c12&page=queryresults
[0m07:00:22.847712 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce7ae08b-e192-4975-a026-089b48159299&page=queryresults
[0m07:00:23.239093 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:21.799349 => 07:00:23.238087
[0m07:00:23.241087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44B18280>]}
[0m07:00:23.242805 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m07:00:23.243751 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:23.244797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:23.245756 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m07:00:23.246754 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m07:00:23.246754 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:23.262513 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:23.265572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:23.247800 => 07:00:23.264526
[0m07:00:23.266535 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:23.278586 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:23.281575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:21.795420 => 07:00:23.281575
[0m07:00:23.282430 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A3F8E0>]}
[0m07:00:23.283494 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m07:00:23.302210 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:23.933495 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:23.934493 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:24.545186 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:efe9d64f-0909-4358-ba8f-ea31c69c747d&page=queryresults
[0m07:00:27.363404 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:23.267568 => 07:00:27.363404
[0m07:00:27.364379 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A3F8E0>]}
[0m07:00:27.365391 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.12s]
[0m07:00:27.367491 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:27.369483 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:27.371482 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m07:00:27.373491 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m07:00:27.375484 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:27.382242 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:27.383261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:27.375484 => 07:00:27.383261
[0m07:00:27.384261 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:27.387262 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:27.980400 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:27.984219 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m07:00:28.695681 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4c4f861-eb4b-4245-97a2-b229494a830b&page=queryresults
[0m07:00:30.683250 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:27.384261 => 07:00:30.682323
[0m07:00:30.685368 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A64040>]}
[0m07:00:30.687359 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.31s]
[0m07:00:30.688373 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:30.690263 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.691368 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m07:00:30.693271 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:30.694269 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.702117 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:30.704146 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:30.694269 => 07:00:30.703140
[0m07:00:30.705142 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.710244 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:31.348148 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:31.351152 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:31.937010 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8c2d697-82cd-4559-8608-ed15986c6141&page=queryresults
[0m07:00:35.163653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:30.705142 => 07:00:35.162592
[0m07:00:35.165649 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44BE9D90>]}
[0m07:00:35.166610 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.47s]
[0m07:00:35.168611 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:35.171650 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:35.171650 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:35.172649 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:35.173658 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:35.174659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:00:35.174659 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m07:00:35.176665 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m07:00:35.177676 [info ] [MainThread]: 
[0m07:00:35.178610 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.86 seconds (17.86s).
[0m07:00:35.182144 [debug] [MainThread]: Command end result
[0m07:00:35.193176 [info ] [MainThread]: 
[0m07:00:35.194139 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:35.195139 [info ] [MainThread]: 
[0m07:00:35.196178 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m07:00:35.197173 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:35.197173 after 20.07 seconds
[0m07:00:35.197173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC400A3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437216D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44A5CD00>]}
[0m07:00:35.198171 [debug] [MainThread]: Flushing usage events
[0m08:00:05.625561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089BE03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD789A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD78D30>]}


============================== 08:00:05.633515 | e6b41468-2089-4194-8834-2b3bf1a8ae28 ==============================
[0m08:00:05.633515 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:05.634508 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:06.550559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD7E370>]}
[0m08:00:06.613530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F38B250>]}
[0m08:00:06.615200 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:06.622339 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:06.675888 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:06.675888 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:06.679890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70B460>]}
[0m08:00:06.687627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F6FB100>]}
[0m08:00:06.687627 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:06.688588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4EF850>]}
[0m08:00:06.689622 [info ] [MainThread]: 
[0m08:00:06.690782 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:06.692602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.693641 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.694609 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.695647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.748259 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.984981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m08:00:08.986888 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:08.987979 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.988992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:09.942544 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:09.943658 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:10.593592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4C9400>]}
[0m08:00:10.593592 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:10.594481 [info ] [MainThread]: 
[0m08:00:10.602146 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.603145 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.605144 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m08:00:10.607162 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:10.608159 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.606147 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m08:00:10.620269 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.621601 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:10.622203 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.627345 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.628222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:10.609157 => 08:00:10.628222
[0m08:00:10.629226 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.636261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:10.622203 => 08:00:10.636261
[0m08:00:10.659372 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.659372 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.662207 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:10.665220 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.668219 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m08:00:10.700790 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:10.702649 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:11.551856 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84a1b4f5-ca1b-4b9e-8263-a6d545fc1a29&page=queryresults
[0m08:00:11.615111 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6be8133-c22a-4444-b9ee-df45e22ed227&page=queryresults
[0m08:00:12.009152 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:10.629226 => 08:00:12.009152
[0m08:00:12.010150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F799FD0>]}
[0m08:00:12.011151 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m08:00:12.012152 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:12.013253 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.013253 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m08:00:12.014242 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:12.015241 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.018237 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:12.019248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:12.015241 => 08:00:12.019248
[0m08:00:12.019248 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.021247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:12.022173 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.023237 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:12.091369 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:10.659372 => 08:00:12.090373
[0m08:00:12.092460 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F75B9A0>]}
[0m08:00:12.093471 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m08:00:12.095458 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:12.095458 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:12.096466 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m08:00:12.098455 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m08:00:12.098455 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:12.103509 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:12.106515 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:12.099449 => 08:00:12.105521
[0m08:00:12.107513 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:12.114511 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:12.116514 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.119511 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:12.734823 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cdce8290-1710-4a39-ba86-795ff8c67f7f&page=queryresults
[0m08:00:12.834328 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1cf3d9a5-ef5e-4071-840f-26c893b52a42&page=queryresults
[0m08:00:13.141173 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:12.019248 => 08:00:13.140172
[0m08:00:13.141173 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70B550>]}
[0m08:00:13.142549 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m08:00:13.142549 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:13.237210 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:12.107513 => 08:00:13.237210
[0m08:00:13.239219 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F75B9A0>]}
[0m08:00:13.240222 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m08:00:13.241112 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:13.242761 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:13.243838 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m08:00:13.244836 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m08:00:13.245836 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:13.260837 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:13.262839 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:13.245836 => 08:00:13.262839
[0m08:00:13.263840 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:13.285267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:14.025834 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:14.027843 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:14.729970 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:457b453b-06a3-49d6-a20b-aa380aa0a63f&page=queryresults
[0m08:00:17.811055 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:13.263840 => 08:00:17.811055
[0m08:00:17.813055 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70BF70>]}
[0m08:00:17.814054 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.57s]
[0m08:00:17.814648 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:17.816735 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:17.817732 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m08:00:17.819735 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m08:00:17.819735 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:17.826755 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:17.828751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:17.820732 => 08:00:17.828751
[0m08:00:17.829655 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:17.833758 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:18.463725 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:18.465738 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m08:00:19.193137 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9992e2e6-9488-4b18-8d7e-68cc54ccbe5f&page=queryresults
[0m08:00:21.438164 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:17.829655 => 08:00:21.437158
[0m08:00:21.439163 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208A0794760>]}
[0m08:00:21.440163 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.62s]
[0m08:00:21.441856 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:21.443176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.444257 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m08:00:21.445252 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:21.446252 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.451252 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:21.452251 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:21.446252 => 08:00:21.452251
[0m08:00:21.453261 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.456352 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:22.104069 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:22.106084 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:22.876290 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b642f035-423d-45a9-b0ff-84e21bf39bcf&page=queryresults
[0m08:00:25.135394 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:21.453261 => 08:00:25.135394
[0m08:00:25.136288 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208A089B190>]}
[0m08:00:25.136288 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.69s]
[0m08:00:25.137289 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.139292 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:25.140290 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.140290 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.141401 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:25.141401 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:00:25.142392 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m08:00:25.142761 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m08:00:25.142761 [info ] [MainThread]: 
[0m08:00:25.143865 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.45 seconds (18.45s).
[0m08:00:25.146760 [debug] [MainThread]: Command end result
[0m08:00:25.158764 [info ] [MainThread]: 
[0m08:00:25.159766 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:25.160765 [info ] [MainThread]: 
[0m08:00:25.162304 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m08:00:25.163338 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:25.163338 after 19.65 seconds
[0m08:00:25.164341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089BE03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4EF3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4D3970>]}
[0m08:00:25.165338 [debug] [MainThread]: Flushing usage events
[0m09:00:06.805163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6FCA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC2A6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC2AE20>]}


============================== 09:00:06.814128 | 75c566b4-81fa-4f33-bdb0-914ec8723b00 ==============================
[0m09:00:06.814128 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:06.814815 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:07.728530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC1E070>]}
[0m09:00:07.785684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73305850>]}
[0m09:00:07.788058 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:07.798106 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:07.868091 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:07.868091 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:07.872098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735ABD90>]}
[0m09:00:07.879023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7359FA30>]}
[0m09:00:07.880023 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:07.880023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7359F940>]}
[0m09:00:07.882394 [info ] [MainThread]: 
[0m09:00:07.883427 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:07.885425 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.885425 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.886425 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.920079 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:08.905394 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:09.579359 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:00:09.580366 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:09.581369 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:09.582364 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:10.254025 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:10.255019 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:10.888003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73373D60>]}
[0m09:00:10.889093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:10.891100 [info ] [MainThread]: 
[0m09:00:10.898797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.899842 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.900796 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m09:00:10.904626 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:10.902457 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m09:00:10.905626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.906505 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:10.920621 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.922339 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.927442 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.929451 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:10.907630 => 09:00:10.928441
[0m09:00:10.929451 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.957636 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:10.922339 => 09:00:10.957636
[0m09:00:10.972474 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.973630 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.985374 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.986375 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:10.990374 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m09:00:11.031107 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:11.033099 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:11.892246 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58534a6b-2c30-4538-808e-61d3d8ced6c2&page=queryresults
[0m09:00:11.901774 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:589b6941-17ba-4cc6-b4cd-56fd31b37051&page=queryresults
[0m09:00:12.302546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:10.930439 => 09:00:12.302546
[0m09:00:12.303652 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73373D60>]}
[0m09:00:12.304652 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m09:00:12.305586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:12.306565 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.307560 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m09:00:12.308562 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:12.308562 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.313563 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:12.314566 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:12.309565 => 09:00:12.314566
[0m09:00:12.315568 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.319562 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:12.320565 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:12.322348 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:12.369659 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:10.974892 => 09:00:12.369659
[0m09:00:12.371658 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735F93D0>]}
[0m09:00:12.372669 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m09:00:12.374668 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:12.376574 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:12.377572 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m09:00:12.380564 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m09:00:12.382072 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:12.390092 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:12.392102 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:12.382072 => 09:00:12.391102
[0m09:00:12.393100 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:12.398183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:12.400088 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:12.402252 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:13.090747 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1964f3c8-dfc9-42e7-8e51-67d380a275e4&page=queryresults
[0m09:00:13.221786 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:33f57a20-a07b-4d65-9a3b-54af92e49f95&page=queryresults
[0m09:00:13.486417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:12.315568 => 09:00:13.486417
[0m09:00:13.487416 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735ABF10>]}
[0m09:00:13.488417 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m09:00:13.489417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:13.633329 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:12.393100 => 09:00:13.633329
[0m09:00:13.635330 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735F93D0>]}
[0m09:00:13.635330 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m09:00:13.637229 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:13.638534 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:13.638534 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m09:00:13.639666 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m09:00:13.640699 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:13.654139 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:13.656048 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:13.640699 => 09:00:13.655141
[0m09:00:13.656048 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:13.669545 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:14.616015 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:14.617019 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:15.354272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a474d895-ec3d-46a8-8b35-0c490cd4d39f&page=queryresults
[0m09:00:17.672603 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:13.657149 => 09:00:17.672603
[0m09:00:17.673608 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A74718B50>]}
[0m09:00:17.674613 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.03s]
[0m09:00:17.676605 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:17.677506 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:17.678507 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m09:00:17.679506 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m09:00:17.680614 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:17.685956 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:17.686843 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:17.680614 => 09:00:17.686843
[0m09:00:17.687848 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:17.690961 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:18.345257 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:18.347160 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m09:00:19.004621 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db9253e2-c30e-485a-99ef-4c007fa0fc91&page=queryresults
[0m09:00:21.213544 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:17.687848 => 09:00:21.212394
[0m09:00:21.214536 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A74718B50>]}
[0m09:00:21.215544 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.54s]
[0m09:00:21.216441 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:21.217439 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.218440 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m09:00:21.219441 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:21.219441 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.224438 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.226442 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:21.220440 => 09:00:21.225438
[0m09:00:21.226892 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.230012 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:21.861318 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.863322 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:22.515749 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:773074f4-763a-4bcf-bdb9-b495422d22dd&page=queryresults
[0m09:00:24.696477 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:21.226892 => 09:00:24.696477
[0m09:00:24.698477 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7475AB20>]}
[0m09:00:24.698477 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.48s]
[0m09:00:24.700570 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:24.703270 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:24.703270 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:24.704380 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:24.704380 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m09:00:24.706385 [info ] [MainThread]: 
[0m09:00:24.707433 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.82 seconds (16.82s).
[0m09:00:24.709623 [debug] [MainThread]: Command end result
[0m09:00:24.722553 [info ] [MainThread]: 
[0m09:00:24.723566 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:24.724566 [info ] [MainThread]: 
[0m09:00:24.725558 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m09:00:24.727763 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:24.726650 after 18.01 seconds
[0m09:00:24.728700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6FCA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73305850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7358DE20>]}
[0m09:00:24.728700 [debug] [MainThread]: Flushing usage events
[0m10:00:05.634347 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023108AB24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A372E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A37760>]}


============================== 10:00:05.644250 | f6086596-4fb4-467f-9d1c-0db0138b90d1 ==============================
[0m10:00:05.644250 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:05.644250 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m10:00:06.294307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A14130>]}
[0m10:00:06.362455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C1F2D30>]}
[0m10:00:06.363883 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:06.370098 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:06.416032 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:06.416032 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:06.420034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C3BAF10>]}
[0m10:00:06.428923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232220>]}
[0m10:00:06.429823 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:06.429823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232250>]}
[0m10:00:06.430824 [info ] [MainThread]: 
[0m10:00:06.431825 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:06.433902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.433902 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.434933 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.434933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.285326 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.986322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:07.987320 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:07.988421 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.989789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.855088 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:08.856084 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:09.507823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C174BE0>]}
[0m10:00:09.509889 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:09.510841 [info ] [MainThread]: 
[0m10:00:09.517919 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.518919 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.519920 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m10:00:09.521920 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m10:00:09.523295 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:09.525293 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:09.525293 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.526291 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.537421 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.543005 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.544945 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:09.527292 => 10:00:09.544945
[0m10:00:09.545948 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.546946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:09.538440 => 10:00:09.546946
[0m10:00:09.558941 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.609434 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.622149 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.623162 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:09.626207 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:09.674897 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:09.679036 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m10:00:10.565874 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc476d6f-4acf-482a-9f5e-69d84673cd35&page=queryresults
[0m10:00:10.593000 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d28e45de-45ff-476c-936b-8ded9c9402f2&page=queryresults
[0m10:00:11.026588 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:09.547996 => 10:00:11.025585
[0m10:00:11.027580 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C156400>]}
[0m10:00:11.028584 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m10:00:11.029585 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:11.029585 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.030588 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m10:00:11.031579 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:11.031579 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.034594 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.035590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:11.031579 => 10:00:11.035590
[0m10:00:11.035590 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.037600 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.038593 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.039457 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:11.233059 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:09.559973 => 10:00:11.233059
[0m10:00:11.234057 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C174BE0>]}
[0m10:00:11.235960 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.71s]
[0m10:00:11.238058 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:11.239058 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:11.240061 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m10:00:11.240960 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m10:00:11.242841 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:11.248858 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:11.249863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:11.242841 => 10:00:11.249863
[0m10:00:11.250862 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:11.254857 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:11.255861 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.258859 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:11.750202 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3ce70cd-5316-44ab-b508-0c746facb3f9&page=queryresults
[0m10:00:11.951670 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40f7cae9-55d3-4640-a7e4-d8a930e95160&page=queryresults
[0m10:00:12.222143 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:11.035590 => 10:00:12.222143
[0m10:00:12.223247 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232100>]}
[0m10:00:12.224244 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m10:00:12.226148 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:12.406812 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:11.250862 => 10:00:12.405810
[0m10:00:12.407812 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310D447D00>]}
[0m10:00:12.408811 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m10:00:12.409812 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:12.411124 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:12.411124 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m10:00:12.413249 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m10:00:12.413249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:12.419244 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:12.420247 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:12.414255 => 10:00:12.420247
[0m10:00:12.421715 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:12.448726 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:13.139965 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:13.142560 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:13.740822 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f5b28b9a-0f59-4e9d-a2e7-baa403cc5629&page=queryresults
[0m10:00:16.663744 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:12.421715 => 10:00:16.663744
[0m10:00:16.664742 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310D49FA30>]}
[0m10:00:16.665742 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.25s]
[0m10:00:16.666743 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:16.668644 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:16.668644 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m10:00:16.670657 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m10:00:16.670657 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:16.674681 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:16.676691 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:16.670657 => 10:00:16.676691
[0m10:00:16.678707 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:16.681647 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:17.316698 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:17.318699 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m10:00:17.997015 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0aa937fc-1bef-4c1d-b3a7-f6e092ea7eb2&page=queryresults
[0m10:00:20.010518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:16.678707 => 10:00:20.010518
[0m10:00:20.011517 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C462700>]}
[0m10:00:20.012517 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.34s]
[0m10:00:20.013424 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:20.014423 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.015423 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m10:00:20.016423 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:20.016423 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.022906 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:20.024911 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:20.016423 => 10:00:20.024006
[0m10:00:20.024911 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.029003 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:20.781562 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:20.783979 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:21.476599 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6476fb02-358b-4182-942b-4d7be1a0fe4d&page=queryresults
[0m10:00:23.725942 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:20.026003 => 10:00:23.723928
[0m10:00:23.725942 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C462670>]}
[0m10:00:23.728483 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.71s]
[0m10:00:23.729497 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:23.732497 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:23.732497 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:23.732497 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:23.733496 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:23.733496 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:23.734494 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m10:00:23.734494 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m10:00:23.735494 [info ] [MainThread]: 
[0m10:00:23.735494 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.30 seconds (17.30s).
[0m10:00:23.737494 [debug] [MainThread]: Command end result
[0m10:00:23.761121 [info ] [MainThread]: 
[0m10:00:23.761121 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:23.761121 [info ] [MainThread]: 
[0m10:00:23.761121 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m10:00:23.767770 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:23.767770 after 18.19 seconds
[0m10:00:23.768770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023108AB24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C1DF550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C0ACC70>]}
[0m10:00:23.769768 [debug] [MainThread]: Flushing usage events
[0m10:48:00.874012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239A7A5430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000223997206A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022399720DC0>]}


============================== 10:48:00.874012 | e9bb99f2-981c-47a5-8533-75263fcf8658 ==============================
[0m10:48:00.874012 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:48:00.878490 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_produto', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:48:01.446627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022399711940>]}
[0m10:48:01.511401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DE15790>]}
[0m10:48:01.511401 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:48:01.525639 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:48:01.596266 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:48:01.596266 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m10:48:01.811436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E134520>]}
[0m10:48:01.832933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DFFC7C0>]}
[0m10:48:01.832933 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:48:01.832933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DFFC760>]}
[0m10:48:01.832933 [info ] [MainThread]: 
[0m10:48:01.832933 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:48:01.838683 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:48:01.838683 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:02.621577 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:48:02.623453 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:02.623453 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:48:02.631459 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:03.311680 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:48:03.311680 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:48:04.021528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DDA9FD0>]}
[0m10:48:04.021528 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:48:04.021528 [info ] [MainThread]: 
[0m10:48:04.051704 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:48:04.056746 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m10:48:04.062833 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m10:48:04.063834 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:48:04.075448 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:48:04.076448 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:48:04.063834 => 10:48:04.076448
[0m10:48:04.076448 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:48:04.094042 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:48:04.781534 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:48:04.781534 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m10:48:05.631272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a9d5dda-6e3d-4154-aaa7-31b60e19985d&page=queryresults
[0m10:48:08.251584 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:48:04.078066 => 10:48:08.251584
[0m10:48:08.262716 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E21E3A0>]}
[0m10:48:08.263557 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 4.20s]
[0m10:48:08.263557 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:48:08.267747 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m10:48:08.267747 [info ] [MainThread]: 
[0m10:48:08.271467 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.43 seconds (6.43s).
[0m10:48:08.271467 [debug] [MainThread]: Command end result
[0m10:48:08.298059 [info ] [MainThread]: 
[0m10:48:08.301287 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:48:08.304464 [info ] [MainThread]: 
[0m10:48:08.305462 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:48:08.311338 [debug] [MainThread]: Command `dbt run` succeeded at 10:48:08.309825 after 7.50 seconds
[0m10:48:08.312468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239A7A5430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E278EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E0BDD30>]}
[0m10:48:08.313478 [debug] [MainThread]: Flushing usage events
[0m11:00:03.883857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EFC92400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEC138E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEC135E0>]}


============================== 11:00:03.883857 | dd1ec695-cd33-4a25-8388-07fc16734951 ==============================
[0m11:00:03.883857 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:03.883857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:04.518453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEBFF100>]}
[0m11:00:04.590018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F32F8790>]}
[0m11:00:04.592102 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:04.598478 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:04.663238 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:04.679423 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3598FA0>]}
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430B80>]}
[0m11:00:04.679423 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430280>]}
[0m11:00:04.695128 [info ] [MainThread]: 
[0m11:00:04.695128 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:04.695128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.695128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:04.695128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.695128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:05.495875 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:06.172027 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:06.173439 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.175124 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:06.175124 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.801129 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:06.801129 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:07.422443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F33367F0>]}
[0m11:00:07.423441 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:07.424439 [info ] [MainThread]: 
[0m11:00:07.431572 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.433218 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.434227 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m11:00:07.435943 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:07.435943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.443827 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:07.434736 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m11:00:07.444826 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:07.444826 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.447822 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:07.449927 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:07.445870 => 11:00:07.448921
[0m11:00:07.450544 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.456889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:07.436943 => 11:00:07.456889
[0m11:00:07.471257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.476064 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:07.481425 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:07.483427 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:07.484427 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:07.486403 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m11:00:07.509702 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:08.528773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96c04bdb-f321-4418-b130-c3d336894778&page=queryresults
[0m11:00:08.549825 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1162ea6f-4c47-4883-92db-4142500338fd&page=queryresults
[0m11:00:08.998665 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:07.476064 => 11:00:08.998665
[0m11:00:08.999225 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F33367F0>]}
[0m11:00:08.999225 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m11:00:09.000535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.001519 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.002460 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m11:00:09.002460 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:09.002460 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.005455 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.006799 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:09.003523 => 11:00:09.005455
[0m11:00:09.008808 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:07.451712 => 11:00:09.008808
[0m11:00:09.008808 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.010159 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430070>]}
[0m11:00:09.012150 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.013110 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m11:00:09.014108 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.014108 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:09.014579 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m11:00:09.014579 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:09.015802 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m11:00:09.015802 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:09.018933 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:09.021169 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:09.043082 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:09.015802 => 11:00:09.042135
[0m11:00:09.043082 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:09.045080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:09.047133 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:09.049071 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:09.715174 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7967f35c-095f-439d-8d9f-7741cb0c2b67&page=queryresults
[0m11:00:09.865929 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20b67da0-f053-4ad2-a9e9-0913b2f04c2d&page=queryresults
[0m11:00:10.136569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:09.010159 => 11:00:10.136569
[0m11:00:10.137569 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F35DD820>]}
[0m11:00:10.138847 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m11:00:10.139846 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:10.578600 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:09.043082 => 11:00:10.578600
[0m11:00:10.588063 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F359BCD0>]}
[0m11:00:10.589040 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m11:00:10.589040 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:10.589040 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:10.589040 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m11:00:10.589040 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m11:00:10.589040 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:10.600780 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:10.600780 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:10.589040 => 11:00:10.600780
[0m11:00:10.600780 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:10.608714 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:11.243355 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:11.244355 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:11.962027 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac212a7e-fcf9-4dea-8e91-2e84f06394ca&page=queryresults
[0m11:00:19.234187 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:10.600780 => 11:00:19.234187
[0m11:00:19.234187 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3641670>]}
[0m11:00:19.234187 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 8.65s]
[0m11:00:19.243011 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:19.243011 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:19.243011 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m11:00:19.243011 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m11:00:19.243011 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:19.243011 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:19.243011 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:19.243011 => 11:00:19.243011
[0m11:00:19.243011 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:19.259125 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:19.890859 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:19.890859 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m11:00:20.702254 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:74275b34-a50a-459e-a0b9-dc53c99ee9be&page=queryresults
[0m11:00:23.513948 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:19.243011 => 11:00:23.513948
[0m11:00:23.513948 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F4720790>]}
[0m11:00:23.526940 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 4.27s]
[0m11:00:23.526940 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:23.526940 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.526940 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m11:00:23.526940 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:23.526940 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.526940 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:23.526940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:23.526940 => 11:00:23.526940
[0m11:00:23.542831 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.546661 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:24.158376 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:24.158376 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:24.842994 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3865999a-3ad6-442a-8cc9-5e2641eea5f1&page=queryresults
[0m11:00:27.161735 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:23.542831 => 11:00:27.161735
[0m11:00:27.162251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F4720790>]}
[0m11:00:27.162946 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.64s]
[0m11:00:27.163704 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:27.168159 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m11:00:27.170533 [info ] [MainThread]: 
[0m11:00:27.171528 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 22.48 seconds (22.48s).
[0m11:00:27.173546 [debug] [MainThread]: Command end result
[0m11:00:27.180992 [info ] [MainThread]: 
[0m11:00:27.182199 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:27.182199 [info ] [MainThread]: 
[0m11:00:27.183205 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m11:00:27.184209 [debug] [MainThread]: Command `dbt run` succeeded at 11:00:27.184209 after 23.35 seconds
[0m11:00:27.184209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EFC92400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3313F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F34CD040>]}
[0m11:00:27.185229 [debug] [MainThread]: Flushing usage events
[0m12:00:13.868293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B4849430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0AC0>]}


============================== 12:00:13.875386 | 420b8252-6b45-49c3-b6c8-3892ffa7a703 ==============================
[0m12:00:13.875386 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:13.875386 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:00:14.667234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0850>]}
[0m12:00:14.737525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7EC2550>]}
[0m12:00:14.737525 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:14.770207 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:18.026675 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:18.026675 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:18.042912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8158BB0>]}
[0m12:00:18.074862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8145880>]}
[0m12:00:18.074862 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:18.090957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8145700>]}
[0m12:00:18.090957 [info ] [MainThread]: 
[0m12:00:18.090957 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:18.090957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:18.090957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:18.090957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:18.090957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:18.975927 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:19.641992 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:00:19.643937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:19.644454 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:19.646591 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:20.310213 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:20.310213 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:20.961399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F22EB0>]}
[0m12:00:20.963655 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:20.964705 [info ] [MainThread]: 
[0m12:00:20.972642 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:20.974362 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:20.975653 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m12:00:20.978751 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:20.979709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:20.977653 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m12:00:20.993979 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:20.994921 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:20.995912 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:20.999395 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:20.999395 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:20.979709 => 12:00:20.999395
[0m12:00:20.999395 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:21.027485 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:21.028225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:20.995912 => 12:00:21.028225
[0m12:00:21.028225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:21.028225 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:21.028225 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:21.037837 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m12:00:21.063562 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:21.066467 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:21.952395 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e033ae82-aba8-4a01-b305-c4cdedc77fdc&page=queryresults
[0m12:00:21.960134 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4fecc196-ebeb-4b2b-a868-201ed0553fc0&page=queryresults
[0m12:00:22.393993 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:20.999395 => 12:00:22.393993
[0m12:00:22.394957 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F22EB0>]}
[0m12:00:22.394957 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m12:00:22.396010 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:22.396901 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.396901 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m12:00:22.397903 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:22.397903 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.398901 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:22.398901 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:22.398901 => 12:00:22.398901
[0m12:00:22.398901 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.398901 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:22.398901 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:22.406569 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:22.430631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:21.028225 => 12:00:22.430631
[0m12:00:22.431520 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81EE3D0>]}
[0m12:00:22.431520 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m12:00:22.432519 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:22.432519 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:22.432519 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m12:00:22.434518 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m12:00:22.434518 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:22.437682 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:22.438467 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:22.434518 => 12:00:22.438467
[0m12:00:22.438467 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:22.441187 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:22.443194 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:22.443194 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:23.190169 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf3a7c9a-15cc-48ef-b0b3-52ab90e73551&page=queryresults
[0m12:00:23.208170 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72bdd97e-8a4e-453b-8da0-a76caf4f936b&page=queryresults
[0m12:00:23.586065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:22.398901 => 12:00:23.586065
[0m12:00:23.587090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B9293E50>]}
[0m12:00:23.587755 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m12:00:23.587755 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:23.641733 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:22.438467 => 12:00:23.641733
[0m12:00:23.642912 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81EE3D0>]}
[0m12:00:23.642912 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m12:00:23.644111 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:23.645157 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:23.645157 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m12:00:23.646153 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m12:00:23.646683 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:23.654490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:23.655485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:23.646683 => 12:00:23.655485
[0m12:00:23.656477 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:23.663820 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:24.296360 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:24.297212 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:24.996690 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7058f136-a05c-435d-99e7-d5cd8d209d75&page=queryresults
[0m12:00:28.104123 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:23.656477 => 12:00:28.104123
[0m12:00:28.105115 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81FD8B0>]}
[0m12:00:28.105910 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.46s]
[0m12:00:28.106617 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:28.107685 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:28.108694 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m12:00:28.109896 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:00:28.111026 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:28.115626 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:28.116507 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:28.111026 => 12:00:28.116507
[0m12:00:28.116507 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:28.119628 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:28.728187 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:28.730190 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m12:00:29.417783 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d8ebca36-31fd-4de8-a5c5-a8f6ff9671a6&page=queryresults
[0m12:00:31.965235 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:28.117634 => 12:00:31.965235
[0m12:00:31.965235 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B929BA60>]}
[0m12:00:31.965235 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 3.86s]
[0m12:00:31.965235 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:31.965235 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.965235 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m12:00:31.965235 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:31.965235 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.965235 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:31.965235 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:31.965235 => 12:00:31.965235
[0m12:00:31.981437 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.984277 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:32.650199 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:32.653142 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:33.262133 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:321714c2-fbfe-466f-a172-f4da9cf0c29d&page=queryresults
[0m12:00:35.259849 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:31.981437 => 12:00:35.259849
[0m12:00:35.261853 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B930DAC0>]}
[0m12:00:35.262849 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.30s]
[0m12:00:35.264849 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:35.268884 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:35.268884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:35.270908 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:35.270908 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:35.272928 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:00:35.272928 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:00:35.274947 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m12:00:35.274947 [info ] [MainThread]: 
[0m12:00:35.274947 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.18 seconds (17.18s).
[0m12:00:35.274947 [debug] [MainThread]: Command end result
[0m12:00:35.285044 [info ] [MainThread]: 
[0m12:00:35.285044 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:35.298033 [info ] [MainThread]: 
[0m12:00:35.298033 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m12:00:35.303727 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:35.302960 after 21.58 seconds
[0m12:00:35.303727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B4849430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7EC2550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F87FA0>]}
[0m12:00:35.303727 [debug] [MainThread]: Flushing usage events
[0m12:03:56.623849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8DF03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7D942E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7D94760>]}


============================== 12:03:56.627548 | 03de64f8-d280-4eae-9be7-1e2b3f0fd587 ==============================
[0m12:03:56.627548 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:03:56.629673 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_produto+', 'send_anonymous_usage_stats': 'True'}
[0m12:03:57.077329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FAF5BAF0>]}
[0m12:03:57.137221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FB75E4C0>]}
[0m12:03:57.137221 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:03:57.147271 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_produto.sql
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m12:03:57.347201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC888970>]}
[0m12:03:57.357309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC66E7F0>]}
[0m12:03:57.357309 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:03:57.357309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC66E790>]}
[0m12:03:57.367073 [info ] [MainThread]: 
[0m12:03:57.367073 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:03:57.367073 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:03:57.367073 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:57.367073 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:03:57.367073 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:58.231968 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:03:58.926470 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:03:58.927470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:58.957867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:03:58.959339 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:59.584527 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:03:59.586523 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:04:00.242138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC89A550>]}
[0m12:04:00.244044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:04:00.244793 [info ] [MainThread]: 
[0m12:04:00.248964 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m12:04:00.248964 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m12:04:00.248964 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m12:04:00.256729 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:04:00.265757 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:04:00.266740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:04:00.256729 => 12:04:00.266740
[0m12:04:00.266740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:04:00.289985 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:04:00.289985 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:04:00.289985 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:04:01.125252 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b423b073-23f9-471c-9322-a6d298ab6add&page=queryresults
[0m12:04:01.582879 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:04:00.267756 => 12:04:01.582879
[0m12:04:01.582879 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FD937FD0>]}
[0m12:04:01.584069 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m12:04:01.584069 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:04:01.585119 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m12:04:01.585119 [info ] [Thread-2  ]: 2 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m12:04:01.586965 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m12:04:01.586965 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:04:01.590038 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:04:01.590738 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:04:01.586965 => 12:04:01.590738
[0m12:04:01.590738 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:04:01.599623 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:04:02.225702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:04:02.225702 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:04:03.007608 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:388d6bac-1654-4394-ae58-3955c07b22ed&page=queryresults
[0m12:04:05.629170 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:04:01.590738 => 12:04:05.629170
[0m12:04:05.629170 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC890D60>]}
[0m12:04:05.629170 [info ] [Thread-2  ]: 2 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.04s]
[0m12:04:05.629170 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:04:05.629170 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m12:04:05.629170 [info ] [Thread-1  ]: 3 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m12:04:05.629170 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:04:05.629170 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:04:05.651270 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:04:05.654505 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:04:05.629170 => 12:04:05.653262
[0m12:04:05.656522 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:04:05.662524 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:04:06.268953 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:04:06.268953 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m12:04:06.887920 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c70fe92-e195-4640-a822-0c9051ae5d71&page=queryresults
[0m12:04:09.448656 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:04:05.658532 => 12:04:09.448656
[0m12:04:09.448656 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FD8E8AC0>]}
[0m12:04:09.461010 [info ] [Thread-1  ]: 3 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.82s]
[0m12:04:09.461010 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:04:09.464169 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.464169 [info ] [Thread-2  ]: 4 of 4 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m12:04:09.464169 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:04:09.468602 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.474309 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:04:09.475708 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:04:09.468602 => 12:04:09.475708
[0m12:04:09.478089 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.484531 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:04:10.354963 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:04:10.356117 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:04:10.982093 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:54a82f4d-a93e-4d46-a20b-247537e2251d&page=queryresults
[0m12:04:13.262969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:04:09.479250 => 12:04:13.262969
[0m12:04:13.264986 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC8C8760>]}
[0m12:04:13.267003 [info ] [Thread-2  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.80s]
[0m12:04:13.267003 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:04:13.267003 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:04:13.267003 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:04:13.267003 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:04:13.274819 [info ] [MainThread]: 
[0m12:04:13.274819 [info ] [MainThread]: Finished running 1 view model, 3 table models in 0 hours 0 minutes and 15.91 seconds (15.91s).
[0m12:04:13.282308 [debug] [MainThread]: Command end result
[0m12:04:13.340762 [info ] [MainThread]: 
[0m12:04:13.342174 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:04:13.344355 [info ] [MainThread]: 
[0m12:04:13.346577 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m12:04:13.352025 [debug] [MainThread]: Command `dbt run` succeeded at 12:04:13.351030 after 16.79 seconds
[0m12:04:13.354074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8DF03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC54B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC72BE80>]}
[0m12:04:13.355078 [debug] [MainThread]: Flushing usage events
[0m13:00:16.401161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964BAF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964AA6C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964AA6CD30>]}


============================== 13:00:16.416901 | 3b1a7040-2923-45d9-a2cc-da3972883190 ==============================
[0m13:00:16.416901 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:16.416901 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:17.737462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964DC3DAC0>]}
[0m13:00:17.848612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1616D0>]}
[0m13:00:17.854916 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:17.897785 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:21.294909 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:21.294909 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:21.294909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3F8B80>]}
[0m13:00:21.354898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3E67F0>]}
[0m13:00:21.354898 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:21.354898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3E6790>]}
[0m13:00:21.354898 [info ] [MainThread]: 
[0m13:00:21.354898 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:21.370756 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:21.370756 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:21.370756 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:21.370756 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:22.315392 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:23.018603 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:00:23.018603 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:23.018603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:23.018603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:23.686958 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:00:23.702688 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:24.358956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F476EE0>]}
[0m13:00:24.358956 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:24.358956 [info ] [MainThread]: 
[0m13:00:24.358956 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.358956 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.358956 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m13:00:24.374957 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:24.374957 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m13:00:24.374957 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.374957 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:24.391039 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:24.391039 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.391039 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:24.391039 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:24.374957 => 13:00:24.391039
[0m13:00:24.406900 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.406900 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:24.391039 => 13:00:24.406900
[0m13:00:24.454746 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.454746 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:24.470834 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:24.470834 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:24.470834 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m13:00:24.502370 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:24.518099 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:25.367941 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fc9ee004-71fb-4b5b-b2ff-0ae234dc32bb&page=queryresults
[0m13:00:25.383826 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19790341-a715-4281-986f-f2cd427470f9&page=queryresults
[0m13:00:25.847008 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:24.406900 => 13:00:25.847008
[0m13:00:25.862939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:24.454746 => 13:00:25.862939
[0m13:00:25.862939 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F0E5B80>]}
[0m13:00:25.862939 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F47ED00>]}
[0m13:00:25.862939 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m13:00:25.862939 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:25.862939 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m13:00:25.862939 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:25.862939 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m13:00:25.862939 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:25.862939 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m13:00:25.862939 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m13:00:25.862939 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:25.862939 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:25.878646 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:25.862939 => 13:00:25.878646
[0m13:00:25.862939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:25.862939 => 13:00:25.862939
[0m13:00:25.878646 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.878646 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:25.878646 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:25.884518 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:25.884518 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:25.884518 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:25.884518 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:25.910887 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:26.716177 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c52a665-010d-409c-80df-86a4771a9edc&page=queryresults
[0m13:00:26.893376 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71abef9e-3a2b-48d5-87fc-c2e006435bcb&page=queryresults
[0m13:00:27.173478 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:25.882508 => 13:00:27.171461
[0m13:00:27.173478 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A1760>]}
[0m13:00:27.175489 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m13:00:27.177504 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:27.177504 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:27.180325 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m13:00:27.181342 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m13:00:27.183360 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:27.199279 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:27.208198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:27.183360 => 13:00:27.208198
[0m13:00:27.208198 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:27.235351 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:27.310611 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:25.878646 => 13:00:27.310611
[0m13:00:27.312629 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F48B2E0>]}
[0m13:00:27.312629 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m13:00:27.312629 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:27.964305 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:27.964305 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:28.655449 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43112fa6-1a6e-4610-b4e6-1b679528aa9c&page=queryresults
[0m13:00:31.171559 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:27.208198 => 13:00:31.171559
[0m13:00:31.173073 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A16A0>]}
[0m13:00:31.175086 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.99s]
[0m13:00:31.175086 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:31.177974 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:31.177974 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m13:00:31.177974 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m13:00:31.177974 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:31.177974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:31.188989 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:31.177974 => 13:00:31.188989
[0m13:00:31.188989 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:31.193333 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:31.875183 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:31.875183 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m13:00:32.565499 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:534aeedc-7aee-4af9-a921-b752ccea7cf8&page=queryresults
[0m13:00:35.150754 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:31.188989 => 13:00:35.150754
[0m13:00:35.152755 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A1670>]}
[0m13:00:35.153758 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.97s]
[0m13:00:35.155683 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:35.157964 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.158955 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m13:00:35.160961 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:35.161952 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.165729 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:35.167827 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:35.161952 => 13:00:35.166828
[0m13:00:35.167827 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.169827 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:35.785461 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:35.786656 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:36.426733 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4cf85e6d-3281-45fa-a0fc-2b575f5e2aa7&page=queryresults
[0m13:00:38.746595 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:35.167827 => 13:00:38.746595
[0m13:00:38.746595 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019650600F10>]}
[0m13:00:38.746595 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.59s]
[0m13:00:38.746595 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:38.746595 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m13:00:38.746595 [info ] [MainThread]: 
[0m13:00:38.755467 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.39 seconds (17.39s).
[0m13:00:38.756635 [debug] [MainThread]: Command end result
[0m13:00:38.766761 [info ] [MainThread]: 
[0m13:00:38.766761 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:00:38.775737 [info ] [MainThread]: 
[0m13:00:38.777092 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m13:00:38.780522 [debug] [MainThread]: Command `dbt run` succeeded at 13:00:38.780003 after 22.56 seconds
[0m13:00:38.780522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964BAF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1EB430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1CDCA0>]}
[0m13:00:38.780522 [debug] [MainThread]: Flushing usage events
[0m14:00:05.384795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244C043460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFBB730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFBBE50>]}


============================== 14:00:05.400738 | 16ee36eb-9aec-4cef-aa9e-be4b53bdf21c ==============================
[0m14:00:05.400738 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:05.402753 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:06.208894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFAE340>]}
[0m14:00:06.288127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F6B0AC0>]}
[0m14:00:06.288127 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:06.288127 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:06.336006 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:06.336006 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:06.336006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F948F40>]}
[0m14:00:06.357573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F93E190>]}
[0m14:00:06.357573 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:06.357573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F93ED90>]}
[0m14:00:06.357573 [info ] [MainThread]: 
[0m14:00:06.357573 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:06.357573 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.357573 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.357573 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:06.357573 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.210420 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:07.877413 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:07.877413 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.893297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:00:07.893297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:08.542896 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m14:00:08.542896 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:09.197322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F600F70>]}
[0m14:00:09.203052 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:09.203052 [info ] [MainThread]: 
[0m14:00:09.213064 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.213064 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.213064 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m14:00:09.213064 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:09.213064 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m14:00:09.213064 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.213064 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:09.228875 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.244776 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.244776 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.244776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:09.213064 => 14:00:09.244776
[0m14:00:09.244776 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.276812 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.276812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:09.244776 => 14:00:09.276812
[0m14:00:09.276812 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.276812 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:09.276812 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.292996 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:09.292996 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:09.324776 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m14:00:10.408722 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7919a253-651f-4282-ad93-2f1339151a0f&page=queryresults
[0m14:00:10.408722 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dae71698-02ff-4843-af76-79004a184bdf&page=queryresults
[0m14:00:10.855830 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:09.244776 => 14:00:10.855830
[0m14:00:10.855830 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F600F70>]}
[0m14:00:10.855830 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m14:00:10.855830 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:10.855830 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.855830 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:09.276812 => 14:00:10.855830
[0m14:00:10.871590 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F9DB190>]}
[0m14:00:10.855830 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m14:00:10.871590 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:10.871590 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.871590 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:10.871590 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m14:00:10.871590 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:10.871590 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:10.871590 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m14:00:10.871590 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:10.871590 => 14:00:10.871590
[0m14:00:10.871590 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m14:00:10.871590 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.871590 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:10.871590 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:10.887766 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:10.887766 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:10.887766 => 14:00:10.887766
[0m14:00:10.887766 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:10.887766 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:10.887766 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:10.887766 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:10.919870 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:10.919870 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:11.639027 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16330f00-183f-424b-8dce-3870d8f866fe&page=queryresults
[0m14:00:11.672792 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f196700-379f-4309-bb01-883d5531993f&page=queryresults
[0m14:00:12.055393 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:10.871590 => 14:00:12.055393
[0m14:00:12.055393 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224509F15E0>]}
[0m14:00:12.055393 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:12.055393 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.069961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:10.887766 => 14:00:12.069961
[0m14:00:12.069961 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450A52040>]}
[0m14:00:12.086048 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m14:00:12.086048 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:12.086048 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:12.086048 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m14:00:12.086048 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m14:00:12.086048 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:12.102044 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:12.118019 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:12.086048 => 14:00:12.118019
[0m14:00:12.118019 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:12.118019 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:12.786015 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:12.801794 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:13.503792 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f99fa70-29be-406a-9be4-877964065d7a&page=queryresults
[0m14:00:17.265985 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:12.118019 => 14:00:17.265985
[0m14:00:17.268003 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450AA9790>]}
[0m14:00:17.268003 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 5.18s]
[0m14:00:17.269758 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:17.269758 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:17.269758 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m14:00:17.269758 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m14:00:17.276314 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:17.280337 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:17.282346 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:17.276314 => 14:00:17.280337
[0m14:00:17.282346 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:17.284356 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:17.906842 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:17.922596 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m14:00:18.576719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:670ba73d-d772-411c-a80d-8a07705b56ba&page=queryresults
[0m14:00:20.835021 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:17.282346 => 14:00:20.835021
[0m14:00:20.835021 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F9EF550>]}
[0m14:00:20.835021 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.57s]
[0m14:00:20.835021 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:20.850960 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.850960 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m14:00:20.850960 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:20.856509 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.864582 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:20.866590 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:20.856509 => 14:00:20.864582
[0m14:00:20.866590 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.868601 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:21.568312 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:21.568312 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:22.197553 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4848afb2-870d-4f93-a95b-cbab9794812d&page=queryresults
[0m14:00:24.432497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:20.866590 => 14:00:24.429462
[0m14:00:24.432497 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450AFC3A0>]}
[0m14:00:24.434509 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.58s]
[0m14:00:24.436517 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:24.436517 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m14:00:24.442572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:24.442572 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m14:00:24.444596 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m14:00:24.444596 [info ] [MainThread]: 
[0m14:00:24.444596 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.09 seconds (18.09s).
[0m14:00:24.448641 [debug] [MainThread]: Command end result
[0m14:00:24.460791 [info ] [MainThread]: 
[0m14:00:24.460791 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:24.460791 [info ] [MainThread]: 
[0m14:00:24.460791 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m14:00:24.460791 [debug] [MainThread]: Command `dbt run` succeeded at 14:00:24.460791 after 19.14 seconds
[0m14:00:24.460791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244C043460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F92EF70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F5D0040>]}
[0m14:00:24.460791 [debug] [MainThread]: Flushing usage events
[0m15:00:04.591443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAAA02400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA9985910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA9985B80>]}


============================== 15:00:04.607547 | a134a497-19c4-48ab-a40a-44b1b6561f62 ==============================
[0m15:00:04.607547 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:04.607547 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:00:05.417028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA99887C0>]}
[0m15:00:05.472124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADF43B80>]}
[0m15:00:05.474130 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:05.474130 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:05.533434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:05.533434 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:05.537188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE308EB0>]}
[0m15:00:05.545210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE2FE0A0>]}
[0m15:00:05.545210 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:05.545210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE2FE0D0>]}
[0m15:00:05.545210 [info ] [MainThread]: 
[0m15:00:05.545210 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:05.551106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.551106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.551106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:05.551106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.348173 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.024787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:07.024787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:07.024787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.024787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.658484 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:07.660502 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.451527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCEBE0>]}
[0m15:00:08.451527 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:08.451527 [info ] [MainThread]: 
[0m15:00:08.451527 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.467267 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m15:00:08.467267 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:08.467267 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m15:00:08.467267 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:08.467267 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.467267 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.467267 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:08.467267 => 15:00:08.467267
[0m15:00:08.482993 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:08.467267 => 15:00:08.482993
[0m15:00:08.482993 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.482993 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.498794 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.498794 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.498794 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:08.498794 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m15:00:08.530718 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:08.530718 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:09.475882 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2156e149-7325-4fe0-a037-b880ea8fb2e6&page=queryresults
[0m15:00:09.493780 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b2937dd0-db1b-45f5-b20b-479fcfaaab9d&page=queryresults
[0m15:00:09.940313 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:08.482993 => 15:00:09.940313
[0m15:00:09.940313 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCEBE0>]}
[0m15:00:09.956221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:08.498794 => 15:00:09.956221
[0m15:00:09.956221 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m15:00:09.956221 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE39C7C0>]}
[0m15:00:09.956221 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m15:00:09.956221 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.956221 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m15:00:09.956221 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:09.956221 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m15:00:09.956221 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.956221 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m15:00:09.956221 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:09.956221 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:09.956221 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:09.956221 => 15:00:09.956221
[0m15:00:09.956221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.972247 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:09.956221 => 15:00:09.972247
[0m15:00:09.972247 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:09.972247 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:09.972247 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:09.972247 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:09.972247 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:09.988296 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:10.728935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0220cc8e-7593-43a3-8820-1c119b677761&page=queryresults
[0m15:00:10.777637 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0428e925-ab56-4fe9-bba8-63fd9700a281&page=queryresults
[0m15:00:11.163325 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:09.956221 => 15:00:11.163325
[0m15:00:11.163325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE0A4940>]}
[0m15:00:11.163325 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:11.163325 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.221942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:09.972247 => 15:00:11.221942
[0m15:00:11.221942 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAF397910>]}
[0m15:00:11.221942 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m15:00:11.221942 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:11.221942 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:11.221942 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m15:00:11.221942 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m15:00:11.237938 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:11.237938 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:11.237938 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:11.237938 => 15:00:11.237938
[0m15:00:11.254040 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:11.269732 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:11.910247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:11.910247 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:12.544741 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eba82d4f-035e-4f25-b946-50b8505a4e5e&page=queryresults
[0m15:00:15.368113 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:11.254040 => 15:00:15.368113
[0m15:00:15.368113 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE3ABA30>]}
[0m15:00:15.368113 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.15s]
[0m15:00:15.368113 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m15:00:15.368113 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m15:00:15.368113 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:15.368113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:15.368113 => 15:00:15.368113
[0m15:00:15.368113 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:16.035426 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:16.037436 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m15:00:16.649284 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f357ffc-454f-494d-a9c3-f1f03180689f&page=queryresults
[0m15:00:18.941624 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:15.368113 => 15:00:18.941624
[0m15:00:18.943638 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE3ABA60>]}
[0m15:00:18.943638 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.57s]
[0m15:00:18.945651 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:18.945651 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.947406 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m15:00:18.947406 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:18.949419 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.953444 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:18.959473 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:18.949419 => 15:00:18.959473
[0m15:00:18.960892 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.962906 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:19.640329 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:19.640329 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:20.224855 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f4dfe7ec-e383-43ec-b483-6f8f557f013f&page=queryresults
[0m15:00:22.393947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:18.960892 => 15:00:22.393947
[0m15:00:22.399976 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAF3B1820>]}
[0m15:00:22.399976 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.45s]
[0m15:00:22.401988 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:22.401988 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:22.401988 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m15:00:22.407609 [info ] [MainThread]: 
[0m15:00:22.407609 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.86 seconds (16.86s).
[0m15:00:22.409621 [debug] [MainThread]: Command end result
[0m15:00:22.421484 [info ] [MainThread]: 
[0m15:00:22.421484 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:22.421484 [info ] [MainThread]: 
[0m15:00:22.421484 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m15:00:22.421484 [debug] [MainThread]: Command `dbt run` succeeded at 15:00:22.421484 after 17.88 seconds
[0m15:00:22.421484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAAA02400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCE340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE009070>]}
[0m15:00:22.421484 [debug] [MainThread]: Flushing usage events
[0m16:00:04.188096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F7603430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583AC0>]}


============================== 16:00:04.197547 | 624326b4-24cc-46fe-8fbe-685e00cb93a1 ==============================
[0m16:00:04.197547 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:04.199377 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:04.823314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583850>]}
[0m16:00:04.882669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAC6B460>]}
[0m16:00:04.883490 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:04.888985 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:04.936067 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:04.936067 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:04.936067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAF08940>]}
[0m16:00:04.952012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAD88610>]}
[0m16:00:04.952012 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:04.952012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAD88490>]}
[0m16:00:04.952012 [info ] [MainThread]: 
[0m16:00:04.952012 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:04.952012 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.952012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:04.970651 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.970651 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:05.870733 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:06.627078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:06.627078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.627078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:06.627078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.370795 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:07.370795 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:08.198706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACA1880>]}
[0m16:00:08.198706 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:08.198706 [info ] [MainThread]: 
[0m16:00:08.207070 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.207070 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.207070 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m16:00:08.207070 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:08.214425 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.207070 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:00:08.216964 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.226903 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:08.226903 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.230163 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.230163 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:08.214425 => 16:00:08.230163
[0m16:00:08.230163 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.257083 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.261326 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:08.226903 => 16:00:08.257083
[0m16:00:08.261326 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.261326 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:08.267111 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.267111 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m16:00:08.286963 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:08.286963 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:09.136870 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e711f931-71f7-4d8b-8ea6-72516bc7caee&page=queryresults
[0m16:00:09.151972 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02de3d65-11b8-4948-b403-6a7aac8b3c2b&page=queryresults
[0m16:00:09.580860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:08.230163 => 16:00:09.580860
[0m16:00:09.581849 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACFA7C0>]}
[0m16:00:09.583854 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:08.261326 => 16:00:09.583854
[0m16:00:09.581849 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m16:00:09.584859 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACA1880>]}
[0m16:00:09.584859 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.585850 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.584859 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m16:00:09.587119 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.586796 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m16:00:09.587119 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:09.588187 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:09.588187 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.588187 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m16:00:09.591180 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.591180 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m16:00:09.592187 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:09.594180 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:09.595126 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:09.589180 => 16:00:09.594180
[0m16:00:09.595126 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.597700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.598904 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:09.592187 => 16:00:09.598904
[0m16:00:09.598904 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:09.601237 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:09.602179 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:09.603546 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:09.630991 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:09.633968 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:10.337601 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5604f0fe-1edd-4ee3-9f12-8fafc3165f24&page=queryresults
[0m16:00:10.487279 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b791504f-753a-4d8a-afb6-9803e95c047a&page=queryresults
[0m16:00:10.747005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:09.595126 => 16:00:10.747005
[0m16:00:10.747005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FBFACCD0>]}
[0m16:00:10.747005 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m16:00:10.747005 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.926716 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:09.598904 => 16:00:10.926716
[0m16:00:10.926716 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FBF9F730>]}
[0m16:00:10.931880 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m16:00:10.931880 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:10.931880 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:10.931880 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:00:10.936982 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m16:00:10.936982 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:10.946843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:10.946843 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:10.938092 => 16:00:10.946843
[0m16:00:10.946843 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:10.957054 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:11.886987 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:11.891827 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:12.517355 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed0ce6a8-a610-4db8-a22b-91653b0f43b5&page=queryresults
[0m16:00:15.067042 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:10.946843 => 16:00:15.067042
[0m16:00:15.067042 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAFAFBE0>]}
[0m16:00:15.067042 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.14s]
[0m16:00:15.067042 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:15.067042 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:15.073147 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m16:00:15.073147 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m16:00:15.075933 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:15.079095 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:15.081106 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:15.075933 => 16:00:15.081106
[0m16:00:15.081106 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:15.083116 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:16.017239 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:16.023294 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m16:00:16.620030 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32887400-4f2c-4cf9-a4b9-33603fb7f5b3&page=queryresults
[0m16:00:19.389470 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:15.081106 => 16:00:19.387456
[0m16:00:19.389470 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAFAFFD0>]}
[0m16:00:19.391481 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 4.32s]
[0m16:00:19.391481 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:19.393491 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.393491 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m16:00:19.393491 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:19.395503 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.399526 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:19.406564 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:19.395503 => 16:00:19.404553
[0m16:00:19.406564 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.408576 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:20.303805 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:20.306838 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:20.875004 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:65268a8a-8c52-4441-9f81-bc40d18d462c&page=queryresults
[0m16:00:23.141003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:19.406564 => 16:00:23.138984
[0m16:00:23.141003 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FC0BED30>]}
[0m16:00:23.143020 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.75s]
[0m16:00:23.144034 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.144034 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m16:00:23.149077 [info ] [MainThread]: 
[0m16:00:23.149077 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.20 seconds (18.20s).
[0m16:00:23.149077 [debug] [MainThread]: Command end result
[0m16:00:23.172318 [info ] [MainThread]: 
[0m16:00:23.173557 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:23.175579 [info ] [MainThread]: 
[0m16:00:23.175579 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m16:00:23.177608 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:23.177608 after 19.08 seconds
[0m16:00:23.179627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F7603430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAC89FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FABF4B20>]}
[0m16:00:23.179627 [debug] [MainThread]: Flushing usage events
[0m17:00:04.233165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5ECB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33AC0>]}


============================== 17:00:04.237706 | 0b6fe523-86b8-4238-b507-746dbcbd5530 ==============================
[0m17:00:04.237706 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:04.237706 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:00:04.848930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB621EEEE0>]}
[0m17:00:04.921663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB622144C0>]}
[0m17:00:04.923191 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:04.929839 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:04.998060 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:04.999568 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:05.129919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB62664E80>]}
[0m17:00:05.142160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625A92B0>]}
[0m17:00:05.143745 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:05.145796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625A9130>]}
[0m17:00:05.149800 [info ] [MainThread]: 
[0m17:00:05.150805 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:05.153368 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.153368 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:05.155442 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.156436 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.180468 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:06.887761 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:06.889817 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.943656 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:06.945867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.644855 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:07.649547 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.353343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6236A280>]}
[0m17:00:08.356037 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.358508 [info ] [MainThread]: 
[0m17:00:08.372173 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.373691 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.376812 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m17:00:08.388463 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:00:08.397816 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.395756 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:00:08.433306 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.437151 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.439140 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.449225 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.451252 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:00:08.398810 => 17:00:08.450250
[0m17:00:08.453263 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.489466 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.490493 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.441201 => 17:00:08.490493
[0m17:00:08.491470 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.492989 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.494577 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.495606 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.499608 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m17:00:08.533297 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:09.721589 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0798acc-a942-4d7f-b1e6-aacde15e9cf5&page=queryresults
[0m17:00:09.736500 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d763c27-d4f3-4a7f-820a-dc9db64f4b44&page=queryresults
[0m17:00:10.180516 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.491470 => 17:00:10.179515
[0m17:00:10.180516 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB623401F0>]}
[0m17:00:10.181516 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.75s]
[0m17:00:10.183041 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.183041 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.183041 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m17:00:10.184662 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:00:10.185710 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.189706 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.191695 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:00:08.454224 => 17:00:10.191695
[0m17:00:10.193209 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6273C9A0>]}
[0m17:00:10.193209 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.81s]
[0m17:00:10.194875 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:10.194875 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:10.195900 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:00:10.197895 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:00:10.185710 => 17:00:10.196893
[0m17:00:10.198902 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m17:00:10.198902 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.199905 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:10.206454 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.215003 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:10.219552 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:10.207454 => 17:00:10.218554
[0m17:00:10.221548 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.223066 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:10.228264 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:00:10.232271 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:10.261015 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:10.263531 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:11.023286 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:94fea64d-1a2b-45d4-b459-f1f019f0622f&page=queryresults
[0m17:00:11.028908 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98521dc3-f27c-4f3b-a92d-206ab6576098&page=queryresults
[0m17:00:11.423127 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:00:10.199905 => 17:00:11.421608
[0m17:00:11.424767 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33700>]}
[0m17:00:11.425781 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:11.427794 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:00:11.433370 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:10.229273 => 17:00:11.433370
[0m17:00:11.433370 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6277D4F0>]}
[0m17:00:11.435132 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:11.436142 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:11.437145 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:11.439432 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:00:11.442453 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m17:00:11.443454 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:11.448938 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:11.449957 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:11.443454 => 17:00:11.449957
[0m17:00:11.450940 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:11.458703 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:12.148667 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:12.149659 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:12.955623 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a718562c-2bd7-412c-afdf-3346d4631374&page=queryresults
[0m17:00:16.130286 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:11.450940 => 17:00:16.128800
[0m17:00:16.133469 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB63788130>]}
[0m17:00:16.136017 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.69s]
[0m17:00:16.140085 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:16.143612 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:16.145687 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:16.148683 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m17:00:16.150498 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:16.162060 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:16.163062 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:16.150498 => 17:00:16.162060
[0m17:00:16.163582 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:16.165666 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:16.800174 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:16.802193 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

  select *
    from cte_join_campos_customizados
order by nm_produto_completo
    );
  
[0m17:00:17.481644 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f4302c0-b2a3-46a8-9eff-700b59e98608&page=queryresults
[0m17:00:20.040294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:16.163582 => 17:00:20.038658
[0m17:00:20.041169 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB63784BE0>]}
[0m17:00:20.043261 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.89s]
[0m17:00:20.044792 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:20.045791 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.045791 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m17:00:20.047811 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:00:20.048794 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.055044 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:20.056056 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:00:20.049788 => 17:00:20.056056
[0m17:00:20.057057 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.060052 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:21.073303 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:21.076051 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:00:21.642186 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fafbf092-6512-452e-80e4-7f27166911ad&page=queryresults
[0m17:00:24.230741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:00:20.057057 => 17:00:24.229697
[0m17:00:24.233286 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB637BC6A0>]}
[0m17:00:24.235950 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.19s]
[0m17:00:24.238951 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.245102 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:24.247055 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:24.248049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:24.250064 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:24.251054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:24.252054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:24.253050 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m17:00:24.253567 [info ] [MainThread]: 
[0m17:00:24.255650 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 19.10 seconds (19.10s).
[0m17:00:24.257606 [debug] [MainThread]: Command end result
[0m17:00:24.277810 [info ] [MainThread]: 
[0m17:00:24.278854 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:24.279936 [info ] [MainThread]: 
[0m17:00:24.280808 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m17:00:24.281793 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:24.281793 after 20.11 seconds
[0m17:00:24.281793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5ECB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB623E0370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625C5B50>]}
[0m17:00:24.281793 [debug] [MainThread]: Flushing usage events
[0m18:18:07.107199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EFE6E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EFD6892E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EFD689760>]}


============================== 18:18:07.107199 | 18090f26-6a9a-4080-a859-035d0da73ab0 ==============================
[0m18:18:07.107199 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:18:07.107199 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:18:07.589693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E81D77370>]}
[0m18:18:07.646848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E81C7B8E0>]}
[0m18:18:07.656170 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:18:07.656170 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:18:07.733507 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:18:07.733507 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m18:18:07.843780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E820D7A60>]}
[0m18:18:07.853812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E81F6BF70>]}
[0m18:18:07.853812 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:18:07.853812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E81CE33A0>]}
[0m18:18:07.853812 [info ] [MainThread]: 
[0m18:18:07.857888 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:18:07.857888 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:18:07.857888 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:18:08.627076 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:18:08.627076 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:18:08.666042 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:18:08.666042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:18:09.507508 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:18:09.507508 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:18:10.148674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E821CAEE0>]}
[0m18:18:10.148674 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:18:10.148674 [info ] [MainThread]: 
[0m18:18:10.166273 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:18:10.170219 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m18:18:10.170219 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m18:18:10.176431 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m18:18:10.190719 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:18:10.190719 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 18:18:10.177430 => 18:18:10.190719
[0m18:18:10.192726 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m18:18:10.209928 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:18:10.216697 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:18:10.216697 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m18:18:10.965696 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:005e02b4-bf51-4f08-a74f-52ce152a2312&page=queryresults
[0m18:18:11.385649 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 18:18:10.192726 => 18:18:11.377391
[0m18:18:11.386665 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18090f26-6a9a-4080-a859-035d0da73ab0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E821F6B20>]}
[0m18:18:11.387267 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m18:18:11.387267 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:18:11.387267 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:18:11.387267 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:18:11.387267 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:18:11.387267 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:18:11.387267 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m18:18:11.387267 [info ] [MainThread]: 
[0m18:18:11.387267 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.53 seconds (3.53s).
[0m18:18:11.387267 [debug] [MainThread]: Command end result
[0m18:18:11.399671 [info ] [MainThread]: 
[0m18:18:11.401317 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:18:11.401317 [info ] [MainThread]: 
[0m18:18:11.401317 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:18:11.401317 [debug] [MainThread]: Command `dbt run` succeeded at 18:18:11.401317 after 4.36 seconds
[0m18:18:11.401317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EFE6E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E8200FF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E81CE33A0>]}
[0m18:18:11.401317 [debug] [MainThread]: Flushing usage events
[0m18:19:02.264152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C92826430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C917A36A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C917A3DC0>]}


============================== 18:19:02.268173 | bfa5318a-ed57-4297-b3a3-846b64a83d60 ==============================
[0m18:19:02.268173 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:19:02.270002 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_produto', 'send_anonymous_usage_stats': 'True'}
[0m18:19:02.673239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C91797070>]}
[0m18:19:02.720323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C95E90850>]}
[0m18:19:02.720323 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:19:02.739132 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:19:02.816058 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:19:02.816058 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m18:19:02.916013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C961CC6A0>]}
[0m18:19:02.926122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C95FD3A60>]}
[0m18:19:02.926122 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:19:02.926122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C95FD3970>]}
[0m18:19:02.926122 [info ] [MainThread]: 
[0m18:19:02.926122 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:19:02.926122 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:19:02.926122 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:03.621687 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:19:03.621687 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:03.621687 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:19:03.621687 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:04.632728 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:19:04.632728 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:19:05.276451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C95DE64F0>]}
[0m18:19:05.276451 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:19:05.276451 [info ] [MainThread]: 
[0m18:19:05.285722 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m18:19:05.285722 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m18:19:05.285722 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m18:19:05.285722 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:19:05.300446 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:19:05.302371 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:19:05.285722 => 18:19:05.302371
[0m18:19:05.303464 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:19:05.315649 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:19:05.926164 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:19:05.926164 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

  select *
    from cte_join_campos_customizados
order by nm_produto_completo
    );
  
[0m18:19:06.656620 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d959dc3f-dc4b-4e5a-8c15-e9b7295e7776&page=queryresults
[0m18:19:09.246443 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:19:05.303464 => 18:19:09.245336
[0m18:19:09.246443 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bfa5318a-ed57-4297-b3a3-846b64a83d60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C9629DDC0>]}
[0m18:19:09.247444 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.96s]
[0m18:19:09.248392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:19:09.250392 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:19:09.251389 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:19:09.251389 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:19:09.251389 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:19:09.251389 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m18:19:09.251389 [info ] [MainThread]: 
[0m18:19:09.251389 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.33 seconds (6.33s).
[0m18:19:09.251389 [debug] [MainThread]: Command end result
[0m18:19:09.261385 [info ] [MainThread]: 
[0m18:19:09.261385 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:19:09.262355 [info ] [MainThread]: 
[0m18:19:09.262355 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:19:09.263681 [debug] [MainThread]: Command `dbt run` succeeded at 18:19:09.263681 after 7.08 seconds
[0m18:19:09.264692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C92826430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C95EA3160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C961486A0>]}
[0m18:19:09.264692 [debug] [MainThread]: Flushing usage events
[0m18:32:03.448239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C57E0323D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C500AC7310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C500AC7790>]}


============================== 18:32:03.464304 | f546723d-7bd2-440a-a818-8bf49cb67069 ==============================
[0m18:32:03.464304 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:32:03.464304 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_imagem_produto', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:32:03.850632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C500AC1940>]}
[0m18:32:03.914797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C501804AC0>]}
[0m18:32:03.914797 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:32:03.930107 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:32:04.036314 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:32:04.037309 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_imagem_produto.sql
[0m18:32:04.134744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C501B80DC0>]}
[0m18:32:04.142769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5019260D0>]}
[0m18:32:04.142769 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:32:04.142769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C501926190>]}
[0m18:32:04.142769 [info ] [MainThread]: 
[0m18:32:04.142769 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:32:04.142769 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:32:04.142769 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:32:04.999230 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:32:05.000236 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:32:05.002231 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:32:05.003231 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:32:05.817174 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:32:05.817174 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:32:06.489157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5018D3BE0>]}
[0m18:32:06.489157 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:32:06.490155 [info ] [MainThread]: 
[0m18:32:06.495084 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:32:06.497134 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m18:32:06.499095 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_imagem_produto'
[0m18:32:06.499095 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:32:06.507546 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:32:06.507546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:32:06.500096 => 18:32:06.507546
[0m18:32:06.507546 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:32:06.536121 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:32:06.537117 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:32:06.538117 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,js_imagens
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
   from cte_imagem_expandido_base;


[0m18:32:07.263701 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:121da97b-bd90-4e7c-bdb4-41692b7d39ef&page=queryresults
[0m18:32:07.660171 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name json_element not found inside a at [28:30]')
[0m18:32:08.025501 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fa62733-7e35-47d2-8937-645348a99efd&page=queryresults
[0m18:32:08.448083 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fa62733-7e35-47d2-8937-645348a99efd&page=queryresults
[0m18:32:08.448083 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:32:06.507546 => 18:32:08.448083
[0m18:32:08.729414 [debug] [Thread-1  ]: Database Error in model stg_imagem_produto (models\1.stg\stg_imagem_produto.sql)
  Name json_element not found inside a at [28:30]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_imagem_produto.sql
[0m18:32:08.729414 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f546723d-7bd2-440a-a818-8bf49cb67069', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C502C85E80>]}
[0m18:32:08.729414 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_imagem_produto ............. [[31mERROR[0m in 2.23s]
[0m18:32:08.729414 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:32:08.729414 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:32:08.729414 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:32:08.729414 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:32:08.745248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:32:08.745248 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_imagem_produto' was properly closed.
[0m18:32:08.746774 [info ] [MainThread]: 
[0m18:32:08.747843 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.60 seconds (4.60s).
[0m18:32:08.749961 [debug] [MainThread]: Command end result
[0m18:32:08.776424 [info ] [MainThread]: 
[0m18:32:08.778416 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:32:08.781725 [info ] [MainThread]: 
[0m18:32:08.782726 [error] [MainThread]:   Database Error in model stg_imagem_produto (models\1.stg\stg_imagem_produto.sql)
  Name json_element not found inside a at [28:30]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_imagem_produto.sql
[0m18:32:08.783733 [info ] [MainThread]: 
[0m18:32:08.784733 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:32:08.787739 [debug] [MainThread]: Command `dbt run` failed at 18:32:08.787739 after 5.38 seconds
[0m18:32:08.788729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C57E0323D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C501804AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C50186E580>]}
[0m18:32:08.788729 [debug] [MainThread]: Flushing usage events
[0m18:32:59.040731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D694016460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D692F999D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D692F99B80>]}


============================== 18:32:59.056681 | dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e ==============================
[0m18:32:59.056681 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:32:59.057652 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_imagem_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:32:59.556132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D692F7C130>]}
[0m18:32:59.625764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D69767F880>]}
[0m18:32:59.625764 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:32:59.625764 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:32:59.717479 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:32:59.717479 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_imagem_produto.sql
[0m18:32:59.796818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D6979EEC40>]}
[0m18:32:59.812648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D69784C220>]}
[0m18:32:59.812648 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:32:59.812648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D697726EE0>]}
[0m18:32:59.812648 [info ] [MainThread]: 
[0m18:32:59.812648 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:32:59.812648 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:32:59.812648 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:00.692702 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:33:00.692702 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:00.725269 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:33:00.725269 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:01.362726 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:33:01.362726 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:33:02.019764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D697ABCEB0>]}
[0m18:33:02.019764 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:33:02.019764 [info ] [MainThread]: 
[0m18:33:02.037113 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:33:02.039239 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m18:33:02.043248 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_imagem_produto'
[0m18:33:02.045239 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:33:02.071693 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:33:02.072693 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:33:02.047241 => 18:33:02.072693
[0m18:33:02.072693 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:33:02.095204 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:33:02.095836 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:33:02.095836 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
   from cte_imagem_expandido_base;


[0m18:33:02.886632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:deac593b-8a95-456a-8045-3773cc710f78&page=queryresults
[0m18:33:03.306179 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:33:02.073693 => 18:33:03.306179
[0m18:33:03.306179 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfbbada5-6c7b-40f8-bdc1-6ce8d01d217e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D697ABCEB0>]}
[0m18:33:03.306179 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m18:33:03.306179 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:33:03.315744 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:33:03.315744 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:33:03.315744 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:33:03.315744 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:33:03.315744 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_imagem_produto' was properly closed.
[0m18:33:03.315744 [info ] [MainThread]: 
[0m18:33:03.315744 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.50 seconds (3.50s).
[0m18:33:03.321618 [debug] [MainThread]: Command end result
[0m18:33:03.331638 [info ] [MainThread]: 
[0m18:33:03.333100 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:33:03.334217 [info ] [MainThread]: 
[0m18:33:03.335147 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:33:03.337113 [debug] [MainThread]: Command `dbt run` succeeded at 18:33:03.337113 after 4.34 seconds
[0m18:33:03.337113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D694016460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D69767F880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D697AFA460>]}
[0m18:33:03.337113 [debug] [MainThread]: Flushing usage events
[0m18:35:28.491053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016146596460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161455199D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016145519B80>]}


============================== 18:35:28.494088 | ce5a4589-a57c-494b-b63a-df0b60f2d307 ==============================
[0m18:35:28.494088 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:35:28.495060 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_imagem_produto', 'send_anonymous_usage_stats': 'True'}
[0m18:35:28.926143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161455109A0>]}
[0m18:35:28.989259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149BFD7C0>]}
[0m18:35:28.990257 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:35:28.995802 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:35:29.085613 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:35:29.085613 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_imagem_produto.sql
[0m18:35:29.185776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149F57E20>]}
[0m18:35:29.195788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149DCF160>]}
[0m18:35:29.195788 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:35:29.195788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149DCF040>]}
[0m18:35:29.195788 [info ] [MainThread]: 
[0m18:35:29.195788 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:35:29.195788 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:35:29.195788 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:30.006863 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:35:30.016357 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:30.016357 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:35:30.016357 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:30.745089 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:35:30.745089 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:35:31.392797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149C12CA0>]}
[0m18:35:31.392797 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:35:31.408689 [info ] [MainThread]: 
[0m18:35:31.408689 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:35:31.419976 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m18:35:31.419976 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_imagem_produto'
[0m18:35:31.419976 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:35:31.436639 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:35:31.438903 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:35:31.423494 => 18:35:31.438903
[0m18:35:31.438903 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:35:31.456588 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:35:31.456588 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:35:31.456588 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling, lk_imagem_produto) as seq_imagem
   from cte_imagem_expandido_base;


[0m18:35:32.577287 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d4ff6903-39e7-4c89-afd8-7c342de3d2cb&page=queryresults
[0m18:35:33.013587 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:35:31.438903 => 18:35:33.013587
[0m18:35:33.013587 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ce5a4589-a57c-494b-b63a-df0b60f2d307', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001614B0C3DC0>]}
[0m18:35:33.013587 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m18:35:33.013587 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:35:33.013587 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:35:33.013587 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:35:33.013587 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:35:33.013587 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:35:33.019602 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_imagem_produto' was properly closed.
[0m18:35:33.019602 [info ] [MainThread]: 
[0m18:35:33.019602 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.82 seconds (3.82s).
[0m18:35:33.022183 [debug] [MainThread]: Command end result
[0m18:35:33.034785 [info ] [MainThread]: 
[0m18:35:33.035799 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:35:33.035799 [info ] [MainThread]: 
[0m18:35:33.035799 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:35:33.035799 [debug] [MainThread]: Command `dbt run` succeeded at 18:35:33.035799 after 4.61 seconds
[0m18:35:33.035799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016146596460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001614A05FA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016149EBBE80>]}
[0m18:35:33.035799 [debug] [MainThread]: Flushing usage events
[0m18:35:58.530312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021820891430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002181F8339A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002181F833D30>]}


============================== 18:35:58.530312 | c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5 ==============================
[0m18:35:58.530312 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:35:58.530312 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models stg_imagem_produto', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:35:58.971111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002181F821970>]}
[0m18:35:59.037035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021823E12280>]}
[0m18:35:59.039012 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:35:59.045013 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:35:59.130317 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:35:59.130317 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_imagem_produto.sql
[0m18:35:59.224588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002182428AA30>]}
[0m18:35:59.224588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021824066EE0>]}
[0m18:35:59.224588 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:35:59.224588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021823FD7AC0>]}
[0m18:35:59.224588 [info ] [MainThread]: 
[0m18:35:59.224588 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:35:59.240551 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:35:59.240551 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:59.857904 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:35:59.857904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:35:59.896237 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:35:59.896237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:00.486248 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:36:00.497547 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:36:01.126805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021823F75D30>]}
[0m18:36:01.126805 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:36:01.126805 [info ] [MainThread]: 
[0m18:36:01.126805 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:36:01.126805 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m18:36:01.138580 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_imagem_produto'
[0m18:36:01.139073 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:36:01.147155 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:36:01.149038 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:36:01.139073 => 18:36:01.148154
[0m18:36:01.149038 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:36:01.166912 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:36:01.166912 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:36:01.175080 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m18:36:01.958695 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cba020c4-4606-4bea-b210-0e8888a4e909&page=queryresults
[0m18:36:02.355926 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:36:01.150049 => 18:36:02.355926
[0m18:36:02.355926 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c9be41ff-5a6b-4a6f-bbe3-ff6184ace4e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002182428AEE0>]}
[0m18:36:02.355926 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m18:36:02.355926 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:36:02.355926 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:36:02.355926 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:36:02.355926 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:36:02.355926 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:36:02.355926 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_imagem_produto' was properly closed.
[0m18:36:02.355926 [info ] [MainThread]: 
[0m18:36:02.355926 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.13 seconds (3.13s).
[0m18:36:02.365058 [debug] [MainThread]: Command end result
[0m18:36:02.371066 [info ] [MainThread]: 
[0m18:36:02.375106 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:36:02.376171 [info ] [MainThread]: 
[0m18:36:02.377164 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:36:02.378162 [debug] [MainThread]: Command `dbt run` succeeded at 18:36:02.378162 after 3.90 seconds
[0m18:36:02.378162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021820891430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021823F83FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218241CF760>]}
[0m18:36:02.379165 [debug] [MainThread]: Flushing usage events
[0m18:38:11.775075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029ED9192430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029ED81399D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029ED8139B80>]}


============================== 18:38:11.775075 | 181ca774-e4af-472b-b351-c5c00367c594 ==============================
[0m18:38:11.775075 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:38:11.775075 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_produto', 'send_anonymous_usage_stats': 'True'}
[0m18:38:12.235715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029ED811C130>]}
[0m18:38:12.315557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC74F9D0>]}
[0m18:38:12.315557 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:38:12.330063 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:38:12.429981 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:38:12.430672 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m18:38:12.586480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDCB99730>]}
[0m18:38:12.612044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC9FDAC0>]}
[0m18:38:12.613043 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:38:12.614048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC9FD9D0>]}
[0m18:38:12.615584 [info ] [MainThread]: 
[0m18:38:12.617397 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:38:12.621472 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:38:12.622476 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:38:13.436312 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:38:13.436312 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:38:13.446378 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:38:13.446378 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:38:14.096546 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:38:14.096546 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:38:14.718638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC8D25E0>]}
[0m18:38:14.722689 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:38:14.722689 [info ] [MainThread]: 
[0m18:38:14.732270 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m18:38:14.733973 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m18:38:14.737000 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m18:38:14.737997 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:38:14.759974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:38:14.761871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:38:14.738988 => 18:38:14.760968
[0m18:38:14.761871 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:38:14.778675 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:38:15.397159 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:38:15.397159 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = b.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m18:38:16.104611 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9266e6e7-d244-4e53-8ac6-c2557d51bfa6&page=queryresults
[0m18:38:18.398288 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:38:14.761871 => 18:38:18.398288
[0m18:38:18.399317 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '181ca774-e4af-472b-b351-c5c00367c594', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC87F880>]}
[0m18:38:18.399766 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (3.0k rows, 1.7 MiB processed)[0m in 3.66s]
[0m18:38:18.399766 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:38:18.405236 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:38:18.407248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:38:18.407248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:38:18.407248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:38:18.407248 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m18:38:18.408304 [info ] [MainThread]: 
[0m18:38:18.408304 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.79 seconds (5.79s).
[0m18:38:18.409312 [debug] [MainThread]: Command end result
[0m18:38:18.421078 [info ] [MainThread]: 
[0m18:38:18.422077 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:38:18.423079 [info ] [MainThread]: 
[0m18:38:18.423079 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:38:18.424074 [debug] [MainThread]: Command `dbt run` succeeded at 18:38:18.424074 after 6.70 seconds
[0m18:38:18.424999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029ED9192430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDC794760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029EDCADB6D0>]}
[0m18:38:18.426354 [debug] [MainThread]: Flushing usage events
[0m18:46:58.374244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8BFF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8AF8D2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8AF8D760>]}


============================== 18:46:58.374244 | b50bb637-a5e2-4182-acea-8c5e9a33cc06 ==============================
[0m18:46:58.374244 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:46:58.374244 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_produto', 'send_anonymous_usage_stats': 'True'}
[0m18:46:58.835249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8E15CAF0>]}
[0m18:46:58.896436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F5B53D0>]}
[0m18:46:58.896436 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:46:58.905490 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:46:59.013671 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:46:59.013671 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m18:46:59.093149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F9BD910>]}
[0m18:46:59.116961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F86FDC0>]}
[0m18:46:59.117969 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:46:59.117969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F63F460>]}
[0m18:46:59.118958 [info ] [MainThread]: 
[0m18:46:59.119954 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:46:59.121956 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:46:59.121956 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:47:00.128415 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:47:00.128415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:47:00.136651 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:47:00.165404 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:47:00.840576 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:47:00.841572 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:47:01.468029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F740AC0>]}
[0m18:47:01.468029 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:47:01.468029 [info ] [MainThread]: 
[0m18:47:01.481527 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m18:47:01.481527 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m18:47:01.483693 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m18:47:01.483693 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:47:01.495516 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:47:01.496521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:47:01.483693 => 18:47:01.496521
[0m18:47:01.497526 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:47:01.512568 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:47:02.184891 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:47:02.186905 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m18:47:02.803481 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cead3f93-dc64-40ca-9d1a-46147d660eb6&page=queryresults
[0m18:47:05.426747 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:47:01.498518 => 18:47:05.426747
[0m18:47:05.426747 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b50bb637-a5e2-4182-acea-8c5e9a33cc06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8FADFC40>]}
[0m18:47:05.426747 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.94s]
[0m18:47:05.426747 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:47:05.426747 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:47:05.426747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:47:05.426747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:47:05.426747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:47:05.426747 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m18:47:05.426747 [info ] [MainThread]: 
[0m18:47:05.426747 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.31 seconds (6.31s).
[0m18:47:05.442702 [debug] [MainThread]: Command end result
[0m18:47:05.453514 [info ] [MainThread]: 
[0m18:47:05.453917 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:47:05.454923 [info ] [MainThread]: 
[0m18:47:05.455927 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:47:05.456253 [debug] [MainThread]: Command `dbt run` succeeded at 18:47:05.456253 after 7.13 seconds
[0m18:47:05.456253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8BFF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F9DCEB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF8F5A1850>]}
[0m18:47:05.456253 [debug] [MainThread]: Flushing usage events
[0m19:00:04.006990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251139E9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251129689A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025112968D30>]}


============================== 19:00:04.014659 | 2d5727ef-bee6-47a5-8449-818ea899f9ec ==============================
[0m19:00:04.014659 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:00:04.015875 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:04.537223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025115B3EBB0>]}
[0m19:00:04.604138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025117058A00>]}
[0m19:00:04.605228 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:00:04.612785 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:00:04.685828 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:00:04.685828 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:00:04.701926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251172FF220>]}
[0m19:00:04.701926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025117235C70>]}
[0m19:00:04.701926 [info ] [MainThread]: Found 8 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:00:04.701926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025117235370>]}
[0m19:00:04.701926 [info ] [MainThread]: 
[0m19:00:04.714264 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:00:04.715307 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.715307 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:04.741823 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.741823 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:05.511255 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:06.145366 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:00:06.146370 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:06.147034 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:00:06.147034 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:06.803063 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:00:06.804873 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:07.453419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251170B38E0>]}
[0m19:00:07.455025 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:07.455025 [info ] [MainThread]: 
[0m19:00:07.455025 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:07.455025 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.455025 [info ] [Thread-1  ]: 1 of 8 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m19:00:07.455025 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m19:00:07.455025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:07.470394 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:07.455025 [info ] [Thread-2  ]: 2 of 8 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m19:00:07.470394 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m19:00:07.470394 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.486521 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.486521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 19:00:07.470394 => 19:00:07.486521
[0m19:00:07.486521 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:07.502307 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:07.502307 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 19:00:07.470394 => 19:00:07.502307
[0m19:00:07.502307 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.518009 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.518009 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:00:07.518009 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m19:00:07.533819 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m19:00:07.533819 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m19:00:08.434916 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:31792542-299a-4e17-8e24-ffd4178bfba0&page=queryresults
[0m19:00:08.441972 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:03392f3c-9545-4432-90cf-b411ecd3ddc3&page=queryresults
[0m19:00:08.873645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 19:00:07.486521 => 19:00:08.872649
[0m19:00:08.873645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251170B38E0>]}
[0m19:00:08.874648 [info ] [Thread-1  ]: 1 of 8 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m19:00:08.876783 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 19:00:07.502307 => 19:00:08.876783
[0m19:00:08.877774 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:08.878778 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025117337820>]}
[0m19:00:08.879178 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m19:00:08.879972 [info ] [Thread-2  ]: 2 of 8 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m19:00:08.881102 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m19:00:08.881102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m19:00:08.879972 [info ] [Thread-1  ]: 3 of 8 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m19:00:08.882109 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m19:00:08.882109 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m19:00:08.885110 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:08.881102 [info ] [Thread-2  ]: 4 of 8 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m19:00:08.886181 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m19:00:08.886181 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m19:00:08.890185 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:08.892548 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 19:00:08.887325 => 19:00:08.891540
[0m19:00:08.892548 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m19:00:08.895272 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:08.895855 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 19:00:08.882109 => 19:00:08.895272
[0m19:00:08.895855 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m19:00:08.897890 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:08.899889 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:08.902635 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m19:00:08.923039 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:08.925938 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m19:00:09.636450 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a465901c-0dd7-45e1-8760-4546d499cd1e&page=queryresults
[0m19:00:09.692008 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08871a2a-e88f-4748-9356-42a713ff0ac0&page=queryresults
[0m19:00:10.124101 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 19:00:08.895855 => 19:00:10.124101
[0m19:00:10.126118 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251170B38E0>]}
[0m19:00:10.126118 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 19:00:08.892548 => 19:00:10.126118
[0m19:00:10.126118 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251173904C0>]}
[0m19:00:10.126118 [info ] [Thread-1  ]: 3 of 8 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m19:00:10.126118 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m19:00:10.126118 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m19:00:10.126118 [info ] [Thread-2  ]: 4 of 8 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m19:00:10.126118 [info ] [Thread-1  ]: 5 of 8 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m19:00:10.139860 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m19:00:10.139860 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m19:00:10.139860 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m19:00:10.155810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m19:00:10.155810 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 19:00:10.139860 => 19:00:10.155810
[0m19:00:10.155810 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m19:00:10.155810 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m19:00:10.155810 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:10.155810 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m19:00:10.938577 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8675ef50-27cc-47fb-a745-fcce686a051e&page=queryresults
[0m19:00:11.353746 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 19:00:10.155810 => 19:00:11.353746
[0m19:00:11.353746 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025118432DF0>]}
[0m19:00:11.353746 [info ] [Thread-1  ]: 5 of 8 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m19:00:11.353746 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m19:00:11.369818 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m19:00:11.369818 [info ] [Thread-2  ]: 6 of 8 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m19:00:11.369818 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m19:00:11.369818 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m19:00:11.369818 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m19:00:11.385799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 19:00:11.369818 => 19:00:11.385799
[0m19:00:11.385799 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m19:00:11.401623 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:12.039906 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m19:00:12.055952 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m19:00:12.640475 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20cf0d6c-946d-4e45-a818-9de143f5927f&page=queryresults
[0m19:00:15.187998 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 19:00:11.385799 => 19:00:15.187998
[0m19:00:15.189001 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251183A2E20>]}
[0m19:00:15.190000 [info ] [Thread-2  ]: 6 of 8 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.82s]
[0m19:00:15.190510 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m19:00:15.192572 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m19:00:15.192572 [info ] [Thread-1  ]: 7 of 8 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m19:00:15.193609 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m19:00:15.195027 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m19:00:15.195027 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m19:00:15.195027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 19:00:15.195027 => 19:00:15.195027
[0m19:00:15.195027 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m19:00:15.195027 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:15.824097 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m19:00:15.826105 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m19:00:16.456411 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:482bd212-2b03-44ba-a0fa-c9d672f83eda&page=queryresults
[0m19:00:18.684850 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 19:00:15.195027 => 19:00:18.683895
[0m19:00:18.685939 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251170B38E0>]}
[0m19:00:18.687099 [info ] [Thread-1  ]: 7 of 8 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.49s]
[0m19:00:18.688108 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m19:00:18.690102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m19:00:18.691106 [info ] [Thread-2  ]: 8 of 8 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m19:00:18.692109 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m19:00:18.693104 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m19:00:18.694772 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:18.694772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 19:00:18.693104 => 19:00:18.694772
[0m19:00:18.694772 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m19:00:18.694772 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:19.309634 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:19.309634 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m19:00:19.931774 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5aa1d9c7-c164-4116-b2d7-16dce6c05878&page=queryresults
[0m19:00:21.884950 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 19:00:18.694772 => 19:00:21.884950
[0m19:00:21.886963 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d5727ef-bee6-47a5-8449-818ea899f9ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002511840E070>]}
[0m19:00:21.886963 [info ] [Thread-2  ]: 8 of 8 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.19s]
[0m19:00:21.888975 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m19:00:21.890595 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:21.890595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:21.890595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:21.890595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:00:21.890595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:00:21.897670 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m19:00:21.897670 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m19:00:21.897670 [info ] [MainThread]: 
[0m19:00:21.897670 [info ] [MainThread]: Finished running 5 view models, 3 table models in 0 hours 0 minutes and 17.20 seconds (17.20s).
[0m19:00:21.902633 [debug] [MainThread]: Command end result
[0m19:00:21.910412 [info ] [MainThread]: 
[0m19:00:21.914312 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:21.915345 [info ] [MainThread]: 
[0m19:00:21.915345 [info ] [MainThread]: Done. PASS=8 WARN=0 ERROR=0 SKIP=0 TOTAL=8
[0m19:00:21.915345 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:21.915345 after 17.97 seconds
[0m19:00:21.915345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251139E9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025117058A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002511736F670>]}
[0m19:00:21.915345 [debug] [MainThread]: Flushing usage events
[0m19:57:10.124248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B739A86430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7389FF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7389FFD30>]}


============================== 19:57:10.134238 | 49fe1b54-f86a-45bb-adff-0258b285b647 ==============================
[0m19:57:10.134238 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:57:10.135944 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_meta_margem_preco', 'send_anonymous_usage_stats': 'True'}
[0m19:57:10.641676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7389F7970>]}
[0m19:57:10.719020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73CFC2D30>]}
[0m19:57:10.720019 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:57:10.728008 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:57:10.823559 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m19:57:10.824560 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_meta_margem_preco.sql
[0m19:57:10.824560 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m19:57:10.981185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73D6573A0>]}
[0m19:57:10.990147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73D089DC0>]}
[0m19:57:10.990451 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:57:10.990451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73D089970>]}
[0m19:57:10.991493 [info ] [MainThread]: 
[0m19:57:10.992541 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:57:10.993452 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:57:10.994517 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:11.823765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:57:11.824697 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:11.854730 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:57:11.854730 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:12.500087 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:57:12.500087 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:57:13.131087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73D6576A0>]}
[0m19:57:13.131087 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:57:13.131087 [info ] [MainThread]: 
[0m19:57:13.147046 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:13.147046 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m19:57:13.147046 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_meta_margem_preco'
[0m19:57:13.147046 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:13.170452 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:57:13.172926 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 19:57:13.147046 => 19:57:13.172490
[0m19:57:13.173985 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:13.198680 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:57:13.199661 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:57:13.201582 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,nullif(pr_desconto_padrao,'0')      as pr_desconto_padrao 
         ,nullif(pr_meta_margem,'0')          as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m19:57:14.099067 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7b827776-1fbb-4993-9bcd-5cec68e54c43&page=queryresults
[0m19:57:14.549787 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for function NULLIF\n  Argument types: FLOAT64, STRING\n  Signature: NULLIF(T1, T1)\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {DOUBLE, STRING} at [13:11]')
[0m19:57:15.140773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebc0bdcf-2cb7-44d2-92f9-86e836aafa00&page=queryresults
[0m19:57:15.519548 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebc0bdcf-2cb7-44d2-92f9-86e836aafa00&page=queryresults
[0m19:57:15.520642 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 19:57:13.173985 => 19:57:15.520642
[0m19:57:15.520642 [debug] [Thread-1  ]: Database Error in model stg_meta_margem_preco (models\1.stg\stg_meta_margem_preco.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [13:11]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_meta_margem_preco.sql
[0m19:57:15.520642 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49fe1b54-f86a-45bb-adff-0258b285b647', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73E698790>]}
[0m19:57:15.520642 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_meta_margem_preco .......... [[31mERROR[0m in 2.37s]
[0m19:57:15.520642 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:15.539061 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:57:15.539649 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:57:15.540730 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:57:15.541727 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:57:15.542396 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_meta_margem_preco' was properly closed.
[0m19:57:15.543912 [info ] [MainThread]: 
[0m19:57:15.545388 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.55 seconds (4.55s).
[0m19:57:15.547756 [debug] [MainThread]: Command end result
[0m19:57:15.569923 [info ] [MainThread]: 
[0m19:57:15.570922 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:57:15.570922 [info ] [MainThread]: 
[0m19:57:15.571923 [error] [MainThread]:   Database Error in model stg_meta_margem_preco (models\1.stg\stg_meta_margem_preco.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [13:11]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_meta_margem_preco.sql
[0m19:57:15.571923 [info ] [MainThread]: 
[0m19:57:15.571923 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:57:15.573629 [debug] [MainThread]: Command `dbt run` failed at 19:57:15.573629 after 5.55 seconds
[0m19:57:15.575522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B739A86430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73CFC2D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B73D1BBB20>]}
[0m19:57:15.575522 [debug] [MainThread]: Flushing usage events
[0m19:57:32.879041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA5F52430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA4EF42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA4EF4760>]}


============================== 19:57:32.885508 | d03e5502-3c17-46ac-b139-93e65a5a3007 ==============================
[0m19:57:32.885508 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:57:32.885508 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_meta_margem_preco', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:57:33.378214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA94C81C0>]}
[0m19:57:33.440859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA95D4AF0>]}
[0m19:57:33.443767 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:57:33.451215 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:57:33.535908 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:57:33.535908 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_meta_margem_preco.sql
[0m19:57:33.631097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA99EF550>]}
[0m19:57:33.646836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA9796910>]}
[0m19:57:33.646836 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:57:33.646836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA9796970>]}
[0m19:57:33.646836 [info ] [MainThread]: 
[0m19:57:33.646836 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:57:33.646836 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:57:33.646836 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:34.404154 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:57:34.404154 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:34.424089 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:57:34.424089 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:35.019649 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m19:57:35.024812 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:57:35.627570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA963E5B0>]}
[0m19:57:35.641503 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:57:35.641503 [info ] [MainThread]: 
[0m19:57:35.641503 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:35.641503 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m19:57:35.641503 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_meta_margem_preco'
[0m19:57:35.641503 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:35.654954 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:57:35.654954 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 19:57:35.641503 => 19:57:35.654954
[0m19:57:35.654954 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:35.679153 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:57:35.683701 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:57:35.685246 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,nullif(pr_desconto_padrao, 0)       as pr_desconto_padrao 
         ,nullif(pr_meta_margem, 0)           as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m19:57:36.394790 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:847695d0-7f0a-411a-8624-c31f875b8e12&page=queryresults
[0m19:57:36.814236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 19:57:35.654954 => 19:57:36.814236
[0m19:57:36.814236 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd03e5502-3c17-46ac-b139-93e65a5a3007', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DAAA74C10>]}
[0m19:57:36.814236 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m19:57:36.814236 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m19:57:36.814236 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:57:36.814236 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:57:36.814236 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:57:36.814236 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:57:36.814236 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_meta_margem_preco' was properly closed.
[0m19:57:36.814236 [info ] [MainThread]: 
[0m19:57:36.814236 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.17 seconds (3.17s).
[0m19:57:36.814236 [debug] [MainThread]: Command end result
[0m19:57:36.827376 [info ] [MainThread]: 
[0m19:57:36.828376 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:57:36.828376 [info ] [MainThread]: 
[0m19:57:36.828376 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:57:36.828376 [debug] [MainThread]: Command `dbt run` succeeded at 19:57:36.828376 after 4.01 seconds
[0m19:57:36.828376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA5F52430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA94D53A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029DA98A05E0>]}
[0m19:57:36.828376 [debug] [MainThread]: Flushing usage events
[0m19:58:41.283506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF0810430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEF7B42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEF7B4760>]}


============================== 19:58:41.284551 | 9085bef3-0f95-44d4-b57a-c77b75be0dbe ==============================
[0m19:58:41.284551 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:58:41.284551 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_meta_margem_preco', 'send_anonymous_usage_stats': 'True'}
[0m19:58:41.716713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF297CBB0>]}
[0m19:58:41.784196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF3DD18E0>]}
[0m19:58:41.784196 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:58:41.793627 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:58:41.883506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:58:41.883506 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_meta_margem_preco.sql
[0m19:58:42.020617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF428F490>]}
[0m19:58:42.033406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF4056850>]}
[0m19:58:42.033980 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:58:42.035037 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF40568B0>]}
[0m19:58:42.035560 [info ] [MainThread]: 
[0m19:58:42.035560 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:58:42.035560 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:58:42.035560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:58:42.729280 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:58:42.730511 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:58:42.732514 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:58:42.734693 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:58:43.379672 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m19:58:43.391499 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:58:44.023077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF3DF7880>]}
[0m19:58:44.023077 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:58:44.023077 [info ] [MainThread]: 
[0m19:58:44.041917 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m19:58:44.042477 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m19:58:44.045316 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_meta_margem_preco'
[0m19:58:44.046315 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m19:58:44.055320 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:58:44.055320 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 19:58:44.047307 => 19:58:44.055320
[0m19:58:44.055320 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m19:58:44.074749 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:58:44.084804 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:58:44.084804 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m19:58:45.055484 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8bba4de5-72d2-4c0f-8778-c35263529008&page=queryresults
[0m19:58:45.546979 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 19:58:44.055320 => 19:58:45.546979
[0m19:58:45.546979 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9085bef3-0f95-44d4-b57a-c77b75be0dbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF42F65B0>]}
[0m19:58:45.546979 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m19:58:45.546979 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m19:58:45.546979 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:58:45.546979 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:58:45.546979 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:58:45.546979 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:58:45.546979 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_meta_margem_preco' was properly closed.
[0m19:58:45.546979 [info ] [MainThread]: 
[0m19:58:45.562644 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.51 seconds (3.51s).
[0m19:58:45.565416 [debug] [MainThread]: Command end result
[0m19:58:45.575632 [info ] [MainThread]: 
[0m19:58:45.576632 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:58:45.577631 [info ] [MainThread]: 
[0m19:58:45.577631 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:58:45.578631 [debug] [MainThread]: Command `dbt run` succeeded at 19:58:45.578631 after 4.35 seconds
[0m19:58:45.578631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF0810430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF3F5D9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF4160520>]}
[0m19:58:45.578631 [debug] [MainThread]: Flushing usage events
[0m20:00:04.066411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F0AF7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219EFA83640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219EFA83AC0>]}


============================== 20:00:04.066411 | 9d27310c-db33-4afe-a8b6-ce56c8fa1111 ==============================
[0m20:00:04.066411 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:04.066411 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:00:04.592468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219EFA83850>]}
[0m20:00:04.640492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4170A60>]}
[0m20:00:04.656397 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:04.656397 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:04.736073 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:04.736073 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:04.736073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4412B50>]}
[0m20:00:04.751891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4339880>]}
[0m20:00:04.751891 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:04.751891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F43398E0>]}
[0m20:00:04.760883 [info ] [MainThread]: 
[0m20:00:04.760883 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:04.760883 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:04.760883 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:04.783476 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:04.783476 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:05.506256 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:06.175817 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:00:06.175817 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.191908 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:00:06.224168 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.856085 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m20:00:06.860805 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:07.501086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4339AF0>]}
[0m20:00:07.503100 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:07.504749 [info ] [MainThread]: 
[0m20:00:07.511186 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:07.513178 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m20:00:07.512181 [info ] [Thread-1  ]: 1 of 9 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m20:00:07.516591 [info ] [Thread-2  ]: 2 of 9 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m20:00:07.518949 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:00:07.520524 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m20:00:07.521785 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:07.522790 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m20:00:07.534338 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:07.537005 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:07.539401 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:00:07.522790 => 20:00:07.539401
[0m20:00:07.539401 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:07.540400 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 20:00:07.534938 => 20:00:07.539401
[0m20:00:07.553667 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:07.553667 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m20:00:07.562709 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:07.562709 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:07.562709 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m20:00:07.583889 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m20:00:07.583889 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m20:00:08.319239 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4b75e0ee-6339-4d5d-80cc-b078181d660f&page=queryresults
[0m20:00:08.330004 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:752b4208-93e6-42a5-92b5-58b6dade3447&page=queryresults
[0m20:00:08.726694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 20:00:07.553667 => 20:00:08.726694
[0m20:00:08.726694 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4466BB0>]}
[0m20:00:08.726694 [info ] [Thread-2  ]: 2 of 9 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m20:00:08.726694 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.726694 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m20:00:08.726694 [info ] [Thread-2  ]: 3 of 9 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m20:00:08.726694 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m20:00:08.726694 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m20:00:08.726694 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:08.726694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 20:00:08.726694 => 20:00:08.726694
[0m20:00:08.726694 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m20:00:08.726694 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:08.742911 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:08.742911 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m20:00:08.759050 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:00:07.540400 => 20:00:08.759050
[0m20:00:08.759050 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F44A65B0>]}
[0m20:00:08.759050 [info ] [Thread-1  ]: 1 of 9 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m20:00:08.759050 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:08.759050 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m20:00:08.759050 [info ] [Thread-1  ]: 4 of 9 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m20:00:08.759050 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m20:00:08.759050 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m20:00:08.759050 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:08.759050 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 20:00:08.759050 => 20:00:08.759050
[0m20:00:08.759050 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m20:00:08.774813 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:08.774813 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:08.774813 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m20:00:09.461608 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8830b7e5-e005-445a-8238-402a80f5d83f&page=queryresults
[0m20:00:09.514935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50bfa0e4-f8b2-4448-be50-4986cec9cc3b&page=queryresults
[0m20:00:09.827585 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 20:00:08.726694 => 20:00:09.827585
[0m20:00:09.827585 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F445F190>]}
[0m20:00:09.827585 [info ] [Thread-2  ]: 3 of 9 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m20:00:09.827585 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m20:00:09.827585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:09.827585 [info ] [Thread-2  ]: 5 of 9 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m20:00:09.827585 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m20:00:09.827585 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:09.843426 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:09.843426 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 20:00:09.827585 => 20:00:09.843426
[0m20:00:09.843426 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:09.843426 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:09.859206 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:09.859206 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m20:00:09.890940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 20:00:08.759050 => 20:00:09.890940
[0m20:00:09.890940 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4339AF0>]}
[0m20:00:09.890940 [info ] [Thread-1  ]: 4 of 9 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m20:00:09.890940 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m20:00:09.890940 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m20:00:09.890940 [info ] [Thread-1  ]: 6 of 9 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m20:00:09.890940 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m20:00:09.890940 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m20:00:09.890940 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m20:00:09.890940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 20:00:09.890940 => 20:00:09.890940
[0m20:00:09.890940 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m20:00:09.890940 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m20:00:09.890940 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:09.890940 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m20:00:10.721193 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f195df3-1d6b-426a-9a98-1312a39df54c&page=queryresults
[0m20:00:10.852416 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa4d38b1-f29c-406b-b015-59df27ac1b3c&page=queryresults
[0m20:00:11.092667 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 20:00:09.843426 => 20:00:11.091927
[0m20:00:11.093713 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F445F160>]}
[0m20:00:11.094668 [info ] [Thread-2  ]: 5 of 9 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m20:00:11.096890 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:11.238314 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 20:00:09.890940 => 20:00:11.236298
[0m20:00:11.238314 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F5546040>]}
[0m20:00:11.240329 [info ] [Thread-1  ]: 6 of 9 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m20:00:11.240329 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m20:00:11.243203 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m20:00:11.243203 [info ] [Thread-2  ]: 7 of 9 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m20:00:11.243203 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m20:00:11.243203 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m20:00:11.243203 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m20:00:11.243203 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 20:00:11.243203 => 20:00:11.243203
[0m20:00:11.243203 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m20:00:11.272965 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:11.884599 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m20:00:11.884599 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m20:00:12.539167 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a88d6070-e01f-4820-83a7-3bd5dd51b56e&page=queryresults
[0m20:00:15.080694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 20:00:11.243203 => 20:00:15.080694
[0m20:00:15.080694 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F5596100>]}
[0m20:00:15.080694 [info ] [Thread-2  ]: 7 of 9 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.84s]
[0m20:00:15.080694 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m20:00:15.080694 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:00:15.080694 [info ] [Thread-1  ]: 8 of 9 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:00:15.096338 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m20:00:15.096338 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:00:15.096338 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:00:15.096338 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:00:15.096338 => 20:00:15.096338
[0m20:00:15.096338 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:00:15.096338 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:15.739315 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:00:15.739315 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:00:16.423597 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:319abcab-3975-410a-b9b5-c29205edbe50&page=queryresults
[0m20:00:18.953803 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:00:15.096338 => 20:00:18.953803
[0m20:00:18.953803 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F5596100>]}
[0m20:00:18.953803 [info ] [Thread-1  ]: 8 of 9 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.87s]
[0m20:00:18.962647 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:00:18.965585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m20:00:18.965585 [info ] [Thread-2  ]: 9 of 9 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m20:00:18.968753 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m20:00:18.969760 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m20:00:18.975797 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:18.977805 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 20:00:18.969760 => 20:00:18.977805
[0m20:00:18.977805 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m20:00:18.977805 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:19.593581 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:19.593581 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m20:00:20.213114 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ff7f9248-17d5-408f-8a4d-100c8d44b9b7&page=queryresults
[0m20:00:22.483438 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 20:00:18.977805 => 20:00:22.483438
[0m20:00:22.483438 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d27310c-db33-4afe-a8b6-ce56c8fa1111', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F44A65B0>]}
[0m20:00:22.485451 [info ] [Thread-2  ]: 9 of 9 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.51s]
[0m20:00:22.485451 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m20:00:22.485451 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:00:22.485451 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m20:00:22.485451 [info ] [MainThread]: 
[0m20:00:22.485451 [info ] [MainThread]: Finished running 6 view models, 3 table models in 0 hours 0 minutes and 17.72 seconds (17.72s).
[0m20:00:22.485451 [debug] [MainThread]: Command end result
[0m20:00:22.515300 [info ] [MainThread]: 
[0m20:00:22.515300 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:00:22.515300 [info ] [MainThread]: 
[0m20:00:22.515300 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
[0m20:00:22.515300 [debug] [MainThread]: Command `dbt run` succeeded at 20:00:22.515300 after 18.50 seconds
[0m20:00:22.515300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F0AF7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F42249D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219F4162A90>]}
[0m20:00:22.515300 [debug] [MainThread]: Flushing usage events
[0m20:20:32.593122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017430070430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001742F0159D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001742F015B80>]}


============================== 20:20:32.597139 | 7043fb4d-27f2-48a3-a750-b29b3c5b7e8e ==============================
[0m20:20:32.597139 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:20:32.598115 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:20:33.028113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001742EFFCA30>]}
[0m20:20:33.087720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001743362B040>]}
[0m20:20:33.089019 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:20:33.095124 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:20:33.165208 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:20:33.165208 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m20:20:33.264665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017433AEE790>]}
[0m20:20:33.273666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000174338B6AF0>]}
[0m20:20:33.274665 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:20:33.274665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000174338B6C10>]}
[0m20:20:33.276067 [info ] [MainThread]: 
[0m20:20:33.276959 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:20:33.277961 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:20:33.277961 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:20:34.185804 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:20:34.187781 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:20:34.189800 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:20:34.191786 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:20:34.844750 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m20:20:34.845746 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:20:35.518212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000174336628B0>]}
[0m20:20:35.518212 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:20:35.519214 [info ] [MainThread]: 
[0m20:20:35.526214 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:20:35.527212 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m20:20:35.528215 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:20:35.529213 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:20:35.546531 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:20:35.550518 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:20:35.530213 => 20:20:35.549534
[0m20:20:35.552527 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:20:35.596865 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:20:35.599877 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:20:35.601869 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,vl_alteracao_preco
   from cte_campo_base;


[0m20:20:36.436379 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:56450198-d1cf-4597-a51c-e6e50b1cc124&page=queryresults
[0m20:20:36.895232 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:20:35.553511 => 20:20:36.895232
[0m20:20:36.896010 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7043fb4d-27f2-48a3-a750-b29b3c5b7e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017433B1A7F0>]}
[0m20:20:36.897109 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m20:20:36.897988 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:20:36.901423 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:20:36.901423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:20:36.902525 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:20:36.903426 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:20:36.903426 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m20:20:36.904513 [info ] [MainThread]: 
[0m20:20:36.905466 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.63 seconds (3.63s).
[0m20:20:36.906520 [debug] [MainThread]: Command end result
[0m20:20:36.914436 [info ] [MainThread]: 
[0m20:20:36.915419 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:20:36.915941 [info ] [MainThread]: 
[0m20:20:36.916954 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:20:36.917947 [debug] [MainThread]: Command `dbt run` succeeded at 20:20:36.917947 after 4.38 seconds
[0m20:20:36.917947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017430070430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017433A81E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017433B6FA00>]}
[0m20:20:36.918950 [debug] [MainThread]: Flushing usage events
[0m20:21:38.171329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F03071430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F020199D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F02019B80>]}


============================== 20:21:38.176458 | 1e63c9f1-e605-4424-97f9-8809295042a7 ==============================
[0m20:21:38.176458 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:21:38.178457 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:21:38.659314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F01FFC130>]}
[0m20:21:38.727329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F067007C0>]}
[0m20:21:38.728313 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:21:38.736314 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:21:38.886796 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:21:38.886796 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m20:21:39.027797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F06AEE1F0>]}
[0m20:21:39.049134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F068E0580>]}
[0m20:21:39.050136 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:21:39.050136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F068E05E0>]}
[0m20:21:39.052134 [info ] [MainThread]: 
[0m20:21:39.054139 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:21:39.057134 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:21:39.058134 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:21:39.937883 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:21:39.938881 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:21:39.941879 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:21:39.942877 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:21:40.686686 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m20:21:40.690683 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:21:41.354268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F06690F10>]}
[0m20:21:41.356269 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:21:41.358268 [info ] [MainThread]: 
[0m20:21:41.367420 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:21:41.368368 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m20:21:41.370380 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:21:41.371378 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:21:41.391363 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:21:41.393371 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:21:41.372376 => 20:21:41.392386
[0m20:21:41.394377 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:21:41.422363 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:21:41.423367 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:21:41.424367 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(vl_alteracao_preco as float64) vl_alteracao_preco
   from cte_campo_base;


[0m20:21:42.203068 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa8bf7b5-18ff-4c1f-9904-fe6f41b62549&page=queryresults
[0m20:21:42.664269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:21:41.394377 => 20:21:42.663168
[0m20:21:42.665270 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e63c9f1-e605-4424-97f9-8809295042a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F07BC3A30>]}
[0m20:21:42.665270 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m20:21:42.667175 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:21:42.670168 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:21:42.671167 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:21:42.671167 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:21:42.672167 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:21:42.672167 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m20:21:42.673169 [info ] [MainThread]: 
[0m20:21:42.674176 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.62 seconds (3.62s).
[0m20:21:42.676169 [debug] [MainThread]: Command end result
[0m20:21:42.688168 [info ] [MainThread]: 
[0m20:21:42.689168 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:21:42.691185 [info ] [MainThread]: 
[0m20:21:42.691185 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:21:42.694184 [debug] [MainThread]: Command `dbt run` succeeded at 20:21:42.694184 after 4.60 seconds
[0m20:21:42.695173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F03071430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F069C0250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F069B2EE0>]}
[0m20:21:42.696165 [debug] [MainThread]: Flushing usage events
[0m20:22:33.031694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E45BB63D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E46362A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44B35E20>]}


============================== 20:22:33.034642 | 94710dc9-44bf-4ab4-8e7b-eaef21b6290c ==============================
[0m20:22:33.034642 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:22:33.035686 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:22:33.514247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44B24BB0>]}
[0m20:22:33.618246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E492F5E50>]}
[0m20:22:33.620247 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:22:33.631248 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:22:33.733242 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:22:33.734252 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m20:22:33.877208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4957E6A0>]}
[0m20:22:33.890210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E493D6A90>]}
[0m20:22:33.890210 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:22:33.891207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E493D6A60>]}
[0m20:22:33.892209 [info ] [MainThread]: 
[0m20:22:33.892209 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:22:33.895208 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:22:33.896206 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:22:34.662292 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:22:34.663288 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:22:34.666296 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:22:34.668300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:22:35.519276 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:22:35.520271 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:22:36.160442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4929BCA0>]}
[0m20:22:36.162440 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:22:36.163447 [info ] [MainThread]: 
[0m20:22:36.171135 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:22:36.172143 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:22:36.173141 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m20:22:36.174134 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:22:36.191138 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:22:36.195137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:22:36.174134 => 20:22:36.193138
[0m20:22:36.197141 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:22:36.214133 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:22:36.882180 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:22:36.883186 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:22:37.583154 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a7fa226-630f-4230-bad0-447135a48caf&page=queryresults
[0m20:22:38.317491 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Bad double value: 59,99')
[0m20:22:39.652443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4abc4388-7fec-413b-81bf-c969012a703e&page=queryresults
[0m20:22:40.364983 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4abc4388-7fec-413b-81bf-c969012a703e&page=queryresults
[0m20:22:40.366891 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:22:36.197141 => 20:22:40.365886
[0m20:22:40.373891 [debug] [Thread-1  ]: Database Error in model tb_produto (models\3.az\tb_produto.sql)
  Bad double value: 59,99
  compiled Code at target\run\shibaribrasil\models\3.az\tb_produto.sql
[0m20:22:40.374890 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94710dc9-44bf-4ab4-8e7b-eaef21b6290c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4A6B6670>]}
[0m20:22:40.375893 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_produto ..................... [[31mERROR[0m in 4.20s]
[0m20:22:40.377891 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:22:40.381882 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:22:40.382883 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:22:40.383885 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:22:40.384884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:22:40.385889 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:22:40.386885 [info ] [MainThread]: 
[0m20:22:40.387884 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.49 seconds (6.49s).
[0m20:22:40.391884 [debug] [MainThread]: Command end result
[0m20:22:40.406880 [info ] [MainThread]: 
[0m20:22:40.407877 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:22:40.408877 [info ] [MainThread]: 
[0m20:22:40.408877 [error] [MainThread]:   Database Error in model tb_produto (models\3.az\tb_produto.sql)
  Bad double value: 59,99
  compiled Code at target\run\shibaribrasil\models\3.az\tb_produto.sql
[0m20:22:40.409878 [info ] [MainThread]: 
[0m20:22:40.410885 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:22:40.412877 [debug] [MainThread]: Command `dbt run` failed at 20:22:40.412877 after 7.44 seconds
[0m20:22:40.413889 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E45BB63D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E492F5E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4929B610>]}
[0m20:22:40.414884 [debug] [MainThread]: Flushing usage events
[0m20:23:08.647454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DDD006460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DDBF719A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DDBF71D30>]}


============================== 20:23:08.650188 | 8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50 ==============================
[0m20:23:08.650188 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:23:08.650757 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:23:09.071844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DDBF6C370>]}
[0m20:23:09.129427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE0663520>]}
[0m20:23:09.130430 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:23:09.137434 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:23:09.222017 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:23:09.222017 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m20:23:09.317527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE0A62EB0>]}
[0m20:23:09.325570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE083F2B0>]}
[0m20:23:09.326517 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:23:09.327495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE083F3A0>]}
[0m20:23:09.328465 [info ] [MainThread]: 
[0m20:23:09.328465 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:23:09.330558 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:23:09.330558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:10.036183 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:23:10.038283 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:23:10.039189 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:10.040183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:10.672590 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m20:23:10.675576 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:23:11.482074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE05F4AF0>]}
[0m20:23:11.484074 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:23:11.486073 [info ] [MainThread]: 
[0m20:23:11.498079 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:23:11.499077 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:23:11.501071 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m20:23:11.501071 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:23:11.521071 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:23:11.522069 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:23:11.502072 => 20:23:11.521071
[0m20:23:11.522069 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:23:11.532084 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:23:12.379112 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:23:12.380114 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:23:13.159543 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:78b2d76f-865f-4752-af19-c466bf1d82cc&page=queryresults
[0m20:23:13.816674 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Bad double value: 59,99')
[0m20:23:15.181424 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e3446a3-4b65-4686-b28c-1ec8edc2189c&page=queryresults
[0m20:23:16.121005 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e3446a3-4b65-4686-b28c-1ec8edc2189c&page=queryresults
[0m20:23:16.122970 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:23:11.522069 => 20:23:16.122970
[0m20:23:16.131000 [debug] [Thread-1  ]: Database Error in model tb_produto (models\3.az\tb_produto.sql)
  Bad double value: 59,99
  compiled Code at target\run\shibaribrasil\models\3.az\tb_produto.sql
[0m20:23:16.131990 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f37d2b8-a4a5-40f9-9d2f-a15f1b391f50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE1AEE2E0>]}
[0m20:23:16.132994 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_produto ..................... [[31mERROR[0m in 4.63s]
[0m20:23:16.134993 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:23:16.137904 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:23:16.138904 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:23:16.140907 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:23:16.140907 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:23:16.141942 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:23:16.142903 [info ] [MainThread]: 
[0m20:23:16.143945 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.81 seconds (6.81s).
[0m20:23:16.145905 [debug] [MainThread]: Command end result
[0m20:23:16.172241 [info ] [MainThread]: 
[0m20:23:16.177240 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:23:16.179242 [info ] [MainThread]: 
[0m20:23:16.180236 [error] [MainThread]:   Database Error in model tb_produto (models\3.az\tb_produto.sql)
  Bad double value: 59,99
  compiled Code at target\run\shibaribrasil\models\3.az\tb_produto.sql
[0m20:23:16.182241 [info ] [MainThread]: 
[0m20:23:16.185613 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:23:16.190814 [debug] [MainThread]: Command `dbt run` failed at 20:23:16.189809 after 7.61 seconds
[0m20:23:16.192812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DDD006460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE0663520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023DE05FFF10>]}
[0m20:23:16.194807 [debug] [MainThread]: Flushing usage events
[0m20:23:21.192564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCF9BD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCE94F640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCE94FAC0>]}


============================== 20:23:21.196581 | b18ae720-a671-4058-9214-f00a79a3af30 ==============================
[0m20:23:21.196581 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:23:21.196581 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:23:21.664498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCE92C040>]}
[0m20:23:21.726397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD2F17760>]}
[0m20:23:21.728396 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:23:21.736396 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:23:21.811038 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:23:21.811038 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:23:21.816155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD32D5C40>]}
[0m20:23:21.825120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD31E6970>]}
[0m20:23:21.825120 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:23:21.826050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD31E69D0>]}
[0m20:23:21.827038 [info ] [MainThread]: 
[0m20:23:21.828037 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:23:21.829167 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:23:21.830038 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:22.490045 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:23:22.490948 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:22.490948 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:23:22.491944 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:23.107169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:23:23.107169 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:23:23.831898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD32E5F10>]}
[0m20:23:23.833903 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:23:23.834898 [info ] [MainThread]: 
[0m20:23:23.840981 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:23:23.842016 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m20:23:23.844030 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:23:23.845072 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:23:23.851008 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:23:23.852065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:23:23.845072 => 20:23:23.852065
[0m20:23:23.852065 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:23:23.874339 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:23:23.875341 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:23:23.876576 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m20:23:24.883283 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5a14503-eb43-4004-8634-15e5bc93561b&page=queryresults
[0m20:23:25.300247 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:23:23.852065 => 20:23:25.300247
[0m20:23:25.301247 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b18ae720-a671-4058-9214-f00a79a3af30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD439CD30>]}
[0m20:23:25.301247 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m20:23:25.302328 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:23:25.304342 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:23:25.305385 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:23:25.305385 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:23:25.306368 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:23:25.306368 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m20:23:25.306368 [info ] [MainThread]: 
[0m20:23:25.307667 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.48 seconds (3.48s).
[0m20:23:25.308673 [debug] [MainThread]: Command end result
[0m20:23:25.325680 [info ] [MainThread]: 
[0m20:23:25.325680 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:23:25.326672 [info ] [MainThread]: 
[0m20:23:25.327675 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:23:25.328674 [debug] [MainThread]: Command `dbt run` succeeded at 20:23:25.328674 after 4.19 seconds
[0m20:23:25.328674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCF9BD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCD6486D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BD2FD7F40>]}
[0m20:23:25.328674 [debug] [MainThread]: Flushing usage events
[0m20:23:40.495710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7276460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D61F99A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D61F9D30>]}


============================== 20:23:40.499708 | 23f3c2f7-183c-47ac-91c3-3af9429a5cf5 ==============================
[0m20:23:40.499708 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:23:40.499708 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:23:40.931969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D61E49D0>]}
[0m20:23:40.992970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DA7F5A30>]}
[0m20:23:40.993970 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:23:40.999970 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:23:41.046969 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:23:41.047971 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:23:41.051970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DAB878B0>]}
[0m20:23:41.059971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DAAC05B0>]}
[0m20:23:41.059971 [info ] [MainThread]: Found 9 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:23:41.061227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DAAC0580>]}
[0m20:23:41.061227 [info ] [MainThread]: 
[0m20:23:41.062281 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:23:41.064236 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:23:41.064236 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:41.747610 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:23:41.747610 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:41.770935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:23:41.770935 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:42.519905 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m20:23:42.520905 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:23:43.133319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DA95EEB0>]}
[0m20:23:43.134320 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:23:43.135320 [info ] [MainThread]: 
[0m20:23:43.139318 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:23:43.140320 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:23:43.140320 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m20:23:43.141320 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:23:43.156328 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:23:43.157322 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:23:43.141320 => 20:23:43.157322
[0m20:23:43.157322 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:23:43.176319 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:23:43.807061 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:23:43.808058 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:23:44.415607 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1646d74c-e984-4929-a94c-ae70869ff76a&page=queryresults
[0m20:23:46.937566 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:23:43.158319 => 20:23:46.937566
[0m20:23:46.937566 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '23f3c2f7-183c-47ac-91c3-3af9429a5cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DABFE850>]}
[0m20:23:46.938556 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.80s]
[0m20:23:46.939470 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:23:46.940472 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:23:46.941508 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:23:46.941508 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:23:46.942504 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:23:46.942504 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:23:46.942504 [info ] [MainThread]: 
[0m20:23:46.943471 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.88 seconds (5.88s).
[0m20:23:46.945470 [debug] [MainThread]: Command end result
[0m20:23:46.969548 [info ] [MainThread]: 
[0m20:23:46.970578 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:23:46.971609 [info ] [MainThread]: 
[0m20:23:46.973483 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:23:46.977469 [debug] [MainThread]: Command `dbt run` succeeded at 20:23:46.977469 after 6.54 seconds
[0m20:23:46.978592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7276460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DA7F5A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3DBC1FF10>]}
[0m20:23:46.979599 [debug] [MainThread]: Flushing usage events
[0m20:28:59.156394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278933AE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002789232F6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002789232FDC0>]}


============================== 20:28:59.161421 | 47d4aaca-bfc5-4ada-95fc-0be5725f204c ==============================
[0m20:28:59.161421 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:28:59.163407 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:28:59.653419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896A0CD30>]}
[0m20:28:59.711516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002789691BA30>]}
[0m20:28:59.713420 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:28:59.718523 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:28:59.788421 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m20:28:59.788421 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m20:28:59.892798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896D4DB50>]}
[0m20:28:59.901066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896CAAA30>]}
[0m20:28:59.902061 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:28:59.903062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896CAAFA0>]}
[0m20:28:59.904064 [info ] [MainThread]: 
[0m20:28:59.904967 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:28:59.906228 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:28:59.907335 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:00.736829 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:29:00.737734 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:00.739730 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:29:00.740731 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:01.409364 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m20:29:01.410361 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:29:02.077411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896A59D60>]}
[0m20:29:02.078451 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:29:02.080398 [info ] [MainThread]: 
[0m20:29:02.089749 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m20:29:02.090746 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m20:29:02.092740 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m20:29:02.093750 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m20:29:02.115197 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m20:29:02.121214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 20:29:02.094752 => 20:29:02.120203
[0m20:29:02.122195 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m20:29:02.156191 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m20:29:02.157190 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:29:02.158191 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_produto
order by cte_join_meta
    );
  
[0m20:29:03.332282 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0a19ab4-3119-4678-aac0-5c16ac82f5f4&page=queryresults
[0m20:29:03.741865 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cte_join_meta at [76:10]')
[0m20:29:04.947196 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:113cb639-1d27-457d-9c6b-e43d66600df0&page=queryresults
[0m20:29:05.399490 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:113cb639-1d27-457d-9c6b-e43d66600df0&page=queryresults
[0m20:29:05.401356 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 20:29:02.122195 => 20:29:05.400464
[0m20:29:05.408405 [debug] [Thread-1  ]: Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  Unrecognized name: cte_join_meta at [76:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m20:29:05.409438 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '47d4aaca-bfc5-4ada-95fc-0be5725f204c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027897EC17F0>]}
[0m20:29:05.410440 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_preco_produto ............... [[31mERROR[0m in 3.32s]
[0m20:29:05.411859 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m20:29:05.415974 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:29:05.416887 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:29:05.417884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:29:05.418880 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:29:05.418880 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m20:29:05.419881 [info ] [MainThread]: 
[0m20:29:05.420878 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.51 seconds (5.51s).
[0m20:29:05.422884 [debug] [MainThread]: Command end result
[0m20:29:05.438894 [info ] [MainThread]: 
[0m20:29:05.440139 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:29:05.440139 [info ] [MainThread]: 
[0m20:29:05.441199 [error] [MainThread]:   Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  Unrecognized name: cte_join_meta at [76:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m20:29:05.441199 [info ] [MainThread]: 
[0m20:29:05.442181 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:29:05.445183 [debug] [MainThread]: Command `dbt run` failed at 20:29:05.444162 after 6.38 seconds
[0m20:29:05.446156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000278933AE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002789691BA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027896BD6820>]}
[0m20:29:05.447148 [debug] [MainThread]: Flushing usage events
[0m20:29:24.920998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C6F06460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C5E809D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C5E80B80>]}


============================== 20:29:24.925000 | 4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88 ==============================
[0m20:29:24.925000 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:29:24.925404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_preco_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:29:25.374219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C5E7E8E0>]}
[0m20:29:25.434820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA445B80>]}
[0m20:29:25.435920 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:29:25.441918 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:29:25.541628 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:29:25.541628 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m20:29:25.641464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA9538E0>]}
[0m20:29:25.650451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA7340A0>]}
[0m20:29:25.651468 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:29:25.651468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA5081F0>]}
[0m20:29:25.652450 [info ] [MainThread]: 
[0m20:29:25.653452 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:29:25.655452 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:29:25.655452 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:26.434069 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:29:26.436087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:26.438087 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m20:29:26.439076 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:27.103499 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m20:29:27.104499 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:29:28.011188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA7FCC70>]}
[0m20:29:28.013167 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:29:28.015166 [info ] [MainThread]: 
[0m20:29:28.033167 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m20:29:28.035169 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m20:29:28.038173 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m20:29:28.040160 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m20:29:28.051252 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m20:29:28.052172 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 20:29:28.040160 => 20:29:28.052172
[0m20:29:28.052172 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m20:29:28.080256 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m20:29:28.081259 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:29:28.083159 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m20:29:29.146245 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:64bb1db5-7460-4eb0-b9dd-ee27240f2852&page=queryresults
[0m20:29:31.773555 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 20:29:28.052172 => 20:29:31.772647
[0m20:29:31.774647 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4ff6d00d-c707-4fe6-aab2-f5cfe1db8e88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CBA0A190>]}
[0m20:29:31.775154 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 3.74s]
[0m20:29:31.777190 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m20:29:31.779239 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:29:31.779239 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:29:31.780242 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m20:29:31.780242 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:29:31.780242 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m20:29:31.780242 [info ] [MainThread]: 
[0m20:29:31.781442 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.13 seconds (6.13s).
[0m20:29:31.782455 [debug] [MainThread]: Command end result
[0m20:29:31.789456 [info ] [MainThread]: 
[0m20:29:31.790448 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:29:31.790968 [info ] [MainThread]: 
[0m20:29:31.791978 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:29:31.792255 [debug] [MainThread]: Command `dbt run` succeeded at 20:29:31.792255 after 6.92 seconds
[0m20:29:31.793263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C6F06460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA61A640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA832970>]}
[0m20:29:31.793263 [debug] [MainThread]: Flushing usage events
[0m21:00:03.995043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D1377430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D02FC640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D02FCAC0>]}


============================== 21:00:03.998820 | b4de6e62-0463-4b6b-9b05-76a6594f06b5 ==============================
[0m21:00:03.998820 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:03.999527 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:00:04.517638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D02FC850>]}
[0m21:00:04.580510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D48D6B80>]}
[0m21:00:04.581515 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:04.587516 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:04.671909 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:04.672830 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:04.676413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4C98160>]}
[0m21:00:04.685424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4C7BBE0>]}
[0m21:00:04.686424 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:04.687048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4C7BC40>]}
[0m21:00:04.689057 [info ] [MainThread]: 
[0m21:00:04.689600 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:04.691650 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.691650 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:04.692607 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.692607 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:05.579706 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:06.282062 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:00:06.283006 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.286088 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:00:06.286998 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.949213 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:00:06.950213 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:07.928367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4CC8550>]}
[0m21:00:07.929462 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:07.931070 [info ] [MainThread]: 
[0m21:00:07.941097 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:07.943094 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.942097 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m21:00:07.947097 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m21:00:07.948122 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:07.956908 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:07.945117 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m21:00:07.957993 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:00:07.957993 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.961000 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.963914 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:00:07.959021 => 21:00:07.962925
[0m21:00:07.964882 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.987960 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 21:00:07.948122 => 21:00:07.987960
[0m21:00:07.988908 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:07.991904 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:07.997905 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.998967 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:07.999883 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m21:00:08.020982 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:00:08.022905 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:00:08.838196 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8eb53d17-69c4-4f15-9c2c-06aa5804c13c&page=queryresults
[0m21:00:08.867158 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9b3851a9-b160-47dc-8370-e141581cb5c0&page=queryresults
[0m21:00:09.297842 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:00:07.964882 => 21:00:09.297842
[0m21:00:09.298847 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4CC87C0>]}
[0m21:00:09.301752 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 21:00:07.988908 => 21:00:09.301752
[0m21:00:09.301752 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4CE3820>]}
[0m21:00:09.299749 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m21:00:09.303790 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.303790 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:00:09.302753 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m21:00:09.304874 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.304874 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m21:00:09.303790 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m21:00:09.306920 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m21:00:09.306920 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:00:09.308985 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:09.305965 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m21:00:09.310930 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m21:00:09.310930 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m21:00:09.313979 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:09.314883 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:00:09.306920 => 21:00:09.314883
[0m21:00:09.314883 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:00:09.316983 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:09.317979 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 21:00:09.310930 => 21:00:09.317979
[0m21:00:09.317979 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m21:00:09.319976 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:09.320952 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:09.321927 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m21:00:09.343500 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:09.345531 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:00:10.042004 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6b55e75f-cf0e-4596-9d07-d728440f065b&page=queryresults
[0m21:00:10.086457 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fdd2f6fe-c3bd-405f-9601-64e7e582ae5c&page=queryresults
[0m21:00:10.483012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 21:00:09.317979 => 21:00:10.482009
[0m21:00:10.485010 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4D3CCA0>]}
[0m21:00:10.491114 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:00:09.314883 => 21:00:10.491114
[0m21:00:10.486014 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m21:00:10.493006 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D5D69970>]}
[0m21:00:10.495010 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m21:00:10.498016 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:10.497107 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m21:00:10.500953 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:00:10.500953 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m21:00:10.499012 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m21:00:10.504952 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m21:00:10.505951 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:10.511948 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:10.501950 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m21:00:10.513950 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m21:00:10.515593 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:00:10.530606 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:00:10.531607 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 21:00:10.505951 => 21:00:10.531607
[0m21:00:10.532608 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:10.538707 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:10.540615 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:00:10.515593 => 21:00:10.540615
[0m21:00:10.541633 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:00:10.546606 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:00:10.547610 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:10.549604 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m21:00:10.575089 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:10.577093 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:00:11.360042 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a39a16a-2391-4d56-9a03-9b53eb2caf7b&page=queryresults
[0m21:00:11.397552 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98d6dd28-aeff-4747-8efd-bab7d2e44ac6&page=queryresults
[0m21:00:11.745416 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:00:10.542619 => 21:00:11.745416
[0m21:00:11.746416 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D5DD0D90>]}
[0m21:00:11.747429 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m21:00:11.749439 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:00:11.750804 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m21:00:11.751927 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m21:00:11.752823 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m21:00:11.753925 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:00:11.759930 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:00:11.760924 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:00:11.753925 => 21:00:11.760924
[0m21:00:11.761863 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:00:11.770911 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:12.066165 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 21:00:10.533715 => 21:00:12.065161
[0m21:00:12.067169 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D5DA0BE0>]}
[0m21:00:12.069168 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m21:00:12.071168 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:12.446414 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:00:12.447416 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:00:13.069156 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86c29de0-4827-41e1-9d94-f113ae417cc5&page=queryresults
[0m21:00:15.570338 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:00:11.761863 => 21:00:15.570338
[0m21:00:15.572252 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D5E0A070>]}
[0m21:00:15.573253 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.82s]
[0m21:00:15.575300 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:00:15.577322 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m21:00:15.578304 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m21:00:15.580255 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.tb_produto)
[0m21:00:15.581248 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:00:15.589252 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:00:15.591255 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:00:15.582251 => 21:00:15.591255
[0m21:00:15.592246 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:00:15.600672 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:16.278528 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:00:16.281522 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m21:00:17.041572 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:962b00e4-5e88-4d7d-a277-539dfc384d01&page=queryresults
[0m21:00:25.391155 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:00:15.593255 => 21:00:25.390154
[0m21:00:25.392157 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D5D23130>]}
[0m21:00:25.394155 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 9.81s]
[0m21:00:25.396157 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:00:25.398154 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:00:25.399436 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m21:00:25.398154 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m21:00:25.401989 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:00:25.402980 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:00:25.406973 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:25.400449 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m21:00:25.409014 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m21:00:25.409014 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m21:00:25.412978 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:25.414981 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:00:25.402980 => 21:00:25.414038
[0m21:00:25.414981 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:00:25.416973 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:25.438650 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 21:00:25.409014 => 21:00:25.438650
[0m21:00:25.438650 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m21:00:25.440664 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:26.241188 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:26.246201 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:26.247199 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m21:00:26.252102 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:00:26.826873 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e63f9922-4a14-43d5-837f-b8d93c3e2c9a&page=queryresults
[0m21:00:26.908473 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97f9774e-f650-4c4f-9478-b3a5596038d9&page=queryresults
[0m21:00:29.123146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:00:25.414981 => 21:00:29.122207
[0m21:00:29.124236 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4D1EC10>]}
[0m21:00:29.126234 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.72s]
[0m21:00:29.128237 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:00:29.702772 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 21:00:25.438650 => 21:00:29.701771
[0m21:00:29.704768 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4de6e62-0463-4b6b-9b05-76a6594f06b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4D1EC70>]}
[0m21:00:29.706770 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.30s]
[0m21:00:29.709092 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m21:00:29.715573 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:00:29.716571 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:29.717508 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:29.718516 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:00:29.719507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:00:29.719507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m21:00:29.719507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:00:29.720499 [info ] [MainThread]: 
[0m21:00:29.721518 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 25.03 seconds (25.03s).
[0m21:00:29.725499 [debug] [MainThread]: Command end result
[0m21:00:29.740497 [info ] [MainThread]: 
[0m21:00:29.741506 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:00:29.742513 [info ] [MainThread]: 
[0m21:00:29.743507 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m21:00:29.744532 [debug] [MainThread]: Command `dbt run` succeeded at 21:00:29.744532 after 25.80 seconds
[0m21:00:29.744532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D1377430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6D4AA2670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6CF0076D0>]}
[0m21:00:29.745521 [debug] [MainThread]: Flushing usage events
[0m22:00:06.687730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF148C23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF138479D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF13847B80>]}


============================== 22:00:06.699663 | aa715a32-3d82-4024-b846-0ac88b9a7689 ==============================
[0m22:00:06.699663 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:00:06.701687 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m22:00:08.013416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF16A05BE0>]}
[0m22:00:08.074270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF13847BE0>]}
[0m22:00:08.076718 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:00:08.084721 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:00:08.169933 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:08.169933 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:08.174020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF181D5F10>]}
[0m22:00:08.186538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF180EAD00>]}
[0m22:00:08.186538 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:00:08.187533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF180EAEE0>]}
[0m22:00:08.189534 [info ] [MainThread]: 
[0m22:00:08.190552 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:00:08.193535 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:08.194536 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:08.195843 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:08.195843 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:09.056438 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:09.952230 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:00:09.953232 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:09.955234 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:00:09.957016 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:10.781583 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:00:10.784679 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:11.501462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF17F82490>]}
[0m22:00:11.503479 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:00:11.505470 [info ] [MainThread]: 
[0m22:00:11.513427 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:11.514423 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m22:00:11.515427 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m22:00:11.518222 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:00:11.518222 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:11.533098 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:00:11.516083 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m22:00:11.535139 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m22:00:11.535632 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m22:00:11.544706 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:11.546675 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:00:11.519232 => 22:00:11.545700
[0m22:00:11.547674 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:11.596759 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 22:00:11.536643 => 22:00:11.596759
[0m22:00:11.602775 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m22:00:11.608709 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:11.618510 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:00:11.620510 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m22:00:11.624473 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:00:11.625500 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m22:00:11.675736 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m22:00:12.555099 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c0ce881-8cd6-4db2-ad28-946195e85eef&page=queryresults
[0m22:00:12.556017 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c363e5df-c1dc-4a73-b75b-1a167f77c9b4&page=queryresults
[0m22:00:13.026479 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:00:11.548681 => 22:00:13.026479
[0m22:00:13.034422 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 22:00:11.603771 => 22:00:13.033418
[0m22:00:13.036137 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF18227940>]}
[0m22:00:13.038205 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF1825CA90>]}
[0m22:00:13.040203 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m22:00:13.042158 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:13.041193 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m22:00:13.043197 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m22:00:13.044198 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m22:00:13.046201 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m22:00:13.045199 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m22:00:13.049204 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m22:00:13.047207 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m22:00:13.050202 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m22:00:13.051207 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m22:00:13.059100 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:13.060100 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m22:00:13.065116 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m22:00:13.066114 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 22:00:13.052159 => 22:00:13.066114
[0m22:00:13.066975 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m22:00:13.069091 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:13.070090 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 22:00:13.060100 => 22:00:13.070090
[0m22:00:13.070984 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m22:00:13.073033 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m22:00:13.074093 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:13.075412 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:13.075412 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:00:13.120435 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m22:00:13.921574 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7fd2e75-2653-40d6-a651-c3aac026d2eb&page=queryresults
[0m22:00:13.927557 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:29570cc7-2a18-48e4-a188-b4ad0918e633&page=queryresults
[0m22:00:14.317901 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 22:00:13.066975 => 22:00:14.316899
[0m22:00:14.321906 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF1933EAF0>]}
[0m22:00:14.330904 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 22:00:13.070984 => 22:00:14.330904
[0m22:00:14.324907 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m22:00:14.332906 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF1929E3A0>]}
[0m22:00:14.333918 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m22:00:14.335654 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:14.334908 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m22:00:14.338769 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m22:00:14.336757 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m22:00:14.339767 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m22:00:14.341671 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m22:00:14.343676 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:14.342672 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m22:00:14.348757 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m22:00:14.349763 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m22:00:14.351700 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m22:00:14.357172 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 22:00:14.343676 => 22:00:14.356164
[0m22:00:14.360172 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:14.370211 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m22:00:14.382438 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:14.396254 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m22:00:14.399338 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m22:00:14.458122 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 22:00:14.352761 => 22:00:14.457161
[0m22:00:14.459106 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m22:00:14.462095 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m22:00:14.464157 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:14.466090 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m22:00:15.183473 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79713517-9c69-413f-9ef4-83d64a744aaa&page=queryresults
[0m22:00:15.243918 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42f3f953-ea85-4c81-86d7-875b06b4e2dd&page=queryresults
[0m22:00:15.596190 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 22:00:14.360172 => 22:00:15.595624
[0m22:00:15.597248 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF1933E1C0>]}
[0m22:00:15.598291 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m22:00:15.599284 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:15.784741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 22:00:14.459106 => 22:00:15.784741
[0m22:00:15.786749 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF17F82FA0>]}
[0m22:00:15.787743 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m22:00:15.790741 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m22:00:15.792740 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m22:00:15.792740 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m22:00:15.793748 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m22:00:15.794742 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m22:00:15.802709 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m22:00:15.806677 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 22:00:15.794742 => 22:00:15.805713
[0m22:00:15.807711 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m22:00:15.827675 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:16.795499 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m22:00:16.797530 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m22:00:17.460892 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:54e30837-d3e3-4f47-9043-3be661542e10&page=queryresults
[0m22:00:19.988384 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 22:00:15.807711 => 22:00:19.987385
[0m22:00:19.990383 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF17F82FA0>]}
[0m22:00:19.992388 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.20s]
[0m22:00:19.996272 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m22:00:19.999298 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m22:00:20.000299 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m22:00:20.003415 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m22:00:20.004420 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m22:00:20.015419 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m22:00:20.018467 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 22:00:20.004420 => 22:00:20.017564
[0m22:00:20.019520 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m22:00:20.026507 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:20.706770 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m22:00:20.709762 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m22:00:21.447279 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fcccb2f3-4da2-4f67-a2fb-8b53d2d34716&page=queryresults
[0m22:00:23.789719 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 22:00:20.020568 => 22:00:23.788720
[0m22:00:23.791725 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF1931D550>]}
[0m22:00:23.793714 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.79s]
[0m22:00:23.795722 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m22:00:23.796326 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m22:00:23.797660 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m22:00:23.799743 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m22:00:23.803689 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m22:00:23.804689 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m22:00:23.800759 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m22:00:23.812735 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m22:00:23.812735 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m22:00:23.816574 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:23.824652 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m22:00:23.828635 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 22:00:23.805687 => 22:00:23.827638
[0m22:00:23.829599 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m22:00:23.831591 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 22:00:23.817647 => 22:00:23.830593
[0m22:00:23.837213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:23.838212 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m22:00:23.846221 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:24.530262 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:24.534175 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m22:00:24.541700 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m22:00:24.543710 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m22:00:25.240999 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42ddd5a2-6dd4-4600-8f36-1b83f1be018f&page=queryresults
[0m22:00:25.249000 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4cb11e0b-15c0-4702-8400-d6a0df895474&page=queryresults
[0m22:00:27.810100 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 22:00:23.832599 => 22:00:27.809099
[0m22:00:27.813095 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF192E0640>]}
[0m22:00:27.815111 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.01s]
[0m22:00:27.818105 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m22:00:28.712306 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 22:00:23.838212 => 22:00:28.711264
[0m22:00:28.714358 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa715a32-3d82-4024-b846-0ac88b9a7689', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF192FB220>]}
[0m22:00:28.715815 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.90s]
[0m22:00:28.717860 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m22:00:28.722855 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:00:28.724896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:28.724896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:28.725867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:00:28.726934 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:00:28.726934 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m22:00:28.727874 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m22:00:28.728856 [info ] [MainThread]: 
[0m22:00:28.729889 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 20.54 seconds (20.54s).
[0m22:00:28.733858 [debug] [MainThread]: Command end result
[0m22:00:28.753906 [info ] [MainThread]: 
[0m22:00:28.754862 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:00:28.754862 [info ] [MainThread]: 
[0m22:00:28.755880 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m22:00:28.757371 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:28.756320 after 22.18 seconds
[0m22:00:28.757371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF148C23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF17E44FA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FF17F93E50>]}
[0m22:00:28.758380 [debug] [MainThread]: Flushing usage events
[0m23:00:05.250531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3AD74460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA39D1F730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA39D1FE50>]}


============================== 23:00:05.258248 | 1c991349-d12e-4a8f-90f3-ed07bc13de6b ==============================
[0m23:00:05.258248 [info ] [MainThread]: Running with dbt=1.7.4
[0m23:00:05.259199 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m23:00:06.117669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA39D0B880>]}
[0m23:00:06.179930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E2D3B80>]}
[0m23:00:06.181579 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m23:00:06.190593 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m23:00:06.244776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:00:06.244776 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:00:06.248805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E6A5F10>]}
[0m23:00:06.261169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E5BF220>]}
[0m23:00:06.262169 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m23:00:06.262943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E5BFF70>]}
[0m23:00:06.264987 [info ] [MainThread]: 
[0m23:00:06.265953 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:00:06.268238 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:06.268238 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:06.269246 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:06.269246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:07.049181 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:07.705244 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m23:00:07.706250 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:07.707251 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m23:00:07.708284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:08.374836 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m23:00:08.376728 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:09.050174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E723AF0>]}
[0m23:00:09.051231 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:00:09.052195 [info ] [MainThread]: 
[0m23:00:09.058947 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:09.059927 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m23:00:09.061590 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m23:00:09.063961 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m23:00:09.062820 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m23:00:09.064966 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:09.065956 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m23:00:09.075657 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:09.075657 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m23:00:09.077791 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:09.079808 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 23:00:09.076794 => 23:00:09.078796
[0m23:00:09.079808 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m23:00:09.079808 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 23:00:09.066953 => 23:00:09.079808
[0m23:00:09.097761 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:09.100759 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:09.104764 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:09.105776 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m23:00:09.107674 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m23:00:09.132564 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m23:00:09.134531 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m23:00:09.944328 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84cdabce-9b30-4f52-95d6-3170eb0e7407&page=queryresults
[0m23:00:10.181138 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:385120e6-08df-4f9c-a73c-0ca1d2e54fe3&page=queryresults
[0m23:00:10.408957 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 23:00:09.097761 => 23:00:10.408957
[0m23:00:10.408957 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E6F2790>]}
[0m23:00:10.409959 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m23:00:10.410952 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:10.410952 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m23:00:10.411955 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m23:00:10.412959 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m23:00:10.412959 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m23:00:10.416721 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:10.417722 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 23:00:10.412959 => 23:00:10.417722
[0m23:00:10.418604 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m23:00:10.422723 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:10.425912 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:10.427916 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m23:00:10.637355 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 23:00:09.080732 => 23:00:10.637355
[0m23:00:10.638358 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E732FD0>]}
[0m23:00:10.639356 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m23:00:10.640356 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m23:00:10.641264 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m23:00:10.642255 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m23:00:10.643258 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m23:00:10.644350 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m23:00:10.650354 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m23:00:10.651355 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 23:00:10.644350 => 23:00:10.651355
[0m23:00:10.652364 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m23:00:10.655344 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m23:00:10.657241 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:10.658356 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m23:00:11.318280 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:999e264c-30e7-4f16-8b77-ea3b56916cb3&page=queryresults
[0m23:00:11.612260 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:703b0da5-d8f6-480c-8b58-de9df22d45f4&page=queryresults
[0m23:00:11.739174 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 23:00:10.418604 => 23:00:11.739174
[0m23:00:11.741309 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E68BF40>]}
[0m23:00:11.742304 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m23:00:11.744218 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m23:00:11.744218 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:11.745284 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m23:00:11.746271 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m23:00:11.747265 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:11.750262 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m23:00:11.751269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 23:00:11.747265 => 23:00:11.751269
[0m23:00:11.751269 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:11.760982 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m23:00:11.761983 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:11.763981 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m23:00:12.047836 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 23:00:10.652364 => 23:00:12.046837
[0m23:00:12.048843 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E73AAF0>]}
[0m23:00:12.049788 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m23:00:12.052308 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m23:00:12.052308 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m23:00:12.053309 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m23:00:12.054310 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m23:00:12.055312 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m23:00:12.068982 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m23:00:12.075690 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 23:00:12.056310 => 23:00:12.073981
[0m23:00:12.078632 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m23:00:12.092535 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m23:00:12.094539 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:12.100706 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m23:00:12.567489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6b7f17a9-7ac6-4812-acbf-ee025d59ff22&page=queryresults
[0m23:00:12.912304 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6c84311-ad47-4577-b328-fb0bf1bea58f&page=queryresults
[0m23:00:12.974967 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 23:00:11.751269 => 23:00:12.973982
[0m23:00:12.974967 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E68BF40>]}
[0m23:00:12.976359 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m23:00:12.977262 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:13.322447 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 23:00:12.079633 => 23:00:13.321445
[0m23:00:13.323446 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E46E550>]}
[0m23:00:13.324446 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m23:00:13.325446 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m23:00:13.326446 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m23:00:13.327624 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m23:00:13.328636 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m23:00:13.329637 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m23:00:13.334637 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m23:00:13.337131 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 23:00:13.329637 => 23:00:13.335637
[0m23:00:13.337640 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m23:00:13.351742 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:14.052026 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m23:00:14.053927 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m23:00:14.692667 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7b9f0bdd-e625-40e3-b473-2e2baa8e6ab0&page=queryresults
[0m23:00:17.582151 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 23:00:13.337640 => 23:00:17.581150
[0m23:00:17.583148 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E732220>]}
[0m23:00:17.584148 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.25s]
[0m23:00:17.585148 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m23:00:17.587149 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m23:00:17.587149 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m23:00:17.589152 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m23:00:17.589152 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m23:00:17.596149 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m23:00:17.598980 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 23:00:17.590150 => 23:00:17.598470
[0m23:00:17.598980 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m23:00:17.605886 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:18.310848 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m23:00:18.312745 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m23:00:19.003205 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58c54049-b164-4aa6-8d96-3b02804ae232&page=queryresults
[0m23:00:21.852051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 23:00:17.599777 => 23:00:21.852051
[0m23:00:21.854056 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E732C70>]}
[0m23:00:21.855046 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.27s]
[0m23:00:21.857063 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m23:00:21.859117 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m23:00:21.860156 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m23:00:21.859117 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m23:00:21.863064 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m23:00:21.864063 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m23:00:21.870059 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:21.861061 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m23:00:21.871080 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m23:00:21.872110 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m23:00:21.876575 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m23:00:21.878481 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 23:00:21.864063 => 23:00:21.878481
[0m23:00:21.879475 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m23:00:21.882473 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:21.925105 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 23:00:21.872110 => 23:00:21.925105
[0m23:00:21.926200 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m23:00:21.929194 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:22.668465 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:22.671461 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m23:00:22.770995 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m23:00:22.773887 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m23:00:23.359339 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d509263e-ae5e-4bd2-96f3-3d87c594c6f8&page=queryresults
[0m23:00:23.417335 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e5a9ad4f-e865-40cd-bbc2-a762b08773c7&page=queryresults
[0m23:00:25.840656 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 23:00:21.879475 => 23:00:25.839656
[0m23:00:25.841661 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3F834970>]}
[0m23:00:25.842657 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.98s]
[0m23:00:25.843558 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m23:00:26.217913 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 23:00:21.926200 => 23:00:26.216803
[0m23:00:26.218915 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c991349-d12e-4a8f-90f3-ed07bc13de6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3F834430>]}
[0m23:00:26.219918 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.35s]
[0m23:00:26.221819 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m23:00:26.224818 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:26.225819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:26.225819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:26.226919 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m23:00:26.226919 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m23:00:26.227918 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m23:00:26.227918 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m23:00:26.228912 [info ] [MainThread]: 
[0m23:00:26.229819 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.96 seconds (19.96s).
[0m23:00:26.233917 [debug] [MainThread]: Command end result
[0m23:00:26.262258 [info ] [MainThread]: 
[0m23:00:26.263312 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:00:26.264260 [info ] [MainThread]: 
[0m23:00:26.265261 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m23:00:26.267261 [debug] [MainThread]: Command `dbt run` succeeded at 23:00:26.267261 after 21.08 seconds
[0m23:00:26.268260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3AD74460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E31C640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BA3E399070>]}
[0m23:00:26.268260 [debug] [MainThread]: Flushing usage events
[0m00:00:04.895882 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E80D23460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E837C5640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E837C5AC0>]}


============================== 00:00:04.900894 | bde18e01-6748-42fe-a6f3-8096ef3cbe55 ==============================
[0m00:00:04.900894 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:00:04.900894 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:00:05.591462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E837C5850>]}
[0m00:00:05.677391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E8443C9A0>]}
[0m00:00:05.679390 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:00:05.688391 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:00:05.744467 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:00:05.744467 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:00:05.749470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E847B5AF0>]}
[0m00:00:05.758215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E846D5760>]}
[0m00:00:05.759217 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:00:05.760250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E846D5850>]}
[0m00:00:05.762236 [info ] [MainThread]: 
[0m00:00:05.762236 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:00:05.764213 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.765213 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:05.765213 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.766245 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:06.665037 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:07.457477 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m00:00:07.458481 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.459482 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m00:00:07.459482 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:08.091983 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m00:00:08.091983 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:08.732285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E844911C0>]}
[0m00:00:08.733284 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:00:08.734282 [info ] [MainThread]: 
[0m00:00:08.738659 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.739686 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.740733 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m00:00:08.741731 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m00:00:08.740733 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m00:00:08.741731 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.742728 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m00:00:08.749665 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.750640 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.753652 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.755080 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 00:00:08.742728 => 00:00:08.755080
[0m00:00:08.755080 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.777969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 00:00:08.750640 => 00:00:08.777969
[0m00:00:08.779011 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.784970 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.788970 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.790971 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m00:00:08.791971 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:00:08.794002 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m00:00:08.816315 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m00:00:09.621460 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7b26917-7c97-4e85-9c04-bb9cf1ff53e4&page=queryresults
[0m00:00:09.628251 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e89c505f-f2e1-4b09-b872-ee93ad54ef81&page=queryresults
[0m00:00:10.060437 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 00:00:08.756136 => 00:00:10.060437
[0m00:00:10.061495 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E844911C0>]}
[0m00:00:10.062493 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m00:00:10.063493 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:10.064509 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.064509 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m00:00:10.065493 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m00:00:10.066494 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.069494 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.071359 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 00:00:10.066494 => 00:00:10.070491
[0m00:00:10.071359 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.075409 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.076092 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:10.078154 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m00:00:10.105102 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 00:00:08.780968 => 00:00:10.104101
[0m00:00:10.106102 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E84810B20>]}
[0m00:00:10.107126 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m00:00:10.108120 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m00:00:10.108120 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m00:00:10.109134 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m00:00:10.110101 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m00:00:10.110101 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m00:00:10.114121 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m00:00:10.115119 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 00:00:10.111126 => 00:00:10.115119
[0m00:00:10.116118 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m00:00:10.118387 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m00:00:10.119410 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:10.121396 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m00:00:10.872703 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de71b787-414e-4948-99a6-0fa2b4493703&page=queryresults
[0m00:00:10.876377 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ff48203-d5fa-4913-bd42-b321c596e022&page=queryresults
[0m00:00:11.262572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 00:00:10.071359 => 00:00:11.262572
[0m00:00:11.262572 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E8592B8B0>]}
[0m00:00:11.263564 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m00:00:11.263564 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m00:00:11.264562 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.264562 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m00:00:11.265561 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m00:00:11.265561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.268560 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:11.269548 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 00:00:11.265561 => 00:00:11.268560
[0m00:00:11.269548 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.276622 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:11.280775 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 00:00:10.116118 => 00:00:11.279791
[0m00:00:11.281762 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E8457F340>]}
[0m00:00:11.281762 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m00:00:11.282763 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m00:00:11.283771 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m00:00:11.283771 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:11.284687 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m00:00:11.285751 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m00:00:11.285751 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m00:00:11.289658 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m00:00:11.291663 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m00:00:11.316898 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 00:00:11.285751 => 00:00:11.315858
[0m00:00:11.316898 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m00:00:11.320881 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m00:00:11.321882 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:11.323882 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m00:00:11.986224 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60ac22b4-9565-4010-8fc1-2d90f667bb25&page=queryresults
[0m00:00:12.033029 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:738a7f3c-d9e4-448f-b704-061ac87eb0d8&page=queryresults
[0m00:00:12.359694 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 00:00:11.269548 => 00:00:12.359694
[0m00:00:12.361682 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E85859FD0>]}
[0m00:00:12.362695 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m00:00:12.363705 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:12.419349 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 00:00:11.317864 => 00:00:12.419349
[0m00:00:12.420346 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E847B5BB0>]}
[0m00:00:12.421359 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m00:00:12.423249 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m00:00:12.424241 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m00:00:12.425232 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m00:00:12.427216 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m00:00:12.428218 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m00:00:12.432325 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m00:00:12.433307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 00:00:12.428218 => 00:00:12.433307
[0m00:00:12.434245 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m00:00:12.442944 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:13.272375 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m00:00:13.274359 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m00:00:13.961083 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66b0efc9-a318-4400-94bb-4b539a439309&page=queryresults
[0m00:00:16.438331 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 00:00:12.434245 => 00:00:16.437326
[0m00:00:16.439328 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E847B5A00>]}
[0m00:00:16.439328 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.01s]
[0m00:00:16.440329 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m00:00:16.441240 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m00:00:16.442344 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m00:00:16.442344 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m00:00:16.443333 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m00:00:16.447332 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m00:00:16.448331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 00:00:16.443333 => 00:00:16.448331
[0m00:00:16.449338 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m00:00:16.457208 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:17.072983 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m00:00:17.074979 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m00:00:17.776326 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2d62aa7-2c9a-4ece-831b-d7a912f8bd54&page=queryresults
[0m00:00:20.051023 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 00:00:16.449338 => 00:00:20.051023
[0m00:00:20.053019 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E8585D460>]}
[0m00:00:20.054018 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.61s]
[0m00:00:20.055018 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m00:00:20.056041 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m00:00:20.057048 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m00:00:20.058049 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m00:00:20.059048 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m00:00:20.060106 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m00:00:20.064069 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:20.058049 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m00:00:20.066063 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m00:00:20.067048 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m00:00:20.072050 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m00:00:20.073048 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 00:00:20.060106 => 00:00:20.073048
[0m00:00:20.074075 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m00:00:20.076701 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:20.077734 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 00:00:20.067048 => 00:00:20.077734
[0m00:00:20.078723 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m00:00:20.081729 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:20.729231 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:20.732227 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m00:00:20.743623 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m00:00:20.745633 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m00:00:21.324042 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:17c2c0e2-186f-43f2-bdd3-819032bb077a&page=queryresults
[0m00:00:21.324958 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b90f431e-d694-44ed-99f7-e2ae2ba63a6f&page=queryresults
[0m00:00:23.509952 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 00:00:20.074075 => 00:00:23.509952
[0m00:00:23.510945 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E84848F70>]}
[0m00:00:23.510945 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.45s]
[0m00:00:23.511968 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m00:00:24.162349 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 00:00:20.078723 => 00:00:24.162349
[0m00:00:24.164358 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bde18e01-6748-42fe-a6f3-8096ef3cbe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E8584F640>]}
[0m00:00:24.165348 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.10s]
[0m00:00:24.166248 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m00:00:24.169354 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:00:24.170351 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.171351 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.172353 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m00:00:24.172353 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m00:00:24.173349 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m00:00:24.174347 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m00:00:24.174347 [info ] [MainThread]: 
[0m00:00:24.175297 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 18.41 seconds (18.41s).
[0m00:00:24.178956 [debug] [MainThread]: Command end result
[0m00:00:24.203895 [info ] [MainThread]: 
[0m00:00:24.204405 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:00:24.205419 [info ] [MainThread]: 
[0m00:00:24.207080 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m00:00:24.209315 [debug] [MainThread]: Command `dbt run` succeeded at 00:00:24.209315 after 19.37 seconds
[0m00:00:24.210312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E80D23460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E85902D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E858537C0>]}
[0m00:00:24.210312 [debug] [MainThread]: Flushing usage events
[0m01:00:15.769920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6706AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F66F628730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F66F628E50>]}


============================== 01:00:15.778879 | 2f90a6cf-b010-4f08-bee8-b74bd0dd62fe ==============================
[0m01:00:15.778879 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:00:15.780876 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:00:16.977466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F66F62A1C0>]}
[0m01:00:17.034466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673D30B20>]}
[0m01:00:17.036371 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:00:17.068262 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:00:20.530013 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:00:20.531015 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:00:20.534017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673FD5EE0>]}
[0m01:00:20.577319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673EEF220>]}
[0m01:00:20.578301 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:00:20.579584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673C4A5E0>]}
[0m01:00:20.582111 [info ] [MainThread]: 
[0m01:00:20.584111 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:00:20.587120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:20.589114 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:20.590111 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:20.590111 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:21.496753 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:22.456234 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:00:22.457379 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m01:00:22.458375 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:22.459372 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:23.134380 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m01:00:23.135383 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:23.791130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673C9F880>]}
[0m01:00:23.792129 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:00:23.793126 [info ] [MainThread]: 
[0m01:00:23.800209 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:23.801202 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m01:00:23.802209 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m01:00:23.805106 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m01:00:23.806104 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:23.804103 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m01:00:23.816950 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:23.816950 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m01:00:23.817946 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m01:00:23.819945 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:23.820943 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 01:00:23.806104 => 01:00:23.820943
[0m01:00:23.820943 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:23.841818 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 01:00:23.817946 => 01:00:23.841818
[0m01:00:23.842817 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m01:00:23.848236 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:23.852249 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:23.854248 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:00:23.855259 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:00:23.856306 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m01:00:23.878067 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m01:00:24.798775 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f70b4140-f7e1-4bb0-996e-99e0d6a66b81&page=queryresults
[0m01:00:24.874412 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c4eba0b-7c03-45d4-977f-d81596bf1b3a&page=queryresults
[0m01:00:25.262878 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 01:00:23.821944 => 01:00:25.262878
[0m01:00:25.262878 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673D85310>]}
[0m01:00:25.263879 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m01:00:25.264398 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.264398 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m01:00:25.265409 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m01:00:25.265409 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m01:00:25.265409 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m01:00:25.267409 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:25.268409 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 01:00:25.265409 => 01:00:25.268409
[0m01:00:25.268409 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m01:00:25.271410 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:25.271410 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:25.272410 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m01:00:25.297962 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 01:00:23.849251 => 01:00:25.297962
[0m01:00:25.297962 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673FE3EB0>]}
[0m01:00:25.298963 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m01:00:25.299975 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.299975 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m01:00:25.299975 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m01:00:25.301000 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m01:00:25.301000 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m01:00:25.303960 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m01:00:25.304963 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 01:00:25.301000 => 01:00:25.304963
[0m01:00:25.305961 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m01:00:25.310003 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m01:00:25.311960 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:25.312961 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m01:00:26.010925 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09ad4524-b74d-4aa6-86a4-3d0311383e8c&page=queryresults
[0m01:00:26.032331 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0859878f-8ab2-4b66-9508-148c97f6b7b3&page=queryresults
[0m01:00:26.401513 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 01:00:25.269410 => 01:00:26.401513
[0m01:00:26.402506 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F675111730>]}
[0m01:00:26.402506 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m01:00:26.403504 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.403504 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:26.404608 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m01:00:26.405604 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m01:00:26.405604 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:26.409603 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:00:26.410602 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 01:00:26.406605 => 01:00:26.410602
[0m01:00:26.410602 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:26.412603 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:00:26.413606 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:26.414558 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m01:00:26.444996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 01:00:25.305961 => 01:00:26.444996
[0m01:00:26.445994 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F67405AD00>]}
[0m01:00:26.445994 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m01:00:26.446998 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m01:00:26.446998 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m01:00:26.447997 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m01:00:26.448997 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m01:00:26.448997 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m01:00:26.451996 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m01:00:26.452996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 01:00:26.448997 => 01:00:26.451996
[0m01:00:26.452996 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m01:00:26.454996 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m01:00:26.455796 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:26.456821 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m01:00:27.146833 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98b93bc7-3ce1-42e8-becb-4465cdfbf131&page=queryresults
[0m01:00:27.155033 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88c9be64-3508-42ef-b4bd-abf2bccce742&page=queryresults
[0m01:00:27.540178 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 01:00:26.452996 => 01:00:27.540178
[0m01:00:27.541165 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F67405AD00>]}
[0m01:00:27.541165 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.09s]
[0m01:00:27.542194 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m01:00:27.544046 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m01:00:27.545168 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m01:00:27.546064 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m01:00:27.547163 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m01:00:27.555941 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m01:00:27.558058 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 01:00:27.548166 => 01:00:27.557051
[0m01:00:27.559050 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m01:00:27.569048 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:27.589954 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 01:00:26.411566 => 01:00:27.589954
[0m01:00:27.591009 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F675172460>]}
[0m01:00:27.591009 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m01:00:27.592918 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:28.363906 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m01:00:28.364908 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m01:00:29.022057 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1767090-f968-4df9-91f4-ed80c0e9187e&page=queryresults
[0m01:00:31.555329 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 01:00:27.559050 => 01:00:31.555329
[0m01:00:31.556328 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F67519C4C0>]}
[0m01:00:31.557328 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.01s]
[0m01:00:31.558327 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m01:00:31.559877 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m01:00:31.560699 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m01:00:31.561768 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.tb_produto)
[0m01:00:31.562769 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m01:00:31.568768 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m01:00:31.570990 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 01:00:31.562769 => 01:00:31.569905
[0m01:00:31.570990 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m01:00:31.574084 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:32.222200 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m01:00:32.225197 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m01:00:32.818054 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99094d45-7c37-4ff7-94bd-f4e22c788fb4&page=queryresults
[0m01:00:35.012790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 01:00:31.570990 => 01:00:35.011790
[0m01:00:35.013790 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6751862E0>]}
[0m01:00:35.014790 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.45s]
[0m01:00:35.015791 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m01:00:35.017189 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m01:00:35.017189 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m01:00:35.017189 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m01:00:35.017189 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m01:00:35.021330 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m01:00:35.021330 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m01:00:35.020319 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m01:00:35.026330 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m01:00:35.027316 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m01:00:35.032484 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:35.033381 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 01:00:35.022330 => 01:00:35.033381
[0m01:00:35.034382 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m01:00:35.036887 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:35.082225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 01:00:35.027316 => 01:00:35.081273
[0m01:00:35.082225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m01:00:35.085223 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:35.707452 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m01:00:35.709816 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m01:00:35.736321 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:35.738356 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m01:00:36.287081 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7e38f3d-89c0-4336-8e55-4647f8d40ed2&page=queryresults
[0m01:00:36.348074 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15adb609-cbd0-4366-aaa9-d7680988ab56&page=queryresults
[0m01:00:38.485922 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 01:00:35.083223 => 01:00:38.484923
[0m01:00:38.486920 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6751CB5B0>]}
[0m01:00:38.487922 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.47s]
[0m01:00:38.488919 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m01:00:44.691520 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 01:00:35.034382 => 01:00:44.691520
[0m01:00:44.693519 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f90a6cf-b010-4f08-bee8-b74bd0dd62fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673D54D60>]}
[0m01:00:44.693519 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 9.67s]
[0m01:00:44.694413 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m01:00:44.696777 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:00:44.697931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:44.697931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:44.698930 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:00:44.698930 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m01:00:44.698930 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m01:00:44.699932 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m01:00:44.699932 [info ] [MainThread]: 
[0m01:00:44.700928 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 24.12 seconds (24.12s).
[0m01:00:44.703823 [debug] [MainThread]: Command end result
[0m01:00:44.718584 [info ] [MainThread]: 
[0m01:00:44.719655 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:00:44.720657 [info ] [MainThread]: 
[0m01:00:44.721420 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m01:00:44.723500 [debug] [MainThread]: Command `dbt run` succeeded at 01:00:44.722499 after 29.10 seconds
[0m01:00:44.723500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F6706AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F673DAA610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F66F6281C0>]}
[0m01:00:44.724499 [debug] [MainThread]: Flushing usage events
[0m02:00:04.999867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFC983430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFB90B9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFB90BD30>]}


============================== 02:00:05.008455 | eeef9547-3cb8-4dbc-84ae-c16a7fff0b54 ==============================
[0m02:00:05.008455 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:05.009288 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m02:00:05.863986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFB9048B0>]}
[0m02:00:05.922261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFFEC3B80>]}
[0m02:00:05.924254 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:05.931399 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:05.974476 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:05.974476 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:05.978507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C80295F10>]}
[0m02:00:05.988415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C801AF220>]}
[0m02:00:05.989410 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:05.990378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C801AFF70>]}
[0m02:00:05.991379 [info ] [MainThread]: 
[0m02:00:05.992553 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:05.994607 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:05.994607 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:05.995604 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:05.995604 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:06.819506 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:07.563799 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:07.564804 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:07.566801 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:00:07.568816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:08.276263 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:00:08.278518 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:08.893967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C80047430>]}
[0m02:00:08.895933 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:08.896522 [info ] [MainThread]: 
[0m02:00:08.903211 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.905174 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.906207 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m02:00:08.908171 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:08.907173 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m02:00:08.909217 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.911213 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:08.922747 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:08.923763 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.926747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:08.927750 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:08.912171 => 02:00:08.927750
[0m02:00:08.928749 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.960386 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:08.923763 => 02:00:08.960386
[0m02:00:08.961399 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.966392 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:08.973389 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:08.973389 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:08.975707 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:09.000866 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:09.002744 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m02:00:09.804705 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d8955ef-e212-4ef4-95c1-46345b555a97&page=queryresults
[0m02:00:09.806406 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71722d8c-c42f-4ddf-93b6-5e3f5b6d7569&page=queryresults
[0m02:00:10.245373 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:08.961399 => 02:00:10.245373
[0m02:00:10.247370 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:08.928749 => 02:00:10.247370
[0m02:00:10.248369 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C81323BB0>]}
[0m02:00:10.248369 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C80047430>]}
[0m02:00:10.249370 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m02:00:10.249370 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:10.249370 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m02:00:10.250366 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.250366 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:10.251378 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m02:00:10.251378 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m02:00:10.252377 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:10.251378 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m02:00:10.252377 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.253374 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m02:00:10.255380 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:10.255713 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m02:00:10.257536 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:10.258545 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:10.253374 => 02:00:10.258545
[0m02:00:10.258545 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.260530 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:10.261474 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 02:00:10.255713 => 02:00:10.261474
[0m02:00:10.261474 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m02:00:10.263528 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:10.264406 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:10.266437 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:10.297178 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:10.299179 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m02:00:11.147569 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:820508cf-8f35-4015-bba6-5f1f1c21cb6e&page=queryresults
[0m02:00:11.207469 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b270e9ed-2d2a-4d98-b4d3-9800e2e06cce&page=queryresults
[0m02:00:11.545384 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 02:00:10.261474 => 02:00:11.545384
[0m02:00:11.546383 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C8033D430>]}
[0m02:00:11.546383 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m02:00:11.547524 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m02:00:11.548589 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.549587 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m02:00:11.550543 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m02:00:11.551590 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.555572 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:11.556880 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 02:00:11.552587 => 02:00:11.556880
[0m02:00:11.557881 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.567950 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:11.569859 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:11.571943 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m02:00:11.634519 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:10.258545 => 02:00:11.634519
[0m02:00:11.636509 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C813E69A0>]}
[0m02:00:11.638471 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m02:00:11.640476 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:11.641384 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:11.643389 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m02:00:11.644577 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m02:00:11.645587 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:11.650588 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:11.652592 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:11.645587 => 02:00:11.651589
[0m02:00:11.653590 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:11.657414 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:11.658415 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:11.660412 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:12.329623 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:085a1998-41c9-45fc-98b8-45e72e4f75cd&page=queryresults
[0m02:00:12.402522 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6590c23-beab-44d9-961f-cebb7934ed64&page=queryresults
[0m02:00:12.734000 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 02:00:11.557881 => 02:00:12.732957
[0m02:00:12.735007 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C813587C0>]}
[0m02:00:12.735831 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m02:00:12.736979 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:12.809368 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:11.653590 => 02:00:12.809368
[0m02:00:12.810374 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C813F9E80>]}
[0m02:00:12.811363 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m02:00:12.811363 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:12.812331 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:12.812865 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m02:00:12.812865 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m02:00:12.812865 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:12.818833 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:12.820829 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:12.813871 => 02:00:12.819836
[0m02:00:12.820829 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:12.841143 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:13.491171 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:13.492172 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:14.142715 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05012d73-79d9-40ef-a3b8-8fab37e89290&page=queryresults
[0m02:00:16.620553 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:12.821834 => 02:00:16.620553
[0m02:00:16.622606 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C8132D430>]}
[0m02:00:16.624602 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.81s]
[0m02:00:16.626336 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:16.627320 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:16.629335 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m02:00:16.630349 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m02:00:16.631420 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:16.636246 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:16.637404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:16.631420 => 02:00:16.637404
[0m02:00:16.638291 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:16.651400 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:17.444062 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:17.446958 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m02:00:18.353768 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ce9089a-2835-4f06-a4ce-6495160c2959&page=queryresults
[0m02:00:20.586425 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:16.638291 => 02:00:20.585430
[0m02:00:20.587423 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C8133AA90>]}
[0m02:00:20.588424 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.96s]
[0m02:00:20.590526 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:20.591532 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:20.593529 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m02:00:20.593529 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m02:00:20.597428 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:20.595527 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m02:00:20.598466 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:20.599880 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m02:00:20.606815 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:20.607655 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m02:00:20.613668 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:20.616449 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:20.600802 => 02:00:20.615666
[0m02:00:20.617486 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 02:00:20.608717 => 02:00:20.616449
[0m02:00:20.618528 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:20.618528 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m02:00:20.622536 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:20.626530 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:21.271313 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:21.273316 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:21.292296 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:21.295290 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m02:00:21.889072 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9173795c-0316-4909-8444-47d59cd66e47&page=queryresults
[0m02:00:21.921119 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2e02837e-d7d0-433e-99a4-a7cb766fb6f5&page=queryresults
[0m02:00:23.847529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:20.619609 => 02:00:23.846527
[0m02:00:23.848526 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C8143F5E0>]}
[0m02:00:23.849516 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.25s]
[0m02:00:23.851516 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:25.018067 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 02:00:20.623539 => 02:00:25.017070
[0m02:00:25.020072 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eeef9547-3cb8-4dbc-84ae-c16a7fff0b54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011C81395430>]}
[0m02:00:25.021077 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.42s]
[0m02:00:25.021972 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m02:00:25.026073 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:25.026073 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.027078 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.028063 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:00:25.028063 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:00:25.028063 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m02:00:25.029061 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m02:00:25.029061 [info ] [MainThread]: 
[0m02:00:25.030068 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.04 seconds (19.04s).
[0m02:00:25.033069 [debug] [MainThread]: Command end result
[0m02:00:25.062257 [info ] [MainThread]: 
[0m02:00:25.064274 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:25.065216 [info ] [MainThread]: 
[0m02:00:25.066263 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m02:00:25.069263 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:25.068219 after 20.16 seconds
[0m02:00:25.069263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFC983430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFFF10640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CFFF89070>]}
[0m02:00:25.070260 [debug] [MainThread]: Flushing usage events
[0m03:00:04.725718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001231F663430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001231E5E79A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001231E5E7D30>]}


============================== 03:00:04.733721 | 9aee9dd6-7d51-40f4-94fa-235fd542c857 ==============================
[0m03:00:04.733721 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:04.734720 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:00:05.574997 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001231E5E48B0>]}
[0m03:00:05.632614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322BA3B80>]}
[0m03:00:05.634685 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:05.642932 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:05.688498 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:05.688498 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:05.692498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322F75F10>]}
[0m03:00:05.702406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322E8F220>]}
[0m03:00:05.703408 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:05.704407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322E8FF70>]}
[0m03:00:05.706400 [info ] [MainThread]: 
[0m03:00:05.707400 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:05.709340 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.709340 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:05.710345 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.710345 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:06.568458 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:07.284014 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:07.286067 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.287066 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m03:00:07.288066 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.948721 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:00:07.950719 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.751376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322E8F130>]}
[0m03:00:08.753371 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:08.753371 [info ] [MainThread]: 
[0m03:00:08.758574 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.760669 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.761667 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m03:00:08.762669 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:08.761667 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m03:00:08.763671 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.764666 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:08.773657 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.774663 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.776596 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.777315 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:08.774663 => 03:00:08.777315
[0m03:00:08.778326 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.785324 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:08.765674 => 03:00:08.785324
[0m03:00:08.799654 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.804780 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.810870 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.810870 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:08.813929 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m03:00:08.843710 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:08.844745 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:09.679889 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88055ea9-5597-4602-bf79-605d1c3b53ff&page=queryresults
[0m03:00:09.680895 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c783b87b-ac7d-4ea2-b033-c01212e43d30&page=queryresults
[0m03:00:10.107641 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:08.778326 => 03:00:10.107641
[0m03:00:10.108641 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322F83760>]}
[0m03:00:10.109638 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:08.799654 => 03:00:10.109638
[0m03:00:10.110632 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322D3E130>]}
[0m03:00:10.110632 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m03:00:10.111607 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:10.111607 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m03:00:10.112639 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.112639 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:10.113633 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m03:00:10.112639 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m03:00:10.114527 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:10.113633 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m03:00:10.114527 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.114527 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m03:00:10.117313 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:10.117313 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m03:00:10.119311 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:10.120310 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:10.115529 => 03:00:10.120310
[0m03:00:10.121449 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.123416 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:10.123416 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 03:00:10.118310 => 03:00:10.123416
[0m03:00:10.124311 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m03:00:10.125418 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:10.126418 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:10.127348 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:10.146456 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:10.148350 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m03:00:10.836243 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd66671f-24ab-49c0-96eb-65761e223ff7&page=queryresults
[0m03:00:10.942765 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:55cbcf1f-e130-4f12-bf97-8c88431eff74&page=queryresults
[0m03:00:11.215615 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:10.121449 => 03:00:11.214615
[0m03:00:11.216607 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322F83760>]}
[0m03:00:11.217628 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m03:00:11.219629 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.219629 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.220626 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m03:00:11.222749 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m03:00:11.222749 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.227742 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.229738 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 03:00:11.223745 => 03:00:11.229738
[0m03:00:11.230744 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.243654 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.244659 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:11.246658 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m03:00:11.329272 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 03:00:10.124311 => 03:00:11.329272
[0m03:00:11.331280 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000123240E5640>]}
[0m03:00:11.332276 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m03:00:11.333174 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.334176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:11.335173 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m03:00:11.336219 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m03:00:11.337158 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:11.342268 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:11.344169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:11.337158 => 03:00:11.344169
[0m03:00:11.345169 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:11.349271 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:11.351173 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:11.354170 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:11.960662 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25d4be2d-5e7c-46f0-b4fd-0d8d8b561d33&page=queryresults
[0m03:00:12.143931 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f923ccc6-1cdc-4c47-a3ea-e233d251dc8c&page=queryresults
[0m03:00:12.330963 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 03:00:11.230744 => 03:00:12.330963
[0m03:00:12.331963 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322D3E130>]}
[0m03:00:12.332968 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m03:00:12.332968 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:12.534228 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:11.345169 => 03:00:12.534228
[0m03:00:12.535580 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322F83EB0>]}
[0m03:00:12.535580 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m03:00:12.536586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:12.537930 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:12.539078 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m03:00:12.540106 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m03:00:12.540106 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:12.545112 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:12.548015 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:12.540106 => 03:00:12.547011
[0m03:00:12.548015 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:12.562533 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:13.196734 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:13.199214 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:13.855994 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79357579-a2ad-4909-a993-3cc43135f3e0&page=queryresults
[0m03:00:16.374667 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:12.549109 => 03:00:16.373667
[0m03:00:16.375666 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000123240DC4F0>]}
[0m03:00:16.376667 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.84s]
[0m03:00:16.377666 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:16.379154 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:16.379154 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m03:00:16.381168 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m03:00:16.381168 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:16.387203 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:16.395609 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:16.381168 => 03:00:16.394728
[0m03:00:16.395609 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:16.402837 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:17.009407 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:17.012305 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m03:00:17.631372 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b005ded-3d5e-42b8-b679-f849ca36cb3a&page=queryresults
[0m03:00:19.899520 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:16.396724 => 03:00:19.897507
[0m03:00:19.899520 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000123241036D0>]}
[0m03:00:19.901533 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.52s]
[0m03:00:19.901533 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:19.903545 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:19.904297 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m03:00:19.905310 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m03:00:19.906310 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:19.907311 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:19.912308 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:19.905310 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m03:00:19.914307 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m03:00:19.914307 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m03:00:19.919304 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:19.921772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:19.907311 => 03:00:19.920304
[0m03:00:19.922784 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:19.926382 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:19.927288 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 03:00:19.915305 => 03:00:19.926382
[0m03:00:19.927288 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m03:00:19.931284 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:20.740318 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:20.744318 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:20.746315 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m03:00:20.750316 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:21.317678 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:747fb8f1-b7de-46b3-96e9-402fee442ed9&page=queryresults
[0m03:00:21.555173 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3821c592-b536-4016-82ec-db962e794887&page=queryresults
[0m03:00:23.290472 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:19.922784 => 03:00:23.290472
[0m03:00:23.292464 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012324004040>]}
[0m03:00:23.293466 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.39s]
[0m03:00:23.295476 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:23.999318 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 03:00:19.928286 => 03:00:23.999318
[0m03:00:24.000317 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aee9dd6-7d51-40f4-94fa-235fd542c857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012324004910>]}
[0m03:00:24.001316 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.09s]
[0m03:00:24.002340 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m03:00:24.005324 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:24.006314 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.007312 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.007312 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m03:00:24.008313 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:00:24.008313 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m03:00:24.009312 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m03:00:24.009312 [info ] [MainThread]: 
[0m03:00:24.010316 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 18.30 seconds (18.30s).
[0m03:00:24.015312 [debug] [MainThread]: Command end result
[0m03:00:24.042810 [info ] [MainThread]: 
[0m03:00:24.043744 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:24.044719 [info ] [MainThread]: 
[0m03:00:24.045812 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m03:00:24.047801 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:24.047801 after 19.38 seconds
[0m03:00:24.048803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001231F663430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322BEC640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012322C69070>]}
[0m03:00:24.049805 [debug] [MainThread]: Flushing usage events
[0m04:00:17.720435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016206BD7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016205B5C6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016205B5CE20>]}


============================== 04:00:17.733895 | 75849d1a-1fb3-4974-87f1-782e9758c786 ==============================
[0m04:00:17.733895 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:17.736827 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:19.607152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016205B5E070>]}
[0m04:00:19.731083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A162EB0>]}
[0m04:00:19.734055 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:19.777075 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:23.368447 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:23.369458 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:23.375621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A4F5E20>]}
[0m04:00:23.430087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A40EAF0>]}
[0m04:00:23.431090 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:23.432134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A40EB50>]}
[0m04:00:23.435123 [info ] [MainThread]: 
[0m04:00:23.436386 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:23.440389 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.442340 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:23.443386 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.444391 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:24.462048 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:25.175479 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:25.176584 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:00:25.177586 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.177586 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.824600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:25.828897 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:26.480277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A574CD0>]}
[0m04:00:26.482204 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:26.483128 [info ] [MainThread]: 
[0m04:00:26.507807 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:26.508810 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:26.509805 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m04:00:26.511804 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:26.512820 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:26.510817 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m04:00:26.524304 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:26.525616 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:26.526745 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:26.530736 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:26.549569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:26.512820 => 04:00:26.548572
[0m04:00:26.550575 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:26.551580 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:26.526745 => 04:00:26.551580
[0m04:00:26.587908 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:26.603984 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:26.612312 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:26.613305 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:26.616402 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:26.617403 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:26.669648 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m04:00:27.793485 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b43446e4-1827-40ef-8ddb-f7d65df03f80&page=queryresults
[0m04:00:27.804250 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:06baafa1-9fc9-43bb-86e5-8cdf44349a73&page=queryresults
[0m04:00:28.196022 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:26.588900 => 04:00:28.196022
[0m04:00:28.198108 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A40ED60>]}
[0m04:00:28.200151 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.67s]
[0m04:00:28.204151 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:26.552573 => 04:00:28.204151
[0m04:00:28.205155 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:28.207418 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A4FDBB0>]}
[0m04:00:28.208407 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.209408 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.69s]
[0m04:00:28.211396 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:28.210405 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m04:00:28.212406 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m04:00:28.214411 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:28.216551 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.215544 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m04:00:28.222117 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.224159 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m04:00:28.225116 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m04:00:28.230935 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:28.235001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:28.216551 => 04:00:28.235001
[0m04:00:28.236253 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.238261 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 04:00:28.225116 => 04:00:28.237256
[0m04:00:28.244341 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.245650 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m04:00:28.253782 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:28.256026 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:28.257034 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:28.261107 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m04:00:28.286195 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:28.962698 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5623735c-7998-4179-ad68-0094489551c5&page=queryresults
[0m04:00:29.028418 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c623e8c6-f8c2-4510-bafa-df2717a4c893&page=queryresults
[0m04:00:29.375348 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 04:00:28.246772 => 04:00:29.375348
[0m04:00:29.376544 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620B5ADE20>]}
[0m04:00:29.377545 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m04:00:29.378448 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m04:00:29.379446 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:29.379446 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m04:00:29.381446 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m04:00:29.381446 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:29.385443 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:29.389840 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 04:00:29.381446 => 04:00:29.388823
[0m04:00:29.389840 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:29.403067 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:29.405073 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:29.407869 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m04:00:29.460680 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:28.238261 => 04:00:29.460680
[0m04:00:29.461680 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620B664EE0>]}
[0m04:00:29.462781 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m04:00:29.463706 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:29.464751 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:29.464751 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m04:00:29.466683 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m04:00:29.466683 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:29.473175 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:29.477125 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:29.467683 => 04:00:29.476173
[0m04:00:29.477125 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:29.481829 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:29.484048 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:29.486696 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:30.153850 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ff9511d-80a8-4249-934e-31a22bb30094&page=queryresults
[0m04:00:30.244291 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4058f1a2-9cd6-4f23-b973-556d9baa38ed&page=queryresults
[0m04:00:30.524669 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 04:00:29.389840 => 04:00:30.524669
[0m04:00:30.525670 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A2C4B80>]}
[0m04:00:30.526895 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m04:00:30.527799 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:30.686766 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:29.478169 => 04:00:30.685751
[0m04:00:30.686766 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A57D370>]}
[0m04:00:30.687766 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m04:00:30.690778 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:30.692772 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:30.694769 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m04:00:30.695768 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m04:00:30.697526 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:30.707620 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:30.710157 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:30.697526 => 04:00:30.709143
[0m04:00:30.711160 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:30.737103 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:31.445467 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:31.447519 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:32.108495 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d9099853-df6c-42e9-86b5-1872ca35bb2d&page=queryresults
[0m04:00:35.824834 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:30.712158 => 04:00:35.823832
[0m04:00:35.826171 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A503580>]}
[0m04:00:35.827174 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 5.13s]
[0m04:00:35.829173 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:35.830115 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:35.831177 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m04:00:35.833175 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m04:00:35.834181 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:35.841431 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:35.845045 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:35.834181 => 04:00:35.845045
[0m04:00:35.846123 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:35.857120 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:36.501019 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:36.501019 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m04:00:37.361996 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58c479d1-568a-4ff6-962f-68fe9d9c1b6f&page=queryresults
[0m04:00:40.518704 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:35.846123 => 04:00:40.517710
[0m04:00:40.519708 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620B688220>]}
[0m04:00:40.520711 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.69s]
[0m04:00:40.521611 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:40.522610 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:40.523610 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m04:00:40.523610 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m04:00:40.525498 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:40.524610 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m04:00:40.527685 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m04:00:40.527685 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m04:00:40.532684 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:40.526673 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:40.538451 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:40.538451 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 04:00:40.528685 => 04:00:40.538451
[0m04:00:40.540774 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m04:00:40.543881 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:40.544786 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:40.533685 => 04:00:40.544786
[0m04:00:40.545368 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:40.548481 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:41.203428 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:41.204416 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m04:00:41.242694 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:41.245671 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:41.805228 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4995aa6d-6632-466b-866f-44ee9cbc3a42&page=queryresults
[0m04:00:41.891626 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1c693de-4736-4415-853f-d6786a1e2d4d&page=queryresults
[0m04:00:44.178498 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:40.545368 => 04:00:44.178498
[0m04:00:44.179501 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620B69CD00>]}
[0m04:00:44.180504 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.65s]
[0m04:00:44.182401 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:44.622699 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 04:00:40.540774 => 04:00:44.622699
[0m04:00:44.623696 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75849d1a-1fb3-4974-87f1-782e9758c786', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620B657460>]}
[0m04:00:44.624700 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.10s]
[0m04:00:44.624700 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m04:00:44.627478 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:44.627478 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:44.628479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:44.628479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:00:44.629476 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:44.629476 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m04:00:44.630476 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m04:00:44.630476 [info ] [MainThread]: 
[0m04:00:44.631476 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 21.19 seconds (21.19s).
[0m04:00:44.634473 [debug] [MainThread]: Command end result
[0m04:00:44.675087 [info ] [MainThread]: 
[0m04:00:44.677102 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:44.677836 [info ] [MainThread]: 
[0m04:00:44.678965 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m04:00:44.681097 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:44.680016 after 27.13 seconds
[0m04:00:44.682202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016206BD7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A318850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001620A208160>]}
[0m04:00:44.683206 [debug] [MainThread]: Flushing usage events
[0m05:00:06.096969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221DF663430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221DE5E3640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221DE5E3AC0>]}


============================== 05:00:06.108218 | bc42c04c-3d79-4bae-89bc-eab5244d1c0a ==============================
[0m05:00:06.108218 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:06.110220 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:07.209787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221DE5CDFD0>]}
[0m05:00:07.321683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2BBD070>]}
[0m05:00:07.323677 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:07.339092 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:07.475403 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:07.476422 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:07.488684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2F75BE0>]}
[0m05:00:07.508174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2E918B0>]}
[0m05:00:07.509150 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:07.510151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2E91910>]}
[0m05:00:07.511151 [info ] [MainThread]: 
[0m05:00:07.512152 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:07.515249 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:07.516298 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.517283 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:07.518290 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:08.411580 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:09.089028 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:09.090024 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:09.092026 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:09.093983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:09.755705 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:09.757708 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:10.463474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2D8C610>]}
[0m05:00:10.465919 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:10.467892 [info ] [MainThread]: 
[0m05:00:10.476360 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.479356 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.480359 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m05:00:10.484327 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:10.482353 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m05:00:10.485664 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.487669 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:10.503090 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:10.504093 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.511562 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:10.513562 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:10.488672 => 05:00:10.513562
[0m05:00:10.514868 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.515918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:10.505510 => 05:00:10.514868
[0m05:00:10.536950 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.540877 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:10.545970 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:10.546966 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:10.549933 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:10.568858 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:10.569808 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m05:00:11.407412 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a0751e9-f201-4b49-ae84-2c0b20297e0f&page=queryresults
[0m05:00:11.412413 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f1836167-9bb8-45df-b2f8-ac8de2cbbd96&page=queryresults
[0m05:00:11.844313 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:10.537950 => 05:00:11.844313
[0m05:00:11.845295 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2D41130>]}
[0m05:00:11.845295 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m05:00:11.847708 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:11.848714 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.852706 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:10.515918 => 05:00:11.851709
[0m05:00:11.848714 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m05:00:11.853705 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2D8C610>]}
[0m05:00:11.854698 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:11.856117 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.860116 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:11.854698 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m05:00:11.861035 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:11.862092 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.862092 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m05:00:11.863095 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m05:00:11.864085 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.868408 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.870440 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:11.856117 => 05:00:11.869468
[0m05:00:11.870440 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.874464 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:11.875800 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 05:00:11.864085 => 05:00:11.875800
[0m05:00:11.876717 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.880799 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.882808 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:11.885098 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:11.913870 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:11.916233 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m05:00:12.632068 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce7b1f0e-ba1e-483e-8ce1-dfa81b4b773f&page=queryresults
[0m05:00:12.727593 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13dc485f-4df2-429d-869f-821e612c0f3d&page=queryresults
[0m05:00:13.027676 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:11.871459 => 05:00:13.026683
[0m05:00:13.029714 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2F856D0>]}
[0m05:00:13.030727 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m05:00:13.032674 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:13.035096 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.036152 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m05:00:13.039099 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m05:00:13.040106 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.049496 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.051493 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 05:00:13.041100 => 05:00:13.051493
[0m05:00:13.053440 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.071954 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.072950 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:13.074950 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m05:00:13.120261 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 05:00:11.876717 => 05:00:13.120261
[0m05:00:13.122254 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2F5BEB0>]}
[0m05:00:13.124263 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m05:00:13.126429 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m05:00:13.127429 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:13.129431 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m05:00:13.131481 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m05:00:13.133479 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:13.142750 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:13.144749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:13.133479 => 05:00:13.144749
[0m05:00:13.145974 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:13.150021 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:13.152038 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:13.155384 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:13.913595 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1f79eda-e5fc-4029-bf14-47406c525bd2&page=queryresults
[0m05:00:14.017269 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42907b7d-1539-481f-b06e-949fd919c786&page=queryresults
[0m05:00:14.326770 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 05:00:13.054445 => 05:00:14.326770
[0m05:00:14.327771 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E409FF70>]}
[0m05:00:14.328771 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m05:00:14.329789 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:14.429858 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:13.145974 => 05:00:14.428851
[0m05:00:14.430855 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E409F430>]}
[0m05:00:14.432860 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m05:00:14.434855 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:14.436302 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:14.438307 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m05:00:14.440306 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m05:00:14.441305 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:14.448644 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:14.450665 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:14.441305 => 05:00:14.449652
[0m05:00:14.451652 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:14.466429 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:15.113555 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:15.116960 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:15.783769 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1cacec67-5d06-4b0c-a418-50e288ff959a&page=queryresults
[0m05:00:18.028281 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:14.451652 => 05:00:18.027279
[0m05:00:18.029276 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2D8C610>]}
[0m05:00:18.030282 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.59s]
[0m05:00:18.032136 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:18.034196 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:18.035167 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m05:00:18.036471 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m05:00:18.037457 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:18.044442 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:18.046749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:18.038434 => 05:00:18.046749
[0m05:00:18.047744 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:18.057244 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:18.728001 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:18.731001 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m05:00:19.376683 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63e0afbf-7146-499c-b8b2-9de260f0bba0&page=queryresults
[0m05:00:21.600326 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:18.047744 => 05:00:21.599326
[0m05:00:21.601327 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2D8C610>]}
[0m05:00:21.603328 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.56s]
[0m05:00:21.605672 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:21.606664 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:21.607807 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m05:00:21.609779 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m05:00:21.612783 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:21.613784 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:21.610786 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m05:00:21.622090 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:21.623140 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m05:00:21.624137 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m05:00:21.630575 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:21.632583 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:21.614778 => 05:00:21.631574
[0m05:00:21.633575 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:21.638793 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:21.640844 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 05:00:21.625088 => 05:00:21.639793
[0m05:00:21.641797 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m05:00:21.647123 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:22.347136 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:22.349143 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:22.350128 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:22.352125 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m05:00:22.955400 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf6b5534-f29c-4c94-ad11-b98881c0c4d4&page=queryresults
[0m05:00:22.962377 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:649433b9-2c77-4805-ae32-5003b3435d99&page=queryresults
[0m05:00:25.004145 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:21.634579 => 05:00:25.004145
[0m05:00:25.005145 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2F75E50>]}
[0m05:00:25.007527 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.39s]
[0m05:00:25.009449 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:25.723467 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 05:00:21.642842 => 05:00:25.722463
[0m05:00:25.724466 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc42c04c-3d79-4bae-89bc-eab5244d1c0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E407CA00>]}
[0m05:00:25.725716 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.10s]
[0m05:00:25.727723 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m05:00:25.730729 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:25.731723 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:25.731723 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:25.732724 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:00:25.732724 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:00:25.732724 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m05:00:25.733725 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m05:00:25.733725 [info ] [MainThread]: 
[0m05:00:25.734728 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 18.22 seconds (18.22s).
[0m05:00:25.738972 [debug] [MainThread]: Command end result
[0m05:00:25.773708 [info ] [MainThread]: 
[0m05:00:25.775899 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:25.776879 [info ] [MainThread]: 
[0m05:00:25.778898 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m05:00:25.780840 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:25.780840 after 19.81 seconds
[0m05:00:25.782842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221DF663430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E2BBD070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221E41C7B50>]}
[0m05:00:25.783846 [debug] [MainThread]: Flushing usage events
[0m06:00:05.349378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C4233460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C31A86D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C31A8E20>]}


============================== 06:00:05.356557 | d675b5dc-1723-43ce-9238-1ca6285004c2 ==============================
[0m06:00:05.356557 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:05.358005 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m06:00:06.439478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C31AA880>]}
[0m06:00:06.598385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7773B80>]}
[0m06:00:06.601385 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:06.610771 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:06.679761 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:06.679761 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:06.683755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7B45F10>]}
[0m06:00:06.691972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7A5F220>]}
[0m06:00:06.691972 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:06.692976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7A5FF70>]}
[0m06:00:06.694951 [info ] [MainThread]: 
[0m06:00:06.696067 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:06.698034 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.698034 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.700803 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.738770 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.527127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.225094 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m06:00:08.226484 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.227496 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:08.229438 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:09.112602 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m06:00:09.115925 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:09.827783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C78F7430>]}
[0m06:00:09.828687 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:09.829772 [info ] [MainThread]: 
[0m06:00:09.838928 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.839957 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.841922 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m06:00:09.846200 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:09.843928 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m06:00:09.848288 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.850276 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:09.872175 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.873180 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.881422 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.884473 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:09.851280 => 06:00:09.883457
[0m06:00:09.885604 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.886726 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:09.874426 => 06:00:09.886726
[0m06:00:09.904141 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.936377 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.949736 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.951693 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:09.956090 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:10.004044 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:10.007150 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m06:00:10.848800 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20b30c95-18e8-4c38-98e6-4ed99d8f4b6d&page=queryresults
[0m06:00:10.862392 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7d2865c-d12b-450a-a599-cfd9f6c61d42&page=queryresults
[0m06:00:11.267537 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:09.919886 => 06:00:11.267537
[0m06:00:11.268531 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7BC3040>]}
[0m06:00:11.269533 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m06:00:11.270530 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:11.270530 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.271534 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m06:00:11.272539 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:11.273523 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.277787 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:11.279731 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:11.273523 => 06:00:11.278791
[0m06:00:11.279731 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.282692 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:11.283689 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:11.284691 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:11.315833 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:09.887745 => 06:00:11.315833
[0m06:00:11.317838 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7B900A0>]}
[0m06:00:11.318837 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m06:00:11.320781 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:11.320781 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.321837 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m06:00:11.323743 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m06:00:11.323743 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.328033 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.329033 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 06:00:11.324743 => 06:00:11.329033
[0m06:00:11.330036 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.332031 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.333033 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:11.334033 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m06:00:12.088166 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dbab97a3-fd06-4559-9732-f695d70c1d09&page=queryresults
[0m06:00:12.095444 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85b85c8d-6a0e-4c95-b857-a341234dcb10&page=queryresults
[0m06:00:12.463591 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 06:00:11.330036 => 06:00:12.462601
[0m06:00:12.464909 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7B45FA0>]}
[0m06:00:12.466039 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m06:00:12.468036 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.468036 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:12.469033 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m06:00:12.471035 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m06:00:12.472032 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:12.480212 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:12.482201 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 06:00:12.472032 => 06:00:12.481209
[0m06:00:12.482201 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:12.491278 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:12.493277 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:12.496531 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m06:00:12.539455 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:11.279731 => 06:00:12.539455
[0m06:00:12.541504 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7BCD610>]}
[0m06:00:12.542505 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m06:00:12.544831 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:12.545963 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:12.546960 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m06:00:12.547964 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m06:00:12.548955 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:12.558086 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:12.562095 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:12.549927 => 06:00:12.561089
[0m06:00:12.564085 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:12.573455 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:12.575945 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:12.580993 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:13.232471 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a4a286d-f4e4-42c8-a7c6-54f53dea61d9&page=queryresults
[0m06:00:13.340738 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40daac34-cac9-474b-a43d-a9fbf8b8fa05&page=queryresults
[0m06:00:13.598275 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 06:00:12.483194 => 06:00:13.597272
[0m06:00:13.599274 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8C9FC10>]}
[0m06:00:13.600280 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m06:00:13.602187 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:13.759467 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:12.564085 => 06:00:13.758466
[0m06:00:13.760461 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8BCDA90>]}
[0m06:00:13.760461 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m06:00:13.761471 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:13.763366 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:13.764366 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m06:00:13.765210 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m06:00:13.766227 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:13.773225 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:13.775224 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:13.767224 => 06:00:13.774225
[0m06:00:13.775224 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:13.789963 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:14.451440 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:14.453404 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:15.038950 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5b3eb71-1f95-4607-8c33-4546bc1a0f5a&page=queryresults
[0m06:00:18.406788 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:13.776454 => 06:00:18.405579
[0m06:00:18.407784 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8CB4B80>]}
[0m06:00:18.408783 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.64s]
[0m06:00:18.409685 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:18.410684 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:18.411684 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m06:00:18.412684 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m06:00:18.413685 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:18.418683 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:18.420687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:18.413685 => 06:00:18.419684
[0m06:00:18.420687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:18.430168 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:19.093685 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:19.096685 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m06:00:19.724805 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2ee0ac72-6b1f-455c-9fe1-5deccaba59fb&page=queryresults
[0m06:00:21.963295 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:18.420687 => 06:00:21.962300
[0m06:00:21.964301 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8CAF0A0>]}
[0m06:00:21.964301 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.55s]
[0m06:00:21.966398 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:21.968395 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:21.968395 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m06:00:21.969396 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m06:00:21.971396 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:21.971396 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:21.976688 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:21.970396 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m06:00:21.977591 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m06:00:21.978589 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m06:00:21.983691 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:21.984587 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:21.972396 => 06:00:21.984587
[0m06:00:21.985982 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 06:00:21.978589 => 06:00:21.984587
[0m06:00:21.986627 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:21.987709 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m06:00:21.990437 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:21.993331 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:22.680105 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:22.682106 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m06:00:22.687508 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:22.690450 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:23.309101 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6285477c-86de-4b5d-9208-a963f1ba7895&page=queryresults
[0m06:00:23.358802 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9d33ddbc-165b-4d41-9aa4-148668b30514&page=queryresults
[0m06:00:26.507296 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 06:00:21.991442 => 06:00:26.506287
[0m06:00:26.508287 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8CC6460>]}
[0m06:00:26.509296 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.53s]
[0m06:00:26.511285 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m06:00:31.996759 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:21.988267 => 06:00:31.995759
[0m06:00:31.997757 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd675b5dc-1723-43ce-9238-1ca6285004c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C8CC6610>]}
[0m06:00:31.997757 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 10.03s]
[0m06:00:31.999759 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:32.001873 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:32.001873 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:32.002872 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:32.002872 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:00:32.002872 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m06:00:32.003870 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m06:00:32.003870 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m06:00:32.004870 [info ] [MainThread]: 
[0m06:00:32.004870 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 25.31 seconds (25.31s).
[0m06:00:32.007868 [debug] [MainThread]: Command end result
[0m06:00:32.030229 [info ] [MainThread]: 
[0m06:00:32.031233 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:32.032234 [info ] [MainThread]: 
[0m06:00:32.033232 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m06:00:32.035329 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:32.034264 after 26.74 seconds
[0m06:00:32.035329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C4233460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C77BC640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299C7838070>]}
[0m06:00:32.036331 [debug] [MainThread]: Flushing usage events
[0m07:00:05.151441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014AD94A2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014AD84299A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014AD8429D30>]}


============================== 07:00:05.158055 | 78a0ca32-b040-490d-bf87-a9d7c6f68eb4 ==============================
[0m07:00:05.158055 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:05.159376 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m07:00:06.077775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014AD8423250>]}
[0m07:00:06.133083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCB10A60>]}
[0m07:00:06.135046 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:06.141321 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:06.185319 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:06.185319 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:06.189416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCDB8250>]}
[0m07:00:06.196834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCCC9BE0>]}
[0m07:00:06.196834 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:06.197838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCCC9F40>]}
[0m07:00:06.199829 [info ] [MainThread]: 
[0m07:00:06.200796 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:06.202502 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.203511 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.227357 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.227357 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.087011 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:07.768637 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:07.769640 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:07.769640 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.769640 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:08.429359 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:08.433350 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:09.126308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCD9BC10>]}
[0m07:00:09.127397 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:09.129380 [info ] [MainThread]: 
[0m07:00:09.136610 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.137615 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.139612 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m07:00:09.141612 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:09.140655 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m07:00:09.142614 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.143734 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:09.154602 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.155854 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.159849 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.162738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:09.144737 => 07:00:09.161696
[0m07:00:09.163757 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.192785 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:09.155854 => 07:00:09.192785
[0m07:00:09.193784 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.201156 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.205563 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.206595 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:09.209615 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:09.210598 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:09.247410 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m07:00:10.255061 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9b05742-5e1d-4883-b834-5edad0eca1ce&page=queryresults
[0m07:00:10.270104 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35b0bd3a-3e4e-4a6f-b086-4326d97702ca&page=queryresults
[0m07:00:10.742146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:09.194796 => 07:00:10.742146
[0m07:00:10.743158 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCE5BF40>]}
[0m07:00:10.746708 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:09.163757 => 07:00:10.745463
[0m07:00:10.747705 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCE3E340>]}
[0m07:00:10.746708 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.60s]
[0m07:00:10.748709 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:10.748709 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m07:00:10.749707 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.750707 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:10.750707 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m07:00:10.750707 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m07:00:10.751717 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:10.752715 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.751717 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m07:00:10.755106 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.755106 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m07:00:10.755106 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m07:00:10.757202 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:10.758198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:10.752715 => 07:00:10.758198
[0m07:00:10.758198 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.760197 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.760197 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 07:00:10.755106 => 07:00:10.760197
[0m07:00:10.761216 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m07:00:10.764194 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:10.765194 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:10.766431 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:10.799539 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:10.800539 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m07:00:11.533145 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a5196b2-322f-49ca-8bc4-1bc679ea83da&page=queryresults
[0m07:00:11.537701 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72fc1d45-61f7-41be-8af3-9fe69ce53500&page=queryresults
[0m07:00:11.948809 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:10.758198 => 07:00:11.948809
[0m07:00:11.950803 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDE75820>]}
[0m07:00:11.954804 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 07:00:10.761216 => 07:00:11.954804
[0m07:00:11.957106 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCE004F0>]}
[0m07:00:11.956102 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:11.959102 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:11.958105 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:11.960102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.961105 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.962102 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:11.962102 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m07:00:11.964182 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m07:00:11.963101 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m07:00:11.965202 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.965519 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m07:00:11.970622 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:11.971620 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:11.977030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 07:00:11.966617 => 07:00:11.977030
[0m07:00:11.978981 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.986439 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:12.001814 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:12.002818 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:12.007139 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m07:00:12.008142 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:11.971620 => 07:00:12.008142
[0m07:00:12.048693 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:12.054690 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:12.057054 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:12.060056 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:12.760367 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:030775ef-f8cd-4d36-a995-4d4ce8cc853e&page=queryresults
[0m07:00:12.880640 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5c060898-1ecf-4a1c-a633-2f8f5053735a&page=queryresults
[0m07:00:13.186978 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 07:00:11.980982 => 07:00:13.186978
[0m07:00:13.188979 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDE75820>]}
[0m07:00:13.189877 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m07:00:13.190880 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:13.276813 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:12.049717 => 07:00:13.276813
[0m07:00:13.278812 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDEB9C70>]}
[0m07:00:13.278812 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m07:00:13.280711 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:13.282150 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:13.283270 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m07:00:13.284321 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m07:00:13.284321 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:13.289450 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:13.291351 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:13.284321 => 07:00:13.290455
[0m07:00:13.291351 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:13.305546 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:13.966879 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:13.967887 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:15.327664 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e9bb0a7-b857-436c-b175-538b727b8256&page=queryresults
[0m07:00:17.553675 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:13.292443 => 07:00:17.553675
[0m07:00:17.554672 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDEEA9D0>]}
[0m07:00:17.555900 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.27s]
[0m07:00:17.557805 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:17.558801 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:17.559801 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m07:00:17.560801 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m07:00:17.560801 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:17.566799 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:17.568801 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:17.561801 => 07:00:17.567799
[0m07:00:17.569229 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:17.572537 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:18.213238 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:18.215479 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m07:00:18.908086 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2ae43e16-5815-4795-8aae-d22c2127c03e&page=queryresults
[0m07:00:21.198889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:17.569229 => 07:00:21.198889
[0m07:00:21.199900 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCD9BC10>]}
[0m07:00:21.200882 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.64s]
[0m07:00:21.202788 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:21.204836 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:21.206130 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m07:00:21.204836 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m07:00:21.208037 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:21.208037 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:21.213034 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:21.215036 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:21.208037 => 07:00:21.214036
[0m07:00:21.215036 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:21.218034 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:21.207037 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m07:00:21.261289 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m07:00:21.261289 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m07:00:21.266500 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:21.269396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 07:00:21.262288 => 07:00:21.269396
[0m07:00:21.270395 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m07:00:21.273525 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:22.014424 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:22.015425 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:22.034619 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:22.036718 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m07:00:22.595724 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e7c81ba3-176c-444b-8325-4e95b8f7d269&page=queryresults
[0m07:00:22.610367 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6398bc8e-c667-496e-a1a3-52135ac9b27b&page=queryresults
[0m07:00:24.539352 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:21.216036 => 07:00:24.538350
[0m07:00:24.540353 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDEFD4F0>]}
[0m07:00:24.540353 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.33s]
[0m07:00:24.541354 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:25.355647 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 07:00:21.270395 => 07:00:25.355647
[0m07:00:25.356931 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78a0ca32-b040-490d-bf87-a9d7c6f68eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADDEFD400>]}
[0m07:00:25.357928 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.10s]
[0m07:00:25.358831 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m07:00:25.360827 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:25.361828 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:25.361828 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:25.362826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:00:25.362826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:25.363826 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m07:00:25.363826 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m07:00:25.363826 [info ] [MainThread]: 
[0m07:00:25.364825 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.16 seconds (19.16s).
[0m07:00:25.367822 [debug] [MainThread]: Command end result
[0m07:00:25.387995 [info ] [MainThread]: 
[0m07:00:25.389207 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:25.390215 [info ] [MainThread]: 
[0m07:00:25.391115 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m07:00:25.394114 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:25.393113 after 20.30 seconds
[0m07:00:25.394479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014AD94A2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCAA9A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014ADCB02A90>]}
[0m07:00:25.395657 [debug] [MainThread]: Flushing usage events
[0m08:00:04.292507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020833C27400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020832B9B910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020832B9BB80>]}


============================== 08:00:04.299566 | 72cbaaea-37a9-4a16-be4d-af6c7e1798aa ==============================
[0m08:00:04.299566 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:04.301571 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:05.223892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020832B8DF70>]}
[0m08:00:05.289341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208371B9130>]}
[0m08:00:05.291394 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:05.301726 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:05.346814 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:05.346814 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:05.350925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020837545D60>]}
[0m08:00:05.359501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083745EA00>]}
[0m08:00:05.359501 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:05.360518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083745E9D0>]}
[0m08:00:05.362494 [info ] [MainThread]: 
[0m08:00:05.362494 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:05.364506 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:05.364847 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:05.364847 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:05.364847 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.187820 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:06.887892 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:00:06.889846 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:06.890858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.890858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.568484 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:07.572491 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.218361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208375C5C10>]}
[0m08:00:08.219358 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:08.220718 [info ] [MainThread]: 
[0m08:00:08.227695 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.228742 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.229694 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m08:00:08.232693 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:08.230736 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m08:00:08.233691 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.234742 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:08.245011 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:08.246323 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.251310 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:08.252312 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:08.234742 => 08:00:08.252312
[0m08:00:08.253242 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.273870 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:08.247327 => 08:00:08.273870
[0m08:00:08.274863 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.279157 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:08.281157 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:08.282160 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:08.283082 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:08.283082 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:08.312158 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m08:00:09.275481 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a7bce53-3550-4cee-9b67-31dd060dca52&page=queryresults
[0m08:00:09.294473 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23b49220-f16a-4a0d-9374-caf1cc3852bc&page=queryresults
[0m08:00:09.751385 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:08.276160 => 08:00:09.751385
[0m08:00:09.752399 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208385C2F10>]}
[0m08:00:09.755742 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:08.253242 => 08:00:09.755742
[0m08:00:09.753386 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m08:00:09.756690 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020837366D60>]}
[0m08:00:09.757754 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.759741 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:09.758754 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m08:00:09.760740 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.761750 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m08:00:09.759741 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m08:00:09.762745 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:09.763736 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:09.767101 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:09.761750 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m08:00:09.768097 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m08:00:09.769093 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m08:00:09.774097 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:09.776494 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:09.763736 => 08:00:09.775432
[0m08:00:09.777525 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:09.778520 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 08:00:09.769093 => 08:00:09.778520
[0m08:00:09.784531 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:09.785739 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m08:00:09.791783 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:09.794807 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:09.796101 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:09.799197 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:09.833984 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m08:00:10.583226 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:17af0faa-0e99-406d-8f23-5dd29794736d&page=queryresults
[0m08:00:10.621609 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88d4e035-59e2-4df2-9d26-febb46f42103&page=queryresults
[0m08:00:10.982405 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:09.779520 => 08:00:10.982405
[0m08:00:10.983403 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083860D6D0>]}
[0m08:00:10.984397 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m08:00:10.985402 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:10.986492 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:10.987490 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m08:00:10.988490 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m08:00:10.988490 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:10.993490 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:10.994491 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 08:00:10.989490 => 08:00:10.994491
[0m08:00:10.995788 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:11.009024 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:11.010027 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:11.013026 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m08:00:11.064990 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 08:00:09.786781 => 08:00:11.064990
[0m08:00:11.066301 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208375CDF70>]}
[0m08:00:11.067303 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m08:00:11.069198 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m08:00:11.069198 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:11.070196 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m08:00:11.071195 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m08:00:11.072197 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:11.079667 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:11.081667 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:11.072197 => 08:00:11.081667
[0m08:00:11.082667 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:11.087111 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:11.089114 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:11.091012 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:11.803196 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b2c2ce9-1e17-4db5-bcfc-e8c8625e4bd0&page=queryresults
[0m08:00:11.847619 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d38171a2-af6d-4e72-879f-410cf2e0f6b7&page=queryresults
[0m08:00:12.226315 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 08:00:10.995788 => 08:00:12.225098
[0m08:00:12.227314 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208385D1BB0>]}
[0m08:00:12.227314 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m08:00:12.228275 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:12.251970 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:11.082667 => 08:00:12.251970
[0m08:00:12.252971 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083754E550>]}
[0m08:00:12.253961 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m08:00:12.254907 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:12.256546 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:12.256546 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m08:00:12.257678 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m08:00:12.258727 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:12.263728 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:12.264680 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:12.258727 => 08:00:12.264680
[0m08:00:12.265790 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:12.279197 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.934867 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:12.937195 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:13.557765 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b77e0f35-dae9-466c-bb4f-714343e9bd59&page=queryresults
[0m08:00:16.669075 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:12.265790 => 08:00:16.669075
[0m08:00:16.670079 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208375CB490>]}
[0m08:00:16.671063 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.41s]
[0m08:00:16.672969 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:16.673967 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:16.674967 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m08:00:16.675968 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m08:00:16.676968 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:16.681965 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:16.683965 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:16.676968 => 08:00:16.682967
[0m08:00:16.683965 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:16.693786 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:17.367053 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:17.369055 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m08:00:18.064419 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0935b94c-9df5-4927-898e-705375007a85&page=queryresults
[0m08:00:20.577971 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:16.683965 => 08:00:20.576973
[0m08:00:20.578975 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083752B8B0>]}
[0m08:00:20.578975 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.90s]
[0m08:00:20.579880 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:20.580873 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:20.581871 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m08:00:20.582871 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m08:00:20.584871 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:20.584871 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:20.589869 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:20.590870 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:20.584871 => 08:00:20.590870
[0m08:00:20.592311 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:20.595322 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:20.582871 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m08:00:20.637383 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m08:00:20.638307 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m08:00:20.642304 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:20.646393 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 08:00:20.638307 => 08:00:20.645391
[0m08:00:20.646393 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m08:00:20.649493 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:21.344626 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:21.345859 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m08:00:21.369230 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:21.371243 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:21.970437 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11c6d9b6-d93f-4fac-a1a9-40d92980552c&page=queryresults
[0m08:00:21.977644 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb3ec658-b519-423f-a550-311472eaf01f&page=queryresults
[0m08:00:24.203732 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:20.592311 => 08:00:24.203732
[0m08:00:24.205730 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020837554D30>]}
[0m08:00:24.207309 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.62s]
[0m08:00:24.209391 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.307053 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 08:00:20.647390 => 08:00:25.307053
[0m08:00:25.308047 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72cbaaea-37a9-4a16-be4d-af6c7e1798aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020837554DC0>]}
[0m08:00:25.309047 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.67s]
[0m08:00:25.310950 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m08:00:25.312949 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:25.313949 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.313949 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.313949 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:25.314947 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:25.314947 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m08:00:25.314947 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m08:00:25.315946 [info ] [MainThread]: 
[0m08:00:25.315946 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.95 seconds (19.95s).
[0m08:00:25.318945 [debug] [MainThread]: Command end result
[0m08:00:25.341318 [info ] [MainThread]: 
[0m08:00:25.342254 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:25.343224 [info ] [MainThread]: 
[0m08:00:25.344328 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m08:00:25.346320 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:25.346320 after 21.11 seconds
[0m08:00:25.347319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020833C27400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020837202280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208371C49A0>]}
[0m08:00:25.347319 [debug] [MainThread]: Flushing usage events
[0m09:00:04.912046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54F80B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54E79B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54E79BE20>]}


============================== 09:00:04.919220 | 49798e4a-745f-4a47-b707-1643c87a8cca ==============================
[0m09:00:04.919220 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:04.920225 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:05.739044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54E78A1C0>]}
[0m09:00:05.795681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D552E80B20>]}
[0m09:00:05.798051 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:05.804145 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:05.847895 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:05.847895 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:05.851891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D553125EE0>]}
[0m09:00:05.860267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D55303F220>]}
[0m09:00:05.860267 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:05.860267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D552D595E0>]}
[0m09:00:05.861266 [info ] [MainThread]: 
[0m09:00:05.862311 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:05.863307 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.864321 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.864321 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:05.865307 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.747133 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:07.447996 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:00:07.449994 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:00:07.450994 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.450994 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:08.126892 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:00:08.129879 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:08.792352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D553125F40>]}
[0m09:00:08.794735 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:08.795851 [info ] [MainThread]: 
[0m09:00:08.806020 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.808055 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.810057 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:00:08.814068 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:08.812058 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:00:08.816485 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.818486 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:08.839156 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.839156 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.842152 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.844139 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:08.819491 => 09:00:08.843163
[0m09:00:08.844139 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.845184 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:08.840153 => 09:00:08.845184
[0m09:00:08.880757 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.900658 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.907135 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.907135 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:08.908024 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:00:08.939266 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:08.940267 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:09.900207 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:691d201d-80a9-4862-b023-d10287393a49&page=queryresults
[0m09:00:09.907156 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16d12d2c-d1e7-4614-9162-32c67fc97489&page=queryresults
[0m09:00:10.353802 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:08.845184 => 09:00:10.352795
[0m09:00:10.354794 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D552ED7310>]}
[0m09:00:10.358258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:08.896657 => 09:00:10.357257
[0m09:00:10.358258 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D553173190>]}
[0m09:00:10.355161 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m09:00:10.359259 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.359259 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m09:00:10.360264 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:10.360264 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.361264 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.361264 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:00:10.362273 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:10.362273 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:00:10.362273 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:10.363273 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:00:10.365627 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:10.365627 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.367734 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:10.368751 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:10.363273 => 09:00:10.368751
[0m09:00:10.368751 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:10.369664 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:00:10.365627 => 09:00:10.368751
[0m09:00:10.370729 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:10.371730 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.373734 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:10.374699 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:10.374699 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:10.377056 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:00:10.397630 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:11.152975 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed3ac90b-2f47-457e-8225-167ccf09d21a&page=queryresults
[0m09:00:11.301040 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a01e1f7d-ec50-44b7-a68b-ceb2c620445c&page=queryresults
[0m09:00:11.568928 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:00:10.371730 => 09:00:11.568928
[0m09:00:11.569927 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D553172CA0>]}
[0m09:00:11.569927 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:11.571243 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:00:11.572259 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:11.573256 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:00:11.575299 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:00:11.575299 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:11.590965 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:11.593053 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:00:11.576548 => 09:00:11.592013
[0m09:00:11.594051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:11.600455 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:11.602461 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:11.606795 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:00:11.957477 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:10.369664 => 09:00:11.957477
[0m09:00:11.958477 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D5541CAA00>]}
[0m09:00:11.959475 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.60s]
[0m09:00:11.961687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.961687 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:11.962767 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m09:00:11.964694 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m09:00:11.964694 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:11.971043 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:11.973035 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:11.966061 => 09:00:11.972038
[0m09:00:11.973035 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:11.977307 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:11.979186 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:11.982314 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:12.402918 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:31b7ccb8-54a7-4052-8d39-aa3be3d6e76b&page=queryresults
[0m09:00:12.763678 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:69a134f5-3097-4a5e-b3d8-5975bc5aa4dc&page=queryresults
[0m09:00:13.093434 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:00:11.595062 => 09:00:13.092444
[0m09:00:13.094439 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D55423E760>]}
[0m09:00:13.095767 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m09:00:13.097758 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.173208 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:11.973918 => 09:00:13.173208
[0m09:00:13.174207 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D5541CAA00>]}
[0m09:00:13.175508 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:13.177508 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:13.178497 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:13.179510 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m09:00:13.181429 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m09:00:13.182434 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:13.189717 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:13.191718 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:13.183431 => 09:00:13.191718
[0m09:00:13.192715 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:13.207321 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:13.899367 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:13.900369 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:14.523059 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4fe98e50-5113-44ce-b431-05fc088f886c&page=queryresults
[0m09:00:17.343669 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:13.193715 => 09:00:17.343669
[0m09:00:17.344670 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D55303FDF0>]}
[0m09:00:17.344670 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.16s]
[0m09:00:17.345790 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:17.347758 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:17.349759 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m09:00:17.350761 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m09:00:17.350761 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:17.356756 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:17.359288 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:17.351759 => 09:00:17.358760
[0m09:00:17.359288 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:17.362618 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:17.997316 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:17.999222 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m09:00:18.653540 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7616893b-ecb4-447a-85f8-af8e05db5888&page=queryresults
[0m09:00:21.202098 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:17.359288 => 09:00:21.202098
[0m09:00:21.204099 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D5542EA4C0>]}
[0m09:00:21.205099 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.85s]
[0m09:00:21.206103 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:21.207722 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.207722 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:00:21.207722 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m09:00:21.209732 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:21.209732 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.215764 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.215764 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:21.209732 => 09:00:21.215764
[0m09:00:21.207722 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m09:00:21.219023 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m09:00:21.219023 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:00:21.224020 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:21.217785 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.226995 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:21.227994 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:00:21.219023 => 09:00:21.227994
[0m09:00:21.228901 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:00:21.231897 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:21.935375 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.937311 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:21.968143 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:21.970044 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m09:00:22.536312 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22700982-113b-4a86-aef9-a2b9e7b23b2e&page=queryresults
[0m09:00:22.651230 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e8e770f4-7989-497b-8908-720d8268ac3b&page=queryresults
[0m09:00:24.765030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:21.225023 => 09:00:24.765030
[0m09:00:24.766262 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D554388100>]}
[0m09:00:24.767261 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.56s]
[0m09:00:24.769161 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:26.380512 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:00:21.228901 => 09:00:26.380512
[0m09:00:26.382515 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49798e4a-745f-4a47-b707-1643c87a8cca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D55437AC10>]}
[0m09:00:26.383517 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 5.16s]
[0m09:00:26.384459 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:00:26.388097 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:26.389111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:26.389111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:26.390106 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:26.390106 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:00:26.391103 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m09:00:26.391103 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m09:00:26.392105 [info ] [MainThread]: 
[0m09:00:26.393174 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 20.53 seconds (20.53s).
[0m09:00:26.396609 [debug] [MainThread]: Command end result
[0m09:00:26.408808 [info ] [MainThread]: 
[0m09:00:26.409704 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:26.410560 [info ] [MainThread]: 
[0m09:00:26.411629 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m09:00:26.412282 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:26.412282 after 21.58 seconds
[0m09:00:26.413451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54F80B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D552EFA610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D54E79B160>]}
[0m09:00:26.414449 [debug] [MainThread]: Flushing usage events
[0m10:00:04.143569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B18FB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17F399A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17F39D30>]}


============================== 10:00:04.152329 | eed281db-801d-4794-bd82-ba4f45d18df7 ==============================
[0m10:00:04.152329 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:04.154329 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:00:04.945212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17F2E040>]}
[0m10:00:05.039633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C61D850>]}
[0m10:00:05.041583 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:05.052110 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:05.167658 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:05.167658 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:05.173661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C8C5EB0>]}
[0m10:00:05.187906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C812970>]}
[0m10:00:05.187906 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:05.189139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C812E50>]}
[0m10:00:05.191180 [info ] [MainThread]: 
[0m10:00:05.191180 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:05.193401 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.194409 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:05.229329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.230378 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.065487 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:06.715547 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:06.717478 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:06.718503 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.719494 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.362489 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:00:07.365474 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.985608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C943130>]}
[0m10:00:07.986713 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:07.988306 [info ] [MainThread]: 
[0m10:00:07.996496 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:07.997491 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:07.998490 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:08.000493 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:07.999493 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:08.001495 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.003493 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:08.016086 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.017086 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.022081 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.024996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:08.018079 => 10:00:08.024996
[0m10:00:08.026158 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.027171 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:08.003493 => 10:00:08.026158
[0m10:00:08.049582 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.073977 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.078226 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.078226 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:08.080274 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:08.113172 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:08.115433 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:08.918510 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:89681f86-0423-4390-85e3-887462520ae6&page=queryresults
[0m10:00:08.926684 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7b126f4-29d0-425e-b548-bdb246b5b2c0&page=queryresults
[0m10:00:09.401100 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:08.064718 => 10:00:09.401100
[0m10:00:09.402100 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C914FD0>]}
[0m10:00:09.402100 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m10:00:09.403118 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.404100 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:09.404100 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:09.405096 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:09.405096 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:09.407389 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:09.408391 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:09.405096 => 10:00:09.408391
[0m10:00:09.409267 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:09.410393 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:09.411390 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:09.412264 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:09.565233 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:08.027171 => 10:00:09.564231
[0m10:00:09.566596 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C910C40>]}
[0m10:00:09.567588 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m10:00:09.568598 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.568598 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:09.569591 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:09.571588 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:09.571588 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:09.577960 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:09.579866 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:09.572591 => 10:00:09.578961
[0m10:00:09.579866 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:09.583959 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:09.585302 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:09.587401 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:10.215581 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b695f2d-d8c9-4b6f-89e3-3086621d4c5c&page=queryresults
[0m10:00:10.348263 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c06fa968-6bab-4097-9fc1-236cd084bb43&page=queryresults
[0m10:00:10.611364 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:09.409267 => 10:00:10.611364
[0m10:00:10.612365 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C958400>]}
[0m10:00:10.612365 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m10:00:10.613365 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.614365 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:10.615698 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:10.616678 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:10.617701 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:10.623751 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:10.624751 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:10.618695 => 10:00:10.624751
[0m10:00:10.626058 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:10.641443 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:10.643452 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:10.647867 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:10.788219 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:09.580962 => 10:00:10.787212
[0m10:00:10.789213 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C9432B0>]}
[0m10:00:10.789213 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m10:00:10.791114 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:10.791114 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:10.792112 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m10:00:10.793112 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m10:00:10.794112 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:10.798377 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:10.799833 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:10.794112 => 10:00:10.799833
[0m10:00:10.800848 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:10.804844 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:10.806182 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:10.808083 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:11.386233 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:243dc9e3-61bc-4b07-aec6-aa78ac642c81&page=queryresults
[0m10:00:11.605932 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fab941a3-4fb3-4d91-a323-f969bf98d72a&page=queryresults
[0m10:00:11.785713 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:10.626058 => 10:00:11.784713
[0m10:00:11.786912 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1D949B20>]}
[0m10:00:11.787916 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m10:00:11.788811 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:12.029078 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:10.800848 => 10:00:12.028077
[0m10:00:12.030078 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C578C40>]}
[0m10:00:12.031078 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:00:12.032078 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:12.033287 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:12.033796 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m10:00:12.034807 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m10:00:12.034807 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:12.039804 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:12.042285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:12.035807 => 10:00:12.041807
[0m10:00:12.042285 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:12.054429 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:12.704653 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:12.706854 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:13.392552 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6ab2c7c-32c1-47d7-bf59-7a22e4433675&page=queryresults
[0m10:00:15.963797 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:12.043138 => 10:00:15.962786
[0m10:00:15.964791 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C578580>]}
[0m10:00:15.967170 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.93s]
[0m10:00:15.968121 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:15.970151 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:15.971064 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m10:00:15.971546 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m10:00:15.972715 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:15.978138 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:15.980040 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:15.972715 => 10:00:15.979157
[0m10:00:15.980040 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:15.990445 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:16.669363 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:16.671261 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m10:00:17.338229 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37ae693f-b054-4ca1-8cb0-8b51d7220dd9&page=queryresults
[0m10:00:20.215634 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:15.980040 => 10:00:20.215634
[0m10:00:20.216859 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1D9C2D60>]}
[0m10:00:20.217862 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.25s]
[0m10:00:20.219762 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:20.220759 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.221758 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m10:00:20.222855 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:20.222855 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.228059 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:20.228059 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:00:20.228956 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m10:00:20.229953 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m10:00:20.230953 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:00:20.234952 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:20.236941 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:20.222855 => 10:00:20.236431
[0m10:00:20.237954 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.240953 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:20.237954 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:00:20.230953 => 10:00:20.236941
[0m10:00:20.241952 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:00:20.244952 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:21.067635 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:21.069637 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m10:00:21.074639 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:21.076206 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:21.657121 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6f4c471-c66a-49f2-ad3e-4ba19c84efa7&page=queryresults
[0m10:00:21.724038 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e5165582-9023-41db-8bac-23695f240d46&page=queryresults
[0m10:00:24.258970 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:20.238953 => 10:00:24.257969
[0m10:00:24.259958 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1DA34E50>]}
[0m10:00:24.260960 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.04s]
[0m10:00:24.261863 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:24.483242 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:00:20.241952 => 10:00:24.482245
[0m10:00:24.484242 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eed281db-801d-4794-bd82-ba4f45d18df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1D949190>]}
[0m10:00:24.485236 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.25s]
[0m10:00:24.485236 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:00:24.487324 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:24.488325 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:24.488325 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:24.489323 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:00:24.489323 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:24.490321 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m10:00:24.490321 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:00:24.491322 [info ] [MainThread]: 
[0m10:00:24.491322 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.30 seconds (19.30s).
[0m10:00:24.494533 [debug] [MainThread]: Command end result
[0m10:00:24.518319 [info ] [MainThread]: 
[0m10:00:24.520300 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:24.521227 [info ] [MainThread]: 
[0m10:00:24.522226 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m10:00:24.524227 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:24.524227 after 20.44 seconds
[0m10:00:24.525226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B18FB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1C61D850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17F342E0>]}
[0m10:00:24.525226 [debug] [MainThread]: Flushing usage events
[0m11:00:05.216102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029415D26460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029414CB96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029414CB9E20>]}


============================== 11:00:05.224426 | 5fc83f97-45d0-401e-963f-b62bbf915f01 ==============================
[0m11:00:05.224426 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:05.225417 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:06.141305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029414CAB220>]}
[0m11:00:06.197068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000294193A0A60>]}
[0m11:00:06.199030 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:06.206388 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:06.250196 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:06.250196 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:06.254607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029419648250>]}
[0m11:00:06.261735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941955EBE0>]}
[0m11:00:06.262746 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:06.262746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941955EF40>]}
[0m11:00:06.264734 [info ] [MainThread]: 
[0m11:00:06.266155 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:06.268089 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:06.268089 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.269122 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:06.270076 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:07.137300 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:07.861428 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:07.863639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:00:07.864962 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:07.864962 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:08.542210 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:00:08.543205 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:09.327636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000294196C2190>]}
[0m11:00:09.329676 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:09.330688 [info ] [MainThread]: 
[0m11:00:09.339298 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.341423 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.340301 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m11:00:09.343426 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:09.342422 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m11:00:09.344419 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.345845 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:09.357422 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:09.358420 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.363418 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:09.364739 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:09.345845 => 11:00:09.364426
[0m11:00:09.364739 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.365745 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:09.359420 => 11:00:09.365745
[0m11:00:09.385662 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.389795 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:09.392800 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:09.393821 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:09.393821 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:09.394667 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:09.396079 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m11:00:10.258221 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b29944d-3a21-4dd7-b133-fc1073ab9040&page=queryresults
[0m11:00:10.302937 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bfe8d450-3f08-4f3f-a193-c25cb2b02a60&page=queryresults
[0m11:00:10.740875 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:09.365745 => 11:00:10.739876
[0m11:00:10.740875 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941940A490>]}
[0m11:00:10.741877 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m11:00:10.742757 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:10.743773 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:10.744772 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m11:00:10.746106 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:10.747122 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:10.752256 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:10.753257 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:10.748120 => 11:00:10.753257
[0m11:00:10.754257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:10.757522 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:10.757522 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:10.759522 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:10.780959 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:09.386791 => 11:00:10.780959
[0m11:00:10.781959 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941962BBB0>]}
[0m11:00:10.781959 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m11:00:10.782959 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:10.782959 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m11:00:10.782959 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m11:00:10.783958 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m11:00:10.785071 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m11:00:10.789337 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:10.790340 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 11:00:10.785071 => 11:00:10.790340
[0m11:00:10.790340 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m11:00:10.794334 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:10.795667 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:10.797669 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m11:00:11.480030 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ad895ee-bdd5-459e-b5d5-9f142afe0d25&page=queryresults
[0m11:00:11.565755 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:30cb572d-f2d1-4305-b34b-352e035c3602&page=queryresults
[0m11:00:11.880794 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:10.754257 => 11:00:11.879793
[0m11:00:11.882789 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941940A370>]}
[0m11:00:11.883801 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m11:00:11.886047 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:11.887042 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:11.888040 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m11:00:11.890435 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m11:00:11.890435 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:11.894772 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:11.897087 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 11:00:11.890435 => 11:00:11.896078
[0m11:00:11.897087 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:11.915975 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:11.918849 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:11.921972 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m11:00:11.977153 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 11:00:10.791340 => 11:00:11.976148
[0m11:00:11.978142 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000294196CCF10>]}
[0m11:00:11.980059 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m11:00:11.982021 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m11:00:11.983019 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:11.984057 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m11:00:11.985058 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m11:00:11.986422 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:11.993360 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:11.994344 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:11.987364 => 11:00:11.994344
[0m11:00:11.995485 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:12.000536 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:12.002535 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:12.005787 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:12.660497 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3bd6796-1cbc-4ccb-bbc4-bc7fc3a1674f&page=queryresults
[0m11:00:12.718852 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af6502e6-6b8a-47f1-8ef8-04df50d4923d&page=queryresults
[0m11:00:13.053961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 11:00:11.898205 => 11:00:13.052962
[0m11:00:13.054953 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941A739D60>]}
[0m11:00:13.055956 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m11:00:13.057059 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:13.134221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:11.995485 => 11:00:13.134221
[0m11:00:13.135222 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941A781640>]}
[0m11:00:13.136408 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m11:00:13.137313 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:13.138936 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:13.138936 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m11:00:13.140073 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m11:00:13.141097 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:13.145108 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:13.147195 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:13.141097 => 11:00:13.147195
[0m11:00:13.148263 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:13.160484 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:13.849567 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:13.851569 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:14.514419 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0780c247-325d-411f-b1a1-b7006bca4da8&page=queryresults
[0m11:00:17.379324 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:13.148263 => 11:00:17.378325
[0m11:00:17.380429 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029419339580>]}
[0m11:00:17.381425 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.24s]
[0m11:00:17.383327 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:17.384323 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:17.385325 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m11:00:17.386326 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m11:00:17.386326 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:17.392807 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:17.394708 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:17.387324 => 11:00:17.393807
[0m11:00:17.395048 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:17.404101 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:18.024643 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:18.025643 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m11:00:18.774243 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd315b45-23f7-489e-99fe-d20a5b1c4af2&page=queryresults
[0m11:00:21.288210 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:17.395048 => 11:00:21.288210
[0m11:00:21.289205 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000294196532E0>]}
[0m11:00:21.290209 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.90s]
[0m11:00:21.291213 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:21.292274 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:21.292274 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:00:21.293273 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m11:00:21.295274 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:21.295274 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:21.300271 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:21.302275 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:21.296273 => 11:00:21.301273
[0m11:00:21.294273 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m11:00:21.303266 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m11:00:21.304278 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:00:21.303266 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:21.309480 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:21.312047 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:21.313946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 11:00:21.304278 => 11:00:21.312982
[0m11:00:21.313946 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:00:21.317198 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:21.985165 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:21.987177 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m11:00:22.034247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:22.036238 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:22.674237 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3418e71a-b511-4714-8bd1-8e589e532169&page=queryresults
[0m11:00:22.772314 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:258a289d-a60d-45f8-961a-d9eedfe62e89&page=queryresults
[0m11:00:24.875499 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:21.309932 => 11:00:24.875499
[0m11:00:24.877495 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941A6D3B20>]}
[0m11:00:24.878489 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.58s]
[0m11:00:24.879386 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:27.042046 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 11:00:21.314946 => 11:00:27.042046
[0m11:00:27.043041 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc83f97-45d0-401e-963f-b62bbf915f01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941A794A60>]}
[0m11:00:27.044046 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 5.74s]
[0m11:00:27.045941 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:00:27.048186 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:27.049191 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.049191 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.050089 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:00:27.050089 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:00:27.051086 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m11:00:27.051086 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m11:00:27.051086 [info ] [MainThread]: 
[0m11:00:27.052087 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 20.79 seconds (20.79s).
[0m11:00:27.055085 [debug] [MainThread]: Command end result
[0m11:00:27.078795 [info ] [MainThread]: 
[0m11:00:27.079801 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:27.080943 [info ] [MainThread]: 
[0m11:00:27.082041 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m11:00:27.084943 [debug] [MainThread]: Command `dbt run` succeeded at 11:00:27.083941 after 21.96 seconds
[0m11:00:27.084943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029415D26460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002941A7420A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029419392A90>]}
[0m11:00:27.085941 [debug] [MainThread]: Flushing usage events
[0m12:00:16.095440 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E4F73430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E3EE19A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E3EE1D30>]}


============================== 12:00:16.107728 | 84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4 ==============================
[0m12:00:16.107728 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:16.109671 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:00:17.531593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E3EF41F0>]}
[0m12:00:17.660405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E85E0B20>]}
[0m12:00:17.664409 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:17.702111 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:21.347243 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:21.348250 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:21.361674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E8885EE0>]}
[0m12:00:21.416405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E879F220>]}
[0m12:00:21.418394 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:21.419365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E84B55E0>]}
[0m12:00:21.424396 [info ] [MainThread]: 
[0m12:00:21.426863 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:21.432866 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:21.434855 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:21.436289 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:21.438271 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:22.396282 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:23.137271 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:23.139269 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:23.140266 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:00:23.142271 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:23.869778 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:23.871777 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:24.620709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E879FD30>]}
[0m12:00:24.623712 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:24.624724 [info ] [MainThread]: 
[0m12:00:24.638537 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:24.640496 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:24.641483 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m12:00:24.642484 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:24.641483 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m12:00:24.643482 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:24.644482 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:24.666050 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:24.666050 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:24.673050 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:24.674066 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:24.644482 => 12:00:24.674066
[0m12:00:24.675343 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:24.705067 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:24.667014 => 12:00:24.704760
[0m12:00:24.717231 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:24.725221 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:24.732318 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:24.733316 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:24.735492 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:24.766188 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:24.768154 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m12:00:25.676781 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8347ebf-87b1-495a-b809-7d62474448e5&page=queryresults
[0m12:00:25.682782 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f697989a-7b67-444d-84ae-74b8c4c8fffb&page=queryresults
[0m12:00:26.176514 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:24.719229 => 12:00:26.175410
[0m12:00:26.178511 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:24.676395 => 12:00:26.177513
[0m12:00:26.179513 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E9913D60>]}
[0m12:00:26.181511 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E879FD30>]}
[0m12:00:26.183511 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m12:00:26.185972 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:26.184533 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m12:00:26.186971 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:26.188970 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:26.190985 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m12:00:26.189969 [info ] [Thread-2  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m12:00:26.193974 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:26.191983 [info ] [Thread-1  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m12:00:26.194973 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:26.195308 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m12:00:26.201412 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:26.202412 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m12:00:26.206734 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:26.208724 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:26.196425 => 12:00:26.208724
[0m12:00:26.209729 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:26.210735 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 12:00:26.203412 => 12:00:26.210735
[0m12:00:26.220180 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:26.221181 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m12:00:26.225505 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:26.227609 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:26.229610 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:26.229610 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:26.252407 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m12:00:27.171669 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c87e464-8533-4b24-b94c-ae891a086306&page=queryresults
[0m12:00:27.233043 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9325ffa-e5f0-444e-a2eb-57e96bb7d522&page=queryresults
[0m12:00:27.622250 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:26.211727 => 12:00:27.622250
[0m12:00:27.625252 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E8888F40>]}
[0m12:00:27.626687 [info ] [Thread-2  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m12:00:27.628686 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:27.630689 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.631696 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m12:00:27.635004 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m12:00:27.636114 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.646584 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:27.649594 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 12:00:27.637119 => 12:00:27.648590
[0m12:00:27.651585 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.674493 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:27.679868 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 12:00:26.221181 => 12:00:27.679868
[0m12:00:27.681873 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E890D5E0>]}
[0m12:00:27.682871 [info ] [Thread-1  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m12:00:27.685214 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:27.687323 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m12:00:27.688321 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:27.693326 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m12:00:27.690317 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m12:00:27.738197 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m12:00:27.739196 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:27.744201 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:27.745202 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:27.740203 => 12:00:27.745202
[0m12:00:27.746576 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:27.749562 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:27.750562 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:27.753564 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:28.513584 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:343e4111-0c3b-4cfc-baa8-cb4f2624861f&page=queryresults
[0m12:00:28.552279 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d876e7c5-7f35-41b2-ac6c-c59168aa03bb&page=queryresults
[0m12:00:28.942184 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 12:00:27.651585 => 12:00:28.942184
[0m12:00:28.945184 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E886BF70>]}
[0m12:00:28.946630 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m12:00:28.948638 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:28.963076 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:27.746576 => 12:00:28.962082
[0m12:00:28.965423 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E892D880>]}
[0m12:00:28.967533 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m12:00:28.969527 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:28.972524 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:28.974524 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m12:00:28.976946 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m12:00:28.977945 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:28.984949 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:28.987232 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:28.978954 => 12:00:28.987232
[0m12:00:28.988302 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:29.000671 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:29.688192 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:29.689074 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:30.342634 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d78b830-c177-4d3f-8609-6c9445ec8ac0&page=queryresults
[0m12:00:33.124771 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:28.988302 => 12:00:33.124771
[0m12:00:33.126019 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E8901220>]}
[0m12:00:33.128056 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.15s]
[0m12:00:33.129982 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:33.132004 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:33.132004 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m12:00:33.133018 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:00:33.134027 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:33.144266 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:33.146506 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:33.134027 => 12:00:33.146506
[0m12:00:33.147504 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:33.158815 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:33.844852 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:33.848955 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m12:00:34.516842 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7cb60014-c365-4f68-8d05-4b434576b5d4&page=queryresults
[0m12:00:37.065940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:33.148509 => 12:00:37.065940
[0m12:00:37.067954 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E854F880>]}
[0m12:00:37.069961 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.93s]
[0m12:00:37.073896 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:37.075325 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:37.076356 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m12:00:37.076356 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m12:00:37.078457 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:37.079455 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:37.087766 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:37.077380 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m12:00:37.090770 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m12:00:37.092774 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m12:00:37.103086 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:37.105411 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:37.079455 => 12:00:37.104089
[0m12:00:37.106463 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:37.113409 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:37.151291 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 12:00:37.093647 => 12:00:37.151291
[0m12:00:37.152293 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m12:00:37.154703 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:37.978078 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:37.981036 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m12:00:37.996579 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:37.998523 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:38.654632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9bcb1161-5b4b-47a0-9e1c-4401240825c0&page=queryresults
[0m12:00:38.727926 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ec299121-ab63-4fe4-a3e6-1500cc948d06&page=queryresults
[0m12:00:42.458860 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:37.107411 => 12:00:42.457894
[0m12:00:42.460794 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E9A02760>]}
[0m12:00:42.462797 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 5.38s]
[0m12:00:42.463791 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:42.677275 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 12:00:37.152293 => 12:00:42.676219
[0m12:00:42.679265 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84bf08ac-09ab-4b58-8d6d-053e4ebc2eb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E99220D0>]}
[0m12:00:42.681232 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 5.59s]
[0m12:00:42.684269 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m12:00:42.689611 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:42.689611 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:42.690614 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:42.691614 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:00:42.691614 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:42.692614 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m12:00:42.692614 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:00:42.693611 [info ] [MainThread]: 
[0m12:00:42.694928 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 21.27 seconds (21.27s).
[0m12:00:42.703030 [debug] [MainThread]: Command end result
[0m12:00:42.733082 [info ] [MainThread]: 
[0m12:00:42.734147 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:42.734147 [info ] [MainThread]: 
[0m12:00:42.735148 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m12:00:42.736475 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:42.736475 after 26.83 seconds
[0m12:00:42.736475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E4F73430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E865A610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241E3EE1130>]}
[0m12:00:42.737473 [debug] [MainThread]: Flushing usage events
[0m13:00:05.248425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D17CE03400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D17BD80910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D17BD80B80>]}


============================== 13:00:05.253440 | 561d1d70-3f28-4a2b-bf8d-da22b07bab86 ==============================
[0m13:00:05.253440 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:05.254469 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:06.159466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D17BD6D0D0>]}
[0m13:00:06.256416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D100470A90>]}
[0m13:00:06.258878 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:06.268194 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:06.386864 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:06.387867 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:06.393865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D100718160>]}
[0m13:00:06.407253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1006FBC70>]}
[0m13:00:06.408218 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:06.408957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1004DE700>]}
[0m13:00:06.411007 [info ] [MainThread]: 
[0m13:00:06.412053 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:06.414015 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:06.414015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:06.415016 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:06.417171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:07.306717 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:07.959622 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:07.961624 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:07.962627 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:00:07.963623 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:08.624914 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:00:08.626925 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:09.249035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1007627F0>]}
[0m13:00:09.251138 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:09.252083 [info ] [MainThread]: 
[0m13:00:09.259325 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:09.260326 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:09.261324 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m13:00:09.261324 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m13:00:09.262362 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:09.263324 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:09.264390 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:09.264390 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:09.273608 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:09.275793 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:09.276689 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:09.273608 => 13:00:09.276689
[0m13:00:09.277747 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:09.265618 => 13:00:09.276689
[0m13:00:09.277747 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:09.278666 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:09.301290 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:09.306597 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:09.307589 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:09.307589 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:09.309457 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m13:00:09.332056 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:10.290667 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b7a109d-797a-4aad-adc8-2b4af0880fb9&page=queryresults
[0m13:00:10.315389 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02dc7160-c9de-475b-b65e-24b5e076e258&page=queryresults
[0m13:00:10.775808 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:09.298288 => 13:00:10.774686
[0m13:00:10.776810 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1007662E0>]}
[0m13:00:10.776810 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m13:00:10.777819 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:10.778811 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:10.778811 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m13:00:10.779817 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:10.779817 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:10.782810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:10.785147 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:09.279793 => 13:00:10.785147
[0m13:00:10.786274 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1017A3400>]}
[0m13:00:10.787278 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:10.779817 => 13:00:10.786274
[0m13:00:10.786274 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m13:00:10.787278 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:10.787278 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:10.789272 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:10.790277 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.790277 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m13:00:10.791280 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m13:00:10.791280 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:10.792153 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.793147 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.794276 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:10.795521 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 13:00:10.792153 => 13:00:10.795521
[0m13:00:10.814089 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.816543 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.817542 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:10.818490 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m13:00:11.573911 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1867dd8-ffda-462e-9172-a6707d826b0a&page=queryresults
[0m13:00:11.618803 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:923d65c8-d598-4929-8d07-2ab34e7f9d7e&page=queryresults
[0m13:00:11.998422 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 13:00:10.814089 => 13:00:11.997421
[0m13:00:11.999421 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D101852FA0>]}
[0m13:00:12.000417 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m13:00:12.002317 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m13:00:12.002317 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.003314 [info ] [Thread-2  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m13:00:12.004312 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m13:00:12.005454 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.010455 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:12.011456 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 13:00:12.005454 => 13:00:12.011456
[0m13:00:12.012555 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.025080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:12.027250 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:12.030247 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m13:00:12.082999 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:10.788233 => 13:00:12.082999
[0m13:00:12.084997 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1007AAE80>]}
[0m13:00:12.086188 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m13:00:12.089192 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:12.089192 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:12.090188 [info ] [Thread-1  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m13:00:12.091186 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m13:00:12.092188 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:12.098407 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:12.100408 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:12.092188 => 13:00:12.100408
[0m13:00:12.101408 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:12.106715 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:12.107716 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:12.110714 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:12.861954 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ace77b25-a588-41b0-9dc7-0f909c2703cd&page=queryresults
[0m13:00:12.879323 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b4b1b64-6a67-401f-96d5-e0428b14532e&page=queryresults
[0m13:00:13.297772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 13:00:12.012555 => 13:00:13.296773
[0m13:00:13.298773 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D101852FA0>]}
[0m13:00:13.299773 [info ] [Thread-2  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m13:00:13.300600 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:13.541739 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:12.101408 => 13:00:13.540727
[0m13:00:13.541739 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D10186DD30>]}
[0m13:00:13.542730 [info ] [Thread-1  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m13:00:13.543626 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:13.544607 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:13.545879 [info ] [Thread-2  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m13:00:13.547275 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m13:00:13.548291 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:13.554284 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:13.555284 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:13.549288 => 13:00:13.555284
[0m13:00:13.555284 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:13.571094 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:14.287140 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:14.288144 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:15.023086 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f45ddc80-a661-47e7-937f-06cb4730ac0c&page=queryresults
[0m13:00:17.890910 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:13.556495 => 13:00:17.890910
[0m13:00:17.892900 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1007AEEE0>]}
[0m13:00:17.893894 [info ] [Thread-2  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.34s]
[0m13:00:17.894805 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:17.896121 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:17.897084 [info ] [Thread-1  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m13:00:17.898081 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m13:00:17.899081 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:17.904128 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:17.906414 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:17.899081 => 13:00:17.905188
[0m13:00:17.906414 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:17.916864 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:18.584137 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:18.586138 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m13:00:19.502898 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab729e35-a82c-4edf-aaf1-93d1e1b852ed&page=queryresults
[0m13:00:21.760633 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:17.907413 => 13:00:21.760633
[0m13:00:21.762631 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1007AEF10>]}
[0m13:00:21.762631 [info ] [Thread-1  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.86s]
[0m13:00:21.763653 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:21.764532 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:21.764532 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m13:00:21.765531 [info ] [Thread-2  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m13:00:21.767533 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:21.767533 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:21.772531 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:21.773533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:21.767533 => 13:00:21.773533
[0m13:00:21.765531 [info ] [Thread-1  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m13:00:21.774912 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:21.775976 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m13:00:21.778942 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:21.779946 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m13:00:21.825831 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:21.828730 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 13:00:21.821614 => 13:00:21.828730
[0m13:00:21.828730 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m13:00:21.831827 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:22.449295 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:22.451297 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:22.523403 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:22.524396 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m13:00:23.093528 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:851238b0-01dd-4391-8a15-ad8b5601221e&page=queryresults
[0m13:00:23.183458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7fe37aa-ed13-4cc3-939a-a06c75a981c1&page=queryresults
[0m13:00:25.064452 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:21.776768 => 13:00:25.064452
[0m13:00:25.066677 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D10188A730>]}
[0m13:00:25.066677 [info ] [Thread-2  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.30s]
[0m13:00:25.067700 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:26.358457 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 13:00:21.829779 => 13:00:26.357449
[0m13:00:26.359454 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '561d1d70-3f28-4a2b-bf8d-da22b07bab86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D10188A520>]}
[0m13:00:26.361454 [info ] [Thread-1  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.58s]
[0m13:00:26.362454 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m13:00:26.367856 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:00:26.368855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:26.369853 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:26.369853 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:00:26.370852 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:00:26.370852 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m13:00:26.371851 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m13:00:26.371851 [info ] [MainThread]: 
[0m13:00:26.372852 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.96 seconds (19.96s).
[0m13:00:26.380792 [debug] [MainThread]: Command end result
[0m13:00:26.431405 [info ] [MainThread]: 
[0m13:00:26.432404 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:00:26.434406 [info ] [MainThread]: 
[0m13:00:26.435688 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m13:00:26.438745 [debug] [MainThread]: Command `dbt run` succeeded at 13:00:26.437740 after 21.24 seconds
[0m13:00:26.439746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D17CE03400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D100520670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1004DE700>]}
[0m13:00:26.439746 [debug] [MainThread]: Flushing usage events
[0m14:00:14.710847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD39E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD29589D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD2958B80>]}


============================== 14:00:14.728840 | 748a85b8-1f1f-4016-9268-4ff58944f6d8 ==============================
[0m14:00:14.728840 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:14.731893 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:00:15.523524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD294BA30>]}
[0m14:00:15.595430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD6F31F70>]}
[0m14:00:15.597448 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:15.626322 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:20.117475 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:20.118489 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:20.124698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD72F63D0>]}
[0m14:00:20.163872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD723D130>]}
[0m14:00:20.163872 [info ] [MainThread]: Found 10 models, 8 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:20.164911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD723D0A0>]}
[0m14:00:20.167913 [info ] [MainThread]: 
[0m14:00:20.168925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:20.171937 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:20.171937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:20.174537 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:20.175510 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:21.326931 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:22.036680 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:00:22.036680 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:22.038682 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:00:22.059838 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:22.669846 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m14:00:22.674428 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:23.327132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD7303520>]}
[0m14:00:23.330764 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:23.333331 [info ] [MainThread]: 
[0m14:00:23.347109 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:23.351709 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:23.349696 [info ] [Thread-1  ]: 1 of 10 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m14:00:23.355270 [info ] [Thread-2  ]: 2 of 10 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m14:00:23.357285 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:23.357285 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:23.358794 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:23.358794 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:23.368443 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:23.372419 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:23.374975 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:23.368443 => 14:00:23.373945
[0m14:00:23.374975 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:23.375964 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:23.359802 => 14:00:23.375964
[0m14:00:23.401512 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:23.408634 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:23.413739 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:23.414349 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:23.416352 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m14:00:23.417352 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:23.441748 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:24.291722 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:94bd8d16-8a41-4455-af40-eb7a6bf78e7e&page=queryresults
[0m14:00:24.304321 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4870210c-70e0-4421-9c05-c4d02c7952ed&page=queryresults
[0m14:00:24.735994 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:23.401512 => 14:00:24.734995
[0m14:00:24.736994 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD733D040>]}
[0m14:00:24.736994 [info ] [Thread-1  ]: 1 of 10 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m14:00:24.738503 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:24.738503 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:24.739515 [info ] [Thread-1  ]: 3 of 10 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m14:00:24.742527 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:23.375964 => 14:00:24.742527
[0m14:00:24.743518 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:24.744134 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD733DB20>]}
[0m14:00:24.745137 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:24.748652 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:24.745137 [info ] [Thread-2  ]: 2 of 10 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m14:00:24.749660 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:24.749660 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.750663 [info ] [Thread-2  ]: 4 of 10 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m14:00:24.752665 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m14:00:24.752665 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.755173 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:24.756174 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:24.745137 => 14:00:24.756174
[0m14:00:24.757176 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:24.758719 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:24.759730 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:24.761778 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:24.761778 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 14:00:24.752665 => 14:00:24.761778
[0m14:00:24.785361 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.787363 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:24.788875 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:24.789887 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m14:00:25.511670 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc6ced2c-d1af-4440-8994-9de6ccdcda54&page=queryresults
[0m14:00:25.585723 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a4e32f5-21e4-444f-af6f-c318ca79dd18&page=queryresults
[0m14:00:25.943616 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:24.757176 => 14:00:25.940686
[0m14:00:25.950710 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD739BF10>]}
[0m14:00:25.956290 [info ] [Thread-1  ]: 3 of 10 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m14:00:25.960932 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:25.964487 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:25.967565 [info ] [Thread-1  ]: 5 of 10 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m14:00:25.971548 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m14:00:25.972525 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:25.988778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:25.994415 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 14:00:24.785361 => 14:00:25.994415
[0m14:00:25.995462 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD738A3A0>]}
[0m14:00:25.995462 [info ] [Thread-2  ]: 4 of 10 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m14:00:25.996430 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m14:00:25.997370 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:25.997370 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 14:00:25.972525 => 14:00:25.997370
[0m14:00:25.999908 [info ] [Thread-2  ]: 6 of 10 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m14:00:26.000909 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:26.001901 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m14:00:26.013984 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:26.013984 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:26.017075 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:26.018619 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:26.014979 => 14:00:26.018619
[0m14:00:26.018619 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:26.022647 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:26.023631 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:26.026231 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m14:00:26.051744 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:26.053254 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:26.996159 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de807ca6-8989-4989-a856-861a94791164&page=queryresults
[0m14:00:27.001732 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3198aad5-8855-42ec-b108-854b68a7cc51&page=queryresults
[0m14:00:27.398769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 14:00:26.001901 => 14:00:27.397257
[0m14:00:27.401797 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD83FEFA0>]}
[0m14:00:27.405921 [info ] [Thread-1  ]: 5 of 10 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m14:00:27.408459 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:27.432883 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:26.019628 => 14:00:27.432883
[0m14:00:27.435410 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD7327370>]}
[0m14:00:27.437427 [info ] [Thread-2  ]: 6 of 10 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m14:00:27.470614 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:27.487833 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:27.488844 [info ] [Thread-1  ]: 7 of 10 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m14:00:27.491844 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m14:00:27.491844 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:27.500947 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:27.501947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:27.493356 => 14:00:27.501947
[0m14:00:27.503456 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:27.511467 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:28.173977 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:28.174980 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:28.745347 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ab6647f-d4f1-47e9-a3b7-104cc82040ab&page=queryresults
[0m14:00:31.338764 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:27.503456 => 14:00:31.335764
[0m14:00:31.340763 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD8465EB0>]}
[0m14:00:31.341766 [info ] [Thread-1  ]: 7 of 10 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.85s]
[0m14:00:31.347280 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:31.351800 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:31.351800 [info ] [Thread-2  ]: 8 of 10 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m14:00:31.353309 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m14:00:31.354317 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:31.364873 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:31.366876 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:31.354317 => 14:00:31.366876
[0m14:00:31.367381 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:31.378772 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:32.248635 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:32.251638 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m14:00:32.910604 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d5dbcae5-7ae6-445c-8044-b230f97c28e3&page=queryresults
[0m14:00:35.447592 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:31.368387 => 14:00:35.447592
[0m14:00:35.449564 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD83FC160>]}
[0m14:00:35.451546 [info ] [Thread-2  ]: 8 of 10 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.10s]
[0m14:00:35.453538 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:35.456934 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:35.458493 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m14:00:35.458493 [info ] [Thread-1  ]: 9 of 10 START sql table model dbt_dw_az.tb_composicao_produto .................. [RUN]
[0m14:00:35.461526 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:35.461526 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:35.467195 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:35.459583 [info ] [Thread-2  ]: 10 of 10 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m14:00:35.471931 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m14:00:35.475522 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m14:00:35.480558 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:35.485305 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:35.462580 => 14:00:35.485305
[0m14:00:35.485305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 14:00:35.476604 => 14:00:35.485305
[0m14:00:35.486346 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:35.487327 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m14:00:35.488926 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:35.492037 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:36.175134 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:36.180797 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m14:00:36.192090 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:36.204322 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:36.827374 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e924e9d3-03f4-466f-ad36-929b085ef5e8&page=queryresults
[0m14:00:36.858607 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8426f56-1c80-4d4f-b1d8-35ecb2619f57&page=queryresults
[0m14:00:39.339749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:35.487327 => 14:00:39.338730
[0m14:00:39.341764 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD838B220>]}
[0m14:00:39.345046 [info ] [Thread-1  ]: 9 of 10 OK created sql table model dbt_dw_az.tb_composicao_produto ............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.88s]
[0m14:00:39.347137 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:39.947203 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 14:00:35.490023 => 14:00:39.947203
[0m14:00:39.948709 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748a85b8-1f1f-4016-9268-4ff58944f6d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD7379430>]}
[0m14:00:39.952269 [info ] [Thread-2  ]: 10 of 10 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.48s]
[0m14:00:39.955794 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m14:00:39.963334 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:39.964354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:39.964354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:39.965357 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m14:00:39.965357 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:39.966372 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m14:00:39.966372 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m14:00:39.966372 [info ] [MainThread]: 
[0m14:00:39.967369 [info ] [MainThread]: Finished running 6 view models, 4 table models in 0 hours 0 minutes and 19.80 seconds (19.80s).
[0m14:00:39.969928 [debug] [MainThread]: Command end result
[0m14:00:39.996003 [info ] [MainThread]: 
[0m14:00:39.997008 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:39.997008 [info ] [MainThread]: 
[0m14:00:39.998515 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=0 SKIP=0 TOTAL=10
[0m14:00:39.999519 [debug] [MainThread]: Command `dbt run` succeeded at 14:00:39.999519 after 25.41 seconds
[0m14:00:40.002527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD39E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD8482400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAD72DBE20>]}
[0m14:00:40.004040 [debug] [MainThread]: Flushing usage events
[0m15:00:04.227821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E4B85430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E3B27730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E3B27E50>]}


============================== 15:00:04.231788 | 220c376f-ecf0-4f01-8c12-cdd8100e6b19 ==============================
[0m15:00:04.231788 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:04.232427 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:00:04.810726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E3B19070>]}
[0m15:00:04.897742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E820E850>]}
[0m15:00:04.898773 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:04.905372 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:04.988727 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m15:00:04.988727 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_formas_pagamento.sql
[0m15:00:04.989722 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m15:00:05.199345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E874F6D0>]}
[0m15:00:05.211284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E83CF040>]}
[0m15:00:05.212296 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:05.212808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E83CFCA0>]}
[0m15:00:05.213819 [info ] [MainThread]: 
[0m15:00:05.214823 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:05.216837 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.217849 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.217849 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:05.218891 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.108076 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.121937 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:07.123620 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.126548 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:00:07.128131 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:08.010091 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:00:08.013653 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.690861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E8774100>]}
[0m15:00:08.692962 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:08.694706 [info ] [MainThread]: 
[0m15:00:08.707197 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.710242 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.708238 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:00:08.714061 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:08.715073 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.711397 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:00:08.725735 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:08.726815 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.729748 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.731807 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.733527 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:08.726815 => 15:00:08.733527
[0m15:00:08.733527 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.760226 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.760226 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:08.715073 => 15:00:08.760226
[0m15:00:08.761271 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.763866 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.763866 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:08.766242 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:08.766242 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:08.788010 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:00:09.583799 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fef3b48e-9fdc-4653-bd56-a92c1f3f5a8f&page=queryresults
[0m15:00:09.622691 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd10b0b2-5a56-4e01-ace6-448ccdaa397d&page=queryresults
[0m15:00:10.075428 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:08.761271 => 15:00:10.074394
[0m15:00:10.076404 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E8801070>]}
[0m15:00:10.079925 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:08.734580 => 15:00:10.079925
[0m15:00:10.076404 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m15:00:10.081183 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E818BE20>]}
[0m15:00:10.081937 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:10.083174 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.082556 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m15:00:10.084187 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:10.085187 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_formas_pagamento
[0m15:00:10.084187 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:00:10.085706 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:10.086718 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.089720 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.085706 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_formas_pagamento ................... [RUN]
[0m15:00:10.091726 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_formas_pagamento)
[0m15:00:10.092803 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_formas_pagamento
[0m15:00:10.095390 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_formas_pagamento"
[0m15:00:10.096289 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:10.086718 => 15:00:10.095390
[0m15:00:10.096289 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.098804 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.099804 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:10.100807 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:10.123398 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_formas_pagamento (compile): 15:00:10.092803 => 15:00:10.123398
[0m15:00:10.123398 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_formas_pagamento
[0m15:00:10.131065 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_formas_pagamento"
[0m15:00:10.132570 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:10.134594 [debug] [Thread-2  ]: On model.shibaribrasil.stg_formas_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_formas_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_formas_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                                     as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                              as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                               as ds_condicao_pagamento
         ,cast(nullif(taxas__aliquota, 0) as float64)                                              as vl_taxa_aliquota
         ,cast(nullif(taxas__valor, 0) as float64)                                                 as vl_taxa_fixa
         ,cast(nullif(taxas__prazo, 0) as float64)                                                 as qt_dias_pagamento
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:10.873833 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88085268-2935-4119-899c-28040d4574e1&page=queryresults
[0m15:00:10.890873 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9a6e4c0-2096-495f-80f4-2219c2027929&page=queryresults
[0m15:00:11.243978 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for function NULLIF\n  Argument types: STRING, INT64\n  Signature: NULLIF(T1, T1)\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {INT64, STRING} at [14:16]')
[0m15:00:11.291152 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:10.096289 => 15:00:11.291152
[0m15:00:11.293797 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E983A8E0>]}
[0m15:00:11.294886 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:11.297803 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.298797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.299791 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:00:11.304260 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m15:00:11.306243 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.313919 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.316919 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:00:11.307263 => 15:00:11.314916
[0m15:00:11.318438 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.322959 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.323971 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:11.324969 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:00:12.019198 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb718da0-2a2b-4471-84c9-e71b6a6ed493&page=queryresults
[0m15:00:12.460996 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:00:11.319458 => 15:00:12.457980
[0m15:00:12.467366 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E98800A0>]}
[0m15:00:12.469386 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m15:00:12.471401 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:00:12.473953 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.473953 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m15:00:12.475952 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m15:00:12.475952 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.480942 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.482453 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 15:00:12.476948 => 15:00:12.482453
[0m15:00:12.483511 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.485988 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.486988 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:12.487991 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m15:00:12.578871 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15a08406-2fd5-4f19-a0d2-481f58cb98ce&page=queryresults
[0m15:00:12.947887 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15a08406-2fd5-4f19-a0d2-481f58cb98ce&page=queryresults
[0m15:00:12.949929 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_formas_pagamento (execute): 15:00:10.124394 => 15:00:12.949929
[0m15:00:13.494670 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1674f18-36f6-4f66-94dc-014d8c19cd92&page=queryresults
[0m15:00:13.576390 [debug] [Thread-2  ]: Database Error in model stg_formas_pagamento (models\1.stg\stg_formas_pagamento.sql)
  No matching signature for function NULLIF
    Argument types: STRING, INT64
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {INT64, STRING} at [14:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_formas_pagamento.sql
[0m15:00:13.579015 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E983ECA0>]}
[0m15:00:13.581015 [error] [Thread-2  ]: 4 of 11 ERROR creating sql view model dbt_dw_stg.stg_formas_pagamento .......... [[31mERROR[0m in 3.49s]
[0m15:00:13.583766 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_formas_pagamento
[0m15:00:13.584764 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:13.585661 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m15:00:13.588771 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_formas_pagamento, now model.shibaribrasil.stg_produto)
[0m15:00:13.590766 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:13.599135 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:13.601090 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:13.591692 => 15:00:13.600055
[0m15:00:13.603698 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:13.625770 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:13.633310 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:13.637496 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:13.892876 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 15:00:12.483511 => 15:00:13.889870
[0m15:00:13.894546 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E989ACD0>]}
[0m15:00:13.895545 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m15:00:13.896555 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:14.397716 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87f15f12-e535-49a7-885e-c2ae9b790c74&page=queryresults
[0m15:00:14.791067 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:13.603698 => 15:00:14.791067
[0m15:00:14.794636 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E818BE20>]}
[0m15:00:14.795619 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:14.798145 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:14.799162 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:14.801161 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m15:00:14.802685 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m15:00:14.804722 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:14.809947 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:14.811948 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:14.804722 => 15:00:14.811948
[0m15:00:14.812961 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:14.819891 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:15.464221 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:15.469112 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:16.075677 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38da1d1f-2966-424a-a58f-7014472efc29&page=queryresults
[0m15:00:18.936052 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:14.812961 => 15:00:18.935068
[0m15:00:18.938070 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E880E4F0>]}
[0m15:00:18.939072 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.14s]
[0m15:00:18.941073 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:18.942585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:18.945464 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m15:00:18.946479 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m15:00:18.948087 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:18.955754 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:18.958776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:18.948087 => 15:00:18.957816
[0m15:00:18.959777 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:18.963490 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:19.715653 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:19.717657 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m15:00:20.384371 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:169694cc-fc8b-46c5-a53e-0b00c2e115de&page=queryresults
[0m15:00:22.629230 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:18.960766 => 15:00:22.628160
[0m15:00:22.631193 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E880E4F0>]}
[0m15:00:22.633769 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.68s]
[0m15:00:22.638092 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:22.641689 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:22.644216 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:00:22.646148 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:00:22.652822 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:22.647690 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m15:00:22.653443 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:22.655447 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m15:00:22.662637 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:00:22.678802 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:22.704566 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:22.707126 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:00:22.665650 => 15:00:22.706111
[0m15:00:22.708137 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:00:22.765069 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:22.766459 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:22.655447 => 15:00:22.766070
[0m15:00:22.766459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:22.768461 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:23.452577 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:23.454600 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_join_meta as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_join_meta
order by nm_produto_completo
    );
  
[0m15:00:23.576782 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:23.579799 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:24.108747 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6df1ae97-de7e-4759-9a14-c99dbdefb84c&page=queryresults
[0m15:00:24.288662 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:606d8223-f40b-4f4f-bac8-8e548e978e88&page=queryresults
[0m15:00:26.512793 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:22.767461 => 15:00:26.511183
[0m15:00:26.513811 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E84FAB20>]}
[0m15:00:26.514810 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.86s]
[0m15:00:26.516808 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:26.958173 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:00:22.709135 => 15:00:26.956647
[0m15:00:26.962752 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '220c376f-ecf0-4f01-8c12-cdd8100e6b19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E98D2100>]}
[0m15:00:26.964787 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (346.0 rows, 61.5 KiB processed)[0m in 4.31s]
[0m15:00:26.969086 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:00:26.976580 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:26.978109 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:26.978109 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:26.979144 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:26.981539 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:26.984125 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m15:00:26.985937 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:00:26.986963 [info ] [MainThread]: 
[0m15:00:26.988964 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 21.77 seconds (21.77s).
[0m15:00:26.994590 [debug] [MainThread]: Command end result
[0m15:00:27.015337 [info ] [MainThread]: 
[0m15:00:27.015337 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:00:27.016315 [info ] [MainThread]: 
[0m15:00:27.017823 [error] [MainThread]:   Database Error in model stg_formas_pagamento (models\1.stg\stg_formas_pagamento.sql)
  No matching signature for function NULLIF
    Argument types: STRING, INT64
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {INT64, STRING} at [14:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_formas_pagamento.sql
[0m15:00:27.019160 [info ] [MainThread]: 
[0m15:00:27.020172 [info ] [MainThread]: Done. PASS=10 WARN=0 ERROR=1 SKIP=0 TOTAL=11
[0m15:00:27.021535 [debug] [MainThread]: Command `dbt run` failed at 15:00:27.021535 after 22.85 seconds
[0m15:00:27.021535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E4B85430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E80E9190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7E850CB80>]}
[0m15:00:27.023043 [debug] [MainThread]: Flushing usage events
[0m15:00:34.197745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9C716460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9B6959A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9B695D30>]}


============================== 15:00:34.201746 | 4c5544a6-a821-4321-89c9-cc1e50379413 ==============================
[0m15:00:34.201746 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:34.206964 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_forma_pagamento', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:00:34.741118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9B687040>]}
[0m15:00:34.809554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FC68760>]}
[0m15:00:34.810977 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:34.821095 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:34.895998 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m15:00:34.896981 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_forma_pagamento.sql
[0m15:00:34.896981 [debug] [MainThread]: Partial parsing: deleted file: shibaribrasil://models\1.stg\stg_formas_pagamento.sql
[0m15:00:35.007604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DCA018F430>]}
[0m15:00:35.016163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FEA16A0>]}
[0m15:00:35.017672 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:35.017672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FEA1790>]}
[0m15:00:35.019679 [info ] [MainThread]: 
[0m15:00:35.020682 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:35.023381 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:35.023381 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:35.670892 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:35.673402 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:35.674417 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:00:35.675416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:36.384799 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:00:36.388814 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:37.365546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FDB7760>]}
[0m15:00:37.366197 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:37.366703 [info ] [MainThread]: 
[0m15:00:37.372742 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:37.372742 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_forma_pagamento ..................... [RUN]
[0m15:00:37.373756 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_forma_pagamento'
[0m15:00:37.374750 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:00:37.380752 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:37.382763 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:00:37.374750 => 15:00:37.381756
[0m15:00:37.382763 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:00:37.406114 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:37.407079 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:37.408114 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                                     as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                              as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                               as ds_condicao_pagamento
         ,cast(nullif(taxas__aliquota, 0) as float64)                                              as vl_taxa_aliquota
         ,cast(nullif(taxas__valor, 0) as float64)                                                 as vl_taxa_fixa
         ,cast(nullif(taxas__prazo, 0) as float64)                                                 as qt_dias_pagamento
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:38.283458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1684ad21-a239-41e5-9f32-45f205afcff9&page=queryresults
[0m15:00:38.759903 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for function NULLIF\n  Argument types: STRING, INT64\n  Signature: NULLIF(T1, T1)\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {INT64, STRING} at [14:16]')
[0m15:00:39.368903 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc97c180-9b37-4571-9c55-b95956cf04a2&page=queryresults
[0m15:00:39.714383 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc97c180-9b37-4571-9c55-b95956cf04a2&page=queryresults
[0m15:00:39.717947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:00:37.382763 => 15:00:39.716412
[0m15:00:39.746739 [debug] [Thread-1  ]: Database Error in model stg_forma_pagamento (models\1.stg\stg_forma_pagamento.sql)
  No matching signature for function NULLIF
    Argument types: STRING, INT64
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {INT64, STRING} at [14:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_forma_pagamento.sql
[0m15:00:39.748734 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c5544a6-a821-4321-89c9-cc1e50379413', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DCA1222640>]}
[0m15:00:39.753258 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_forma_pagamento ............ [[31mERROR[0m in 2.37s]
[0m15:00:39.757848 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:39.762932 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:39.762932 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:39.763951 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:00:39.763951 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:39.763951 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_forma_pagamento' was properly closed.
[0m15:00:39.763951 [info ] [MainThread]: 
[0m15:00:39.764972 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.74 seconds (4.74s).
[0m15:00:39.765970 [debug] [MainThread]: Command end result
[0m15:00:39.782591 [info ] [MainThread]: 
[0m15:00:39.784615 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:00:39.785621 [info ] [MainThread]: 
[0m15:00:39.787626 [error] [MainThread]:   Database Error in model stg_forma_pagamento (models\1.stg\stg_forma_pagamento.sql)
  No matching signature for function NULLIF
    Argument types: STRING, INT64
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {INT64, STRING} at [14:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_forma_pagamento.sql
[0m15:00:39.791630 [info ] [MainThread]: 
[0m15:00:39.794435 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:00:39.795504 [debug] [MainThread]: Command `dbt run` failed at 15:00:39.795504 after 5.69 seconds
[0m15:00:39.796489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9C716460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FC68760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002DC9FE43250>]}
[0m15:00:39.796489 [debug] [MainThread]: Flushing usage events
[0m15:02:01.757845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172552BE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017254248640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017254248AC0>]}


============================== 15:02:01.760854 | 5a0c0937-9556-457f-a674-fc620c86a6ca ==============================
[0m15:02:01.760854 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:02:01.762359 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_forma_pagamento', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:02:02.290746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001725740CB20>]}
[0m15:02:02.356193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258805FD0>]}
[0m15:02:02.358730 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:02:02.364847 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:02:02.456217 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:02:02.456217 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_forma_pagamento.sql
[0m15:02:02.566147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258D3F2E0>]}
[0m15:02:02.576907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258A595E0>]}
[0m15:02:02.577906 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:02:02.578908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258A596D0>]}
[0m15:02:02.580910 [info ] [MainThread]: 
[0m15:02:02.582416 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:02:02.583425 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:02:02.584422 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:03.373207 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:02:03.375749 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:03.377747 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:02:03.378745 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:04.066466 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:02:04.067978 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:02:04.742616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001725898FFD0>]}
[0m15:02:04.744641 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:02:04.746634 [info ] [MainThread]: 
[0m15:02:04.761701 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:02:04.763232 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_forma_pagamento ..................... [RUN]
[0m15:02:04.767776 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_forma_pagamento'
[0m15:02:04.770834 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:02:04.807688 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:02:04.812685 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:02:04.771827 => 15:02:04.811677
[0m15:02:04.812685 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:02:04.849994 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:02:04.850995 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:02:04.853513 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                                     as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                              as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                               as ds_condicao_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:02:06.036850 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a014e02c-67cc-4544-b2c4-85d19c626415&page=queryresults
[0m15:02:06.503210 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:02:04.814167 => 15:02:06.503210
[0m15:02:06.504215 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a0c0937-9556-457f-a674-fc620c86a6ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258961DF0>]}
[0m15:02:06.504215 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_forma_pagamento ................ [[32mCREATE VIEW (0 processed)[0m in 1.74s]
[0m15:02:06.505214 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:02:06.507821 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:02:06.507821 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:02:06.507821 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:02:06.507821 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:02:06.507821 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_forma_pagamento' was properly closed.
[0m15:02:06.508942 [info ] [MainThread]: 
[0m15:02:06.509831 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.93 seconds (3.93s).
[0m15:02:06.511886 [debug] [MainThread]: Command end result
[0m15:02:06.525527 [info ] [MainThread]: 
[0m15:02:06.526527 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:02:06.526527 [info ] [MainThread]: 
[0m15:02:06.528036 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:02:06.529045 [debug] [MainThread]: Command `dbt run` succeeded at 15:02:06.529045 after 4.83 seconds
[0m15:02:06.530049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172552BE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172589B7C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017258BFA370>]}
[0m15:02:06.530049 [debug] [MainThread]: Flushing usage events
[0m15:14:09.528470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D0D92E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D0C8B8640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D0C8B8AC0>]}


============================== 15:14:09.532472 | 8ee207bf-6455-4985-b682-4162eff1a876 ==============================
[0m15:14:09.532472 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:14:09.532984 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:14:10.053893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8ee207bf-6455-4985-b682-4162eff1a876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D0C8AB910>]}
[0m15:14:10.126623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8ee207bf-6455-4985-b682-4162eff1a876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D10EB40A0>]}
[0m15:14:10.127624 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:14:10.134978 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:14:10.253901 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:14:10.254900 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_forma_pagamento.sql
[0m15:14:10.254900 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:14:10.360312 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.shibaribrasil.tb_preco_produto' (models\3.az\tb_preco_produto.sql) depends on a node named 'formas_pagamentos_detalhes' which was not found
[0m15:14:10.361306 [debug] [MainThread]: Command `dbt run` failed at 15:14:10.361306 after 0.90 seconds
[0m15:14:10.362307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D0D92E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D11392B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028D1125E1C0>]}
[0m15:14:10.362307 [debug] [MainThread]: Flushing usage events
[0m15:14:35.515669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019951E023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019950DA12E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019950DA1760>]}


============================== 15:14:35.520668 | f35d7a50-9094-46b8-a36b-20cf80e1dfd1 ==============================
[0m15:14:35.520668 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:14:35.520668 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:14:36.005422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019950D8C0D0>]}
[0m15:14:36.074283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019955420E50>]}
[0m15:14:36.076227 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:14:36.082502 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:14:36.149643 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:14:36.150649 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:14:36.151650 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_forma_pagamento.sql
[0m15:14:36.267587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001995587C190>]}
[0m15:14:36.278634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199555BA4F0>]}
[0m15:14:36.278634 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:14:36.280635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199555BA550>]}
[0m15:14:36.281633 [info ] [MainThread]: 
[0m15:14:36.282633 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:14:36.284153 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:14:36.284153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:14:37.361057 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:14:37.363638 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:14:37.366448 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:14:37.369011 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:14:38.109005 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:14:38.117651 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:14:38.792597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199554E4430>]}
[0m15:14:38.797619 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:14:38.802544 [info ] [MainThread]: 
[0m15:14:38.820047 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:14:38.824619 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:14:38.830717 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:14:38.832713 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:14:38.848728 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:14:38.854247 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:14:38.834119 => 15:14:38.853236
[0m15:14:38.855249 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:14:38.869622 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:14:39.634352 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:14:39.635357 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_aliquota) as tx_aliquota_cartao
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_fixa)     as tx_fixa_cartao
          ,if(nm_forma_pagamento = '[Nuvem] PIX', vl_taxa_aliquota)               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                      as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
     join cte_forma_pagamento as c 
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m15:14:40.408672 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c89cf91-ee76-49d9-b254-6f2ba1c19489&page=queryresults
[0m15:14:40.811042 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('INNER JOIN must have an immediately following ON or USING clause at [87:6]')
[0m15:14:41.510191 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d7c035a-c901-4126-bd9d-bf5d17887037&page=queryresults
[0m15:14:41.885923 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d7c035a-c901-4126-bd9d-bf5d17887037&page=queryresults
[0m15:14:41.889001 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:14:38.855249 => 15:14:41.887949
[0m15:14:41.899616 [debug] [Thread-1  ]: Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  INNER JOIN must have an immediately following ON or USING clause at [87:6]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:14:41.900621 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f35d7a50-9094-46b8-a36b-20cf80e1dfd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001995696CB50>]}
[0m15:14:41.902848 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_preco_produto ............... [[31mERROR[0m in 3.07s]
[0m15:14:41.904888 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:14:41.907137 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:14:41.908161 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:14:41.908161 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:14:41.908161 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:14:41.909159 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:14:41.909159 [info ] [MainThread]: 
[0m15:14:41.910147 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.63 seconds (5.63s).
[0m15:14:41.911150 [debug] [MainThread]: Command end result
[0m15:14:41.928884 [info ] [MainThread]: 
[0m15:14:41.929888 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:14:41.930885 [info ] [MainThread]: 
[0m15:14:41.931881 [error] [MainThread]:   Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  INNER JOIN must have an immediately following ON or USING clause at [87:6]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:14:41.931881 [info ] [MainThread]: 
[0m15:14:41.932885 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:14:41.933995 [debug] [MainThread]: Command `dbt run` failed at 15:14:41.932885 after 6.48 seconds
[0m15:14:41.933995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019951E023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019955420E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001994FEA86D0>]}
[0m15:14:41.935006 [debug] [MainThread]: Flushing usage events
[0m15:15:31.260617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D819ED13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D818E792E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D818E79760>]}


============================== 15:15:31.264695 | 7bed3c07-9c29-44cb-b5a4-3b00e424baf4 ==============================
[0m15:15:31.264695 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:15:31.265701 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:15:31.747633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D818E5C130>]}
[0m15:15:31.814285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D55F760>]}
[0m15:15:31.815299 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:15:31.823611 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:15:31.927905 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:15:31.928895 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:15:32.035596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D8ECFA0>]}
[0m15:15:32.045534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D69D460>]}
[0m15:15:32.045534 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:15:32.046600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D69D550>]}
[0m15:15:32.047592 [info ] [MainThread]: 
[0m15:15:32.048533 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:15:32.050571 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:15:32.050571 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:15:32.812569 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:15:32.816881 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:15:32.823505 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:15:32.825522 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:15:33.469777 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:15:33.474900 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:15:34.148758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D5B9E80>]}
[0m15:15:34.149754 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:15:34.150760 [info ] [MainThread]: 
[0m15:15:34.156270 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:15:34.156270 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:15:34.157234 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:15:34.158587 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:15:34.168694 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:15:34.171703 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:15:34.159586 => 15:15:34.170699
[0m15:15:34.173329 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:15:34.183879 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:15:34.844491 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:15:34.845967 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_aliquota) as tx_aliquota_cartao
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_fixa)     as tx_fixa_cartao
          ,if(nm_forma_pagamento = '[Nuvem] PIX', vl_taxa_aliquota)               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                      as vl_desconto_fixo_pix
     from cte_produto     as a
         ,cte_forma_pagamento as c 
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m15:15:35.546685 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cfb8f16d-d1f1-4228-b645-078e9577aa16&page=queryresults
[0m15:15:35.956064 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for function IF\n  Argument types: BOOL, FLOAT64\n  Signature: IF(BOOL, T1, T1)\n    Signature requires at least 3 arguments, found 2 arguments at [78:12]')
[0m15:15:37.280289 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ac18973-836f-45fb-956f-22200009e0ea&page=queryresults
[0m15:15:37.659218 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ac18973-836f-45fb-956f-22200009e0ea&page=queryresults
[0m15:15:37.662888 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:15:34.173329 => 15:15:37.661229
[0m15:15:37.677735 [debug] [Thread-1  ]: Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  No matching signature for function IF
    Argument types: BOOL, FLOAT64
    Signature: IF(BOOL, T1, T1)
      Signature requires at least 3 arguments, found 2 arguments at [78:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:15:37.680307 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bed3c07-9c29-44cb-b5a4-3b00e424baf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81EA0A850>]}
[0m15:15:37.682930 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_preco_produto ............... [[31mERROR[0m in 3.52s]
[0m15:15:37.686006 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:15:37.697896 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:15:37.697896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:15:37.699038 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:15:37.699038 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:15:37.699038 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:15:37.699918 [info ] [MainThread]: 
[0m15:15:37.703622 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.65 seconds (5.65s).
[0m15:15:37.706644 [debug] [MainThread]: Command end result
[0m15:15:37.718107 [info ] [MainThread]: 
[0m15:15:37.720120 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:15:37.721171 [info ] [MainThread]: 
[0m15:15:37.722719 [error] [MainThread]:   Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  No matching signature for function IF
    Argument types: BOOL, FLOAT64
    Signature: IF(BOOL, T1, T1)
      Signature requires at least 3 arguments, found 2 arguments at [78:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:15:37.723638 [info ] [MainThread]: 
[0m15:15:37.724765 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:15:37.726325 [debug] [MainThread]: Command `dbt run` failed at 15:15:37.726325 after 6.54 seconds
[0m15:15:37.726325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D819ED13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D55F760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D81D75A760>]}
[0m15:15:37.726325 [debug] [MainThread]: Flushing usage events
[0m15:16:11.787573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C28EA6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C27E1C6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C27E1CDC0>]}


============================== 15:16:11.793948 | 3de4b2e5-46c8-4419-a3b5-d3b30259cf9e ==============================
[0m15:16:11.793948 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:16:11.794956 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_preco_produto', 'send_anonymous_usage_stats': 'True'}
[0m15:16:12.367590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C27E15070>]}
[0m15:16:12.470866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C510850>]}
[0m15:16:12.472381 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:16:12.479494 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:16:12.623525 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:16:12.624526 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:16:12.739513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C91E160>]}
[0m15:16:12.752782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C631490>]}
[0m15:16:12.753804 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:16:12.754856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C631580>]}
[0m15:16:12.756421 [info ] [MainThread]: 
[0m15:16:12.758166 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:16:12.759192 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:16:12.760198 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:16:13.456522 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:16:13.457515 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:16:13.458770 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:16:13.462780 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:16:14.166481 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:16:14.169471 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:16:14.833582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C555D60>]}
[0m15:16:14.836577 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:16:14.837588 [info ] [MainThread]: 
[0m15:16:14.860449 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:16:14.864850 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:16:14.869881 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:16:14.870875 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:16:14.903308 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:16:14.907911 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:16:14.870875 => 15:16:14.906380
[0m15:16:14.909953 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:16:14.928785 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:16:15.682630 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:16:15.684870 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_aliquota, 0) as tx_aliquota_cartao
          ,if(nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_fixa, 0)     as tx_fixa_cartao
          ,if(nm_forma_pagamento = '[Nuvem] PIX', vl_taxa_aliquota, 0)               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
         ,cte_forma_pagamento as c 
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m15:16:16.438587 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25cf50e7-ed68-42ee-9836-92ef5e519e7c&page=queryresults
[0m15:16:16.814362 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: nm_produto_completo at [93:10]')
[0m15:16:17.866774 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9eb27b1e-8548-49e3-b11a-66388c1e4a2a&page=queryresults
[0m15:16:18.212592 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9eb27b1e-8548-49e3-b11a-66388c1e4a2a&page=queryresults
[0m15:16:18.213918 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:16:14.910953 => 15:16:18.213918
[0m15:16:18.226791 [debug] [Thread-1  ]: Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  Unrecognized name: nm_produto_completo at [93:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:16:18.227904 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3de4b2e5-46c8-4419-a3b5-d3b30259cf9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2D9D3730>]}
[0m15:16:18.228895 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_preco_produto ............... [[31mERROR[0m in 3.36s]
[0m15:16:18.229791 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:16:18.233407 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:16:18.233407 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:16:18.234412 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:16:18.235409 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:16:18.236410 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:16:18.237914 [info ] [MainThread]: 
[0m15:16:18.238937 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.48 seconds (5.48s).
[0m15:16:18.240930 [debug] [MainThread]: Command end result
[0m15:16:18.268924 [info ] [MainThread]: 
[0m15:16:18.270908 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:16:18.272529 [info ] [MainThread]: 
[0m15:16:18.274619 [error] [MainThread]:   Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  Unrecognized name: nm_produto_completo at [93:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:16:18.276538 [info ] [MainThread]: 
[0m15:16:18.277542 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:16:18.285747 [debug] [MainThread]: Command `dbt run` failed at 15:16:18.284749 after 6.56 seconds
[0m15:16:18.287762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C28EA6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C510850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C2C7AA520>]}
[0m15:16:18.288740 [debug] [MainThread]: Flushing usage events
[0m15:17:10.648532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEA8D23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE986C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE986C760>]}


============================== 15:17:10.651536 | 8148097e-3a9d-4080-9274-2621b435bc7f ==============================
[0m15:17:10.651536 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:17:10.652531 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:17:11.184498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE9866910>]}
[0m15:17:11.266762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEDF63AC0>]}
[0m15:17:11.267758 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:17:11.277598 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:17:11.377699 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:17:11.377699 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:17:11.494591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEE36D340>]}
[0m15:17:11.506931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEE0726D0>]}
[0m15:17:11.507936 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:17:11.507936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEE072730>]}
[0m15:17:11.509938 [info ] [MainThread]: 
[0m15:17:11.510901 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:17:11.510901 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:17:11.512425 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:12.251629 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:17:12.255166 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:12.256163 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:17:12.256163 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:12.925368 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:17:12.930905 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:17:13.910791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEDFBD580>]}
[0m15:17:13.914346 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:17:13.916410 [info ] [MainThread]: 
[0m15:17:13.930726 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:17:13.932312 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:17:13.935922 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:17:13.938535 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:17:13.952632 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:17:13.956841 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:17:13.940768 => 15:17:13.955803
[0m15:17:13.956841 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:17:13.971148 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:17:14.653985 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:17:14.655992 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,if(c.nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_aliquota, 0) as tx_aliquota_cartao
          ,if(c.nm_forma_pagamento = '[Nuvem] Cartão de Crédito', vl_taxa_fixa, 0)     as tx_fixa_cartao
          ,if(c.nm_forma_pagamento = '[Nuvem] PIX', vl_taxa_aliquota, 0)               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
         ,cte_forma_pagamento as c 
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
     
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:17:15.320791 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d51eaccd-74ad-4fc5-be16-a535164f1b72&page=queryresults
[0m15:17:17.886999 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:17:13.957927 => 15:17:17.885466
[0m15:17:17.888029 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8148097e-3a9d-4080-9274-2621b435bc7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEE387DF0>]}
[0m15:17:17.888029 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (692.0 rows, 61.7 KiB processed)[0m in 3.95s]
[0m15:17:17.890033 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:17:17.892554 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:17:17.893589 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:17:17.893589 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:17:17.893589 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:17:17.894616 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:17:17.894616 [info ] [MainThread]: 
[0m15:17:17.895613 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.38 seconds (6.38s).
[0m15:17:17.896616 [debug] [MainThread]: Command end result
[0m15:17:17.923538 [info ] [MainThread]: 
[0m15:17:17.924543 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:17:17.924543 [info ] [MainThread]: 
[0m15:17:17.925560 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:17:17.928573 [debug] [MainThread]: Command `dbt run` succeeded at 15:17:17.928573 after 7.34 seconds
[0m15:17:17.929851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEA8D23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEDEEBCD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFEE22B3A0>]}
[0m15:17:17.929851 [debug] [MainThread]: Flushing usage events
[0m15:22:48.618750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002264342C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226423B69D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226423B6B80>]}


============================== 15:22:48.623370 | f187d7bc-be67-42ac-ae56-a39d5f338740 ==============================
[0m15:22:48.623370 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:22:48.623370 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_preco_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:22:49.105887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002264239CA30>]}
[0m15:22:49.176116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646B75820>]}
[0m15:22:49.177722 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:22:49.185439 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:22:49.289749 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:22:49.290747 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:22:49.396388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646E8A520>]}
[0m15:22:49.405969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646BB2850>]}
[0m15:22:49.406990 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:22:49.407987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646BB2940>]}
[0m15:22:49.408983 [info ] [MainThread]: 
[0m15:22:49.408983 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:22:49.410980 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:22:49.410980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:50.178306 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:22:50.182877 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:50.186029 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:22:50.189676 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:50.935207 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:22:50.939738 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:22:51.702314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646A23730>]}
[0m15:22:51.704340 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:22:51.707527 [info ] [MainThread]: 
[0m15:22:51.731634 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:22:51.734200 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:22:51.743709 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:22:51.745737 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:22:51.814527 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:22:51.818089 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:22:51.747773 => 15:22:51.816561
[0m15:22:51.821619 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:22:51.856423 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:22:52.613617 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:22:52.615563 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_fixa_cartao
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_cartao
          --regra manual de desconto do pix
          ,3                                                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:22:53.370054 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:420f5f6d-1729-4e7c-8681-008c57cc1638&page=queryresults
[0m15:22:53.778562 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('CREATE TABLE has columns with duplicate name tx_aliquota_cartao at [17:1]')
[0m15:22:55.074583 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:541ad847-88c0-4ffd-abb5-caa66a1ae425&page=queryresults
[0m15:22:55.476771 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:541ad847-88c0-4ffd-abb5-caa66a1ae425&page=queryresults
[0m15:22:55.478778 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:22:51.822612 => 15:22:55.477771
[0m15:22:55.483367 [debug] [Thread-1  ]: Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  CREATE TABLE has columns with duplicate name tx_aliquota_cartao at [17:1]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:22:55.484710 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f187d7bc-be67-42ac-ae56-a39d5f338740', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022647F21A60>]}
[0m15:22:55.484710 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_preco_produto ............... [[31mERROR[0m in 3.75s]
[0m15:22:55.486713 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:22:55.488722 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:22:55.489723 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:22:55.490723 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:22:55.490723 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:22:55.491721 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:22:55.491721 [info ] [MainThread]: 
[0m15:22:55.491721 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.08 seconds (6.08s).
[0m15:22:55.492722 [debug] [MainThread]: Command end result
[0m15:22:55.504373 [info ] [MainThread]: 
[0m15:22:55.505370 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:22:55.506366 [info ] [MainThread]: 
[0m15:22:55.506366 [error] [MainThread]:   Database Error in model tb_preco_produto (models\3.az\tb_preco_produto.sql)
  CREATE TABLE has columns with duplicate name tx_aliquota_cartao at [17:1]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_preco_produto.sql
[0m15:22:55.507876 [info ] [MainThread]: 
[0m15:22:55.507876 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:22:55.508884 [debug] [MainThread]: Command `dbt run` failed at 15:22:55.508884 after 6.95 seconds
[0m15:22:55.509886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002264342C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646B75820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022646B22160>]}
[0m15:22:55.510899 [debug] [MainThread]: Flushing usage events
[0m15:23:19.439372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B3E1E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B3D17C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B3D17C760>]}


============================== 15:23:19.442893 | f5943679-deb0-438e-a842-961fb07cd161 ==============================
[0m15:23:19.442893 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:23:19.442893 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_preco_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:23:19.928008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B3D16CA60>]}
[0m15:23:20.000586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B41870FA0>]}
[0m15:23:20.002133 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:23:20.007857 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:23:20.117776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:23:20.117776 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:23:20.228587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B41C66520>]}
[0m15:23:20.238824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B419818B0>]}
[0m15:23:20.239823 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:23:20.239823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B41981910>]}
[0m15:23:20.240889 [info ] [MainThread]: 
[0m15:23:20.240889 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:23:20.244556 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:23:20.244556 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:20.955495 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:23:20.957497 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:20.962580 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:23:20.963951 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:21.572719 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:23:21.582317 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:23:22.162518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B417DF730>]}
[0m15:23:22.165868 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:23:22.168511 [info ] [MainThread]: 
[0m15:23:22.196339 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:23:22.199046 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:23:22.202497 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:23:22.204521 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:23:22.213025 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:23:22.214032 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:23:22.204521 => 15:23:22.214032
[0m15:23:22.214032 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:23:22.228672 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:23:23.156105 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:23:23.157618 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,b.pr_desconto_padrao 
          ,b.pr_meta_margem 
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_fixa_cartao
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:23:23.824766 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e144687e-5ffc-4a4b-8bf9-829a9f211091&page=queryresults
[0m15:23:27.305831 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:23:22.214032 => 15:23:27.305408
[0m15:23:27.305831 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5943679-deb0-438e-a842-961fb07cd161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B42D31C10>]}
[0m15:23:27.306836 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (346.0 rows, 61.7 KiB processed)[0m in 5.11s]
[0m15:23:27.307880 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:23:27.309838 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:23:27.310943 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:23:27.311620 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:23:27.311620 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:23:27.311620 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:23:27.311620 [info ] [MainThread]: 
[0m15:23:27.312813 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.07 seconds (7.07s).
[0m15:23:27.313868 [debug] [MainThread]: Command end result
[0m15:23:27.323398 [info ] [MainThread]: 
[0m15:23:27.324371 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:23:27.325370 [info ] [MainThread]: 
[0m15:23:27.325811 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:23:27.326818 [debug] [MainThread]: Command `dbt run` succeeded at 15:23:27.326818 after 7.94 seconds
[0m15:23:27.326818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B3E1E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B418C9280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B41B39550>]}
[0m15:23:27.326818 [debug] [MainThread]: Flushing usage events
[0m15:42:05.569527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C73302430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C722A92E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C722A9760>]}


============================== 15:42:05.574051 | 934ad5e0-aef8-4473-a8a1-fd2a9253130f ==============================
[0m15:42:05.574051 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:42:05.575050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_preco_produto', 'send_anonymous_usage_stats': 'True'}
[0m15:42:06.478052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C75D16BE0>]}
[0m15:42:06.567593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C7687E790>]}
[0m15:42:06.570626 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:42:06.583750 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:42:06.715112 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:42:06.715112 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:42:06.861329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C76D0BAF0>]}
[0m15:42:06.872078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C76AD4CD0>]}
[0m15:42:06.873101 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:42:06.874169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C769289D0>]}
[0m15:42:06.875151 [info ] [MainThread]: 
[0m15:42:06.876159 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:42:06.878697 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:42:06.879695 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:42:07.634879 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:42:07.635885 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:42:07.635885 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:42:07.637480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:42:08.369361 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:42:08.372363 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:42:09.010553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C7691F1F0>]}
[0m15:42:09.016070 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:42:09.016070 [info ] [MainThread]: 
[0m15:42:09.029189 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:42:09.030191 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:42:09.032191 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:42:09.032697 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:42:09.043663 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:42:09.047181 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:42:09.032697 => 15:42:09.046204
[0m15:42:09.047181 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:42:09.060585 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:42:09.798481 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:42:09.799420 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                         as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                         as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                             as pr_meta_margem 
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_fixa_cartao
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:42:10.590325 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9401072c-fa54-4c05-b864-d401a793cdcf&page=queryresults
[0m15:42:13.183083 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:42:09.047181 => 15:42:13.182075
[0m15:42:13.183083 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '934ad5e0-aef8-4473-a8a1-fd2a9253130f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C76DC0D00>]}
[0m15:42:13.184082 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (346.0 rows, 61.7 KiB processed)[0m in 4.15s]
[0m15:42:13.188710 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:42:13.192240 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:42:13.193247 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:42:13.193247 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:42:13.193247 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:42:13.194248 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:42:13.194248 [info ] [MainThread]: 
[0m15:42:13.195254 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.32 seconds (6.32s).
[0m15:42:13.196249 [debug] [MainThread]: Command end result
[0m15:42:13.220334 [info ] [MainThread]: 
[0m15:42:13.223860 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:42:13.225864 [info ] [MainThread]: 
[0m15:42:13.229384 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:42:13.237428 [debug] [MainThread]: Command `dbt run` succeeded at 15:42:13.236419 after 7.77 seconds
[0m15:42:13.238426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C73302430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C769231C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015C769117F0>]}
[0m15:42:13.240428 [debug] [MainThread]: Flushing usage events
[0m15:45:51.782283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273ACBDC460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273ABB699D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273ABB69B80>]}


============================== 15:45:51.785808 | 80afb5c7-f95f-4e7a-9729-8c29fd0c27ba ==============================
[0m15:45:51.785808 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:45:51.785808 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:45:52.304998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273AED2DB80>]}
[0m15:45:52.377201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B02467C0>]}
[0m15:45:52.378236 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:45:52.387335 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:45:52.475103 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:45:52.476106 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:45:52.595761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B0591FA0>]}
[0m15:45:52.607244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B0371400>]}
[0m15:45:52.608287 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:45:52.610294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B03714F0>]}
[0m15:45:52.611292 [info ] [MainThread]: 
[0m15:45:52.614538 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:45:52.620551 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:45:52.623111 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:53.332338 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:45:53.335419 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:53.340392 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:45:53.343488 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:54.143945 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:45:54.144959 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:45:54.875723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B0591FA0>]}
[0m15:45:54.880271 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:45:54.883350 [info ] [MainThread]: 
[0m15:45:54.917193 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:45:54.921199 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:45:54.924758 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:45:54.927281 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:45:54.956672 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:45:54.960850 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:45:54.928309 => 15:45:54.959854
[0m15:45:54.962360 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:45:54.978435 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:45:55.657253 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:45:55.659064 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                         as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                         as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                             as pr_meta_margem 
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_fixa_cartao
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:45:56.332133 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75e88331-584d-477e-a645-e91da50a18ac&page=queryresults
[0m15:45:58.698298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:45:54.963375 => 15:45:58.697290
[0m15:45:58.700272 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80afb5c7-f95f-4e7a-9729-8c29fd0c27ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B06593D0>]}
[0m15:45:58.701285 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 61.7 KiB processed)[0m in 3.78s]
[0m15:45:58.704848 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:45:58.711433 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:45:58.712465 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:45:58.713020 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:45:58.715026 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:45:58.716043 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:45:58.718611 [info ] [MainThread]: 
[0m15:45:58.720654 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.10 seconds (6.10s).
[0m15:45:58.726241 [debug] [MainThread]: Command end result
[0m15:45:58.776243 [info ] [MainThread]: 
[0m15:45:58.779227 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:45:58.785088 [info ] [MainThread]: 
[0m15:45:58.788669 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:45:58.792192 [debug] [MainThread]: Command `dbt run` succeeded at 15:45:58.792192 after 7.06 seconds
[0m15:45:58.795216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273ACBDC460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B0277820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B051A100>]}
[0m15:45:58.798260 [debug] [MainThread]: Flushing usage events
[0m15:48:17.176000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D719F2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D709992E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D70999760>]}


============================== 15:48:17.179478 | ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03 ==============================
[0m15:48:17.179478 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:48:17.180479 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_preco_produto', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:48:17.780101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D70986250>]}
[0m15:48:17.852407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D75083C70>]}
[0m15:48:17.854421 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:48:17.863973 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:48:17.948312 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:48:17.949315 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:48:18.063847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D7548D310>]}
[0m15:48:18.074905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D751A16A0>]}
[0m15:48:18.074905 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:48:18.075905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D751A1700>]}
[0m15:48:18.077413 [info ] [MainThread]: 
[0m15:48:18.079420 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:48:18.080419 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:48:18.080419 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:19.118343 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:48:19.120668 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:19.127245 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:48:19.132765 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:19.927542 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:48:19.928593 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:48:20.663116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D750CDE80>]}
[0m15:48:20.665126 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:48:20.666118 [info ] [MainThread]: 
[0m15:48:20.685557 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:48:20.688128 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:48:20.694705 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:48:20.698459 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:48:20.746200 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:48:20.749223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:48:20.700496 => 15:48:20.748155
[0m15:48:20.750157 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:48:20.801169 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:48:21.546415 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:48:21.547413 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                         as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                         as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                             as pr_meta_margem 
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_fixa_cartao
          ,(select vl_taxa_aliquota from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,3                                                                                                         as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:48:22.262084 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cee7b1c5-26a6-498a-bfde-27db9fd95397&page=queryresults
[0m15:48:24.566106 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:48:20.751164 => 15:48:24.566106
[0m15:48:24.566106 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed8311bf-71b6-4ba9-bfb7-a96dd5c79a03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D754C1EB0>]}
[0m15:48:24.567121 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 3.87s]
[0m15:48:24.568100 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:48:24.569098 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:24.570101 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:48:24.571106 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:48:24.571106 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:48:24.571106 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:48:24.572104 [info ] [MainThread]: 
[0m15:48:24.572104 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.49 seconds (6.49s).
[0m15:48:24.573530 [debug] [MainThread]: Command end result
[0m15:48:24.582606 [info ] [MainThread]: 
[0m15:48:24.583614 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:48:24.583614 [info ] [MainThread]: 
[0m15:48:24.584611 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:48:24.584611 [debug] [MainThread]: Command `dbt run` succeeded at 15:48:24.584611 after 7.47 seconds
[0m15:48:24.585632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D719F2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D75361550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016D7534A340>]}
[0m15:48:24.585632 [debug] [MainThread]: Flushing usage events
[0m15:54:25.248616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED6A96460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED5A109A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED5A10D30>]}


============================== 15:54:25.253248 | 095e4aaf-6435-4bbc-a69f-ad0e881d2339 ==============================
[0m15:54:25.253248 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:54:25.253248 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_preco_produto', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:54:25.748411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED8BE0B80>]}
[0m15:54:25.833018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED5A0E760>]}
[0m15:54:25.837403 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:54:25.847983 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:54:25.941719 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:54:25.941719 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m15:54:26.057934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA50D190>]}
[0m15:54:26.069732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA22A580>]}
[0m15:54:26.069732 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:54:26.070733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA22A550>]}
[0m15:54:26.070733 [info ] [MainThread]: 
[0m15:54:26.072607 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:26.074617 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:54:26.074617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:27.035226 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:54:27.037237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:27.041946 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:54:27.044197 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:27.654896 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:54:27.655835 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:54:28.342087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA1C8850>]}
[0m15:54:28.345492 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:54:28.349279 [info ] [MainThread]: 
[0m15:54:28.369577 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:54:28.370623 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:54:28.373166 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:54:28.374159 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:54:28.389898 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:54:28.394260 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:54:28.375671 => 15:54:28.393244
[0m15:54:28.394260 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:54:28.407437 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:54:29.070480 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:54:29.072089 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                                 as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m15:54:29.750276 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:406d4312-6802-44d7-ab2c-44c8199fab89&page=queryresults
[0m15:54:32.705256 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:54:28.395712 => 15:54:32.704253
[0m15:54:32.708508 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '095e4aaf-6435-4bbc-a69f-ad0e881d2339', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA536D00>]}
[0m15:54:32.712982 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 4.34s]
[0m15:54:32.715947 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:54:32.723089 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:32.725144 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:54:32.725928 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:54:32.727481 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:54:32.729063 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:54:32.731086 [info ] [MainThread]: 
[0m15:54:32.733697 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.66 seconds (6.66s).
[0m15:54:32.740334 [debug] [MainThread]: Command end result
[0m15:54:32.785678 [info ] [MainThread]: 
[0m15:54:32.790428 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:54:32.795051 [info ] [MainThread]: 
[0m15:54:32.797992 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:54:32.807508 [debug] [MainThread]: Command `dbt run` succeeded at 15:54:32.807508 after 7.62 seconds
[0m15:54:32.810538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED6A96460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025ED5A0E760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025EDA528C70>]}
[0m15:54:32.814172 [debug] [MainThread]: Flushing usage events
[0m16:00:04.489120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D247C3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D237486D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D23748E20>]}


============================== 16:00:04.493822 | 8e481021-303d-4dba-8e5c-e4145764706a ==============================
[0m16:00:04.493822 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:04.494824 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:05.428485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D2690AB80>]}
[0m16:00:05.513158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D27D03FD0>]}
[0m16:00:05.515229 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:05.523011 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:05.622034 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:05.622636 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:05.625759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D280DD9D0>]}
[0m16:00:05.639963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D28020640>]}
[0m16:00:05.640968 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:05.640968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D28020730>]}
[0m16:00:05.643125 [info ] [MainThread]: 
[0m16:00:05.644145 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:05.646141 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:05.647143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:05.671124 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:05.672692 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.447558 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:07.161231 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:07.167021 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.171111 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:07.175448 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.907608 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:07.914696 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:08.751126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D27D9F190>]}
[0m16:00:08.752668 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:08.755781 [info ] [MainThread]: 
[0m16:00:08.772041 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.774729 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.773741 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m16:00:08.777274 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m16:00:08.781946 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:08.784815 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:08.786971 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.788994 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.813570 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.820224 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.832772 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:08.790003 => 16:00:08.825821
[0m16:00:08.835810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:08.814594 => 16:00:08.833823
[0m16:00:08.838417 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.841960 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.914082 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.919076 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.920078 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:08.920078 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:08.924263 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:08.964619 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m16:00:09.722510 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d29203a7-5db5-4cc8-be4e-536af34a34e4&page=queryresults
[0m16:00:09.794801 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:34ed76b7-2a68-4c37-9dec-c988d06c3d28&page=queryresults
[0m16:00:10.164556 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:08.845074 => 16:00:10.164556
[0m16:00:10.165552 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D27E64250>]}
[0m16:00:10.165552 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m16:00:10.167060 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:10.168073 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.169071 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m16:00:10.170072 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:10.170072 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.175588 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:10.175588 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:10.171069 => 16:00:10.175588
[0m16:00:10.177095 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.187119 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:10.189124 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:10.191129 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:10.228227 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:08.873072 => 16:00:10.228227
[0m16:00:10.229226 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D2816E0A0>]}
[0m16:00:10.229226 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m16:00:10.230226 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:10.230226 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.231732 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m16:00:10.233740 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m16:00:10.235746 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.238262 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.239260 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 16:00:10.235746 => 16:00:10.239260
[0m16:00:10.240263 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.242778 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.243778 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:10.245779 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m16:00:10.935349 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7fe9cbd3-2248-484a-ac86-82d306bbddb1&page=queryresults
[0m16:00:11.017943 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09f3847c-c1d6-41ef-98d0-d0a6df9c6f79&page=queryresults
[0m16:00:11.443004 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 16:00:10.240263 => 16:00:11.441975
[0m16:00:11.454094 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D2816E0A0>]}
[0m16:00:11.456134 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:10.177095 => 16:00:11.456134
[0m16:00:11.460141 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D29258730>]}
[0m16:00:11.458101 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m16:00:11.464887 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:11.462151 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m16:00:11.466941 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.472577 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:11.475588 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m16:00:11.479266 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:11.482844 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m16:00:11.486993 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.495595 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:11.485446 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m16:00:11.498144 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m16:00:11.499143 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:11.514798 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:11.517303 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 16:00:11.486993 => 16:00:11.515769
[0m16:00:11.520356 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.525649 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:11.527169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 16:00:11.499143 => 16:00:11.525649
[0m16:00:11.528194 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:11.534313 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:11.536342 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:11.540437 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m16:00:11.569413 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:11.572022 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m16:00:12.282600 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e4860ffe-a843-4d5f-91fc-f859f7e7aabf&page=queryresults
[0m16:00:12.354349 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a60955c-eda5-498d-8faa-3a09b4803822&page=queryresults
[0m16:00:12.685267 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 16:00:11.521887 => 16:00:12.685267
[0m16:00:12.689039 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D280E8FA0>]}
[0m16:00:12.691048 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m16:00:12.695657 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m16:00:12.698290 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:12.700256 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m16:00:12.703921 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m16:00:12.705873 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:12.713853 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:12.715792 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:12.705873 => 16:00:12.714849
[0m16:00:12.715792 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:12.720519 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:12.720519 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:12.723170 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:12.767318 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 16:00:11.528194 => 16:00:12.766203
[0m16:00:12.767318 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D291603D0>]}
[0m16:00:12.768319 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m16:00:12.770476 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.532187 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:24406528-27c3-4d73-8579-4072d940e2f7&page=queryresults
[0m16:00:13.932980 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:12.715792 => 16:00:13.932980
[0m16:00:13.935526 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D29150E80>]}
[0m16:00:13.938165 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m16:00:13.942569 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:13.947851 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:13.948846 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m16:00:13.952464 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m16:00:13.953467 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:13.962075 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:13.964185 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:13.955470 => 16:00:13.964185
[0m16:00:13.965191 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:14.003648 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:14.934882 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:14.941989 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:15.680319 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7e22ad99-8dba-4b3e-8d41-5b42db5726f2&page=queryresults
[0m16:00:18.543840 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:13.965191 => 16:00:18.543840
[0m16:00:18.544843 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D281485B0>]}
[0m16:00:18.545636 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.59s]
[0m16:00:18.549370 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:18.551978 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:18.553066 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m16:00:18.554076 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m16:00:18.555064 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:18.559053 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:18.561005 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:18.555064 => 16:00:18.560046
[0m16:00:18.562026 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:18.564409 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:19.158246 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:19.162928 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m16:00:19.824733 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b34ca76-61cc-4536-876d-0fd4e0d9fc9d&page=queryresults
[0m16:00:22.625153 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:18.562026 => 16:00:22.624043
[0m16:00:22.626449 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D29249AC0>]}
[0m16:00:22.628167 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.07s]
[0m16:00:22.630154 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:22.631237 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:22.634117 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:00:22.633119 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m16:00:22.636115 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:22.636115 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:22.642117 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:22.634117 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m16:00:22.643393 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m16:00:22.644499 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:00:22.649341 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:22.650341 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:22.637117 => 16:00:22.650341
[0m16:00:22.651854 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:22.654610 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:22.654610 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:00:22.644499 => 16:00:22.654610
[0m16:00:22.655490 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:00:22.685470 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:23.357939 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:23.360962 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                                 as vl_desconto_fixo_pix
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m16:00:23.369470 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:23.371989 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:24.048657 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44a56657-704c-4e48-ad10-c44d9d03bac0&page=queryresults
[0m16:00:24.065407 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d90f3b84-ef41-485b-ae79-851ebc2edb83&page=queryresults
[0m16:00:26.304768 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:22.651854 => 16:00:26.304768
[0m16:00:26.306948 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D281721C0>]}
[0m16:00:26.307992 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.67s]
[0m16:00:26.310011 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:26.850320 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:00:22.655490 => 16:00:26.850320
[0m16:00:26.852946 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e481021-303d-4dba-8e5c-e4145764706a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D2927B850>]}
[0m16:00:26.855044 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 4.21s]
[0m16:00:26.858042 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:00:26.863511 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:26.864613 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:26.864613 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:26.865563 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:00:26.866555 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:00:26.866555 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m16:00:26.867580 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m16:00:26.867580 [info ] [MainThread]: 
[0m16:00:26.869577 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 21.22 seconds (21.22s).
[0m16:00:26.873263 [debug] [MainThread]: Command end result
[0m16:00:26.883787 [info ] [MainThread]: 
[0m16:00:26.883787 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:26.885600 [info ] [MainThread]: 
[0m16:00:26.885917 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m16:00:26.885917 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:26.885917 after 22.48 seconds
[0m16:00:26.885917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D247C3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D2927B7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D291864C0>]}
[0m16:00:26.887621 [debug] [MainThread]: Flushing usage events
[0m16:08:28.512394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E16A2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E06459D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E0645B80>]}


============================== 16:08:28.515432 | b431bd0d-b56c-4566-96a3-13817d1b6b64 ==============================
[0m16:08:28.515432 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:08:28.516993 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_preco_produto', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:08:29.095353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E380CBB0>]}
[0m16:08:29.170174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E4D2F7C0>]}
[0m16:08:29.172722 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:08:29.180393 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:08:29.267007 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:08:29.267007 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m16:08:29.376856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E508DFA0>]}
[0m16:08:29.388941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E4E5A400>]}
[0m16:08:29.388941 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:08:29.389941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E4E5A4F0>]}
[0m16:08:29.390976 [info ] [MainThread]: 
[0m16:08:29.392311 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:08:29.393409 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:08:29.393409 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:08:30.196987 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:08:30.199098 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:08:30.202544 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:08:30.205771 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:08:30.907042 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:08:30.908052 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:08:31.932045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E4CAE190>]}
[0m16:08:31.934321 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:08:31.936833 [info ] [MainThread]: 
[0m16:08:31.965612 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:08:31.970678 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m16:08:31.981793 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m16:08:31.987866 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:08:32.041616 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:08:32.049184 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:08:31.989864 => 16:08:32.047163
[0m16:08:32.052741 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:08:32.090158 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:08:32.878011 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:08:32.880036 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto, ds_variacao
    );
  
[0m16:08:33.569249 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37b3b5bd-1da9-4c9d-b2f7-fb705168a10f&page=queryresults
[0m16:08:36.419825 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:08:32.053744 => 16:08:36.419825
[0m16:08:36.420925 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b431bd0d-b56c-4566-96a3-13817d1b6b64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E515CFD0>]}
[0m16:08:36.420925 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 4.44s]
[0m16:08:36.422005 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:08:36.424057 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:08:36.425014 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:08:36.425014 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:08:36.425014 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:08:36.426014 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m16:08:36.426014 [info ] [MainThread]: 
[0m16:08:36.427015 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.03 seconds (7.03s).
[0m16:08:36.427015 [debug] [MainThread]: Command end result
[0m16:08:36.438076 [info ] [MainThread]: 
[0m16:08:36.439075 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:08:36.440075 [info ] [MainThread]: 
[0m16:08:36.441073 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:08:36.442635 [debug] [MainThread]: Command `dbt run` succeeded at 16:08:36.442635 after 7.99 seconds
[0m16:08:36.443648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E16A2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E5158FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217E4FFA100>]}
[0m16:08:36.443648 [debug] [MainThread]: Flushing usage events
[0m16:38:12.909395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E2260430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E12092E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E1209760>]}


============================== 16:38:12.912851 | 09065d5f-3e78-4cb3-8210-b425f463c8ce ==============================
[0m16:38:12.912851 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:38:12.913847 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models +tb_preco_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:38:13.412157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E1209940>]}
[0m16:38:13.481539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E58E6280>]}
[0m16:38:13.482140 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:38:13.488983 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:38:13.583345 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:38:13.584244 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m16:38:13.696471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5C62DF0>]}
[0m16:38:13.706459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5ADC160>]}
[0m16:38:13.706459 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:38:13.707467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5ADC250>]}
[0m16:38:13.709476 [info ] [MainThread]: 
[0m16:38:13.710475 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:38:13.712808 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:38:13.713787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:13.713787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:38:13.714805 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:14.517789 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:38:15.156485 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:38:15.157486 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:15.181685 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m16:38:15.182694 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:15.764153 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m16:38:15.767703 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:38:16.452465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5ADC100>]}
[0m16:38:16.455517 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:38:16.457470 [info ] [MainThread]: 
[0m16:38:16.474232 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:38:16.476732 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:38:16.483434 [info ] [Thread-1  ]: 1 of 9 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m16:38:16.487503 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:38:16.484436 [info ] [Thread-2  ]: 2 of 9 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:38:16.488504 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:38:16.491445 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:38:16.527967 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:38:16.529017 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:38:16.533601 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:38:16.535541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:38:16.493098 => 16:38:16.535541
[0m16:38:16.535541 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:38:16.560435 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:38:16.562079 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:38:16.531439 => 16:38:16.562079
[0m16:38:16.562079 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:38:16.565210 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:38:16.565210 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:38:16.566726 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:38:16.567741 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m16:38:16.591414 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:38:17.666797 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bc5209b-307a-4ae0-b373-31fc4072b5b5&page=queryresults
[0m16:38:17.708864 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01360fed-010d-49f4-b847-5f7a8b12a2ee&page=queryresults
[0m16:38:18.132833 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:38:16.536477 => 16:38:18.132833
[0m16:38:18.133839 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5D0BB80>]}
[0m16:38:18.137838 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:38:16.562079 => 16:38:18.137838
[0m16:38:18.138840 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5D0BBE0>]}
[0m16:38:18.134842 [info ] [Thread-1  ]: 1 of 9 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.65s]
[0m16:38:18.139837 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:38:18.139837 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m16:38:18.139837 [info ] [Thread-2  ]: 2 of 9 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.65s]
[0m16:38:18.142358 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:38:18.142358 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m16:38:18.141347 [info ] [Thread-1  ]: 3 of 9 START sql view model dbt_dw_stg.stg_forma_pagamento ..................... [RUN]
[0m16:38:18.143355 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m16:38:18.143355 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m16:38:18.142358 [info ] [Thread-2  ]: 4 of 9 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m16:38:18.149902 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:38:18.149902 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m16:38:18.151407 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m16:38:18.154417 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m16:38:18.155420 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 16:38:18.143355 => 16:38:18.155420
[0m16:38:18.155420 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m16:38:18.159740 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:38:18.159740 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 16:38:18.151407 => 16:38:18.159740
[0m16:38:18.161248 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m16:38:18.164359 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m16:38:18.165259 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:38:18.166872 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m16:38:18.188476 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:38:18.191478 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m16:38:18.906751 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51f2a791-8b1b-4a51-b51b-00f67038953f&page=queryresults
[0m16:38:18.935556 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:827c0241-8493-4a2e-82ad-763d082644f6&page=queryresults
[0m16:38:19.297971 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 16:38:18.156741 => 16:38:19.297971
[0m16:38:19.298893 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6E04250>]}
[0m16:38:19.299875 [info ] [Thread-1  ]: 3 of 9 OK created sql view model dbt_dw_stg.stg_forma_pagamento ................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m16:38:19.301383 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m16:38:19.302399 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m16:38:19.302399 [info ] [Thread-1  ]: 5 of 9 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m16:38:19.303390 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m16:38:19.304391 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m16:38:19.311950 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:38:19.312960 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 16:38:19.304391 => 16:38:19.312960
[0m16:38:19.313967 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m16:38:19.315966 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:38:19.317977 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:38:19.319971 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m16:38:19.344591 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 16:38:18.161248 => 16:38:19.344591
[0m16:38:19.344591 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6E04580>]}
[0m16:38:19.345594 [info ] [Thread-2  ]: 4 of 9 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m16:38:19.346591 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m16:38:19.347598 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:38:19.347598 [info ] [Thread-2  ]: 6 of 9 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m16:38:19.348590 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m16:38:19.348590 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:38:19.355606 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:38:19.357621 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:38:19.348590 => 16:38:19.356613
[0m16:38:19.357621 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:38:19.360621 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:38:19.361622 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:38:19.363771 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:38:20.020650 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f3c632e3-0426-45c9-8b7b-dafc616d3caf&page=queryresults
[0m16:38:20.029582 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38bbcf8b-0793-4959-a8cd-aa7c627c6ae2&page=queryresults
[0m16:38:20.427040 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:38:19.357621 => 16:38:20.425507
[0m16:38:20.431590 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6DD9850>]}
[0m16:38:20.435629 [info ] [Thread-2  ]: 6 of 9 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.08s]
[0m16:38:20.443583 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 16:38:19.313967 => 16:38:20.443583
[0m16:38:20.445582 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:38:20.449584 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6DA55B0>]}
[0m16:38:20.451578 [info ] [Thread-1  ]: 5 of 9 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m16:38:20.454830 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m16:38:20.459379 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m16:38:20.462433 [info ] [Thread-2  ]: 7 of 9 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:38:20.464442 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m16:38:20.465446 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:38:20.472496 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:38:20.474495 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:38:20.466964 => 16:38:20.473501
[0m16:38:20.474495 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:38:20.483527 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:38:21.105831 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:38:21.106852 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:38:21.742955 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:34521762-5f69-4216-9dde-fa007a0fe5a1&page=queryresults
[0m16:38:25.504439 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:38:20.474495 => 16:38:25.503455
[0m16:38:25.505437 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6EB7E50>]}
[0m16:38:25.505437 [info ] [Thread-2  ]: 7 of 9 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 5.04s]
[0m16:38:25.506949 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:38:25.508003 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m16:38:25.508962 [info ] [Thread-1  ]: 8 of 9 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m16:38:25.509959 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.tb_produto)
[0m16:38:25.509959 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:38:25.513480 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:38:25.514479 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:38:25.511470 => 16:38:25.514479
[0m16:38:25.515483 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:38:25.517480 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:38:26.119842 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:38:26.122205 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m16:38:26.751568 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:380a1134-8e2e-4f55-ac68-2ae16ee59c00&page=queryresults
[0m16:38:28.983305 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:38:25.515483 => 16:38:28.982300
[0m16:38:28.984301 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6E84220>]}
[0m16:38:28.985300 [info ] [Thread-1  ]: 8 of 9 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.47s]
[0m16:38:28.987223 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:38:28.987223 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:38:28.989745 [info ] [Thread-2  ]: 9 of 9 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m16:38:28.992278 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_preco_produto)
[0m16:38:28.993291 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:38:28.996811 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:38:28.997857 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:38:28.993291 => 16:38:28.997857
[0m16:38:28.998820 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:38:28.999820 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:38:29.608516 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:38:29.610457 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m16:38:30.249804 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:81388049-eaa9-42af-93c6-65ac08390fd6&page=queryresults
[0m16:38:33.344473 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:38:28.998820 => 16:38:33.343481
[0m16:38:33.346485 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '09065d5f-3e78-4cb3-8210-b425f463c8ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5CE4D00>]}
[0m16:38:33.347478 [info ] [Thread-2  ]: 9 of 9 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 4.35s]
[0m16:38:33.349488 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:38:33.353804 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:38:33.354807 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:38:33.355706 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:38:33.356708 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:38:33.357716 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:38:33.359727 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m16:38:33.361721 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m16:38:33.361721 [info ] [MainThread]: 
[0m16:38:33.363279 [info ] [MainThread]: Finished running 6 view models, 3 table models in 0 hours 0 minutes and 19.65 seconds (19.65s).
[0m16:38:33.365213 [debug] [MainThread]: Command end result
[0m16:38:33.374253 [info ] [MainThread]: 
[0m16:38:33.375253 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:38:33.377776 [info ] [MainThread]: 
[0m16:38:33.378772 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
[0m16:38:33.379772 [debug] [MainThread]: Command `dbt run` succeeded at 16:38:33.379772 after 20.54 seconds
[0m16:38:33.379772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E2260430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E6E9DA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247E5BB9E20>]}
[0m16:38:33.381279 [debug] [MainThread]: Flushing usage events
[0m17:00:04.230239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F66B93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F56389A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F5638D30>]}


============================== 17:00:04.234324 | 1acf74a2-5251-4538-af8a-9493c5a0eaa5 ==============================
[0m17:00:04.234324 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:04.234324 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m17:00:05.047577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F5639040>]}
[0m17:00:05.121196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9D2D850>]}
[0m17:00:05.123269 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:05.130055 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:05.268083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:00:05.268083 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:00:05.274674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9FDD880>]}
[0m17:00:05.284823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9F25550>]}
[0m17:00:05.284823 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:05.287248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9F255B0>]}
[0m17:00:05.289312 [info ] [MainThread]: 
[0m17:00:05.289312 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:05.291867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.291867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:05.292391 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.292391 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.228278 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:07.197664 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:00:07.201094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.205130 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:07.208096 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:08.097638 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:00:08.102175 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.763125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9D93D90>]}
[0m17:00:08.765500 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.767156 [info ] [MainThread]: 
[0m17:00:08.777291 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.778286 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.779284 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m17:00:08.781800 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:00:08.782811 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.802766 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.780281 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m17:00:08.806289 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.807292 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.810305 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.811305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.808304 => 17:00:08.811305
[0m17:00:08.812382 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.821896 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:00:08.783809 => 17:00:08.821896
[0m17:00:08.822908 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.843612 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.850360 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.851878 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.852395 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.854404 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:00:08.878603 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:09.686366 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4ce0b997-7bef-4725-9572-1b7fb27f5ff8&page=queryresults
[0m17:00:09.750269 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a70764c-ceca-414c-80af-4efa84ce8de3&page=queryresults
[0m17:00:10.141111 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.812382 => 17:00:10.141111
[0m17:00:10.143131 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FA06AD90>]}
[0m17:00:10.144120 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m17:00:10.145119 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.145119 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.145899 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m17:00:10.146132 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:00:10.146132 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.149142 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.150145 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:00:10.146132 => 17:00:10.149142
[0m17:00:10.150145 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.153668 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.153668 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.155671 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:00:10.929786 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:61ea08b1-1a63-4f10-b653-78a70a54bb01&page=queryresults
[0m17:00:11.340430 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:00:10.151149 => 17:00:11.339419
[0m17:00:11.341942 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB1637F0>]}
[0m17:00:11.343981 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m17:00:11.344976 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:00:11.346484 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.347498 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m17:00:11.349499 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m17:00:11.351007 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.363108 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:11.364618 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:00:11.351007 => 17:00:11.364618
[0m17:00:11.365637 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.369641 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:11.371157 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:11.372165 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:00:12.174519 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c6ea7bd-a2fa-4103-ac79-d81157c1cd31&page=queryresults
[0m17:00:12.623819 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:00:11.366749 => 17:00:12.623819
[0m17:00:12.625408 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB055070>]}
[0m17:00:12.626537 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m17:00:12.628558 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:12.629559 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:00:12.632088 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m17:00:12.633088 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m17:00:12.634087 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:00:12.637621 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:12.639642 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:00:12.634087 => 17:00:12.639642
[0m17:00:12.641160 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:00:12.654540 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:12.655540 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:12.657537 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:00:13.498190 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d996e1df-b94d-46ba-92dc-d6804023378d&page=queryresults
[0m17:00:13.888562 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:00:12.642174 => 17:00:13.887510
[0m17:00:13.888562 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB055910>]}
[0m17:00:13.889540 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m17:00:13.889540 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:00:13.889540 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.889540 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m17:00:13.891173 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:00:13.891173 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.896269 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:13.897237 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:00:13.892291 => 17:00:13.896269
[0m17:00:13.897237 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.899228 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:13.900287 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:13.901904 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:00:14.731359 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4471a3c0-0262-43ae-9094-4b5957e14126&page=queryresults
[0m17:00:15.158299 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:00:13.897237 => 17:00:15.158299
[0m17:00:15.160298 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9D93D90>]}
[0m17:00:15.162250 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m17:00:15.163479 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:15.164537 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:15.165484 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m17:00:15.166980 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m17:00:15.168029 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:15.179565 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:15.181198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:15.168029 => 17:00:15.181198
[0m17:00:15.182221 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:15.187386 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:15.188483 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:15.190391 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:15.906045 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22d5f700-e5a0-480c-9feb-7588d41a9fdb&page=queryresults
[0m17:00:16.286746 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:15.183308 => 17:00:16.284891
[0m17:00:16.288972 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB0617F0>]}
[0m17:00:16.289969 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m17:00:16.293694 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:16.295597 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:16.296595 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m17:00:16.298709 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:00:16.299596 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:16.306483 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:16.308497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:16.299596 => 17:00:16.307525
[0m17:00:16.308497 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:16.319720 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:16.982270 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:16.984221 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:17.606657 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ddfd83b6-796e-445d-b2a1-6cd26748eed4&page=queryresults
[0m17:00:20.352183 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:00:08.822908 => 17:00:20.352183
[0m17:00:20.353202 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB0A5F70>]}
[0m17:00:20.354206 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 11.57s]
[0m17:00:20.355190 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:21.029507 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:16.308497 => 17:00:21.029507
[0m17:00:21.031029 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB17F460>]}
[0m17:00:21.032098 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.73s]
[0m17:00:21.033171 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:21.034080 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:21.035109 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m17:00:21.035109 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.tb_produto)
[0m17:00:21.036621 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:21.039704 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:21.042378 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:21.036621 => 17:00:21.041308
[0m17:00:21.042378 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:21.044355 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:21.668140 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:21.670145 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m17:00:22.369922 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84421f2f-b076-4e26-87a0-81c5e9b01b15&page=queryresults
[0m17:00:24.651657 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:21.042378 => 17:00:24.651657
[0m17:00:24.652693 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB1551C0>]}
[0m17:00:24.652693 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.62s]
[0m17:00:24.653681 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:24.654662 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.654662 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:00:24.654662 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m17:00:24.656171 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m17:00:24.657179 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:00:24.658180 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m17:00:24.658180 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.659182 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:00:24.661715 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:24.664721 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:00:24.667252 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:00:24.659182 => 17:00:24.667252
[0m17:00:24.667252 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.670263 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:24.672709 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:00:24.662756 => 17:00:24.671266
[0m17:00:24.672709 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:00:24.674711 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:25.280027 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:25.282558 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:00:25.353422 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:00:25.356382 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:26.019798 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:24e1c823-ba7f-41f8-ad5e-b5c4233a52ea&page=queryresults
[0m17:00:26.022368 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d1804f6-2456-43fe-ad14-5318c52890fe&page=queryresults
[0m17:00:28.296855 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:00:24.668265 => 17:00:28.296855
[0m17:00:28.299112 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB201400>]}
[0m17:00:28.301156 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.64s]
[0m17:00:28.303384 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:00:29.807541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:00:24.672709 => 17:00:29.807541
[0m17:00:29.808541 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1acf74a2-5251-4538-af8a-9493c5a0eaa5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5FB189670>]}
[0m17:00:29.808541 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 5.15s]
[0m17:00:29.809540 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:00:29.812049 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:29.812049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:29.812049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:29.812049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:00:29.812049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:29.813056 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m17:00:29.813056 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m17:00:29.813056 [info ] [MainThread]: 
[0m17:00:29.814062 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 24.52 seconds (24.52s).
[0m17:00:29.815151 [debug] [MainThread]: Command end result
[0m17:00:29.823183 [info ] [MainThread]: 
[0m17:00:29.824190 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:29.825193 [info ] [MainThread]: 
[0m17:00:29.825193 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m17:00:29.826699 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:29.826699 after 25.66 seconds
[0m17:00:29.826699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F66B93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9D2D850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5F9D935E0>]}
[0m17:00:29.827750 [debug] [MainThread]: Flushing usage events
[0m17:10:08.809577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782C1063D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782B082910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782B082B80>]}


============================== 17:10:08.814640 | 18e898eb-049c-4f4b-8586-ddb4825e29ce ==============================
[0m17:10:08.814640 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:10:08.814640 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models +tb_preco_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:10:09.544224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782B07F940>]}
[0m17:10:09.612256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F753280>]}
[0m17:10:09.614255 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:10:09.622372 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:10:09.705514 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:10:09.705514 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m17:10:09.809357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782FACDEE0>]}
[0m17:10:09.819238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F9623D0>]}
[0m17:10:09.820234 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:10:09.821277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F962430>]}
[0m17:10:09.821277 [info ] [MainThread]: 
[0m17:10:09.822697 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:10:09.824689 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:10:09.824689 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:10:09.825374 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:10:09.826458 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:10:10.811101 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:10:11.534945 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:10:11.541884 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:10:11.544961 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:10:11.549570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:10:12.296507 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:10:12.296507 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:10:12.934117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782FA0A760>]}
[0m17:10:12.937691 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:10:12.939691 [info ] [MainThread]: 
[0m17:10:12.947124 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:10:12.949055 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:10:12.948056 [info ] [Thread-1  ]: 1 of 9 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m17:10:12.951116 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:10:12.951116 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:10:12.950055 [info ] [Thread-2  ]: 2 of 9 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:10:12.956460 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:10:12.957461 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:10:12.960461 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:10:12.963032 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:10:12.964011 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:10:12.951116 => 17:10:12.964011
[0m17:10:12.964011 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:10:12.971603 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:10:12.957461 => 17:10:12.971603
[0m17:10:12.972613 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:10:12.999383 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:10:13.001354 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:10:13.003451 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:10:13.003451 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:10:13.006433 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:10:13.030446 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:10:13.755494 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a9d9cbd4-808f-4ef6-aa12-0fc92631f454&page=queryresults
[0m17:10:13.780188 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ade64a63-c139-4835-b458-f4a5e9a573ef&page=queryresults
[0m17:10:14.188019 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:10:12.972613 => 17:10:14.186996
[0m17:10:14.188019 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F71E0D0>]}
[0m17:10:14.191672 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:10:12.964998 => 17:10:14.191672
[0m17:10:14.189018 [info ] [Thread-2  ]: 2 of 9 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m17:10:14.191672 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830BE6FA0>]}
[0m17:10:14.192673 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:10:14.193712 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:10:14.192673 [info ] [Thread-1  ]: 1 of 9 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:10:14.194673 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:10:14.193712 [info ] [Thread-2  ]: 3 of 9 START sql view model dbt_dw_stg.stg_forma_pagamento ..................... [RUN]
[0m17:10:14.194673 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:10:14.196208 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m17:10:14.197217 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:10:14.196208 [info ] [Thread-1  ]: 4 of 9 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m17:10:14.200223 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:10:14.201723 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m17:10:14.201723 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:10:14.204755 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:10:14.204755 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:10:14.197217 => 17:10:14.204755
[0m17:10:14.206269 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:10:14.208278 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:10:14.209279 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:10:14.202734 => 17:10:14.209279
[0m17:10:14.210279 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:10:14.212793 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:10:14.213791 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:10:14.214835 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:10:14.238316 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:10:14.239324 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:10:14.969165 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a1cf181-6342-49b1-80fc-95d146269431&page=queryresults
[0m17:10:15.021120 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6ec6e9f6-ec3e-49a9-b9ac-729e7a37dfdc&page=queryresults
[0m17:10:15.367853 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:10:14.210279 => 17:10:15.367853
[0m17:10:15.368776 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830BE6DC0>]}
[0m17:10:15.368776 [info ] [Thread-1  ]: 4 of 9 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m17:10:15.369752 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:10:15.369752 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:10:15.371271 [info ] [Thread-1  ]: 5 of 9 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m17:10:15.372281 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:10:15.372281 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:10:15.375299 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:10:15.376285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:10:15.372281 => 17:10:15.376285
[0m17:10:15.376285 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:10:15.379289 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:10:15.380278 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:10:15.381828 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:10:15.418425 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:10:14.206269 => 17:10:15.418425
[0m17:10:15.419381 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830D08820>]}
[0m17:10:15.419381 [info ] [Thread-2  ]: 3 of 9 OK created sql view model dbt_dw_stg.stg_forma_pagamento ................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m17:10:15.425042 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:10:15.425042 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:10:15.425042 [info ] [Thread-2  ]: 6 of 9 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:10:15.426173 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_produto)
[0m17:10:15.426173 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:10:15.429707 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:10:15.431269 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:10:15.427305 => 17:10:15.431269
[0m17:10:15.431269 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:10:15.434408 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:10:15.435394 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:10:15.437352 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:10:16.092400 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a327a3e-3ee3-4420-ae2d-da7b7cc32aea&page=queryresults
[0m17:10:16.169339 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cc2685e0-3250-4385-8b65-ee5080cf7e93&page=queryresults
[0m17:10:16.496069 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:10:15.377281 => 17:10:16.495066
[0m17:10:16.497077 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830CCDC40>]}
[0m17:10:16.498038 [info ] [Thread-1  ]: 5 of 9 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m17:10:16.500020 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:10:16.650999 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:10:15.432317 => 17:10:16.650999
[0m17:10:16.652018 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F71E700>]}
[0m17:10:16.652018 [info ] [Thread-2  ]: 6 of 9 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m17:10:16.653066 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:10:16.654087 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m17:10:16.655072 [info ] [Thread-1  ]: 7 of 9 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:10:16.656061 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m17:10:16.656061 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:10:16.660027 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:10:16.661139 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:10:16.656061 => 17:10:16.661139
[0m17:10:16.661139 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:10:16.673342 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:10:17.392234 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:10:17.396217 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:10:17.962398 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:444a8800-5d27-4884-9011-ca7ba9d9b8f0&page=queryresults
[0m17:10:20.470315 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:10:16.661139 => 17:10:20.470315
[0m17:10:20.472880 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830D43550>]}
[0m17:10:20.474865 [info ] [Thread-1  ]: 7 of 9 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.82s]
[0m17:10:20.477511 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:10:20.479406 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m17:10:20.481947 [info ] [Thread-2  ]: 8 of 9 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:10:20.486535 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m17:10:20.487649 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:10:20.504767 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:10:20.512035 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:10:20.489558 => 17:10:20.509495
[0m17:10:20.515114 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:10:20.526811 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:10:21.203015 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:10:21.209589 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m17:10:21.886907 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c747da4d-59e5-4039-a654-647fe162f44d&page=queryresults
[0m17:10:24.484023 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:10:20.516048 => 17:10:24.483021
[0m17:10:24.485923 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830D174F0>]}
[0m17:10:24.487147 [info ] [Thread-2  ]: 8 of 9 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.00s]
[0m17:10:24.492613 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:10:24.497821 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:10:24.501336 [info ] [Thread-1  ]: 9 of 9 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m17:10:24.506566 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_preco_produto)
[0m17:10:24.508683 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:10:24.517351 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:10:24.521448 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:10:24.508683 => 17:10:24.518413
[0m17:10:24.522086 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:10:24.525179 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:10:25.237659 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:10:25.239660 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:10:25.959301 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed81af0f-9f95-4bc2-b164-bbf107782370&page=queryresults
[0m17:10:28.769205 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:10:24.522086 => 17:10:28.768199
[0m17:10:28.770215 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18e898eb-049c-4f4b-8586-ddb4825e29ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027830D18130>]}
[0m17:10:28.771205 [info ] [Thread-1  ]: 9 of 9 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 64.2 KiB processed)[0m in 4.26s]
[0m17:10:28.772861 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:10:28.774879 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:10:28.774879 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:10:28.776479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:10:28.776479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:10:28.776479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:10:28.776479 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m17:10:28.777590 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:10:28.777590 [info ] [MainThread]: 
[0m17:10:28.778587 [info ] [MainThread]: Finished running 6 view models, 3 table models in 0 hours 0 minutes and 18.95 seconds (18.95s).
[0m17:10:28.781194 [debug] [MainThread]: Command end result
[0m17:10:28.795592 [info ] [MainThread]: 
[0m17:10:28.796837 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:10:28.797847 [info ] [MainThread]: 
[0m17:10:28.797847 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
[0m17:10:28.799850 [debug] [MainThread]: Command `dbt run` succeeded at 17:10:28.799850 after 20.05 seconds
[0m17:10:28.799850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782C1063D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782F7F20D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002782FA3A070>]}
[0m17:10:28.801369 [debug] [MainThread]: Flushing usage events
[0m17:49:54.704059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB0722430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EAF6BC2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EAF6BC760>]}


============================== 17:49:54.708572 | 37af63a5-6f10-47ec-bfe8-245c9067f2f1 ==============================
[0m17:49:54.708572 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:49:54.709600 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models +tb_preco_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:49:55.300876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EAF6B6910>]}
[0m17:49:55.382734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB3DB3AC0>]}
[0m17:49:55.383734 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:49:55.394714 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:49:55.606848 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:49:55.607844 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto.sql
[0m17:49:55.775796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB41BF340>]}
[0m17:49:55.802061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB3ED16D0>]}
[0m17:49:55.803130 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:49:55.804145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB3ED1730>]}
[0m17:49:55.808736 [info ] [MainThread]: 
[0m17:49:55.811236 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:49:55.817028 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:49:55.817977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:55.821596 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:49:55.825533 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:56.807177 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:49:57.571275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:49:57.574313 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:57.579852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:49:57.583385 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:58.375607 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:49:58.375607 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:49:59.080474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB3E35970>]}
[0m17:49:59.082743 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:49:59.084738 [info ] [MainThread]: 
[0m17:49:59.094370 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:49:59.095887 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:49:59.097952 [info ] [Thread-1  ]: 1 of 9 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m17:49:59.101541 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:49:59.103521 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:49:59.098907 [info ] [Thread-2  ]: 2 of 9 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:49:59.145647 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:49:59.147643 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:49:59.150605 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:49:59.157323 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:49:59.159326 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:49:59.106073 => 17:49:59.158323
[0m17:49:59.162829 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:49:59.152905 => 17:49:59.161818
[0m17:49:59.162829 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:49:59.163813 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:49:59.202230 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:49:59.198003 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:49:59.205764 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:49:59.206863 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:49:59.207924 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:49:59.237949 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:50:00.025620 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7f99ea54-4e5b-4277-bc5a-4cadd5cda9db&page=queryresults
[0m17:50:00.230684 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:801dc497-0f99-4146-9233-9c51309d2023&page=queryresults
[0m17:50:00.444304 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:49:59.198983 => 17:50:00.443307
[0m17:50:00.444304 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB41C6DF0>]}
[0m17:50:00.445814 [info ] [Thread-2  ]: 2 of 9 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m17:50:00.446824 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:50:00.446824 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:50:00.447821 [info ] [Thread-2  ]: 3 of 9 START sql view model dbt_dw_stg.stg_forma_pagamento ..................... [RUN]
[0m17:50:00.448823 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m17:50:00.450332 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:50:00.455855 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:50:00.456866 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:50:00.450332 => 17:50:00.456866
[0m17:50:00.456866 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:50:00.461397 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:50:00.462386 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:50:00.463900 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:50:00.628872 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:49:59.164765 => 17:50:00.628872
[0m17:50:00.630380 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB41C6DC0>]}
[0m17:50:00.630380 [info ] [Thread-1  ]: 1 of 9 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m17:50:00.631390 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:50:00.631390 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:50:00.632386 [info ] [Thread-1  ]: 4 of 9 START sql view model dbt_dw_stg.stg_imagem_produto ...................... [RUN]
[0m17:50:00.633386 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_imagem_produto)
[0m17:50:00.633386 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:50:00.635921 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:50:00.636931 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:50:00.633386 => 17:50:00.636931
[0m17:50:00.637933 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:50:00.640441 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:50:00.641449 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:50:00.643448 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:50:01.144523 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:522930b3-71e6-4717-bdad-f0faf5f2da7b&page=queryresults
[0m17:50:01.340849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e755fa7-53ee-493e-a852-7a9bcc62875f&page=queryresults
[0m17:50:01.544238 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:50:00.457865 => 17:50:01.544238
[0m17:50:01.545748 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB5266C10>]}
[0m17:50:01.545748 [info ] [Thread-2  ]: 3 of 9 OK created sql view model dbt_dw_stg.stg_forma_pagamento ................ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m17:50:01.546761 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:50:01.547761 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:50:01.547761 [info ] [Thread-2  ]: 5 of 9 START sql view model dbt_dw_stg.stg_meta_margem_preco ................... [RUN]
[0m17:50:01.549777 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:50:01.549777 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:50:01.553287 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:50:01.554289 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:50:01.550759 => 17:50:01.554289
[0m17:50:01.554289 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:50:01.557813 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:50:01.557813 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:50:01.559816 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:50:01.773619 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:50:00.637933 => 17:50:01.772637
[0m17:50:01.774625 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB41C6DC0>]}
[0m17:50:01.776608 [info ] [Thread-1  ]: 4 of 9 OK created sql view model dbt_dw_stg.stg_imagem_produto ................. [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m17:50:01.777601 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:50:01.777601 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m17:50:01.778600 [info ] [Thread-1  ]: 6 of 9 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:50:01.779601 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m17:50:01.781128 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:50:01.788702 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:50:01.789705 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:50:01.781128 => 17:50:01.789705
[0m17:50:01.790704 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:50:01.794239 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:50:01.795748 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:50:01.796758 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:50:02.285962 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3aa11e55-62b1-415e-9dd1-cbfeebe32d65&page=queryresults
[0m17:50:02.433549 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09100f11-cd0f-4b46-98df-544275cb2a7f&page=queryresults
[0m17:50:02.667747 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:50:01.554289 => 17:50:02.667747
[0m17:50:02.670751 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB41E2D90>]}
[0m17:50:02.671260 [info ] [Thread-2  ]: 5 of 9 OK created sql view model dbt_dw_stg.stg_meta_margem_preco .............. [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m17:50:02.673281 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:50:02.823860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:50:01.791227 => 17:50:02.822876
[0m17:50:02.824869 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB530FF40>]}
[0m17:50:02.825884 [info ] [Thread-1  ]: 6 of 9 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.05s]
[0m17:50:02.826863 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:50:02.829874 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:50:02.832432 [info ] [Thread-2  ]: 7 of 9 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:50:02.838223 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m17:50:02.840756 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:50:02.864712 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:50:02.872873 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:50:02.841781 => 17:50:02.870827
[0m17:50:02.875925 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:50:02.891176 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:50:03.648855 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:50:03.656982 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:50:04.328100 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08bd3668-2af7-4a80-bd59-d69453e1dd1b&page=queryresults
[0m17:50:06.596998 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:50:02.878037 => 17:50:06.594411
[0m17:50:06.602576 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB5229EE0>]}
[0m17:50:06.607681 [info ] [Thread-2  ]: 7 of 9 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.76s]
[0m17:50:06.613159 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:50:06.618328 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:50:06.623041 [info ] [Thread-1  ]: 8 of 9 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:50:06.631209 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m17:50:06.634237 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:50:06.657940 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:50:06.667136 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:50:06.635815 => 17:50:06.664560
[0m17:50:06.674740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:50:06.735680 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:50:07.479010 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:50:07.491169 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m17:50:08.099023 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ddd27146-e2f8-4a7b-85d7-0692ebe8d335&page=queryresults
[0m17:50:10.346072 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:50:06.676294 => 17:50:10.345078
[0m17:50:10.348080 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB53E0340>]}
[0m17:50:10.351498 [info ] [Thread-1  ]: 8 of 9 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.72s]
[0m17:50:10.354524 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:50:10.360601 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:50:10.367218 [info ] [Thread-2  ]: 9 of 9 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m17:50:10.371755 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_preco_produto)
[0m17:50:10.373747 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:50:10.389827 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:50:10.396125 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:50:10.374843 => 17:50:10.394125
[0m17:50:10.397120 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:50:10.404332 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:50:11.110671 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:50:11.114752 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:50:11.693014 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4d9650ef-d863-41fc-973e-befabe27b03d&page=queryresults
[0m17:50:14.170532 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:50:10.398115 => 17:50:14.169003
[0m17:50:14.172566 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af63a5-6f10-47ec-bfe8-245c9067f2f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB5379160>]}
[0m17:50:14.174561 [info ] [Thread-2  ]: 9 of 9 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 3.80s]
[0m17:50:14.177124 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:50:14.180652 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:50:14.182671 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:50:14.182671 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:50:14.183682 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:50:14.184668 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:50:14.185669 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:50:14.186686 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m17:50:14.187682 [info ] [MainThread]: 
[0m17:50:14.188668 [info ] [MainThread]: Finished running 6 view models, 3 table models in 0 hours 0 minutes and 18.38 seconds (18.38s).
[0m17:50:14.195757 [debug] [MainThread]: Command end result
[0m17:50:14.243237 [info ] [MainThread]: 
[0m17:50:14.245758 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:50:14.248799 [info ] [MainThread]: 
[0m17:50:14.251322 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
[0m17:50:14.257095 [debug] [MainThread]: Command `dbt run` succeeded at 17:50:14.255974 after 19.61 seconds
[0m17:50:14.259050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB0722430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB4041E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027EB407A3A0>]}
[0m17:50:14.259050 [debug] [MainThread]: Flushing usage events
[0m18:00:03.816437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C26EE83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C26DDF89A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C26DDF8D30>]}


============================== 18:00:03.820436 | ea4b729a-0ce6-413c-8b29-e9a0a532f3ba ==============================
[0m18:00:03.820436 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:03.821290 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m18:00:04.382462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C26DDFBB80>]}
[0m18:00:04.446497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2724DDC10>]}
[0m18:00:04.448058 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:04.455737 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:04.528963 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:00:04.528963 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:00:04.533498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27279DB80>]}
[0m18:00:04.546921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2726E0850>]}
[0m18:00:04.546921 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:04.547920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2726E08B0>]}
[0m18:00:04.548921 [info ] [MainThread]: 
[0m18:00:04.551467 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:04.553457 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:04.553457 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:04.554517 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:04.554517 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:05.418765 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:06.096226 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:00:06.099935 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.104506 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:06.107133 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.787573 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:00:06.789585 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:07.492388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27252FF10>]}
[0m18:00:07.494380 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:07.497026 [info ] [MainThread]: 
[0m18:00:07.520636 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:07.522224 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m18:00:07.521171 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m18:00:07.525709 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m18:00:07.525709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:07.537366 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:07.523177 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m18:00:07.538140 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m18:00:07.539156 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m18:00:07.542679 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:07.544677 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 18:00:07.526825 => 18:00:07.543678
[0m18:00:07.544677 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:07.554207 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 18:00:07.539156 => 18:00:07.554207
[0m18:00:07.554207 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m18:00:07.577568 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:07.582282 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:07.584177 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:00:07.585793 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m18:00:07.606483 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:07.609488 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m18:00:08.401227 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f69eb3af-467b-477a-a5e7-b32448d2249a&page=queryresults
[0m18:00:08.441582 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5342d52-5d83-4f49-915c-bd5a7fdaa7f7&page=queryresults
[0m18:00:08.870840 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 18:00:07.556830 => 18:00:08.870840
[0m18:00:08.871448 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C272825040>]}
[0m18:00:08.872550 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m18:00:08.873671 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m18:00:08.873671 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m18:00:08.874608 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m18:00:08.874608 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m18:00:08.874608 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m18:00:08.879288 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:08.882936 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 18:00:07.544677 => 18:00:08.881884
[0m18:00:08.882936 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27279DBE0>]}
[0m18:00:08.883942 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m18:00:08.884888 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:08.884888 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:08.884888 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m18:00:08.885843 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m18:00:08.885843 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m18:00:08.888880 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:08.889874 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 18:00:08.876214 => 18:00:08.889874
[0m18:00:08.889874 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 18:00:08.885843 => 18:00:08.889874
[0m18:00:08.890948 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m18:00:08.891554 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m18:00:08.897095 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:08.900628 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:08.901637 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:08.902638 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:08.903657 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m18:00:08.928935 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m18:00:09.876145 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:803ed9d3-12c6-4c21-a08f-337e9b1535de&page=queryresults
[0m18:00:09.882822 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4bb0ec6-20d8-4fd1-bc96-907d72970160&page=queryresults
[0m18:00:10.274580 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 18:00:08.897095 => 18:00:10.273624
[0m18:00:10.277095 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C272781D60>]}
[0m18:00:10.280620 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m18:00:10.283707 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:10.285684 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:00:10.286750 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m18:00:10.288686 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m18:00:10.289696 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:00:10.295464 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:10.297461 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:00:10.289696 => 18:00:10.297461
[0m18:00:10.298459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:00:10.327817 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 18:00:08.891554 => 18:00:10.326819
[0m18:00:10.332843 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2738487C0>]}
[0m18:00:10.347633 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:10.349601 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m18:00:10.353173 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m18:00:10.353173 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:10.353715 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m18:00:10.354753 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m18:00:10.354753 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:10.358721 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:10.359759 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:10.362885 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m18:00:10.363886 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 18:00:10.354753 => 18:00:10.362885
[0m18:00:10.386050 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:10.388169 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:10.389098 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:10.391698 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m18:00:11.064862 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26709db8-030d-4b78-bbe0-0a0180c78f1b&page=queryresults
[0m18:00:11.130578 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3668509a-76c2-443f-b4f8-4ad52cd9e619&page=queryresults
[0m18:00:11.455262 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:00:10.299538 => 18:00:11.455262
[0m18:00:11.457346 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2738E26A0>]}
[0m18:00:11.457908 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m18:00:11.458954 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:00:11.460544 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m18:00:11.461605 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m18:00:11.463604 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m18:00:11.463604 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m18:00:11.468629 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m18:00:11.471209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 18:00:11.464651 => 18:00:11.469614
[0m18:00:11.472261 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m18:00:11.474300 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m18:00:11.474300 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:11.475807 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m18:00:11.499533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 18:00:10.386050 => 18:00:11.499533
[0m18:00:11.500545 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C272825040>]}
[0m18:00:11.501432 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m18:00:11.501932 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:12.157580 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b357a984-8601-4006-94e8-6ebcb5a0e135&page=queryresults
[0m18:00:12.578536 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 18:00:11.472261 => 18:00:12.576959
[0m18:00:12.581150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2739086D0>]}
[0m18:00:12.582156 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m18:00:12.583161 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m18:00:12.586764 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m18:00:12.587782 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m18:00:12.590762 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m18:00:12.591342 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m18:00:12.597024 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m18:00:12.598026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 18:00:12.591342 => 18:00:12.598026
[0m18:00:12.598026 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m18:00:12.610992 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:13.293544 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m18:00:13.295537 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m18:00:13.943001 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:14ee8bd0-55b5-4d45-899f-a046241021f5&page=queryresults
[0m18:00:16.491324 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 18:00:12.599079 => 18:00:16.491324
[0m18:00:16.493436 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C272781D60>]}
[0m18:00:16.494428 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.90s]
[0m18:00:16.498139 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m18:00:16.500571 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m18:00:16.503592 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m18:00:16.509612 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m18:00:16.512046 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:00:16.524156 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:00:16.527709 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:00:16.513069 => 18:00:16.526789
[0m18:00:16.528724 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:00:16.532413 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:17.191766 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:00:17.194827 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m18:00:17.952451 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15178558-ec2f-4ace-86dc-2d439fe84f87&page=queryresults
[0m18:00:20.504488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:00:16.528724 => 18:00:20.504488
[0m18:00:20.507054 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2727E96D0>]}
[0m18:00:20.509045 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.00s]
[0m18:00:20.513660 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:00:20.516591 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m18:00:20.517590 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m18:00:20.519610 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m18:00:20.522806 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m18:00:20.523808 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m18:00:20.533943 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:20.520592 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m18:00:20.536942 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m18:00:20.538938 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m18:00:20.546514 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m18:00:20.547504 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 18:00:20.524806 => 18:00:20.547504
[0m18:00:20.548504 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m18:00:20.552201 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:20.553173 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 18:00:20.538938 => 18:00:20.553173
[0m18:00:20.553173 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m18:00:20.560612 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:21.565722 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:21.569820 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m18:00:21.576984 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:21.581542 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m18:00:22.209910 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98718026-fbe0-46a1-8699-8f858a5a9afb&page=queryresults
[0m18:00:22.217937 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad193256-fbcc-449d-89cc-45f520c3a4f5&page=queryresults
[0m18:00:24.465840 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 18:00:20.549513 => 18:00:24.464814
[0m18:00:24.465840 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27388C160>]}
[0m18:00:24.466846 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.94s]
[0m18:00:24.467825 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m18:00:24.508243 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 18:00:20.553173 => 18:00:24.507248
[0m18:00:24.509256 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea4b729a-0ce6-413c-8b29-e9a0a532f3ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C27387D7C0>]}
[0m18:00:24.510894 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 3.97s]
[0m18:00:24.512965 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m18:00:24.517467 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:24.518488 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:24.518488 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:24.518488 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:00:24.519483 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:00:24.519483 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m18:00:24.520481 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m18:00:24.520989 [info ] [MainThread]: 
[0m18:00:24.522000 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 19.97 seconds (19.97s).
[0m18:00:24.526713 [debug] [MainThread]: Command end result
[0m18:00:24.542343 [info ] [MainThread]: 
[0m18:00:24.544370 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:24.544370 [info ] [MainThread]: 
[0m18:00:24.545900 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m18:00:24.546911 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:24.546911 after 20.79 seconds
[0m18:00:24.547912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C26EE83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2727A8070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C272471D60>]}
[0m18:00:24.547912 [debug] [MainThread]: Flushing usage events
[0m19:00:06.814096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB21B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB11589A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB1158D30>]}


============================== 19:00:06.825089 | 0ce8bdc3-8649-4367-829f-72461e348a55 ==============================
[0m19:00:06.825089 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:00:06.827105 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m19:00:08.137261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB431ABB0>]}
[0m19:00:08.231349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5838A00>]}
[0m19:00:08.234346 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:00:08.245348 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:00:08.456233 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:00:08.456233 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:00:08.461250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5AED820>]}
[0m19:00:08.475257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5A354F0>]}
[0m19:00:08.476253 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:00:08.477253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5A35550>]}
[0m19:00:08.480250 [info ] [MainThread]: 
[0m19:00:08.482252 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:00:08.487287 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:08.489267 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:08.491287 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:08.493287 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:09.349839 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:10.276871 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:00:10.278834 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:10.281802 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:00:10.283791 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:11.039858 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:00:11.045859 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:11.714732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5B3A3D0>]}
[0m19:00:11.715731 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:11.717729 [info ] [MainThread]: 
[0m19:00:11.727730 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:11.729732 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m19:00:11.731731 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m19:00:11.735737 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m19:00:11.733730 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m19:00:11.737705 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:11.739602 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m19:00:11.759683 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:11.760695 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m19:00:11.766695 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:11.769649 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 19:00:11.761685 => 19:00:11.768684
[0m19:00:11.770646 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 19:00:11.740605 => 19:00:11.770646
[0m19:00:11.771647 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m19:00:11.772668 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:11.839485 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:11.845487 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:11.848559 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m19:00:11.849440 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:00:11.857482 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m19:00:11.860485 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m19:00:12.673696 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b12d855f-7b7a-4d84-a7b0-075c259115b1&page=queryresults
[0m19:00:12.724661 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae52e9b8-6537-4865-be56-699be3d1e6c2&page=queryresults
[0m19:00:13.135756 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 19:00:11.772668 => 19:00:13.135756
[0m19:00:13.137758 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5B841C0>]}
[0m19:00:13.141758 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 19:00:11.787693 => 19:00:13.141758
[0m19:00:13.138755 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m19:00:13.143762 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB57A11F0>]}
[0m19:00:13.144757 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m19:00:13.146753 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m19:00:13.145753 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m19:00:13.147753 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m19:00:13.149753 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:13.150752 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m19:00:13.151753 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m19:00:13.152754 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m19:00:13.159754 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:13.153752 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m19:00:13.161753 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m19:00:13.162753 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m19:00:13.167752 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m19:00:13.168751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 19:00:13.153752 => 19:00:13.168751
[0m19:00:13.169752 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m19:00:13.172753 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:13.174755 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 19:00:13.162753 => 19:00:13.174755
[0m19:00:13.175758 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:13.176754 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m19:00:13.182755 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m19:00:13.184764 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m19:00:13.215559 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:13.218803 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m19:00:14.003701 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6b70ea96-7c5e-4d9a-98e1-fe2a14f152cd&page=queryresults
[0m19:00:14.030396 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c6d5fc8-b1b3-4551-875b-f3baefc46a74&page=queryresults
[0m19:00:14.410970 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 19:00:13.177751 => 19:00:14.409424
[0m19:00:14.412989 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB57A1B80>]}
[0m19:00:14.415038 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m19:00:14.416043 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m19:00:14.417050 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m19:00:14.417989 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m19:00:14.428036 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 19:00:13.169752 => 19:00:14.426985
[0m19:00:14.429988 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m19:00:14.432040 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6BAE340>]}
[0m19:00:14.433970 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m19:00:14.445037 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:14.435986 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m19:00:14.447038 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m19:00:14.448033 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:14.449741 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m19:00:14.451801 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m19:00:14.452755 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:14.458757 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 19:00:14.436986 => 19:00:14.457805
[0m19:00:14.462804 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m19:00:14.473813 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:14.486820 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:14.502981 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:00:14.505937 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m19:00:14.535658 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 19:00:14.453756 => 19:00:14.535658
[0m19:00:14.536670 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:14.540609 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:00:14.542633 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:14.545611 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m19:00:15.257645 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d2eff2e-7574-4c8b-8733-6bf4a7b9ef00&page=queryresults
[0m19:00:15.307367 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f900fcd3-c43d-4029-bbaa-89a760d6a842&page=queryresults
[0m19:00:15.669504 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 19:00:14.465756 => 19:00:15.669504
[0m19:00:15.670501 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5AD82B0>]}
[0m19:00:15.671502 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m19:00:15.673509 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m19:00:15.674505 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m19:00:15.675505 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m19:00:15.677506 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m19:00:15.678505 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m19:00:15.688507 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m19:00:15.691507 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 19:00:15.679506 => 19:00:15.690504
[0m19:00:15.693507 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m19:00:15.703530 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m19:00:15.709518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 19:00:14.536670 => 19:00:15.709518
[0m19:00:15.711538 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6BAE340>]}
[0m19:00:15.712537 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m19:00:15.714061 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:15.716089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:15.720092 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m19:00:16.806033 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:68fc4927-f1d1-4414-99bc-881071304355&page=queryresults
[0m19:00:17.173618 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 19:00:15.694500 => 19:00:17.173618
[0m19:00:17.174615 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6B8ADC0>]}
[0m19:00:17.175612 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m19:00:17.177537 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m19:00:17.179491 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m19:00:17.181616 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m19:00:17.183609 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m19:00:17.184612 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m19:00:17.193575 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m19:00:17.196610 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 19:00:17.185558 => 19:00:17.196610
[0m19:00:17.197550 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m19:00:17.211697 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:17.894022 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m19:00:17.897021 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m19:00:18.680981 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9abad0bb-28d3-4ad6-8bec-f8add22e192d&page=queryresults
[0m19:00:21.509232 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 19:00:17.198576 => 19:00:21.508215
[0m19:00:21.510219 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5793250>]}
[0m19:00:21.511212 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.33s]
[0m19:00:21.513271 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m19:00:21.515329 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m19:00:21.516316 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m19:00:21.519323 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m19:00:21.520329 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m19:00:21.529032 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m19:00:21.532006 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 19:00:21.520329 => 19:00:21.531038
[0m19:00:21.533039 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m19:00:21.537948 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:22.480407 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m19:00:22.485493 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m19:00:23.175328 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09c236cf-5727-4a07-ada8-8f932e579551&page=queryresults
[0m19:00:25.433109 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 19:00:21.534047 => 19:00:25.432108
[0m19:00:25.434109 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6C77AC0>]}
[0m19:00:25.435109 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.92s]
[0m19:00:25.437619 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m19:00:25.439629 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m19:00:25.440626 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m19:00:25.441626 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m19:00:25.444627 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m19:00:25.442627 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m19:00:25.445627 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m19:00:25.446626 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m19:00:25.452632 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m19:00:25.456632 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:25.465632 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m19:00:25.469634 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 19:00:25.457634 => 19:00:25.468631
[0m19:00:25.470630 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 19:00:25.447627 => 19:00:25.470630
[0m19:00:25.471631 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m19:00:25.472630 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m19:00:25.479637 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:25.484629 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:26.169817 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:26.173739 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m19:00:26.190817 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m19:00:26.194840 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m19:00:26.742121 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1cc10e3d-3810-485c-a5e1-2e01884b1a39&page=queryresults
[0m19:00:26.912684 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e4648b2-840b-4336-a879-01ed804f8701&page=queryresults
[0m19:00:29.702425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 19:00:25.473632 => 19:00:29.701419
[0m19:00:29.703420 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6C2A940>]}
[0m19:00:29.703420 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.26s]
[0m19:00:29.705282 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m19:00:31.514196 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 19:00:25.480637 => 19:00:31.513197
[0m19:00:31.515196 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ce8bdc3-8649-4367-829f-72461e348a55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB6C2AEE0>]}
[0m19:00:31.517195 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 6.07s]
[0m19:00:31.519196 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m19:00:31.524196 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:31.525195 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:31.526197 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:31.526197 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:00:31.527196 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:00:31.528196 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m19:00:31.529195 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m19:00:31.530195 [info ] [MainThread]: 
[0m19:00:31.531194 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 23.05 seconds (23.05s).
[0m19:00:31.537200 [debug] [MainThread]: Command end result
[0m19:00:31.558825 [info ] [MainThread]: 
[0m19:00:31.559822 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:31.560857 [info ] [MainThread]: 
[0m19:00:31.561852 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m19:00:31.562851 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:31.562851 after 24.83 seconds
[0m19:00:31.562851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB21B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB5838A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CDB586FA90>]}
[0m19:00:31.563852 [debug] [MainThread]: Flushing usage events
[0m20:00:05.228036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC35E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC25719D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC2571B80>]}


============================== 20:00:05.235572 | 3341b28a-9708-48f3-8dec-6ce6ecacdbc2 ==============================
[0m20:00:05.235572 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:05.236554 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:00:06.198072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC574ABE0>]}
[0m20:00:06.260596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC2571BE0>]}
[0m20:00:06.262669 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:06.271638 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:06.314677 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:06.314677 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:06.318409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6F1D8E0>]}
[0m20:00:06.331004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6E655B0>]}
[0m20:00:06.332030 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:06.332030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6E65610>]}
[0m20:00:06.334028 [info ] [MainThread]: 
[0m20:00:06.335005 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:06.338005 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:06.338005 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.373429 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:06.374431 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:07.374031 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:08.040465 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:00:08.042602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:00:08.043623 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:08.044614 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:08.717297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:00:08.720421 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:09.382200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6BC2280>]}
[0m20:00:09.383229 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:09.385193 [info ] [MainThread]: 
[0m20:00:09.392854 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:09.393960 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m20:00:09.394884 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m20:00:09.398183 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:00:09.399182 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:09.397180 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m20:00:09.413455 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:09.414722 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m20:00:09.415737 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m20:00:09.422182 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:09.424061 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:00:09.399182 => 20:00:09.423207
[0m20:00:09.425061 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:09.444848 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 20:00:09.417061 => 20:00:09.443838
[0m20:00:09.447571 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m20:00:09.518562 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:09.519568 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:09.522502 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m20:00:09.522502 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:09.525571 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m20:00:09.564226 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m20:00:10.340623 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d801a28e-63f3-4e44-83f3-e15635bce0a5&page=queryresults
[0m20:00:10.348594 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b8233c8f-0ffd-43b5-ac3d-18571ccce256&page=queryresults
[0m20:00:10.742706 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 20:00:09.449533 => 20:00:10.742706
[0m20:00:10.743708 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6F9F0D0>]}
[0m20:00:10.743708 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m20:00:10.744642 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m20:00:10.745702 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.747046 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m20:00:10.748166 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m20:00:10.749166 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.753161 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:10.754166 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 20:00:10.749166 => 20:00:10.754166
[0m20:00:10.754166 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.757541 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:10.757541 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:10.760569 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m20:00:10.801396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:00:09.425061 => 20:00:10.801396
[0m20:00:10.802395 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6FA5100>]}
[0m20:00:10.803395 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m20:00:10.804149 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:10.805164 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.806161 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m20:00:10.807801 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m20:00:10.807801 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.810946 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m20:00:10.811946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 20:00:10.807801 => 20:00:10.811946
[0m20:00:10.812880 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.814944 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m20:00:10.815872 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:10.816521 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m20:00:11.565749 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99c2be0a-f138-45c2-bc64-0e3cf1604b75&page=queryresults
[0m20:00:11.587211 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1f024b23-21e1-40ba-bbc1-755f014c509c&page=queryresults
[0m20:00:11.975221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 20:00:10.755046 => 20:00:11.974225
[0m20:00:11.976218 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6F521F0>]}
[0m20:00:11.976633 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m20:00:11.978675 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m20:00:11.979673 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m20:00:11.980671 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m20:00:11.982671 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m20:00:11.983670 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m20:00:11.994624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 20:00:10.812880 => 20:00:11.994624
[0m20:00:11.999366 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6F9F2E0>]}
[0m20:00:12.002370 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m20:00:12.016434 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:12.018067 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m20:00:12.020067 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.021053 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m20:00:12.023302 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m20:00:12.024399 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 20:00:11.984626 => 20:00:12.024399
[0m20:00:12.025401 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.026942 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m20:00:12.033077 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:12.036898 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:12.039922 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 20:00:12.028058 => 20:00:12.038914
[0m20:00:12.041023 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:12.041924 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.047665 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:12.050665 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m20:00:12.101575 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:12.104567 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m20:00:12.844694 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85f63a8a-081c-4890-969b-d689817bd05c&page=queryresults
[0m20:00:12.921576 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4dc68bab-3c59-4f93-849b-cf131e0c307e&page=queryresults
[0m20:00:13.222273 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 20:00:12.042914 => 20:00:13.222273
[0m20:00:13.224274 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6FAD130>]}
[0m20:00:13.224274 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m20:00:13.226176 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:13.226176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m20:00:13.227172 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m20:00:13.228833 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m20:00:13.228833 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m20:00:13.236753 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m20:00:13.238920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 20:00:13.228833 => 20:00:13.238022
[0m20:00:13.238920 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m20:00:13.242919 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m20:00:13.244919 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:13.247153 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m20:00:13.318002 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 20:00:12.033077 => 20:00:13.316887
[0m20:00:13.319069 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6D36A90>]}
[0m20:00:13.320014 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m20:00:13.322032 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m20:00:13.969772 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c5a086a-9f54-46d2-80d5-46d816cfc0df&page=queryresults
[0m20:00:14.365337 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 20:00:13.239919 => 20:00:14.365337
[0m20:00:14.366340 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC80D2F40>]}
[0m20:00:14.367632 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m20:00:14.369534 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m20:00:14.370533 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m20:00:14.371635 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m20:00:14.372530 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m20:00:14.373634 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m20:00:14.378881 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m20:00:14.380772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 20:00:14.373634 => 20:00:14.379885
[0m20:00:14.381772 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m20:00:14.402351 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:15.067018 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m20:00:15.069416 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m20:00:15.741446 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:efae2aaa-c688-441e-bade-98f29966af54&page=queryresults
[0m20:00:18.873691 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 20:00:14.381772 => 20:00:18.873691
[0m20:00:18.875686 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6C94580>]}
[0m20:00:18.876674 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.50s]
[0m20:00:18.877912 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m20:00:18.878816 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:00:18.879818 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m20:00:18.881922 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m20:00:18.881922 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:00:18.888157 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:00:18.889055 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:00:18.882921 => 20:00:18.889055
[0m20:00:18.890425 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:00:18.893436 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:19.610989 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:00:19.612989 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:00:20.354755 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:822bfdc4-f2cd-4060-b2a9-bae3430a2003&page=queryresults
[0m20:00:23.182376 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:00:18.890425 => 20:00:23.182376
[0m20:00:23.184373 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6FB0700>]}
[0m20:00:23.185373 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.30s]
[0m20:00:23.186896 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:00:23.189216 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m20:00:23.190320 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m20:00:23.191214 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m20:00:23.194314 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m20:00:23.195215 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m20:00:23.200212 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:23.192216 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m20:00:23.202652 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m20:00:23.202652 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m20:00:23.209269 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m20:00:23.211171 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 20:00:23.195215 => 20:00:23.211171
[0m20:00:23.212225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m20:00:23.213263 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 20:00:23.203794 => 20:00:23.212225
[0m20:00:23.217169 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m20:00:23.226125 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:23.229237 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:23.923726 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m20:00:23.927154 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m20:00:23.973287 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:23.976286 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m20:00:24.543950 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:931f31df-fdf3-4599-986b-e2917f00e422&page=queryresults
[0m20:00:24.600101 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd548ee1-9570-4d60-841d-530399dfb111&page=queryresults
[0m20:00:26.539200 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 20:00:23.214289 => 20:00:26.539200
[0m20:00:26.541191 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC806A130>]}
[0m20:00:26.541191 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.35s]
[0m20:00:26.543103 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m20:00:27.061334 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 20:00:23.226125 => 20:00:27.060327
[0m20:00:27.062328 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3341b28a-9708-48f3-8dec-6ce6ecacdbc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6FAD9D0>]}
[0m20:00:27.063325 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 3.86s]
[0m20:00:27.065326 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m20:00:27.067604 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:27.068725 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:27.069727 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:27.069727 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:00:27.070725 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:00:27.070725 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m20:00:27.071735 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m20:00:27.072617 [info ] [MainThread]: 
[0m20:00:27.073527 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.74 seconds (20.74s).
[0m20:00:27.076588 [debug] [MainThread]: Command end result
[0m20:00:27.090211 [info ] [MainThread]: 
[0m20:00:27.092221 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:00:27.092693 [info ] [MainThread]: 
[0m20:00:27.093781 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m20:00:27.095740 [debug] [MainThread]: Command `dbt run` succeeded at 20:00:27.094569 after 21.94 seconds
[0m20:00:27.095740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC35E33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6F52F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EEC6BDE100>]}
[0m20:00:27.096744 [debug] [MainThread]: Flushing usage events
[0m21:00:04.622810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE439F9460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4298B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4298BE20>]}


============================== 21:00:04.631177 | 758c6182-e1e0-4678-99d9-f652b00dfe0e ==============================
[0m21:00:04.631177 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:04.632138 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:00:05.613870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4297B880>]}
[0m21:00:05.714935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE46F43B80>]}
[0m21:00:05.716929 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:05.728835 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:05.838722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:05.838722 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:05.845720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4731D970>]}
[0m21:00:05.860719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE472605E0>]}
[0m21:00:05.861731 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:05.862231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE472606D0>]}
[0m21:00:05.864272 [info ] [MainThread]: 
[0m21:00:05.865271 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:05.867557 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:05.867557 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:05.868591 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:05.869594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.678919 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:07.476016 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:00:07.477519 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:00:07.478519 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:07.479523 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:08.162050 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:00:08.163048 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:09.083525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE470C58B0>]}
[0m21:00:09.084526 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:09.085522 [info ] [MainThread]: 
[0m21:00:09.094088 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.095096 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.096088 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m21:00:09.098377 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m21:00:09.097381 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m21:00:09.100378 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.101377 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:00:09.115722 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:09.116750 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.119291 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:09.121295 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 21:00:09.102374 => 21:00:09.121295
[0m21:00:09.122171 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.123170 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:00:09.117177 => 21:00:09.123170
[0m21:00:09.138690 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.157495 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:09.160679 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:09.162551 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:09.163549 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:00:09.165652 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:00:09.167903 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m21:00:10.036625 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:94f8aad1-aed9-4beb-8e43-805987183b18&page=queryresults
[0m21:00:10.053402 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:487434e9-b6fd-4236-975d-fe033bb622b3&page=queryresults
[0m21:00:10.477882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:00:09.138690 => 21:00:10.477882
[0m21:00:10.479880 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 21:00:09.124212 => 21:00:10.479880
[0m21:00:10.479880 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE483E4E80>]}
[0m21:00:10.480883 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4713BF10>]}
[0m21:00:10.480883 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m21:00:10.481899 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:00:10.482881 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:00:10.481899 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m21:00:10.482881 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:10.483880 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m21:00:10.482881 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m21:00:10.484983 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m21:00:10.485880 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:00:10.488204 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:10.483880 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m21:00:10.489200 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m21:00:10.489200 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m21:00:10.492202 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m21:00:10.492202 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:00:10.485880 => 21:00:10.492202
[0m21:00:10.493202 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:00:10.494204 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:10.495201 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 21:00:10.490201 => 21:00:10.495201
[0m21:00:10.495201 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m21:00:10.497201 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m21:00:10.497777 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:10.498784 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:00:10.517896 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:10.519896 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m21:00:11.342141 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ba48cf99-59a8-4012-af94-4cda27004389&page=queryresults
[0m21:00:11.354738 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:362a5181-a0f3-495e-837d-9370a9ec364f&page=queryresults
[0m21:00:11.792865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 21:00:10.495201 => 21:00:11.791866
[0m21:00:11.795858 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:00:10.493202 => 21:00:11.795858
[0m21:00:11.797325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE483DB580>]}
[0m21:00:11.798335 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE483C6040>]}
[0m21:00:11.799327 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m21:00:11.801324 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m21:00:11.800325 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m21:00:11.801324 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m21:00:11.802325 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:00:11.803322 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:11.802325 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m21:00:11.804324 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m21:00:11.803322 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m21:00:11.804324 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m21:00:11.804324 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m21:00:11.806325 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:11.807325 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:11.810515 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 21:00:11.804324 => 21:00:11.810515
[0m21:00:11.811419 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m21:00:11.813424 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:11.819218 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:11.819218 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 21:00:11.807325 => 21:00:11.819218
[0m21:00:11.820097 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:11.820097 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:11.822221 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:11.823222 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m21:00:11.845309 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:11.847712 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m21:00:12.580102 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:21b115d1-0b98-4d49-a631-a0d8a46d66f9&page=queryresults
[0m21:00:12.586719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f1f6d32-1d83-4b63-a145-3b6cae46577a&page=queryresults
[0m21:00:13.086972 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 21:00:11.820097 => 21:00:13.085990
[0m21:00:13.091955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 21:00:11.812489 => 21:00:13.091955
[0m21:00:13.092957 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE48460C40>]}
[0m21:00:13.093946 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE48460C70>]}
[0m21:00:13.094945 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m21:00:13.095957 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:13.096946 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m21:00:13.094945 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m21:00:13.098181 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m21:00:13.096946 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m21:00:13.099187 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m21:00:13.100188 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:00:13.104187 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:00:13.105187 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:00:13.100188 => 21:00:13.105187
[0m21:00:13.106188 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:00:13.109523 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:00:13.111488 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:13.114020 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:00:13.996995 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5903b1cb-92c4-4799-afb3-4fc5a1b8ab72&page=queryresults
[0m21:00:14.398464 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:00:13.106188 => 21:00:14.398464
[0m21:00:14.399466 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE4844D130>]}
[0m21:00:14.399466 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m21:00:14.401463 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:00:14.403466 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:00:14.404473 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m21:00:14.406741 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m21:00:14.407788 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:00:14.412776 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:00:14.414882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:00:14.408790 => 21:00:14.414882
[0m21:00:14.415832 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:00:14.428974 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:15.362432 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:00:15.363418 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:00:16.016748 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a01f25fe-8d7d-49c9-b2ef-f92ea426fc54&page=queryresults
[0m21:00:18.840294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:00:14.415832 => 21:00:18.839279
[0m21:00:18.842849 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE47328580>]}
[0m21:00:18.843849 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.44s]
[0m21:00:18.845851 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:00:18.848217 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:00:18.848728 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m21:00:18.851848 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m21:00:18.851848 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:00:18.859228 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:00:18.861404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:00:18.852851 => 21:00:18.860507
[0m21:00:18.862402 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:00:18.866951 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:19.514144 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:00:19.517023 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m21:00:20.206532 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:717f9940-bd38-49ef-a27e-82873b28690b&page=queryresults
[0m21:00:22.490658 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:00:18.862402 => 21:00:22.489655
[0m21:00:22.491658 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE48401490>]}
[0m21:00:22.492650 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.64s]
[0m21:00:22.494557 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:00:22.495556 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:00:22.495556 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m21:00:22.496556 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m21:00:22.498557 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:00:22.498557 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:00:22.503555 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:22.497555 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m21:00:22.509030 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m21:00:22.510005 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m21:00:22.510005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:00:22.499556 => 21:00:22.509030
[0m21:00:22.516016 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:22.516647 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:00:22.520773 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:22.563753 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 21:00:22.511016 => 21:00:22.563753
[0m21:00:22.564650 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m21:00:22.568001 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:23.192395 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:23.196388 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:23.198579 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m21:00:23.202580 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:00:23.794823 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce3c0292-5989-4aa5-98d3-88d4e8b20db4&page=queryresults
[0m21:00:23.844291 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c509bc1b-2dc6-45e6-b41e-56c7643d6a33&page=queryresults
[0m21:00:27.793123 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 21:00:22.564650 => 21:00:27.793123
[0m21:00:27.794113 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE484EEAF0>]}
[0m21:00:27.795125 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.29s]
[0m21:00:27.795125 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m21:00:31.704670 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:00:22.517675 => 21:00:31.704670
[0m21:00:31.704670 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758c6182-e1e0-4678-99d9-f652b00dfe0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE483A10A0>]}
[0m21:00:31.704670 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 9.21s]
[0m21:00:31.704670 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:00:31.711942 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:00:31.712940 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:31.712940 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:31.713936 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:00:31.715041 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:00:31.715041 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:00:31.716039 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m21:00:31.716039 [info ] [MainThread]: 
[0m21:00:31.717471 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 25.85 seconds (25.85s).
[0m21:00:31.720990 [debug] [MainThread]: Command end result
[0m21:00:31.735204 [info ] [MainThread]: 
[0m21:00:31.736207 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:00:31.737206 [info ] [MainThread]: 
[0m21:00:31.737956 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m21:00:31.740468 [debug] [MainThread]: Command `dbt run` succeeded at 21:00:31.739281 after 27.20 seconds
[0m21:00:31.740468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE439F9460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE470DD130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FE46FC25B0>]}
[0m21:00:31.741467 [debug] [MainThread]: Flushing usage events
[0m22:00:04.790662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAB2B2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAA2289A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAA228D30>]}


============================== 22:00:04.800083 | 6ae39f5a-147b-4923-a387-60db2a1b9dfd ==============================
[0m22:00:04.800083 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:00:04.801065 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:00:05.767233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAA2341F0>]}
[0m22:00:05.824109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAE920B20>]}
[0m22:00:05.826202 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:00:05.836229 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:00:05.889975 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:05.889975 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:05.893981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEBCD940>]}
[0m22:00:05.903595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEB10610>]}
[0m22:00:05.903595 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:00:05.904635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEB10670>]}
[0m22:00:05.906977 [info ] [MainThread]: 
[0m22:00:05.907592 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:00:05.910464 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:05.910464 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:05.912461 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:05.913430 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:06.712537 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:07.373986 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:00:07.375006 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:00:07.376523 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:07.377537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:08.044524 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:00:08.045528 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:08.681506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAE88FDC0>]}
[0m22:00:08.683523 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:00:08.684521 [info ] [MainThread]: 
[0m22:00:08.692011 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:08.693014 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m22:00:08.695028 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m22:00:08.695028 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m22:00:08.697941 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:00:08.698988 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m22:00:08.700540 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:08.701473 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m22:00:08.712846 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:08.720532 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:00:08.722556 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 22:00:08.707757 => 22:00:08.721533
[0m22:00:08.723537 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m22:00:08.741174 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:00:08.702379 => 22:00:08.740205
[0m22:00:08.742207 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:08.779660 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:00:08.784806 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:08.787084 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:00:08.790664 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m22:00:08.791660 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m22:00:08.829690 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m22:00:09.801956 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e32078a2-f675-4489-9e4a-b529cf93556a&page=queryresults
[0m22:00:09.889836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ed2b17d-af79-4394-9789-0636a64635e1&page=queryresults
[0m22:00:10.283140 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 22:00:08.724535 => 22:00:10.283140
[0m22:00:10.284140 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEC51FD0>]}
[0m22:00:10.285138 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m22:00:10.286672 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m22:00:10.286672 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m22:00:10.287670 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m22:00:10.288669 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m22:00:10.288669 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m22:00:10.290670 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:10.291668 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 22:00:10.288669 => 22:00:10.291668
[0m22:00:10.291668 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m22:00:10.293669 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:10.294668 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:10.295669 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:00:10.318680 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:00:08.742207 => 22:00:10.318680
[0m22:00:10.318680 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEC518B0>]}
[0m22:00:10.319677 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m22:00:10.320580 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:00:10.320580 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m22:00:10.321576 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m22:00:10.322581 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m22:00:10.322581 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m22:00:10.325577 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m22:00:10.327117 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 22:00:10.322581 => 22:00:10.327117
[0m22:00:10.328390 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m22:00:10.331397 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m22:00:10.332394 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:10.334389 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m22:00:10.984315 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:68973391-2461-47c9-9f4e-352debf3b9e1&page=queryresults
[0m22:00:11.048632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb140c15-c029-4d80-916d-a8d1dfb2af80&page=queryresults
[0m22:00:11.386637 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 22:00:10.291668 => 22:00:11.386006
[0m22:00:11.386637 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFD181C0>]}
[0m22:00:11.387649 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m22:00:11.388761 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m22:00:11.389649 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m22:00:11.390651 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m22:00:11.391649 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m22:00:11.392651 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m22:00:11.397234 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m22:00:11.398250 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 22:00:11.392651 => 22:00:11.398250
[0m22:00:11.399296 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m22:00:11.408867 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m22:00:11.409868 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:11.410868 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m22:00:11.447461 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 22:00:10.328390 => 22:00:11.447009
[0m22:00:11.447461 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEC573D0>]}
[0m22:00:11.447461 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m22:00:11.449452 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m22:00:11.449452 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:11.449452 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m22:00:11.450579 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m22:00:11.450579 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:11.452576 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m22:00:11.453569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 22:00:11.450579 => 22:00:11.453569
[0m22:00:11.454491 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:11.455538 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m22:00:11.456549 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:11.457073 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m22:00:12.148708 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7840e8e-ce37-48fb-91b0-4d9bd789fe2b&page=queryresults
[0m22:00:12.184006 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1f7087ad-57fd-4f76-a03a-31e77efdc16e&page=queryresults
[0m22:00:12.519852 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 22:00:11.399296 => 22:00:12.518856
[0m22:00:12.519852 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAEBD8880>]}
[0m22:00:12.520845 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m22:00:12.521762 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m22:00:12.521762 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m22:00:12.523761 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m22:00:12.525853 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m22:00:12.526506 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m22:00:12.533656 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m22:00:12.535653 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 22:00:12.526506 => 22:00:12.535653
[0m22:00:12.536530 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m22:00:12.539234 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m22:00:12.540245 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:12.542307 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m22:00:12.563325 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 22:00:11.454491 => 22:00:12.562327
[0m22:00:12.563325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFD49250>]}
[0m22:00:12.564326 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m22:00:12.564326 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m22:00:13.284737 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac6c4789-f2f3-4ee6-a6cd-76be787432a4&page=queryresults
[0m22:00:13.678645 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 22:00:12.537097 => 22:00:13.678645
[0m22:00:13.679642 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFD70B50>]}
[0m22:00:13.680641 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m22:00:13.681546 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m22:00:13.683558 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m22:00:13.684558 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m22:00:13.685557 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m22:00:13.686917 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m22:00:13.692946 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m22:00:13.693955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 22:00:13.686917 => 22:00:13.692946
[0m22:00:13.694610 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m22:00:13.720527 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:14.395625 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m22:00:14.396628 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m22:00:15.086784 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01ae88a8-0349-419f-98c4-3b95630bb70b&page=queryresults
[0m22:00:18.482532 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 22:00:13.695625 => 22:00:18.482532
[0m22:00:18.484530 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFC54430>]}
[0m22:00:18.487135 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.80s]
[0m22:00:18.490182 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m22:00:18.492553 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m22:00:18.493620 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m22:00:18.496573 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m22:00:18.498365 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m22:00:18.505443 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m22:00:18.507739 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 22:00:18.498365 => 22:00:18.507739
[0m22:00:18.509593 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m22:00:18.513623 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:19.187964 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m22:00:19.190985 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m22:00:19.850880 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1e0f35c5-852c-4754-904c-6e3a45e1d710&page=queryresults
[0m22:00:22.340069 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 22:00:18.509593 => 22:00:22.340069
[0m22:00:22.341069 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFCB36D0>]}
[0m22:00:22.342068 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.85s]
[0m22:00:22.343190 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m22:00:22.344204 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m22:00:22.346214 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m22:00:22.345215 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m22:00:22.347896 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m22:00:22.346885 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m22:00:22.348905 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m22:00:22.349896 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m22:00:22.354901 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:22.355896 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m22:00:22.360043 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m22:00:22.361089 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 22:00:22.356505 => 22:00:22.361089
[0m22:00:22.362118 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 22:00:22.349896 => 22:00:22.362118
[0m22:00:22.363155 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m22:00:22.363155 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m22:00:22.367820 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:22.408089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:23.028084 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m22:00:23.031098 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m22:00:23.037191 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:23.041937 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m22:00:23.642999 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cc1c015c-82e3-4bb0-8787-7703750e0969&page=queryresults
[0m22:00:23.688703 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:181826c3-0710-4183-8cd6-b4ce0e0cb275&page=queryresults
[0m22:00:25.906721 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 22:00:22.368940 => 22:00:25.906210
[0m22:00:25.908053 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFCABAF0>]}
[0m22:00:25.909050 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.56s]
[0m22:00:25.911122 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m22:00:28.378258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 22:00:22.364093 => 22:00:28.377258
[0m22:00:28.380340 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ae39f5a-147b-4923-a387-60db2a1b9dfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFCAB340>]}
[0m22:00:28.381341 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 6.03s]
[0m22:00:28.383057 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m22:00:28.386585 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:00:28.386585 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:28.387588 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:28.388586 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:00:28.388586 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:00:28.389583 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m22:00:28.389583 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m22:00:28.390579 [info ] [MainThread]: 
[0m22:00:28.391887 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 22.48 seconds (22.48s).
[0m22:00:28.394400 [debug] [MainThread]: Command end result
[0m22:00:28.412801 [info ] [MainThread]: 
[0m22:00:28.413814 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:00:28.414923 [info ] [MainThread]: 
[0m22:00:28.416274 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m22:00:28.417844 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:28.417844 after 23.72 seconds
[0m22:00:28.418845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAB2B2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAFD04D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAA228790>]}
[0m22:00:28.419843 [debug] [MainThread]: Flushing usage events
[0m23:00:06.572333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC567B3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC557396D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC55739E20>]}


============================== 23:00:06.581926 | 74b6b903-1e7a-4fad-be68-533dbf2dc567 ==============================
[0m23:00:06.581926 [info ] [MainThread]: Running with dbt=1.7.4
[0m23:00:06.581926 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m23:00:07.625313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5572E130>]}
[0m23:00:07.689682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59E20A90>]}
[0m23:00:07.689682 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m23:00:07.689682 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m23:00:07.737593 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:00:07.737593 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:00:07.737593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A0CDA60>]}
[0m23:00:07.753451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A010730>]}
[0m23:00:07.753451 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m23:00:07.753451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A010790>]}
[0m23:00:07.753451 [info ] [MainThread]: 
[0m23:00:07.753451 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:00:07.753451 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:07.753451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:07.753451 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:07.769163 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:08.548469 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:09.243644 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m23:00:09.243644 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:09.243644 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m23:00:09.254257 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:10.255836 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m23:00:10.255836 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:10.906048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59E48F40>]}
[0m23:00:10.906048 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:00:10.906048 [info ] [MainThread]: 
[0m23:00:10.921899 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:10.921899 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m23:00:10.921899 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m23:00:10.921899 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m23:00:10.921899 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m23:00:10.921899 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:10.953839 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m23:00:10.953839 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m23:00:10.962277 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:10.969799 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:10.969799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 23:00:10.956480 => 23:00:10.969799
[0m23:00:10.969799 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 23:00:10.938123 => 23:00:10.969799
[0m23:00:10.969799 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m23:00:10.969799 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:11.017269 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:11.032966 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:11.032966 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m23:00:11.032966 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m23:00:11.048876 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m23:00:11.099676 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m23:00:11.929478 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a9b16a7-ef00-4a1e-bc77-0bb4e0cdd824&page=queryresults
[0m23:00:12.003788 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37c7a6bd-7495-4668-a77a-bf1874ba1a8e&page=queryresults
[0m23:00:12.362955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 23:00:10.985595 => 23:00:12.362955
[0m23:00:12.362955 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A151FD0>]}
[0m23:00:12.362955 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m23:00:12.362955 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:12.378697 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m23:00:12.378697 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m23:00:12.378697 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m23:00:12.378697 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m23:00:12.378697 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:12.378697 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 23:00:12.378697 => 23:00:12.378697
[0m23:00:12.378697 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m23:00:12.394436 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:12.394436 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:12.405747 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m23:00:12.442435 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 23:00:10.969799 => 23:00:12.442435
[0m23:00:12.442435 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B1897C0>]}
[0m23:00:12.442435 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m23:00:12.442435 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m23:00:12.442435 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m23:00:12.442435 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m23:00:12.458242 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m23:00:12.458242 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m23:00:12.458242 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m23:00:12.458242 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 23:00:12.458242 => 23:00:12.458242
[0m23:00:12.458242 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m23:00:12.474189 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m23:00:12.474189 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:12.474189 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m23:00:13.229759 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0549b1bc-e3f8-4c70-be38-fd0e14fe712c&page=queryresults
[0m23:00:13.233789 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58044c7f-20da-420b-ac14-6f04638f66b4&page=queryresults
[0m23:00:13.630745 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 23:00:12.458242 => 23:00:13.630745
[0m23:00:13.632757 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A1540A0>]}
[0m23:00:13.634770 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m23:00:13.639054 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m23:00:13.650154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 23:00:12.378697 => 23:00:13.647399
[0m23:00:13.650154 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m23:00:13.654863 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B190E80>]}
[0m23:00:13.656873 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m23:00:13.659889 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m23:00:13.659889 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m23:00:13.663826 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m23:00:13.665846 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m23:00:13.667862 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:13.677677 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m23:00:13.677677 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m23:00:13.681697 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m23:00:13.681697 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:13.691489 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 23:00:13.667862 => 23:00:13.689480
[0m23:00:13.693497 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m23:00:13.693497 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m23:00:13.721676 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m23:00:13.721676 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:13.721676 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m23:00:13.785267 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 23:00:13.683708 => 23:00:13.785267
[0m23:00:13.785267 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:13.785267 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m23:00:13.785267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:13.801310 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m23:00:14.433095 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9db3efa8-8de9-4519-9207-263a56ea9b8e&page=queryresults
[0m23:00:14.533792 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db56ed1b-1d38-451d-b8e3-6590b6b4560b&page=queryresults
[0m23:00:14.840576 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 23:00:13.693497 => 23:00:14.840576
[0m23:00:14.840576 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A101A00>]}
[0m23:00:14.840576 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m23:00:14.840576 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m23:00:14.847299 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m23:00:14.847299 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m23:00:14.849037 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m23:00:14.849037 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m23:00:14.849037 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m23:00:14.849037 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 23:00:14.849037 => 23:00:14.849037
[0m23:00:14.849037 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m23:00:14.865132 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m23:00:14.865132 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:14.865132 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m23:00:14.990193 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 23:00:13.785267 => 23:00:14.990193
[0m23:00:14.992206 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B207E20>]}
[0m23:00:14.993718 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m23:00:14.993718 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m23:00:15.699513 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7f2f44c5-b4a0-4b03-8fc4-f4ff8f66ae6f&page=queryresults
[0m23:00:16.142974 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 23:00:14.849037 => 23:00:16.142974
[0m23:00:16.144487 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B247070>]}
[0m23:00:16.146500 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m23:00:16.146500 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m23:00:16.146500 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m23:00:16.146500 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m23:00:16.151314 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m23:00:16.151314 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m23:00:16.157163 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m23:00:16.160181 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 23:00:16.151314 => 23:00:16.160181
[0m23:00:16.160181 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m23:00:16.176159 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:16.830326 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m23:00:16.830326 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m23:00:17.400431 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41ac3bf6-2124-4604-a196-3317779c1a51&page=queryresults
[0m23:00:20.201841 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 23:00:16.162191 => 23:00:20.201841
[0m23:00:20.201841 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59D8F880>]}
[0m23:00:20.201841 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.05s]
[0m23:00:20.201841 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m23:00:20.201841 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m23:00:20.211734 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m23:00:20.211734 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m23:00:20.211734 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m23:00:20.219810 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m23:00:20.227532 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 23:00:20.211734 => 23:00:20.227532
[0m23:00:20.227532 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m23:00:20.233577 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:20.840811 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m23:00:20.847557 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m23:00:21.508402 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a8d070b7-dc9c-4a09-8c27-9fe083252b00&page=queryresults
[0m23:00:24.325069 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 23:00:20.229545 => 23:00:24.325069
[0m23:00:24.329102 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B247820>]}
[0m23:00:24.329102 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.12s]
[0m23:00:24.331121 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m23:00:24.333139 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m23:00:24.333139 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m23:00:24.335748 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m23:00:24.335748 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m23:00:24.339238 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m23:00:24.341096 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:24.335748 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m23:00:24.341096 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m23:00:24.352843 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m23:00:24.358882 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m23:00:24.358882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 23:00:24.341096 => 23:00:24.358882
[0m23:00:24.358882 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m23:00:24.358882 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:24.358882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 23:00:24.352843 => 23:00:24.358882
[0m23:00:24.358882 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m23:00:24.371278 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:25.055237 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:25.055237 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m23:00:25.075833 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m23:00:25.075833 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m23:00:25.620513 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ecd37b70-743c-477c-aae1-2a1f87f3a40b&page=queryresults
[0m23:00:25.827666 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0128cad1-43a2-40f1-a3fa-c7ad0e78ee81&page=queryresults
[0m23:00:28.175977 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 23:00:24.358882 => 23:00:28.173963
[0m23:00:28.175977 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B279910>]}
[0m23:00:28.177991 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.84s]
[0m23:00:28.180005 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m23:00:28.585807 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 23:00:24.358882 => 23:00:28.580491
[0m23:00:28.585807 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b6b903-1e7a-4fad-be68-533dbf2dc567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5A0D8790>]}
[0m23:00:28.588222 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.24s]
[0m23:00:28.590619 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m23:00:28.597451 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:28.599464 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:28.599464 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:28.601477 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m23:00:28.601477 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m23:00:28.603491 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m23:00:28.603491 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m23:00:28.605504 [info ] [MainThread]: 
[0m23:00:28.607519 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.85 seconds (20.85s).
[0m23:00:28.619293 [debug] [MainThread]: Command end result
[0m23:00:28.664820 [info ] [MainThread]: 
[0m23:00:28.670271 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:00:28.670271 [info ] [MainThread]: 
[0m23:00:28.670271 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m23:00:28.670271 [debug] [MainThread]: Command `dbt run` succeeded at 23:00:28.670271 after 22.17 seconds
[0m23:00:28.680613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC567B3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC5B247820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CC59D3C100>]}
[0m23:00:28.680613 [debug] [MainThread]: Flushing usage events
[0m00:00:04.956422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD30E33460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD2FDA8640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD2FDA8AC0>]}


============================== 00:00:04.956422 | 3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce ==============================
[0m00:00:04.956422 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:00:04.956422 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m00:00:05.657052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD32F7BB80>]}
[0m00:00:05.736929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD33E604F0>]}
[0m00:00:05.736929 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:00:05.736929 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:00:05.816493 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:00:05.816493 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:00:05.816493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD3475D850>]}
[0m00:00:05.832623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD346A54C0>]}
[0m00:00:05.832623 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:00:05.832623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD346A55B0>]}
[0m00:00:05.832623 [info ] [MainThread]: 
[0m00:00:05.832623 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:00:05.832623 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.832623 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:05.832623 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.832623 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:06.685223 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:07.333410 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m00:00:07.333410 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.333410 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m00:00:07.333410 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.968285 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m00:00:07.970024 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:08.589138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD344CB9A0>]}
[0m00:00:08.589138 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:00:08.589138 [info ] [MainThread]: 
[0m00:00:08.604911 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.604911 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.604911 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m00:00:08.604911 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m00:00:08.604911 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.604911 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m00:00:08.620986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.636781 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m00:00:08.636781 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.636781 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.636781 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 00:00:08.604911 => 00:00:08.636781
[0m00:00:08.636781 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.652957 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 00:00:08.636781 => 00:00:08.652957
[0m00:00:08.652957 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.669037 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.669037 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.669037 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m00:00:08.669037 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:00:08.669037 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m00:00:08.707034 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m00:00:09.493979 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e05a1702-98b0-43fb-94b2-3c9f2971aa4b&page=queryresults
[0m00:00:09.509907 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86f2ea49-b71b-47db-b54c-338e13b57c96&page=queryresults
[0m00:00:09.971965 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 00:00:08.669037 => 00:00:09.971965
[0m00:00:09.971965 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD34411550>]}
[0m00:00:09.977770 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 00:00:08.636781 => 00:00:09.977770
[0m00:00:09.977770 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD344CB9A0>]}
[0m00:00:09.977770 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m00:00:09.977770 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m00:00:09.977770 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m00:00:09.977770 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m00:00:09.977770 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:09.977770 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m00:00:09.977770 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m00:00:09.977770 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m00:00:09.977770 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m00:00:09.977770 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m00:00:09.977770 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m00:00:09.987616 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:09.987616 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m00:00:09.991714 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m00:00:09.991714 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 00:00:09.977770 => 00:00:09.991714
[0m00:00:09.991714 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m00:00:09.991714 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:09.991714 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 00:00:09.987616 => 00:00:09.991714
[0m00:00:09.991714 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m00:00:09.991714 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:10.003492 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m00:00:10.003492 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m00:00:10.029311 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:10.029311 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m00:00:10.768725 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad979242-0a56-48b7-89b7-177642447043&page=queryresults
[0m00:00:10.816133 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:56b06d41-21cf-4bda-9ae9-c23ce1fcb667&page=queryresults
[0m00:00:11.229961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 00:00:09.991714 => 00:00:11.229961
[0m00:00:11.229961 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD344D34C0>]}
[0m00:00:11.229961 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 00:00:09.991714 => 00:00:11.229961
[0m00:00:11.229961 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m00:00:11.229961 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD358972B0>]}
[0m00:00:11.246058 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m00:00:11.246058 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m00:00:11.246058 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m00:00:11.246058 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m00:00:11.246058 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m00:00:11.246058 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m00:00:11.246058 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.246058 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m00:00:11.246058 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m00:00:11.246058 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m00:00:11.246058 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m00:00:11.246058 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.261799 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:11.261799 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 00:00:11.246058 => 00:00:11.261799
[0m00:00:11.261799 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m00:00:11.261799 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m00:00:11.261799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 00:00:11.246058 => 00:00:11.261799
[0m00:00:11.261799 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:11.261799 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:11.261799 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:11.261799 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m00:00:11.294364 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:11.294364 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m00:00:12.051612 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:703bbc9e-b31c-469d-b5e9-d7d6461dd658&page=queryresults
[0m00:00:12.090974 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:576da496-3cad-438b-8725-e7c2613f9bda&page=queryresults
[0m00:00:12.450703 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 00:00:11.261799 => 00:00:12.450703
[0m00:00:12.450703 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD358ACD30>]}
[0m00:00:12.466490 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m00:00:12.466490 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:12.466490 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m00:00:12.466490 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m00:00:12.466490 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m00:00:12.466490 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m00:00:12.482240 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m00:00:12.500847 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 00:00:11.261799 => 00:00:12.500847
[0m00:00:12.502870 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD358EE970>]}
[0m00:00:12.505071 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 00:00:12.466490 => 00:00:12.505071
[0m00:00:12.505071 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m00:00:12.505071 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m00:00:12.513950 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m00:00:12.513950 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m00:00:12.513950 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:12.513950 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m00:00:13.194314 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2832f94-93a9-4c53-8244-7961db90a44b&page=queryresults
[0m00:00:13.559029 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 00:00:12.505071 => 00:00:13.559029
[0m00:00:13.559029 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD34411550>]}
[0m00:00:13.559029 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.09s]
[0m00:00:13.559029 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m00:00:13.559029 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m00:00:13.559029 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m00:00:13.559029 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m00:00:13.559029 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m00:00:13.575050 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m00:00:13.575050 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 00:00:13.559029 => 00:00:13.575050
[0m00:00:13.575050 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m00:00:13.590788 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:14.264418 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m00:00:14.264418 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m00:00:14.933827 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a085bd35-11cd-4e24-80a2-b2f5e9119f74&page=queryresults
[0m00:00:17.764728 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 00:00:13.575050 => 00:00:17.764728
[0m00:00:17.764728 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD358E0970>]}
[0m00:00:17.764728 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.21s]
[0m00:00:17.764728 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m00:00:17.764728 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m00:00:17.764728 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m00:00:17.780812 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m00:00:17.780812 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m00:00:17.780812 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m00:00:17.780812 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 00:00:17.780812 => 00:00:17.780812
[0m00:00:17.780812 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m00:00:17.780812 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:18.416289 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m00:00:18.416289 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m00:00:19.080574 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7aca76f-229b-436a-942c-7059ae48e8ac&page=queryresults
[0m00:00:23.462226 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 00:00:17.780812 => 00:00:23.462226
[0m00:00:23.464240 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD35879BE0>]}
[0m00:00:23.464240 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 5.70s]
[0m00:00:23.467369 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m00:00:23.467369 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m00:00:23.467369 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m00:00:23.467369 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m00:00:23.467369 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m00:00:23.467369 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m00:00:23.467369 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m00:00:23.467369 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m00:00:23.479024 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:23.479024 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m00:00:23.483203 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 00:00:23.467369 => 00:00:23.483203
[0m00:00:23.483203 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m00:00:23.490687 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:23.490687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m00:00:23.514816 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 00:00:23.479024 => 00:00:23.514816
[0m00:00:23.514816 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m00:00:23.514816 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:24.124511 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m00:00:24.124511 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m00:00:24.140623 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:24.140623 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m00:00:24.755455 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aec7d663-daaa-400c-85fc-5e04c73286ac&page=queryresults
[0m00:00:24.768319 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa224312-f770-406c-98f5-27791f52cb7b&page=queryresults
[0m00:00:27.262425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 00:00:23.483203 => 00:00:27.262425
[0m00:00:27.262425 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD35877DF0>]}
[0m00:00:27.262425 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.80s]
[0m00:00:27.262425 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m00:00:27.262425 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 00:00:23.514816 => 00:00:27.262425
[0m00:00:27.262425 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6d889e-2a65-4bdb-8a4f-82cbb2d01cce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD358FF730>]}
[0m00:00:27.278362 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 3.80s]
[0m00:00:27.278362 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m00:00:27.278362 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m00:00:27.278362 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m00:00:27.278362 [info ] [MainThread]: 
[0m00:00:27.278362 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 21.45 seconds (21.45s).
[0m00:00:27.278362 [debug] [MainThread]: Command end result
[0m00:00:27.294396 [info ] [MainThread]: 
[0m00:00:27.294396 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:00:27.294396 [info ] [MainThread]: 
[0m00:00:27.294396 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m00:00:27.310514 [debug] [MainThread]: Command `dbt run` succeeded at 00:00:27.310514 after 22.41 seconds
[0m00:00:27.310514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD30E33460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD359457C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD3475DB50>]}
[0m00:00:27.310514 [debug] [MainThread]: Flushing usage events
[0m01:00:04.361797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026860DB3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002685FD596D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002685FD59E20>]}


============================== 01:00:04.361797 | 6873a841-148e-4882-ad42-1453af638be9 ==============================
[0m01:00:04.361797 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:00:04.361797 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:00:05.182983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002685FD4A220>]}
[0m01:00:05.247023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026864440A60>]}
[0m01:00:05.247023 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:00:05.263196 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:00:05.311230 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:00:05.311230 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:00:05.311230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268646EDA30>]}
[0m01:00:05.311230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026864630700>]}
[0m01:00:05.311230 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:00:05.311230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026864630760>]}
[0m01:00:05.327116 [info ] [MainThread]: 
[0m01:00:05.327116 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:00:05.327116 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:05.327116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:05.327116 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:05.327116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:06.256973 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:06.931108 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m01:00:06.931108 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:06.931108 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:00:06.931108 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:07.575190 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m01:00:07.575190 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:08.228780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268644FFC40>]}
[0m01:00:08.228780 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:00:08.228780 [info ] [MainThread]: 
[0m01:00:08.244501 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:08.244501 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m01:00:08.244501 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m01:00:08.244501 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m01:00:08.244501 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m01:00:08.244501 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:08.244501 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m01:00:08.260198 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:08.260198 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m01:00:08.260198 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:08.276028 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 01:00:08.244501 => 01:00:08.276028
[0m01:00:08.276028 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:08.291971 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 01:00:08.260198 => 01:00:08.291971
[0m01:00:08.308156 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m01:00:08.308156 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:08.308156 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:08.316491 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:00:08.316491 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:00:08.316491 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m01:00:08.339943 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m01:00:09.119314 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d31f03f7-93b3-4341-be85-21be761a7482&page=queryresults
[0m01:00:09.130432 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1c088a8-9183-4b3d-8e97-f6eb8b9aa322&page=queryresults
[0m01:00:09.547205 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 01:00:08.308156 => 01:00:09.547205
[0m01:00:09.547205 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026864750D60>]}
[0m01:00:09.547205 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m01:00:09.563060 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m01:00:09.563060 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m01:00:09.563060 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m01:00:09.563060 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m01:00:09.563060 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m01:00:09.563060 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:09.563060 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 01:00:08.276028 => 01:00:09.563060
[0m01:00:09.563060 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268646F85B0>]}
[0m01:00:09.563060 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 01:00:09.563060 => 01:00:09.563060
[0m01:00:09.563060 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m01:00:09.563060 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m01:00:09.579134 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:09.579134 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:09.579134 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m01:00:09.579134 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m01:00:09.579134 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m01:00:09.579134 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m01:00:09.579134 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:09.579134 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m01:00:09.579134 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m01:00:09.610796 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 01:00:09.579134 => 01:00:09.610796
[0m01:00:09.610796 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m01:00:09.610796 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m01:00:09.610796 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:09.610796 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m01:00:10.345043 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f373e23d-ec3e-4b59-ad8b-c732360fdc13&page=queryresults
[0m01:00:10.345043 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c74f3129-67a9-44a0-b6bc-49884d672edc&page=queryresults
[0m01:00:10.746883 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 01:00:09.563060 => 01:00:10.746883
[0m01:00:10.746883 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026865810DF0>]}
[0m01:00:10.746883 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m01:00:10.746883 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m01:00:10.746883 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m01:00:10.746883 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m01:00:10.763128 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m01:00:10.763128 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 01:00:09.610796 => 01:00:10.763128
[0m01:00:10.763128 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m01:00:10.763128 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002686582A160>]}
[0m01:00:10.774994 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m01:00:10.774994 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m01:00:10.774994 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m01:00:10.774994 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:10.778924 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m01:00:10.778924 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 01:00:10.763128 => 01:00:10.778924
[0m01:00:10.778924 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m01:00:10.778924 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m01:00:10.778924 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:10.778924 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m01:00:10.788868 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:00:10.788868 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 01:00:10.778924 => 01:00:10.788868
[0m01:00:10.788868 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:10.788868 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:00:10.793034 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:10.793034 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m01:00:10.810470 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:10.810470 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m01:00:11.574274 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0899d64-c23b-41cb-bda0-ef7758d2b3b6&page=queryresults
[0m01:00:11.674219 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a54d3a1e-0c87-45ad-be59-73f22960265f&page=queryresults
[0m01:00:11.947909 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 01:00:10.778924 => 01:00:11.947909
[0m01:00:11.947909 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268658283A0>]}
[0m01:00:11.947909 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m01:00:11.947909 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m01:00:11.947909 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m01:00:11.947909 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m01:00:11.947909 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m01:00:11.947909 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m01:00:11.947909 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m01:00:11.964845 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 01:00:11.947909 => 01:00:11.964007
[0m01:00:11.964845 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m01:00:11.964845 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m01:00:11.964845 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:11.979857 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m01:00:12.067523 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 01:00:10.788868 => 01:00:12.067523
[0m01:00:12.069523 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268646308E0>]}
[0m01:00:12.069523 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m01:00:12.072305 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m01:00:12.727977 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05e59de0-335f-4b3c-8c9c-0bb5d1577f90&page=queryresults
[0m01:00:13.102766 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 01:00:11.964845 => 01:00:13.100751
[0m01:00:13.102766 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002686586ADC0>]}
[0m01:00:13.104779 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m01:00:13.104779 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m01:00:13.106794 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m01:00:13.106794 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m01:00:13.106794 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m01:00:13.106794 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m01:00:13.112538 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m01:00:13.112538 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 01:00:13.106794 => 01:00:13.112538
[0m01:00:13.112538 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m01:00:13.128521 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:13.768406 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m01:00:13.768406 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m01:00:14.376613 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b6bed98-0817-4cea-bea5-7574a9f6880b&page=queryresults
[0m01:00:17.253761 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 01:00:13.112538 => 01:00:17.253761
[0m01:00:17.253761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026865807100>]}
[0m01:00:17.253761 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.15s]
[0m01:00:17.253761 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m01:00:17.253761 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m01:00:17.262846 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m01:00:17.264860 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m01:00:17.264860 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m01:00:17.269893 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m01:00:17.275920 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 01:00:17.264860 => 01:00:17.275920
[0m01:00:17.277370 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m01:00:17.279383 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:18.096600 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m01:00:18.102943 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m01:00:18.766052 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7151007-4c53-4991-b9e7-9f0e8c91aa8b&page=queryresults
[0m01:00:21.332965 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 01:00:17.277370 => 01:00:21.332965
[0m01:00:21.334981 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268658143A0>]}
[0m01:00:21.334981 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.07s]
[0m01:00:21.336993 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m01:00:21.339006 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m01:00:21.339006 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m01:00:21.339006 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m01:00:21.341018 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m01:00:21.343030 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m01:00:21.346796 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:21.350818 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 01:00:21.343030 => 01:00:21.350818
[0m01:00:21.350818 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m01:00:21.341018 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m01:00:21.350818 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m01:00:21.350818 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m01:00:21.359734 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m01:00:21.368825 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:21.370833 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 01:00:21.355714 => 01:00:21.370833
[0m01:00:21.370833 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m01:00:21.374193 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:22.049666 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:22.049666 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m01:00:22.093826 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m01:00:22.095843 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m01:00:22.635643 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3b86279-bc25-48f8-b3a2-7cfc539b546f&page=queryresults
[0m01:00:22.745897 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:245c8962-e9e7-419c-968f-978e7b1193ec&page=queryresults
[0m01:00:24.588763 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 01:00:21.350818 => 01:00:24.588763
[0m01:00:24.590776 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268658CC070>]}
[0m01:00:24.592790 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.25s]
[0m01:00:24.592790 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m01:00:26.716091 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 01:00:21.370833 => 01:00:26.716091
[0m01:00:26.716091 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6873a841-148e-4882-ad42-1453af638be9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268658D0D60>]}
[0m01:00:26.716091 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.37s]
[0m01:00:26.716091 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m01:00:26.732220 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m01:00:26.732879 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m01:00:26.732879 [info ] [MainThread]: 
[0m01:00:26.732879 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 21.41 seconds (21.41s).
[0m01:00:26.740058 [debug] [MainThread]: Command end result
[0m01:00:26.752165 [info ] [MainThread]: 
[0m01:00:26.752165 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:00:26.752165 [info ] [MainThread]: 
[0m01:00:26.752165 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m01:00:26.752165 [debug] [MainThread]: Command `dbt run` succeeded at 01:00:26.752165 after 22.45 seconds
[0m01:00:26.752165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026860DB3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026864720B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268644EDC10>]}
[0m01:00:26.752165 [debug] [MainThread]: Flushing usage events
[0m02:00:16.821941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D131C23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D130B986D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D130B98E20>]}


============================== 02:00:16.837816 | a7e1b039-0307-49c2-87f7-e1d5480b05e9 ==============================
[0m02:00:16.837816 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:16.837816 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:00:18.071352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D133D6AAC0>]}
[0m02:00:18.156084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1352926D0>]}
[0m02:00:18.167262 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:18.197855 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:21.988631 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:21.988631 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:22.004830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13553D640>]}
[0m02:00:22.062460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D135480400>]}
[0m02:00:22.062460 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:22.063397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1354803A0>]}
[0m02:00:22.064494 [info ] [MainThread]: 
[0m02:00:22.065497 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:22.067091 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:22.068192 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:22.068192 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:22.068192 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:22.953196 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:23.631302 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:23.636093 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:23.636093 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m02:00:23.636093 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:24.402003 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m02:00:24.418069 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:25.089425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13553DE50>]}
[0m02:00:25.089425 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:25.089425 [info ] [MainThread]: 
[0m02:00:25.089425 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:25.103290 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:25.103290 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m02:00:25.103290 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:25.103290 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m02:00:25.103290 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:25.103290 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:25.103290 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:25.119009 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:25.119009 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:25.119009 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:25.103290 => 02:00:25.119009
[0m02:00:25.119009 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:25.135171 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:25.119009 => 02:00:25.135171
[0m02:00:25.135171 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:25.151198 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:25.151198 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:25.151198 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:25.151198 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:25.151198 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:25.151198 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m02:00:26.013873 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:70cd88a5-4163-49d1-851c-54df8b19b1af&page=queryresults
[0m02:00:26.013873 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5731d12f-e8df-4d57-ac6b-fc8a3597c9fc&page=queryresults
[0m02:00:26.489220 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:25.151198 => 02:00:26.489220
[0m02:00:26.495319 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13554A700>]}
[0m02:00:26.503402 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:25.119009 => 02:00:26.501381
[0m02:00:26.497340 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m02:00:26.506375 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13554A4C0>]}
[0m02:00:26.508402 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:26.508402 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:26.508402 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m02:00:26.508402 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m02:00:26.513731 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:26.513731 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:26.517362 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:26.519719 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:26.519719 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m02:00:26.521283 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:26.521283 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m02:00:26.526352 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m02:00:26.528381 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:26.528381 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:26.521283 => 02:00:26.528381
[0m02:00:26.533942 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:26.537042 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:26.537042 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 02:00:26.526352 => 02:00:26.537042
[0m02:00:26.537042 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m02:00:26.543479 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:26.552391 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:26.554421 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:26.608884 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:26.608884 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m02:00:27.328808 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f45b061-d70f-43c3-b4c0-0ccfd9b97055&page=queryresults
[0m02:00:27.408508 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e65778ec-aeac-44c8-affc-7e8e8559687b&page=queryresults
[0m02:00:27.745427 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:26.533942 => 02:00:27.745427
[0m02:00:27.745427 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366A92B0>]}
[0m02:00:27.745427 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m02:00:27.745427 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:27.745427 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m02:00:27.745427 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m02:00:27.745427 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m02:00:27.745427 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m02:00:27.755990 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:27.758001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 02:00:27.745427 => 02:00:27.758001
[0m02:00:27.759519 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m02:00:27.759519 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:27.759519 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:27.759519 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m02:00:27.839012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 02:00:26.537042 => 02:00:27.839012
[0m02:00:27.839012 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13556BA00>]}
[0m02:00:27.839012 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m02:00:27.839012 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:27.839012 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:27.839012 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m02:00:27.839012 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m02:00:27.839012 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:27.854097 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:27.854097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 02:00:27.839012 => 02:00:27.854097
[0m02:00:27.854097 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:27.854097 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:27.854097 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:27.854097 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m02:00:28.594377 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:91f215d0-bb12-41b1-810d-c93934b55c49&page=queryresults
[0m02:00:28.620227 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d035170a-d550-4388-aeaa-d71d281c4068&page=queryresults
[0m02:00:29.001782 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 02:00:27.854097 => 02:00:28.999124
[0m02:00:29.003810 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1355CC700>]}
[0m02:00:29.006858 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 02:00:27.759519 => 02:00:29.006858
[0m02:00:29.006858 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m02:00:29.012325 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D13666EA60>]}
[0m02:00:29.015389 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:29.019442 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:29.017416 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m02:00:29.021470 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m02:00:29.021470 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m02:00:29.025525 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m02:00:29.025525 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:29.030209 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:29.030209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:29.025525 => 02:00:29.030209
[0m02:00:29.030209 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:29.054404 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:29.054404 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:29.056425 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:30.020775 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d34f5ba6-9446-46d5-ba81-d15cd89669bf&page=queryresults
[0m02:00:30.413460 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:29.030209 => 02:00:30.413460
[0m02:00:30.429646 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366FC970>]}
[0m02:00:30.429646 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m02:00:30.429646 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:30.429646 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:30.429646 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m02:00:30.429646 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m02:00:30.429646 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:30.445431 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:30.445431 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:30.429646 => 02:00:30.445431
[0m02:00:30.445431 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:30.445431 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:31.129131 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:31.129131 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:31.816113 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e8b5b136-3678-44b3-9fdd-628c8e3fa383&page=queryresults
[0m02:00:34.915883 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:30.445431 => 02:00:34.913870
[0m02:00:34.915883 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366CB8B0>]}
[0m02:00:34.917899 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.49s]
[0m02:00:34.917899 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:34.919915 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:34.919915 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m02:00:34.921672 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m02:00:34.926711 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:34.926711 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:34.926711 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:34.926711 => 02:00:34.926711
[0m02:00:34.926711 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:34.937653 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:35.765035 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:35.765035 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m02:00:36.403306 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b622abe1-f38e-457a-a282-2cd6316ab0e0&page=queryresults
[0m02:00:38.708505 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:34.926711 => 02:00:38.708505
[0m02:00:38.714662 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366CB8B0>]}
[0m02:00:38.714662 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.79s]
[0m02:00:38.714662 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:38.714662 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:38.714662 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m02:00:38.714662 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m02:00:38.714662 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:38.714662 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m02:00:38.730760 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:38.730760 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m02:00:38.730760 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:38.730760 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m02:00:38.746410 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:38.730760 => 02:00:38.746410
[0m02:00:38.746410 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:38.746410 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:38.778381 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:38.794162 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 02:00:38.730760 => 02:00:38.794162
[0m02:00:38.794162 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m02:00:38.794162 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:39.414608 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:39.414608 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:39.430266 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:39.432286 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:40.052002 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2ca86c55-4b16-4d1f-a02a-144740edc71e&page=queryresults
[0m02:00:40.116390 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0936327a-40a3-4985-bcfa-c6a39b6ee62a&page=queryresults
[0m02:00:42.004912 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:38.746410 => 02:00:42.004912
[0m02:00:42.004912 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366B9970>]}
[0m02:00:42.004912 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.29s]
[0m02:00:42.017940 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:44.107567 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 02:00:38.794162 => 02:00:44.107567
[0m02:00:44.108590 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7e1b039-0307-49c2-87f7-e1d5480b05e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D1366B9220>]}
[0m02:00:44.109587 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.38s]
[0m02:00:44.111595 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m02:00:44.113615 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:44.114587 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:44.115587 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:44.116588 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m02:00:44.117816 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:00:44.118814 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m02:00:44.118814 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m02:00:44.119813 [info ] [MainThread]: 
[0m02:00:44.120815 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 22.05 seconds (22.05s).
[0m02:00:44.127472 [debug] [MainThread]: Command end result
[0m02:00:44.143465 [info ] [MainThread]: 
[0m02:00:44.143465 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:44.143465 [info ] [MainThread]: 
[0m02:00:44.143465 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m02:00:44.143465 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:44.143465 after 27.50 seconds
[0m02:00:44.143465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D131C23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D136721E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D135215F10>]}
[0m02:00:44.143465 [debug] [MainThread]: Flushing usage events
[0m03:00:04.499543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C74E304400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C74D2A08E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C74D2A05E0>]}


============================== 03:00:04.499543 | 58fe83c8-840f-4989-9c14-e9c9e3caf96f ==============================
[0m03:00:04.499543 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:04.499543 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:00:05.407336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C74D29F790>]}
[0m03:00:05.465769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751990AC0>]}
[0m03:00:05.465769 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:05.471745 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:05.535984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:05.535984 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:05.535984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751C3DA90>]}
[0m03:00:05.551907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751B80730>]}
[0m03:00:05.551907 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:05.551907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751B80700>]}
[0m03:00:05.551907 [info ] [MainThread]: 
[0m03:00:05.551907 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:05.551907 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.551907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:05.551907 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.566198 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:06.514635 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:07.176443 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m03:00:07.176443 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:07.176443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.176443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.835862 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:00:07.835862 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.480278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C7519DAA90>]}
[0m03:00:08.480278 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:08.480278 [info ] [MainThread]: 
[0m03:00:08.494442 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.494442 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.494442 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m03:00:08.494442 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:08.494442 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m03:00:08.494442 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.494442 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:08.510364 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.510364 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.510364 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.526209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:08.494442 => 03:00:08.526209
[0m03:00:08.526209 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.510364 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:08.510364 => 03:00:08.510364
[0m03:00:08.526209 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.590496 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.590496 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.590496 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:08.590496 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:08.607807 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:08.609818 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m03:00:09.425170 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:836365e2-243e-40d0-8e88-c381235f1108&page=queryresults
[0m03:00:09.473577 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c8c1c02-6f90-4db1-b8f9-876959b4b74c&page=queryresults
[0m03:00:09.858372 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:08.526209 => 03:00:09.858372
[0m03:00:09.858372 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751C8B460>]}
[0m03:00:09.858372 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m03:00:09.858372 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.858372 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:09.858372 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m03:00:09.858372 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:09.874293 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:09.874293 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:09.874293 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:09.874293 => 03:00:09.874293
[0m03:00:09.874293 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:09.885138 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:09.885138 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:09.890479 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:09.927460 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:08.526209 => 03:00:09.927460
[0m03:00:09.927460 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751CC4520>]}
[0m03:00:09.929468 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m03:00:09.929468 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.929468 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:09.929468 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m03:00:09.929468 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m03:00:09.929468 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m03:00:09.936297 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:09.938306 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 03:00:09.929468 => 03:00:09.936297
[0m03:00:09.938306 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m03:00:09.940315 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:09.942324 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:09.942324 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m03:00:10.587618 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:03d7ae6f-e182-4999-9d7f-507b32594e9a&page=queryresults
[0m03:00:10.712502 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:14395ad7-cebb-4874-bcd6-feeaa890abe8&page=queryresults
[0m03:00:11.011860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:09.874293 => 03:00:11.011860
[0m03:00:11.011860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752D006A0>]}
[0m03:00:11.011860 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m03:00:11.011860 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.027665 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.027665 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m03:00:11.027665 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m03:00:11.027665 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.027665 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:11.027665 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 03:00:11.027665 => 03:00:11.027665
[0m03:00:11.027665 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.027665 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:11.043624 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:11.043624 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m03:00:11.108023 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 03:00:09.938306 => 03:00:11.108023
[0m03:00:11.108023 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752CB60A0>]}
[0m03:00:11.108023 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m03:00:11.108023 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:11.108023 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.108023 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m03:00:11.108023 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m03:00:11.108023 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.108023 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.124058 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 03:00:11.108023 => 03:00:11.108023
[0m03:00:11.124058 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.124058 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.124058 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:11.124058 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m03:00:11.894708 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb6dc455-8cc7-4c50-a82a-b7fe115e0204&page=queryresults
[0m03:00:11.910623 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:752ed7bc-b64d-4520-b8bf-e88f6a1a77f0&page=queryresults
[0m03:00:12.294480 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 03:00:11.027665 => 03:00:12.294480
[0m03:00:12.294480 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752D10AC0>]}
[0m03:00:12.294480 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m03:00:12.294480 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m03:00:12.294480 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:12.301099 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m03:00:12.303110 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m03:00:12.303110 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:12.309989 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:12.310737 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 03:00:11.124058 => 03:00:12.310737
[0m03:00:12.310737 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751CC4520>]}
[0m03:00:12.317322 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m03:00:12.323350 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:12.323350 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:12.303110 => 03:00:12.323350
[0m03:00:12.323350 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:12.329392 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:12.331405 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:12.331405 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:13.060103 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f05e1fe1-ff30-4bc2-9ae4-e05afbedf2ac&page=queryresults
[0m03:00:13.446265 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:12.325364 => 03:00:13.446265
[0m03:00:13.446265 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752D328B0>]}
[0m03:00:13.452735 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m03:00:13.452735 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:13.452735 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:13.456483 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m03:00:13.456483 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m03:00:13.456483 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:13.468796 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:13.468796 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:13.458497 => 03:00:13.468796
[0m03:00:13.468796 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:13.484908 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:14.141869 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:14.143881 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:14.835463 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7d92c5b-04a7-4bd2-84ba-277bf94195c8&page=queryresults
[0m03:00:17.907672 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:13.468796 => 03:00:17.907672
[0m03:00:17.909687 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752CB63A0>]}
[0m03:00:17.909687 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.45s]
[0m03:00:17.911701 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:17.911701 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:17.911701 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m03:00:17.911701 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m03:00:17.911701 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:17.923439 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:17.924088 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:17.911701 => 03:00:17.924088
[0m03:00:17.924088 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:17.927615 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:18.649345 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:18.649345 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m03:00:19.289782 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a94fd8d-ea13-4b42-a62b-9242405ac393&page=queryresults
[0m03:00:21.536987 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:17.926100 => 03:00:21.536987
[0m03:00:21.536987 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752D10AC0>]}
[0m03:00:21.539001 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.63s]
[0m03:00:21.541016 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:21.542771 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.543589 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m03:00:21.543589 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m03:00:21.545600 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:21.545600 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.551641 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:21.543589 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m03:00:21.558738 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m03:00:21.558738 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m03:00:21.564778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:21.566791 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:21.547614 => 03:00:21.566791
[0m03:00:21.566791 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.574599 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:21.574599 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 03:00:21.558738 => 03:00:21.574599
[0m03:00:21.574599 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m03:00:21.587081 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:22.285126 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:22.285126 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:22.296022 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:22.296022 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:22.845641 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae1dc594-d542-4f47-9b2e-3d3ffa14d961&page=queryresults
[0m03:00:22.872629 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88a627c8-fd87-431e-a1bd-b94fdbe0edfc&page=queryresults
[0m03:00:25.101750 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:21.566791 => 03:00:25.099735
[0m03:00:25.101750 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752D6C3A0>]}
[0m03:00:25.103762 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.56s]
[0m03:00:25.103762 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:25.646425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 03:00:21.574599 => 03:00:25.646425
[0m03:00:25.648441 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58fe83c8-840f-4989-9c14-e9c9e3caf96f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C752E1EF70>]}
[0m03:00:25.648441 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.09s]
[0m03:00:25.650455 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m03:00:25.652470 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:25.655031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:25.655031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:25.655031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:25.656543 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:00:25.656543 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m03:00:25.656543 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m03:00:25.656543 [info ] [MainThread]: 
[0m03:00:25.658556 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.10 seconds (20.10s).
[0m03:00:25.662581 [debug] [MainThread]: Command end result
[0m03:00:25.674386 [info ] [MainThread]: 
[0m03:00:25.674386 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:25.674386 [info ] [MainThread]: 
[0m03:00:25.674386 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m03:00:25.674386 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:25.674386 after 21.24 seconds
[0m03:00:25.674386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C74E304400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C751C3DFA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C7519A6CA0>]}
[0m03:00:25.674386 [debug] [MainThread]: Flushing usage events
[0m04:00:04.745986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB89BC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB88B47910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB88B47B80>]}


============================== 04:00:04.762142 | 71f6f18e-e346-43b0-ade5-9bbb68905e30 ==============================
[0m04:00:04.762142 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:04.762142 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m04:00:05.634990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB88B2B8E0>]}
[0m04:00:05.692112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D21C100>]}
[0m04:00:05.692112 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:05.699959 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:05.745559 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:05.745559 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:05.749570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D4DD4C0>]}
[0m04:00:05.757596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D41D280>]}
[0m04:00:05.757596 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:05.757596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D41D220>]}
[0m04:00:05.757596 [info ] [MainThread]: 
[0m04:00:05.757596 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:05.761466 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:05.761466 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:05.761466 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:05.761466 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:06.507786 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:07.184492 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:07.184492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:07.184492 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m04:00:07.184492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:07.953660 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:00:07.953660 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:08.564467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D5205B0>]}
[0m04:00:08.564467 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:08.564467 [info ] [MainThread]: 
[0m04:00:08.580445 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.580445 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.580445 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m04:00:08.580445 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:08.580445 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m04:00:08.580445 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.580445 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:08.596614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:08.596614 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.596614 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:08.596614 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:08.580445 => 04:00:08.596614
[0m04:00:08.612456 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:08.596614 => 04:00:08.612456
[0m04:00:08.612456 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.612456 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.628477 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:08.628477 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:08.628477 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:08.644412 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m04:00:08.660498 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:08.660498 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:09.471243 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6325777-c7c7-444a-8fb7-a61308649dd3&page=queryresults
[0m04:00:09.487265 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:274dede2-3f64-4f69-9acc-39894b719d88&page=queryresults
[0m04:00:09.905852 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:08.612456 => 04:00:09.905852
[0m04:00:09.905852 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D562610>]}
[0m04:00:09.905852 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m04:00:09.905852 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:09.905852 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:09.905852 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m04:00:09.905852 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:09.905852 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:09.922022 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:09.922022 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:09.905852 => 04:00:09.922022
[0m04:00:09.922022 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:09.922022 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:09.922022 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:08.612456 => 04:00:09.922022
[0m04:00:09.922022 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:09.922022 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D566940>]}
[0m04:00:09.938183 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m04:00:09.938183 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:09.938183 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:09.959032 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:09.959032 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m04:00:09.959032 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m04:00:09.959032 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m04:00:09.959032 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:09.959032 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 04:00:09.959032 => 04:00:09.959032
[0m04:00:09.959032 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m04:00:09.959032 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:09.959032 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:09.959032 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m04:00:10.678704 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:06644c60-7c3c-406c-b4ac-d919582c556e&page=queryresults
[0m04:00:10.678704 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7774cf6-d50f-472e-b2a6-67560e731d03&page=queryresults
[0m04:00:11.082024 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:09.922022 => 04:00:11.082024
[0m04:00:11.082024 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E658670>]}
[0m04:00:11.082024 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 04:00:09.959032 => 04:00:11.082024
[0m04:00:11.082024 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m04:00:11.082024 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E6259A0>]}
[0m04:00:11.082024 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:11.082024 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m04:00:11.082024 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m04:00:11.082024 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:11.082024 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:11.082024 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m04:00:11.082024 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m04:00:11.082024 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m04:00:11.098143 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:11.082024 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m04:00:11.098143 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m04:00:11.098143 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:11.106435 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 04:00:11.082024 => 04:00:11.106435
[0m04:00:11.107566 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m04:00:11.109562 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:11.116804 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:11.116804 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:11.118741 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m04:00:11.140845 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 04:00:11.098143 => 04:00:11.140845
[0m04:00:11.140845 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:11.140845 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:11.156596 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:11.158394 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m04:00:11.830214 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85dd4af8-4901-4f03-b861-e15b7d6a32cb&page=queryresults
[0m04:00:11.868560 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3861525d-212a-4807-9c6c-47bf97bc3f2d&page=queryresults
[0m04:00:12.220453 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 04:00:11.140845 => 04:00:12.220453
[0m04:00:12.220453 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E6259A0>]}
[0m04:00:12.220453 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m04:00:12.232177 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:12.232177 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:12.232177 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m04:00:12.232177 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m04:00:12.232177 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:12.232177 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:12.232177 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 04:00:11.107566 => 04:00:12.232177
[0m04:00:12.247945 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D55FE50>]}
[0m04:00:12.247945 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m04:00:12.247945 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m04:00:12.247945 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:12.232177 => 04:00:12.247945
[0m04:00:12.247945 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:12.247945 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:12.247945 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:12.247945 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:13.043389 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac3d81eb-3ca0-470b-991a-2113a98a8c0c&page=queryresults
[0m04:00:13.420827 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:12.247945 => 04:00:13.420827
[0m04:00:13.420827 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E580FA0>]}
[0m04:00:13.420827 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m04:00:13.420827 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:13.420827 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:13.436918 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m04:00:13.436918 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.dm_produto)
[0m04:00:13.436918 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:13.436918 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:13.436918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:13.436918 => 04:00:13.436918
[0m04:00:13.436918 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:13.452948 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:14.077666 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:14.077666 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:14.658460 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8b958b04-5903-4b46-85a9-3ee3eec64788&page=queryresults
[0m04:00:17.536566 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:13.436918 => 04:00:17.536566
[0m04:00:17.537770 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E649730>]}
[0m04:00:17.537770 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.10s]
[0m04:00:17.537770 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:17.537770 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:17.537770 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m04:00:17.541212 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m04:00:17.541212 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:17.547249 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:17.553871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:17.543225 => 04:00:17.553154
[0m04:00:17.553871 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:17.553871 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:18.235011 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:18.238035 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m04:00:18.862802 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c71d413-c7d1-47bb-875a-0623d303a619&page=queryresults
[0m04:00:21.102150 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:17.553871 => 04:00:21.102150
[0m04:00:21.118243 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E66E6D0>]}
[0m04:00:21.120254 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.57s]
[0m04:00:21.120254 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:21.124018 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:21.126031 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m04:00:21.126031 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m04:00:21.126031 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:21.129939 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:21.138059 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:21.126031 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m04:00:21.139956 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m04:00:21.141062 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m04:00:21.149533 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:21.151536 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:21.131057 => 04:00:21.150540
[0m04:00:21.151536 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:21.151536 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:21.151536 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 04:00:21.141431 => 04:00:21.151536
[0m04:00:21.151536 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m04:00:21.162325 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:21.827603 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:21.827603 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:21.858930 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:21.860944 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:22.449953 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c7ba3e4-63f4-4ebe-b29f-8768fa87a0c5&page=queryresults
[0m04:00:22.449953 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f981137-0955-4b59-aade-9ecdbbf72e8d&page=queryresults
[0m04:00:24.366719 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:21.151536 => 04:00:24.366719
[0m04:00:24.366719 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E67C7F0>]}
[0m04:00:24.366719 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.24s]
[0m04:00:24.366719 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:25.539901 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 04:00:21.151536 => 04:00:25.539901
[0m04:00:25.539901 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71f6f18e-e346-43b0-ade5-9bbb68905e30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8E613E50>]}
[0m04:00:25.539901 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.40s]
[0m04:00:25.539901 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m04:00:25.546528 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:25.546528 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:25.546528 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:25.546528 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:00:25.548540 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:25.548540 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m04:00:25.548540 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m04:00:25.548540 [info ] [MainThread]: 
[0m04:00:25.550552 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 19.79 seconds (19.79s).
[0m04:00:25.552565 [debug] [MainThread]: Command end result
[0m04:00:25.566413 [info ] [MainThread]: 
[0m04:00:25.566413 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:25.570449 [info ] [MainThread]: 
[0m04:00:25.570449 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m04:00:25.572462 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:25.572462 after 20.87 seconds
[0m04:00:25.572462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB89BC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D4EAA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8D1B6820>]}
[0m04:00:25.572462 [debug] [MainThread]: Flushing usage events
[0m05:00:05.579709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563BE93430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563AE089A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563AE08D30>]}


============================== 05:00:05.585810 | 9f545e3f-8e5d-42dc-a2c9-8055ebd8da74 ==============================
[0m05:00:05.585810 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:05.585810 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m05:00:06.529662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563AE0EB80>]}
[0m05:00:06.628187 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F4250D0>]}
[0m05:00:06.628187 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:06.628187 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:06.739685 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:06.739685 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:06.739685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F7ADC40>]}
[0m05:00:06.760668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F6F08E0>]}
[0m05:00:06.766835 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:06.766835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F6F08B0>]}
[0m05:00:06.766835 [info ] [MainThread]: 
[0m05:00:06.766835 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:06.771569 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.771569 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:06.771569 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.771569 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.642919 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:08.283847 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:08.291541 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:08.291541 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:08.291541 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:08.924652 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:08.924652 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:09.555427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F53B820>]}
[0m05:00:09.555427 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:09.555427 [info ] [MainThread]: 
[0m05:00:09.562278 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.562278 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.562278 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m05:00:09.562278 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:09.562278 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.562278 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m05:00:09.578312 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:09.578312 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.578312 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.594137 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.594137 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:09.578312 => 05:00:09.594137
[0m05:00:09.594137 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.594137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:09.562278 => 05:00:09.594137
[0m05:00:09.609877 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.641814 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.641814 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.641814 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:09.641814 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:09.641814 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:09.657943 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m05:00:10.533931 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c989b852-72c5-4090-8356-32d7820191cc&page=queryresults
[0m05:00:10.549954 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38768886-f9f2-4491-9fa3-fc2eb103d45c&page=queryresults
[0m05:00:11.001769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:09.609877 => 05:00:11.001769
[0m05:00:11.001769 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F7ADFA0>]}
[0m05:00:11.001769 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m05:00:11.015844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:11.015844 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.015844 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m05:00:11.015844 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:11.017720 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.017720 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:11.017720 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:11.017720 => 05:00:11.017720
[0m05:00:11.017720 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.017720 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:11.017720 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:11.017720 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:11.275155 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:09.594137 => 05:00:11.275155
[0m05:00:11.275155 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F837E50>]}
[0m05:00:11.275155 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.70s]
[0m05:00:11.275155 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:11.275155 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.275155 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m05:00:11.291325 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m05:00:11.291325 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.291325 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.291325 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 05:00:11.291325 => 05:00:11.291325
[0m05:00:11.291325 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.291325 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.291325 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:11.291325 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m05:00:11.778402 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c594fa2-b224-4e8d-904f-5849924f5385&page=queryresults
[0m05:00:12.063818 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35abb738-8b20-4d95-8cef-fa8ad221811f&page=queryresults
[0m05:00:12.179304 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:11.017720 => 05:00:12.179304
[0m05:00:12.179304 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025640899160>]}
[0m05:00:12.179304 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m05:00:12.179304 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:12.179304 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m05:00:12.179304 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m05:00:12.179304 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m05:00:12.179304 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m05:00:12.179304 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:12.195203 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 05:00:12.179304 => 05:00:12.195203
[0m05:00:12.195203 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m05:00:12.195203 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:12.211379 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:12.211379 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m05:00:12.469281 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 05:00:11.291325 => 05:00:12.469281
[0m05:00:12.469281 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F843670>]}
[0m05:00:12.469281 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m05:00:12.469281 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:12.469281 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:12.469281 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m05:00:12.469281 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m05:00:12.469281 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:12.485533 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:12.485533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 05:00:12.469281 => 05:00:12.485533
[0m05:00:12.485533 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:12.485533 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:12.485533 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:12.485533 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m05:00:13.125552 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2e4721a9-81f2-467a-8578-6420ecc15037&page=queryresults
[0m05:00:13.388002 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d8cb4c4-6477-4e8b-88d9-12379fb78c04&page=queryresults
[0m05:00:13.488842 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 05:00:12.195203 => 05:00:13.488842
[0m05:00:13.490855 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000256408991C0>]}
[0m05:00:13.490855 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m05:00:13.490855 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m05:00:13.490855 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:13.490855 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m05:00:13.490855 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m05:00:13.490855 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:13.501760 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:13.503770 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:13.496774 => 05:00:13.503770
[0m05:00:13.503770 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:13.507796 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:13.509809 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:13.512835 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:13.829915 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 05:00:12.485533 => 05:00:13.827902
[0m05:00:13.829915 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F80FCD0>]}
[0m05:00:13.831927 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m05:00:13.831927 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:14.234267 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f107afd-505e-45dc-9d3b-234c0909a133&page=queryresults
[0m05:00:14.621214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:13.503770 => 05:00:14.621214
[0m05:00:14.621214 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000256408271F0>]}
[0m05:00:14.623230 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m05:00:14.625243 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:14.626756 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:14.626756 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m05:00:14.626756 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m05:00:14.630935 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:14.636969 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:14.636969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:14.630935 => 05:00:14.636969
[0m05:00:14.636969 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:14.653184 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:15.359078 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:15.361090 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:15.982892 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c59545ae-5a13-4743-b2f1-79e65c4698f6&page=queryresults
[0m05:00:18.810259 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:14.640543 => 05:00:18.810259
[0m05:00:18.810259 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002564088A250>]}
[0m05:00:18.810259 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.18s]
[0m05:00:18.810259 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:18.816247 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:18.816247 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m05:00:18.818261 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m05:00:18.818261 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:18.824294 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:18.826047 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:18.818261 => 05:00:18.826047
[0m05:00:18.826047 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:18.830571 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:19.451757 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:19.451757 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m05:00:20.162570 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c89dd84c-141e-4ba1-8684-517aeea7ed1e&page=queryresults
[0m05:00:22.752826 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:18.826047 => 05:00:22.752826
[0m05:00:22.752826 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002564092D310>]}
[0m05:00:22.754839 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.94s]
[0m05:00:22.754839 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:22.754839 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:22.754839 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m05:00:22.754839 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m05:00:22.754839 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:22.754839 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:22.754839 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:22.754839 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m05:00:22.754839 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m05:00:22.754839 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m05:00:22.774977 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:22.774977 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:22.754839 => 05:00:22.774977
[0m05:00:22.774977 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:22.774977 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:22.818700 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 05:00:22.770951 => 05:00:22.818700
[0m05:00:22.818700 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m05:00:22.824000 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:23.424411 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:23.426424 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:23.458287 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:23.460300 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:24.133513 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e4e21ba1-a505-43c8-be81-05e0a61483a0&page=queryresults
[0m05:00:24.246833 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a904cd0-44ee-4f91-9943-6863aad0513f&page=queryresults
[0m05:00:26.743296 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:22.774977 => 05:00:26.743296
[0m05:00:26.743296 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002564088C5B0>]}
[0m05:00:26.743296 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.99s]
[0m05:00:26.743296 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:27.200873 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 05:00:22.818700 => 05:00:27.200873
[0m05:00:27.200873 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f545e3f-8e5d-42dc-a2c9-8055ebd8da74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F84F9A0>]}
[0m05:00:27.204006 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.45s]
[0m05:00:27.204006 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m05:00:27.204006 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m05:00:27.204006 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m05:00:27.204006 [info ] [MainThread]: 
[0m05:00:27.204006 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.44 seconds (20.44s).
[0m05:00:27.215111 [debug] [MainThread]: Command end result
[0m05:00:27.227404 [info ] [MainThread]: 
[0m05:00:27.227404 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:27.227404 [info ] [MainThread]: 
[0m05:00:27.227404 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m05:00:27.227404 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:27.227404 after 21.74 seconds
[0m05:00:27.234911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563BE93430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000256409213A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002563F590910>]}
[0m05:00:27.234911 [debug] [MainThread]: Flushing usage events
[0m06:00:04.931413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173CD9833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173CC8F09A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173CC8F0D30>]}


============================== 06:00:04.931413 | f3aa21c5-ffe0-4cf7-b533-9b0b8a219558 ==============================
[0m06:00:04.931413 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:04.944844 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m06:00:05.788456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173CC8E9B80>]}
[0m06:00:05.835994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D0EE2130>]}
[0m06:00:05.835994 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:05.851905 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:05.899926 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:05.899926 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:05.899926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D129D6A0>]}
[0m06:00:05.916150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D11DD3A0>]}
[0m06:00:05.916150 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:05.916150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D11DD310>]}
[0m06:00:05.916150 [info ] [MainThread]: 
[0m06:00:05.916150 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:05.916150 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:05.916150 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:05.932128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:05.948227 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.738732 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:07.517719 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m06:00:07.533521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.533521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:07.533521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.191517 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m06:00:08.191517 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.802477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D12D3760>]}
[0m06:00:08.818522 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:08.818522 [info ] [MainThread]: 
[0m06:00:08.818522 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.818522 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.818522 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m06:00:08.818522 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m06:00:08.834423 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:08.834423 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:08.834423 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.834423 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.850606 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:08.850606 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:08.850606 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:08.850606 => 06:00:08.850606
[0m06:00:08.850606 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:08.834423 => 06:00:08.850606
[0m06:00:08.850606 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.866512 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.895598 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:08.898653 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:08.898653 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:08.898653 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:08.898653 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m06:00:08.930687 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:09.850199 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7abcdb80-9c66-44e5-a9dc-11dc47fc9686&page=queryresults
[0m06:00:09.850199 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6fb6655c-41a1-48b8-8739-ef87dc9c5db9&page=queryresults
[0m06:00:10.284392 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:08.866512 => 06:00:10.284392
[0m06:00:10.284392 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:08.876172 => 06:00:10.284392
[0m06:00:10.294053 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D131CDF0>]}
[0m06:00:10.294053 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D131F460>]}
[0m06:00:10.294053 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m06:00:10.294053 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:10.294053 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m06:00:10.294053 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.294053 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:10.294053 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:10.294053 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m06:00:10.294053 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:10.294053 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.294053 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m06:00:10.294053 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.294053 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m06:00:10.294053 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m06:00:10.294053 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:10.294053 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:10.294053 => 06:00:10.294053
[0m06:00:10.294053 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.294053 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.294053 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 06:00:10.294053 => 06:00:10.294053
[0m06:00:10.294053 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m06:00:10.310137 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:10.310137 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:10.310137 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:10.326395 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.326395 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m06:00:11.003546 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a7c594b-c38c-42df-a50b-d6cb1d345397&page=queryresults
[0m06:00:11.079640 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f12f587-96f3-4074-a7fe-c87b22d20ab6&page=queryresults
[0m06:00:11.402938 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:10.294053 => 06:00:11.402938
[0m06:00:11.402938 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D23DFEB0>]}
[0m06:00:11.402938 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m06:00:11.402938 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.402938 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.402938 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m06:00:11.418785 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m06:00:11.418785 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.418785 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.418785 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 06:00:11.418785 => 06:00:11.418785
[0m06:00:11.418785 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.435009 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.435009 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:11.435009 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m06:00:11.514187 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 06:00:10.294053 => 06:00:11.514187
[0m06:00:11.514187 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D133CCA0>]}
[0m06:00:11.514187 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m06:00:11.514187 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.514187 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:11.514187 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m06:00:11.514187 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m06:00:11.514187 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:11.529960 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:11.529960 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 06:00:11.514187 => 06:00:11.529960
[0m06:00:11.529960 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:11.529960 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:11.529960 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:11.529960 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m06:00:12.158574 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2377e12-7239-414a-8cc7-e7fb44b0c8d4&page=queryresults
[0m06:00:12.223093 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e81b97a-cb2e-42b3-86fa-602b6f354ac6&page=queryresults
[0m06:00:12.527380 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 06:00:11.418785 => 06:00:12.527380
[0m06:00:12.543244 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D233E4F0>]}
[0m06:00:12.543244 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m06:00:12.543244 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.543244 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:12.543244 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m06:00:12.543244 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m06:00:12.543244 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:12.543244 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:12.543244 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:12.543244 => 06:00:12.543244
[0m06:00:12.543244 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:12.559435 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:12.559435 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:12.559435 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:12.575637 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 06:00:11.529960 => 06:00:12.575637
[0m06:00:12.575637 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D132C7F0>]}
[0m06:00:12.575637 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m06:00:12.575637 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:13.475862 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25802cd5-b93d-4301-91b3-c75d4c9a50b8&page=queryresults
[0m06:00:13.847952 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:12.559435 => 06:00:13.847952
[0m06:00:13.847952 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D2436D00>]}
[0m06:00:13.847952 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m06:00:13.847952 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:13.847952 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:13.847952 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m06:00:13.864149 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m06:00:13.864149 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:13.864149 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:13.864149 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:13.864149 => 06:00:13.864149
[0m06:00:13.864149 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:13.879911 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:14.489803 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:14.489803 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:15.151082 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c433c4b4-417f-422b-a884-b6674d37c8a4&page=queryresults
[0m06:00:18.257937 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:13.864149 => 06:00:18.257937
[0m06:00:18.257937 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D131CDF0>]}
[0m06:00:18.259950 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.39s]
[0m06:00:18.259950 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:18.262665 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:18.262665 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m06:00:18.262665 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m06:00:18.262665 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:18.262665 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:18.262665 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:18.262665 => 06:00:18.262665
[0m06:00:18.262665 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:18.278611 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:19.084877 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:19.088197 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m06:00:19.757209 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3782b40e-2649-4eb1-b6e4-9a5e5207e41b&page=queryresults
[0m06:00:22.031454 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:18.262665 => 06:00:22.031454
[0m06:00:22.033472 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D240A6A0>]}
[0m06:00:22.035487 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.77s]
[0m06:00:22.037087 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:22.038085 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:22.039086 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m06:00:22.040183 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m06:00:22.042086 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:22.043090 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:22.048731 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:22.050730 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:22.043090 => 06:00:22.050730
[0m06:00:22.051503 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:22.055831 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:22.041086 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m06:00:22.056732 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m06:00:22.057983 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m06:00:22.064515 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:22.066542 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 06:00:22.057983 => 06:00:22.065542
[0m06:00:22.067880 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m06:00:22.086339 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:22.759591 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:22.761605 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:22.772467 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:22.772467 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:23.386389 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef662693-0ccf-4d58-a6ae-3c6415da0c33&page=queryresults
[0m06:00:23.390414 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c912247d-4b14-418d-984d-17a8338f8c66&page=queryresults
[0m06:00:25.391707 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:22.051503 => 06:00:25.391707
[0m06:00:25.391707 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D23D2F70>]}
[0m06:00:25.391707 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.35s]
[0m06:00:25.391707 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:26.196836 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 06:00:22.068895 => 06:00:26.194817
[0m06:00:26.198850 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3aa21c5-ffe0-4cf7-b533-9b0b8a219558', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D23DB7C0>]}
[0m06:00:26.200868 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 4.14s]
[0m06:00:26.200868 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m06:00:26.204964 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:26.207896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:26.207896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:26.207896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:00:26.207896 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m06:00:26.209910 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m06:00:26.209910 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m06:00:26.209910 [info ] [MainThread]: 
[0m06:00:26.209910 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.29 seconds (20.29s).
[0m06:00:26.209910 [debug] [MainThread]: Command end result
[0m06:00:26.221173 [info ] [MainThread]: 
[0m06:00:26.221173 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:26.221173 [info ] [MainThread]: 
[0m06:00:26.221173 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m06:00:26.221173 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:26.221173 after 21.36 seconds
[0m06:00:26.221173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173CD9833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D24425E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000173D0F7DF10>]}
[0m06:00:26.235470 [debug] [MainThread]: Flushing usage events
[0m07:00:05.131151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7AEA2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A79E186D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A79E18E20>]}


============================== 07:00:05.148445 | 457849d0-3779-4664-b9fb-b79954b31256 ==============================
[0m07:00:05.148445 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:05.148445 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m07:00:05.975892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A79E19C10>]}
[0m07:00:06.031254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E3FD070>]}
[0m07:00:06.033260 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:06.040601 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:06.084709 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:06.084709 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:06.084709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E7BD520>]}
[0m07:00:06.102533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E6FD310>]}
[0m07:00:06.102533 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:06.102533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E6FD250>]}
[0m07:00:06.102533 [info ] [MainThread]: 
[0m07:00:06.102533 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:06.102533 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.102533 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.132202 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.132202 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.919689 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:07.688212 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:07.688212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.688212 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:07.688212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:08.538675 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:08.540686 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:09.196209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E7BD880>]}
[0m07:00:09.196209 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:09.196209 [info ] [MainThread]: 
[0m07:00:09.196209 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.196209 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.212272 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m07:00:09.212272 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:09.212272 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m07:00:09.212272 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.212272 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:09.227485 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.227485 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.227485 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.227485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:09.212272 => 07:00:09.227485
[0m07:00:09.227485 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.243242 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:09.227485 => 07:00:09.243242
[0m07:00:09.259033 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.294431 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.294431 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.294431 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:09.294431 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:09.294431 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m07:00:09.294431 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:10.173064 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:156046e2-5a10-455e-8b5a-6a63fdee3c08&page=queryresults
[0m07:00:10.223893 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e030fa7-e351-4ded-9a3d-1ec1fc316056&page=queryresults
[0m07:00:10.605735 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:09.243242 => 07:00:10.605735
[0m07:00:10.605735 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E841CA0>]}
[0m07:00:10.605735 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m07:00:10.605735 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:10.605735 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.605735 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m07:00:10.605735 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:10.605735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.605735 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.621722 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:10.605735 => 07:00:10.621722
[0m07:00:10.621722 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.621722 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.621722 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:10.621722 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:10.685961 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:09.274650 => 07:00:10.685961
[0m07:00:10.685961 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E840F10>]}
[0m07:00:10.685961 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m07:00:10.685961 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:10.685961 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.685961 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m07:00:10.685961 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m07:00:10.685961 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.702076 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:10.702076 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 07:00:10.685961 => 07:00:10.702076
[0m07:00:10.702076 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.702076 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:10.702076 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:10.702076 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m07:00:11.395160 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb1cc43d-d211-4080-af73-bb3b772d764f&page=queryresults
[0m07:00:11.443529 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d190c8b5-57fd-4fbc-a885-07add8c17ef5&page=queryresults
[0m07:00:11.839794 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:10.621722 => 07:00:11.839794
[0m07:00:11.841806 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F8D5460>]}
[0m07:00:11.841806 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m07:00:11.843818 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:11.843818 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.845574 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m07:00:11.845574 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m07:00:11.845574 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.852364 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.855296 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 07:00:11.845574 => 07:00:11.854376
[0m07:00:11.855803 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.859825 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.861576 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:11.861576 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m07:00:11.913229 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 07:00:10.702076 => 07:00:11.913229
[0m07:00:11.913229 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E7BDF10>]}
[0m07:00:11.913229 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m07:00:11.913229 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:11.913229 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.913229 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m07:00:11.924927 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m07:00:11.924927 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.924927 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:11.924927 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 07:00:11.924927 => 07:00:11.924927
[0m07:00:11.924927 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.924927 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:11.924927 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:11.940881 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m07:00:12.632230 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:afa4ba49-cf7b-43eb-a935-f719465285db&page=queryresults
[0m07:00:12.744232 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a6fa836d-6cc5-4966-b4eb-d3df0441d031&page=queryresults
[0m07:00:13.048319 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 07:00:11.855803 => 07:00:13.048319
[0m07:00:13.050312 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F8FE400>]}
[0m07:00:13.052312 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:13.053721 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m07:00:13.054734 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:13.055734 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m07:00:13.056734 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m07:00:13.058038 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:13.072454 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:13.075460 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:13.059032 => 07:00:13.074459
[0m07:00:13.077461 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:13.104168 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:13.106208 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:13.109968 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:13.161918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 07:00:11.924927 => 07:00:13.161918
[0m07:00:13.163928 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F91B8E0>]}
[0m07:00:13.163928 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m07:00:13.166027 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:13.981428 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:932b8383-40a1-44ec-a444-8b51fb383030&page=queryresults
[0m07:00:14.375736 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:13.078464 => 07:00:14.375736
[0m07:00:14.382321 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F977070>]}
[0m07:00:14.382321 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m07:00:14.382321 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:14.382321 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:14.382321 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m07:00:14.387840 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m07:00:14.387840 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:14.391713 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:14.391713 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:14.387840 => 07:00:14.391713
[0m07:00:14.391713 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:14.414603 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:15.097490 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:15.097490 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:15.794023 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e8be926c-1086-44e3-9f76-4276d29586a6&page=queryresults
[0m07:00:18.351809 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:14.399162 => 07:00:18.349804
[0m07:00:18.351809 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F8DD370>]}
[0m07:00:18.353813 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.97s]
[0m07:00:18.353813 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:18.355815 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:18.355815 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m07:00:18.355815 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m07:00:18.358325 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:18.363865 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:18.367382 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:18.358325 => 07:00:18.365878
[0m07:00:18.367382 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:18.367382 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:19.017411 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:19.017411 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m07:00:19.715228 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0e2226d3-efe4-440c-8b80-d2463c635368&page=queryresults
[0m07:00:23.114287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:18.367382 => 07:00:23.113167
[0m07:00:23.115278 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F8DDEB0>]}
[0m07:00:23.116181 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.76s]
[0m07:00:23.117458 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:23.120162 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:23.121143 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m07:00:23.121143 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m07:00:23.121143 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:23.121143 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:23.128049 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:23.121143 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m07:00:23.128049 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m07:00:23.128049 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m07:00:23.137190 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:23.153295 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:23.121143 => 07:00:23.137190
[0m07:00:23.153295 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:23.157323 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:23.201169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 07:00:23.133032 => 07:00:23.201169
[0m07:00:23.201169 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m07:00:23.201169 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:23.829943 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:23.837944 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:23.843139 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:23.843139 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:24.516981 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c8ad5f6e-9991-4a8d-8e3e-ead4877df963&page=queryresults
[0m07:00:24.537597 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9888ae3d-559e-4491-9f6b-384e1ef41d35&page=queryresults
[0m07:00:28.221760 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:23.153295 => 07:00:28.221760
[0m07:00:28.221760 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F996A30>]}
[0m07:00:28.221760 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 5.10s]
[0m07:00:28.237437 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:28.241468 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 07:00:23.201169 => 07:00:28.241468
[0m07:00:28.241468 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '457849d0-3779-4664-b9fb-b79954b31256', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7FA0DD90>]}
[0m07:00:28.243481 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.11s]
[0m07:00:28.243481 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m07:00:28.245494 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:28.245494 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:28.245494 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:28.245494 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m07:00:28.248923 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:28.248923 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m07:00:28.248923 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m07:00:28.248923 [info ] [MainThread]: 
[0m07:00:28.248923 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 22.15 seconds (22.15s).
[0m07:00:28.253309 [debug] [MainThread]: Command end result
[0m07:00:28.253309 [info ] [MainThread]: 
[0m07:00:28.253309 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:28.269273 [info ] [MainThread]: 
[0m07:00:28.269273 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m07:00:28.269273 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:28.269273 after 23.18 seconds
[0m07:00:28.269273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7AEA2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7F91D3A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A7E56C5B0>]}
[0m07:00:28.269273 [debug] [MainThread]: Flushing usage events
[0m08:00:05.968933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000168931D33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000168921599A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016892159D30>]}


============================== 08:00:05.968933 | fec85062-13ce-4ebf-b885-903baa7f0e19 ==============================
[0m08:00:05.968933 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:05.968933 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:06.907792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016892149B80>]}
[0m08:00:07.019893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016895B190D0>]}
[0m08:00:07.028840 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:07.036010 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:07.147443 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:07.147443 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:07.147443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896AECE80>]}
[0m08:00:07.163387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001689696B970>]}
[0m08:00:07.163387 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:07.163387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001689696BBB0>]}
[0m08:00:07.175131 [info ] [MainThread]: 
[0m08:00:07.175131 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:07.177661 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:07.177661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.179405 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:07.211338 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.061121 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.833534 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:08.835605 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m08:00:08.835605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.835605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:09.487623 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:09.487623 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:10.103777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001689696BD30>]}
[0m08:00:10.103777 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:10.103777 [info ] [MainThread]: 
[0m08:00:10.115781 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.115781 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.115781 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m08:00:10.115781 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:10.115781 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m08:00:10.115781 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.115781 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:10.115781 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.115781 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.134120 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.136134 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:10.115781 => 08:00:10.136134
[0m08:00:10.136134 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.147751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:10.131681 => 08:00:10.147751
[0m08:00:10.147751 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.171763 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.171763 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.171763 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:10.171763 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:10.171763 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:10.195268 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m08:00:10.953993 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a39fab8b-39b6-4c69-b995-b6e8a493e728&page=queryresults
[0m08:00:10.969869 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:91193e99-9cdd-4f25-9698-3603beb7d99f&page=queryresults
[0m08:00:11.372503 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:10.136134 => 08:00:11.372503
[0m08:00:11.372503 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897BD8790>]}
[0m08:00:11.372503 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m08:00:11.372503 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:11.372503 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.372503 [info ] [Thread-1  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m08:00:11.372503 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:11.372503 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.372503 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.372503 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:11.372503 => 08:00:11.372503
[0m08:00:11.372503 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.388296 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.388296 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:10.147751 => 08:00:11.388296
[0m08:00:11.388296 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896B718E0>]}
[0m08:00:11.388296 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:11.388296 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m08:00:11.404176 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:11.404176 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:11.404176 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:11.404176 [info ] [Thread-2  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m08:00:11.436276 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m08:00:11.436276 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m08:00:11.436276 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:11.436276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 08:00:11.436276 => 08:00:11.436276
[0m08:00:11.436276 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m08:00:11.436276 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:11.436276 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:11.436276 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m08:00:12.154907 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19c72ae7-e5dc-4328-a3fb-772405993b71&page=queryresults
[0m08:00:12.206971 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b5838b88-d9d1-4853-9b49-52720fe84e1d&page=queryresults
[0m08:00:12.558515 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:11.388296 => 08:00:12.558515
[0m08:00:12.558515 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896B3E400>]}
[0m08:00:12.558515 [info ] [Thread-1  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m08:00:12.558515 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.558515 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.573700 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m08:00:12.573700 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m08:00:12.573700 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.573700 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.573700 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 08:00:12.573700 => 08:00:12.573700
[0m08:00:12.573700 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.589608 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.589608 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.589608 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m08:00:12.637296 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 08:00:11.436276 => 08:00:12.637296
[0m08:00:12.637296 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897C9F5E0>]}
[0m08:00:12.637296 [info ] [Thread-2  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m08:00:12.637296 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.637296 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:12.637296 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m08:00:12.637296 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m08:00:12.637296 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:12.637296 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:12.653120 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 08:00:12.637296 => 08:00:12.653120
[0m08:00:12.653120 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:12.658471 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:12.658471 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.658471 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m08:00:13.323755 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4077eb28-f819-4213-bd2d-512a603bdb34&page=queryresults
[0m08:00:13.388575 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ea55fd5-9559-4477-9059-7b082016fcbc&page=queryresults
[0m08:00:13.762005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 08:00:12.573700 => 08:00:13.762005
[0m08:00:13.762005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896B3E790>]}
[0m08:00:13.762005 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m08:00:13.762005 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m08:00:13.762005 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:13.772878 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m08:00:13.772878 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m08:00:13.774891 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:13.778916 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:13.780928 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:13.774891 => 08:00:13.780928
[0m08:00:13.782936 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:13.786339 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:13.789076 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:13.789076 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:13.836758 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 08:00:12.653120 => 08:00:13.836758
[0m08:00:13.836758 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897BB5550>]}
[0m08:00:13.836758 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m08:00:13.836758 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.675598 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f75962f1-a286-4e87-a18e-e4496ee942b4&page=queryresults
[0m08:00:15.056789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:13.782936 => 08:00:15.056789
[0m08:00:15.056789 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896B809A0>]}
[0m08:00:15.056789 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m08:00:15.056789 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:15.056789 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:15.066172 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m08:00:15.066172 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m08:00:15.066172 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:15.071704 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:15.073776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:15.068183 => 08:00:15.073776
[0m08:00:15.075788 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:15.089818 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:15.778003 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:15.794071 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:16.456363 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a381293d-937a-4317-b18e-2fee44f0c493&page=queryresults
[0m08:00:19.280937 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:15.076298 => 08:00:19.280937
[0m08:00:19.282951 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016896B809D0>]}
[0m08:00:19.282951 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.21s]
[0m08:00:19.286041 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:19.286041 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:19.287551 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m08:00:19.289565 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m08:00:19.289565 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:19.295601 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:19.301828 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:19.289565 => 08:00:19.300621
[0m08:00:19.301828 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:19.301828 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:20.013629 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:20.015643 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m08:00:20.695255 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9936dd88-0fe2-4b93-a190-d5c0a757bc68&page=queryresults
[0m08:00:22.875879 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:19.301828 => 08:00:22.875879
[0m08:00:22.877893 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897C40A00>]}
[0m08:00:22.877893 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 3.59s]
[0m08:00:22.879906 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:22.881663 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:22.881663 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m08:00:22.881663 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m08:00:22.881663 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m08:00:22.881663 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:22.881663 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m08:00:22.881663 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:22.881663 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m08:00:22.881663 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:22.897633 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:22.901051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 08:00:22.881663 => 08:00:22.901051
[0m08:00:22.901051 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m08:00:22.905880 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:22.906568 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:22.881663 => 08:00:22.906568
[0m08:00:22.906568 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:22.917160 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:23.542355 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:23.542355 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:23.599885 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:23.601899 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:24.224580 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e85d3301-081b-4eb2-9196-9c0aff1c907d&page=queryresults
[0m08:00:24.272402 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:abff7b6e-be3c-4e83-b8c0-fccde59a19b2&page=queryresults
[0m08:00:26.637759 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:22.906568 => 08:00:26.637759
[0m08:00:26.637759 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000168967CDF40>]}
[0m08:00:26.637759 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.76s]
[0m08:00:26.637759 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:27.950169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 08:00:22.901051 => 08:00:27.950169
[0m08:00:27.950169 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec85062-13ce-4ebf-b885-903baa7f0e19', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897CBB490>]}
[0m08:00:27.966278 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.07s]
[0m08:00:27.966278 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m08:00:27.968291 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m08:00:27.968291 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m08:00:27.968291 [info ] [MainThread]: 
[0m08:00:27.968291 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 20.79 seconds (20.79s).
[0m08:00:27.968291 [debug] [MainThread]: Command end result
[0m08:00:27.989325 [info ] [MainThread]: 
[0m08:00:27.989325 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:27.989325 [info ] [MainThread]: 
[0m08:00:27.989325 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m08:00:27.989325 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:27.989325 after 22.10 seconds
[0m08:00:27.996392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000168931D33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016897C5FD00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000168967C13A0>]}
[0m08:00:27.996392 [debug] [MainThread]: Flushing usage events
[0m09:00:05.844513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001912F779400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001912E703910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001912E703B80>]}


============================== 09:00:05.844513 | 4f27a3bd-2974-4201-bb7d-982242059309 ==============================
[0m09:00:05.844513 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:05.844513 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:00:06.886137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191318CAB20>]}
[0m09:00:06.946129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019132CD3BB0>]}
[0m09:00:06.946129 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:06.946129 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:07.056938 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:07.056938 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:07.072744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001913309D850>]}
[0m09:00:07.089953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019132FE54F0>]}
[0m09:00:07.089953 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:07.089953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019132FE54C0>]}
[0m09:00:07.089953 [info ] [MainThread]: 
[0m09:00:07.089953 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:07.089953 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.089953 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.089953 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.089953 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.888107 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:08.888488 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:08.888488 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:08.888488 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:00:08.888488 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:09.526644 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:00:09.542366 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:10.165988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191330D5FD0>]}
[0m09:00:10.165988 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:10.181698 [info ] [MainThread]: 
[0m09:00:10.181698 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.181698 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.181698 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:00:10.181698 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:00:10.197792 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:10.181698 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:10.199813 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.199813 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.213650 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.213650 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.213650 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:10.213650 => 09:00:10.213650
[0m09:00:10.227138 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.229777 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:10.199813 => 09:00:10.227138
[0m09:00:10.229777 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.261574 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.261574 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.261574 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:10.261574 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:10.261574 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:10.303027 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:00:11.276773 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:912563b8-ca8c-428a-8434-6d55b46b9f85&page=queryresults
[0m09:00:11.284827 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d2171cc-128a-4918-83dd-d3d7693500f2&page=queryresults
[0m09:00:11.744152 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:10.229777 => 09:00:11.744152
[0m09:00:11.746172 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:10.229777 => 09:00:11.746172
[0m09:00:11.746172 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019133127910>]}
[0m09:00:11.746172 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019133088640>]}
[0m09:00:11.748192 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.55s]
[0m09:00:11.748192 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:11.748192 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m09:00:11.748192 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.750210 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:11.750210 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:11.750210 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:00:11.750210 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:11.750210 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:00:11.750210 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.752230 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m09:00:11.755055 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:11.755055 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:00:11.755055 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:11.755055 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:00:11.755055 => 09:00:11.755055
[0m09:00:11.755055 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:00:11.755055 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:11.755055 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:11.752230 => 09:00:11.755055
[0m09:00:11.755055 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.755055 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:11.755055 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:11.770006 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:00:11.786112 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:11.786112 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:12.573810 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7414b60d-839b-4a24-8a48-ffbd33d8759f&page=queryresults
[0m09:00:12.599104 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e34c66d-ddfc-4478-b3df-398e16605224&page=queryresults
[0m09:00:12.984120 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:11.755055 => 09:00:12.984120
[0m09:00:12.984120 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019134170520>]}
[0m09:00:12.984120 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m09:00:12.984120 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.984120 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.984120 [info ] [Thread-2  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:00:12.984120 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:00:12.984120 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:00:13.000258 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:13.000258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:00:12.984120 => 09:00:13.000258
[0m09:00:13.000258 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:00:13.000258 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:13.000258 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:13.016440 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:00:13.049126 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:00:11.755055 => 09:00:13.049126
[0m09:00:13.049126 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019134110CD0>]}
[0m09:00:13.050154 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m09:00:13.050154 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:13.051254 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.051254 [info ] [Thread-1  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:00:13.052133 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:00:13.053134 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.056134 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:13.057135 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:00:13.053134 => 09:00:13.057135
[0m09:00:13.057135 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.060193 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:13.060193 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:13.061262 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:00:13.788875 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:040b51a8-4b56-4957-a03f-2763c31c8b1b&page=queryresults
[0m09:00:13.804748 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:427e198b-5921-47f0-af62-c9ac4ade798b&page=queryresults
[0m09:00:14.188206 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:00:13.000258 => 09:00:14.188206
[0m09:00:14.188206 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191341D5E50>]}
[0m09:00:14.188206 [info ] [Thread-2  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m09:00:14.188206 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:00:14.198082 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:14.198082 [info ] [Thread-2  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m09:00:14.204139 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m09:00:14.204139 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:14.210927 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:14.210927 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:00:13.057135 => 09:00:14.210927
[0m09:00:14.210927 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001913415ACA0>]}
[0m09:00:14.210927 [info ] [Thread-1  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m09:00:14.220321 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:14.220321 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:14.204139 => 09:00:14.220321
[0m09:00:14.220321 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:14.220321 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:14.220321 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:14.236566 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:15.148716 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7f810a8d-c83b-4dde-962e-93d3e3d446c0&page=queryresults
[0m09:00:15.799424 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:14.220321 => 09:00:15.799424
[0m09:00:15.801436 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019132E311C0>]}
[0m09:00:15.803450 [info ] [Thread-2  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.60s]
[0m09:00:15.805465 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:15.807474 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:15.807474 [info ] [Thread-1  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m09:00:15.807474 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m09:00:15.807474 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:15.815212 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:15.815212 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:15.807474 => 09:00:15.815212
[0m09:00:15.815212 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:15.815212 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:16.469253 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:16.472827 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:17.164250 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:80743d4a-31f1-4e40-806b-d90aa5252862&page=queryresults
[0m09:00:27.659756 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:15.815212 => 09:00:27.659756
[0m09:00:27.661775 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019133133220>]}
[0m09:00:27.663797 [info ] [Thread-1  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 11.85s]
[0m09:00:27.663797 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:27.666712 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:27.666712 [info ] [Thread-2  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m09:00:27.666712 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m09:00:27.666712 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:27.666712 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:27.666712 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:27.666712 => 09:00:27.666712
[0m09:00:27.666712 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:27.682668 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:28.326284 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:28.326284 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m09:00:29.047575 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:95693473-77ab-4ea9-a792-ae4020d41f8c&page=queryresults
[0m09:00:36.931903 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:27.666712 => 09:00:36.931903
[0m09:00:36.931903 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191341D0F70>]}
[0m09:00:36.931903 [info ] [Thread-2  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 9.27s]
[0m09:00:36.931903 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:36.947985 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:36.947985 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:00:36.947985 [info ] [Thread-1  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:00:36.947985 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:36.947985 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:36.947985 [info ] [Thread-2  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m09:00:36.947985 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:36.964089 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m09:00:36.964089 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:00:36.964089 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:36.964089 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:36.947985 => 09:00:36.964089
[0m09:00:36.964089 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:36.964089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:36.964089 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:00:36.964089 => 09:00:36.964089
[0m09:00:36.964089 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:00:37.004210 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:37.618048 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:37.620068 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:37.620068 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:37.620068 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:38.315049 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5fde034f-500a-4eef-a121-36b4346d38d2&page=queryresults
[0m09:00:38.340554 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3bfb5739-701c-4b7f-8796-b0c207d263b2&page=queryresults
[0m09:00:42.321054 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:00:36.964089 => 09:00:42.321054
[0m09:00:42.334480 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191341F41F0>]}
[0m09:00:42.334480 [info ] [Thread-2  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.37s]
[0m09:00:42.334480 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:00:43.362971 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:36.964089 => 09:00:43.362971
[0m09:00:43.362971 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f27a3bd-2974-4201-bb7d-982242059309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001913417DFD0>]}
[0m09:00:43.362971 [info ] [Thread-1  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 6.41s]
[0m09:00:43.362971 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:43.362971 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:43.362971 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:43.362971 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:43.362971 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:00:43.362971 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:43.362971 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m09:00:43.379030 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m09:00:43.379030 [info ] [MainThread]: 
[0m09:00:43.379030 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 36.29 seconds (36.29s).
[0m09:00:43.379030 [debug] [MainThread]: Command end result
[0m09:00:43.395249 [info ] [MainThread]: 
[0m09:00:43.395249 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:43.411210 [info ] [MainThread]: 
[0m09:00:43.411210 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m09:00:43.411210 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:43.411210 after 37.65 seconds
[0m09:00:43.411210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001912F779400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001913311FC70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001913310B160>]}
[0m09:00:43.411210 [debug] [MainThread]: Flushing usage events
[0m10:00:04.881791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C46D1D73D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C46C1589D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C46C158B80>]}


============================== 10:00:04.902875 | 38496e0c-79ca-4887-89c6-1d40f8e5e38f ==============================
[0m10:00:04.902875 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:04.902875 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m10:00:05.717529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C46C14B130>]}
[0m10:00:05.797168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4707F4340>]}
[0m10:00:05.797168 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:05.797168 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:05.877214 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:05.877214 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:05.877214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B0D700>]}
[0m10:00:05.893384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470A50370>]}
[0m10:00:05.893384 [info ] [MainThread]: Found 11 models, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:05.893384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470A50460>]}
[0m10:00:05.893384 [info ] [MainThread]: 
[0m10:00:05.893384 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:05.893384 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.893384 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.893384 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:05.893384 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.729353 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.429099 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:07.429099 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:07.429099 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.429099 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.087240 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:00:08.087240 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:08.876579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B454F0>]}
[0m10:00:08.876579 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:08.876579 [info ] [MainThread]: 
[0m10:00:08.891144 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.891144 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.891144 [info ] [Thread-1  ]: 1 of 11 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:08.891144 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:08.891144 [info ] [Thread-2  ]: 2 of 11 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:08.891144 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.891144 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:08.907167 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.907167 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.907167 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.923016 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:08.891144 => 10:00:08.923016
[0m10:00:08.923016 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.923016 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:08.907167 => 10:00:08.923016
[0m10:00:08.939019 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.987291 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.993776 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.993776 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:08.993776 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:08.993776 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:08.993776 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:09.872783 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b9bc3ed5-0778-4efb-83c0-05cde2852253&page=queryresults
[0m10:00:09.892840 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98e57804-1b87-4ae3-8a77-9f1e52f6b3cf&page=queryresults
[0m10:00:10.349853 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:08.939019 => 10:00:10.349853
[0m10:00:10.349853 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4707EDE20>]}
[0m10:00:10.349853 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:08.923016 => 10:00:10.349853
[0m10:00:10.349853 [info ] [Thread-2  ]: 2 of 11 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m10:00:10.349853 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B7D640>]}
[0m10:00:10.349853 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:10.365513 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.365513 [info ] [Thread-1  ]: 1 of 11 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m10:00:10.365513 [info ] [Thread-2  ]: 3 of 11 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:10.365513 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:10.365513 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:10.365513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.365513 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.365513 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.365513 [info ] [Thread-1  ]: 4 of 11 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:00:10.381367 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:00:10.381367 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.381367 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:10.381367 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:10.365513 => 10:00:10.381367
[0m10:00:10.381367 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.381367 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.381367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:00:10.381367 => 10:00:10.381367
[0m10:00:10.381367 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.397409 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:10.397409 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:10.397409 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:10.397409 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:10.413475 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:00:11.136313 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb9e9648-f943-4cdd-9c28-50da80a07237&page=queryresults
[0m10:00:11.136313 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:64b6fb1d-e6a0-4fcb-b0c1-2cb8dc1edb7e&page=queryresults
[0m10:00:11.544932 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:00:10.396307 => 10:00:11.544932
[0m10:00:11.544932 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471BCD100>]}
[0m10:00:11.544932 [info ] [Thread-1  ]: 4 of 11 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m10:00:11.546938 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:11.546938 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.546938 [info ] [Thread-1  ]: 5 of 11 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:11.546938 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:11.546938 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.552974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.552974 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:11.546938 => 10:00:11.552974
[0m10:00:11.552974 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.568802 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.576790 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:10.381367 => 10:00:11.574776
[0m10:00:11.576790 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B91A60>]}
[0m10:00:11.578803 [info ] [Thread-2  ]: 3 of 11 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m10:00:11.578803 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.580815 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.580815 [info ] [Thread-2  ]: 6 of 11 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:11.580815 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:11.580815 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.588224 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:11.590237 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.590237 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:11.584193 => 10:00:11.590237
[0m10:00:11.590237 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.590237 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:11.600170 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:11.647456 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.650383 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:12.396284 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:77c91ec3-4804-4a09-bac6-f467fc9209e6&page=queryresults
[0m10:00:12.421272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7fc70cac-6ffe-4f2c-a6a0-ac4df8255c89&page=queryresults
[0m10:00:12.807205 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:11.556045 => 10:00:12.807205
[0m10:00:12.807205 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471B852B0>]}
[0m10:00:12.807205 [info ] [Thread-1  ]: 5 of 11 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m10:00:12.807205 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:12.807205 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:12.815946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:11.590237 => 10:00:12.815946
[0m10:00:12.817958 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471BE62B0>]}
[0m10:00:12.807205 [info ] [Thread-1  ]: 7 of 11 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m10:00:12.819970 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m10:00:12.819970 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:12.825001 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:12.817958 [info ] [Thread-2  ]: 6 of 11 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:00:12.825001 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:12.825001 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:12.819970 => 10:00:12.825001
[0m10:00:12.825001 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:12.831664 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:12.833676 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:12.837702 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:13.595360 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f964df6-4cfa-4b25-814d-4b545198582b&page=queryresults
[0m10:00:13.995108 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:12.829651 => 10:00:13.995108
[0m10:00:13.995108 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B45250>]}
[0m10:00:13.995108 [info ] [Thread-1  ]: 7 of 11 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m10:00:13.995108 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:13.995108 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:13.995108 [info ] [Thread-2  ]: 8 of 11 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m10:00:14.005510 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m10:00:14.005510 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:14.013063 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:14.019097 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:14.005510 => 10:00:14.019097
[0m10:00:14.019097 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:14.042749 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:14.789221 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:14.791231 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:15.503777 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:edb148d2-1118-4b01-8094-ff912939a91a&page=queryresults
[0m10:00:18.409410 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:14.019097 => 10:00:18.407396
[0m10:00:18.409410 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471C65EE0>]}
[0m10:00:18.411422 [info ] [Thread-2  ]: 8 of 11 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.40s]
[0m10:00:18.411422 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:18.411422 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:18.411422 [info ] [Thread-1  ]: 9 of 11 START sql table model dbt_dw_az.tb_produto ............................. [RUN]
[0m10:00:18.411422 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m10:00:18.411422 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:18.421553 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:18.425123 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:18.417529 => 10:00:18.423564
[0m10:00:18.425123 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:18.425123 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:19.100915 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:19.102929 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m10:00:19.794350 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:56eb4d81-baeb-43d8-ac49-b5481e8f5320&page=queryresults
[0m10:00:22.676244 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:18.425123 => 10:00:22.676244
[0m10:00:22.676244 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B9FCD0>]}
[0m10:00:22.676244 [info ] [Thread-1  ]: 9 of 11 OK created sql table model dbt_dw_az.tb_produto ........................ [[32mCREATE TABLE (346.0 rows, 1.7 MiB processed)[0m in 4.26s]
[0m10:00:22.676244 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:22.676244 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:22.685939 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:00:22.685939 [info ] [Thread-2  ]: 10 of 11 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:00:22.688758 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:22.688758 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:22.688758 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:22.685939 [info ] [Thread-1  ]: 11 of 11 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m10:00:22.688758 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_preco_produto)
[0m10:00:22.688758 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:00:22.688758 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:22.703805 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:00:22.688758 => 10:00:22.703805
[0m10:00:22.703805 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:00:22.703805 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:22.751269 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:22.688758 => 10:00:22.748042
[0m10:00:22.751269 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:22.751269 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:23.403820 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:23.405834 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:23.450648 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:23.450648 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:24.073867 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:265f6ed0-ffdc-4913-a3c4-dc0556e15ebe&page=queryresults
[0m10:00:24.135704 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db50a90c-a41c-489f-87db-0d4648996b37&page=queryresults
[0m10:00:26.108327 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:22.751269 => 10:00:26.108327
[0m10:00:26.124157 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471BEC0D0>]}
[0m10:00:26.124157 [info ] [Thread-2  ]: 10 of 11 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.42s]
[0m10:00:26.124157 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:28.180817 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:00:22.703805 => 10:00:28.180817
[0m10:00:28.182831 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38496e0c-79ca-4887-89c6-1d40f8e5e38f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C471C46C40>]}
[0m10:00:28.182831 [info ] [Thread-1  ]: 11 of 11 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 66.9 KiB processed)[0m in 5.49s]
[0m10:00:28.184843 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:00:28.184843 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:00:28.184843 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m10:00:28.184843 [info ] [MainThread]: 
[0m10:00:28.184843 [info ] [MainThread]: Finished running 7 view models, 4 table models in 0 hours 0 minutes and 22.29 seconds (22.29s).
[0m10:00:28.184843 [debug] [MainThread]: Command end result
[0m10:00:28.207481 [info ] [MainThread]: 
[0m10:00:28.207481 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:28.207481 [info ] [MainThread]: 
[0m10:00:28.207481 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 TOTAL=11
[0m10:00:28.207481 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:28.207481 after 23.38 seconds
[0m10:00:28.207481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C46D1D73D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4707F4340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C470B1AC10>]}
[0m10:00:28.207481 [debug] [MainThread]: Flushing usage events
