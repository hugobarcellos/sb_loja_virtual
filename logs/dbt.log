[0m00:00:13.346739 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m00:00:13.346739 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m00:00:13.362970 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m00:00:13.362970 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 00:00:13.346739 => 00:00:13.362970
[0m00:00:13.362970 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m00:00:13.379202 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m00:00:13.379202 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:13.379202 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m00:00:14.045941 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2bbe3f83-2a8c-4a8d-acc9-29fefbbb927c&page=queryresults
[0m00:00:14.097560 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6cf20af6-1b68-45e7-a21e-d816e4f1a78b&page=queryresults
[0m00:00:14.489869 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 00:00:13.298875 => 00:00:14.489869
[0m00:00:14.489869 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E7106A0>]}
[0m00:00:14.505549 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 00:00:13.362970 => 00:00:14.505549
[0m00:00:14.505549 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m00:00:14.505549 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E7BEEE0>]}
[0m00:00:14.505549 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m00:00:14.505549 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:14.505549 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m00:00:14.521629 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m00:00:14.505549 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m00:00:14.521629 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m00:00:14.521629 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m00:00:14.521629 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:14.521629 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m00:00:14.533269 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m00:00:14.533269 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m00:00:14.541388 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:14.541388 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m00:00:14.541388 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 00:00:14.521629 => 00:00:14.541388
[0m00:00:14.541388 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 00:00:14.541388 => 00:00:14.541388
[0m00:00:14.541388 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:14.553448 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m00:00:14.558377 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m00:00:14.558377 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m00:00:14.558377 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:14.558377 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:14.558377 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m00:00:14.558377 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m00:00:15.294132 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1117fc9-d898-4c4c-ad59-e2b8ed13195e&page=queryresults
[0m00:00:15.411113 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75260339-dbbd-4493-8bc1-5a1e7bdb1c69&page=queryresults
[0m00:00:15.684987 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 00:00:14.553448 => 00:00:15.684987
[0m00:00:15.687001 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E7A9C10>]}
[0m00:00:15.687001 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m00:00:15.689013 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m00:00:15.689013 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m00:00:15.693085 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m00:00:15.693085 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m00:00:15.693085 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m00:00:15.702388 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m00:00:15.702388 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 00:00:15.693085 => 00:00:15.702388
[0m00:00:15.702388 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m00:00:15.706402 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m00:00:15.706402 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:15.708873 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m00:00:15.803719 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 00:00:14.558377 => 00:00:15.803719
[0m00:00:15.810484 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E759A00>]}
[0m00:00:15.812499 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m00:00:15.812499 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m00:00:15.812499 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m00:00:15.816731 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m00:00:15.816731 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m00:00:15.819486 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m00:00:15.819486 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m00:00:15.819486 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 00:00:15.819486 => 00:00:15.819486
[0m00:00:15.819486 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m00:00:15.834984 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m00:00:15.834984 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:15.839837 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m00:00:16.469649 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d285d10-39fd-46fd-aa72-d3f96b896337&page=queryresults
[0m00:00:16.538740 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f1a18171-8c76-4c16-b34c-b6bffcf3ad84&page=queryresults
[0m00:00:16.865105 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 00:00:15.702388 => 00:00:16.865105
[0m00:00:16.865105 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E80CD90>]}
[0m00:00:16.865105 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m00:00:16.865105 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m00:00:16.865105 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m00:00:16.865105 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m00:00:16.865105 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m00:00:16.865105 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m00:00:16.876772 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m00:00:16.878781 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 00:00:16.865105 => 00:00:16.876772
[0m00:00:16.878781 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m00:00:16.882802 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m00:00:16.884812 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:16.884812 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m00:00:16.912815 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 00:00:15.828962 => 00:00:16.912815
[0m00:00:16.912815 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E79D760>]}
[0m00:00:16.912815 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m00:00:16.912815 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m00:00:16.912815 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m00:00:16.912815 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m00:00:16.912815 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m00:00:16.912815 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m00:00:16.927275 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m00:00:16.928783 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 00:00:16.912815 => 00:00:16.927275
[0m00:00:16.928783 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m00:00:16.930789 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m00:00:16.932798 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:16.932798 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m00:00:17.593327 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ade07d08-f1b1-431f-bc84-15d758696c3f&page=queryresults
[0m00:00:17.878833 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:78bd79d4-c54f-46b7-88ea-7b2d59d35d0f&page=queryresults
[0m00:00:17.974047 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 00:00:16.878781 => 00:00:17.974047
[0m00:00:17.974047 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E831A00>]}
[0m00:00:17.974047 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m00:00:17.974047 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m00:00:17.974047 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m00:00:17.974047 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m00:00:17.974047 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m00:00:17.974047 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m00:00:17.989875 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m00:00:17.989875 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 00:00:17.974047 => 00:00:17.989875
[0m00:00:17.989875 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m00:00:18.005824 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:18.276086 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 00:00:16.928783 => 00:00:18.276086
[0m00:00:18.276086 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E759A00>]}
[0m00:00:18.276086 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m00:00:18.276086 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m00:00:18.735647 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m00:00:18.735647 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m00:00:19.343090 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50c202e7-4728-4801-bbbe-3a47f9ea8a8b&page=queryresults
[0m00:00:21.843102 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 00:00:17.989875 => 00:00:21.843102
[0m00:00:21.843102 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E85BE20>]}
[0m00:00:21.843102 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.87s]
[0m00:00:21.843102 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m00:00:21.843102 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m00:00:21.843102 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m00:00:21.857718 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m00:00:21.857718 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m00:00:21.857718 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m00:00:21.857718 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 00:00:21.857718 => 00:00:21.857718
[0m00:00:21.857718 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m00:00:21.857718 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:22.489030 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m00:00:22.489030 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m00:00:23.176735 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76dabfc7-1e65-4c1d-aec2-b309e85cd299&page=queryresults
[0m00:00:25.395986 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 00:00:21.857718 => 00:00:25.395986
[0m00:00:25.395986 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E7FCCA0>]}
[0m00:00:25.395986 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.54s]
[0m00:00:25.395986 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m00:00:25.395986 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m00:00:25.412169 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m00:00:25.395986 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m00:00:25.412169 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m00:00:25.412169 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m00:00:25.412169 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m00:00:25.412169 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m00:00:25.412169 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:25.412169 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m00:00:25.428407 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m00:00:25.428407 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 00:00:25.412169 => 00:00:25.428407
[0m00:00:25.428407 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m00:00:25.428407 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:25.428407 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 00:00:25.412169 => 00:00:25.428407
[0m00:00:25.444298 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m00:00:25.444298 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:26.133536 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:26.133536 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m00:00:26.133536 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m00:00:26.133536 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m00:00:26.712970 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0aba8500-230c-4f5c-aaed-bbb7714a25f4&page=queryresults
[0m00:00:26.729049 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f2fc2bf-08b0-4bc2-8615-7127c5868e87&page=queryresults
[0m00:00:28.953318 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 00:00:25.428407 => 00:00:28.953318
[0m00:00:28.955334 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E876070>]}
[0m00:00:28.955334 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.54s]
[0m00:00:28.958362 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m00:00:28.958362 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m00:00:28.958362 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m00:00:28.960374 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m00:00:28.960374 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m00:00:28.966414 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m00:00:28.968424 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 00:00:28.960374 => 00:00:28.968424
[0m00:00:28.968424 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m00:00:28.968424 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:29.738946 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m00:00:29.740955 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m00:00:30.150859 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:952f5487-4f3b-4672-b8a5-86ec82cd796c&page=queryresults
[0m00:00:32.356169 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 00:00:28.968424 => 00:00:32.356169
[0m00:00:32.358183 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E6EF6D0>]}
[0m00:00:32.358183 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.40s]
[0m00:00:32.360197 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m00:00:32.360197 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m00:00:32.362211 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m00:00:32.362211 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m00:00:32.362211 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m00:00:32.370263 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m00:00:32.372273 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 00:00:32.364224 => 00:00:32.372273
[0m00:00:32.372273 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m00:00:32.372273 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:33.019525 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m00:00:33.022292 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m00:00:33.626224 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ab6b5b4-a42d-402c-beff-0beeb3ac687c&page=queryresults
[0m00:00:33.866908 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 00:00:25.444298 => 00:00:33.866908
[0m00:00:33.868923 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E70C7F0>]}
[0m00:00:33.868923 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 112.5 KiB processed)[0m in 8.46s]
[0m00:00:33.870437 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m00:00:33.870437 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m00:00:33.870437 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m00:00:33.870437 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_agg_compra_produto)
[0m00:00:33.870437 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m00:00:33.880276 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m00:00:33.882285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 00:00:33.876249 => 00:00:33.882285
[0m00:00:33.882285 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m00:00:33.896385 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:34.540352 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m00:00:34.542366 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m00:00:34.914767 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b18231c6-dbd0-409b-849e-9e666261709e&page=queryresults
[0m00:00:36.156618 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 00:00:32.372273 => 00:00:36.156618
[0m00:00:36.158632 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567F86B550>]}
[0m00:00:36.158632 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.80s]
[0m00:00:36.160645 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m00:00:36.160645 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m00:00:36.160645 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m00:00:36.160645 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m00:00:36.160645 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m00:00:36.170492 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m00:00:36.172503 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 00:00:36.165458 => 00:00:36.172503
[0m00:00:36.172503 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m00:00:36.177415 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:36.875045 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m00:00:36.877059 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m00:00:37.103959 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 00:00:33.882285 => 00:00:37.103959
[0m00:00:37.103959 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E7BEEE0>]}
[0m00:00:37.105972 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 35.9 KiB processed)[0m in 3.23s]
[0m00:00:37.107986 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m00:00:37.107986 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m00:00:37.107986 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m00:00:37.107986 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m00:00:37.107986 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m00:00:37.115748 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m00:00:37.119771 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 00:00:37.111981 => 00:00:37.117760
[0m00:00:37.119771 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m00:00:37.121784 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:37.298659 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:354f5f89-87ce-4814-bba2-9059eda04423&page=queryresults
[0m00:00:37.772077 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m00:00:37.772077 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m00:00:38.463722 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc6ef70c-319f-4d12-b8c5-7d1b53682dd1&page=queryresults
[0m00:00:39.502798 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 00:00:36.172503 => 00:00:39.502798
[0m00:00:39.502798 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E849130>]}
[0m00:00:39.502798 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.5 KiB processed)[0m in 3.34s]
[0m00:00:39.502798 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m00:00:39.502798 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m00:00:39.502798 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m00:00:39.502798 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m00:00:39.502798 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m00:00:39.518586 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m00:00:39.518586 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 00:00:39.514820 => 00:00:39.518586
[0m00:00:39.518586 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m00:00:39.533182 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:40.248742 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m00:00:40.250750 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m00:00:40.605020 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a5edae92-82cf-47c5-9a98-3a45786a2dfa&page=queryresults
[0m00:00:41.224903 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 00:00:37.119771 => 00:00:41.224903
[0m00:00:41.226919 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567F8E62E0>]}
[0m00:00:41.941933 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.12s]
[0m00:00:41.943949 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m00:00:41.945965 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m00:00:41.945965 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m00:00:41.945965 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m00:00:41.949794 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m00:00:41.955573 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m00:00:41.959595 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 00:00:41.949794 => 00:00:41.957584
[0m00:00:41.959595 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m00:00:41.961608 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:42.577625 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m00:00:42.579641 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m00:00:42.889662 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 00:00:39.523134 => 00:00:42.889662
[0m00:00:42.889662 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E849100>]}
[0m00:00:42.891675 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 299.5 KiB processed)[0m in 3.39s]
[0m00:00:42.893690 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m00:00:42.893690 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m00:00:42.893690 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m00:00:42.893690 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m00:00:42.893690 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m00:00:42.903322 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m00:00:42.905332 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 00:00:42.898289 => 00:00:42.905332
[0m00:00:42.905332 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m00:00:42.905332 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:43.227905 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72cd5b30-76ed-4f00-9e52-04c8b51672c5&page=queryresults
[0m00:00:43.522010 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m00:00:43.522010 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m00:00:43.903357 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:67f757d7-7e58-43f9-b879-c787ddc3194f&page=queryresults
[0m00:00:45.491281 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 00:00:41.959595 => 00:00:45.491281
[0m00:00:45.491281 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567F8C6370>]}
[0m00:00:45.493294 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.55s]
[0m00:00:45.495308 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m00:00:46.366146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 00:00:42.905332 => 00:00:46.366146
[0m00:00:46.368159 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567E77E310>]}
[0m00:00:46.368159 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.47s]
[0m00:00:46.370173 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m00:00:46.370173 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m00:00:46.370173 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m00:00:46.370173 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m00:00:46.370173 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m00:00:46.381407 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m00:00:46.385428 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 00:00:46.370173 => 00:00:46.385428
[0m00:00:46.385428 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m00:00:46.393213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:47.034294 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m00:00:47.038317 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m00:00:47.655809 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1cb6f006-ce67-4eac-a717-b1a8f8120165&page=queryresults
[0m00:00:51.062307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 00:00:46.385428 => 00:00:51.062307
[0m00:00:51.062307 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2164125c-cf34-4533-b4c4-4c10ceeb4819', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567D2B5C70>]}
[0m00:00:51.062307 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.69s]
[0m00:00:51.062307 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m00:00:51.068423 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:00:51.068423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:51.070801 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:51.070801 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m00:00:51.070801 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m00:00:51.070801 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m00:00:51.070801 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m00:00:51.072811 [info ] [MainThread]: 
[0m00:00:51.072811 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 45.03 seconds (45.03s).
[0m00:00:51.078337 [debug] [MainThread]: Command end result
[0m00:00:51.096311 [info ] [MainThread]: 
[0m00:00:51.096311 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:00:51.096311 [info ] [MainThread]: 
[0m00:00:51.096311 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m00:00:51.096311 [debug] [MainThread]: Command `dbt run` succeeded at 00:00:51.096311 after 46.02 seconds
[0m00:00:51.102017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025679CD2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567F876C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002567D4297C0>]}
[0m00:00:51.102017 [debug] [MainThread]: Flushing usage events
[0m00:00:55.306392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B0F73460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148AFEF4670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148AFEF4D90>]}


============================== 00:00:55.316513 | ac6c5501-7971-413b-8add-faeda6cc5b3b ==============================
[0m00:00:55.316513 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:00:55.316513 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:00:56.240256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148AFEF47C0>]}
[0m00:00:56.303967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B44FFD30>]}
[0m00:00:56.310344 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:00:56.319902 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:00:56.367874 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:00:56.367874 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:00:56.367874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B48D7700>]}
[0m00:00:56.383753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B47D1520>]}
[0m00:00:56.383753 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:00:56.383753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B47D1310>]}
[0m00:00:56.392385 [info ] [MainThread]: 
[0m00:00:56.392385 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:00:56.392385 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:56.392385 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:57.074690 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m00:00:57.074690 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m00:00:57.074690 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:57.074690 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:57.877896 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m00:00:57.877896 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:57.941731 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m00:00:57.941731 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:58.577670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B456EC40>]}
[0m00:00:58.585470 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:00:58.585470 [info ] [MainThread]: 
[0m00:00:58.585470 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m00:00:58.585470 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m00:00:58.585470 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m00:00:58.585470 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m00:00:58.626231 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 00:00:58.585470 => 00:00:58.626231
[0m00:00:58.629096 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m00:00:58.697079 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:00:58.697079 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m00:00:59.485301 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f4490b75-7eb6-4bc5-9696-206c5955dd5a&page=queryresults
[0m00:01:00.612926 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m00:01:01.031366 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3111e092-d1b9-4af1-897a-f8714396eb25&page=queryresults
[0m00:01:03.645402 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m00:01:04.356894 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m00:01:04.360940 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m00:01:04.748969 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60bd058c-d397-4046-8907-c7ab3b5796a4&page=queryresults
[0m00:01:06.975672 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 00:00:58.629096 => 00:01:06.975672
[0m00:01:06.977691 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ac6c5501-7971-413b-8add-faeda6cc5b3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B5978130>]}
[0m00:01:06.979706 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 224.9 KiB processed)[0m in 8.39s]
[0m00:01:06.979706 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m00:01:06.981720 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:01:06.981720 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:01:06.984655 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m00:01:06.984655 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m00:01:06.984655 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m00:01:06.984655 [info ] [MainThread]: 
[0m00:01:06.986666 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.59 seconds (10.59s).
[0m00:01:06.986666 [debug] [MainThread]: Command end result
[0m00:01:07.005479 [info ] [MainThread]: 
[0m00:01:07.005479 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:01:07.005479 [info ] [MainThread]: 
[0m00:01:07.011534 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:01:07.011534 [debug] [MainThread]: Command `dbt snapshot` succeeded at 00:01:07.011534 after 11.77 seconds
[0m00:01:07.014327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B0F73460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B44FFD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148B59896A0>]}
[0m00:01:07.014327 [debug] [MainThread]: Flushing usage events
[0m00:01:11.694676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D2697430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D161F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D161FE20>]}


============================== 00:01:11.710608 | 75992138-0f1e-46e0-b776-345123fc8335 ==============================
[0m00:01:11.710608 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:01:11.710608 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m00:01:12.602583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D1615070>]}
[0m00:01:12.666529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D5C21C40>]}
[0m00:01:12.666529 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:01:12.666529 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:01:12.714658 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:01:12.730803 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:01:12.730803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D60087C0>]}
[0m00:01:12.730803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D5F02700>]}
[0m00:01:12.730803 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:01:12.746645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D5C98CD0>]}
[0m00:01:12.746645 [info ] [MainThread]: 
[0m00:01:12.746645 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:01:12.746645 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:01:12.746645 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:01:13.377244 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m00:01:13.377244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:01:13.377244 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m00:01:13.377244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:01:13.997796 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m00:01:14.004531 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:01:14.045731 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m00:01:14.056654 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:01:14.896731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D6008AC0>]}
[0m00:01:14.909157 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:01:14.909157 [info ] [MainThread]: 
[0m00:01:14.912828 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m00:01:14.912828 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m00:01:14.912828 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m00:01:14.912828 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m00:01:14.928586 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m00:01:14.928586 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 00:01:14.912828 => 00:01:14.928586
[0m00:01:14.928586 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m00:01:14.960522 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:01:15.587258 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m00:01:15.587258 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m00:01:15.909606 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:29baf4a5-16fc-4aba-b0ea-a622583d03c5&page=queryresults
[0m00:01:18.866932 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 00:01:14.928586 => 00:01:18.866932
[0m00:01:18.870725 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D7081FD0>]}
[0m00:01:18.870725 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 191.9 KiB processed)[0m in 3.96s]
[0m00:01:18.870725 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m00:01:18.870725 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m00:01:18.870725 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m00:01:18.870725 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m00:01:18.870725 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m00:01:18.886724 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m00:01:18.886724 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 00:01:18.870725 => 00:01:18.886724
[0m00:01:18.886724 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m00:01:18.902613 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m00:01:19.729823 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m00:01:19.736113 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m00:01:20.177897 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46588e5a-33e3-4a95-913e-6e32700ad4fc&page=queryresults
[0m00:01:22.289248 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 00:01:18.886724 => 00:01:22.289248
[0m00:01:22.289248 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75992138-0f1e-46e0-b776-345123fc8335', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D7157F70>]}
[0m00:01:22.289248 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 202.0 KiB processed)[0m in 3.42s]
[0m00:01:22.289248 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m00:01:22.289248 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:01:22.289248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:01:22.289248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m00:01:22.289248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m00:01:22.289248 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m00:01:22.289248 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m00:01:22.289248 [info ] [MainThread]: 
[0m00:01:22.289248 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.54 seconds (9.54s).
[0m00:01:22.289248 [debug] [MainThread]: Command end result
[0m00:01:22.320874 [info ] [MainThread]: 
[0m00:01:22.320874 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:01:22.320874 [info ] [MainThread]: 
[0m00:01:22.320874 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m00:01:22.320874 [debug] [MainThread]: Command `dbt run` succeeded at 00:01:22.320874 after 10.68 seconds
[0m00:01:22.320874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D2697430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D5C21C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B6D71578B0>]}
[0m00:01:22.320874 [debug] [MainThread]: Flushing usage events
[0m01:50:46.627486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BABCD87430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BABBD0D6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BABBD0DE20>]}


============================== 01:50:46.643375 | c3da1469-1a54-40dd-9353-2aac4e235c27 ==============================
[0m01:50:46.643375 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:50:46.643375 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m01:50:47.547456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BABBD151C0>]}
[0m01:50:47.614612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC0401AF0>]}
[0m01:50:47.614612 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:50:47.622434 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:50:47.849436 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:50:47.849436 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:50:47.849436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC06F8A00>]}
[0m01:50:47.865585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC0602820>]}
[0m01:50:47.865585 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:50:47.865585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC0602610>]}
[0m01:50:47.865585 [info ] [MainThread]: 
[0m01:50:47.865585 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:50:47.881850 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:50:47.881850 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:50:47.881850 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:50:47.881850 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:50:49.202532 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:50:50.237679 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:50:50.237679 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:50:50.237679 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m01:50:50.242818 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:50:51.460600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m01:50:51.460600 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:50:51.460600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m01:50:51.460600 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:50:52.454387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC03632E0>]}
[0m01:50:52.454387 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:50:52.454387 [info ] [MainThread]: 
[0m01:50:52.470606 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:50:52.470606 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m01:50:52.470606 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m01:50:52.470606 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m01:50:52.470606 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m01:50:52.486490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:50:52.470606 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m01:50:52.486490 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m01:50:52.486490 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m01:50:52.492512 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m01:50:52.492512 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 01:50:52.470606 => 01:50:52.492512
[0m01:50:52.492512 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m01:50:52.518333 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:50:52.518333 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 01:50:52.492512 => 01:50:52.518333
[0m01:50:52.518333 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m01:50:52.518333 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m01:50:52.534135 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:50:52.534135 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:50:52.534135 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m01:50:52.565907 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m01:50:53.444557 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49e61449-197b-43f9-b63b-2a2a09dcb348&page=queryresults
[0m01:50:53.455750 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13eb3e31-3727-46bf-a817-0c5203189db1&page=queryresults
[0m01:50:53.896258 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 01:50:52.492512 => 01:50:53.896258
[0m01:50:53.896258 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC17B4D90>]}
[0m01:50:53.896258 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m01:50:53.896258 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:50:53.896258 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m01:50:53.912112 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m01:50:53.912112 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m01:50:53.912112 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m01:50:53.912112 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m01:50:53.912112 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 01:50:53.912112 => 01:50:53.912112
[0m01:50:53.912112 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m01:50:53.912112 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m01:50:53.912112 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:53.912112 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m01:50:53.943762 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 01:50:52.518333 => 01:50:53.943762
[0m01:50:53.943762 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1821850>]}
[0m01:50:53.943762 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m01:50:53.943762 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m01:50:53.943762 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m01:50:53.943762 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m01:50:53.943762 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m01:50:53.943762 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m01:50:53.943762 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m01:50:53.943762 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 01:50:53.943762 => 01:50:53.943762
[0m01:50:53.943762 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m01:50:53.943762 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m01:50:53.943762 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:53.943762 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m01:50:54.696801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5871b592-0c6a-4717-b32a-a274a2bd54d1&page=queryresults
[0m01:50:54.728938 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:06915684-a67a-44ef-8ae2-61013cda0057&page=queryresults
[0m01:50:55.114033 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 01:50:53.912112 => 01:50:55.114033
[0m01:50:55.114033 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC17A4580>]}
[0m01:50:55.114033 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m01:50:55.114033 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m01:50:55.114033 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m01:50:55.114033 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m01:50:55.114033 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m01:50:55.114033 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m01:50:55.130074 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m01:50:55.130074 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 01:50:55.114033 => 01:50:55.130074
[0m01:50:55.130074 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m01:50:55.130074 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m01:50:55.130074 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:55.130074 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m01:50:55.178046 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 01:50:53.943762 => 01:50:55.178046
[0m01:50:55.178046 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC17BE940>]}
[0m01:50:55.178046 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m01:50:55.178046 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m01:50:55.178046 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m01:50:55.178046 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m01:50:55.178046 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m01:50:55.178046 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m01:50:55.194004 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m01:50:55.194004 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 01:50:55.178046 => 01:50:55.194004
[0m01:50:55.194004 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m01:50:55.194004 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m01:50:55.194004 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:55.194004 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m01:50:55.851709 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fb4e533-5ab6-48e8-8f2e-f545ce44c479&page=queryresults
[0m01:50:55.931566 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d66b609-0e64-4b00-b1c8-06f692dd9532&page=queryresults
[0m01:50:56.251359 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 01:50:55.130074 => 01:50:56.251359
[0m01:50:56.251359 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC189F0A0>]}
[0m01:50:56.251359 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m01:50:56.251359 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m01:50:56.251359 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m01:50:56.251359 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m01:50:56.251359 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m01:50:56.251359 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m01:50:56.267427 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m01:50:56.267427 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 01:50:56.251359 => 01:50:56.267427
[0m01:50:56.267427 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m01:50:56.267427 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m01:50:56.267427 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:56.267427 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m01:50:56.347893 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 01:50:55.194004 => 01:50:56.347893
[0m01:50:56.347893 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC176FF70>]}
[0m01:50:56.347893 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m01:50:56.347893 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m01:50:56.347893 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m01:50:56.347893 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m01:50:56.347893 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m01:50:56.347893 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m01:50:56.363977 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m01:50:56.363977 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 01:50:56.347893 => 01:50:56.363977
[0m01:50:56.363977 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m01:50:56.363977 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m01:50:56.363977 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:56.363977 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m01:50:57.022189 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e40d80a7-0c4c-40fc-9121-87057ed0e7ab&page=queryresults
[0m01:50:57.150622 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f913e911-9e72-457d-a10c-4d858e8f245d&page=queryresults
[0m01:50:57.423815 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 01:50:56.267427 => 01:50:57.423815
[0m01:50:57.439645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC180CD30>]}
[0m01:50:57.439645 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m01:50:57.439645 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m01:50:57.439645 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m01:50:57.439645 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m01:50:57.439645 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m01:50:57.439645 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m01:50:57.455332 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:50:57.455332 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 01:50:57.439645 => 01:50:57.455332
[0m01:50:57.455332 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m01:50:57.455332 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m01:50:57.455332 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:57.455332 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m01:50:57.535178 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 01:50:56.363977 => 01:50:57.535178
[0m01:50:57.551194 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1802700>]}
[0m01:50:57.551194 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m01:50:57.551194 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m01:50:57.551194 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m01:50:57.551194 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m01:50:57.551194 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m01:50:57.551194 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m01:50:57.551194 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m01:50:57.567197 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 01:50:57.551194 => 01:50:57.567197
[0m01:50:57.567197 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m01:50:57.567197 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m01:50:57.567197 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:57.567197 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m01:50:58.364101 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f4f9429-bd0e-4651-a2d9-c73bc6571136&page=queryresults
[0m01:50:58.474972 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2c18845-51b0-4537-97b1-b9014960cd74&page=queryresults
[0m01:50:58.760030 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 01:50:57.455332 => 01:50:58.760030
[0m01:50:58.760030 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC185CBB0>]}
[0m01:50:58.760030 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m01:50:58.760030 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m01:50:58.760030 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m01:50:58.760030 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m01:50:58.760030 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m01:50:58.760030 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m01:50:58.776165 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m01:50:58.776165 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 01:50:58.760030 => 01:50:58.776165
[0m01:50:58.776165 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m01:50:58.776165 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m01:50:58.776165 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:58.776165 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m01:50:58.855757 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 01:50:57.567197 => 01:50:58.855757
[0m01:50:58.855757 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1821850>]}
[0m01:50:58.855757 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m01:50:58.855757 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m01:50:58.855757 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m01:50:58.855757 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m01:50:58.855757 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m01:50:58.871525 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m01:50:58.871525 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m01:50:58.871525 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 01:50:58.871525 => 01:50:58.871525
[0m01:50:58.871525 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m01:50:58.887348 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m01:50:58.887348 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:58.887348 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m01:50:59.432192 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:478847f4-144c-4ff0-ab60-22c42a279e7d&page=queryresults
[0m01:50:59.578351 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0bf8223-13dc-4330-be11-c5de3c8cc818&page=queryresults
[0m01:50:59.834523 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 01:50:58.776165 => 01:50:59.834523
[0m01:50:59.850369 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC17A4580>]}
[0m01:50:59.850369 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.09s]
[0m01:50:59.850369 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m01:50:59.850369 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m01:50:59.850369 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m01:50:59.850369 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m01:50:59.850369 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m01:50:59.850369 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m01:50:59.866577 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 01:50:59.850369 => 01:50:59.866577
[0m01:50:59.866577 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m01:50:59.866577 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m01:50:59.866577 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:50:59.866577 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m01:50:59.963174 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 01:50:58.871525 => 01:50:59.963174
[0m01:50:59.963174 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1783F10>]}
[0m01:50:59.963174 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m01:50:59.963174 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m01:50:59.963174 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m01:50:59.963174 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m01:50:59.979080 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m01:50:59.979080 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m01:50:59.979080 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m01:50:59.979080 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 01:50:59.979080 => 01:50:59.979080
[0m01:50:59.979080 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m01:50:59.995079 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m01:50:59.995079 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:50:59.995079 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m01:51:00.539759 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf7e8a12-2f21-4698-9d25-228a9e6fdb23&page=queryresults
[0m01:51:00.909272 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 01:50:59.866577 => 01:51:00.909272
[0m01:51:00.909272 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1910E80>]}
[0m01:51:00.909272 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m01:51:00.925084 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m01:51:00.925084 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m01:51:00.925084 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m01:51:00.925084 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m01:51:00.925084 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m01:51:00.925084 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m01:51:00.925084 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 01:51:00.925084 => 01:51:00.925084
[0m01:51:00.941145 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m01:51:00.957336 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:00.973244 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1285966-de7d-43bf-9c79-05b8e57a441d&page=queryresults
[0m01:51:01.390451 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 01:50:59.979080 => 01:51:01.390451
[0m01:51:01.390451 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC184E1C0>]}
[0m01:51:01.390451 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m01:51:01.390451 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m01:51:01.630419 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m01:51:01.630419 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m01:51:02.321458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f98587ec-5443-402a-b337-e75c6c745e74&page=queryresults
[0m01:51:05.145817 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 01:51:00.941145 => 01:51:05.145817
[0m01:51:05.148833 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC17B4D90>]}
[0m01:51:05.149683 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.22s]
[0m01:51:05.149683 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m01:51:05.153472 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m01:51:05.155486 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m01:51:05.157497 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m01:51:05.157497 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m01:51:05.164669 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m01:51:05.170481 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 01:51:05.157497 => 01:51:05.164669
[0m01:51:05.170481 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m01:51:05.174506 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:05.788899 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m01:51:05.805130 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m01:51:06.532202 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c96ecf6-d178-4a48-8cfc-21b7834f6a9b&page=queryresults
[0m01:51:09.063127 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 01:51:05.172494 => 01:51:09.061613
[0m01:51:09.063127 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC18B4D30>]}
[0m01:51:09.065137 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.91s]
[0m01:51:09.065137 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m01:51:09.065137 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m01:51:09.070993 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m01:51:09.065137 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m01:51:09.070993 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m01:51:09.070993 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m01:51:09.078832 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m01:51:09.070993 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m01:51:09.078832 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m01:51:09.078832 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m01:51:09.087290 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m01:51:09.089299 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 01:51:09.083273 => 01:51:09.089299
[0m01:51:09.089299 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m01:51:09.094381 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:09.142750 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 01:51:09.074388 => 01:51:09.142750
[0m01:51:09.142750 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m01:51:09.151767 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:09.827589 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m01:51:09.829602 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m01:51:09.866599 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m01:51:09.866599 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m01:51:10.421498 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd168059-18e0-4a7f-98fc-8900aa2307b5&page=queryresults
[0m01:51:10.536390 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ad2b3e9-8286-4d83-b6bc-289c63c026bf&page=queryresults
[0m01:51:12.340519 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 01:51:09.142750 => 01:51:12.338506
[0m01:51:12.340519 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC19511C0>]}
[0m01:51:12.342529 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.27s]
[0m01:51:12.344542 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m01:51:12.344542 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m01:51:12.346554 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m01:51:12.347566 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m01:51:12.347566 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m01:51:12.353593 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m01:51:12.355604 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 01:51:12.347566 => 01:51:12.355604
[0m01:51:12.357618 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m01:51:12.359629 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:13.001167 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m01:51:13.001167 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m01:51:13.416535 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:522fc4ff-89aa-45d3-b43a-9048a8a48b92&page=queryresults
[0m01:51:15.328613 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 01:51:12.357618 => 01:51:15.328613
[0m01:51:15.328613 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1951460>]}
[0m01:51:15.328613 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 2.98s]
[0m01:51:15.328613 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m01:51:15.328613 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m01:51:15.340149 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m01:51:15.340149 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m01:51:15.340149 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m01:51:15.340149 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m01:51:15.340149 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 01:51:15.340149 => 01:51:15.340149
[0m01:51:15.340149 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m01:51:15.355929 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:15.957910 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m01:51:15.957910 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m01:51:16.638536 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4f64fee-9851-4693-859c-9a80f53df86a&page=queryresults
[0m01:51:19.153324 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 01:51:15.340149 => 01:51:19.153324
[0m01:51:19.153324 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC07427F0>]}
[0m01:51:19.153324 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.81s]
[0m01:51:19.169191 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m01:51:19.169191 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m01:51:19.169191 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m01:51:19.169191 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m01:51:19.169191 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m01:51:19.185103 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m01:51:19.185103 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 01:51:19.169191 => 01:51:19.185103
[0m01:51:19.185103 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m01:51:19.185103 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:19.280784 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 01:51:09.092374 => 01:51:19.280784
[0m01:51:19.280784 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1951C10>]}
[0m01:51:19.280784 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 10.20s]
[0m01:51:19.280784 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m01:51:19.280784 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m01:51:19.290402 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m01:51:19.290402 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_agg_compra_produto)
[0m01:51:19.290402 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m01:51:19.296716 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m01:51:19.296716 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 01:51:19.290402 => 01:51:19.296716
[0m01:51:19.296716 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m01:51:19.296716 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:19.824688 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m01:51:19.824688 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m01:51:19.920580 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m01:51:19.920580 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m01:51:20.209491 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:219ef881-608f-4823-900c-38b3c673be87&page=queryresults
[0m01:51:20.321983 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eebd9b4d-913a-44c1-b563-c6391bd2c542&page=queryresults
[0m01:51:22.231434 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 01:51:19.296716 => 01:51:22.231434
[0m01:51:22.247439 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1951970>]}
[0m01:51:22.247439 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 2.96s]
[0m01:51:22.247439 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m01:51:22.247439 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m01:51:22.247439 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m01:51:22.247439 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m01:51:22.247439 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m01:51:22.247439 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m01:51:22.247439 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 01:51:22.247439 => 01:51:22.247439
[0m01:51:22.263508 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m01:51:22.263508 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:22.448381 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 01:51:19.185103 => 01:51:22.448381
[0m01:51:22.450392 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC0742D60>]}
[0m01:51:22.450392 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.28s]
[0m01:51:22.450392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m01:51:22.450392 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m01:51:22.450392 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m01:51:22.455753 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m01:51:22.455753 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m01:51:22.468167 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m01:51:22.470176 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 01:51:22.458128 => 01:51:22.470176
[0m01:51:22.470176 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m01:51:22.521111 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:22.886570 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m01:51:22.886570 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m01:51:23.174846 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m01:51:23.174846 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m01:51:23.544369 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8a9a0923-4b6c-4ef1-bbed-e57922ef5715&page=queryresults
[0m01:51:23.576544 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05e720a1-0854-44e7-96f7-9493ce26b239&page=queryresults
[0m01:51:25.906502 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 01:51:22.470176 => 01:51:25.906502
[0m01:51:25.906502 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1951910>]}
[0m01:51:26.656526 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 01:51:22.263508 => 01:51:26.656526
[0m01:51:26.656526 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC297FFD0>]}
[0m01:51:26.765373 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.45s]
[0m01:51:26.770399 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m01:51:26.768388 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.41s]
[0m01:51:26.770399 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m01:51:26.770399 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m01:51:26.773810 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m01:51:26.773810 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m01:51:26.775819 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m01:51:26.777830 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m01:51:26.785715 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m01:51:26.775819 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m01:51:26.785715 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m01:51:26.787724 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m01:51:26.791739 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m01:51:26.791739 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 01:51:26.777830 => 01:51:26.791739
[0m01:51:26.791739 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m01:51:26.799294 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:51:26.846962 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 01:51:26.787724 => 01:51:26.846962
[0m01:51:26.846962 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m01:51:26.851017 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:27.459241 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m01:51:27.461256 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m01:51:27.513148 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m01:51:27.515161 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m01:51:27.927008 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:725e6c5c-ede8-4290-92e1-81b506431d5c&page=queryresults
[0m01:51:28.124773 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8be7002b-7218-4777-ace1-216289020403&page=queryresults
[0m01:51:30.354964 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 01:51:26.846962 => 01:51:30.354964
[0m01:51:30.354964 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC29760D0>]}
[0m01:51:30.354964 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.57s]
[0m01:51:30.354964 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m01:51:30.426655 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 01:51:26.797781 => 01:51:30.426655
[0m01:51:30.428667 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC29676A0>]}
[0m01:51:30.428667 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.65s]
[0m01:51:30.430677 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m01:51:30.432690 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m01:51:30.432690 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m01:51:30.434444 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m01:51:30.436791 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m01:51:30.452364 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m01:51:30.454378 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 01:51:30.436791 => 01:51:30.454378
[0m01:51:30.454378 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m01:51:30.458404 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:51:31.113263 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m01:51:31.120480 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m01:51:31.752547 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0a9f3a1-74bd-4319-b543-a7148110ba95&page=queryresults
[0m01:51:34.841494 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 01:51:30.454378 => 01:51:34.841494
[0m01:51:34.841494 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3da1469-1a54-40dd-9353-2aac4e235c27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC19517C0>]}
[0m01:51:34.841494 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.41s]
[0m01:51:34.841494 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m01:51:34.850155 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:51:34.850155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:51:34.850155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:51:34.850155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m01:51:34.852168 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m01:51:34.852168 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m01:51:34.852168 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m01:51:34.852168 [info ] [MainThread]: 
[0m01:51:34.854177 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 46.99 seconds (46.99s).
[0m01:51:34.861209 [debug] [MainThread]: Command end result
[0m01:51:34.879102 [info ] [MainThread]: 
[0m01:51:34.881110 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:51:34.881110 [info ] [MainThread]: 
[0m01:51:34.881110 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m01:51:34.884013 [debug] [MainThread]: Command `dbt run` succeeded at 01:51:34.884013 after 48.30 seconds
[0m01:51:34.884013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BABCD87430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC1765A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BAC03F4AF0>]}
[0m01:51:34.884013 [debug] [MainThread]: Flushing usage events
[0m01:51:38.315467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CA7733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C96FF9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C96FFB80>]}


============================== 01:51:38.315467 | e9a28e69-26d6-4627-bb6d-15394d693ac2 ==============================
[0m01:51:38.315467 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:51:38.315467 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:51:38.873730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C96D0130>]}
[0m01:51:38.937499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CDCF7280>]}
[0m01:51:38.937499 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:51:38.937499 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:51:38.985416 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:51:38.985416 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:51:39.001416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CE0D8250>]}
[0m01:51:39.001416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CDFEE1C0>]}
[0m01:51:39.001416 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:51:39.001416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CDFBC0D0>]}
[0m01:51:39.001416 [info ] [MainThread]: 
[0m01:51:39.017583 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:51:39.017583 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:51:39.017583 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:39.706063 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m01:51:39.708992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:39.741088 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:51:39.741088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:40.335821 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m01:51:40.335821 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:51:40.400159 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m01:51:40.400159 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:51:41.015110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CE0E4F40>]}
[0m01:51:41.015110 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:51:41.015110 [info ] [MainThread]: 
[0m01:51:41.023957 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m01:51:41.023957 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m01:51:41.023957 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m01:51:41.023957 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m01:51:41.039834 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 01:51:41.039834 => 01:51:41.039834
[0m01:51:41.039834 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m01:51:41.087118 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:51:41.087118 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m01:51:42.019000 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e25c201f-31b7-4c61-a367-a926ac2131b0&page=queryresults
[0m01:51:43.110695 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m01:51:43.594873 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:04e3bdf8-3a97-4c29-8925-5492ef781068&page=queryresults
[0m01:51:46.047573 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m01:51:46.870529 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m01:51:46.870529 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m01:51:47.285137 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c15f738-95c8-4b53-a056-5bc8d5dcbee1&page=queryresults
[0m01:51:49.214142 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 01:51:41.039834 => 01:51:49.214142
[0m01:51:49.214142 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9a28e69-26d6-4627-bb6d-15394d693ac2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CF1844F0>]}
[0m01:51:49.214142 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (12.0 rows, 227.7 KiB processed)[0m in 8.19s]
[0m01:51:49.214142 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m01:51:49.214142 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:51:49.214142 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:51:49.214142 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m01:51:49.214142 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:51:49.214142 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m01:51:49.214142 [info ] [MainThread]: 
[0m01:51:49.230006 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.21 seconds (10.21s).
[0m01:51:49.230006 [debug] [MainThread]: Command end result
[0m01:51:49.245957 [info ] [MainThread]: 
[0m01:51:49.245957 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:51:49.245957 [info ] [MainThread]: 
[0m01:51:49.245957 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m01:51:49.245957 [debug] [MainThread]: Command `dbt snapshot` succeeded at 01:51:49.245957 after 10.99 seconds
[0m01:51:49.245957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CA7733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CDCF7280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255CF1EDA60>]}
[0m01:51:49.245957 [debug] [MainThread]: Flushing usage events
[0m01:51:52.812381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C85A83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C84A0F9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C84A0FB80>]}


============================== 01:51:52.812381 | 7a72e9de-5ecd-48b4-941e-3fa540bd6b95 ==============================
[0m01:51:52.812381 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:51:52.812381 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m01:51:53.364801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C849EA100>]}
[0m01:51:53.412522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C89100850>]}
[0m01:51:53.428560 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:51:53.428560 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:51:53.476232 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:51:53.476232 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:51:53.476232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C893F87F0>]}
[0m01:51:53.492204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C892F7610>]}
[0m01:51:53.492204 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:51:53.492204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C892F7400>]}
[0m01:51:53.492204 [info ] [MainThread]: 
[0m01:51:53.492204 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:51:53.492204 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:51:53.492204 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:54.153841 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m01:51:54.153841 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:54.166362 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m01:51:54.166362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:51:54.780296 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m01:51:54.780296 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:51:54.823088 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m01:51:54.823088 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:51:55.720744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C8915E2B0>]}
[0m01:51:55.736466 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:51:55.736466 [info ] [MainThread]: 
[0m01:51:55.736466 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m01:51:55.736466 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m01:51:55.736466 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m01:51:55.750469 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m01:51:55.766729 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m01:51:55.768235 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 01:51:55.750469 => 01:51:55.768235
[0m01:51:55.768235 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m01:51:55.779262 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:51:56.392539 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m01:51:56.392539 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m01:51:56.745766 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:105c2040-a682-4f01-9cba-331f4ef2520b&page=queryresults
[0m01:51:59.012551 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 01:51:55.768235 => 01:51:59.012551
[0m01:51:59.012551 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C8A46EE50>]}
[0m01:51:59.012551 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.28s]
[0m01:51:59.012551 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m01:51:59.028666 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m01:51:59.028666 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m01:51:59.028666 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m01:51:59.028666 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m01:51:59.028666 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m01:51:59.044669 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 01:51:59.028666 => 01:51:59.044669
[0m01:51:59.044669 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m01:51:59.044669 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:51:59.668211 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m01:51:59.668211 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m01:52:00.117824 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c198fe8d-8439-4b76-b923-3085e8904b6b&page=queryresults
[0m01:52:02.079036 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 01:51:59.044669 => 01:52:02.078019
[0m01:52:02.081057 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a72e9de-5ecd-48b4-941e-3fa540bd6b95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C8A532E50>]}
[0m01:52:02.083074 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.05s]
[0m01:52:02.083074 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m01:52:02.083074 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:52:02.083074 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:52:02.083074 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m01:52:02.083074 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:52:02.092334 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m01:52:02.092334 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m01:52:02.092334 [info ] [MainThread]: 
[0m01:52:02.094721 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.60 seconds (8.60s).
[0m01:52:02.094721 [debug] [MainThread]: Command end result
[0m01:52:02.126532 [info ] [MainThread]: 
[0m01:52:02.129961 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:52:02.129961 [info ] [MainThread]: 
[0m01:52:02.129961 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m01:52:02.129961 [debug] [MainThread]: Command `dbt run` succeeded at 01:52:02.129961 after 9.37 seconds
[0m01:52:02.129961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C85A83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C89489160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C89093F70>]}
[0m01:52:02.129961 [debug] [MainThread]: Flushing usage events
[0m02:00:05.674158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017ADDFE3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017ADCF619A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017ADCF61D30>]}


============================== 02:00:05.674158 | 76ab7327-43f9-43eb-86cf-ba4d6baaa2a0 ==============================
[0m02:00:05.674158 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:05.690117 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:00:06.718706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017ADCF529D0>]}
[0m02:00:06.777783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE153D580>]}
[0m02:00:06.777783 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:06.785740 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:06.832788 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:06.832788 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:06.832788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE19486D0>]}
[0m02:00:06.848472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE18420A0>]}
[0m02:00:06.848472 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:06.848472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE1842310>]}
[0m02:00:06.848472 [info ] [MainThread]: 
[0m02:00:06.848472 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:06.848472 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:06.848472 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:06.864587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:06.864587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:07.701461 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:08.403823 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:08.403823 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:08.403823 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:00:08.403823 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:09.078611 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m02:00:09.078611 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:09.124558 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:00:09.124558 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:09.768426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE19C5640>]}
[0m02:00:09.784515 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:09.784515 [info ] [MainThread]: 
[0m02:00:09.784515 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:09.784515 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:09.784515 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m02:00:09.784515 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:09.784515 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m02:00:09.784515 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:09.800366 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:09.800366 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:09.800366 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:09.816421 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:09.816421 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:09.800366 => 02:00:09.816421
[0m02:00:09.816421 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:09.848545 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:09.848545 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:09.800366 => 02:00:09.848545
[0m02:00:09.864651 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:09.864651 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:09.864651 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:09.864651 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m02:00:09.880882 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:09.880882 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:10.683164 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fa8ad955-8f14-4a3a-afc0-fbbb3dd6a320&page=queryresults
[0m02:00:10.683164 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a8a08ed-a25c-4a80-ab4c-5aa0ddad6405&page=queryresults
[0m02:00:11.132439 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:09.816421 => 02:00:11.132439
[0m02:00:11.132439 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A079D0>]}
[0m02:00:11.132439 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m02:00:11.132439 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.132439 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:11.132439 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m02:00:11.132439 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:11.132439 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:11.152504 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:11.152504 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:09.864651 => 02:00:11.152504
[0m02:00:11.152504 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29B57C0>]}
[0m02:00:11.152504 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m02:00:11.152504 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.164336 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m02:00:11.164336 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:11.132439 => 02:00:11.164336
[0m02:00:11.164336 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:11.164336 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m02:00:11.164336 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:11.164336 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m02:00:11.164336 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m02:00:11.164336 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m02:00:11.164336 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:11.180236 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:11.196129 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 02:00:11.164336 => 02:00:11.196129
[0m02:00:11.196129 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m02:00:11.196129 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m02:00:11.196129 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:11.196129 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m02:00:12.155289 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8166b2e2-b2f0-4e17-96ba-cee00949386f&page=queryresults
[0m02:00:12.171288 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fb92857-9fbd-4cdb-8b2b-64d8ad901e66&page=queryresults
[0m02:00:12.522533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 02:00:11.196129 => 02:00:12.522533
[0m02:00:12.522533 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE169DA30>]}
[0m02:00:12.522533 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m02:00:12.522533 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m02:00:12.522533 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:12.522533 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m02:00:12.538651 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m02:00:12.538651 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m02:00:12.538651 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:12.538651 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 02:00:12.538651 => 02:00:12.538651
[0m02:00:12.538651 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m02:00:12.554702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:12.554702 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:12.554702 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m02:00:12.586636 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:11.164336 => 02:00:12.586636
[0m02:00:12.586636 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE169DA90>]}
[0m02:00:12.586636 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m02:00:12.586636 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.586636 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m02:00:12.586636 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m02:00:12.586636 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m02:00:12.586636 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m02:00:12.602765 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:12.602765 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 02:00:12.586636 => 02:00:12.602765
[0m02:00:12.618751 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m02:00:12.618751 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:12.618751 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:12.618751 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m02:00:13.314842 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b910b6e3-14c9-46ea-9183-1d5b9a1eab8c&page=queryresults
[0m02:00:13.458056 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bae6dbda-23c3-4236-91e2-2c39427ded44&page=queryresults
[0m02:00:13.714569 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 02:00:12.538651 => 02:00:13.714569
[0m02:00:13.716585 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE169DA30>]}
[0m02:00:13.718599 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m02:00:13.718599 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:13.720610 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m02:00:13.720610 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m02:00:13.722618 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m02:00:13.722618 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m02:00:13.724128 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m02:00:13.724128 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 02:00:13.724128 => 02:00:13.724128
[0m02:00:13.724128 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m02:00:13.724128 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m02:00:13.724128 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:13.739940 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m02:00:13.819668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 02:00:12.618751 => 02:00:13.819668
[0m02:00:13.819668 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE169DA90>]}
[0m02:00:13.819668 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m02:00:13.819668 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m02:00:13.826789 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m02:00:13.826789 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m02:00:13.828800 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m02:00:13.828800 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m02:00:13.834828 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m02:00:13.837009 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 02:00:13.828800 => 02:00:13.837009
[0m02:00:13.837009 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m02:00:13.841029 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m02:00:13.843040 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:13.845050 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m02:00:14.521371 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d5f685e-a492-42e9-8641-ac28bb099594&page=queryresults
[0m02:00:14.571413 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:504be74d-a20b-4f85-92cb-df5806bfbd27&page=queryresults
[0m02:00:15.002541 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 02:00:13.724128 => 02:00:15.002541
[0m02:00:15.002541 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29BA310>]}
[0m02:00:15.002541 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m02:00:15.002541 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m02:00:15.013353 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:15.013353 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m02:00:15.015362 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m02:00:15.015362 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:15.024579 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:15.024579 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 02:00:15.015362 => 02:00:15.024579
[0m02:00:15.024579 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:15.034368 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:15.034368 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:15.034368 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m02:00:15.088597 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 02:00:13.837009 => 02:00:15.088597
[0m02:00:15.098243 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29DC280>]}
[0m02:00:15.100285 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m02:00:15.100285 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m02:00:15.100285 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m02:00:15.103150 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m02:00:15.103150 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m02:00:15.103150 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m02:00:15.103150 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m02:00:15.103150 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 02:00:15.103150 => 02:00:15.103150
[0m02:00:15.103150 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m02:00:15.114053 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m02:00:15.114053 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:15.114053 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m02:00:15.804230 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fd0a0a48-12f2-488f-b6ad-6c528426862d&page=queryresults
[0m02:00:15.850187 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e0e1dc63-a498-45ca-9480-8fe6f47f40a2&page=queryresults
[0m02:00:16.195407 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 02:00:15.024579 => 02:00:16.195407
[0m02:00:16.197417 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2ABD9D0>]}
[0m02:00:16.199426 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m02:00:16.199426 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:16.199426 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:16.201816 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m02:00:16.203326 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m02:00:16.203326 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:16.203326 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:16.203326 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:16.203326 => 02:00:16.203326
[0m02:00:16.203326 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:16.203326 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:16.219121 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:16.219121 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:16.267956 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 02:00:15.103150 => 02:00:16.267956
[0m02:00:16.267956 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29F5D00>]}
[0m02:00:16.267956 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m02:00:16.267956 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m02:00:16.267956 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m02:00:16.267956 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m02:00:16.267956 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m02:00:16.267956 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m02:00:16.283759 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m02:00:16.285768 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 02:00:16.267956 => 02:00:16.285768
[0m02:00:16.285768 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m02:00:16.299488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m02:00:16.299488 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:16.303511 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m02:00:17.017289 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b45a327b-07f4-4d81-b341-a277d6533b79&page=queryresults
[0m02:00:17.092123 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:12e1ce00-fd0e-4710-a75a-f883796d5c3c&page=queryresults
[0m02:00:17.394454 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:16.203326 => 02:00:17.392445
[0m02:00:17.394454 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29BA310>]}
[0m02:00:17.396462 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m02:00:17.396462 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:17.398474 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m02:00:17.398474 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m02:00:17.400485 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m02:00:17.400485 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m02:00:17.408271 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m02:00:17.410283 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 02:00:17.402236 => 02:00:17.410283
[0m02:00:17.410283 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m02:00:17.416315 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m02:00:17.418066 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:17.420074 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m02:00:17.468379 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 02:00:16.285768 => 02:00:17.468379
[0m02:00:17.470385 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A079D0>]}
[0m02:00:17.470385 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m02:00:17.470385 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m02:00:17.470385 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m02:00:17.470385 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m02:00:17.473189 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m02:00:17.473189 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m02:00:17.475194 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m02:00:17.475194 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 02:00:17.473189 => 02:00:17.475194
[0m02:00:17.477199 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m02:00:17.479202 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m02:00:17.479202 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:17.479202 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m02:00:18.120596 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dae5cefc-5b00-468b-84f8-5fc4a5c832f9&page=queryresults
[0m02:00:18.363724 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15a75337-74fa-43b1-8bbf-14e9da9ebe3f&page=queryresults
[0m02:00:18.481588 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 02:00:17.410283 => 02:00:18.481588
[0m02:00:18.483601 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A1B8E0>]}
[0m02:00:18.483601 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.08s]
[0m02:00:18.485613 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m02:00:18.485613 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:18.487622 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m02:00:18.489636 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m02:00:18.489636 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:18.489636 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:18.489636 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:18.489636 => 02:00:18.489636
[0m02:00:18.489636 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:18.525211 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:18.780261 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 02:00:17.477199 => 02:00:18.780261
[0m02:00:18.782274 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A00F70>]}
[0m02:00:18.782274 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m02:00:18.784284 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m02:00:19.173741 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:19.175492 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:19.830989 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3a4ff861-6d0b-4988-86b9-faaad0e16afe&page=queryresults
[0m02:00:22.338428 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:18.489636 => 02:00:22.338428
[0m02:00:22.338428 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE19DA4C0>]}
[0m02:00:22.338428 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.85s]
[0m02:00:22.338428 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:22.349065 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:22.349065 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m02:00:22.352309 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m02:00:22.352309 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:22.360344 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:22.360344 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:22.352309 => 02:00:22.360344
[0m02:00:22.360344 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:22.360344 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:23.132631 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:23.134643 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m02:00:24.236828 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1c6db04-525a-4803-99bd-7bc69c206312&page=queryresults
[0m02:00:26.530738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:22.360344 => 02:00:26.530738
[0m02:00:26.530738 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE19DA4C0>]}
[0m02:00:26.530738 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.18s]
[0m02:00:26.546658 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:26.546658 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:26.546658 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m02:00:26.546658 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m02:00:26.546658 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:26.546658 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m02:00:26.546658 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:26.546658 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m02:00:26.562760 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:26.562760 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m02:00:26.562760 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m02:00:26.562760 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:26.546658 => 02:00:26.562760
[0m02:00:26.562760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 02:00:26.562760 => 02:00:26.562760
[0m02:00:26.578777 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:26.578777 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m02:00:26.578777 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:26.594636 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:27.315074 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m02:00:27.315074 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m02:00:27.331120 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:27.347366 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:27.911352 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d375a9ab-0249-4dd8-b27e-973a6a72769b&page=queryresults
[0m02:00:28.008028 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7652b540-4a37-4421-a76b-add5d1f1b117&page=queryresults
[0m02:00:30.131656 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 02:00:26.578777 => 02:00:30.131656
[0m02:00:30.131656 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A0FA00>]}
[0m02:00:30.131656 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.58s]
[0m02:00:30.131656 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m02:00:30.131656 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m02:00:30.131656 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m02:00:30.131656 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m02:00:30.147492 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m02:00:30.159391 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m02:00:30.163207 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 02:00:30.147492 => 02:00:30.163207
[0m02:00:30.163207 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m02:00:30.170170 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:30.259273 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:26.578777 => 02:00:30.259273
[0m02:00:30.259273 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BC4C70>]}
[0m02:00:30.259273 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.71s]
[0m02:00:30.259273 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:30.259273 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m02:00:30.259273 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m02:00:30.259273 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m02:00:30.259273 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m02:00:30.275502 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m02:00:30.275502 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 02:00:30.259273 => 02:00:30.275502
[0m02:00:30.275502 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m02:00:30.275502 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:30.907530 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m02:00:30.909548 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m02:00:30.915420 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m02:00:30.915420 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:31.273044 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d46e2928-f5ec-4248-8d9c-2ddeda568ffd&page=queryresults
[0m02:00:31.552506 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e50b9f59-2bf2-4b30-bbbe-979f147cf179&page=queryresults
[0m02:00:32.892141 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 02:00:30.163207 => 02:00:32.892141
[0m02:00:32.894153 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2A911F0>]}
[0m02:00:32.894153 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 2.76s]
[0m02:00:32.894153 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m02:00:32.897689 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m02:00:32.897689 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m02:00:32.897689 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m02:00:32.897689 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m02:00:32.908166 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m02:00:32.908166 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 02:00:32.901055 => 02:00:32.908166
[0m02:00:32.908166 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m02:00:33.022955 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:33.609823 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m02:00:33.611839 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m02:00:34.054950 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a2e1906-cf30-48de-9c88-eb64a01a015c&page=queryresults
[0m02:00:34.356232 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 02:00:30.275502 => 02:00:34.356232
[0m02:00:34.358244 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29BA310>]}
[0m02:00:34.358244 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.10s]
[0m02:00:34.360257 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m02:00:34.360257 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m02:00:34.360257 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m02:00:34.363173 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m02:00:34.363173 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m02:00:34.367191 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m02:00:34.367191 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 02:00:34.365181 => 02:00:34.367191
[0m02:00:34.367191 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m02:00:34.367191 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:35.175584 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m02:00:35.179351 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m02:00:35.524282 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:549acd3b-933a-45c3-b65a-6e6e6680fa2d&page=queryresults
[0m02:00:35.965731 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 02:00:32.908166 => 02:00:35.965731
[0m02:00:35.965731 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BFB7C0>]}
[0m02:00:35.965731 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.07s]
[0m02:00:35.965731 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m02:00:35.972088 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m02:00:35.972088 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m02:00:35.972088 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m02:00:35.975976 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m02:00:35.981744 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m02:00:35.983755 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 02:00:35.975976 => 02:00:35.983755
[0m02:00:35.983755 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m02:00:35.987780 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:36.604720 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m02:00:36.606457 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m02:00:37.248267 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b326ecd-098e-4b87-b0b3-43d1758dc153&page=queryresults
[0m02:00:38.045778 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 02:00:34.367191 => 02:00:38.045778
[0m02:00:38.047790 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BC40A0>]}
[0m02:00:38.050809 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.68s]
[0m02:00:38.050809 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m02:00:38.053982 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m02:00:38.053982 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m02:00:38.055994 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m02:00:38.055994 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m02:00:38.070806 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m02:00:38.072819 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 02:00:38.055994 => 02:00:38.072819
[0m02:00:38.072819 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m02:00:38.076842 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:38.709139 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m02:00:38.711155 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m02:00:39.075449 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe6beac5-c12c-4159-a817-c2b277addc94&page=queryresults
[0m02:00:40.023400 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 02:00:35.985767 => 02:00:40.021383
[0m02:00:40.023400 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE29DDE50>]}
[0m02:00:40.852920 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.05s]
[0m02:00:40.853932 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m02:00:40.855947 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m02:00:40.855947 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m02:00:40.857926 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m02:00:40.857926 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m02:00:40.865957 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m02:00:40.867968 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 02:00:40.857926 => 02:00:40.867968
[0m02:00:40.869722 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m02:00:40.873745 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:41.517822 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m02:00:41.519849 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:41.844584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 02:00:38.074829 => 02:00:41.844584
[0m02:00:41.844584 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BC4E20>]}
[0m02:00:41.844584 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.79s]
[0m02:00:41.844584 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m02:00:41.844584 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m02:00:41.844584 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m02:00:41.844584 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m02:00:41.844584 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m02:00:41.866816 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m02:00:41.868825 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 02:00:41.844584 => 02:00:41.868825
[0m02:00:41.870837 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m02:00:41.874856 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:42.181181 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:abfaf81c-c750-4d7e-a149-a7e11974e1aa&page=queryresults
[0m02:00:42.553461 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m02:00:42.553461 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m02:00:42.930438 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35be6ff2-436b-4737-b1e0-00470a6bb0aa&page=queryresults
[0m02:00:45.604404 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 02:00:40.869722 => 02:00:45.604404
[0m02:00:45.606415 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE2B1FCD0>]}
[0m02:00:45.606415 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.75s]
[0m02:00:45.608424 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m02:00:46.055630 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 02:00:41.870837 => 02:00:46.055630
[0m02:00:46.057642 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BC4D90>]}
[0m02:00:46.059662 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.21s]
[0m02:00:46.059662 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m02:00:46.061674 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m02:00:46.063187 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m02:00:46.063187 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m02:00:46.066422 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m02:00:46.082497 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m02:00:46.084508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 02:00:46.066422 => 02:00:46.084508
[0m02:00:46.086521 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m02:00:46.090545 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:46.792535 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m02:00:46.794547 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:47.441028 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:92dfae21-6136-40d0-b2df-8e8f47dd4b7c&page=queryresults
[0m02:00:50.265399 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 02:00:46.086521 => 02:00:50.265399
[0m02:00:50.265399 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ab7327-43f9-43eb-86cf-ba4d6baaa2a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BC4310>]}
[0m02:00:50.265399 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.20s]
[0m02:00:50.265399 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m02:00:50.281119 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:50.283612 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:50.283612 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:50.283612 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m02:00:50.283612 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:00:50.285623 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m02:00:50.285623 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m02:00:50.285623 [info ] [MainThread]: 
[0m02:00:50.285623 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 43.44 seconds (43.44s).
[0m02:00:50.293665 [debug] [MainThread]: Command end result
[0m02:00:50.313004 [info ] [MainThread]: 
[0m02:00:50.313004 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:50.313004 [info ] [MainThread]: 
[0m02:00:50.313004 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m02:00:50.313004 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:50.313004 after 44.71 seconds
[0m02:00:50.320879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017ADDFE3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE153D580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE3BE9DF0>]}
[0m02:00:50.320879 [debug] [MainThread]: Flushing usage events
[0m02:00:55.070915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027146BA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027145B139A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027145B13D30>]}


============================== 02:00:55.086934 | 351c863f-d002-42b8-b4a7-1cba7381d1b3 ==============================
[0m02:00:55.086934 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:55.086934 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:00:56.057092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027145B1F970>]}
[0m02:00:56.120899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A20A550>]}
[0m02:00:56.120899 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:56.120899 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:56.185368 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:56.185368 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:56.185368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A5075B0>]}
[0m02:00:56.201218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A3FA3D0>]}
[0m02:00:56.201218 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:56.201218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A3FA1C0>]}
[0m02:00:56.201218 [info ] [MainThread]: 
[0m02:00:56.201218 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:56.201218 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:56.217281 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:56.904720 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:56.904720 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:00:56.904720 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:56.904720 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:57.777632 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:00:57.787483 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:57.835466 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m02:00:57.835466 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:58.450194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A513130>]}
[0m02:00:58.453918 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:58.453918 [info ] [MainThread]: 
[0m02:00:58.460536 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:58.460536 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m02:00:58.460536 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m02:00:58.460536 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:58.492257 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 02:00:58.460536 => 02:00:58.476392
[0m02:00:58.492257 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:58.539490 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:58.539490 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m02:00:59.226989 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0e4e841c-d672-4ef5-9458-dadf92b66675&page=queryresults
[0m02:01:00.350666 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m02:01:00.766698 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02e940d5-3eea-4909-a34d-b08e0fd87711&page=queryresults
[0m02:01:03.163464 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m02:01:04.001728 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m02:01:04.001728 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m02:01:04.411211 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b9a1940f-cf71-4d94-b6eb-0dacf98ad9f0&page=queryresults
[0m02:01:06.332170 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 02:00:58.492257 => 02:01:06.332170
[0m02:01:06.332170 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '351c863f-d002-42b8-b4a7-1cba7381d1b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714B5AF880>]}
[0m02:01:06.332170 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 7.87s]
[0m02:01:06.332170 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:01:06.332170 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:01:06.332170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:01:06.332170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:01:06.332170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m02:01:06.332170 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m02:01:06.332170 [info ] [MainThread]: 
[0m02:01:06.332170 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.13 seconds (10.13s).
[0m02:01:06.332170 [debug] [MainThread]: Command end result
[0m02:01:06.364092 [info ] [MainThread]: 
[0m02:01:06.364092 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:01:06.364092 [info ] [MainThread]: 
[0m02:01:06.364092 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m02:01:06.364092 [debug] [MainThread]: Command `dbt snapshot` succeeded at 02:01:06.364092 after 11.36 seconds
[0m02:01:06.364092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027146BA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A1C0190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002714A2DA310>]}
[0m02:01:06.364092 [debug] [MainThread]: Flushing usage events
[0m02:01:11.044630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1468E3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14586C910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14586CB80>]}


============================== 02:01:11.060296 | cfb2341d-3739-481d-b396-efc2754595af ==============================
[0m02:01:11.060296 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:01:11.060296 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m02:01:12.159911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14585B8E0>]}
[0m02:01:12.224236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B149F51490>]}
[0m02:01:12.224236 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:01:12.240013 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:01:12.287916 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:01:12.287916 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:01:12.287916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14A248670>]}
[0m02:01:12.303796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14A143490>]}
[0m02:01:12.303796 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:01:12.303796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14A143280>]}
[0m02:01:12.303796 [info ] [MainThread]: 
[0m02:01:12.303796 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:01:12.303796 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:01:12.319709 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:01:12.962091 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m02:01:12.962091 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:01:12.962091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:01:12.962091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:01:13.609861 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m02:01:13.614851 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:01:13.614851 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:01:13.614851 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:01:14.244598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14A007040>]}
[0m02:01:14.244598 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:01:14.244598 [info ] [MainThread]: 
[0m02:01:14.244598 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:01:14.244598 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m02:01:14.260445 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m02:01:14.260445 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:01:14.276188 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m02:01:14.276188 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 02:01:14.260445 => 02:01:14.276188
[0m02:01:14.276188 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:01:14.308485 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:01:15.157588 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m02:01:15.157588 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m02:01:15.495520 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c666ec0f-dcd5-4cbd-825a-62e651c04448&page=queryresults
[0m02:01:17.741206 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 02:01:14.276188 => 02:01:17.741206
[0m02:01:17.741206 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14B2C1D30>]}
[0m02:01:17.741206 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.48s]
[0m02:01:17.741206 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:01:17.741206 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m02:01:17.741206 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m02:01:17.757218 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m02:01:17.757218 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m02:01:17.757218 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m02:01:17.757218 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 02:01:17.757218 => 02:01:17.757218
[0m02:01:17.757218 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m02:01:17.757218 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:01:18.416226 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m02:01:18.416226 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m02:01:18.804032 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:683412ed-f9f6-4ec8-9b09-fbf64fb9ddb1&page=queryresults
[0m02:01:20.704977 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 02:01:17.757218 => 02:01:20.704977
[0m02:01:20.704977 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfb2341d-3739-481d-b396-efc2754595af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14B2C17F0>]}
[0m02:01:20.704977 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.96s]
[0m02:01:20.704977 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m02:01:20.704977 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:01:20.704977 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:01:20.704977 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:01:20.704977 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:01:20.704977 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m02:01:20.704977 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m02:01:20.704977 [info ] [MainThread]: 
[0m02:01:20.720735 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.40 seconds (8.40s).
[0m02:01:20.720735 [debug] [MainThread]: Command end result
[0m02:01:20.752602 [info ] [MainThread]: 
[0m02:01:20.752602 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:01:20.752602 [info ] [MainThread]: 
[0m02:01:20.752602 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m02:01:20.752602 [debug] [MainThread]: Command `dbt run` succeeded at 02:01:20.752602 after 9.77 seconds
[0m02:01:20.759487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1468E3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B149FDF970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14A22BE50>]}
[0m02:01:20.759487 [debug] [MainThread]: Flushing usage events
[0m03:00:12.105278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BC94733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BC83FF9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BC83FFB80>]}


============================== 03:00:12.105278 | ee6ac6a4-d354-44ab-81ff-c4e9744c2610 ==============================
[0m03:00:12.105278 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:12.105278 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m03:00:12.886593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BC83DAA60>]}
[0m03:00:13.005326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCADFCD0>]}
[0m03:00:13.007334 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:13.043151 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:16.031399 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:16.031399 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:16.047591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCDD8C40>]}
[0m03:00:16.063295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCCEFA60>]}
[0m03:00:16.063295 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:16.063295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCCEF850>]}
[0m03:00:16.067231 [info ] [MainThread]: 
[0m03:00:16.067231 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:16.071246 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:16.071246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:16.071246 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:16.071246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:17.145054 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:17.814279 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:17.814279 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:17.846228 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:17.846228 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:18.470063 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m03:00:18.470063 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:18.505826 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:18.505826 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:19.154289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCB343D0>]}
[0m03:00:19.154289 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:19.154289 [info ] [MainThread]: 
[0m03:00:19.167250 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:19.171261 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:19.167250 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m03:00:19.171261 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m03:00:19.171261 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:19.171261 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:19.171261 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:19.171261 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:19.183108 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:19.199104 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:19.199104 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:19.171261 => 03:00:19.199104
[0m03:00:19.199104 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:19.215123 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:19.183108 => 03:00:19.215123
[0m03:00:19.215123 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:19.250970 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:19.250970 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:19.250970 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:19.250970 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:19.294913 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:19.294913 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m03:00:20.155559 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15b58dae-e0ee-4d12-b88f-662dd3140994&page=queryresults
[0m03:00:20.203309 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf3c692d-8502-4aee-be75-448ec0850363&page=queryresults
[0m03:00:20.602269 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:19.215123 => 03:00:20.602269
[0m03:00:20.602269 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC60D0>]}
[0m03:00:20.602269 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m03:00:20.602269 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:20.602269 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:20.615572 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m03:00:20.615572 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:20.615572 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:20.620417 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:20.622428 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:20.615572 => 03:00:20.622428
[0m03:00:20.622428 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:20.622428 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:20.622428 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:20.634413 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:20.675213 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:19.199104 => 03:00:20.675213
[0m03:00:20.675213 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC8610>]}
[0m03:00:20.675213 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m03:00:20.677221 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:20.677221 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m03:00:20.677221 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m03:00:20.679381 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m03:00:20.679381 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m03:00:20.681966 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m03:00:20.681966 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 03:00:20.679381 => 03:00:20.681966
[0m03:00:20.681966 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m03:00:20.681966 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m03:00:20.681966 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:20.681966 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m03:00:21.414945 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ce4c154-fe04-4578-bcaa-62407beef893&page=queryresults
[0m03:00:21.414945 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6ee510c1-fbe9-47b2-894a-c3a57284130e&page=queryresults
[0m03:00:21.813911 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:20.622428 => 03:00:21.813911
[0m03:00:21.813911 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCE4AE50>]}
[0m03:00:21.813911 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m03:00:21.813911 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:21.829905 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:21.829905 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m03:00:21.829905 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m03:00:21.829905 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m03:00:21.829905 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:21.840720 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 03:00:20.681966 => 03:00:21.829905
[0m03:00:21.840720 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDE84D60>]}
[0m03:00:21.842736 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m03:00:21.842736 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m03:00:21.842736 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m03:00:21.842736 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m03:00:21.845913 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 03:00:21.829905 => 03:00:21.845913
[0m03:00:21.845913 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m03:00:21.845913 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m03:00:21.845913 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m03:00:21.845913 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:21.861202 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:21.861202 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:21.861202 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m03:00:21.893235 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 03:00:21.845913 => 03:00:21.893235
[0m03:00:21.893235 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m03:00:21.909095 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:21.909095 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:21.909095 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m03:00:22.755533 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8b41daca-50d6-48ea-a8a7-3a83820349d2&page=queryresults
[0m03:00:22.814204 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97b37f7c-18f6-4bc9-ba23-326ea20608be&page=queryresults
[0m03:00:23.136958 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 03:00:21.845913 => 03:00:23.136958
[0m03:00:23.138965 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC2A90>]}
[0m03:00:23.138965 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m03:00:23.138965 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:23.138965 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m03:00:23.138965 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m03:00:23.138965 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m03:00:23.138965 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m03:00:23.143278 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m03:00:23.143278 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 03:00:23.138965 => 03:00:23.143278
[0m03:00:23.143278 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m03:00:23.147423 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m03:00:23.147423 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:23.149431 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m03:00:23.199254 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 03:00:21.893235 => 03:00:23.197746
[0m03:00:23.199254 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF58070>]}
[0m03:00:23.199254 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m03:00:23.201794 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m03:00:23.201794 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m03:00:23.201794 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m03:00:23.201794 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m03:00:23.201794 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m03:00:23.207506 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m03:00:23.207506 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 03:00:23.201794 => 03:00:23.207506
[0m03:00:23.207506 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m03:00:23.209511 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m03:00:23.211518 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:23.211518 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m03:00:23.811369 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7002769e-859f-49ba-9fa1-01b09eb56c83&page=queryresults
[0m03:00:23.916011 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:da10033a-1954-4b7c-8ffe-2c9607af1ae6&page=queryresults
[0m03:00:24.198444 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 03:00:23.143278 => 03:00:24.198444
[0m03:00:24.198444 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC88B0>]}
[0m03:00:24.198444 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m03:00:24.198444 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m03:00:24.210417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:24.210417 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m03:00:24.210417 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m03:00:24.210417 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:24.227597 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:24.230619 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 03:00:24.210417 => 03:00:24.230619
[0m03:00:24.230619 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:24.237466 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:24.239470 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:24.239470 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m03:00:24.294430 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 03:00:23.207506 => 03:00:24.294430
[0m03:00:24.310452 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEAF190>]}
[0m03:00:24.310452 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m03:00:24.310452 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m03:00:24.310452 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m03:00:24.310452 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m03:00:24.310452 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m03:00:24.310452 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m03:00:24.322095 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m03:00:24.324107 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 03:00:24.310452 => 03:00:24.324107
[0m03:00:24.324107 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m03:00:24.326121 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m03:00:24.326121 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:24.326121 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m03:00:24.968336 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99cd032a-4728-44ae-829c-e5921344f2a2&page=queryresults
[0m03:00:25.075611 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5351ffd-6d4f-4906-8e43-a75cccb2604d&page=queryresults
[0m03:00:25.399281 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 03:00:24.233111 => 03:00:25.399281
[0m03:00:25.401291 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC60D0>]}
[0m03:00:25.401291 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m03:00:25.401291 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:25.401291 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:25.401291 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m03:00:25.401291 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m03:00:25.404800 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:25.406804 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:25.406804 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:25.404800 => 03:00:25.406804
[0m03:00:25.408811 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:25.410815 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:25.410815 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:25.412818 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:25.453901 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 03:00:24.324107 => 03:00:25.453901
[0m03:00:25.455909 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCE4A3D0>]}
[0m03:00:25.455909 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m03:00:25.455909 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m03:00:25.455909 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m03:00:25.455909 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m03:00:25.455909 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m03:00:25.455909 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m03:00:25.464218 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m03:00:25.464218 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 03:00:25.455909 => 03:00:25.464218
[0m03:00:25.464218 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m03:00:25.468229 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m03:00:25.468229 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:25.469974 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m03:00:26.155861 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3e0dbc18-a300-4b60-9f3a-9d01cb5bb9fb&page=queryresults
[0m03:00:26.172070 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c97c43f-56c5-4714-850f-33d7968d6759&page=queryresults
[0m03:00:26.546387 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:25.408811 => 03:00:26.546387
[0m03:00:26.548396 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDEC60D0>]}
[0m03:00:26.548396 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m03:00:26.548396 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:26.548396 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m03:00:26.548396 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m03:00:26.548396 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m03:00:26.553477 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m03:00:26.557499 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m03:00:26.559510 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 03:00:26.553477 => 03:00:26.559510
[0m03:00:26.561521 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m03:00:26.565548 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m03:00:26.567559 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:26.569312 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m03:00:26.617298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 03:00:25.466224 => 03:00:26.617298
[0m03:00:26.617298 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF67FD0>]}
[0m03:00:26.617298 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m03:00:26.617298 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m03:00:26.617298 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m03:00:26.617298 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m03:00:26.633133 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m03:00:26.633133 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m03:00:26.633133 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m03:00:26.633133 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 03:00:26.633133 => 03:00:26.633133
[0m03:00:26.633133 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m03:00:26.633133 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m03:00:26.633133 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:26.633133 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m03:00:27.286722 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4b882c71-cc6f-4a08-8f05-99a1dd94c146&page=queryresults
[0m03:00:27.540047 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1703218f-93ad-4ed1-a520-044198005789&page=queryresults
[0m03:00:27.669755 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 03:00:26.561521 => 03:00:27.669755
[0m03:00:27.671767 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF9F3A0>]}
[0m03:00:27.671767 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m03:00:27.673782 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m03:00:27.673782 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:27.673782 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m03:00:27.673782 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m03:00:27.673782 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:27.683407 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:27.683407 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:27.673782 => 03:00:27.683407
[0m03:00:27.683407 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:27.701181 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:27.928807 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 03:00:26.633133 => 03:00:27.928807
[0m03:00:27.930819 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF58070>]}
[0m03:00:27.932831 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m03:00:27.932831 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m03:00:28.613335 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:28.615347 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:29.192322 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb6f3dae-f6a2-4fe1-aa5b-ac45dea94fc2&page=queryresults
[0m03:00:31.724408 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:27.683407 => 03:00:31.724408
[0m03:00:31.726420 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDE7F7F0>]}
[0m03:00:31.726420 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.05s]
[0m03:00:31.726420 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:31.726420 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:31.726420 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m03:00:31.731614 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m03:00:31.731614 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:31.738931 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:31.740944 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:31.731614 => 03:00:31.740944
[0m03:00:31.740944 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:31.744970 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:32.374906 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:32.374906 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m03:00:33.099568 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca2ede60-de63-4dcc-a07e-152948321abd&page=queryresults
[0m03:00:35.645804 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:31.740944 => 03:00:35.645804
[0m03:00:35.645804 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF83D60>]}
[0m03:00:35.645804 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.91s]
[0m03:00:35.651799 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:35.651799 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:35.651799 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m03:00:35.651799 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m03:00:35.651799 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:35.651799 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:35.651799 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:35.651799 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m03:00:35.651799 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m03:00:35.651799 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m03:00:35.651799 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m03:00:35.651799 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 03:00:35.651799 => 03:00:35.651799
[0m03:00:35.651799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:35.651799 => 03:00:35.651799
[0m03:00:35.663773 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m03:00:35.663773 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:35.667923 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:35.667923 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:36.273023 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m03:00:36.273023 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m03:00:36.288998 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:36.288998 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:36.892398 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ee24e32-1aa3-4a63-8862-75ea4388fa0a&page=queryresults
[0m03:00:37.012242 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7b1ec60-ee43-4736-bdb4-a258c1909c59&page=queryresults
[0m03:00:39.255481 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:35.667923 => 03:00:39.255481
[0m03:00:39.257489 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF332B0>]}
[0m03:00:39.257489 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.61s]
[0m03:00:39.257489 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:39.257489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m03:00:39.260857 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m03:00:39.260857 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m03:00:39.260857 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m03:00:39.260857 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m03:00:39.271393 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 03:00:39.260857 => 03:00:39.271393
[0m03:00:39.271393 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m03:00:39.275547 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:39.407610 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 03:00:35.663773 => 03:00:39.407610
[0m03:00:39.409621 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCE07ED60>]}
[0m03:00:39.409621 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.76s]
[0m03:00:39.411634 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m03:00:39.413645 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m03:00:39.413645 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m03:00:39.415156 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m03:00:39.415156 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m03:00:39.417168 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m03:00:39.417168 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 03:00:39.415156 => 03:00:39.417168
[0m03:00:39.417168 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m03:00:39.431143 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:39.993768 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m03:00:39.993768 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:40.025617 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m03:00:40.027630 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m03:00:40.353870 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e76d0e3a-19b5-44fa-87ec-60009f05014d&page=queryresults
[0m03:00:40.593563 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f2e89bb-3709-4aa8-b666-30eea3023ccb&page=queryresults
[0m03:00:42.291963 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 03:00:39.271393 => 03:00:42.278854
[0m03:00:42.291963 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCF0CF1C0>]}
[0m03:00:42.293977 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.03s]
[0m03:00:42.294986 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m03:00:42.294986 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m03:00:42.294986 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m03:00:42.294986 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m03:00:42.294986 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m03:00:42.364562 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m03:00:42.369603 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 03:00:42.299757 => 03:00:42.369603
[0m03:00:42.369603 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m03:00:42.373623 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:42.817876 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 03:00:39.417168 => 03:00:42.817876
[0m03:00:42.817876 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF33220>]}
[0m03:00:42.820989 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.40s]
[0m03:00:42.820989 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m03:00:42.820989 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m03:00:42.820989 [info ] [Thread-1  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m03:00:42.820989 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m03:00:42.820989 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m03:00:42.820989 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m03:00:42.820989 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 03:00:42.820989 => 03:00:42.820989
[0m03:00:42.820989 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m03:00:42.833763 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:42.943289 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m03:00:42.943289 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m03:00:43.379418 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fd091907-7a1a-4adb-9fe3-e3ae0799585d&page=queryresults
[0m03:00:43.445444 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m03:00:43.445444 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m03:00:43.826169 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a28b84e-3fc0-4705-b6ac-7c3f07fda400&page=queryresults
[0m03:00:45.301371 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 03:00:42.371614 => 03:00:45.301371
[0m03:00:45.301371 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDE82160>]}
[0m03:00:45.301371 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.01s]
[0m03:00:45.301371 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m03:00:45.301371 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m03:00:45.301371 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m03:00:45.301371 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m03:00:45.301371 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m03:00:45.301371 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m03:00:45.301371 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 03:00:45.301371 => 03:00:45.301371
[0m03:00:45.301371 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m03:00:45.317493 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:45.921552 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m03:00:45.921552 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m03:00:46.336417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 03:00:42.833255 => 03:00:46.336417
[0m03:00:46.336417 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDECB8B0>]}
[0m03:00:46.336417 [info ] [Thread-1  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.52s]
[0m03:00:46.336417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m03:00:46.336417 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:46.336417 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m03:00:46.336417 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m03:00:46.336417 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:46.336417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m03:00:46.352545 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 03:00:46.336417 => 03:00:46.352545
[0m03:00:46.352545 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:46.354553 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:46.497081 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:508d1113-b69d-45e7-81be-ccc0882315bc&page=queryresults
[0m03:00:46.991484 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m03:00:46.993492 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m03:00:47.388543 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0a175e13-2e82-42ea-84d7-9757076f5343&page=queryresults
[0m03:00:49.252154 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 03:00:45.317493 => 03:00:49.252154
[0m03:00:49.252154 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF7FDF0>]}
[0m03:00:49.622748 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 03:00:46.352545 => 03:00:49.622748
[0m03:00:49.622748 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDE5C310>]}
[0m03:00:49.976430 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 3.95s]
[0m03:00:49.976430 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m03:00:49.976430 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.29s]
[0m03:00:49.976430 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:49.976430 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m03:00:49.976430 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m03:00:49.976430 [info ] [Thread-2  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m03:00:49.976430 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m03:00:49.976430 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m03:00:49.976430 [info ] [Thread-1  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m03:00:49.984404 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m03:00:49.984404 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m03:00:49.984404 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m03:00:49.998306 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m03:00:50.000062 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 03:00:49.976430 => 03:00:50.000062
[0m03:00:50.000062 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m03:00:50.000062 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:50.000062 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 03:00:49.984404 => 03:00:50.000062
[0m03:00:50.000062 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m03:00:50.006450 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:50.685863 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m03:00:50.685863 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m03:00:50.692960 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:50.692960 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m03:00:51.120929 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5c1e47a-bb3f-4ed5-bdb2-7785e4414980&page=queryresults
[0m03:00:51.302212 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85513f81-d8db-4a1d-94e7-b8e6d0763545&page=queryresults
[0m03:00:53.489287 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 03:00:50.000062 => 03:00:53.489287
[0m03:00:53.491301 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCDF6B160>]}
[0m03:00:53.491301 [info ] [Thread-2  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.51s]
[0m03:00:53.491301 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m03:00:53.904172 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 03:00:50.000062 => 03:00:53.902156
[0m03:00:53.904172 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCF099580>]}
[0m03:00:53.906184 [info ] [Thread-1  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.92s]
[0m03:00:53.906184 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m03:00:53.909013 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:53.909013 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m03:00:53.909013 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m03:00:53.909013 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:53.915900 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m03:00:53.915900 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 03:00:53.909013 => 03:00:53.915900
[0m03:00:53.915900 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:53.917906 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:54.506000 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m03:00:54.508014 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:55.094075 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f934be87-2662-4256-8739-bd3abbdfa60e&page=queryresults
[0m03:00:58.443859 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 03:00:53.917906 => 03:00:58.443859
[0m03:00:58.445871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ee6ac6a4-d354-44ab-81ff-c4e9744c2610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCDE46A0>]}
[0m03:00:58.447379 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.54s]
[0m03:00:58.447379 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:58.447379 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:58.447379 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:58.447379 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:58.447379 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:58.447379 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m03:00:58.454800 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m03:00:58.454800 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m03:00:58.454800 [info ] [MainThread]: 
[0m03:00:58.454800 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 42.39 seconds (42.39s).
[0m03:00:58.463039 [debug] [MainThread]: Command end result
[0m03:00:58.474259 [info ] [MainThread]: 
[0m03:00:58.474259 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:58.474259 [info ] [MainThread]: 
[0m03:00:58.474259 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m03:00:58.474259 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:58.474259 after 46.46 seconds
[0m03:00:58.474259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BC94733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCADFCD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016BCCA66460>]}
[0m03:00:58.474259 [debug] [MainThread]: Flushing usage events
[0m03:01:01.725724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4391E3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E438163670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E438163AC0>]}


============================== 03:01:01.725724 | 542e7a17-f34a-420f-859e-8ee603d96033 ==============================
[0m03:01:01.725724 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:01:01.725724 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m03:01:02.209665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4381637C0>]}
[0m03:01:02.271028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43C8420D0>]}
[0m03:01:02.273033 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:01:02.281265 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:01:02.332433 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:01:02.332433 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:01:02.332433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43CB483D0>]}
[0m03:01:02.348373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43CA5B2E0>]}
[0m03:01:02.348373 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:01:02.348373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43C7E66D0>]}
[0m03:01:02.348373 [info ] [MainThread]: 
[0m03:01:02.348373 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:01:02.348373 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:01:02.348373 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:03.039554 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m03:01:03.039554 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:03.039554 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m03:01:03.039554 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:03.636584 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m03:01:03.637105 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:03.654161 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:01:03.654161 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:04.279251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43C80C280>]}
[0m03:01:04.281781 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:01:04.282291 [info ] [MainThread]: 
[0m03:01:04.282291 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:01:04.290748 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m03:01:04.290748 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m03:01:04.290748 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:01:04.316266 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 03:01:04.290748 => 03:01:04.316266
[0m03:01:04.318275 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:01:04.369613 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:01:04.369613 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m03:01:05.102447 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d4c4b799-fadc-4c10-9bf0-d6b7887cde3c&page=queryresults
[0m03:01:06.201521 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m03:01:06.614334 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85b0886b-d6f4-4c3f-b03a-d5100996118b&page=queryresults
[0m03:01:09.015616 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m03:01:09.733723 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m03:01:09.737489 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m03:01:10.133390 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01c0fae7-a908-41b0-8acc-e62be08cd69a&page=queryresults
[0m03:01:12.091189 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 03:01:04.318275 => 03:01:12.091189
[0m03:01:12.091189 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '542e7a17-f34a-420f-859e-8ee603d96033', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43DC41CA0>]}
[0m03:01:12.091189 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 7.80s]
[0m03:01:12.091189 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:01:12.091189 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:12.091189 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:01:12.091189 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:01:12.091189 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m03:01:12.091189 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m03:01:12.091189 [info ] [MainThread]: 
[0m03:01:12.091189 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.74 seconds (9.74s).
[0m03:01:12.091189 [debug] [MainThread]: Command end result
[0m03:01:12.116979 [info ] [MainThread]: 
[0m03:01:12.116979 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:01:12.116979 [info ] [MainThread]: 
[0m03:01:12.116979 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:01:12.116979 [debug] [MainThread]: Command `dbt snapshot` succeeded at 03:01:12.116979 after 10.44 seconds
[0m03:01:12.122863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4391E3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43C8420D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E43CA31070>]}
[0m03:01:12.122863 [debug] [MainThread]: Flushing usage events
[0m03:01:15.179304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EB7B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EA73F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EA73FD30>]}


============================== 03:01:15.179304 | dc232b22-2361-46c4-9c8a-35709c085d17 ==============================
[0m03:01:15.179304 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:01:15.179304 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:01:15.785014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EA723040>]}
[0m03:01:15.833060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EED31C40>]}
[0m03:01:15.848857 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:01:15.855660 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:01:15.896224 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:01:15.896224 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:01:15.912298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EF1187C0>]}
[0m03:01:15.912298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EF012700>]}
[0m03:01:15.912298 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:01:15.912298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EEDACCD0>]}
[0m03:01:15.912298 [info ] [MainThread]: 
[0m03:01:15.912298 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:01:15.928384 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:01:15.928384 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:16.548199 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m03:01:16.548199 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:16.548199 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:01:16.548199 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:17.112249 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:01:17.112249 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:17.144407 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m03:01:17.147339 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:17.728825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EF118AC0>]}
[0m03:01:17.728825 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:01:17.728825 [info ] [MainThread]: 
[0m03:01:17.739905 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:17.739905 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m03:01:17.742202 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m03:01:17.742202 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:17.755736 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:01:17.755736 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 03:01:17.744800 => 03:01:17.755736
[0m03:01:17.755736 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:17.771091 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:01:18.380813 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:01:18.380813 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m03:01:18.753927 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:12ace618-6d88-4b7f-b5a4-bfd9d6c0d66d&page=queryresults
[0m03:01:21.001931 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 03:01:17.755736 => 03:01:21.001931
[0m03:01:21.003678 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259F018BBE0>]}
[0m03:01:21.003678 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.26s]
[0m03:01:21.003678 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:21.003678 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m03:01:21.003678 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m03:01:21.003678 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m03:01:21.003678 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m03:01:21.009283 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m03:01:21.011289 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 03:01:21.003678 => 03:01:21.011289
[0m03:01:21.011289 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m03:01:21.013296 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:01:21.596576 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m03:01:21.598590 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m03:01:21.960992 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd54e912-b0b2-47b8-8412-27fcc536eebc&page=queryresults
[0m03:01:23.864789 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 03:01:21.011289 => 03:01:23.864789
[0m03:01:23.864789 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dc232b22-2361-46c4-9c8a-35709c085d17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259F018B940>]}
[0m03:01:23.868604 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.86s]
[0m03:01:23.868604 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m03:01:23.868604 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:23.868604 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:01:23.868604 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:01:23.868604 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m03:01:23.868604 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m03:01:23.868604 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m03:01:23.868604 [info ] [MainThread]: 
[0m03:01:23.868604 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 7.96 seconds (7.96s).
[0m03:01:23.868604 [debug] [MainThread]: Command end result
[0m03:01:23.896822 [info ] [MainThread]: 
[0m03:01:23.896822 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:01:23.896822 [info ] [MainThread]: 
[0m03:01:23.896822 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m03:01:23.900368 [debug] [MainThread]: Command `dbt run` succeeded at 03:01:23.900368 after 8.77 seconds
[0m03:01:23.900368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EB7B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EED31C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000259EEDACE20>]}
[0m03:01:23.900368 [debug] [MainThread]: Flushing usage events
[0m04:00:04.586566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212AD2623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212AC1C79D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212AC1C7B80>]}


============================== 04:00:04.586566 | 157c76eb-e5e5-4a77-8d31-925bb864c8d7 ==============================
[0m04:00:04.586566 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:04.586566 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:05.446060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212AC1BA130>]}
[0m04:00:05.509595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B08D27F0>]}
[0m04:00:05.509595 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:05.509595 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:05.557449 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:05.557449 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:05.573305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0BC8A60>]}
[0m04:00:05.573305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0ADE880>]}
[0m04:00:05.573305 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:05.573305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0ADE670>]}
[0m04:00:05.590967 [info ] [MainThread]: 
[0m04:00:05.591868 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:05.593617 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:05.593617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:05.593617 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:05.593617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:06.439565 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:07.146681 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m04:00:07.146681 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:00:07.146681 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:07.146681 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:07.809479 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:00:07.809479 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:07.836491 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m04:00:07.842124 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:08.462319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B084EF70>]}
[0m04:00:08.462319 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:08.462319 [info ] [MainThread]: 
[0m04:00:08.478360 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.478360 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.478360 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m04:00:08.478360 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:08.478360 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m04:00:08.478360 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.478360 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:08.494450 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:08.494450 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.494450 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:08.494450 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:08.478360 => 04:00:08.494450
[0m04:00:08.494450 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:08.542356 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:08.542356 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:08.494450 => 04:00:08.542356
[0m04:00:08.542356 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:08.542356 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:08.542356 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:08.542356 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:08.542356 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:08.574299 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m04:00:10.361859 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:907d3a8d-c474-4691-864c-fd29bce372eb&page=queryresults
[0m04:00:10.844578 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:08.542356 => 04:00:10.844578
[0m04:00:10.844578 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1CF28B0>]}
[0m04:00:10.844578 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 2.37s]
[0m04:00:10.844578 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:10.844578 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:10.844578 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m04:00:10.844578 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:10.844578 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:10.860429 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:10.860429 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:10.844578 => 04:00:10.860429
[0m04:00:10.860429 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:10.860429 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:10.860429 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:10.860429 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:11.519504 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:33b84427-aa76-4d3e-99af-69a0c0824298&page=queryresults
[0m04:00:11.969700 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:08.510567 => 04:00:11.969700
[0m04:00:11.969700 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C88E20>]}
[0m04:00:11.969700 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 3.49s]
[0m04:00:11.969700 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:11.969700 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m04:00:11.969700 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m04:00:11.969700 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m04:00:11.985487 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m04:00:11.985487 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m04:00:11.985487 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 04:00:11.985487 => 04:00:11.985487
[0m04:00:11.985487 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m04:00:11.985487 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m04:00:11.985487 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:12.001378 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m04:00:14.661480 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e0e1a1c-3871-4782-a539-d260f2b05ff3&page=queryresults
[0m04:00:15.081408 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:10.860429 => 04:00:15.081408
[0m04:00:15.081408 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1D34FA0>]}
[0m04:00:15.081408 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 4.24s]
[0m04:00:15.081408 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:15.081408 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:15.081408 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m04:00:15.094831 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m04:00:15.094831 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m04:00:15.094831 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:15.094831 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 04:00:15.094831 => 04:00:15.094831
[0m04:00:15.094831 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m04:00:15.094831 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:15.094831 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:15.094831 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m04:00:15.287266 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:14033973-a9e1-4fb4-a7fd-27beec2f9c2c&page=queryresults
[0m04:00:15.706017 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 04:00:11.985487 => 04:00:15.706017
[0m04:00:15.706017 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1D34C70>]}
[0m04:00:15.706017 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 3.74s]
[0m04:00:15.706017 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m04:00:15.706017 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m04:00:15.706017 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m04:00:15.706017 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m04:00:15.706017 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m04:00:15.721846 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:15.721846 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 04:00:15.706017 => 04:00:15.721846
[0m04:00:15.721846 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m04:00:15.737837 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:15.737837 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:15.737837 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m04:00:15.881491 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44b0b2b6-4d55-4d6e-92aa-b052e642d611&page=queryresults
[0m04:00:16.286141 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 04:00:15.094831 => 04:00:16.286141
[0m04:00:16.286141 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0C3EA30>]}
[0m04:00:16.286141 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m04:00:16.299336 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:16.299336 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m04:00:16.299336 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m04:00:16.299336 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m04:00:16.299336 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m04:00:16.299336 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m04:00:16.299336 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 04:00:16.299336 => 04:00:16.299336
[0m04:00:16.299336 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m04:00:16.315440 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m04:00:16.315440 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:16.315440 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m04:00:16.502865 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbac13c1-00df-4ca5-8532-01775b62dce4&page=queryresults
[0m04:00:16.892920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 04:00:15.721846 => 04:00:16.880816
[0m04:00:16.892920 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0C3ED90>]}
[0m04:00:16.892920 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m04:00:16.892920 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m04:00:16.892920 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m04:00:16.892920 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m04:00:16.892920 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m04:00:16.892920 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m04:00:16.892920 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m04:00:16.892920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 04:00:16.892920 => 04:00:16.892920
[0m04:00:16.892920 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m04:00:16.908618 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m04:00:16.908618 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:16.908618 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m04:00:17.004156 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:401b9ee5-a2a9-49c1-94e5-88ec5a0678b1&page=queryresults
[0m04:00:17.357704 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 04:00:16.299336 => 04:00:17.357704
[0m04:00:17.357704 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C40EE0>]}
[0m04:00:17.357704 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m04:00:17.373810 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m04:00:17.373810 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:17.373810 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m04:00:17.373810 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m04:00:17.373810 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:17.391843 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:17.393860 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 04:00:17.373810 => 04:00:17.393860
[0m04:00:17.395880 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:17.397899 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:17.397899 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:17.405771 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m04:00:17.661995 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d837461-e06d-4f29-9b9c-b6d9f1d1fd85&page=queryresults
[0m04:00:18.058322 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 04:00:16.892920 => 04:00:18.058322
[0m04:00:18.060333 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C40220>]}
[0m04:00:18.060333 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m04:00:18.062342 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m04:00:18.063852 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m04:00:18.063852 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m04:00:18.063852 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m04:00:18.067972 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m04:00:18.074003 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m04:00:18.076015 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 04:00:18.067972 => 04:00:18.076015
[0m04:00:18.076015 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m04:00:18.081790 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m04:00:18.083801 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:18.087822 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m04:00:18.127470 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b50b696d-000c-4012-bbdc-d975048b9378&page=queryresults
[0m04:00:18.542711 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 04:00:17.395880 => 04:00:18.542711
[0m04:00:18.543721 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1CF28B0>]}
[0m04:00:18.545736 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m04:00:18.545736 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:18.545736 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:18.545736 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m04:00:18.545736 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m04:00:18.545736 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:18.545736 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:18.559587 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:18.545736 => 04:00:18.559587
[0m04:00:18.559587 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:18.559587 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:18.559587 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:18.559587 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:18.845370 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ca8f139-3bf7-45a1-8e71-7a0f58924f93&page=queryresults
[0m04:00:19.249138 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 04:00:18.076015 => 04:00:19.249138
[0m04:00:19.249138 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1DA2310>]}
[0m04:00:19.251152 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m04:00:19.251152 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m04:00:19.254722 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m04:00:19.254722 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m04:00:19.256734 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m04:00:19.256734 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m04:00:19.270956 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m04:00:19.270956 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16713de4-a553-4a64-9d10-57f9fb7ebc9c&page=queryresults
[0m04:00:19.277319 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 04:00:19.256734 => 04:00:19.277319
[0m04:00:19.277319 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m04:00:19.287003 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m04:00:19.289017 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:19.292210 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m04:00:19.671045 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:18.559587 => 04:00:19.671045
[0m04:00:19.673054 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C6AA00>]}
[0m04:00:19.673054 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m04:00:19.675063 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:19.675063 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m04:00:19.675063 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m04:00:19.677071 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m04:00:19.677071 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m04:00:19.682851 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m04:00:19.682851 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 04:00:19.679093 => 04:00:19.682851
[0m04:00:19.682851 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m04:00:19.682851 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m04:00:19.682851 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:19.682851 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m04:00:20.034031 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9bb6e28-d648-440a-a8cb-97b5b8f5b4c8&page=queryresults
[0m04:00:20.398230 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0a3edf17-4e56-4662-a362-74422f558fe5&page=queryresults
[0m04:00:20.419691 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 04:00:19.277319 => 04:00:20.419691
[0m04:00:20.419691 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0BB5880>]}
[0m04:00:20.419691 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m04:00:20.419691 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m04:00:20.426070 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m04:00:20.426070 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m04:00:20.426070 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m04:00:20.426070 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m04:00:20.433296 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m04:00:20.435307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 04:00:20.426070 => 04:00:20.433296
[0m04:00:20.435307 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m04:00:20.435307 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m04:00:20.435307 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:20.435307 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m04:00:20.812620 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 04:00:19.682851 => 04:00:20.812620
[0m04:00:20.818975 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1DE1D90>]}
[0m04:00:20.818975 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m04:00:20.818975 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m04:00:20.824138 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:20.824138 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m04:00:20.826151 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m04:00:20.826151 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:20.834216 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:20.834216 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:20.826151 => 04:00:20.834216
[0m04:00:20.834216 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:20.867923 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:21.534926 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:21.534926 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:21.614719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a5af34bc-c5e8-4ffc-a0bd-7ae82e7340b2&page=queryresults
[0m04:00:21.996743 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 04:00:20.435307 => 04:00:21.996743
[0m04:00:21.996743 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C76D60>]}
[0m04:00:21.996743 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m04:00:21.996743 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m04:00:22.124834 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0aff4bc4-733d-40b1-9d6f-db121edd9c31&page=queryresults
[0m04:00:24.635968 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:20.834216 => 04:00:24.635968
[0m04:00:24.635968 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B086A3A0>]}
[0m04:00:24.635968 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.81s]
[0m04:00:24.635968 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:24.635968 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:24.635968 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m04:00:24.649789 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m04:00:24.649789 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:24.649789 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:24.649789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:24.649789 => 04:00:24.649789
[0m04:00:24.649789 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:24.663951 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:25.280932 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:25.282948 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m04:00:25.997270 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40a9aa6b-ada6-4c09-8208-245be819c48b&page=queryresults
[0m04:00:28.150960 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:24.649789 => 04:00:28.148947
[0m04:00:28.150960 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1E21D30>]}
[0m04:00:28.152973 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.51s]
[0m04:00:28.152973 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:28.152973 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:28.152973 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m04:00:28.152973 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m04:00:28.152973 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:28.152973 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:28.166101 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:28.152973 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m04:00:28.168110 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m04:00:28.168110 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m04:00:28.174138 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m04:00:28.178159 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 04:00:28.170120 => 04:00:28.176147
[0m04:00:28.178159 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m04:00:28.181921 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:28.181921 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:28.162081 => 04:00:28.181921
[0m04:00:28.181921 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:28.193073 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:28.880062 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m04:00:28.881820 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:28.881820 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m04:00:28.889221 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:29.433859 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d53cc3f-fe50-47b4-9e9a-db2cd5ab10a4&page=queryresults
[0m04:00:29.444311 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d5c2088f-ac62-494e-9da7-cb80a11907a5&page=queryresults
[0m04:00:31.372737 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:28.181921 => 04:00:31.372737
[0m04:00:31.372737 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C561F0>]}
[0m04:00:31.378251 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.22s]
[0m04:00:31.380263 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:31.380263 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m04:00:31.382273 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m04:00:31.382273 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m04:00:31.384283 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m04:00:31.388300 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:31.390312 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 04:00:31.384283 => 04:00:31.390312
[0m04:00:31.390312 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m04:00:31.394334 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:31.945017 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 04:00:28.178159 => 04:00:31.945017
[0m04:00:31.947033 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1E54F40>]}
[0m04:00:31.949048 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.78s]
[0m04:00:31.949048 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m04:00:31.951060 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m04:00:31.951060 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m04:00:31.953073 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m04:00:31.953073 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m04:00:31.959103 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m04:00:31.962866 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 04:00:31.953073 => 04:00:31.961114
[0m04:00:31.962866 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m04:00:31.966887 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:32.128579 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:32.128579 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:32.499460 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a4cc8bca-1c9f-4fd1-853d-de578692bccc&page=queryresults
[0m04:00:32.653459 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m04:00:32.669520 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m04:00:33.216715 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db8269f4-891c-41b9-b8ad-473d221506f6&page=queryresults
[0m04:00:34.179648 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 04:00:31.392323 => 04:00:34.179648
[0m04:00:34.179648 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1DB0220>]}
[0m04:00:34.195836 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 2.80s]
[0m04:00:34.195836 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m04:00:34.195836 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:34.195836 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m04:00:34.195836 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m04:00:34.195836 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:34.211625 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m04:00:34.211625 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 04:00:34.201319 => 04:00:34.211625
[0m04:00:34.221104 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:34.323214 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:34.951929 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m04:00:34.960267 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m04:00:35.307564 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71359b29-535b-49fb-9752-f38f76eeb82a&page=queryresults
[0m04:00:35.736169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 04:00:31.962866 => 04:00:35.736169
[0m04:00:35.736169 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C56790>]}
[0m04:00:35.736169 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.78s]
[0m04:00:35.736169 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m04:00:35.736169 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m04:00:35.736169 [info ] [Thread-1  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m04:00:35.736169 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m04:00:35.736169 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m04:00:35.752079 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m04:00:35.752079 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 04:00:35.736169 => 04:00:35.752079
[0m04:00:35.752079 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m04:00:35.752079 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:36.344075 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m04:00:36.344075 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m04:00:36.730326 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dbfca0b9-d9e6-43be-b1e4-4e21f1402544&page=queryresults
[0m04:00:37.217501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 04:00:34.221104 => 04:00:37.217501
[0m04:00:37.219508 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C6AA00>]}
[0m04:00:37.219508 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.02s]
[0m04:00:37.219508 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:37.219508 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m04:00:37.219508 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m04:00:37.219508 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m04:00:37.219508 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m04:00:37.229433 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m04:00:37.229433 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 04:00:37.219508 => 04:00:37.229433
[0m04:00:37.229433 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m04:00:37.229433 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:38.120073 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m04:00:38.122088 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m04:00:38.650997 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f85175a2-89b3-43e7-9b41-e3d36b8cdc42&page=queryresults
[0m04:00:38.950343 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 04:00:35.752079 => 04:00:38.950343
[0m04:00:38.950343 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C568B0>]}
[0m04:00:38.950343 [info ] [Thread-1  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.21s]
[0m04:00:38.950343 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m04:00:38.950343 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:38.950343 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m04:00:38.950343 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m04:00:38.950343 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:38.966140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m04:00:38.966140 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 04:00:38.950343 => 04:00:38.966140
[0m04:00:38.966140 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:38.981883 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:39.596724 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m04:00:39.596724 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m04:00:39.986463 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e435ea4-1b7e-4d57-975c-eaaabd3a12f6&page=queryresults
[0m04:00:41.122510 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 04:00:37.229433 => 04:00:41.122510
[0m04:00:41.122510 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C71EE0>]}
[0m04:00:41.846942 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 3.90s]
[0m04:00:41.846942 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m04:00:41.860478 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.862492 [info ] [Thread-2  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m04:00:41.864506 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m04:00:41.864506 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.872549 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m04:00:41.876570 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 04:00:41.864506 => 04:00:41.874557
[0m04:00:41.876570 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.880339 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:42.450308 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 04:00:38.966140 => 04:00:42.450308
[0m04:00:42.453331 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C56520>]}
[0m04:00:42.453331 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.50s]
[0m04:00:42.453331 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:42.457436 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m04:00:42.457436 [info ] [Thread-1  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m04:00:42.457436 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m04:00:42.461463 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m04:00:42.469243 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m04:00:42.472213 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 04:00:42.461463 => 04:00:42.470200
[0m04:00:42.472213 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m04:00:42.476234 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:42.527318 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m04:00:42.533183 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:43.154421 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:93b76fb5-e39e-4b3d-9c38-c0fa83ec37f0&page=queryresults
[0m04:00:43.167121 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m04:00:43.169135 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m04:00:43.562016 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:241bd272-a31d-4d08-bc50-a25feaf4e52f&page=queryresults
[0m04:00:45.618151 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 04:00:41.876570 => 04:00:45.618151
[0m04:00:45.618151 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B2E42790>]}
[0m04:00:45.618151 [info ] [Thread-2  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.76s]
[0m04:00:45.618151 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m04:00:46.099559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 04:00:42.472213 => 04:00:46.099559
[0m04:00:46.101571 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B1C719D0>]}
[0m04:00:46.101571 [info ] [Thread-1  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.64s]
[0m04:00:46.103586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m04:00:46.103586 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:46.107432 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m04:00:46.107432 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m04:00:46.110131 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:46.117673 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m04:00:46.117673 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 04:00:46.110131 => 04:00:46.117673
[0m04:00:46.123112 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:46.127138 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:46.735776 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m04:00:46.739808 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:47.339179 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39f619af-0562-4531-90cb-cb8f52723de6&page=queryresults
[0m04:00:50.120166 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 04:00:46.123112 => 04:00:50.118650
[0m04:00:50.120166 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157c76eb-e5e5-4a77-8d31-925bb864c8d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B086A3A0>]}
[0m04:00:50.120166 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.01s]
[0m04:00:50.123558 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:50.127030 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:50.127030 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:50.129044 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:50.129044 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:00:50.129044 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:50.129044 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m04:00:50.129044 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m04:00:50.131054 [info ] [MainThread]: 
[0m04:00:50.131054 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 44.54 seconds (44.54s).
[0m04:00:50.138864 [debug] [MainThread]: Command end result
[0m04:00:50.153982 [info ] [MainThread]: 
[0m04:00:50.153982 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:50.153982 [info ] [MainThread]: 
[0m04:00:50.153982 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m04:00:50.153982 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:50.153982 after 45.64 seconds
[0m04:00:50.162589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212AD2623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0953100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B0C5CA30>]}
[0m04:00:50.162589 [debug] [MainThread]: Flushing usage events
[0m04:00:54.359814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8BCBF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8BBB7A670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8BBB7AD90>]}


============================== 04:00:54.370915 | e5ebe5db-b636-411a-9cd1-307342e9a34c ==============================
[0m04:00:54.370915 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:54.370915 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:55.189352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8BBB69BB0>]}
[0m04:00:55.253025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C0258D60>]}
[0m04:00:55.253025 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:55.268998 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:55.333083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:55.333083 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:55.333083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C0556FA0>]}
[0m04:00:55.349915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C046E910>]}
[0m04:00:55.349915 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:55.349915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C046EC70>]}
[0m04:00:55.349915 [info ] [MainThread]: 
[0m04:00:55.349915 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:55.349915 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:55.349915 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:56.009268 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:56.009268 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:00:56.009268 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:56.009268 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:56.619320 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:56.619320 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:56.619320 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:00:56.635208 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:57.309694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C0564FD0>]}
[0m04:00:57.309694 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:57.309694 [info ] [MainThread]: 
[0m04:00:57.309694 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:57.325358 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m04:00:57.325358 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m04:00:57.325358 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:57.341204 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 04:00:57.325358 => 04:00:57.341204
[0m04:00:57.341204 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:57.404616 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:57.404616 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m04:00:58.128333 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e8d2c3d9-0c31-41b7-8c31-78ab9b2ec04b&page=queryresults
[0m04:00:59.191387 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m04:00:59.575652 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4195ecd9-94e1-4f39-a328-2a21fc923b48&page=queryresults
[0m04:01:01.875231 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m04:01:02.646765 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m04:01:02.662608 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m04:01:03.118609 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6fd1e5f-d281-4ad4-9333-c345e89fc060&page=queryresults
[0m04:01:05.337032 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 04:00:57.341204 => 04:01:05.337032
[0m04:01:05.337032 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e5ebe5db-b636-411a-9cd1-307342e9a34c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C164A670>]}
[0m04:01:05.337032 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.01s]
[0m04:01:05.337032 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:05.337032 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:05.337032 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:05.337032 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:01:05.337032 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:01:05.337032 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m04:01:05.337032 [info ] [MainThread]: 
[0m04:01:05.337032 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.99 seconds (9.99s).
[0m04:01:05.337032 [debug] [MainThread]: Command end result
[0m04:01:05.352827 [info ] [MainThread]: 
[0m04:01:05.352827 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:05.352827 [info ] [MainThread]: 
[0m04:01:05.352827 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:01:05.368588 [debug] [MainThread]: Command `dbt snapshot` succeeded at 04:01:05.368588 after 11.06 seconds
[0m04:01:05.368588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8BCBF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C0258D60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8C031F310>]}
[0m04:01:05.368588 [debug] [MainThread]: Flushing usage events
[0m04:01:09.622307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253300633D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002532EFDE9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002532EFDEB80>]}


============================== 04:01:09.638195 | f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726 ==============================
[0m04:01:09.638195 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:01:09.638195 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:01:10.495891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253321AAAF0>]}
[0m04:01:10.559801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253329A9A90>]}
[0m04:01:10.559801 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:01:10.575739 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:01:10.623780 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:01:10.623780 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:01:10.623780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253339C8550>]}
[0m04:01:10.639602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253338BD370>]}
[0m04:01:10.639602 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:01:10.639602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253338BD160>]}
[0m04:01:10.639602 [info ] [MainThread]: 
[0m04:01:10.639602 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:01:10.639602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:01:10.639602 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:11.314792 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:01:11.314792 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:01:11.314792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:11.314792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:12.007692 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m04:01:12.007692 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:12.039342 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:01:12.039342 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:12.649608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025333728A30>]}
[0m04:01:12.649608 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:01:12.649608 [info ] [MainThread]: 
[0m04:01:12.665347 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:12.665347 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m04:01:12.665347 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m04:01:12.665347 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:12.681147 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:12.681147 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 04:01:12.665347 => 04:01:12.681147
[0m04:01:12.681147 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:12.696996 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:01:13.306898 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:13.306898 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m04:01:13.677382 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e014cc72-53cf-419f-b970-526e6e3d223e&page=queryresults
[0m04:01:15.895830 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 04:01:12.681147 => 04:01:15.895830
[0m04:01:15.911744 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025334A762E0>]}
[0m04:01:15.911744 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.25s]
[0m04:01:15.911744 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:15.911744 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m04:01:15.915510 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m04:01:15.915510 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m04:01:15.915510 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m04:01:15.915510 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m04:01:15.915510 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 04:01:15.915510 => 04:01:15.915510
[0m04:01:15.915510 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m04:01:15.915510 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:01:16.539696 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m04:01:16.539696 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m04:01:16.861872 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:738a8142-98a5-4ff1-9c16-99cf1d98d8f8&page=queryresults
[0m04:01:18.487566 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 04:01:15.915510 => 04:01:18.487566
[0m04:01:18.487566 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8d81ce9-8ebb-48cd-810b-e2f4e3bdf726', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025334A42AF0>]}
[0m04:01:18.487566 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.57s]
[0m04:01:18.503374 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m04:01:18.503374 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:18.503374 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:18.503374 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m04:01:18.503374 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:01:18.503374 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m04:01:18.503374 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m04:01:18.503374 [info ] [MainThread]: 
[0m04:01:18.503374 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 7.86 seconds (7.86s).
[0m04:01:18.503374 [debug] [MainThread]: Command end result
[0m04:01:18.519485 [info ] [MainThread]: 
[0m04:01:18.519485 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:18.519485 [info ] [MainThread]: 
[0m04:01:18.535415 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m04:01:18.535415 [debug] [MainThread]: Command `dbt run` succeeded at 04:01:18.535415 after 8.96 seconds
[0m04:01:18.535415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000253300633D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533379D0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002533375E4C0>]}
[0m04:01:18.535415 [debug] [MainThread]: Flushing usage events
[0m05:00:04.633412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F0473460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EF3F06D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EF3F0E20>]}


============================== 05:00:04.633412 | adf1e5ec-5a01-4b2d-9d04-742085ff59ed ==============================
[0m05:00:04.633412 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:04.649294 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m05:00:05.445861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F25BAA90>]}
[0m05:00:05.510127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3AE3430>]}
[0m05:00:05.510127 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:05.526125 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:05.573848 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:05.573848 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:05.573848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3DD8610>]}
[0m05:00:05.589885 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3CD6430>]}
[0m05:00:05.589885 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:05.589885 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3CD6250>]}
[0m05:00:05.605053 [info ] [MainThread]: 
[0m05:00:05.605053 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:05.605053 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:05.605053 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:05.605053 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:05.605053 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:06.445739 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.136237 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m05:00:07.136237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.136237 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:07.136237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.955827 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:00:07.971666 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.987455 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m05:00:07.987455 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:08.607341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3B6E5B0>]}
[0m05:00:08.610834 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:08.610834 [info ] [MainThread]: 
[0m05:00:08.612676 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.612676 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.612676 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m05:00:08.612676 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:08.612676 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m05:00:08.612676 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.612676 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:08.648209 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:08.649467 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.657479 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:08.659478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:08.628663 => 05:00:08.658476
[0m05:00:08.660496 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.688942 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:08.689945 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:08.650503 => 05:00:08.688942
[0m05:00:08.689945 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.691877 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:08.692942 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:08.692942 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:08.694819 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m05:00:08.718109 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:09.536088 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8da55325-11a9-47da-8cdd-f66ff51eebdf&page=queryresults
[0m05:00:09.647988 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b307342e-2ef1-4302-bb0c-47e6b983582c&page=queryresults
[0m05:00:10.002064 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:08.661472 => 05:00:10.002064
[0m05:00:10.002064 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E2CFA0>]}
[0m05:00:10.002064 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m05:00:10.002064 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.002064 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.002064 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m05:00:10.002064 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:10.002064 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.018159 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.018159 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:10.002064 => 05:00:10.018159
[0m05:00:10.018159 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.018159 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.018159 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:10.018159 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:10.113676 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:08.689945 => 05:00:10.113676
[0m05:00:10.113676 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E2C1F0>]}
[0m05:00:10.113676 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m05:00:10.113676 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.113676 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m05:00:10.113676 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m05:00:10.113676 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m05:00:10.113676 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m05:00:10.129532 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m05:00:10.133610 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 05:00:10.113676 => 05:00:10.129532
[0m05:00:10.133610 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m05:00:10.139646 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m05:00:10.141654 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:10.143660 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m05:00:10.765003 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:135648a4-75be-4c8f-ac9f-a42773257f52&page=queryresults
[0m05:00:10.905987 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:232389cb-b5d7-4ba2-a15e-ad2bc25253a3&page=queryresults
[0m05:00:11.155536 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:10.018159 => 05:00:11.155536
[0m05:00:11.155536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E6C370>]}
[0m05:00:11.171406 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m05:00:11.171406 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.171406 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.171406 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m05:00:11.171406 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m05:00:11.171406 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.171406 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.171406 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 05:00:11.171406 => 05:00:11.171406
[0m05:00:11.171406 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.171406 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.171406 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:11.171406 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m05:00:11.332200 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 05:00:10.135624 => 05:00:11.332200
[0m05:00:11.332200 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F39910>]}
[0m05:00:11.332200 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m05:00:11.332200 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m05:00:11.343732 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.343732 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m05:00:11.343732 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m05:00:11.347140 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.348274 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.348274 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 05:00:11.347140 => 05:00:11.348274
[0m05:00:11.348274 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.348274 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.348274 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:11.348274 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m05:00:11.908679 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e399c138-9e8f-4b59-bf61-874667445075&page=queryresults
[0m05:00:12.150655 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f8bfa4a-a50f-427b-94f1-66936b5ff286&page=queryresults
[0m05:00:12.304685 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 05:00:11.171406 => 05:00:12.304685
[0m05:00:12.304685 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E6C370>]}
[0m05:00:12.311587 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m05:00:12.311587 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:12.311587 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m05:00:12.311587 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m05:00:12.311587 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m05:00:12.311587 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m05:00:12.311587 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m05:00:12.311587 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 05:00:12.311587 => 05:00:12.311587
[0m05:00:12.311587 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m05:00:12.327707 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m05:00:12.327707 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:12.327707 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m05:00:12.536436 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 05:00:11.348274 => 05:00:12.536436
[0m05:00:12.536436 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E6C310>]}
[0m05:00:12.552300 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m05:00:12.552300 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m05:00:12.552300 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m05:00:12.552300 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m05:00:12.552300 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m05:00:12.552300 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m05:00:12.552300 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m05:00:12.552300 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 05:00:12.552300 => 05:00:12.552300
[0m05:00:12.552300 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m05:00:12.552300 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m05:00:12.552300 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:12.552300 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m05:00:13.162897 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1bf4615-4524-44f4-bf35-98a5c9844773&page=queryresults
[0m05:00:13.387702 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:193d744a-4062-4466-b423-9c83652bbe90&page=queryresults
[0m05:00:13.534409 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 05:00:12.311587 => 05:00:13.534409
[0m05:00:13.534409 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E60460>]}
[0m05:00:13.534409 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m05:00:13.534409 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m05:00:13.534409 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.534409 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m05:00:13.534409 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m05:00:13.534409 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.548319 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.548319 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 05:00:13.534409 => 05:00:13.548319
[0m05:00:13.548319 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.564125 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.564125 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:13.564125 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m05:00:13.806019 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 05:00:12.552300 => 05:00:13.806019
[0m05:00:13.806019 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E6C310>]}
[0m05:00:13.806019 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m05:00:13.821949 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m05:00:13.821949 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m05:00:13.821949 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m05:00:13.821949 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m05:00:13.821949 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m05:00:13.821949 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m05:00:13.821949 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 05:00:13.821949 => 05:00:13.821949
[0m05:00:13.821949 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m05:00:13.821949 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m05:00:13.821949 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:13.821949 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m05:00:14.271378 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0d4a4fb-b935-43c6-a266-5b29aa6dd5c3&page=queryresults
[0m05:00:14.561405 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86c94af7-c152-496c-8e77-0e734b5be8f2&page=queryresults
[0m05:00:14.677079 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 05:00:13.548319 => 05:00:14.677079
[0m05:00:14.678071 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F521C0>]}
[0m05:00:14.679074 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m05:00:14.680076 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:14.681090 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:14.681090 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m05:00:14.681090 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m05:00:14.681090 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:14.683823 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:14.683823 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:14.681090 => 05:00:14.683823
[0m05:00:14.683823 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:14.691032 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:14.693035 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:14.695032 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:14.952616 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 05:00:13.821949 => 05:00:14.952616
[0m05:00:14.952616 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F06070>]}
[0m05:00:14.952616 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m05:00:14.952616 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m05:00:14.952616 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m05:00:14.952616 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m05:00:14.952616 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m05:00:14.952616 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m05:00:14.964589 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m05:00:14.964589 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 05:00:14.952616 => 05:00:14.964589
[0m05:00:14.964589 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m05:00:14.982299 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m05:00:14.982299 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:14.982299 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m05:00:15.414041 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e2549d6-d08e-41a8-8467-b891fb1a1f37&page=queryresults
[0m05:00:15.707543 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87fcac98-e832-4e2a-9714-a78ecb4d30c7&page=queryresults
[0m05:00:15.833504 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:14.688021 => 05:00:15.833504
[0m05:00:15.833504 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F39190>]}
[0m05:00:15.833504 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m05:00:15.833504 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:15.833504 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m05:00:15.833504 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m05:00:15.833504 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m05:00:15.833504 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m05:00:15.833504 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m05:00:15.849585 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 05:00:15.833504 => 05:00:15.849585
[0m05:00:15.849585 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m05:00:15.849585 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m05:00:15.849585 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:15.849585 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m05:00:16.107276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 05:00:14.964589 => 05:00:16.107276
[0m05:00:16.107276 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E2C8B0>]}
[0m05:00:16.107276 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m05:00:16.107276 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m05:00:16.107276 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m05:00:16.107276 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m05:00:16.107276 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m05:00:16.107276 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m05:00:16.123497 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m05:00:16.123497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 05:00:16.107276 => 05:00:16.123497
[0m05:00:16.123497 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m05:00:16.123497 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m05:00:16.123497 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:16.123497 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m05:00:16.621825 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:abeb323c-484a-4424-862d-fd571a37dd81&page=queryresults
[0m05:00:17.032376 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:752c1f11-f9df-4e1e-9334-a57245cd4887&page=queryresults
[0m05:00:17.285174 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 05:00:15.849585 => 05:00:17.285174
[0m05:00:17.285174 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E6C370>]}
[0m05:00:17.287184 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m05:00:17.289553 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m05:00:17.289553 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:17.289553 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m05:00:17.291561 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m05:00:17.291561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:17.297875 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:17.299886 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:17.293856 => 05:00:17.299886
[0m05:00:17.299886 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:17.321483 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:17.385091 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 05:00:16.123497 => 05:00:17.385091
[0m05:00:17.385091 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4E792B0>]}
[0m05:00:17.385091 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m05:00:17.399368 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m05:00:18.007895 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:18.007895 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:18.714563 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ecc52016-3764-4ac5-8a27-e648a9d910a3&page=queryresults
[0m05:00:21.195485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:17.301895 => 05:00:21.195485
[0m05:00:21.195485 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4E83490>]}
[0m05:00:21.199607 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.90s]
[0m05:00:21.199607 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:21.202389 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:21.202389 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m05:00:21.202389 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m05:00:21.206090 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:21.212117 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:21.212117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:21.206090 => 05:00:21.212117
[0m05:00:21.214127 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:21.217645 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:21.857311 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:21.859319 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m05:00:22.464616 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:718c10d3-afe6-4360-bd25-c2a68a788557&page=queryresults
[0m05:00:24.626320 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:21.214127 => 05:00:24.626320
[0m05:00:24.626320 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3DE3E20>]}
[0m05:00:24.626320 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.42s]
[0m05:00:24.626320 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:24.626320 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:24.626320 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m05:00:24.626320 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m05:00:24.626320 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m05:00:24.626320 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:24.626320 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m05:00:24.626320 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:24.626320 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m05:00:24.646444 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:24.646444 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m05:00:24.646444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:24.626320 => 05:00:24.646444
[0m05:00:24.646444 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:24.659654 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:24.661668 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 05:00:24.646444 => 05:00:24.661668
[0m05:00:24.661668 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m05:00:24.704606 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:25.373348 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:25.373348 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:25.405287 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m05:00:25.405287 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m05:00:25.952953 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15ce5563-a588-48f6-b392-556de3f8b85c&page=queryresults
[0m05:00:25.969150 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5be865d7-e1c3-46b9-a45d-727a4c56d4f1&page=queryresults
[0m05:00:27.930902 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:24.657644 => 05:00:27.930902
[0m05:00:27.930902 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4E8E580>]}
[0m05:00:27.930902 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.30s]
[0m05:00:27.930902 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:27.930902 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m05:00:27.930902 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m05:00:27.930902 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m05:00:27.930902 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m05:00:27.946978 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:27.946978 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 05:00:27.930902 => 05:00:27.946978
[0m05:00:27.946978 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m05:00:27.946978 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:28.204042 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 05:00:24.661668 => 05:00:28.204042
[0m05:00:28.204042 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4FB2CA0>]}
[0m05:00:28.204042 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.58s]
[0m05:00:28.204042 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m05:00:28.220098 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m05:00:28.220098 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m05:00:28.220098 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m05:00:28.220098 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m05:00:28.220098 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m05:00:28.220098 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 05:00:28.220098 => 05:00:28.220098
[0m05:00:28.220098 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m05:00:28.220098 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:28.605862 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:28.605862 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:28.885745 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m05:00:28.885745 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m05:00:28.991448 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7892a967-9b72-44e3-a6b7-19b39680843d&page=queryresults
[0m05:00:29.449615 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ccd232c8-d647-42d3-8b28-15d9a9e38c51&page=queryresults
[0m05:00:30.907220 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 05:00:27.946978 => 05:00:30.905203
[0m05:00:30.907220 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4FECE80>]}
[0m05:00:30.909234 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 2.98s]
[0m05:00:30.909234 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m05:00:30.912219 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:30.913732 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m05:00:30.913732 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m05:00:30.915744 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:30.931811 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m05:00:30.933824 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 05:00:30.915744 => 05:00:30.933824
[0m05:00:30.933824 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:31.009478 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:31.658389 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m05:00:31.661406 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m05:00:32.038849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7851f53-b7e6-4dda-87b6-34c127efd3e8&page=queryresults
[0m05:00:32.501925 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 05:00:28.220098 => 05:00:32.501925
[0m05:00:32.501925 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F25580>]}
[0m05:00:32.503939 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.28s]
[0m05:00:32.505694 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m05:00:32.505694 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m05:00:32.505694 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m05:00:32.505694 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m05:00:32.505694 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m05:00:32.505694 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m05:00:32.505694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 05:00:32.505694 => 05:00:32.505694
[0m05:00:32.505694 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m05:00:32.523508 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:33.305856 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m05:00:33.305856 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m05:00:33.668528 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a797e274-d1db-4a2e-a822-419f4a5ddd94&page=queryresults
[0m05:00:33.954689 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 05:00:30.935839 => 05:00:33.954689
[0m05:00:33.954689 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F60335E0>]}
[0m05:00:33.958688 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.04s]
[0m05:00:33.958688 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:33.960701 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m05:00:33.960701 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m05:00:33.963366 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m05:00:33.963366 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m05:00:33.966441 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m05:00:33.966441 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 05:00:33.963366 => 05:00:33.966441
[0m05:00:33.966441 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m05:00:33.966441 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:34.593599 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m05:00:34.609575 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m05:00:35.312166 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0fe1274-9cdb-4bdf-8843-bbabf5b13c1e&page=queryresults
[0m05:00:35.921704 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 05:00:32.505694 => 05:00:35.919687
[0m05:00:35.921704 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F28970>]}
[0m05:00:35.923719 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.42s]
[0m05:00:35.925735 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m05:00:35.925735 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:35.927851 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m05:00:35.927851 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m05:00:35.930921 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:35.942986 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m05:00:35.942986 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 05:00:35.930921 => 05:00:35.942986
[0m05:00:35.942986 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:35.942986 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:36.722545 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m05:00:36.725647 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m05:00:37.162356 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b786ab44-e638-41d6-ac24-e938dacd3e78&page=queryresults
[0m05:00:38.138966 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 05:00:33.966441 => 05:00:38.138966
[0m05:00:38.140982 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F14040>]}
[0m05:00:38.837863 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.18s]
[0m05:00:38.837863 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m05:00:38.837863 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m05:00:38.837863 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m05:00:38.837863 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m05:00:38.837863 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m05:00:38.850095 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m05:00:38.853856 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 05:00:38.837863 => 05:00:38.853856
[0m05:00:38.853856 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m05:00:38.857873 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:39.650617 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 05:00:35.942986 => 05:00:39.650617
[0m05:00:39.651616 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F28D30>]}
[0m05:00:39.652615 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.72s]
[0m05:00:39.653615 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:39.656137 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m05:00:39.657138 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m05:00:39.659157 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m05:00:39.660156 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m05:00:39.677156 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m05:00:39.680261 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m05:00:39.685159 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:39.692158 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 05:00:39.660156 => 05:00:39.692158
[0m05:00:39.693156 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m05:00:39.695310 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:40.285868 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8a3b78c-649e-4ce7-a54f-df4f220a3b2d&page=queryresults
[0m05:00:40.358155 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m05:00:40.362179 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m05:00:40.787245 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a48f90ac-308f-4fc7-b36e-9d660a683c7f&page=queryresults
[0m05:00:43.033183 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 05:00:38.853856 => 05:00:43.033183
[0m05:00:43.033183 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F77D00>]}
[0m05:00:43.033183 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.20s]
[0m05:00:43.033183 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m05:00:43.883810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 05:00:39.693156 => 05:00:43.883810
[0m05:00:43.883810 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F4F91250>]}
[0m05:00:43.883810 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.23s]
[0m05:00:43.883810 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m05:00:43.883810 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:43.899502 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m05:00:43.899502 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m05:00:43.899502 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:43.914913 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m05:00:43.914913 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 05:00:43.899502 => 05:00:43.914913
[0m05:00:43.914913 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:43.914913 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:44.538678 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m05:00:44.538678 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:45.154586 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a2337edb-2935-410c-ad84-2d6d1a226fd3&page=queryresults
[0m05:00:48.193384 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 05:00:43.914913 => 05:00:48.193384
[0m05:00:48.193384 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adf1e5ec-5a01-4b2d-9d04-742085ff59ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F60564F0>]}
[0m05:00:48.193384 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.29s]
[0m05:00:48.195389 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:48.196855 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m05:00:48.196855 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m05:00:48.196855 [info ] [MainThread]: 
[0m05:00:48.196855 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 42.59 seconds (42.59s).
[0m05:00:48.200865 [debug] [MainThread]: Command end result
[0m05:00:48.208888 [info ] [MainThread]: 
[0m05:00:48.208888 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:48.208888 [info ] [MainThread]: 
[0m05:00:48.208888 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m05:00:48.208888 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:48.208888 after 43.63 seconds
[0m05:00:48.208888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F0473460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3E26D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5F3A6EF70>]}
[0m05:00:48.208888 [debug] [MainThread]: Flushing usage events
[0m05:00:51.859100 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AC753430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AB6D7670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AB6D7D90>]}


============================== 05:00:51.859100 | 990bab4a-a6f4-41cd-8a36-c7d063946761 ==============================
[0m05:00:51.859100 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:51.859100 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:52.721987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AB6C9940>]}
[0m05:00:52.786272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AFCBFE80>]}
[0m05:00:52.786272 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:52.786272 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:52.834491 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:52.834491 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:52.834491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6B00B6EE0>]}
[0m05:00:52.850537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AFFCDE50>]}
[0m05:00:52.850537 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:52.850537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AFFCDC10>]}
[0m05:00:52.866530 [info ] [MainThread]: 
[0m05:00:52.868537 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:52.868537 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:52.868537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:53.734192 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m05:00:53.734192 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:53.734192 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:53.734192 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:54.327432 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m05:00:54.327432 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:54.343359 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:00:54.343359 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:54.960851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AFDFBE50>]}
[0m05:00:54.960851 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:54.960851 [info ] [MainThread]: 
[0m05:00:54.974063 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:54.974063 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m05:00:54.974063 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m05:00:54.982088 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:55.002206 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 05:00:54.982088 => 05:00:55.002206
[0m05:00:55.002206 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:55.053723 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:55.053723 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m05:00:55.899615 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84c516ba-b70d-4e0b-b8be-7c4e76961db9&page=queryresults
[0m05:00:56.959285 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m05:00:57.376979 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42d29f8c-88ee-4c53-9e36-ac6d90b254ef&page=queryresults
[0m05:00:59.687440 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m05:01:00.409044 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m05:01:00.409044 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m05:01:00.798353 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c6ea540f-e786-4079-88eb-ef62cbad9fc7&page=queryresults
[0m05:01:02.997567 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 05:00:55.002206 => 05:01:02.997567
[0m05:01:02.997567 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '990bab4a-a6f4-41cd-8a36-c7d063946761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6B1133B80>]}
[0m05:01:02.997567 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.02s]
[0m05:01:02.997567 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:01:03.006574 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:03.006574 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:03.006574 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:01:03.006574 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m05:01:03.006574 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m05:01:03.006574 [info ] [MainThread]: 
[0m05:01:03.006574 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.14 seconds (10.14s).
[0m05:01:03.006574 [debug] [MainThread]: Command end result
[0m05:01:03.022465 [info ] [MainThread]: 
[0m05:01:03.022465 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:03.022465 [info ] [MainThread]: 
[0m05:01:03.022465 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m05:01:03.022465 [debug] [MainThread]: Command `dbt snapshot` succeeded at 05:01:03.022465 after 11.23 seconds
[0m05:01:03.038591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AC753430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6AFCBFE80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6B11813A0>]}
[0m05:01:03.038591 [debug] [MainThread]: Flushing usage events
[0m05:01:07.146405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA9BE9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA8B639A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA8B63D30>]}


============================== 05:01:07.146405 | 92613784-0da0-4010-8962-143291c96c78 ==============================
[0m05:01:07.146405 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:01:07.146405 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m05:01:07.978167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA8B52B20>]}
[0m05:01:08.041750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD1567F0>]}
[0m05:01:08.041750 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:01:08.057866 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:01:08.105851 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:01:08.105851 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:01:08.105851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD56A1F0>]}
[0m05:01:08.121541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD47F100>]}
[0m05:01:08.121541 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:01:08.121541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD451040>]}
[0m05:01:08.131965 [info ] [MainThread]: 
[0m05:01:08.131965 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:01:08.131965 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:01:08.131965 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:08.844627 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m05:01:08.853000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:08.853000 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:01:08.853000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:09.442731 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m05:01:09.442731 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:09.485200 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m05:01:09.485200 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:10.087735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD2AAB50>]}
[0m05:01:10.087735 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:01:10.087735 [info ] [MainThread]: 
[0m05:01:10.103503 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:10.103503 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m05:01:10.106028 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m05:01:10.106028 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:10.119201 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:10.119201 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 05:01:10.106028 => 05:01:10.119201
[0m05:01:10.119201 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:10.135032 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:01:10.939357 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:10.939357 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m05:01:11.266880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9479e687-dede-4dc7-9a2b-f9707335d31a&page=queryresults
[0m05:01:13.504643 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 05:01:10.119201 => 05:01:13.504643
[0m05:01:13.504643 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAE5E56A0>]}
[0m05:01:13.504643 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.40s]
[0m05:01:13.504643 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:13.504643 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m05:01:13.504643 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m05:01:13.504643 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m05:01:13.504643 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m05:01:13.504643 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m05:01:13.504643 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 05:01:13.504643 => 05:01:13.504643
[0m05:01:13.504643 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m05:01:13.504643 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:01:14.119221 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m05:01:14.135122 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m05:01:14.508716 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6ea91666-fec0-4369-9304-239855a6f49a&page=queryresults
[0m05:01:16.415029 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 05:01:13.504643 => 05:01:16.415029
[0m05:01:16.415029 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92613784-0da0-4010-8962-143291c96c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAE65CD60>]}
[0m05:01:16.415029 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.91s]
[0m05:01:16.415029 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m05:01:16.415029 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:16.415029 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:16.415029 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m05:01:16.415029 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m05:01:16.415029 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m05:01:16.430943 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m05:01:16.430943 [info ] [MainThread]: 
[0m05:01:16.430943 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.30 seconds (8.30s).
[0m05:01:16.430943 [debug] [MainThread]: Command end result
[0m05:01:16.466980 [info ] [MainThread]: 
[0m05:01:16.466980 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:16.466980 [info ] [MainThread]: 
[0m05:01:16.466980 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m05:01:16.466980 [debug] [MainThread]: Command `dbt run` succeeded at 05:01:16.466980 after 9.38 seconds
[0m05:01:16.466980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA9BE9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AA8B63160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD1EFE50>]}
[0m05:01:16.466980 [debug] [MainThread]: Flushing usage events
[0m06:00:05.108350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A747559460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7464EF6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7464EFE50>]}


============================== 06:00:05.124370 | f8cce230-3e61-42a8-a01b-49d0f6f8465a ==============================
[0m06:00:05.124370 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:05.124370 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m06:00:05.936308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A7464D5940>]}
[0m06:00:06.000195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74ABD3490>]}
[0m06:00:06.000195 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:06.000195 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:06.048161 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:06.048161 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:06.064087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AEC8670>]}
[0m06:00:06.080050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74ADC6490>]}
[0m06:00:06.080050 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:06.080050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74ADC6280>]}
[0m06:00:06.080050 [info ] [MainThread]: 
[0m06:00:06.080050 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:06.080050 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.080050 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.080050 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.080050 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.979145 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:07.682601 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:07.683602 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.683602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:07.684594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.334047 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:08.334047 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m06:00:08.334047 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.334047 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:09.007536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AC54970>]}
[0m06:00:09.007536 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:09.007536 [info ] [MainThread]: 
[0m06:00:09.007536 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.007536 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.007536 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m06:00:09.023663 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:09.023663 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.023663 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.023663 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m06:00:09.023663 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:09.023663 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.039745 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.039745 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:09.023663 => 06:00:09.039745
[0m06:00:09.039745 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.087876 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:09.023663 => 06:00:09.087876
[0m06:00:09.087876 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.087876 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.087876 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.087876 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:09.087876 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:09.087876 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m06:00:09.119656 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:09.956901 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8cedb0f3-ede1-4437-bd02-2e780c392a41&page=queryresults
[0m06:00:10.017780 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c473f352-6d82-44a9-b7dc-c4e3a063387d&page=queryresults
[0m06:00:10.435099 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:09.039745 => 06:00:10.435099
[0m06:00:10.435099 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BF84850>]}
[0m06:00:10.450957 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:09.087876 => 06:00:10.450957
[0m06:00:10.450957 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m06:00:10.450957 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BFDFB20>]}
[0m06:00:10.450957 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:10.450957 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.450957 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m06:00:10.450957 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:10.450957 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m06:00:10.450957 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m06:00:10.450957 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m06:00:10.450957 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:10.450957 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m06:00:10.450957 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.450957 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m06:00:10.450957 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m06:00:10.466724 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.466724 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 06:00:10.450957 => 06:00:10.466724
[0m06:00:10.466724 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m06:00:10.482652 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m06:00:10.482652 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:10.450957 => 06:00:10.482652
[0m06:00:10.482652 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.482652 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.482652 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:10.498539 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m06:00:10.530170 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.530170 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:11.309148 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c6b2c53c-bab4-480f-a9b8-3ef50655ae8b&page=queryresults
[0m06:00:11.309148 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:28a6bc22-cfeb-41ac-b8bf-498361d37dfb&page=queryresults
[0m06:00:11.744241 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 06:00:10.482652 => 06:00:11.744241
[0m06:00:11.744241 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:10.482652 => 06:00:11.744241
[0m06:00:11.744241 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BF41C40>]}
[0m06:00:11.744241 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BFCB1F0>]}
[0m06:00:11.744241 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m06:00:11.759990 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m06:00:11.759990 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m06:00:11.759990 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.759990 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.759990 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.759990 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m06:00:11.759990 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m06:00:11.759990 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m06:00:11.759990 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m06:00:11.759990 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.759990 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.776159 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.787328 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:11.789336 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 06:00:11.759990 => 06:00:11.789336
[0m06:00:11.792348 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 06:00:11.759990 => 06:00:11.792348
[0m06:00:11.792348 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m06:00:11.792348 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.792348 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:11.808116 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:11.808116 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:11.808116 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:11.808116 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m06:00:11.808116 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m06:00:12.696391 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:326e25f0-a035-4d05-bf2c-c9c13aa5ff0d&page=queryresults
[0m06:00:12.740299 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac320caa-0697-44c7-9775-a21654bee5b2&page=queryresults
[0m06:00:13.078464 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 06:00:11.792348 => 06:00:13.078464
[0m06:00:13.078464 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AC7AD30>]}
[0m06:00:13.078464 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m06:00:13.078464 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m06:00:13.078464 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m06:00:13.078464 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m06:00:13.078464 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_compra)
[0m06:00:13.078464 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m06:00:13.078464 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m06:00:13.094497 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 06:00:13.078464 => 06:00:13.094497
[0m06:00:13.094497 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m06:00:13.094497 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m06:00:13.094497 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:13.094497 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m06:00:13.126221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 06:00:11.792348 => 06:00:13.126221
[0m06:00:13.126221 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BF51B50>]}
[0m06:00:13.126221 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m06:00:13.126221 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:13.126221 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m06:00:13.126221 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m06:00:13.126221 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m06:00:13.126221 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m06:00:13.141891 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m06:00:13.141891 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 06:00:13.126221 => 06:00:13.141891
[0m06:00:13.141891 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m06:00:13.141891 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m06:00:13.141891 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:13.141891 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m06:00:13.866203 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ff3d15b0-e728-4521-8777-af31903cbc80&page=queryresults
[0m06:00:13.886204 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f984f9a0-3209-438e-8230-0e66bcbf50aa&page=queryresults
[0m06:00:14.229924 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 06:00:13.094497 => 06:00:14.229924
[0m06:00:14.229924 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C0623D0>]}
[0m06:00:14.229924 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m06:00:14.229924 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m06:00:14.229924 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.245105 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m06:00:14.245105 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m06:00:14.245105 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.245105 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:14.245105 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 06:00:14.245105 => 06:00:14.245105
[0m06:00:14.245105 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.245105 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:14.245105 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:14.245105 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m06:00:14.296129 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 06:00:13.141891 => 06:00:14.296129
[0m06:00:14.296129 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74ADF3550>]}
[0m06:00:14.298139 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m06:00:14.300147 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m06:00:14.300147 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m06:00:14.302153 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m06:00:14.304161 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m06:00:14.304161 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m06:00:14.311194 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m06:00:14.313202 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 06:00:14.304161 => 06:00:14.311194
[0m06:00:14.313202 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m06:00:14.317218 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m06:00:14.317218 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:14.317218 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m06:00:14.986535 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf25495d-3c08-4bfb-b9ca-9a82ac84a812&page=queryresults
[0m06:00:15.372601 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 06:00:14.245105 => 06:00:15.372601
[0m06:00:15.372601 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BFC8490>]}
[0m06:00:15.372601 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m06:00:15.372601 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:15.372601 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:15.372601 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m06:00:15.372601 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m06:00:15.372601 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:15.390431 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:15.392447 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:15.372601 => 06:00:15.392447
[0m06:00:15.394463 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:15.398488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:15.400497 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:15.402507 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:15.500282 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1c4fc71-ca0b-44a3-810e-68847cf804c2&page=queryresults
[0m06:00:15.900111 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 06:00:14.313202 => 06:00:15.900111
[0m06:00:15.900111 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AF18AF0>]}
[0m06:00:15.900111 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.60s]
[0m06:00:15.900111 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m06:00:15.900111 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.900111 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m06:00:15.900111 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m06:00:15.900111 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.916060 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m06:00:15.916060 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 06:00:15.900111 => 06:00:15.916060
[0m06:00:15.916060 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.916060 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m06:00:15.916060 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:15.916060 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m06:00:16.108581 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3f45285-8ab5-4801-bd04-2a77411ae422&page=queryresults
[0m06:00:16.510835 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:15.394463 => 06:00:16.510835
[0m06:00:16.510835 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74ADF3E20>]}
[0m06:00:16.510835 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m06:00:16.526323 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:16.526323 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m06:00:16.526323 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m06:00:16.526323 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m06:00:16.526323 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m06:00:16.526323 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m06:00:16.542316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 06:00:16.526323 => 06:00:16.526323
[0m06:00:16.542316 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m06:00:16.542316 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m06:00:16.542316 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:16.542316 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m06:00:16.606125 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:785b4757-2a5c-49fb-aa47-ee484453d1fc&page=queryresults
[0m06:00:16.981650 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 06:00:15.916060 => 06:00:16.981650
[0m06:00:16.997631 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AF41CD0>]}
[0m06:00:16.997631 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m06:00:16.997631 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m06:00:16.997631 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m06:00:16.997631 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m06:00:16.997631 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m06:00:16.997631 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m06:00:17.019668 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m06:00:17.021685 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 06:00:17.009123 => 06:00:17.019668
[0m06:00:17.021685 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m06:00:17.027726 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m06:00:17.031254 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:17.035287 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m06:00:17.570500 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:53fb59c0-ba80-4dff-874f-254514702e4b&page=queryresults
[0m06:00:17.947790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 06:00:16.542316 => 06:00:17.947790
[0m06:00:17.947790 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C0D14F0>]}
[0m06:00:17.947790 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m06:00:17.947790 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m06:00:17.947790 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:17.953386 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m06:00:17.955404 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m06:00:17.955404 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:17.963450 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:17.965461 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:17.955404 => 06:00:17.965461
[0m06:00:17.967474 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:17.987078 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:18.026528 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb638bc2-2dd8-4d2b-9f63-20fb3abe1eb5&page=queryresults
[0m06:00:18.418202 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 06:00:17.021685 => 06:00:18.418202
[0m06:00:18.420215 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C0E6F40>]}
[0m06:00:18.420215 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m06:00:18.422760 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m06:00:18.811851 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:18.811851 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:19.484810 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:53ffb487-77c4-4043-83d6-acdfa57061f9&page=queryresults
[0m06:00:22.047875 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:17.967474 => 06:00:22.047875
[0m06:00:22.047875 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AC7AD30>]}
[0m06:00:22.050551 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.09s]
[0m06:00:22.050551 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:22.053914 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:22.053914 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m06:00:22.053914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m06:00:22.058351 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:22.064385 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:22.066398 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:22.058351 => 06:00:22.066398
[0m06:00:22.068411 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:22.072432 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:22.696430 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:22.698443 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m06:00:23.351982 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd4d49df-edea-41ab-9c0c-4cbf90ab8456&page=queryresults
[0m06:00:25.523226 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:22.068411 => 06:00:25.523226
[0m06:00:25.525235 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C0C5C70>]}
[0m06:00:25.525235 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.47s]
[0m06:00:25.525235 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:25.525235 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:25.525235 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m06:00:25.530937 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m06:00:25.530937 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:25.530937 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:25.530937 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:25.530937 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m06:00:25.530937 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m06:00:25.530937 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m06:00:25.548863 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m06:00:25.548863 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:25.530937 => 06:00:25.548863
[0m06:00:25.548863 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:25.554699 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:25.556712 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 06:00:25.543093 => 06:00:25.556712
[0m06:00:25.556712 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m06:00:25.562659 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:26.152498 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:26.152498 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:26.238279 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m06:00:26.240293 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m06:00:26.734056 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d9054db2-becc-4143-a3c5-22776a4c4c50&page=queryresults
[0m06:00:26.845547 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:14cc7185-6043-4a88-a32d-33aa040a6ca7&page=queryresults
[0m06:00:28.940889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:25.552689 => 06:00:28.940889
[0m06:00:28.942898 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D1341F0>]}
[0m06:00:28.942898 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.41s]
[0m06:00:28.942898 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:28.942898 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m06:00:28.944908 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m06:00:28.944908 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m06:00:28.944908 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m06:00:28.946917 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:28.946917 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 06:00:28.944908 => 06:00:28.946917
[0m06:00:28.946917 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m06:00:28.952256 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:29.128307 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 06:00:25.556712 => 06:00:29.112331
[0m06:00:29.130322 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D18A580>]}
[0m06:00:29.130322 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.60s]
[0m06:00:29.132336 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m06:00:29.132336 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m06:00:29.134347 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m06:00:29.136413 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m06:00:29.136413 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m06:00:29.144200 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m06:00:29.146213 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 06:00:29.136413 => 06:00:29.146213
[0m06:00:29.146213 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m06:00:29.146213 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:29.781013 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:29.783031 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:29.996827 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m06:00:29.998840 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m06:00:30.132566 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5451adb1-c59c-4713-9ff8-1920bb6d940f&page=queryresults
[0m06:00:30.626660 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3dea116b-b087-4583-9f07-2c87f3b465f3&page=queryresults
[0m06:00:31.911646 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 06:00:28.946917 => 06:00:31.911646
[0m06:00:31.911646 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D12FDF0>]}
[0m06:00:31.911646 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 2.97s]
[0m06:00:31.911646 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m06:00:31.911646 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:31.911646 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m06:00:31.920174 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m06:00:31.920174 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:31.926201 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m06:00:31.927725 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 06:00:31.922183 => 06:00:31.927725
[0m06:00:31.927725 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:31.927725 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:32.579314 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m06:00:32.583339 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m06:00:33.081511 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae9e1683-2112-4245-8896-319154556607&page=queryresults
[0m06:00:33.147184 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 06:00:29.146213 => 06:00:33.147184
[0m06:00:33.147184 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D10E2E0>]}
[0m06:00:33.147184 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.01s]
[0m06:00:33.162555 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m06:00:33.169238 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.169238 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m06:00:33.169238 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m06:00:33.169238 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.169238 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m06:00:33.169238 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 06:00:33.169238 => 06:00:33.169238
[0m06:00:33.169238 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.178497 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:33.807409 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m06:00:33.809426 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m06:00:34.139562 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de0dd04f-d2da-407d-a159-2c2215fa29ec&page=queryresults
[0m06:00:35.115486 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 06:00:31.927725 => 06:00:35.113473
[0m06:00:35.115486 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D1443A0>]}
[0m06:00:35.117501 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.20s]
[0m06:00:35.117501 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:35.117501 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.117501 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m06:00:35.122791 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m06:00:35.122791 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.130529 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m06:00:35.132541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 06:00:35.122791 => 06:00:35.132541
[0m06:00:35.133552 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.137577 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:35.868058 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m06:00:35.870072 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m06:00:36.474600 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:10c52bfc-7b51-41b7-a0e3-49e1d047d61f&page=queryresults
[0m06:00:36.654155 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 06:00:33.169238 => 06:00:36.652141
[0m06:00:36.656103 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D1BAE80>]}
[0m06:00:36.657099 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.49s]
[0m06:00:36.659003 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m06:00:36.660575 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:36.661588 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m06:00:36.663590 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m06:00:36.664588 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:36.673122 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m06:00:36.676123 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 06:00:36.664588 => 06:00:36.676123
[0m06:00:36.677111 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:36.685112 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:37.368891 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m06:00:37.370904 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m06:00:37.712868 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a1d0450-bb57-43df-956b-4cc541c4bd09&page=queryresults
[0m06:00:39.840756 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 06:00:35.133552 => 06:00:39.840756
[0m06:00:39.840756 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C115DF0>]}
[0m06:00:39.931243 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 06:00:36.678111 => 06:00:39.929230
[0m06:00:39.931243 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BF742E0>]}
[0m06:00:40.549688 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.72s]
[0m06:00:40.549688 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m06:00:40.549688 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m06:00:40.549688 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.27s]
[0m06:00:40.549688 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:40.560637 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m06:00:40.549688 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m06:00:40.560637 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m06:00:40.563553 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m06:00:40.569583 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m06:00:40.560637 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m06:00:40.571594 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m06:00:40.573602 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m06:00:40.580127 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 06:00:40.563553 => 06:00:40.579268
[0m06:00:40.580127 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m06:00:40.584145 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:40.584145 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m06:00:40.618316 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 06:00:40.573602 => 06:00:40.618316
[0m06:00:40.618316 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m06:00:40.618316 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:41.362422 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m06:00:41.366449 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m06:00:41.368466 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:41.373675 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m06:00:41.843152 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e7f0e059-9735-4877-9d82-6ed80c5776f1&page=queryresults
[0m06:00:41.977333 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6dc2f453-2d5e-4f12-8c70-7d8e61e4c0e0&page=queryresults
[0m06:00:44.228787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 06:00:40.580127 => 06:00:44.228787
[0m06:00:44.230800 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C115F40>]}
[0m06:00:44.230800 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.67s]
[0m06:00:44.232812 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m06:00:44.610856 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 06:00:40.618316 => 06:00:44.610856
[0m06:00:44.610856 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74BF41130>]}
[0m06:00:44.610856 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.04s]
[0m06:00:44.610856 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m06:00:44.618249 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:44.618249 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m06:00:44.618249 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m06:00:44.618249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:44.628851 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m06:00:44.628851 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 06:00:44.621815 => 06:00:44.628851
[0m06:00:44.632391 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:44.640431 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:45.264906 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m06:00:45.264906 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:45.852881 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66ff5ff6-5599-4e84-be5f-4e4a51676ff3&page=queryresults
[0m06:00:49.231618 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 06:00:44.632391 => 06:00:49.215639
[0m06:00:49.231618 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8cce230-3e61-42a8-a01b-49d0f6f8465a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74D144670>]}
[0m06:00:49.231618 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.61s]
[0m06:00:49.231618 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:49.231618 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m06:00:49.231618 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m06:00:49.231618 [info ] [MainThread]: 
[0m06:00:49.231618 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 43.15 seconds (43.15s).
[0m06:00:49.247547 [debug] [MainThread]: Command end result
[0m06:00:49.263574 [info ] [MainThread]: 
[0m06:00:49.263574 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:49.263574 [info ] [MainThread]: 
[0m06:00:49.263574 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m06:00:49.263574 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:49.263574 after 44.24 seconds
[0m06:00:49.271019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A747559460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74AC98730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A74C0F1CD0>]}
[0m06:00:49.271019 [debug] [MainThread]: Flushing usage events
[0m06:00:54.231554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000164392C24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000164382479D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016438247B80>]}


============================== 06:00:54.231554 | 740d6b8a-9c6e-4891-9579-32be29d13fcd ==============================
[0m06:00:54.231554 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:54.231554 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m06:00:55.125423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016438231130>]}
[0m06:00:55.216748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643C92E700>]}
[0m06:00:55.216748 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:55.232510 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:55.355527 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:55.355527 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:55.359281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643CC27850>]}
[0m06:00:55.375391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643CB25670>]}
[0m06:00:55.375391 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:55.375391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643CB25490>]}
[0m06:00:55.375391 [info ] [MainThread]: 
[0m06:00:55.391430 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:55.391430 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:55.391430 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:56.067903 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:56.082314 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:56.083866 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:56.116022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:56.726796 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:56.726796 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m06:00:56.726796 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:56.726796 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:57.370261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643C9966D0>]}
[0m06:00:57.370261 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:57.370261 [info ] [MainThread]: 
[0m06:00:57.386271 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.386271 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m06:00:57.386271 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m06:00:57.386271 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.402193 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 06:00:57.386271 => 06:00:57.402193
[0m06:00:57.402193 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.450336 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:57.450336 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m06:00:58.318467 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9db3fc86-f4e8-4f5d-a631-4e81e40c3fe5&page=queryresults
[0m06:00:59.366571 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m06:00:59.753389 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41909333-2f3a-4064-b4b7-ab1567bd8e74&page=queryresults
[0m06:01:02.135078 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m06:01:02.857770 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m06:01:02.857770 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m06:01:03.313386 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0e13a1fb-3965-4a81-9e3b-5e7b239397ce&page=queryresults
[0m06:01:05.281020 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 06:00:57.402193 => 06:01:05.281020
[0m06:01:05.281020 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '740d6b8a-9c6e-4891-9579-32be29d13fcd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643DD01550>]}
[0m06:01:05.286194 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 7.89s]
[0m06:01:05.286194 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:01:05.286194 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:01:05.286194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:01:05.286194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:01:05.286194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:01:05.286194 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m06:01:05.286194 [info ] [MainThread]: 
[0m06:01:05.286194 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.91 seconds (9.91s).
[0m06:01:05.286194 [debug] [MainThread]: Command end result
[0m06:01:05.312820 [info ] [MainThread]: 
[0m06:01:05.312820 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:01:05.312820 [info ] [MainThread]: 
[0m06:01:05.312820 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m06:01:05.312820 [debug] [MainThread]: Command `dbt snapshot` succeeded at 06:01:05.312820 after 11.17 seconds
[0m06:01:05.312820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000164392C24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643C92E700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001643C83E160>]}
[0m06:01:05.319037 [debug] [MainThread]: Flushing usage events
[0m06:01:09.029794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBC8543400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBC74C1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBC74C1B80>]}


============================== 06:01:09.045504 | 1d7c8aba-75f8-4313-8705-b2ce6fe9ff27 ==============================
[0m06:01:09.045504 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:01:09.045504 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m06:01:09.901540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBC74AF040>]}
[0m06:01:09.965633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBBA2BE0>]}
[0m06:01:09.965633 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:01:09.981651 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:01:10.029600 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:01:10.029600 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:01:10.029600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBEA8A90>]}
[0m06:01:10.045576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBDBF8B0>]}
[0m06:01:10.045576 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:01:10.045576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBDBF6D0>]}
[0m06:01:10.045576 [info ] [MainThread]: 
[0m06:01:10.045576 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:01:10.061637 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:01:10.061637 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:10.767674 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:01:10.767674 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:01:10.767674 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:10.767674 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:11.375302 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:01:11.391476 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:01:11.391476 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m06:01:11.391476 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:01:12.002419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBB2EB20>]}
[0m06:01:12.002419 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:01:12.002419 [info ] [MainThread]: 
[0m06:01:12.002419 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:12.002419 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m06:01:12.002419 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m06:01:12.017735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:12.033810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:12.033810 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 06:01:12.017735 => 06:01:12.033810
[0m06:01:12.033810 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:12.049866 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:01:12.704477 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:12.706379 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m06:01:13.048901 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e8140624-95d4-4326-9e89-cb21bc0a8d97&page=queryresults
[0m06:01:16.101282 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 06:01:12.033810 => 06:01:16.101282
[0m06:01:16.101282 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCCF21F40>]}
[0m06:01:16.101282 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 4.10s]
[0m06:01:16.117179 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:16.118550 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m06:01:16.118550 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m06:01:16.118550 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m06:01:16.118550 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m06:01:16.118550 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m06:01:16.118550 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 06:01:16.118550 => 06:01:16.118550
[0m06:01:16.118550 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m06:01:16.130009 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:01:16.764042 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m06:01:16.766053 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m06:01:17.114175 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be3e8e6e-71a8-4744-84c7-4222e0e0cd31&page=queryresults
[0m06:01:20.127980 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 06:01:16.130009 => 06:01:20.127980
[0m06:01:20.127980 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1d7c8aba-75f8-4313-8705-b2ce6fe9ff27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCCF48E20>]}
[0m06:01:20.127980 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 4.01s]
[0m06:01:20.127980 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m06:01:20.136475 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:01:20.138934 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:01:20.138934 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:01:20.138934 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:01:20.138934 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m06:01:20.138934 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m06:01:20.140945 [info ] [MainThread]: 
[0m06:01:20.140945 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.09 seconds (10.09s).
[0m06:01:20.142957 [debug] [MainThread]: Command end result
[0m06:01:20.160101 [info ] [MainThread]: 
[0m06:01:20.160101 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:01:20.160101 [info ] [MainThread]: 
[0m06:01:20.167902 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m06:01:20.167902 [debug] [MainThread]: Command `dbt run` succeeded at 06:01:20.167902 after 11.18 seconds
[0m06:01:20.167902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBC8543400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBBFE520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BBCBC560D0>]}
[0m06:01:20.167902 [debug] [MainThread]: Flushing usage events
[0m07:00:05.169352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD9D03460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD8C8F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD8C8FE50>]}


============================== 07:00:05.169352 | 78ead559-0229-4b89-8ddd-67ec1fa45962 ==============================
[0m07:00:05.169352 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:05.169352 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m07:00:06.012678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD8C7E1C0>]}
[0m07:00:06.076198 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD25B7F0>]}
[0m07:00:06.076198 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:06.092306 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:06.140599 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:06.140599 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:06.140599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD6689A0>]}
[0m07:00:06.156377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD5717C0>]}
[0m07:00:06.156377 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:06.156377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD5715B0>]}
[0m07:00:06.156377 [info ] [MainThread]: 
[0m07:00:06.156377 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:06.172128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.172128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.172128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.172128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.021080 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:07.695159 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:07.695159 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:00:07.695159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.695159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:08.327583 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m07:00:08.327583 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:08.352492 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:00:08.352492 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:08.992534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD8C8F580>]}
[0m07:00:08.992534 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:08.992534 [info ] [MainThread]: 
[0m07:00:08.992534 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.008630 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.008630 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m07:00:09.008630 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m07:00:09.008630 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:09.008630 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:09.008630 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.008630 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.024382 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.024382 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.040427 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:09.008630 => 07:00:09.040427
[0m07:00:09.024382 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:09.024382 => 07:00:09.024382
[0m07:00:09.042438 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.042438 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.072227 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.072227 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.072227 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:09.072227 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:09.072227 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:09.104183 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m07:00:09.933849 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:386ae31b-5d29-41fa-bb70-84cb8916ec66&page=queryresults
[0m07:00:10.266391 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:802e631a-f60c-4612-8248-00348f13b9cb&page=queryresults
[0m07:00:10.458977 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:09.072227 => 07:00:10.458977
[0m07:00:10.458977 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE6E9FA0>]}
[0m07:00:10.458977 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m07:00:10.458977 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:10.458977 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.458977 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m07:00:10.474773 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:10.474773 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.474773 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.474773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:10.474773 => 07:00:10.474773
[0m07:00:10.474773 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.474773 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.474773 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:10.490825 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:10.715438 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:09.042438 => 07:00:10.715438
[0m07:00:10.715438 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE6E9E80>]}
[0m07:00:10.715438 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.71s]
[0m07:00:10.715438 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:10.715438 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m07:00:10.715438 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m07:00:10.715438 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m07:00:10.726245 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m07:00:10.731410 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m07:00:10.731410 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 07:00:10.726245 => 07:00:10.731410
[0m07:00:10.731410 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m07:00:10.731410 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m07:00:10.731410 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:10.731410 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m07:00:11.341853 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:820591ed-c651-412c-84ff-496c67aa5c5f&page=queryresults
[0m07:00:11.469795 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a675840e-0e99-49be-b96f-9d82f5b68cf6&page=queryresults
[0m07:00:11.844569 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:10.474773 => 07:00:11.844569
[0m07:00:11.855223 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE754EE0>]}
[0m07:00:11.855223 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m07:00:11.855223 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:11.855223 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:11.855223 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m07:00:11.855223 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m07:00:11.855223 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m07:00:11.855223 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:11.870931 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 07:00:11.855223 => 07:00:11.870931
[0m07:00:11.870931 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m07:00:11.870931 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:11.870931 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:11.870931 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m07:00:11.918812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 07:00:10.731410 => 07:00:11.918812
[0m07:00:11.918812 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7D1EE0>]}
[0m07:00:11.918812 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:11.918812 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m07:00:11.918812 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.918812 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m07:00:11.918812 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m07:00:11.918812 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.934500 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.934500 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 07:00:11.918812 => 07:00:11.934500
[0m07:00:11.934500 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.934500 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.934500 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:11.934500 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m07:00:12.607082 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab6205cf-40e0-411b-b619-76c177332bf8&page=queryresults
[0m07:00:12.796100 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b4bff7d-997e-4f30-b688-9da6947dfad6&page=queryresults
[0m07:00:13.024773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 07:00:11.870931 => 07:00:13.024773
[0m07:00:13.024773 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE6EDE20>]}
[0m07:00:13.026783 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m07:00:13.026783 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:13.028792 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m07:00:13.028792 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m07:00:13.030801 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m07:00:13.030801 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m07:00:13.036328 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m07:00:13.038338 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 07:00:13.030801 => 07:00:13.036328
[0m07:00:13.038338 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m07:00:13.042355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m07:00:13.044364 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:13.046374 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m07:00:13.179724 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 07:00:11.934500 => 07:00:13.177713
[0m07:00:13.179724 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE72A3A0>]}
[0m07:00:13.181735 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m07:00:13.181735 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m07:00:13.181735 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m07:00:13.181735 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m07:00:13.181735 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m07:00:13.181735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m07:00:13.181735 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m07:00:13.181735 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 07:00:13.181735 => 07:00:13.181735
[0m07:00:13.181735 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m07:00:13.195484 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m07:00:13.195484 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:13.195484 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m07:00:13.798392 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b26656f7-cbb8-4598-bac1-f78a70495662&page=queryresults
[0m07:00:13.935414 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d076f0ab-db5f-49d4-b824-9a8eec5ec592&page=queryresults
[0m07:00:14.182446 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 07:00:13.038338 => 07:00:14.180433
[0m07:00:14.182446 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE6EDE20>]}
[0m07:00:14.184455 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m07:00:14.184455 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m07:00:14.187772 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.187772 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m07:00:14.187772 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m07:00:14.187772 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.204834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:14.206845 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 07:00:14.191461 => 07:00:14.206845
[0m07:00:14.208602 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.214639 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:14.216652 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:14.218667 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m07:00:14.322624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 07:00:13.181735 => 07:00:14.322624
[0m07:00:14.324634 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD6E0490>]}
[0m07:00:14.326645 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m07:00:14.328655 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m07:00:14.328655 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m07:00:14.328655 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m07:00:14.330667 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m07:00:14.332677 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m07:00:14.338441 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m07:00:14.342458 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 07:00:14.332677 => 07:00:14.340447
[0m07:00:14.342458 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m07:00:14.348490 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m07:00:14.348490 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:14.351650 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m07:00:14.960691 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c307a1bf-5294-4bb2-a0ea-77d5818d16d1&page=queryresults
[0m07:00:15.089645 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f1718973-2b49-486b-b205-b3cf931415ed&page=queryresults
[0m07:00:15.385763 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 07:00:14.208602 => 07:00:15.383749
[0m07:00:15.385763 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE79FC10>]}
[0m07:00:15.387775 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:15.387775 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:15.391269 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:15.391269 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m07:00:15.393281 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m07:00:15.393281 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:15.401323 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:15.401323 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:15.393281 => 07:00:15.401323
[0m07:00:15.403893 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:15.408922 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:15.408922 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:15.412937 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:15.518022 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 07:00:14.342458 => 07:00:15.518022
[0m07:00:15.519777 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD6BC9D0>]}
[0m07:00:15.521792 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m07:00:15.521792 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m07:00:15.523801 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m07:00:15.523801 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m07:00:15.526192 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m07:00:15.528208 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m07:00:15.539758 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m07:00:15.541765 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 07:00:15.528208 => 07:00:15.541765
[0m07:00:15.541765 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m07:00:15.545778 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m07:00:15.545778 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:15.547787 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m07:00:16.175122 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2acdeeb8-6c2f-4fb4-8bb9-c074a4ff6f15&page=queryresults
[0m07:00:16.565439 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:15.403893 => 07:00:16.565439
[0m07:00:16.570931 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7F59A0>]}
[0m07:00:16.570931 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m07:00:16.572944 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:16.572944 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m07:00:16.574955 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m07:00:16.574955 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m07:00:16.576966 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m07:00:16.580984 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m07:00:16.582995 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 07:00:16.576966 => 07:00:16.582995
[0m07:00:16.582995 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m07:00:16.588643 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m07:00:16.590654 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:16.592676 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m07:00:16.636313 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b78fbb7b-efb8-4b01-9cea-be75d6738700&page=queryresults
[0m07:00:17.010729 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 07:00:15.541765 => 07:00:17.010729
[0m07:00:17.010729 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7D1EE0>]}
[0m07:00:17.012741 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m07:00:17.012741 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m07:00:17.012741 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m07:00:17.012741 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m07:00:17.012741 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m07:00:17.012741 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m07:00:17.020001 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m07:00:17.020001 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 07:00:17.012741 => 07:00:17.020001
[0m07:00:17.020001 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m07:00:17.020001 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m07:00:17.020001 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:17.020001 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m07:00:17.415920 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f8cb13e-929a-4384-be76-0010c28a0334&page=queryresults
[0m07:00:17.828900 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 07:00:16.582995 => 07:00:17.828900
[0m07:00:17.830914 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE80DEE0>]}
[0m07:00:17.830914 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m07:00:17.830914 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m07:00:17.834654 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:17.834654 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m07:00:17.834654 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m07:00:17.834654 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:17.844418 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:17.846431 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:17.838384 => 07:00:17.846431
[0m07:00:17.846431 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:17.876261 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:17.950437 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:df4b3a0a-e81b-4d87-8cb6-52464022da0f&page=queryresults
[0m07:00:18.343613 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 07:00:17.020001 => 07:00:18.343613
[0m07:00:18.345624 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7093A0>]}
[0m07:00:18.345624 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m07:00:18.347634 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m07:00:18.570031 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:18.575828 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:19.339234 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9d736ea1-b4a1-4225-91b6-0ecd04f59de0&page=queryresults
[0m07:00:21.625066 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:17.848442 => 07:00:21.625066
[0m07:00:21.627080 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD6BC940>]}
[0m07:00:21.629097 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.79s]
[0m07:00:21.629097 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:21.631112 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:21.631112 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m07:00:21.637633 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m07:00:21.637633 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:21.646513 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:21.649514 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:21.638617 => 07:00:21.649514
[0m07:00:21.650514 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:21.657475 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:22.380714 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:22.382727 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m07:00:23.150947 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b5f61c69-fcbd-4acf-b5d9-e9015bea7896&page=queryresults
[0m07:00:25.764234 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:21.650514 => 07:00:25.764234
[0m07:00:25.768275 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE826B80>]}
[0m07:00:25.771321 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.14s]
[0m07:00:25.775364 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:25.777388 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:25.777388 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m07:00:25.777388 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m07:00:25.785216 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:25.782176 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m07:00:25.787230 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:25.789240 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m07:00:25.797035 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:25.799045 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m07:00:25.807186 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m07:00:25.807186 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:25.789240 => 07:00:25.807186
[0m07:00:25.807186 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:25.815090 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:25.816922 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 07:00:25.799045 => 07:00:25.816922
[0m07:00:25.816922 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m07:00:25.816922 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:26.452049 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m07:00:26.452049 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m07:00:26.499689 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:26.499689 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:27.068682 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dbf0f1eb-91f9-42fe-a9f6-19d62fb85544&page=queryresults
[0m07:00:27.104677 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9811cd96-5890-4714-9ca4-33aa9380a809&page=queryresults
[0m07:00:29.288594 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 07:00:25.816922 => 07:00:29.288594
[0m07:00:29.288594 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADF8DB040>]}
[0m07:00:29.288594 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.50s]
[0m07:00:29.288594 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m07:00:29.288594 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m07:00:29.288594 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m07:00:29.288594 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m07:00:29.288594 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m07:00:29.304486 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:29.304486 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 07:00:29.288594 => 07:00:29.304486
[0m07:00:29.304486 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m07:00:29.304486 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:29.610977 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:25.811069 => 07:00:29.610977
[0m07:00:29.610977 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7C1B20>]}
[0m07:00:29.610977 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.83s]
[0m07:00:29.610977 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:29.610977 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m07:00:29.610977 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m07:00:29.610977 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m07:00:29.610977 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m07:00:29.631780 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m07:00:29.635859 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 07:00:29.610977 => 07:00:29.634814
[0m07:00:29.635859 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m07:00:29.638863 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:29.934021 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:29.934021 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:30.303456 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m07:00:30.305462 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m07:00:30.346608 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f23c0b91-ac9a-49ee-9631-9e8f62030375&page=queryresults
[0m07:00:30.893483 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:48502d7b-c463-4573-8b05-96b89fe3f32e&page=queryresults
[0m07:00:33.378522 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 07:00:29.636874 => 07:00:33.376508
[0m07:00:33.378522 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD6BC940>]}
[0m07:00:33.380535 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.77s]
[0m07:00:33.382547 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m07:00:33.382547 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:33.384560 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m07:00:33.384560 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_agg_compra_produto)
[0m07:00:33.386572 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:33.392353 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m07:00:33.396378 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 07:00:33.386572 => 07:00:33.394365
[0m07:00:33.396378 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:33.412086 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:34.124226 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m07:00:34.124226 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m07:00:34.472873 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:564eff77-2cd8-43d2-8faa-c7ea3fddc8c2&page=queryresults
[0m07:00:36.396524 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 07:00:33.396378 => 07:00:36.396524
[0m07:00:36.402645 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE827790>]}
[0m07:00:36.402645 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.02s]
[0m07:00:36.402645 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:36.408159 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m07:00:36.408159 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m07:00:36.408159 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_venda_produto_final)
[0m07:00:36.412054 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m07:00:36.418716 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m07:00:36.418716 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 07:00:36.412054 => 07:00:36.418716
[0m07:00:36.418716 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m07:00:36.418716 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:37.053668 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m07:00:37.055683 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m07:00:37.119150 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 07:00:29.304486 => 07:00:37.117134
[0m07:00:37.119150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE7CA850>]}
[0m07:00:37.121163 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 7.83s]
[0m07:00:37.123254 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m07:00:37.123254 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.125267 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m07:00:37.125267 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_produto_fabricado)
[0m07:00:37.125267 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.133958 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m07:00:37.135982 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 07:00:37.127927 => 07:00:37.135982
[0m07:00:37.135982 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.141151 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:37.413116 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:338078c6-15f2-4970-872a-c906684cdb6f&page=queryresults
[0m07:00:37.766698 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m07:00:37.768712 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m07:00:38.313432 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11781124-6552-45af-a386-501bc40a0c61&page=queryresults
[0m07:00:40.166117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 07:00:36.418716 => 07:00:40.166117
[0m07:00:40.168130 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE8C49A0>]}
[0m07:00:40.168130 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.76s]
[0m07:00:40.171154 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m07:00:40.171154 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:40.173166 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m07:00:40.175179 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m07:00:40.175179 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:40.181207 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m07:00:40.183218 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 07:00:40.175179 => 07:00:40.183218
[0m07:00:40.183218 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:40.187077 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:40.814355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m07:00:40.816373 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m07:00:41.069363 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 07:00:37.135982 => 07:00:41.069363
[0m07:00:41.069363 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADF90AD60>]}
[0m07:00:41.182413 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c49a4c9-b862-478a-8fe3-307d4452feb0&page=queryresults
[0m07:00:41.800154 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 3.94s]
[0m07:00:41.800154 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m07:00:41.803518 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.803518 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m07:00:41.806097 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m07:00:41.806097 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.816054 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m07:00:41.818066 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 07:00:41.806097 => 07:00:41.818066
[0m07:00:41.820077 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.824098 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:42.435988 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m07:00:42.440017 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:43.110125 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:89fe100f-8edf-44c9-a73b-35b11acef67c&page=queryresults
[0m07:00:43.220885 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 07:00:40.183218 => 07:00:43.220885
[0m07:00:43.220885 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE73E1F0>]}
[0m07:00:43.220885 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.05s]
[0m07:00:43.220885 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:43.231076 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.231076 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m07:00:43.233404 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m07:00:43.233404 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.243037 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m07:00:43.247060 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 07:00:43.233404 => 07:00:43.245048
[0m07:00:43.247060 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.252840 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:43.885716 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m07:00:43.887730 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m07:00:44.309938 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52b855a8-c0fb-4a9b-92b4-6afc4155aa1b&page=queryresults
[0m07:00:45.657577 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 07:00:41.820077 => 07:00:45.657577
[0m07:00:45.659590 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADF8C3970>]}
[0m07:00:45.659590 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.85s]
[0m07:00:45.661604 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m07:00:47.096476 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 07:00:43.247060 => 07:00:47.094460
[0m07:00:47.096476 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADF930970>]}
[0m07:00:47.098493 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.86s]
[0m07:00:47.100624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m07:00:47.102639 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.102639 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m07:00:47.105199 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m07:00:47.107211 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.115906 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m07:00:47.115906 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 07:00:47.107211 => 07:00:47.115906
[0m07:00:47.115906 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.131686 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:47.750687 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m07:00:47.752697 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:48.441120 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c478114-84cf-4dd6-be8f-1809f3f87dfd&page=queryresults
[0m07:00:53.113251 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 07:00:47.115906 => 07:00:53.113251
[0m07:00:53.113251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78ead559-0229-4b89-8ddd-67ec1fa45962', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADE786250>]}
[0m07:00:53.115257 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 6.01s]
[0m07:00:53.115257 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:53.117818 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m07:00:53.117818 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m07:00:53.117818 [info ] [MainThread]: 
[0m07:00:53.117818 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 46.96 seconds (46.96s).
[0m07:00:53.123553 [debug] [MainThread]: Command end result
[0m07:00:53.137309 [info ] [MainThread]: 
[0m07:00:53.142724 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:53.142724 [info ] [MainThread]: 
[0m07:00:53.142724 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m07:00:53.142724 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:53.142724 after 48.03 seconds
[0m07:00:53.142724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD9D03460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADF931BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD671280>]}
[0m07:00:53.142724 [debug] [MainThread]: Flushing usage events
[0m07:00:57.221356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D950B55460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D94FAEC6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D94FAECAF0>]}


============================== 07:00:57.221356 | 6e0955f4-b160-4899-a7ed-7a6a6cae0286 ==============================
[0m07:00:57.221356 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:57.221356 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m07:00:58.037986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D94FAEC880>]}
[0m07:00:58.102053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D94FAE51C0>]}
[0m07:00:58.102053 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:58.117730 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:58.165950 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:58.165950 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:58.165950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9544D7730>]}
[0m07:00:58.181945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9543D1550>]}
[0m07:00:58.181945 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:58.181945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9543D1340>]}
[0m07:00:58.181945 [info ] [MainThread]: 
[0m07:00:58.181945 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:58.181945 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:58.181945 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:59.191832 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:59.191832 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:59.191832 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:59.207958 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:59.985186 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:59.987204 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:00.009733 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m07:01:00.009733 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:00.662815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D95422B100>]}
[0m07:01:00.664909 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:01:00.665911 [info ] [MainThread]: 
[0m07:01:00.673134 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:01:00.674233 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m07:01:00.676149 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m07:01:00.677141 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:01:00.689234 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 07:01:00.677141 => 07:01:00.689234
[0m07:01:00.689234 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:01:00.720983 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:01:00.736676 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m07:01:01.685315 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:06d6d6bd-5530-44d3-9b5c-e96486979678&page=queryresults
[0m07:01:02.772693 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m07:01:03.239471 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:57dd74ae-11af-4cbb-9543-c8809756eddf&page=queryresults
[0m07:01:05.855024 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m07:01:06.657896 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m07:01:06.657896 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m07:01:07.061578 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db7bab46-8e75-4808-905f-75872efb51d0&page=queryresults
[0m07:01:09.036964 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 07:01:00.689234 => 07:01:09.036964
[0m07:01:09.036964 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e0955f4-b160-4899-a7ed-7a6a6cae0286', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9555919A0>]}
[0m07:01:09.036964 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.36s]
[0m07:01:09.036964 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:01:09.048886 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:01:09.048886 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:01:09.048886 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m07:01:09.048886 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:01:09.048886 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m07:01:09.048886 [info ] [MainThread]: 
[0m07:01:09.048886 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.87 seconds (10.87s).
[0m07:01:09.048886 [debug] [MainThread]: Command end result
[0m07:01:09.076690 [info ] [MainThread]: 
[0m07:01:09.076690 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:01:09.076690 [info ] [MainThread]: 
[0m07:01:09.080774 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m07:01:09.080774 [debug] [MainThread]: Command `dbt snapshot` succeeded at 07:01:09.080774 after 11.91 seconds
[0m07:01:09.080774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D950B55460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D954231D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9542AC820>]}
[0m07:01:09.080774 [debug] [MainThread]: Flushing usage events
[0m07:01:12.702975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230C6A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230B6206D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230B620E20>]}


============================== 07:01:12.702975 | a67a391a-fdca-4bb7-b28c-79b07e71a883 ==============================
[0m07:01:12.702975 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:01:12.702975 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m07:01:13.532399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230B6159A0>]}
[0m07:01:13.580343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230FDC6190>]}
[0m07:01:13.597314 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:01:13.602789 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:01:13.660465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:01:13.662061 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:01:13.667088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002231000A1C0>]}
[0m07:01:13.681138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230FF1E0D0>]}
[0m07:01:13.681525 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:01:13.682624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230FEED1C0>]}
[0m07:01:13.683656 [info ] [MainThread]: 
[0m07:01:13.684640 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:01:13.686608 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:01:13.686608 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:14.342318 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m07:01:14.342318 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:14.342318 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:01:14.342318 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:14.954957 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m07:01:14.956973 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:14.987211 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:01:14.987211 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:15.562525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230FC74310>]}
[0m07:01:15.562525 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:01:15.562525 [info ] [MainThread]: 
[0m07:01:15.562525 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.578256 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m07:01:15.578256 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m07:01:15.578256 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.594248 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:15.594248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 07:01:15.578256 => 07:01:15.594248
[0m07:01:15.594248 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.611635 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:01:16.252913 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:16.252913 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m07:01:16.574396 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44c28a8d-2794-46df-b3fc-cbd92e293bf7&page=queryresults
[0m07:01:18.737780 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 07:01:15.594248 => 07:01:18.737780
[0m07:01:18.737780 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022311084790>]}
[0m07:01:18.737780 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.16s]
[0m07:01:18.737780 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:18.737780 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m07:01:18.737780 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m07:01:18.737780 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m07:01:18.737780 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m07:01:18.753927 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m07:01:18.753927 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 07:01:18.737780 => 07:01:18.753927
[0m07:01:18.753927 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m07:01:18.753927 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:01:19.368579 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m07:01:19.368579 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m07:01:19.813957 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b976118e-11ae-43c8-bf34-1ce004dc616e&page=queryresults
[0m07:01:21.727420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 07:01:18.753927 => 07:01:21.726420
[0m07:01:21.729416 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a67a391a-fdca-4bb7-b28c-79b07e71a883', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000223110D44C0>]}
[0m07:01:21.730417 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.99s]
[0m07:01:21.731429 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m07:01:21.734682 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:01:21.735685 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:01:21.735685 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:01:21.736686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m07:01:21.736686 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m07:01:21.736686 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m07:01:21.737671 [info ] [MainThread]: 
[0m07:01:21.738575 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.05 seconds (8.05s).
[0m07:01:21.739291 [debug] [MainThread]: Command end result
[0m07:01:21.762302 [info ] [MainThread]: 
[0m07:01:21.762302 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:01:21.765396 [info ] [MainThread]: 
[0m07:01:21.765396 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m07:01:21.765396 [debug] [MainThread]: Command `dbt run` succeeded at 07:01:21.765396 after 9.12 seconds
[0m07:01:21.765396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230C6A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230FDDB280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002230E7EDB80>]}
[0m07:01:21.765396 [debug] [MainThread]: Flushing usage events
[0m08:00:05.811750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E53C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E436F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E436FE50>]}


============================== 08:00:05.811750 | 4c22ee8f-e981-4aef-91c1-a6a949a8c17f ==============================
[0m08:00:05.811750 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:05.811750 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m08:00:06.654147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E752DA90>]}
[0m08:00:06.718102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8A4E520>]}
[0m08:00:06.718102 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:06.733861 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:06.781931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:06.781931 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:06.781931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8D48580>]}
[0m08:00:06.798163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8C3E3A0>]}
[0m08:00:06.798163 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:06.798163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8C3E190>]}
[0m08:00:06.798163 [info ] [MainThread]: 
[0m08:00:06.798163 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:06.798163 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.798163 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.815635 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.829639 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.676637 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.344895 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:08.344895 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:00:08.344895 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.344895 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.972459 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:08.972459 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.972459 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m08:00:08.988166 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:09.787092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8B0BB80>]}
[0m08:00:09.787092 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:09.795485 [info ] [MainThread]: 
[0m08:00:09.797044 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.797044 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.797044 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m08:00:09.797044 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:09.797044 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m08:00:09.797044 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.797044 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:09.813137 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:09.813137 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.829147 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:09.829147 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:09.797044 => 08:00:09.829147
[0m08:00:09.829147 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.861000 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:09.861000 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:09.813137 => 08:00:09.861000
[0m08:00:09.861000 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.861000 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:09.861000 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:09.876976 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:09.879848 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m08:00:09.909096 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:10.682344 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a8451be9-2450-42fa-b48b-08d913e475bd&page=queryresults
[0m08:00:10.698398 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8e31916-9d4f-4e7e-931a-669462dfe0a9&page=queryresults
[0m08:00:11.100486 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:09.861000 => 08:00:11.100486
[0m08:00:11.100486 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E581F0>]}
[0m08:00:11.100486 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m08:00:11.100486 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:11.100486 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.100486 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m08:00:11.116370 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:11.116370 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.120381 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.122410 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:11.116370 => 08:00:11.122410
[0m08:00:11.122410 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.122410 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.122410 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:11.122410 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:11.154792 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:09.829147 => 08:00:11.154792
[0m08:00:11.154792 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E73250>]}
[0m08:00:11.154792 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m08:00:11.154792 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:11.164431 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m08:00:11.164431 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m08:00:11.164431 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m08:00:11.164431 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m08:00:11.164431 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m08:00:11.164431 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 08:00:11.164431 => 08:00:11.164431
[0m08:00:11.164431 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m08:00:11.164431 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m08:00:11.164431 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:11.164431 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m08:00:11.902034 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4be17005-cefa-4d5c-86fb-c8397cff4945&page=queryresults
[0m08:00:11.966751 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75440b56-9ecb-4d6d-a96d-3560fba4d8e0&page=queryresults
[0m08:00:12.322325 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:11.122410 => 08:00:12.322325
[0m08:00:12.322325 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9EA93D0>]}
[0m08:00:12.322325 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m08:00:12.322325 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.322325 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.322325 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m08:00:12.337598 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m08:00:12.337598 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.337598 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:12.337598 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 08:00:12.337598 => 08:00:12.337598
[0m08:00:12.337598 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.337598 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:12.337598 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.337598 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m08:00:12.417701 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 08:00:11.164431 => 08:00:12.417701
[0m08:00:12.417701 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DC7940>]}
[0m08:00:12.433884 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m08:00:12.433884 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m08:00:12.433884 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.433884 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m08:00:12.433884 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m08:00:12.433884 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.449782 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.449782 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 08:00:12.433884 => 08:00:12.449782
[0m08:00:12.449782 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.449782 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.449782 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.449782 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m08:00:13.092323 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a95e17c-8819-4440-86a9-8fbda198421c&page=queryresults
[0m08:00:13.156867 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a362c736-aa93-466c-b127-2ebb50f13a23&page=queryresults
[0m08:00:13.524870 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 08:00:12.337598 => 08:00:13.524870
[0m08:00:13.524870 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DC7B20>]}
[0m08:00:13.524870 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m08:00:13.524870 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:13.540865 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m08:00:13.540865 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m08:00:13.540865 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m08:00:13.540865 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m08:00:13.540865 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m08:00:13.540865 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 08:00:13.540865 => 08:00:13.540865
[0m08:00:13.540865 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m08:00:13.556991 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m08:00:13.556991 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:13.556991 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m08:00:13.604824 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 08:00:12.449782 => 08:00:13.604824
[0m08:00:13.604824 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E38CD0>]}
[0m08:00:13.604824 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m08:00:13.604824 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m08:00:13.604824 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m08:00:13.620628 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m08:00:13.620628 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m08:00:13.620628 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m08:00:13.620628 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m08:00:13.620628 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 08:00:13.620628 => 08:00:13.620628
[0m08:00:13.620628 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m08:00:13.620628 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m08:00:13.620628 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:13.636550 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m08:00:14.408178 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac2fe150-193b-4dfe-9f55-3393bc3571df&page=queryresults
[0m08:00:14.439921 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f7c4c17-d0d1-4a41-b7fb-0e0f6863fe63&page=queryresults
[0m08:00:14.838326 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 08:00:13.620628 => 08:00:14.838326
[0m08:00:14.840337 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DE9FD0>]}
[0m08:00:14.846117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 08:00:13.540865 => 08:00:14.846117
[0m08:00:14.848128 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DC7D60>]}
[0m08:00:14.840337 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m08:00:14.850140 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m08:00:14.852151 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.850140 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m08:00:14.854161 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m08:00:14.856170 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m08:00:14.852151 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m08:00:14.857924 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m08:00:14.859937 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.856170 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m08:00:14.867983 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m08:00:14.869993 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m08:00:14.879710 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m08:00:14.879710 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:14.889551 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 08:00:14.859937 => 08:00:14.889551
[0m08:00:14.889551 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.889551 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:14.889551 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 08:00:14.869993 => 08:00:14.889551
[0m08:00:14.889551 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m08:00:14.905371 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m08:00:14.907383 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:14.907383 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m08:00:14.959198 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:14.959198 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m08:00:15.974756 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f3267cb7-569c-4dab-b6e6-8288098dce68&page=queryresults
[0m08:00:16.034215 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f00055e7-3c0c-4967-88d4-e0ee9e15d0a8&page=queryresults
[0m08:00:16.398651 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 08:00:14.889551 => 08:00:16.398651
[0m08:00:16.400666 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DF1FD0>]}
[0m08:00:16.403311 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 08:00:14.900337 => 08:00:16.403311
[0m08:00:16.403311 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E8A7F0>]}
[0m08:00:16.403311 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m08:00:16.403311 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:16.403311 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:16.403311 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m08:00:16.403311 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m08:00:16.403311 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.403311 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m08:00:16.418025 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m08:00:16.403311 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m08:00:16.419063 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:16.419063 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m08:00:16.432107 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:16.432107 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.432107 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m08:00:16.432107 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:16.419063 => 08:00:16.432107
[0m08:00:16.432107 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:16.447911 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:16.447911 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 08:00:16.432107 => 08:00:16.447911
[0m08:00:16.447911 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.460262 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m08:00:16.462271 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:16.464025 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:16.466775 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:16.521655 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m08:00:17.262391 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0088127-f521-4be0-9c1c-1c61888f9c13&page=queryresults
[0m08:00:17.319287 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6f677e9-61a5-456e-9c9a-6f61168de066&page=queryresults
[0m08:00:17.626821 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 08:00:16.456231 => 08:00:17.626821
[0m08:00:17.628832 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9F4B8B0>]}
[0m08:00:17.628832 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m08:00:17.633305 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m08:00:17.634304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m08:00:17.634304 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m08:00:17.636305 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m08:00:17.636305 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m08:00:17.642296 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m08:00:17.644297 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 08:00:17.637303 => 08:00:17.644297
[0m08:00:17.645300 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m08:00:17.651844 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m08:00:17.654849 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:17.658844 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m08:00:17.724150 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:16.432107 => 08:00:17.723149
[0m08:00:17.726144 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E73250>]}
[0m08:00:17.727147 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m08:00:17.729141 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:17.730152 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m08:00:17.730152 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m08:00:17.730152 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_lead_time)
[0m08:00:17.730152 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m08:00:17.730152 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m08:00:17.730152 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 08:00:17.730152 => 08:00:17.730152
[0m08:00:17.730152 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m08:00:17.730152 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m08:00:17.746338 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:17.746338 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m08:00:18.421009 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c28f8c97-4f45-4d08-8db1-e4f405f29201&page=queryresults
[0m08:00:18.741708 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5337f1ae-209b-45d4-8d3d-525f68170602&page=queryresults
[0m08:00:18.833170 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 08:00:17.645300 => 08:00:18.833170
[0m08:00:18.833170 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9F50BE0>]}
[0m08:00:18.835182 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m08:00:18.837193 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m08:00:18.837193 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:18.837193 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m08:00:18.839202 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m08:00:18.839202 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:18.845226 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:18.847236 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:18.841210 => 08:00:18.847236
[0m08:00:18.847236 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:18.863040 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:19.108397 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 08:00:17.730152 => 08:00:19.108397
[0m08:00:19.108397 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E73250>]}
[0m08:00:19.108397 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m08:00:19.108397 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m08:00:19.498209 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:19.500219 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:20.098501 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:762da508-4cb8-40ff-a361-d29f63083417&page=queryresults
[0m08:00:22.946573 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:18.849247 => 08:00:22.946573
[0m08:00:22.948580 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9FAD7C0>]}
[0m08:00:22.950592 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.11s]
[0m08:00:22.950592 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:22.952602 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:22.952602 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m08:00:22.952602 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m08:00:22.956509 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:22.962538 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:22.964547 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:22.956509 => 08:00:22.964547
[0m08:00:22.964547 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:22.968567 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:23.601045 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:23.603060 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m08:00:24.296259 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e4af3536-0f37-4b74-a8d4-d32c7e68cccc&page=queryresults
[0m08:00:27.104077 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:22.964547 => 08:00:27.088206
[0m08:00:27.104077 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DD5C10>]}
[0m08:00:27.104077 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.15s]
[0m08:00:27.104077 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:27.104077 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:27.104077 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m08:00:27.104077 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m08:00:27.113201 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:27.115242 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:27.121274 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:27.104077 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m08:00:27.121274 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m08:00:27.121274 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m08:00:27.121274 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m08:00:27.121274 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:27.115242 => 08:00:27.121274
[0m08:00:27.121274 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:27.136579 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:27.175949 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 08:00:27.121274 => 08:00:27.175949
[0m08:00:27.175949 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m08:00:27.175949 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:27.786955 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:27.803059 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m08:00:27.803059 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:27.803059 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m08:00:28.363376 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c525c787-e669-4ef6-887e-aa9f3a836728&page=queryresults
[0m08:00:28.524141 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a9397da-77bd-4b31-a951-c2441db3f527&page=queryresults
[0m08:00:30.321725 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:27.134568 => 08:00:30.321725
[0m08:00:30.321725 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8D9F160>]}
[0m08:00:30.321725 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.21s]
[0m08:00:30.321725 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:30.321725 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m08:00:30.321725 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m08:00:30.337689 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m08:00:30.337689 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m08:00:30.337689 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:30.337689 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 08:00:30.337689 => 08:00:30.337689
[0m08:00:30.337689 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m08:00:30.337689 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:30.738521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 08:00:27.175949 => 08:00:30.738521
[0m08:00:30.754605 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182EAF83850>]}
[0m08:00:30.754605 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.63s]
[0m08:00:30.754605 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m08:00:30.754605 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m08:00:30.754605 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m08:00:30.754605 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m08:00:30.754605 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m08:00:30.770296 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m08:00:30.770296 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 08:00:30.754605 => 08:00:30.770296
[0m08:00:30.770296 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m08:00:30.770296 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:30.995709 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:30.995709 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:31.446759 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m08:00:31.446759 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m08:00:31.543301 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c651aa8-afb3-4d62-a921-56288bf60c01&page=queryresults
[0m08:00:32.067656 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:987f1aea-44e4-405d-a361-ab5228490a7c&page=queryresults
[0m08:00:34.024145 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 08:00:30.337689 => 08:00:34.024145
[0m08:00:34.026157 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9FA57F0>]}
[0m08:00:34.026157 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.69s]
[0m08:00:34.028171 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m08:00:34.029925 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:34.029925 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m08:00:34.029925 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m08:00:34.029925 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:34.029925 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m08:00:34.029925 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 08:00:34.029925 => 08:00:34.029925
[0m08:00:34.029925 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:34.051797 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:34.647916 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 08:00:30.770296 => 08:00:34.646923
[0m08:00:34.648920 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182EB010850>]}
[0m08:00:34.650935 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.89s]
[0m08:00:34.651816 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m08:00:34.653861 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m08:00:34.654914 [info ] [Thread-1  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m08:00:34.657744 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m08:00:34.658436 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m08:00:34.726262 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m08:00:34.735146 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m08:00:34.749480 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m08:00:34.751366 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 08:00:34.659431 => 08:00:34.751366
[0m08:00:34.751366 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m08:00:34.753365 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:35.150482 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3dc68fb1-7e27-476a-bb69-1c8cce9a4d64&page=queryresults
[0m08:00:35.362536 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m08:00:35.363547 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m08:00:35.780197 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c03a6a8-fa17-4282-a13a-be3d15be8521&page=queryresults
[0m08:00:37.079263 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 08:00:34.029925 => 08:00:37.079263
[0m08:00:37.081275 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8D9F1C0>]}
[0m08:00:37.083285 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.05s]
[0m08:00:37.083285 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:37.085038 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m08:00:37.087051 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m08:00:37.087051 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m08:00:37.089061 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m08:00:37.095094 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m08:00:37.097104 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 08:00:37.089061 => 08:00:37.097104
[0m08:00:37.097104 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m08:00:37.100871 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:37.733303 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m08:00:37.735304 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m08:00:38.259975 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5db12cb-9564-4c70-a2c4-9e1c5dcade92&page=queryresults
[0m08:00:38.319344 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 08:00:34.751366 => 08:00:38.317329
[0m08:00:38.319344 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DF1C10>]}
[0m08:00:38.321357 [info ] [Thread-1  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.66s]
[0m08:00:38.323367 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m08:00:38.324378 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:38.324378 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m08:00:38.324378 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m08:00:38.324378 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:38.324378 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m08:00:38.324378 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 08:00:38.324378 => 08:00:38.324378
[0m08:00:38.324378 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:38.324378 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:38.938585 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m08:00:38.942197 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m08:00:39.271265 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79d39129-1624-4391-ad42-aab4f510aa22&page=queryresults
[0m08:00:41.395160 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 08:00:37.099116 => 08:00:41.395160
[0m08:00:41.397175 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8C73C40>]}
[0m08:00:41.782989 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 08:00:38.324378 => 08:00:41.782989
[0m08:00:41.782989 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8AC27F0>]}
[0m08:00:42.253456 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.31s]
[0m08:00:42.255470 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m08:00:42.257481 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m08:00:42.253456 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.46s]
[0m08:00:42.259494 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:42.259494 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m08:00:42.257481 [info ] [Thread-2  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m08:00:42.263322 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m08:00:42.265335 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m08:00:42.273373 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m08:00:42.259494 [info ] [Thread-1  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m08:00:42.273373 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m08:00:42.276325 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m08:00:42.283360 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m08:00:42.283360 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 08:00:42.276325 => 08:00:42.283360
[0m08:00:42.286716 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m08:00:42.286716 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:42.286716 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 08:00:42.265335 => 08:00:42.286716
[0m08:00:42.286716 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m08:00:42.295324 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:42.959206 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m08:00:42.959206 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:42.959206 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m08:00:42.967913 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m08:00:43.326384 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f197a01-06c2-436f-a197-ec7095958ae0&page=queryresults
[0m08:00:43.602793 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b7be26f-e6f9-4e78-a462-59ae8dd10bb2&page=queryresults
[0m08:00:45.802896 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 08:00:42.286716 => 08:00:45.802896
[0m08:00:45.802896 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DCFBB0>]}
[0m08:00:45.802896 [info ] [Thread-1  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 3.53s]
[0m08:00:45.802896 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m08:00:45.812095 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:45.812095 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m08:00:45.812095 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m08:00:45.812095 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:45.822804 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m08:00:45.824815 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 08:00:45.815595 => 08:00:45.824815
[0m08:00:45.826828 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:45.834613 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:46.499415 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m08:00:46.503447 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:47.116568 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76fb08c9-c21e-4198-b25d-b3bfd41ce0d7&page=queryresults
[0m08:00:47.246751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 08:00:42.292305 => 08:00:47.246751
[0m08:00:47.248764 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9E85760>]}
[0m08:00:47.250778 [info ] [Thread-2  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.99s]
[0m08:00:47.252789 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m08:00:51.111653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 08:00:45.826828 => 08:00:51.111653
[0m08:00:51.113666 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c22ee8f-e981-4aef-91c1-a6a949a8c17f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9EAC310>]}
[0m08:00:51.113666 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.30s]
[0m08:00:51.113666 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:51.113666 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m08:00:51.113666 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m08:00:51.123107 [info ] [MainThread]: 
[0m08:00:51.123107 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 44.32 seconds (44.32s).
[0m08:00:51.123107 [debug] [MainThread]: Command end result
[0m08:00:51.144537 [info ] [MainThread]: 
[0m08:00:51.144537 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:51.144537 [info ] [MainThread]: 
[0m08:00:51.144537 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m08:00:51.144537 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:51.144537 after 45.40 seconds
[0m08:00:51.144537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E53C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E9DFED90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182E8B1D2B0>]}
[0m08:00:51.154319 [debug] [MainThread]: Flushing usage events
[0m08:00:55.192061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5A8233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5B011340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5AFE09A0>]}


============================== 08:00:55.192061 | 608eb888-1cb1-4434-b52c-f0053d5ed4c6 ==============================
[0m08:00:55.192061 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:55.192061 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m08:00:55.972225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F59799EE0>]}
[0m08:00:56.035859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5DDAE1C0>]}
[0m08:00:56.035859 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:56.051584 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:56.101421 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:56.101421 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:56.115334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5E188370>]}
[0m08:00:56.131027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5E09A220>]}
[0m08:00:56.131027 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:56.131027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5E070340>]}
[0m08:00:56.135275 [info ] [MainThread]: 
[0m08:00:56.135275 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:56.135275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:56.135275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:56.799658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:00:56.799658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:00:56.799658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:56.799658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:57.346401 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m08:00:57.359377 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:57.391706 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:57.391706 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:57.996868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5DEF1B80>]}
[0m08:00:57.996868 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:58.001539 [info ] [MainThread]: 
[0m08:00:58.001539 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:58.001539 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m08:00:58.012931 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m08:00:58.014947 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:58.030761 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 08:00:58.014947 => 08:00:58.030761
[0m08:00:58.030761 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:58.092779 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:58.092779 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m08:00:58.957126 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:632971a1-a38c-40e7-862e-40581baaf718&page=queryresults
[0m08:01:00.050692 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m08:01:00.493398 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:77fef73b-f486-4328-a2df-47c9758bab0e&page=queryresults
[0m08:01:03.361889 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m08:01:04.145954 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m08:01:04.145954 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m08:01:04.610805 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f22d330d-83a0-4d6a-8fd0-9dad29f11307&page=queryresults
[0m08:01:06.876183 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 08:00:58.032766 => 08:01:06.876183
[0m08:01:06.876183 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '608eb888-1cb1-4434-b52c-f0053d5ed4c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F584A76D0>]}
[0m08:01:06.876183 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.87s]
[0m08:01:06.876183 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:01:06.876183 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:01:06.891915 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:01:06.891915 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:01:06.891915 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:01:06.891915 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m08:01:06.891915 [info ] [MainThread]: 
[0m08:01:06.891915 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.76 seconds (10.76s).
[0m08:01:06.891915 [debug] [MainThread]: Command end result
[0m08:01:06.907851 [info ] [MainThread]: 
[0m08:01:06.907851 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:01:06.907851 [info ] [MainThread]: 
[0m08:01:06.923578 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m08:01:06.923578 [debug] [MainThread]: Command `dbt snapshot` succeeded at 08:01:06.923578 after 11.79 seconds
[0m08:01:06.923578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5A8233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5DDAE1C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F5F294DC0>]}
[0m08:01:06.923578 [debug] [MainThread]: Flushing usage events
[0m08:01:11.430700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EB183400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EA0F9910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EA0F9B80>]}


============================== 08:01:11.430700 | c42321cf-a250-4c14-84b9-ee2bcd8210a3 ==============================
[0m08:01:11.430700 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:01:11.430700 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m08:01:12.390687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6ED2CEA30>]}
[0m08:01:12.484304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EDAD29D0>]}
[0m08:01:12.484304 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:01:12.512749 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:01:12.623187 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:01:12.625193 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:01:12.631210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EEAE8550>]}
[0m08:01:12.643271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EE9DE370>]}
[0m08:01:12.643271 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:01:12.643271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EE9DE160>]}
[0m08:01:12.643271 [info ] [MainThread]: 
[0m08:01:12.643271 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:01:12.643271 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:01:12.659192 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:13.337211 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:01:13.337211 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:13.337211 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:01:13.337211 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:13.948093 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:01:13.963986 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:13.963986 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m08:01:13.963986 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:14.590055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EE879E80>]}
[0m08:01:14.590055 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:01:14.590055 [info ] [MainThread]: 
[0m08:01:14.609709 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:14.610217 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m08:01:14.610217 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m08:01:14.610217 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:14.633732 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:01:14.633732 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 08:01:14.610217 => 08:01:14.633732
[0m08:01:14.635740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:14.649517 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:01:15.286967 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:01:15.286967 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m08:01:15.662731 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c5b6707e-3591-4f7e-82ff-d0a2eed798e5&page=queryresults
[0m08:01:17.874813 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 08:01:14.635740 => 08:01:17.874813
[0m08:01:17.874813 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EFB5CA90>]}
[0m08:01:17.874813 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.26s]
[0m08:01:17.874813 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:17.874813 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m08:01:17.874813 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m08:01:17.874813 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m08:01:17.874813 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m08:01:17.874813 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m08:01:17.874813 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 08:01:17.874813 => 08:01:17.874813
[0m08:01:17.874813 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m08:01:17.890710 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:01:18.498814 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m08:01:18.498814 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m08:01:18.938050 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c93e2dc1-3af0-4471-aae5-679a93bb7fe8&page=queryresults
[0m08:01:21.110938 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 08:01:17.874813 => 08:01:21.110938
[0m08:01:21.110938 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c42321cf-a250-4c14-84b9-ee2bcd8210a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EFB81EE0>]}
[0m08:01:21.110938 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.24s]
[0m08:01:21.110938 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m08:01:21.110938 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:01:21.121145 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:01:21.121145 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:01:21.121145 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:01:21.121145 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m08:01:21.122654 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m08:01:21.122654 [info ] [MainThread]: 
[0m08:01:21.124793 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.48 seconds (8.48s).
[0m08:01:21.124793 [debug] [MainThread]: Command end result
[0m08:01:21.151668 [info ] [MainThread]: 
[0m08:01:21.151668 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:01:21.154707 [info ] [MainThread]: 
[0m08:01:21.154707 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m08:01:21.154707 [debug] [MainThread]: Command `dbt run` succeeded at 08:01:21.154707 after 9.78 seconds
[0m08:01:21.159273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EB183400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EE8BD0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6EE87E4C0>]}
[0m08:01:21.159273 [debug] [MainThread]: Flushing usage events
[0m09:00:04.337250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD2373430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD12E69D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD12E6B80>]}


============================== 09:00:04.344937 | 676552f6-f0eb-4aa3-9ec9-60cbe89a9597 ==============================
[0m09:00:04.344937 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:04.344937 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:05.187795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD44BDAC0>]}
[0m09:00:05.235545 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD4CB9A90>]}
[0m09:00:05.251348 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:05.251348 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:05.303983 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:05.315434 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:05.315434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5CD8550>]}
[0m09:00:05.331528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5BCE370>]}
[0m09:00:05.331528 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:05.331528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5BCE160>]}
[0m09:00:05.331528 [info ] [MainThread]: 
[0m09:00:05.331528 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:05.347418 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.347418 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:05.347418 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.347418 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.178722 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:06.874492 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:00:06.887416 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:00:06.887416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.887416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.532876 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:00:07.532876 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:07.576687 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:07.578735 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:08.244606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5A96850>]}
[0m09:00:08.244606 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:08.250201 [info ] [MainThread]: 
[0m09:00:08.250201 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.250201 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.250201 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:00:08.250201 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:08.250201 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:00:08.250201 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.266151 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:08.281938 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.281938 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.281938 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.281938 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:08.266151 => 09:00:08.281938
[0m09:00:08.281938 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.327537 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.327537 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:08.281938 => 09:00:08.327537
[0m09:00:08.327537 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.329317 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.329317 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:08.329317 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:00:08.360878 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:08.360878 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:09.184953 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b7f9344-bb26-4d84-9cdc-7b8581fdf732&page=queryresults
[0m09:00:09.200845 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:096bd349-bb3a-488b-9c9d-a341318e7761&page=queryresults
[0m09:00:09.684569 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:08.329317 => 09:00:09.684569
[0m09:00:09.684569 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6E04FD0>]}
[0m09:00:09.684569 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m09:00:09.684569 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:09.684569 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.684569 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:00:09.684569 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:09.684569 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.700468 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:09.700468 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:09.684569 => 09:00:09.700468
[0m09:00:09.700468 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.700468 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:09.700468 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:09.700468 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:09.732373 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:08.281938 => 09:00:09.732373
[0m09:00:09.732373 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DE6100>]}
[0m09:00:09.732373 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m09:00:09.748140 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:09.748140 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m09:00:09.748140 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m09:00:09.748140 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m09:00:09.748140 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m09:00:09.748140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m09:00:09.748140 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 09:00:09.748140 => 09:00:09.748140
[0m09:00:09.748140 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m09:00:09.748140 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m09:00:09.748140 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:09.748140 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m09:00:10.487758 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eed57820-7919-4b27-a46a-3697842c76d0&page=queryresults
[0m09:00:10.508993 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:00c2d3f0-4b3c-4541-8553-f4c75f46a8cf&page=queryresults
[0m09:00:10.954483 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 09:00:09.748140 => 09:00:10.954483
[0m09:00:10.954483 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D7A040>]}
[0m09:00:10.970548 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:10.970548 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m09:00:10.970548 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:10.970548 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:00:10.975955 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m09:00:10.975955 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:00:10.975955 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:10.975955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:00:10.975955 => 09:00:10.975955
[0m09:00:10.986246 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:00:10.992708 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:10.992708 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:09.700468 => 09:00:10.992708
[0m09:00:10.992708 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DD0C40>]}
[0m09:00:10.992708 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m09:00:10.992708 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:10.992708 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.992708 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:00:10.992708 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:00:10.992708 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:00:11.002035 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:11.002035 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:11.011389 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:00:11.033784 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:00:10.992708 => 09:00:11.033784
[0m09:00:11.033784 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:00:11.033784 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:11.033784 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:11.033784 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:00:11.766432 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a450ffc-fdad-4ba1-9c6e-fd115c26b21c&page=queryresults
[0m09:00:11.766432 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46adc7e9-a23d-43b7-bfeb-313cb48c9006&page=queryresults
[0m09:00:12.169809 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:00:10.986246 => 09:00:12.169809
[0m09:00:12.169809 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DC5940>]}
[0m09:00:12.169809 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m09:00:12.169809 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:12.169809 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m09:00:12.169809 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m09:00:12.169809 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m09:00:12.169809 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m09:00:12.185933 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m09:00:12.185933 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 09:00:12.169809 => 09:00:12.185933
[0m09:00:12.185933 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m09:00:12.185933 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m09:00:12.201825 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:00:11.033784 => 09:00:12.201825
[0m09:00:12.201825 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D5B8E0>]}
[0m09:00:12.201825 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:12.201825 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.201825 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:12.201825 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m09:00:12.201825 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m09:00:12.201825 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m09:00:12.201825 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m09:00:12.233698 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m09:00:12.233698 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m09:00:12.233698 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 09:00:12.233698 => 09:00:12.233698
[0m09:00:12.233698 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m09:00:12.233698 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m09:00:12.233698 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:12.233698 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m09:00:12.892693 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac75094d-5305-475d-9fb4-a423dd8f8ef5&page=queryresults
[0m09:00:12.924651 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf11148a-9924-46b4-8535-89dba18fda63&page=queryresults
[0m09:00:13.327013 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 09:00:12.233698 => 09:00:13.327013
[0m09:00:13.327013 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6EB4670>]}
[0m09:00:13.327013 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m09:00:13.327013 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m09:00:13.327013 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.327013 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:00:13.327013 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:00:13.342880 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.342880 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:13.359034 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:00:13.342880 => 09:00:13.359034
[0m09:00:13.359034 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:13.359034 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:13.359034 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 09:00:12.185933 => 09:00:13.359034
[0m09:00:13.359034 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6EC22E0>]}
[0m09:00:13.374816 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:13.359034 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m09:00:13.374816 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m09:00:13.374816 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:00:13.374816 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m09:00:13.406707 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m09:00:13.406707 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m09:00:13.406707 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m09:00:13.406707 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m09:00:13.415231 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 09:00:13.406707 => 09:00:13.415231
[0m09:00:13.415231 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m09:00:13.422450 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m09:00:13.422450 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:13.422450 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m09:00:14.105775 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ba1ff02b-1d2b-44e0-b7e2-7b74e6712119&page=queryresults
[0m09:00:14.121696 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:726ac62a-9ee2-4682-8175-2fbc974d9e40&page=queryresults
[0m09:00:14.508484 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 09:00:13.415231 => 09:00:14.508484
[0m09:00:14.508484 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5D2FA00>]}
[0m09:00:14.508484 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m09:00:14.508484 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m09:00:14.508484 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:14.508484 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m09:00:14.508484 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m09:00:14.508484 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:14.524544 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:14.524544 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:00:13.359034 => 09:00:14.524544
[0m09:00:14.524544 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DA9E80>]}
[0m09:00:14.524544 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m09:00:14.524544 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:14.524544 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m09:00:14.524544 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:14.508484 => 09:00:14.524544
[0m09:00:14.524544 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m09:00:14.524544 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:14.540659 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto_fabricado)
[0m09:00:14.540659 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:14.540659 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m09:00:14.540659 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m09:00:14.556315 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:14.556315 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:14.585852 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 09:00:14.540659 => 09:00:14.585852
[0m09:00:14.585852 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m09:00:14.588182 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m09:00:14.588182 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:14.588182 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m09:00:15.370784 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6262ca46-3ee4-461e-b6fe-e768b5d04911&page=queryresults
[0m09:00:15.377907 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d67b917-97e0-4e24-8eb8-fc11f09038c5&page=queryresults
[0m09:00:15.736009 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:14.540659 => 09:00:15.736009
[0m09:00:15.736009 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6E39070>]}
[0m09:00:15.736009 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m09:00:15.736009 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:15.736009 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m09:00:15.736009 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m09:00:15.736009 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m09:00:15.736009 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m09:00:15.752000 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m09:00:15.752000 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 09:00:14.585852 => 09:00:15.752000
[0m09:00:15.752000 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DA9E80>]}
[0m09:00:15.752000 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 09:00:15.736009 => 09:00:15.752000
[0m09:00:15.752000 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m09:00:15.752000 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:15.767863 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m09:00:15.767863 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m09:00:15.767863 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m09:00:15.767863 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m09:00:15.767863 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m09:00:15.767863 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m09:00:15.767863 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m09:00:15.783753 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:15.783753 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 09:00:15.767863 => 09:00:15.783753
[0m09:00:15.783753 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m09:00:15.783753 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m09:00:15.783753 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m09:00:15.815716 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:15.815716 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m09:00:16.521836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9aa96e4c-6561-4e49-bc9a-8faa7a598222&page=queryresults
[0m09:00:16.860026 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4927d2ae-6a34-487e-a656-a6f9b5046498&page=queryresults
[0m09:00:16.880934 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 09:00:15.752000 => 09:00:16.880934
[0m09:00:16.880934 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6EF71C0>]}
[0m09:00:16.883221 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m09:00:16.883221 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m09:00:16.883221 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:16.883221 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m09:00:16.883221 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m09:00:16.883221 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:16.889273 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:16.889273 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:16.883221 => 09:00:16.889273
[0m09:00:16.889273 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:16.899299 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:17.307697 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 09:00:15.783753 => 09:00:17.307697
[0m09:00:17.307697 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DC5310>]}
[0m09:00:17.307697 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m09:00:17.307697 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m09:00:17.643569 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:17.647333 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:18.383467 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c951cf38-981b-4d6b-8d09-8f5f1c34aa3c&page=queryresults
[0m09:00:21.286271 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:16.891278 => 09:00:21.286271
[0m09:00:21.288282 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6E18400>]}
[0m09:00:21.290291 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.41s]
[0m09:00:21.290291 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:21.292303 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:21.292303 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m09:00:21.292303 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m09:00:21.296387 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:21.302158 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:21.304168 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:21.296387 => 09:00:21.304168
[0m09:00:21.304168 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:21.308191 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:21.963961 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:21.965976 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m09:00:22.716186 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6fd8d67e-0311-4846-8e69-554e07ec01d0&page=queryresults
[0m09:00:25.469584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:21.306180 => 09:00:25.469584
[0m09:00:25.471596 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6EAAE80>]}
[0m09:00:25.471596 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.18s]
[0m09:00:25.471596 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:25.471596 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:25.471596 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m09:00:25.471596 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:00:25.478475 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:25.478475 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:25.478475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:25.478475 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m09:00:25.478475 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m09:00:25.478475 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m09:00:25.478475 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m09:00:25.494604 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:25.478475 => 09:00:25.494604
[0m09:00:25.494604 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:25.494604 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:25.494604 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 09:00:25.478475 => 09:00:25.494604
[0m09:00:25.494604 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m09:00:25.554336 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:26.166062 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m09:00:26.168078 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m09:00:26.214433 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:26.214433 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:26.773985 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cdc8c167-5245-4f9a-b531-8cd01bd2c494&page=queryresults
[0m09:00:26.871649 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c9d7365-6861-4794-b086-8e4ade134cd2&page=queryresults
[0m09:00:28.855449 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:25.494604 => 09:00:28.855449
[0m09:00:28.855449 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DEFCA0>]}
[0m09:00:28.855449 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.38s]
[0m09:00:28.855449 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:28.862932 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m09:00:28.862932 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m09:00:28.864943 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m09:00:28.864943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m09:00:28.872991 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:28.872991 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 09:00:28.864943 => 09:00:28.872991
[0m09:00:28.872991 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m09:00:28.877745 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:29.275501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 09:00:25.494604 => 09:00:29.275501
[0m09:00:29.277514 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6F28220>]}
[0m09:00:29.279526 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.80s]
[0m09:00:29.279526 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m09:00:29.282197 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m09:00:29.282197 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m09:00:29.283937 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m09:00:29.283937 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m09:00:29.291975 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m09:00:29.291975 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 09:00:29.283937 => 09:00:29.291975
[0m09:00:29.295283 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m09:00:29.297293 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:29.526597 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:29.528609 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:29.901167 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad0f7f5a-076b-4e74-882b-238a58227f8b&page=queryresults
[0m09:00:29.935917 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m09:00:29.937933 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m09:00:30.573006 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a8a52ebe-7f98-48b6-a7ef-e96fcd58d483&page=queryresults
[0m09:00:31.865075 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 09:00:28.877745 => 09:00:31.865075
[0m09:00:31.867089 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6F2BE50>]}
[0m09:00:31.869103 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.00s]
[0m09:00:31.869103 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m09:00:31.869103 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:31.871116 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m09:00:31.871116 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m09:00:31.873126 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:31.886926 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m09:00:31.888937 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 09:00:31.873126 => 09:00:31.886926
[0m09:00:31.888937 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:31.956089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:32.747685 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m09:00:32.749701 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m09:00:33.094311 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d57caaec-a2f7-4c55-a940-c2abbb51ef85&page=queryresults
[0m09:00:33.376722 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 09:00:29.295283 => 09:00:33.376722
[0m09:00:33.378736 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D620A0>]}
[0m09:00:33.380752 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.09s]
[0m09:00:33.380752 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m09:00:33.383627 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m09:00:33.385641 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m09:00:33.385641 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m09:00:33.385641 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m09:00:33.385641 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:00:33.385641 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 09:00:33.385641 => 09:00:33.385641
[0m09:00:33.385641 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m09:00:33.401487 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:34.039575 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:00:34.042603 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m09:00:34.372112 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e2ef4a27-276c-4922-adc1-06f4affcedc1&page=queryresults
[0m09:00:35.067781 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 09:00:31.888937 => 09:00:35.067781
[0m09:00:35.069536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D62FD0>]}
[0m09:00:35.069536 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.20s]
[0m09:00:35.069536 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:35.069536 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m09:00:35.069536 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m09:00:35.069536 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m09:00:35.069536 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m09:00:35.069536 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m09:00:35.069536 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 09:00:35.069536 => 09:00:35.069536
[0m09:00:35.085713 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m09:00:35.085713 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:35.731886 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m09:00:35.733899 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m09:00:36.383303 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:14488282-6d00-451e-852e-bdf621803dab&page=queryresults
[0m09:00:36.825652 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 09:00:33.385641 => 09:00:36.823641
[0m09:00:36.825652 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6F987C0>]}
[0m09:00:36.827665 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.44s]
[0m09:00:36.829690 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m09:00:36.829690 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:36.829690 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m09:00:36.829690 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m09:00:36.835045 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:36.849206 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:00:36.851216 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 09:00:36.835045 => 09:00:36.851216
[0m09:00:36.853227 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:36.856996 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:37.477832 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:00:37.484802 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m09:00:37.881930 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b363935c-2048-4d83-8c8b-d6d597a5921a&page=queryresults
[0m09:00:39.752897 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 09:00:35.085713 => 09:00:39.752897
[0m09:00:39.754914 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D743D0>]}
[0m09:00:40.369130 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 09:00:36.853227 => 09:00:40.369130
[0m09:00:40.371145 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6F9EBE0>]}
[0m09:00:40.552346 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.69s]
[0m09:00:40.552346 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m09:00:40.555635 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m09:00:40.552346 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.54s]
[0m09:00:40.557883 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:40.557883 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m09:00:40.555635 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m09:00:40.562473 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m09:00:40.562473 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m09:00:40.570513 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m09:00:40.557883 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m09:00:40.572527 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m09:00:40.573641 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m09:00:40.573641 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:00:40.573641 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 09:00:40.562473 => 09:00:40.573641
[0m09:00:40.573641 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m09:00:40.573641 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:40.621249 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 09:00:40.573641 => 09:00:40.621249
[0m09:00:40.621249 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m09:00:40.621249 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:41.296110 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:00:41.300139 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m09:00:41.342166 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m09:00:41.348127 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:41.760385 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:365b0567-e19c-4434-bb3f-ee992c7e82c6&page=queryresults
[0m09:00:41.940994 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d07581a9-0745-4284-934d-0081265e768f&page=queryresults
[0m09:00:44.426093 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 09:00:40.573641 => 09:00:44.424080
[0m09:00:44.430232 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6DA8BB0>]}
[0m09:00:44.430232 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.87s]
[0m09:00:44.434550 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m09:00:44.929939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 09:00:40.621249 => 09:00:44.929939
[0m09:00:44.929939 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6FB7130>]}
[0m09:00:44.929939 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.36s]
[0m09:00:44.929939 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m09:00:44.938340 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:44.939446 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m09:00:44.939446 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m09:00:44.939446 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:44.957583 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m09:00:44.959599 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 09:00:44.942346 => 09:00:44.957583
[0m09:00:44.959599 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:44.963624 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:45.628867 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m09:00:45.628867 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:46.378029 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c3858ad-e688-478b-9c21-30761253b7e2&page=queryresults
[0m09:00:50.096047 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 09:00:44.959599 => 09:00:50.094034
[0m09:00:50.096047 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676552f6-f0eb-4aa3-9ec9-60cbe89a9597', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD6D628B0>]}
[0m09:00:50.098058 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.16s]
[0m09:00:50.100071 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:50.101584 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:50.104439 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:50.104439 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:50.104439 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:00:50.106451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:50.106451 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m09:00:50.106451 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m09:00:50.106451 [info ] [MainThread]: 
[0m09:00:50.108461 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 44.77 seconds (44.77s).
[0m09:00:50.114489 [debug] [MainThread]: Command end result
[0m09:00:50.131566 [info ] [MainThread]: 
[0m09:00:50.133317 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:50.133317 [info ] [MainThread]: 
[0m09:00:50.133317 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m09:00:50.133317 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:50.133317 after 45.85 seconds
[0m09:00:50.138006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD2373430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD4CB9A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CD5AAD0D0>]}
[0m09:00:50.138006 [debug] [MainThread]: Flushing usage events
[0m09:00:54.263407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4C829430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4B7A59A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4B7A5D30>]}


============================== 09:00:54.278040 | ac9dd408-01e7-4789-8b5c-9f93f10823b1 ==============================
[0m09:00:54.278040 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:54.278040 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:55.135976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4B7B58B0>]}
[0m09:00:55.199730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4FE90970>]}
[0m09:00:55.206877 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:55.215397 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:55.263112 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:55.263112 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:55.263112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B501978B0>]}
[0m09:00:55.279088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B500956D0>]}
[0m09:00:55.279088 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:55.279088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B500954C0>]}
[0m09:00:55.279088 [info ] [MainThread]: 
[0m09:00:55.279088 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:55.279088 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:55.279088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:55.970438 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:00:55.986354 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:55.986354 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:55.986354 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:56.596682 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:56.612826 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:56.612826 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:00:56.612826 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:57.228386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B500957F0>]}
[0m09:00:57.228386 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:57.228386 [info ] [MainThread]: 
[0m09:00:57.244116 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:57.244116 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m09:00:57.244116 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m09:00:57.244116 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:57.260082 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 09:00:57.244116 => 09:00:57.260082
[0m09:00:57.260082 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:57.307746 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:57.309750 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m09:00:58.206370 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3609977b-384a-4aa3-80cd-8b231bb6df49&page=queryresults
[0m09:00:59.335153 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m09:00:59.788293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:832a63d3-df76-4700-8446-a42ae0abd443&page=queryresults
[0m09:01:02.537384 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m09:01:03.403891 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m09:01:03.405904 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m09:01:03.775633 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf9562a9-0934-4652-ad6d-d97028b24cb4&page=queryresults
[0m09:01:05.720306 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 09:00:57.260082 => 09:01:05.720306
[0m09:01:05.726018 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ac9dd408-01e7-4789-8b5c-9f93f10823b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B5124E250>]}
[0m09:01:05.726018 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.48s]
[0m09:01:05.726018 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:01:05.726018 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:01:05.726018 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:01:05.726018 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:01:05.726018 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:01:05.726018 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m09:01:05.736332 [info ] [MainThread]: 
[0m09:01:05.736332 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.46 seconds (10.46s).
[0m09:01:05.736332 [debug] [MainThread]: Command end result
[0m09:01:05.752264 [info ] [MainThread]: 
[0m09:01:05.752264 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:01:05.752264 [info ] [MainThread]: 
[0m09:01:05.752264 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:01:05.752264 [debug] [MainThread]: Command `dbt snapshot` succeeded at 09:01:05.752264 after 11.55 seconds
[0m09:01:05.752264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4C829430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4A8B76D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B4FF61F10>]}
[0m09:01:05.752264 [debug] [MainThread]: Flushing usage events
[0m09:01:10.000747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D960E9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9507F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9507FE20>]}


============================== 09:01:10.012242 | e9af196a-5d4f-4ac9-9131-c8d35dc5c83d ==============================
[0m09:01:10.012242 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:01:10.012242 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:01:10.844069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9507F910>]}
[0m09:01:10.892228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D99676400>]}
[0m09:01:10.892228 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:01:10.908241 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:01:10.956257 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:01:10.956257 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:01:10.956257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D99A58520>]}
[0m09:01:10.972354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9994F340>]}
[0m09:01:10.972354 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:01:10.972354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9994F160>]}
[0m09:01:10.972354 [info ] [MainThread]: 
[0m09:01:10.972354 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:01:10.972354 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:01:10.972354 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:11.639873 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:01:11.641364 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:11.643357 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:01:11.644324 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:12.348953 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:01:12.348953 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:12.412988 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:01:12.412988 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:13.021832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9971E880>]}
[0m09:01:13.021832 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:01:13.038006 [info ] [MainThread]: 
[0m09:01:13.038006 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:13.038006 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m09:01:13.038006 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m09:01:13.038006 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:13.070214 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:01:13.070214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 09:01:13.038006 => 09:01:13.070214
[0m09:01:13.070214 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:13.086332 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:01:13.706443 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:01:13.707693 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m09:01:14.029620 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b2cd2255-0876-4e0c-9bc3-0c0d5656181b&page=queryresults
[0m09:01:16.571115 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 09:01:13.070214 => 09:01:16.571115
[0m09:01:16.571115 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9AACFB20>]}
[0m09:01:16.571115 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.53s]
[0m09:01:16.571115 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:16.571115 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:01:16.586994 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m09:01:16.586994 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m09:01:16.586994 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:01:16.586994 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:01:16.586994 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:01:16.586994 => 09:01:16.586994
[0m09:01:16.586994 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:01:16.586994 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:01:17.220785 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:01:17.220785 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m09:01:17.622444 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:74c51cc2-dacb-468f-a45c-6050002d2ad6&page=queryresults
[0m09:01:19.514776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:01:16.586994 => 09:01:19.514776
[0m09:01:19.514776 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9af196a-5d4f-4ac9-9131-c8d35dc5c83d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D9AAF6EB0>]}
[0m09:01:19.514776 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 2.93s]
[0m09:01:19.514776 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:01:19.530774 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:01:19.530774 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:01:19.530774 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:01:19.530774 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:01:19.530774 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m09:01:19.530774 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m09:01:19.530774 [info ] [MainThread]: 
[0m09:01:19.530774 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.56 seconds (8.56s).
[0m09:01:19.530774 [debug] [MainThread]: Command end result
[0m09:01:19.546788 [info ] [MainThread]: 
[0m09:01:19.546788 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:01:19.546788 [info ] [MainThread]: 
[0m09:01:19.546788 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m09:01:19.546788 [debug] [MainThread]: Command `dbt run` succeeded at 09:01:19.546788 after 9.62 seconds
[0m09:01:19.562794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D960E9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D93D776D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023D997EFFA0>]}
[0m09:01:19.562794 [debug] [MainThread]: Flushing usage events
[0m10:00:05.551234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AA9E2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4A99646D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4A9964E20>]}


============================== 10:00:05.568140 | eb439a53-20a6-4a53-bb9b-4ee473912715 ==============================
[0m10:00:05.568140 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:05.568140 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m10:00:06.477344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4ACB2AB80>]}
[0m10:00:06.541251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE052640>]}
[0m10:00:06.541251 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:06.557211 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:06.684063 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:06.684063 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:06.684063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE348790>]}
[0m10:00:06.718102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE2475B0>]}
[0m10:00:06.720114 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:06.722131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE2473A0>]}
[0m10:00:06.726224 [info ] [MainThread]: 
[0m10:00:06.731627 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:06.731627 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.737858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.737858 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.737858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.637199 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:08.309604 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:00:08.309604 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.309604 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:08.317141 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.976443 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:00:08.976443 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:09.032012 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:00:09.032012 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:09.841990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE0A8A30>]}
[0m10:00:09.846017 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:09.846017 [info ] [MainThread]: 
[0m10:00:09.857758 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.857758 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.857758 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:09.857758 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:09.857758 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:09.857758 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.857758 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:09.885813 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.885813 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.889889 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.889889 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:09.869920 => 10:00:09.889889
[0m10:00:09.889889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:09.885813 => 10:00:09.889889
[0m10:00:09.889889 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.889889 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.961702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.963710 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.965726 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:09.969679 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:09.969679 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:10.001238 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:10.896977 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6568d8e7-6592-40c7-ac47-9f45ef7a6958&page=queryresults
[0m10:00:10.911020 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0f59610-6fb6-4b03-a710-5c5f52198b26&page=queryresults
[0m10:00:11.389240 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:09.937602 => 10:00:11.389240
[0m10:00:11.389240 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:09.889889 => 10:00:11.389240
[0m10:00:11.389240 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF47F550>]}
[0m10:00:11.389240 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF473400>]}
[0m10:00:11.389240 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m10:00:11.389240 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:11.389240 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.389240 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m10:00:11.389240 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:11.389240 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m10:00:11.389240 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:11.389240 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:11.405030 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.389240 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m10:00:11.405030 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m10:00:11.405030 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m10:00:11.405030 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m10:00:11.405030 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.405030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 10:00:11.405030 => 10:00:11.405030
[0m10:00:11.420787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:11.405030 => 10:00:11.420787
[0m10:00:11.420787 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.420787 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m10:00:11.420787 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.420787 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m10:00:11.420787 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.420787 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.436830 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m10:00:11.468582 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:12.283718 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fd12b76-5699-4793-b558-55a6539dcf2a&page=queryresults
[0m10:00:12.299743 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25a336c4-6532-4a48-8c90-6767ac877217&page=queryresults
[0m10:00:12.666013 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:11.420787 => 10:00:12.666013
[0m10:00:12.666013 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF40EE20>]}
[0m10:00:12.666013 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m10:00:12.666013 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:12.666013 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:12.666013 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:00:12.666013 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:00:12.666013 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:00:12.682106 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:12.682106 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:00:12.666013 => 10:00:12.682106
[0m10:00:12.682106 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:00:12.682106 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:12.682106 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:12.682106 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:00:12.729744 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 10:00:11.420787 => 10:00:12.713944
[0m10:00:12.729744 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF40E8B0>]}
[0m10:00:12.729744 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m10:00:12.729744 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m10:00:12.729744 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:12.729744 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:12.729744 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:12.729744 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:12.729744 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:12.729744 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:12.729744 => 10:00:12.729744
[0m10:00:12.729744 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:12.745777 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:12.745777 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:12.745777 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:13.455717 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:031210f1-7ce5-47fa-87b3-31732a43a3ad&page=queryresults
[0m10:00:13.468356 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:da040d6c-2eba-4600-b9d8-f5b9ecb6ac89&page=queryresults
[0m10:00:13.830220 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:00:12.682106 => 10:00:13.830220
[0m10:00:13.830220 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF4A8040>]}
[0m10:00:13.830220 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m10:00:13.830220 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:13.830220 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m10:00:13.845444 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m10:00:13.845444 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m10:00:13.848487 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m10:00:13.850500 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m10:00:13.850500 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 10:00:13.848487 => 10:00:13.850500
[0m10:00:13.850500 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m10:00:13.865261 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m10:00:13.867267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:13.869274 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m10:00:13.908676 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:12.729744 => 10:00:13.908676
[0m10:00:13.908676 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF45F460>]}
[0m10:00:13.908676 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m10:00:13.908676 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:13.908676 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:00:13.908676 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m10:00:13.908676 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m10:00:13.908676 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:00:13.908676 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:13.908676 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:00:13.908676 => 10:00:13.908676
[0m10:00:13.908676 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:00:13.924405 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:13.924405 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:13.924405 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:00:14.634060 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4ff7ec2e-5f1c-4a96-8888-0510a28a9fd1&page=queryresults
[0m10:00:14.665416 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f3feb749-d91e-4a97-b0ce-c723a0ec7499&page=queryresults
[0m10:00:15.033452 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:00:13.908676 => 10:00:15.033452
[0m10:00:15.033452 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE3C1970>]}
[0m10:00:15.033452 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m10:00:15.033452 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:00:15.042032 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:15.042032 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:15.042032 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:15.042032 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:15.046980 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:15.046980 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:15.042032 => 10:00:15.046980
[0m10:00:15.046980 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:15.046980 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:15.046980 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:15.062870 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:15.103654 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 10:00:13.861238 => 10:00:15.103654
[0m10:00:15.105663 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF3BCA90>]}
[0m10:00:15.105663 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m10:00:15.105663 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m10:00:15.105663 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:00:15.105663 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m10:00:15.110982 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m10:00:15.110982 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:00:15.110982 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:00:15.110982 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:00:15.110982 => 10:00:15.110982
[0m10:00:15.110982 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:00:15.110982 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:00:15.127088 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:15.127088 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:00:15.933658 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:127cd705-a43a-46fb-8f73-4f82ca701c62&page=queryresults
[0m10:00:16.049204 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbddb786-2e36-45b7-8275-dc381098da99&page=queryresults
[0m10:00:16.369686 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:15.046980 => 10:00:16.369686
[0m10:00:16.373002 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF40EA60>]}
[0m10:00:16.373002 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m10:00:16.375015 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:16.375015 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:16.377028 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m10:00:16.379043 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m10:00:16.379043 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:16.385626 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:16.385626 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:16.379043 => 10:00:16.385626
[0m10:00:16.385626 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:16.385626 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:16.385626 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:16.393405 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:16.469121 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:00:15.110982 => 10:00:16.469121
[0m10:00:16.471127 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF43C310>]}
[0m10:00:16.471127 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m10:00:16.471127 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:00:16.471127 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m10:00:16.471127 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m10:00:16.471127 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m10:00:16.471127 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m10:00:16.478994 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:00:16.478994 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 10:00:16.471127 => 10:00:16.478994
[0m10:00:16.478994 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m10:00:16.494888 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:00:16.509782 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:16.512811 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m10:00:17.194435 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4f56eef-38f6-4d86-929a-0b6c02fbe685&page=queryresults
[0m10:00:17.258605 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be29d348-f092-4ffb-8586-d1f9d24194af&page=queryresults
[0m10:00:17.610517 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:16.385626 => 10:00:17.610517
[0m10:00:17.610517 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE3C1970>]}
[0m10:00:17.610517 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m10:00:17.610517 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:17.610517 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m10:00:17.610517 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m10:00:17.610517 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m10:00:17.610517 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m10:00:17.610517 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m10:00:17.610517 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 10:00:17.610517 => 10:00:17.610517
[0m10:00:17.610517 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m10:00:17.610517 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m10:00:17.626377 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:17.627194 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m10:00:17.704435 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 10:00:16.478994 => 10:00:17.704435
[0m10:00:17.706451 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF548100>]}
[0m10:00:17.708466 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:00:17.710476 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m10:00:17.710476 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m10:00:17.712486 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m10:00:17.713492 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m10:00:17.713492 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m10:00:17.718392 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m10:00:17.720398 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 10:00:17.713492 => 10:00:17.720398
[0m10:00:17.720398 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m10:00:17.720398 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m10:00:17.720398 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:17.720398 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m10:00:18.352749 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:349eeff5-6d90-4928-b90c-2eebd7d0c718&page=queryresults
[0m10:00:18.687849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbe5f05b-fbe8-48f8-ac9e-32e754dd28d0&page=queryresults
[0m10:00:18.734909 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 10:00:17.610517 => 10:00:18.734909
[0m10:00:18.734909 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF570580>]}
[0m10:00:18.734909 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m10:00:18.734909 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m10:00:18.734909 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:18.734909 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m10:00:18.734909 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m10:00:18.748025 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:18.758094 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:18.760105 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:18.748025 => 10:00:18.758094
[0m10:00:18.760105 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:18.769874 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:19.098906 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 10:00:17.720398 => 10:00:19.098906
[0m10:00:19.098906 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF3F6CD0>]}
[0m10:00:19.098906 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m10:00:19.098906 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m10:00:19.439971 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:19.439971 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:20.060096 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae371cf7-4ffe-499d-a746-9fee9e66308a&page=queryresults
[0m10:00:22.589355 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:18.760105 => 10:00:22.589355
[0m10:00:22.589355 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF54EB50>]}
[0m10:00:22.589355 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.85s]
[0m10:00:22.589355 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:22.589355 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:22.589355 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:00:22.589355 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m10:00:22.589355 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:22.605229 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:22.605229 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:22.605229 => 10:00:22.605229
[0m10:00:22.605229 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:22.605229 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:23.253416 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:23.253416 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m10:00:23.968882 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf4fcf16-3e4a-4bcc-b308-2778f595f46c&page=queryresults
[0m10:00:26.764722 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:22.605229 => 10:00:26.764722
[0m10:00:26.766184 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE39C190>]}
[0m10:00:26.768198 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.18s]
[0m10:00:26.768198 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:26.768198 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:26.768198 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m10:00:26.768198 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:00:26.776315 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:26.768198 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m10:00:26.776315 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:26.780007 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m10:00:26.789828 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:26.789828 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m10:00:26.789828 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m10:00:26.797498 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:26.781748 => 10:00:26.797498
[0m10:00:26.797498 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:26.801510 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:26.801510 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 10:00:26.789828 => 10:00:26.801510
[0m10:00:26.801510 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m10:00:26.839508 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:27.450941 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:27.452956 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:27.470007 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m10:00:27.472021 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m10:00:28.126976 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86b6795d-d750-4a01-9ba6-caa7c949621c&page=queryresults
[0m10:00:28.146977 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d849d7b4-3efa-43b0-9f9d-fc8379d6b3d7&page=queryresults
[0m10:00:30.343464 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 10:00:26.801510 => 10:00:30.343464
[0m10:00:30.343464 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF3CC610>]}
[0m10:00:30.343464 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.57s]
[0m10:00:30.343464 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m10:00:30.359138 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:00:30.359138 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:00:30.359138 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m10:00:30.359138 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:00:30.359138 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:30.359138 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:00:30.359138 => 10:00:30.359138
[0m10:00:30.359138 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:00:30.359138 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:30.391230 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:26.797498 => 10:00:30.391230
[0m10:00:30.391230 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4B05A4B20>]}
[0m10:00:30.391230 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.62s]
[0m10:00:30.391230 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:30.391230 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:00:30.391230 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m10:00:30.391230 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m10:00:30.391230 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:00:30.391230 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:00:30.391230 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:00:30.391230 => 10:00:30.391230
[0m10:00:30.391230 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:00:30.407050 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:31.029131 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:00:31.029131 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:00:31.045151 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:31.045151 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:31.443839 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2ba04854-3005-4620-9f87-477241c4180a&page=queryresults
[0m10:00:31.797892 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1f65039-a596-4ed7-8cef-32c5a4aecf34&page=queryresults
[0m10:00:33.693223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:00:30.359138 => 10:00:33.693223
[0m10:00:33.694217 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE116C70>]}
[0m10:00:33.695226 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.34s]
[0m10:00:33.696254 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:00:33.697224 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:33.697224 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m10:00:33.697224 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m10:00:33.697224 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:33.697224 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:00:33.697224 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 10:00:33.697224 => 10:00:33.697224
[0m10:00:33.697224 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:33.713347 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:34.286722 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:00:30.391230 => 10:00:34.286722
[0m10:00:34.286722 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE39C280>]}
[0m10:00:34.286722 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.90s]
[0m10:00:34.286722 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:00:34.302756 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:34.302756 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m10:00:34.302756 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m10:00:34.305716 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:00:34.313775 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:34.315789 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:00:34.305716 => 10:00:34.315789
[0m10:00:34.317802 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:00:34.318812 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:34.427056 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:00:34.429070 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m10:00:34.788037 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b95a50e8-cee9-498d-959e-50a869e184b8&page=queryresults
[0m10:00:34.958560 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:34.960577 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:00:35.353799 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4032e306-9733-431c-80c7-2fae66a3d2e7&page=queryresults
[0m10:00:37.575561 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 10:00:33.697224 => 10:00:37.575561
[0m10:00:37.575561 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF4B9310>]}
[0m10:00:37.575561 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.88s]
[0m10:00:37.591630 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:37.591630 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m10:00:37.591630 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m10:00:37.591630 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m10:00:37.591630 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m10:00:37.591630 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:00:37.591630 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 10:00:37.591630 => 10:00:37.591630
[0m10:00:37.591630 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m10:00:37.607886 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:37.624020 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:00:34.318812 => 10:00:37.624020
[0m10:00:37.624020 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4B05D3F70>]}
[0m10:00:37.624020 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.32s]
[0m10:00:37.624020 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:37.624020 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.624020 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m10:00:37.639833 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:00:37.639833 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.639833 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:37.639833 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:00:37.639833 => 10:00:37.639833
[0m10:00:37.639833 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.639833 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:38.417999 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:38.417999 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:00:38.533636 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:00:38.535651 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m10:00:38.809753 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7821361-2aa1-495c-b18c-c1b3a124e7cd&page=queryresults
[0m10:00:39.136679 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:194d382e-9c94-4ed1-be6b-dd928fe28f23&page=queryresults
[0m10:00:41.037913 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:00:37.639833 => 10:00:41.037913
[0m10:00:41.037913 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF45F8E0>]}
[0m10:00:41.892356 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.40s]
[0m10:00:41.892356 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:41.892356 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.892356 [info ] [Thread-2  ]: 25 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m10:00:41.892356 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m10:00:41.892356 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.908221 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:41.908221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:00:41.892356 => 10:00:41.908221
[0m10:00:41.908221 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.908221 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:42.209765 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 10:00:37.607886 => 10:00:42.209765
[0m10:00:42.209765 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF4BF6A0>]}
[0m10:00:42.209765 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.62s]
[0m10:00:42.209765 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m10:00:42.209765 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m10:00:42.225826 [info ] [Thread-1  ]: 26 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m10:00:42.225826 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m10:00:42.225826 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m10:00:42.225826 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:00:42.225826 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 10:00:42.225826 => 10:00:42.225826
[0m10:00:42.225826 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m10:00:42.241646 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:42.560457 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:42.560457 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m10:00:42.927897 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:00:42.927897 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:43.024562 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6cf96cc4-503d-4d21-a97d-1fec23343b46&page=queryresults
[0m10:00:43.637195 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e2e09b54-b259-493b-9172-81e68ef86157&page=queryresults
[0m10:00:46.472025 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:00:41.908221 => 10:00:46.472025
[0m10:00:46.472025 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4B058A1F0>]}
[0m10:00:46.472025 [info ] [Thread-2  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.58s]
[0m10:00:46.472025 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:46.472025 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.472025 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m10:00:46.488218 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m10:00:46.488218 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.488218 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:00:46.488218 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 10:00:46.488218 => 10:00:46.488218
[0m10:00:46.488218 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.488218 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:46.803321 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 10:00:42.241646 => 10:00:46.803321
[0m10:00:46.803321 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF436580>]}
[0m10:00:46.807229 [info ] [Thread-1  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.58s]
[0m10:00:46.809240 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m10:00:47.119107 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:00:47.119107 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:47.763594 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:357e59bd-f501-4024-b81e-698c99c50b51&page=queryresults
[0m10:00:52.424030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 10:00:46.488218 => 10:00:52.422005
[0m10:00:52.426053 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb439a53-20a6-4a53-bb9b-4ee473912715', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AF4364F0>]}
[0m10:00:52.426053 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.95s]
[0m10:00:52.428076 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:52.431836 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:52.431836 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:52.435829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:52.435829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:52.435829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:00:52.437841 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m10:00:52.437841 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m10:00:52.437841 [info ] [MainThread]: 
[0m10:00:52.439854 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 45.71 seconds (45.71s).
[0m10:00:52.449371 [debug] [MainThread]: Command end result
[0m10:00:52.463354 [info ] [MainThread]: 
[0m10:00:52.463354 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:52.463354 [info ] [MainThread]: 
[0m10:00:52.463354 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m10:00:52.471469 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:52.471469 after 46.99 seconds
[0m10:00:52.471469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AA9E2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4B05B68B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4AE11C6D0>]}
[0m10:00:52.471469 [debug] [MainThread]: Flushing usage events
[0m10:00:57.453138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C615FB9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C614F49910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C614F49B80>]}


============================== 10:00:57.453138 | 7a765417-a190-40a8-9e7a-06da1e64a992 ==============================
[0m10:00:57.453138 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:57.453138 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:00:58.360875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C614F29F70>]}
[0m10:00:58.456545 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C614EFFBE0>]}
[0m10:00:58.456545 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:58.456545 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:58.536157 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:58.551986 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:58.551986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C619927AC0>]}
[0m10:00:58.583753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6197528E0>]}
[0m10:00:58.583753 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:58.583753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C619752700>]}
[0m10:00:58.583753 [info ] [MainThread]: 
[0m10:00:58.583753 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:58.583753 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:58.583753 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:59.257977 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:59.257977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:59.257977 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:59.257977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:59.958737 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:59.958737 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:59.990522 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:00:59.990522 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:00.755837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6196856D0>]}
[0m10:01:00.755837 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:01:00.771828 [info ] [MainThread]: 
[0m10:01:00.771828 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:00.771828 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:01:00.771828 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:01:00.771828 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:00.803680 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:01:00.787646 => 10:01:00.803680
[0m10:01:00.803680 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:00.851828 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:01:00.851828 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:01:01.637663 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c1e3f6e-f020-41d0-96da-7c217fc3459a&page=queryresults
[0m10:01:02.759169 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:01:03.284390 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e4399e0a-f341-4a15-a286-eb526777abe1&page=queryresults
[0m10:01:06.476504 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:01:07.222838 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:01:07.224847 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:01:07.693719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:455bd1c1-6eec-4dcf-a7a0-7e7a51a1fc36&page=queryresults
[0m10:01:09.918473 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:01:00.803680 => 10:01:09.918473
[0m10:01:09.918473 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a765417-a190-40a8-9e7a-06da1e64a992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C61A9FD490>]}
[0m10:01:09.918473 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 9.15s]
[0m10:01:09.918473 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:09.918473 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:09.918473 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:09.918473 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:01:09.933412 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:01:09.933412 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:01:09.933412 [info ] [MainThread]: 
[0m10:01:09.934418 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.35 seconds (11.35s).
[0m10:01:09.934418 [debug] [MainThread]: Command end result
[0m10:01:09.949743 [info ] [MainThread]: 
[0m10:01:09.949743 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:09.949743 [info ] [MainThread]: 
[0m10:01:09.949743 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:01:09.949743 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:01:09.949743 after 12.58 seconds
[0m10:01:09.949743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C615FB9430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C614EFFBE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C61A9FD820>]}
[0m10:01:09.949743 [debug] [MainThread]: Flushing usage events
[0m10:01:14.687904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199236F7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019922680640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019922680AC0>]}


============================== 10:01:14.692961 | 9324b556-3ae2-4ea0-9e84-2639921ca178 ==============================
[0m10:01:14.692961 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:01:14.692961 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:01:15.613696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992266E910>]}
[0m10:01:15.677052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199206B1DC0>]}
[0m10:01:15.677052 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:01:15.692842 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:01:15.740490 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:01:15.740490 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:01:15.756582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019927067F40>]}
[0m10:01:15.772744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019926F7FDF0>]}
[0m10:01:15.772744 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:01:15.772744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019926F7FBE0>]}
[0m10:01:15.772744 [info ] [MainThread]: 
[0m10:01:15.772744 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:01:15.772744 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:01:15.772744 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:16.444078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:01:16.450279 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:16.450279 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:01:16.453913 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:17.084399 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:01:17.100254 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:17.132253 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:01:17.132253 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:17.995490 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019927067F70>]}
[0m10:01:17.995490 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:01:17.995490 [info ] [MainThread]: 
[0m10:01:18.011537 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:18.011537 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:01:18.011537 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:01:18.011537 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:18.043398 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:18.043398 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:01:18.027318 => 10:01:18.043398
[0m10:01:18.043398 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:18.059082 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:01:18.737677 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:18.737677 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m10:01:19.200070 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:30405350-7201-4b28-be85-70272b5084b4&page=queryresults
[0m10:01:21.399424 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:01:18.043398 => 10:01:21.399424
[0m10:01:21.399424 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019928105F10>]}
[0m10:01:21.399424 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.39s]
[0m10:01:21.415175 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:21.415175 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:01:21.415175 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m10:01:21.415175 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m10:01:21.415175 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:01:21.415175 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:01:21.415175 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:01:21.415175 => 10:01:21.415175
[0m10:01:21.415175 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:01:21.415175 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:01:22.009731 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:01:22.009731 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m10:01:22.429850 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:62302911-8a62-4519-a2dc-54a4cb08320c&page=queryresults
[0m10:01:24.655352 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:01:21.415175 => 10:01:24.655352
[0m10:01:24.655352 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9324b556-3ae2-4ea0-9e84-2639921ca178', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199280E6190>]}
[0m10:01:24.655352 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.24s]
[0m10:01:24.671225 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:01:24.671225 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:24.671225 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:24.671225 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:01:24.671225 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:24.671225 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:01:24.671225 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:01:24.671225 [info ] [MainThread]: 
[0m10:01:24.671225 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.90 seconds (8.90s).
[0m10:01:24.671225 [debug] [MainThread]: Command end result
[0m10:01:24.703017 [info ] [MainThread]: 
[0m10:01:24.703017 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:24.703017 [info ] [MainThread]: 
[0m10:01:24.703017 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m10:01:24.703017 [debug] [MainThread]: Command `dbt run` succeeded at 10:01:24.703017 after 10.11 seconds
[0m10:01:24.703017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199236F7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019926E3E190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019926052970>]}
[0m10:01:24.703017 [debug] [MainThread]: Flushing usage events
[0m11:00:13.485527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7B0433D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E79FC19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E79FC1B80>]}


============================== 11:00:13.497301 | cfc208f5-3c7f-45c4-8d84-26c903a7243d ==============================
[0m11:00:13.497301 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:13.497301 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:14.337661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E79FAA130>]}
[0m11:00:14.402109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E6B2460>]}
[0m11:00:14.402109 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:14.449911 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:18.295550 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:18.295550 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:18.311265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E9A8640>]}
[0m11:00:18.358885 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E8A2580>]}
[0m11:00:18.358885 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:18.358885 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E72DB20>]}
[0m11:00:18.358885 [info ] [MainThread]: 
[0m11:00:18.358885 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:18.358885 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:18.358885 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:18.358885 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:18.358885 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:19.155869 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:19.810326 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:19.810326 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:19.810326 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:19.810326 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:20.613781 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:20.613781 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:20.697040 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:00:20.698051 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:21.325069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E710100>]}
[0m11:00:21.325069 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:21.325069 [info ] [MainThread]: 
[0m11:00:21.325069 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:21.325069 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:21.325069 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m11:00:21.325069 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m11:00:21.325069 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:21.341181 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:21.341181 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:21.341181 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:21.341181 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:21.357070 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:21.357070 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:21.341181 => 11:00:21.357070
[0m11:00:21.357070 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:21.341181 => 11:00:21.357070
[0m11:00:21.357070 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:21.357070 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:21.389099 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:21.389099 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:21.405178 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:21.405178 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:21.405178 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m11:00:21.425662 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:22.321575 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ad028af-e370-494b-a9ad-fc01dd12210a&page=queryresults
[0m11:00:22.321575 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8249db2e-e9ed-48b5-9821-26209365e4c9&page=queryresults
[0m11:00:22.787203 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:21.357070 => 11:00:22.787203
[0m11:00:22.787203 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA66880>]}
[0m11:00:22.802963 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:21.389099 => 11:00:22.802963
[0m11:00:22.802963 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m11:00:22.802963 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAD2850>]}
[0m11:00:22.802963 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:22.802963 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:22.802963 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m11:00:22.802963 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:22.802963 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m11:00:22.802963 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m11:00:22.802963 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:22.802963 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:22.802963 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m11:00:22.802963 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m11:00:22.802963 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m11:00:22.819153 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:22.819153 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m11:00:22.819153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 11:00:22.802963 => 11:00:22.819153
[0m11:00:22.819153 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m11:00:22.819153 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:22.802963 => 11:00:22.819153
[0m11:00:22.835254 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m11:00:22.835254 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:22.835254 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:22.835254 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:22.835254 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m11:00:22.835254 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:22.867364 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:23.620544 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb063b4a-3ba2-4d4c-b906-4c3c3ab06a1c&page=queryresults
[0m11:00:23.683839 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:065260f3-9622-4f47-9876-19b7dd96dac7&page=queryresults
[0m11:00:24.047901 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:22.835254 => 11:00:24.047901
[0m11:00:24.055386 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA43250>]}
[0m11:00:24.057223 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m11:00:24.057223 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:24.057223 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:24.057223 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m11:00:24.057223 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m11:00:24.057223 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m11:00:24.057223 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:24.071332 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 11:00:24.057223 => 11:00:24.071332
[0m11:00:24.071332 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m11:00:24.071332 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:24.071332 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:24.071332 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m11:00:24.119449 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 11:00:22.819153 => 11:00:24.119449
[0m11:00:24.119449 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAE4D00>]}
[0m11:00:24.119449 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m11:00:24.119449 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m11:00:24.119449 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m11:00:24.119449 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m11:00:24.119449 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m11:00:24.135614 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m11:00:24.135614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:24.135614 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 11:00:24.135614 => 11:00:24.135614
[0m11:00:24.135614 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m11:00:24.135614 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:24.135614 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:24.135614 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m11:00:24.832692 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b134b18c-5d5f-4395-a50d-e7282502e7b2&page=queryresults
[0m11:00:24.887869 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3705d81-6d40-4e37-af74-e5bb9d52cbe2&page=queryresults
[0m11:00:25.257261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 11:00:24.071332 => 11:00:25.257261
[0m11:00:25.257261 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA3A190>]}
[0m11:00:25.257261 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m11:00:25.257261 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:25.257261 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m11:00:25.257261 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m11:00:25.272903 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m11:00:25.275401 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m11:00:25.279426 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m11:00:25.281433 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 11:00:25.275401 => 11:00:25.281433
[0m11:00:25.281433 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m11:00:25.285447 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m11:00:25.287453 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:25.288958 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m11:00:25.319652 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 11:00:24.135614 => 11:00:25.319652
[0m11:00:25.320658 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAE4D00>]}
[0m11:00:25.320658 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m11:00:25.320658 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m11:00:25.320658 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m11:00:25.320658 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m11:00:25.320658 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m11:00:25.320658 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m11:00:25.320658 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:25.320658 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 11:00:25.320658 => 11:00:25.320658
[0m11:00:25.320658 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m11:00:25.320658 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:25.336672 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:25.339403 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m11:00:26.252921 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8dbf8ee7-0eda-4592-a117-ec5a6348eff2&page=queryresults
[0m11:00:26.316860 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:402e9649-9314-41fb-9631-8664ffb6dd79&page=queryresults
[0m11:00:26.679523 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 11:00:25.283441 => 11:00:26.678521
[0m11:00:26.680522 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA3A190>]}
[0m11:00:26.680522 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m11:00:26.681519 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m11:00:26.682489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:26.683518 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m11:00:26.684518 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m11:00:26.684518 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:26.688667 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:26.690684 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 11:00:26.684518 => 11:00:26.689653
[0m11:00:26.690684 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:26.699886 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:26.700885 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:26.701885 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m11:00:26.808004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 11:00:25.320658 => 11:00:26.808004
[0m11:00:26.808004 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FB22580>]}
[0m11:00:26.808004 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m11:00:26.808004 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m11:00:26.808004 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m11:00:26.808004 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m11:00:26.808004 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m11:00:26.808004 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m11:00:26.824154 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m11:00:26.824154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 11:00:26.808004 => 11:00:26.824154
[0m11:00:26.824154 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m11:00:26.824154 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m11:00:26.824154 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:26.840258 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m11:00:27.418729 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2f28568-ca7f-443b-94e4-e448f337b133&page=queryresults
[0m11:00:27.563217 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3e5b935d-cee7-43a6-a085-1d1d03588453&page=queryresults
[0m11:00:27.788248 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 11:00:26.691665 => 11:00:27.788248
[0m11:00:27.788248 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAE4D60>]}
[0m11:00:27.804052 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m11:00:27.804052 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:27.807732 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:27.807732 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m11:00:27.807732 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m11:00:27.807732 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:27.819678 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:27.820428 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:27.807732 => 11:00:27.820428
[0m11:00:27.820428 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:27.820428 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:27.820428 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:27.830751 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:27.949095 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 11:00:26.824154 => 11:00:27.949095
[0m11:00:27.949095 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FB1C700>]}
[0m11:00:27.949095 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m11:00:27.949095 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m11:00:27.964893 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m11:00:27.964893 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m11:00:27.964893 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m11:00:27.964893 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m11:00:27.972045 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m11:00:27.974051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 11:00:27.964893 => 11:00:27.972045
[0m11:00:27.974051 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m11:00:27.978062 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m11:00:27.978062 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:27.980069 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m11:00:28.603138 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5324eaf1-1218-4f05-8f08-71467ef400d0&page=queryresults
[0m11:00:28.739392 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7164d1b1-5145-4737-b1b5-1d45ea1831e9&page=queryresults
[0m11:00:29.132166 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:27.820428 => 11:00:29.132166
[0m11:00:29.134172 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAE4DC0>]}
[0m11:00:29.134172 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 11:00:27.974051 => 11:00:29.134172
[0m11:00:29.134172 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m11:00:29.143870 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:29.143870 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m11:00:29.143870 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FBAC7C0>]}
[0m11:00:29.143870 [info ] [Thread-2  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m11:00:29.143870 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m11:00:29.143870 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m11:00:29.143870 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m11:00:29.143870 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m11:00:29.159722 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m11:00:29.159722 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_lead_time
[0m11:00:29.159722 [info ] [Thread-1  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m11:00:29.159722 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 11:00:29.143870 => 11:00:29.159722
[0m11:00:29.159722 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m11:00:29.159722 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m11:00:29.159722 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m11:00:29.175472 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m11:00:29.175472 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m11:00:29.175472 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 11:00:29.175472 => 11:00:29.175472
[0m11:00:29.175472 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:29.175472 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m11:00:29.191584 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m11:00:29.191584 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m11:00:29.223382 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:29.223382 [debug] [Thread-1  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m11:00:29.861092 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a76d30e3-3dd8-46d2-a1d8-e0ae2305b174&page=queryresults
[0m11:00:30.226776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 11:00:29.175472 => 11:00:30.226776
[0m11:00:30.226776 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FB4A9D0>]}
[0m11:00:30.226776 [info ] [Thread-2  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.08s]
[0m11:00:30.226776 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m11:00:30.226776 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:30.242512 [info ] [Thread-2  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m11:00:30.242512 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m11:00:30.242512 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:30.242512 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:30.242512 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:30.242512 => 11:00:30.242512
[0m11:00:30.242512 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:30.258680 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:30.258680 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1512e36-efe4-4ab3-9913-c2d189e8d7da&page=queryresults
[0m11:00:30.642212 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 11:00:29.175472 => 11:00:30.642212
[0m11:00:30.642212 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAD2520>]}
[0m11:00:30.642212 [info ] [Thread-1  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m11:00:30.642212 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m11:00:30.931017 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:30.931017 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:31.605075 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5fb54360-9832-424f-9e58-f53fb7a00697&page=queryresults
[0m11:00:33.970791 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:30.242512 => 11:00:33.970791
[0m11:00:33.970791 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA6F700>]}
[0m11:00:33.970791 [info ] [Thread-2  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 3.73s]
[0m11:00:33.970791 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:33.970791 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:33.970791 [info ] [Thread-1  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m11:00:33.970791 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m11:00:33.970791 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:33.986468 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:33.986468 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:33.970791 => 11:00:33.986468
[0m11:00:33.986468 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:33.986468 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:34.654683 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:34.661708 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m11:00:35.293448 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:298d6df2-d505-4d2f-8add-24e1044b9f3d&page=queryresults
[0m11:00:37.840027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:33.986468 => 11:00:37.840027
[0m11:00:37.840027 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E9A8B20>]}
[0m11:00:37.842248 [info ] [Thread-1  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.87s]
[0m11:00:37.844277 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:37.846284 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:37.848292 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m11:00:37.846284 [info ] [Thread-2  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m11:00:37.852309 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:37.848292 [info ] [Thread-1  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m11:00:37.854076 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:37.857319 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m11:00:37.865145 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:37.867154 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m11:00:37.869994 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m11:00:37.869994 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 11:00:37.867154 => 11:00:37.869994
[0m11:00:37.869994 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m11:00:37.879020 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:37.881030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:37.857319 => 11:00:37.881030
[0m11:00:37.881030 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:37.881030 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:38.539814 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m11:00:38.541570 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m11:00:38.556959 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:38.558970 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:39.188484 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66973de3-cf08-4d59-b53f-e0b9a1ac488e&page=queryresults
[0m11:00:39.192517 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b608dfab-cd76-478b-bd11-c81fd5348920&page=queryresults
[0m11:00:41.160962 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:37.881030 => 11:00:41.160962
[0m11:00:41.162978 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA907C0>]}
[0m11:00:41.164991 [info ] [Thread-2  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.31s]
[0m11:00:41.167007 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:41.167007 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m11:00:41.167007 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m11:00:41.169018 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m11:00:41.171031 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m11:00:41.177063 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:41.179073 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 11:00:41.171031 => 11:00:41.179073
[0m11:00:41.179073 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m11:00:41.182842 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:41.601209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 11:00:37.877008 => 11:00:41.601209
[0m11:00:41.604691 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FC33640>]}
[0m11:00:41.606704 [info ] [Thread-1  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 3.75s]
[0m11:00:41.608714 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m11:00:41.608714 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m11:00:41.608714 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m11:00:41.610727 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m11:00:41.612737 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m11:00:41.618781 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m11:00:41.620790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 11:00:41.612737 => 11:00:41.620790
[0m11:00:41.620790 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m11:00:41.624809 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:41.869385 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:41.871399 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:42.226460 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:48541880-08c8-49f9-8cd9-8ae89bed9ede&page=queryresults
[0m11:00:42.252837 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m11:00:42.256865 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m11:00:42.914984 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c711de4-2156-4343-85f8-fe0a34dab4f0&page=queryresults
[0m11:00:44.209500 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 11:00:41.180829 => 11:00:44.209500
[0m11:00:44.211514 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA6F700>]}
[0m11:00:44.211514 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.04s]
[0m11:00:44.213528 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m11:00:44.213528 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:44.213528 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m11:00:44.215540 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m11:00:44.215540 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:44.221571 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m11:00:44.223577 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 11:00:44.215540 => 11:00:44.223577
[0m11:00:44.224283 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:44.225399 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:44.844316 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m11:00:44.846329 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m11:00:45.195065 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7a3d5fb-46d5-435e-a5c5-a510e389a978&page=queryresults
[0m11:00:45.830452 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 11:00:41.622800 => 11:00:45.830452
[0m11:00:45.830452 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FCAA310>]}
[0m11:00:45.837157 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.22s]
[0m11:00:45.837157 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m11:00:45.837157 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:45.837157 [info ] [Thread-1  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m11:00:45.837157 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m11:00:45.837157 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m11:00:45.837157 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:45.837157 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 11:00:45.837157 => 11:00:45.837157
[0m11:00:45.837157 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m11:00:45.837157 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:46.435383 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:46.439411 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m11:00:46.857692 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:74a492f6-ffde-43ed-9a57-f0f8d95b7e83&page=queryresults
[0m11:00:47.546675 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 11:00:44.224283 => 11:00:47.546675
[0m11:00:47.548689 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FCAAAC0>]}
[0m11:00:47.550701 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.33s]
[0m11:00:47.550701 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:47.552711 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m11:00:47.552711 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m11:00:47.552711 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m11:00:47.552711 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m11:00:47.560519 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m11:00:47.563222 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 11:00:47.556503 => 11:00:47.563222
[0m11:00:47.563222 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m11:00:47.567241 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:48.162214 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m11:00:48.162214 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m11:00:48.792681 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e0e8612c-1107-4e18-8638-0c86d7b7f03c&page=queryresults
[0m11:00:49.126060 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 11:00:45.837157 => 11:00:49.126060
[0m11:00:49.127816 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FB752E0>]}
[0m11:00:49.127816 [info ] [Thread-1  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.29s]
[0m11:00:49.129830 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:49.129830 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:49.129830 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m11:00:49.129830 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m11:00:49.129830 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:49.129830 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:00:49.141293 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 11:00:49.129830 => 11:00:49.141293
[0m11:00:49.143306 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:49.145318 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:49.776456 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:00:49.776456 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m11:00:50.182215 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a44d7ccf-c70a-481a-a55f-e383b5278791&page=queryresults
[0m11:00:52.198067 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 11:00:47.565230 => 11:00:52.198067
[0m11:00:52.198067 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FAD2160>]}
[0m11:00:52.373462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 11:00:49.143306 => 11:00:52.373462
[0m11:00:52.373462 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA51D30>]}
[0m11:00:52.943588 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.65s]
[0m11:00:52.943588 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m11:00:52.950676 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m11:00:52.943588 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.24s]
[0m11:00:52.952606 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:52.954860 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m11:00:52.952606 [info ] [Thread-2  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m11:00:52.956873 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m11:00:52.956873 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m11:00:52.966919 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m11:00:52.954860 [info ] [Thread-1  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m11:00:52.970944 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m11:00:52.970944 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m11:00:52.978981 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:00:52.978981 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 11:00:52.958881 => 11:00:52.978981
[0m11:00:52.978981 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m11:00:52.982900 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:53.030854 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 11:00:52.970944 => 11:00:53.030854
[0m11:00:53.030854 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m11:00:53.042592 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:53.745438 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m11:00:53.745438 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:53.781282 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:00:53.783293 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m11:00:54.202659 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:239e56ad-2c2e-4ff7-873a-a4b229fbd479&page=queryresults
[0m11:00:54.393778 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a5e07c85-267c-4b0b-bb56-88d81c02f5c9&page=queryresults
[0m11:00:57.060682 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 11:00:53.030854 => 11:00:57.060682
[0m11:00:57.060682 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA4AC40>]}
[0m11:00:57.060682 [info ] [Thread-1  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.09s]
[0m11:00:57.060682 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m11:00:57.066573 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:00:57.066573 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m11:00:57.066573 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m11:00:57.070620 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:00:57.075399 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:00:57.075399 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:00:57.070620 => 11:00:57.075399
[0m11:00:57.075399 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:00:57.090255 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:57.217918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 11:00:52.978981 => 11:00:57.217918
[0m11:00:57.217918 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E9FA5B0>]}
[0m11:00:57.217918 [info ] [Thread-2  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.26s]
[0m11:00:57.217918 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m11:00:57.706692 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:00:57.710720 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:58.277513 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b6b6be3-f42f-4677-be68-77b7335ac556&page=queryresults
[0m11:01:01.978487 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:00:57.075399 => 11:01:01.978487
[0m11:01:01.978487 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfc208f5-3c7f-45c4-8d84-26c903a7243d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7FA500D0>]}
[0m11:01:01.978487 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 4.91s]
[0m11:01:01.978487 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:01:01.988687 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:01.988687 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:01.988687 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:01.988687 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:01.988687 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:01.988687 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:01:01.994397 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m11:01:01.994397 [info ] [MainThread]: 
[0m11:01:01.994397 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 43.64 seconds (43.64s).
[0m11:01:01.994397 [debug] [MainThread]: Command end result
[0m11:01:02.010535 [info ] [MainThread]: 
[0m11:01:02.010535 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:02.010535 [info ] [MainThread]: 
[0m11:01:02.010535 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m11:01:02.010535 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:02.010535 after 48.69 seconds
[0m11:01:02.026285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7B0433D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E585D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018E7E98BFD0>]}
[0m11:01:02.026285 [debug] [MainThread]: Flushing usage events
[0m11:01:06.096309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2E1E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2D167670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2D167D90>]}


============================== 11:01:06.096309 | 40a9c8b8-cca6-4f44-9c2b-d382b9111af7 ==============================
[0m11:01:06.096309 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:01:06.096309 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:01:06.971310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2D159070>]}
[0m11:01:07.035324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2D11FF10>]}
[0m11:01:07.035324 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:01:07.050998 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:01:07.099089 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:01:07.099089 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:01:07.099089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B31B476A0>]}
[0m11:01:07.115087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B31A3C4C0>]}
[0m11:01:07.115087 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:01:07.115087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B31A3C2B0>]}
[0m11:01:07.115087 [info ] [MainThread]: 
[0m11:01:07.115087 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:01:07.115087 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:01:07.115087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:07.789342 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:01:07.789342 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:01:07.789342 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:07.789342 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:08.398358 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:01:08.398358 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:08.446109 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:01:08.446109 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:09.045058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B31B53DF0>]}
[0m11:01:09.046925 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:01:09.046925 [info ] [MainThread]: 
[0m11:01:09.046925 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:09.046925 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m11:01:09.046925 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m11:01:09.046925 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:09.078738 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 11:01:09.046925 => 11:01:09.063003
[0m11:01:09.078738 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:09.126372 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:01:09.126372 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m11:01:09.931734 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:870194ce-7f64-4f67-94cb-ba2b3a2c4003&page=queryresults
[0m11:01:11.079985 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m11:01:11.500455 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:746f05a4-0dc4-48d2-b9c7-7cc58253cf8f&page=queryresults
[0m11:01:13.865411 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m11:01:14.659531 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m11:01:14.661537 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m11:01:15.058486 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f7a5bd14-5164-4c59-9473-4b2b8c08a516&page=queryresults
[0m11:01:17.028159 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 11:01:09.078738 => 11:01:17.028159
[0m11:01:17.028159 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '40a9c8b8-cca6-4f44-9c2b-d382b9111af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B32BF2580>]}
[0m11:01:17.028159 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 7.98s]
[0m11:01:17.028159 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:17.028159 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:17.028159 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:17.028159 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:01:17.028159 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:17.028159 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m11:01:17.028159 [info ] [MainThread]: 
[0m11:01:17.028159 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.91 seconds (9.91s).
[0m11:01:17.028159 [debug] [MainThread]: Command end result
[0m11:01:17.060096 [info ] [MainThread]: 
[0m11:01:17.060096 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:17.060096 [info ] [MainThread]: 
[0m11:01:17.060096 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:17.060096 [debug] [MainThread]: Command `dbt snapshot` succeeded at 11:01:17.060096 after 11.04 seconds
[0m11:01:17.060096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2E1E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B2BE676D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024B3191D4F0>]}
[0m11:01:17.060096 [debug] [MainThread]: Flushing usage events
[0m11:01:21.273609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592A0623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015928FD19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015928FD1B80>]}


============================== 11:01:21.289280 | 552b6081-b1d4-44b9-bb69-860c2171b183 ==============================
[0m11:01:21.289280 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:01:21.289280 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:01:22.149922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015928FCAFD0>]}
[0m11:01:22.197856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D6D2B20>]}
[0m11:01:22.213668 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:01:22.213668 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:01:22.277188 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:01:22.277188 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:01:22.277188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D9C8880>]}
[0m11:01:22.293085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D8C76A0>]}
[0m11:01:22.293085 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:01:22.293085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D8C7490>]}
[0m11:01:22.308893 [info ] [MainThread]: 
[0m11:01:22.308893 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:01:22.308893 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:01:22.308893 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:23.021113 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:01:23.021113 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:23.021113 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:01:23.021113 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:23.660515 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:01:23.660515 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:23.692880 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:01:23.692880 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:24.350218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D633D30>]}
[0m11:01:24.366187 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:01:24.366187 [info ] [MainThread]: 
[0m11:01:24.366187 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:24.366187 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m11:01:24.366187 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m11:01:24.366187 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:24.398198 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:24.398198 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 11:01:24.366187 => 11:01:24.398198
[0m11:01:24.398198 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:24.398198 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:01:25.065719 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:25.065719 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m11:01:25.484014 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b536131b-a81c-46b5-8f2b-2245ad0d53fe&page=queryresults
[0m11:01:27.790723 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 11:01:24.398198 => 11:01:27.790723
[0m11:01:27.790723 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592EA3FDF0>]}
[0m11:01:27.790723 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 3.42s]
[0m11:01:27.790723 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:27.790723 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:01:27.790723 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m11:01:27.790723 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m11:01:27.790723 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:01:27.800878 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:01:27.802887 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 11:01:27.790723 => 11:01:27.802887
[0m11:01:27.802887 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:01:27.806647 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:01:28.575539 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:01:28.577149 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:01:28.958502 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:28742934-cc20-467c-a990-27f5241ff828&page=queryresults
[0m11:01:30.899044 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 11:01:27.802887 => 11:01:30.899044
[0m11:01:30.899044 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '552b6081-b1d4-44b9-bb69-860c2171b183', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592EB0C8B0>]}
[0m11:01:30.901051 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.11s]
[0m11:01:30.903060 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:01:30.905067 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:30.907075 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:30.907075 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:30.908825 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:01:30.908825 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m11:01:30.910835 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m11:01:30.910835 [info ] [MainThread]: 
[0m11:01:30.910835 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.60 seconds (8.60s).
[0m11:01:30.912842 [debug] [MainThread]: Command end result
[0m11:01:30.940471 [info ] [MainThread]: 
[0m11:01:30.940471 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:30.943575 [info ] [MainThread]: 
[0m11:01:30.945594 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m11:01:30.945594 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:30.945594 after 9.73 seconds
[0m11:01:30.945594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592A0623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D79CFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001592D665BB0>]}
[0m11:01:30.945594 [debug] [MainThread]: Flushing usage events
[0m12:00:24.253541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6BC333D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6ABB09D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6ABB0B80>]}


============================== 12:00:24.285182 | f6bbe910-66c6-4ee6-9904-0e8f0a557676 ==============================
[0m12:00:24.285182 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:24.289176 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:00:29.469082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6AB92130>]}
[0m12:00:30.045366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F2A0700>]}
[0m12:00:30.050876 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:30.107778 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:30.596846 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:30.596846 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:30.629980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F598850>]}
[0m12:00:30.736447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F497670>]}
[0m12:00:30.737446 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:30.741970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F497490>]}
[0m12:00:30.752514 [info ] [MainThread]: 
[0m12:00:30.761040 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:30.769084 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:30.771068 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:30.785159 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:30.915209 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:31.860781 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:32.929881 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:32.944969 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:32.948981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:00:32.952516 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:33.967033 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:00:33.973547 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:34.071443 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:34.072459 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:35.152792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F1F32E0>]}
[0m12:00:35.154803 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:35.155802 [info ] [MainThread]: 
[0m12:00:35.165339 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:35.169342 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:35.175870 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m12:00:35.182393 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:35.177868 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m12:00:35.186402 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:35.193941 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:35.231629 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:35.239656 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:35.250921 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:35.262097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:35.195950 => 12:00:35.260943
[0m12:00:35.264109 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:35.232643 => 12:00:35.262097
[0m12:00:35.268107 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:35.270109 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:35.542807 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:35.550804 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:35.561889 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:35.564898 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:35.618730 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m12:00:35.579055 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:36.784920 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e019f95d-5945-4a85-8471-ac7677b9ec0e&page=queryresults
[0m12:00:36.804589 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef920b55-5329-4ae9-b5ff-fd17659d4b5d&page=queryresults
[0m12:00:37.379838 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:35.271617 => 12:00:37.378802
[0m12:00:37.417501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:35.317304 => 12:00:37.413495
[0m12:00:37.432103 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70690C40>]}
[0m12:00:37.425028 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70684F40>]}
[0m12:00:37.441101 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 2.24s]
[0m12:00:37.464835 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:37.446748 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 2.24s]
[0m12:00:37.467835 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:37.474356 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:37.481891 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m12:00:37.479358 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m12:00:37.492418 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:37.493426 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:37.486894 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m12:00:37.505966 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:37.516031 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m12:00:37.523582 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m12:00:37.564753 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:37.493426 => 12:00:37.555206
[0m12:00:37.566740 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:37.578264 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:37.582812 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m12:00:37.591329 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:37.599350 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 12:00:37.527581 => 12:00:37.598347
[0m12:00:37.603876 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:37.610172 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m12:00:37.747470 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m12:00:37.749467 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:37.771036 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m12:00:38.680892 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea58eca6-e99e-4a51-9790-1b1bc564f88a&page=queryresults
[0m12:00:38.727476 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66c4b9ea-58b7-4be4-b3c4-05eafc158164&page=queryresults
[0m12:00:39.157777 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 12:00:37.710824 => 12:00:39.157777
[0m12:00:39.167322 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:37.567742 => 12:00:39.166310
[0m12:00:39.172840 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7060F8B0>]}
[0m12:00:39.178855 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A706AE040>]}
[0m12:00:39.184380 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.66s]
[0m12:00:39.190916 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.69s]
[0m12:00:39.199942 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m12:00:39.210039 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:39.217560 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:39.219552 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m12:00:39.235620 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m12:00:39.239624 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m12:00:39.242177 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m12:00:39.252725 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:39.237621 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m12:00:39.263256 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m12:00:39.269265 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m12:00:39.309010 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:39.315044 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 12:00:39.244189 => 12:00:39.314050
[0m12:00:39.325614 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m12:00:39.328620 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 12:00:39.273801 => 12:00:39.327614
[0m12:00:39.333143 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m12:00:39.354206 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:39.365728 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:39.373261 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:39.376264 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m12:00:39.379260 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:39.481204 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m12:00:40.674761 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:127f9903-babb-4e86-b17d-98e94017c12f&page=queryresults
[0m12:00:40.745050 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15d2f0ce-b759-4a32-a356-2e2e687e3f63&page=queryresults
[0m12:00:41.113865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 12:00:39.329614 => 12:00:41.113865
[0m12:00:41.120001 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70703190>]}
[0m12:00:41.125031 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.88s]
[0m12:00:41.127027 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:41.133605 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m12:00:41.139604 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m12:00:41.145136 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m12:00:41.150143 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m12:00:41.184281 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m12:00:41.203363 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 12:00:41.153660 => 12:00:41.201348
[0m12:00:41.205375 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m12:00:41.220948 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m12:00:41.222966 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:41.234502 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m12:00:41.370197 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 12:00:39.341648 => 12:00:41.370197
[0m12:00:41.371707 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A706AE040>]}
[0m12:00:41.373730 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 2.11s]
[0m12:00:41.378730 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m12:00:41.385862 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m12:00:41.393383 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m12:00:41.402926 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m12:00:41.408926 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m12:00:41.436079 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:41.444123 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 12:00:41.411980 => 12:00:41.439586
[0m12:00:41.447149 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m12:00:41.464203 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:41.470179 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:41.474707 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m12:00:42.359104 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c546dc0-f237-4e83-bcfc-16af83f72f21&page=queryresults
[0m12:00:42.373228 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bceb59f1-712c-4e00-95d6-0f2bf2a81aa2&page=queryresults
[0m12:00:42.816746 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 12:00:41.453651 => 12:00:42.814744
[0m12:00:42.822270 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7076E0D0>]}
[0m12:00:42.829261 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m12:00:42.839313 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m12:00:42.851367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 12:00:41.205375 => 12:00:42.850853
[0m12:00:42.855417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:42.866918 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F627460>]}
[0m12:00:42.871432 [info ] [Thread-2  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m12:00:42.881985 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m12:00:42.885020 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:42.878456 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.72s]
[0m12:00:42.916604 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:42.925153 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m12:00:42.932176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m12:00:42.943741 [info ] [Thread-1  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m12:00:42.959279 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m12:00:42.961820 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 12:00:42.886016 => 12:00:42.960801
[0m12:00:42.962818 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m12:00:42.965829 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:43.006959 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:43.048630 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:43.077226 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m12:00:43.081754 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m12:00:43.208703 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 12:00:42.966830 => 12:00:43.204731
[0m12:00:43.213234 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m12:00:43.239825 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m12:00:43.241335 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:43.247352 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m12:00:44.053835 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86e318ce-2906-40d2-9805-20ad4dcdc8c3&page=queryresults
[0m12:00:44.279270 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c3d7f2f-549d-402e-930f-1a42f42172f8&page=queryresults
[0m12:00:44.475772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 12:00:42.982889 => 12:00:44.475772
[0m12:00:44.481283 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A706F5BB0>]}
[0m12:00:44.485303 [info ] [Thread-2  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.60s]
[0m12:00:44.488301 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:44.489301 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:44.490816 [info ] [Thread-2  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m12:00:44.494831 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m12:00:44.495829 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:44.506363 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:44.508360 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:44.496830 => 12:00:44.508360
[0m12:00:44.510882 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:44.528445 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:44.544085 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:44.566286 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:44.755064 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 12:00:43.221787 => 12:00:44.754066
[0m12:00:44.757064 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70684AF0>]}
[0m12:00:44.763597 [info ] [Thread-1  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.81s]
[0m12:00:44.768603 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m12:00:44.774134 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m12:00:44.780134 [info ] [Thread-1  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m12:00:44.789673 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m12:00:44.795221 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m12:00:44.837928 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m12:00:44.839929 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 12:00:44.799224 => 12:00:44.839929
[0m12:00:44.841439 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m12:00:44.849460 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m12:00:44.861511 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:44.878059 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m12:00:45.669374 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63aa318e-42e8-4b3c-8912-b2aa36901c5d&page=queryresults
[0m12:00:45.846064 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:80c0f9a2-9f90-4d5b-8bef-d8d0b9041a04&page=queryresults
[0m12:00:46.302309 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 12:00:44.842452 => 12:00:46.298784
[0m12:00:46.328420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:44.510882 => 12:00:46.327417
[0m12:00:46.330929 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70648760>]}
[0m12:00:46.334942 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7060FEB0>]}
[0m12:00:46.337475 [info ] [Thread-1  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m12:00:46.348001 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m12:00:46.339470 [info ] [Thread-2  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.84s]
[0m12:00:46.353521 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m12:00:46.354520 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:46.356526 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m12:00:46.361050 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m12:00:46.369071 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m12:00:46.378607 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m12:00:46.373595 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m12:00:46.406999 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_lead_time)
[0m12:00:46.421040 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m12:00:46.478263 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m12:00:46.479261 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m12:00:46.488788 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 12:00:46.384154 => 12:00:46.488788
[0m12:00:46.496672 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 12:00:46.465749 => 12:00:46.494382
[0m12:00:46.506217 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m12:00:46.507216 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m12:00:46.519749 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m12:00:46.532798 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m12:00:46.535814 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:46.537320 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:46.549355 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m12:00:46.639697 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m12:00:47.679675 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25292f7d-3d2f-4e2d-8144-a4d95989bc22&page=queryresults
[0m12:00:47.812818 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75132a88-b0cd-4c3f-9baa-e9697db6d7b8&page=queryresults
[0m12:00:48.135785 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 12:00:46.508218 => 12:00:48.134784
[0m12:00:48.149895 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F2FE1C0>]}
[0m12:00:48.151406 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.78s]
[0m12:00:48.154428 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m12:00:48.155430 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:48.157430 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m12:00:48.160798 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m12:00:48.161819 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:48.177344 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:48.188875 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:48.162812 => 12:00:48.186875
[0m12:00:48.189881 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:48.262822 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:48.364961 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 12:00:46.521256 => 12:00:48.361954
[0m12:00:48.378481 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7076E0D0>]}
[0m12:00:48.383030 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.97s]
[0m12:00:48.393586 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m12:00:49.226867 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:49.230869 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:49.929399 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:95d0be2c-5ae6-4547-a94f-f649941af2c2&page=queryresults
[0m12:00:52.852986 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:48.192457 => 12:00:52.851985
[0m12:00:52.854008 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70703670>]}
[0m12:00:52.855007 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.69s]
[0m12:00:52.879068 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:52.887616 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:52.893134 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m12:00:52.897141 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m12:00:52.901649 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:52.942410 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:52.955954 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:52.904667 => 12:00:52.952942
[0m12:00:52.956951 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:52.964486 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:53.787406 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:53.789411 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m12:00:54.482252 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2804fdcd-760e-47a0-aae7-ab4da11915cd&page=queryresults
[0m12:00:56.785205 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:52.957950 => 12:00:56.782207
[0m12:00:56.791729 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A707AEB50>]}
[0m12:00:56.798734 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.90s]
[0m12:00:56.805256 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:56.811781 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:56.817786 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m12:00:56.824336 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m12:00:56.844964 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:56.847963 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:56.831873 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m12:00:56.863895 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:56.872420 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m12:00:56.879414 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m12:00:56.934659 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:56.849960 => 12:00:56.933655
[0m12:00:56.929125 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m12:00:56.938131 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:56.959171 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:57.109198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 12:00:56.882938 => 12:00:57.107197
[0m12:00:57.116754 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m12:00:57.125275 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:58.096076 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:58.098075 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:58.186467 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m12:00:58.189445 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m12:00:58.804471 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb6b6972-f454-42df-9e7f-b4a3483a95d9&page=queryresults
[0m12:00:58.851755 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58dbe32f-3aa5-403a-96df-95493b181a37&page=queryresults
[0m12:01:00.975511 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 12:00:57.119747 => 12:01:00.971508
[0m12:01:00.984032 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A707DDBB0>]}
[0m12:01:00.988031 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 4.11s]
[0m12:01:00.991034 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m12:01:00.991547 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m12:01:01.011595 [info ] [Thread-2  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m12:01:01.014616 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m12:01:01.015617 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m12:01:01.036577 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m12:01:01.046098 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 12:01:01.015617 => 12:01:01.045099
[0m12:01:01.047108 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m12:01:01.058679 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:01:01.076741 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:56.940675 => 12:01:01.073748
[0m12:01:01.086422 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F62A8B0>]}
[0m12:01:01.101543 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 4.25s]
[0m12:01:01.288535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:01:01.289536 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m12:01:01.297072 [info ] [Thread-1  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m12:01:01.301103 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m12:01:01.303626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m12:01:01.334207 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m12:01:01.344754 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 12:01:01.306635 => 12:01:01.343749
[0m12:01:01.346767 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m12:01:01.351279 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:01:02.115832 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m12:01:02.119822 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:02.244098 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m12:01:02.253637 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m12:01:02.501434 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4377ed53-9747-4562-8591-b722619691ad&page=queryresults
[0m12:01:02.825147 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ec8462d-0ad1-470f-8746-940a6d24e93d&page=queryresults
[0m12:01:05.353827 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 12:01:01.048102 => 12:01:05.349257
[0m12:01:05.361320 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A707EB580>]}
[0m12:01:05.391988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 12:01:01.346767 => 12:01:05.390972
[0m12:01:05.393999 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F62A8B0>]}
[0m12:01:05.371904 [info ] [Thread-2  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 4.35s]
[0m12:01:05.398999 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m12:01:05.399998 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m12:01:05.396000 [info ] [Thread-1  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.09s]
[0m12:01:05.405566 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m12:01:05.403569 [info ] [Thread-2  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m12:01:05.407567 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m12:01:05.413093 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m12:01:05.423617 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m12:01:05.429621 [info ] [Thread-1  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m12:01:05.458806 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m12:01:05.465339 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m12:01:05.471894 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m12:01:05.481422 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 12:01:05.417114 => 12:01:05.480908
[0m12:01:05.493989 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:01:05.497991 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m12:01:05.534671 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 12:01:05.482439 => 12:01:05.531134
[0m12:01:05.535664 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m12:01:05.571113 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:01:05.576160 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:01:06.627122 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m12:01:06.654278 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m12:01:06.768793 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:01:06.782841 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m12:01:07.059455 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:158ed69a-5a41-4ecc-b62c-d6e8fa2c97ff&page=queryresults
[0m12:01:07.189435 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a465685-4f8b-44fd-a34d-033684544860&page=queryresults
[0m12:01:09.332743 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 12:01:05.503057 => 12:01:09.332743
[0m12:01:09.336761 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A707FF940>]}
[0m12:01:09.344282 [info ] [Thread-2  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.93s]
[0m12:01:09.351810 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m12:01:09.360822 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m12:01:09.361335 [info ] [Thread-2  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m12:01:09.364359 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m12:01:09.367360 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m12:01:09.392042 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m12:01:09.398062 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 12:01:09.368363 => 12:01:09.396053
[0m12:01:09.399051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m12:01:09.407383 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:01:09.548865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 12:01:05.564604 => 12:01:09.544871
[0m12:01:09.562920 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A70721BB0>]}
[0m12:01:09.573893 [info ] [Thread-1  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 4.11s]
[0m12:01:09.578397 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m12:01:09.584927 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:01:09.585925 [info ] [Thread-1  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m12:01:09.588923 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m12:01:09.589924 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:01:09.604968 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:01:09.612511 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 12:01:09.590926 => 12:01:09.611486
[0m12:01:09.618506 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:01:09.642120 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:01:10.348123 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m12:01:10.362203 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m12:01:10.532997 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:01:10.542546 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m12:01:10.983350 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a6f3a52-c306-4ca2-97a4-87b6260bdd83&page=queryresults
[0m12:01:10.997911 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a622044e-027e-4b99-9b9e-9ca2933370b7&page=queryresults
[0m12:01:13.638113 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 12:01:09.622044 => 12:01:13.635104
[0m12:01:13.644653 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A71813850>]}
[0m12:01:13.917415 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 12:01:09.400052 => 12:01:13.916420
[0m12:01:13.922943 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7184DC10>]}
[0m12:01:14.574728 [info ] [Thread-1  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 4.05s]
[0m12:01:14.581794 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:01:14.577256 [info ] [Thread-2  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.56s]
[0m12:01:14.585806 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m12:01:14.587804 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:01:14.595239 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m12:01:14.589803 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m12:01:14.604797 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m12:01:14.599246 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m12:01:14.611305 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:01:14.618332 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m12:01:14.651985 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:01:14.657003 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m12:01:14.691284 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m12:01:14.695307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:01:14.619326 => 12:01:14.694304
[0m12:01:14.696305 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:01:14.707840 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:01:14.719382 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 12:01:14.662183 => 12:01:14.716382
[0m12:01:14.812213 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m12:01:14.834018 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:01:15.579762 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:01:15.591804 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:01:15.668594 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m12:01:15.677335 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:15.961960 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:411c4aa6-bd94-4906-be14-451214f58b3c&page=queryresults
[0m12:01:16.362801 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2778f72a-56c1-41c3-966e-70d93ae0e72a&page=queryresults
[0m12:01:18.918217 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 12:01:14.818219 => 12:01:18.918217
[0m12:01:18.919220 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A717F9C10>]}
[0m12:01:18.920732 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.30s]
[0m12:01:18.930758 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m12:01:19.429533 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:01:14.696305 => 12:01:19.429533
[0m12:01:19.432055 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A71814520>]}
[0m12:01:19.433059 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.83s]
[0m12:01:19.435071 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:01:19.440069 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:01:19.445587 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m12:01:19.448596 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m12:01:19.449591 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:01:19.467755 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:01:19.471228 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:01:19.449591 => 12:01:19.469710
[0m12:01:19.472245 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:01:19.506474 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:01:20.504675 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:01:20.507679 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:21.143687 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4861c46d-283d-4c27-9ca8-2ad05fd05dab&page=queryresults
[0m12:01:25.201703 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:01:19.473253 => 12:01:25.185621
[0m12:01:25.203730 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6bbe910-66c6-4ee6-9904-0e8f0a557676', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F4E0E20>]}
[0m12:01:25.205030 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.76s]
[0m12:01:25.207050 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:01:25.212564 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:25.212564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:25.213573 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:25.214572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:01:25.214572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:01:25.215573 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:01:25.215573 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:01:25.217577 [info ] [MainThread]: 
[0m12:01:25.218575 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 54.46 seconds (54.46s).
[0m12:01:25.273714 [debug] [MainThread]: Command end result
[0m12:01:25.349682 [info ] [MainThread]: 
[0m12:01:25.354247 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:25.359233 [info ] [MainThread]: 
[0m12:01:25.366776 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m12:01:25.377293 [debug] [MainThread]: Command `dbt run` succeeded at 12:01:25.375298 after 61.59 seconds
[0m12:01:25.382845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6BC333D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F621C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A6F4E0E20>]}
[0m12:01:25.387849 [debug] [MainThread]: Flushing usage events
[0m12:01:48.702043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A100523430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A102FCF670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A102FCFD90>]}


============================== 12:01:48.727109 | 5fd475d7-a5ce-4c4c-928f-73f9754b1f0e ==============================
[0m12:01:48.727109 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:01:48.731626 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:01:53.620184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A102FBF070>]}
[0m12:01:54.272026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103CA3100>]}
[0m12:01:54.278038 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:01:54.356497 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:01:54.869564 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:01:54.871082 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:01:54.900178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1040077F0>]}
[0m12:01:54.959960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103F05100>]}
[0m12:01:54.961486 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:01:54.963522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103F05400>]}
[0m12:01:54.969522 [info ] [MainThread]: 
[0m12:01:54.977055 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:01:54.986231 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:01:54.991754 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:56.023914 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:01:56.024914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:56.030911 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:01:56.046494 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:57.057408 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:01:57.063951 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:57.223759 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:01:57.234287 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:58.151740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103F05130>]}
[0m12:01:58.153755 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:01:58.155754 [info ] [MainThread]: 
[0m12:01:58.174799 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:58.177800 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m12:01:58.179803 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m12:01:58.180800 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:58.201382 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 12:01:58.181310 => 12:01:58.200873
[0m12:01:58.202396 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:58.555977 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:01:58.565050 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m12:01:59.645804 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0b1a11c-cc53-4cdb-b5a6-3bcbb50017e2&page=queryresults
[0m12:02:01.130926 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m12:02:01.625843 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1661305e-6364-4024-a31b-75daa2cd0ee3&page=queryresults
[0m12:02:04.378381 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m12:02:05.167415 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m12:02:05.169403 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m12:02:05.637696 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:edaced4e-9877-4467-b89f-7e4f072a6688&page=queryresults
[0m12:02:08.130843 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 12:01:58.202396 => 12:02:08.128330
[0m12:02:08.137860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fd475d7-a5ce-4c4c-928f-73f9754b1f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1050BEF70>]}
[0m12:02:08.146077 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 9.96s]
[0m12:02:08.155625 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:02:08.173727 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:02:08.174716 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:02:08.175717 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:02:08.175717 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:02:08.176716 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m12:02:08.177718 [info ] [MainThread]: 
[0m12:02:08.178717 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 13.20 seconds (13.20s).
[0m12:02:08.181234 [debug] [MainThread]: Command end result
[0m12:02:08.244116 [info ] [MainThread]: 
[0m12:02:08.250116 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:02:08.254632 [info ] [MainThread]: 
[0m12:02:08.256633 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:02:08.263166 [debug] [MainThread]: Command `dbt snapshot` succeeded at 12:02:08.263166 after 19.93 seconds
[0m12:02:08.267173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A100523430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103DD29D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A103D6EE50>]}
[0m12:02:08.271684 [debug] [MainThread]: Flushing usage events
[0m12:02:30.798298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DAA43460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146D99B76D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146D99B7E20>]}


============================== 12:02:30.821887 | 311968e6-7eaf-45cd-87ba-ec82b7143c68 ==============================
[0m12:02:30.821887 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:02:30.824921 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:02:35.299620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146D99B5BB0>]}
[0m12:02:35.839362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146D99C1F40>]}
[0m12:02:35.854419 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:02:35.895655 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:02:36.387785 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:02:36.390788 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:02:36.485003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DE3A8460>]}
[0m12:02:36.580879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DE2AAD30>]}
[0m12:02:36.585894 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:02:36.591413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DE296430>]}
[0m12:02:36.607987 [info ] [MainThread]: 
[0m12:02:36.618535 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:02:36.632720 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:02:36.642283 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:02:37.515229 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:02:37.519224 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:02:37.523757 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:02:37.658016 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:02:38.487100 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m12:02:38.493636 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:02:38.676349 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:02:38.681870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:02:39.557864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DE032220>]}
[0m12:02:39.567397 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:02:39.572941 [info ] [MainThread]: 
[0m12:02:39.613104 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:02:39.620106 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m12:02:39.629621 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m12:02:39.635162 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:02:39.709419 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:02:39.712943 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 12:02:39.645680 => 12:02:39.711946
[0m12:02:39.713953 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:02:39.781254 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:02:40.812164 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:02:40.822692 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m12:02:41.258709 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:69aca6d5-9d58-45e5-98bc-0923fe087bac&page=queryresults
[0m12:02:43.677115 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 12:02:39.713953 => 12:02:43.676117
[0m12:02:43.681635 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DF46C610>]}
[0m12:02:43.685637 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 4.05s]
[0m12:02:43.694176 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:02:43.701683 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m12:02:43.708688 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m12:02:43.717225 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m12:02:43.719218 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m12:02:43.728752 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m12:02:43.732302 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 12:02:43.719218 => 12:02:43.731285
[0m12:02:43.733321 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m12:02:43.739299 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:02:44.534354 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m12:02:44.536635 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:02:44.946605 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6f7296ae-7a4e-4a3d-b775-e7ed74b9d621&page=queryresults
[0m12:02:46.965774 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 12:02:43.734304 => 12:02:46.964774
[0m12:02:46.977326 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '311968e6-7eaf-45cd-87ba-ec82b7143c68', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DF4D1130>]}
[0m12:02:46.979324 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.27s]
[0m12:02:46.984860 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m12:02:46.998395 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:02:47.002923 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:02:47.007925 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:02:47.011449 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:02:47.013453 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m12:02:47.014455 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m12:02:47.019452 [info ] [MainThread]: 
[0m12:02:47.024005 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.40 seconds (10.40s).
[0m12:02:47.036590 [debug] [MainThread]: Command end result
[0m12:02:47.107195 [info ] [MainThread]: 
[0m12:02:47.110195 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:02:47.116751 [info ] [MainThread]: 
[0m12:02:47.122279 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m12:02:47.126295 [debug] [MainThread]: Command `dbt run` succeeded at 12:02:47.125297 after 16.72 seconds
[0m12:02:47.126295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DAA43460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DDFDD6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146DDF879A0>]}
[0m12:02:47.127325 [debug] [MainThread]: Flushing usage events
[0m13:00:21.586627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002341CF82430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002341BEF99A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002341BEF9D30>]}


============================== 13:00:21.612127 | c55e0914-faeb-4063-adf3-54985da8c0cf ==============================
[0m13:00:21.612127 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:21.614122 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:25.607742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002341BEF2040>]}
[0m13:00:26.197901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023420513C40>]}
[0m13:00:26.205394 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:26.258015 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:26.748351 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:26.751930 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:26.779724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234208F87C0>]}
[0m13:00:26.873055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234207F8700>]}
[0m13:00:26.876139 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:26.880720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023420588CD0>]}
[0m13:00:26.899846 [info ] [MainThread]: 
[0m13:00:26.906113 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:26.921247 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:26.925286 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:26.932950 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:26.937950 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:28.367338 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:29.335388 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:00:29.338000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:29.341566 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:29.345502 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:30.388026 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m13:00:30.394318 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:30.554316 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:00:30.575547 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:31.486468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234207F8400>]}
[0m13:00:31.491251 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:31.494178 [info ] [MainThread]: 
[0m13:00:31.537374 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:31.538417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:31.543075 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m13:00:31.550579 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:31.545057 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m13:00:31.554666 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:31.558778 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:31.607980 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:31.635792 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:31.640967 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:31.648978 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:31.561358 => 13:00:31.647977
[0m13:00:31.650490 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:31.608976 => 13:00:31.650490
[0m13:00:31.652548 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:31.653611 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:32.043474 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:32.036327 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:32.052039 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:32.055146 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:32.089612 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m13:00:32.240796 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:33.324595 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e97b7cc8-2681-4ec8-aa14-8610c9ff3064&page=queryresults
[0m13:00:33.325601 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0b22669d-cba6-4f5b-a5b7-7fdf94a9819e&page=queryresults
[0m13:00:33.948065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:31.656667 => 13:00:33.942538
[0m13:00:33.950631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:31.686544 => 13:00:33.949587
[0m13:00:33.953151 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234219C3100>]}
[0m13:00:33.955781 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A1CAC0>]}
[0m13:00:33.958829 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 2.41s]
[0m13:00:33.968443 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:33.968443 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:33.963436 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 2.40s]
[0m13:00:33.977067 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:33.971036 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m13:00:33.980601 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m13:00:33.984617 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:33.987611 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m13:00:33.991170 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:33.996164 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m13:00:34.023961 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:34.026968 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m13:00:34.049804 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m13:00:34.053414 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:33.998220 => 13:00:34.052406
[0m13:00:34.055413 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:34.077671 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:34.086305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 13:00:34.027964 => 13:00:34.082295
[0m13:00:34.108529 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m13:00:34.119665 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m13:00:34.122705 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:34.133261 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:34.268137 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:34.282520 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m13:00:35.302875 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb289bf2-3f68-4cfb-9da9-cf3bb2cd626b&page=queryresults
[0m13:00:35.348626 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bf6923f-30fb-4df4-8ee8-f1efa452b7ca&page=queryresults
[0m13:00:35.749996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 13:00:34.113130 => 13:00:35.748448
[0m13:00:35.752140 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234219BF040>]}
[0m13:00:35.758137 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.76s]
[0m13:00:35.763789 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m13:00:35.766734 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:35.770295 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m13:00:35.776302 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m13:00:35.778298 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m13:00:35.812797 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:35.834075 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:34.058410 => 13:00:35.833094
[0m13:00:35.839599 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A86EB0>]}
[0m13:00:35.843304 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.86s]
[0m13:00:35.848295 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:35.852896 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 13:00:35.780919 => 13:00:35.850915
[0m13:00:35.856902 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m13:00:35.858900 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m13:00:35.863460 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m13:00:35.880669 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m13:00:35.888688 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m13:00:35.916028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:35.922566 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:35.926568 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 13:00:35.893292 => 13:00:35.926568
[0m13:00:35.929583 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m13:00:35.944551 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:35.948567 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:35.963798 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m13:00:35.980965 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:36.130009 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m13:00:37.092329 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc589b93-a6e6-4ac7-b993-171324191ddb&page=queryresults
[0m13:00:37.104856 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22b2f2b6-0cb0-48b3-addf-b9596f38340a&page=queryresults
[0m13:00:37.539945 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 13:00:35.865458 => 13:00:37.537943
[0m13:00:37.542658 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234219F41F0>]}
[0m13:00:37.545390 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.77s]
[0m13:00:37.550378 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:37.554096 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m13:00:37.559685 [info ] [Thread-2  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m13:00:37.581069 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 13:00:35.930116 => 13:00:37.578388
[0m13:00:37.586129 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m13:00:37.591809 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234219C3100>]}
[0m13:00:37.594936 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m13:00:37.607591 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m13:00:37.598920 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.71s]
[0m13:00:37.613332 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m13:00:37.616273 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m13:00:37.618256 [info ] [Thread-1  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m13:00:37.622875 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m13:00:37.626879 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 13:00:37.600516 => 13:00:37.624948
[0m13:00:37.628941 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m13:00:37.631566 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m13:00:37.655599 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:37.670738 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m13:00:37.677828 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 13:00:37.633603 => 13:00:37.675845
[0m13:00:37.681538 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:37.684471 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m13:00:37.702032 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:37.712676 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m13:00:37.833660 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:37.848485 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m13:00:38.787999 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bad4da07-9311-4f3f-931c-20f45f47e779&page=queryresults
[0m13:00:38.791973 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25dba039-2b9e-4c0a-a132-cc4b33f6ec4c&page=queryresults
[0m13:00:39.234182 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 13:00:37.687533 => 13:00:39.232199
[0m13:00:39.238172 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A8CD60>]}
[0m13:00:39.258118 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 13:00:37.656617 => 13:00:39.258118
[0m13:00:39.260694 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234219C3160>]}
[0m13:00:39.248537 [info ] [Thread-1  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m13:00:39.269786 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m13:00:39.273178 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:39.262714 [info ] [Thread-2  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.68s]
[0m13:00:39.282877 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m13:00:39.278246 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m13:00:39.285948 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m13:00:39.290571 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m13:00:39.297601 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:39.294639 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m13:00:39.308322 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m13:00:39.316041 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m13:00:39.345494 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m13:00:39.379893 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:39.384350 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 13:00:39.318023 => 13:00:39.381424
[0m13:00:39.388335 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m13:00:39.411551 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m13:00:39.416603 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 13:00:39.300205 => 13:00:39.415661
[0m13:00:39.417588 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:39.438791 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:39.444374 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:39.454200 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m13:00:39.599663 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:39.612567 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m13:00:40.566964 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab343bbd-95b8-4bbe-a8d9-c15dbf2a9115&page=queryresults
[0m13:00:40.575686 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d8a10ae-908e-4c62-bfec-873cced1beca&page=queryresults
[0m13:00:41.031027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 13:00:39.420110 => 13:00:41.026460
[0m13:00:41.036087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421969F10>]}
[0m13:00:41.039621 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.75s]
[0m13:00:41.056276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 13:00:39.390905 => 13:00:41.055282
[0m13:00:41.061960 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:41.065948 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AB3820>]}
[0m13:00:41.070489 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:41.075555 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.76s]
[0m13:00:41.084118 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m13:00:41.078547 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m13:00:41.088115 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m13:00:41.093714 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m13:00:41.100893 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:41.097726 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m13:00:41.127108 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:41.128124 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m13:00:41.130718 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m13:00:41.145534 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m13:00:41.149156 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:41.104899 => 13:00:41.148540
[0m13:00:41.151361 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:41.155363 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 13:00:41.132737 => 13:00:41.153356
[0m13:00:41.174067 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:41.177021 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m13:00:41.206037 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m13:00:41.209964 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:41.214472 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:41.231026 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:41.406021 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m13:00:42.337223 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a92d4448-71e2-4d85-81f2-ca182541ff2d&page=queryresults
[0m13:00:42.352359 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dda1f405-8728-4e41-a17d-a9c93e206f9e&page=queryresults
[0m13:00:42.768476 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:41.157281 => 13:00:42.768476
[0m13:00:42.771051 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A59550>]}
[0m13:00:42.775130 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.68s]
[0m13:00:42.779763 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:42.783878 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m13:00:42.786812 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m13:00:42.792561 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m13:00:42.798625 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m13:00:42.836587 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m13:00:42.842217 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 13:00:41.180757 => 13:00:42.838568
[0m13:00:42.848292 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AB3820>]}
[0m13:00:42.853976 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.72s]
[0m13:00:42.859060 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m13:00:42.861782 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m13:00:42.862768 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m13:00:42.866691 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m13:00:42.869759 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 13:00:42.801262 => 13:00:42.868694
[0m13:00:42.869759 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m13:00:42.873255 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m13:00:42.890529 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m13:00:42.920445 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m13:00:42.924508 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 13:00:42.875248 => 13:00:42.924508
[0m13:00:42.925674 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:42.928754 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m13:00:42.948735 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m13:00:42.960900 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m13:00:43.067516 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:43.088927 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m13:00:44.008982 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:83499869-6f65-490a-ae97-3f795b939c28&page=queryresults
[0m13:00:44.291232 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:066ed559-f102-4fc0-8756-5e213c09988d&page=queryresults
[0m13:00:44.451466 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 13:00:42.891621 => 13:00:44.449887
[0m13:00:44.457103 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AD13A0>]}
[0m13:00:44.460641 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.67s]
[0m13:00:44.468722 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m13:00:44.470252 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:44.471822 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m13:00:44.472848 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m13:00:44.472848 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:44.488736 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:44.497187 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:44.473843 => 13:00:44.495187
[0m13:00:44.499731 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:44.570739 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:44.793071 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 13:00:42.929802 => 13:00:44.793071
[0m13:00:44.795084 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422B0D1C0>]}
[0m13:00:44.796073 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.93s]
[0m13:00:44.801653 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m13:00:45.694631 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:45.696632 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:46.325783 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e78967d2-578a-4782-b60f-1cf7a64db198&page=queryresults
[0m13:00:49.786708 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:44.501764 => 13:00:49.786708
[0m13:00:49.788656 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AD20A0>]}
[0m13:00:49.789670 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 5.32s]
[0m13:00:49.795413 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:49.801952 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:49.806978 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m13:00:49.811816 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m13:00:49.812805 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:49.836207 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:49.841773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:49.813849 => 13:00:49.840836
[0m13:00:49.844807 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:49.852454 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:50.752148 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:50.760330 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m13:00:51.577539 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19bcc2e6-1c57-436f-968c-2b6df2fdc925&page=queryresults
[0m13:00:54.201877 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:49.845800 => 13:00:54.199828
[0m13:00:54.206878 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A487F0>]}
[0m13:00:54.210446 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.40s]
[0m13:00:54.224281 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:54.227285 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:54.233952 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m13:00:54.231023 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m13:00:54.243687 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:54.245687 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:54.239065 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m13:00:54.268547 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:54.272256 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m13:00:54.277239 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m13:00:54.301227 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m13:00:54.307273 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:54.248691 => 13:00:54.305237
[0m13:00:54.311011 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:54.325747 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:54.337258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 13:00:54.282899 => 13:00:54.335320
[0m13:00:54.339787 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m13:00:54.504809 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:55.375538 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m13:00:55.378532 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m13:00:55.419869 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:55.428322 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:55.976947 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f8cb9ea-c33f-4607-b605-1e330ab13827&page=queryresults
[0m13:00:56.154130 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:80d3ed39-512d-4417-b3be-ca8e8ef63ffd&page=queryresults
[0m13:00:58.243892 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:54.313015 => 13:00:58.242912
[0m13:00:58.245895 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421ACEAC0>]}
[0m13:00:58.247901 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 4.01s]
[0m13:00:58.253489 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:58.258495 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m13:00:58.262094 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m13:00:58.266101 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m13:00:58.267102 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m13:00:58.282213 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:58.301200 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 13:00:58.268091 => 13:00:58.298781
[0m13:00:58.307199 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m13:00:58.326994 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:58.779868 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 13:00:54.340817 => 13:00:58.777015
[0m13:00:58.791118 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A8CE20>]}
[0m13:00:58.793160 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 4.52s]
[0m13:00:58.795255 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m13:00:58.799691 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:00:58.805835 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m13:00:58.811554 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m13:00:58.813551 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:00:58.841132 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:00:58.857877 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:00:58.815473 => 13:00:58.855811
[0m13:00:58.862387 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:00:58.877495 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:59.338934 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:59.341574 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:59.737410 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:00:59.745654 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m13:00:59.771793 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32907554-ae6f-4c56-84c6-fe9d9775839b&page=queryresults
[0m13:01:00.412962 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab35e514-4b1b-49ce-bc05-bcb848470b97&page=queryresults
[0m13:01:01.737499 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 13:00:58.311784 => 13:01:01.737499
[0m13:01:01.740120 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234209029A0>]}
[0m13:01:01.745150 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.48s]
[0m13:01:01.748158 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m13:01:01.751829 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m13:01:01.754803 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m13:01:01.758811 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m13:01:01.761498 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m13:01:01.779779 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m13:01:01.788866 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 13:01:01.763485 => 13:01:01.786871
[0m13:01:01.790556 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m13:01:01.828952 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:01:02.887332 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m13:01:02.888328 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m13:01:03.317833 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96282d64-71fc-4140-9745-d63ebbcd49f3&page=queryresults
[0m13:01:04.186585 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:00:58.868404 => 13:01:04.184576
[0m13:01:04.192232 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422B7C1F0>]}
[0m13:01:04.196236 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 5.38s]
[0m13:01:04.201837 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:01:04.206766 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m13:01:04.210312 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m13:01:04.216454 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m13:01:04.220027 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m13:01:04.235533 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:01:04.237512 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 13:01:04.221071 => 13:01:04.236534
[0m13:01:04.238537 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m13:01:04.258204 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:01:05.111220 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:01:05.117251 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m13:01:05.323420 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 13:01:01.790556 => 13:01:05.321381
[0m13:01:05.328509 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422B5F7C0>]}
[0m13:01:05.333196 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.57s]
[0m13:01:05.342039 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m13:01:05.347048 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m13:01:05.350579 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m13:01:05.357666 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m13:01:05.361239 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m13:01:05.393240 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m13:01:05.396274 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 13:01:05.363262 => 13:01:05.395344
[0m13:01:05.400878 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m13:01:05.406994 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:01:05.571515 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:21353911-0b2a-47f8-adad-4e3be0ab2812&page=queryresults
[0m13:01:06.293131 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m13:01:06.310352 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m13:01:06.977954 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4dbfa420-f12c-4802-bce4-6f530544723c&page=queryresults
[0m13:01:07.891561 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 13:01:04.240069 => 13:01:07.888117
[0m13:01:07.896599 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422B8FB80>]}
[0m13:01:07.910908 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.68s]
[0m13:01:07.917973 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m13:01:07.923585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:01:07.926582 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m13:01:07.931142 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m13:01:07.934438 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:01:07.958658 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:01:07.966250 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 13:01:07.936501 => 13:01:07.964241
[0m13:01:07.970339 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:01:08.251769 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:01:09.213940 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:01:09.219660 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m13:01:09.651958 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6cdf6854-4c25-4d1c-920d-22773a85ac6e&page=queryresults
[0m13:01:10.173741 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 13:01:05.401865 => 13:01:10.172707
[0m13:01:10.177701 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422BC3250>]}
[0m13:01:10.970337 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.82s]
[0m13:01:10.975526 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m13:01:10.980152 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m13:01:10.985431 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m13:01:10.992916 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m13:01:10.998921 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m13:01:11.023306 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m13:01:11.027304 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 13:01:11.004907 => 13:01:11.026311
[0m13:01:11.028307 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m13:01:11.034043 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:01:11.818671 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m13:01:11.827241 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:01:11.951091 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 13:01:07.971011 => 13:01:11.948510
[0m13:01:11.956189 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422BB2070>]}
[0m13:01:11.963766 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 4.03s]
[0m13:01:11.974264 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:01:11.976264 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m13:01:11.978264 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m13:01:11.979785 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m13:01:11.980826 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m13:01:11.995457 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:01:11.998385 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 13:01:11.980826 => 13:01:11.996504
[0m13:01:12.002033 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m13:01:12.008953 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:01:12.508116 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3fbe11b-1ca0-4cce-ab69-1f80df34a4d1&page=queryresults
[0m13:01:12.845637 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:01:12.853280 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m13:01:13.297253 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7793264-74ea-41de-9d76-7b18c26fc3ef&page=queryresults
[0m13:01:15.643948 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 13:01:11.028307 => 13:01:15.640938
[0m13:01:15.650164 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023422B396A0>]}
[0m13:01:15.657205 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 4.66s]
[0m13:01:15.665948 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m13:01:16.844188 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 13:01:12.003033 => 13:01:16.842154
[0m13:01:16.855417 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AD71C0>]}
[0m13:01:16.857411 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.88s]
[0m13:01:16.860979 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m13:01:16.864030 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m13:01:16.868140 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m13:01:16.872812 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m13:01:16.873807 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m13:01:16.908772 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:01:16.912554 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 13:01:16.874806 => 13:01:16.911614
[0m13:01:16.913538 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m13:01:16.918543 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:01:17.778100 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:01:17.790468 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:01:18.408162 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be253b02-1ea5-4a97-8fa4-af05d1037654&page=queryresults
[0m13:01:22.174882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 13:01:16.914616 => 13:01:22.172925
[0m13:01:22.179868 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c55e0914-faeb-4063-adf3-54985da8c0cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002342197DD60>]}
[0m13:01:22.183155 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.31s]
[0m13:01:22.188161 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m13:01:22.198888 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:01:22.202558 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:22.204559 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:22.208598 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:01:22.211207 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:01:22.215259 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m13:01:22.217245 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m13:01:22.226858 [info ] [MainThread]: 
[0m13:01:22.231457 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 55.32 seconds (55.32s).
[0m13:01:22.264239 [debug] [MainThread]: Command end result
[0m13:01:22.334274 [info ] [MainThread]: 
[0m13:01:22.338341 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:01:22.342085 [info ] [MainThread]: 
[0m13:01:22.345091 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m13:01:22.352758 [debug] [MainThread]: Command `dbt run` succeeded at 13:01:22.351731 after 61.18 seconds
[0m13:01:22.354762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002341CF82430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421A5F0A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023421AB3820>]}
[0m13:01:22.357463 [debug] [MainThread]: Flushing usage events
[0m13:01:42.427787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D3DA2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D2D4B940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D2D4BB80>]}


============================== 13:01:42.453566 | 4907850f-7573-40fd-8c88-2a110dc8b410 ==============================
[0m13:01:42.453566 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:01:42.458569 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m13:01:46.511925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D2D4B850>]}
[0m13:01:46.980000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7420700>]}
[0m13:01:46.994467 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:01:47.048247 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:01:47.535831 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:01:47.538863 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:01:47.597934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7727850>]}
[0m13:01:47.692945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7624670>]}
[0m13:01:47.694953 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:01:47.697950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7624490>]}
[0m13:01:47.714220 [info ] [MainThread]: 
[0m13:01:47.727210 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:01:47.731862 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:01:47.736897 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:49.131583 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:01:49.131583 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:49.138587 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:01:49.141263 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:50.365710 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m13:01:50.384018 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:01:50.421059 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m13:01:50.425084 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:01:51.414604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7624790>]}
[0m13:01:51.418604 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:01:51.423227 [info ] [MainThread]: 
[0m13:01:51.451383 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:01:51.452422 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m13:01:51.456743 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m13:01:51.457746 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:01:51.504656 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 13:01:51.458747 => 13:01:51.504656
[0m13:01:51.505651 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:01:51.778009 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:01:51.788606 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m13:01:52.847553 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4bc5bf21-3028-4e0e-af53-e8db87225c07&page=queryresults
[0m13:01:54.285778 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m13:01:54.731642 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:770d5a63-af38-4990-8b2c-f0bc4d4d7ecf&page=queryresults
[0m13:01:57.220766 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m13:01:57.973728 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m13:01:57.981247 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m13:01:58.458226 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8be9a0f7-9d6a-453c-ae55-ed523986634a&page=queryresults
[0m13:02:00.799696 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 13:01:51.506655 => 13:02:00.798704
[0m13:02:00.806759 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4907850f-7573-40fd-8c88-2a110dc8b410', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D88070A0>]}
[0m13:02:00.811540 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 9.35s]
[0m13:02:00.816461 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:02:00.825275 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:02:00.827275 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:02:00.829871 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:02:00.830945 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:02:00.832973 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m13:02:00.835898 [info ] [MainThread]: 
[0m13:02:00.838999 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 13.11 seconds (13.11s).
[0m13:02:00.845688 [debug] [MainThread]: Command end result
[0m13:02:00.920870 [info ] [MainThread]: 
[0m13:02:00.923838 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:02:00.926897 [info ] [MainThread]: 
[0m13:02:00.930352 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:02:00.938464 [debug] [MainThread]: Command `dbt snapshot` succeeded at 13:02:00.936395 after 18.91 seconds
[0m13:02:00.939998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D3DA2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D1A476D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D748E1C0>]}
[0m13:02:00.941124 [debug] [MainThread]: Flushing usage events
[0m13:02:21.285015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EA469460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2E93FF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2E93FFD30>]}


============================== 13:02:21.309926 | 21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a ==============================
[0m13:02:21.309926 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:02:21.314483 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:02:25.388763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2E93E5B20>]}
[0m13:02:26.052606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2ED9D4790>]}
[0m13:02:26.058639 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:02:26.110032 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:02:26.668088 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:02:26.669085 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:02:26.721514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EDDDA370>]}
[0m13:02:26.801576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EDCE8220>]}
[0m13:02:26.802622 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:02:26.806623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EDCC6340>]}
[0m13:02:26.819758 [info ] [MainThread]: 
[0m13:02:26.823864 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:02:26.833468 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:02:26.838019 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:02:27.810000 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:02:27.814048 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:02:27.820060 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:02:27.827196 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:02:28.728448 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m13:02:28.731083 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:02:28.878156 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:02:28.899987 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:02:29.833682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EDABD850>]}
[0m13:02:29.840240 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:02:29.850161 [info ] [MainThread]: 
[0m13:02:29.869986 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:02:29.874039 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m13:02:29.880595 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m13:02:29.884669 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:02:29.960485 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m13:02:29.967528 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 13:02:29.885666 => 13:02:29.965494
[0m13:02:29.971105 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:02:30.043242 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:02:31.075989 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m13:02:31.082277 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m13:02:31.521266 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0f26a2e-5cc5-4e5b-998f-1fd1222cb19d&page=queryresults
[0m13:02:34.803269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 13:02:29.973118 => 13:02:34.803269
[0m13:02:34.809786 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EEE99190>]}
[0m13:02:34.821456 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 4.93s]
[0m13:02:34.823485 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:02:34.828513 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m13:02:34.834082 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m13:02:34.839102 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m13:02:34.842319 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m13:02:34.868683 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m13:02:34.872248 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 13:02:34.844317 => 13:02:34.872248
[0m13:02:34.873249 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m13:02:34.878248 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:02:35.703086 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m13:02:35.711641 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m13:02:36.152009 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c6ae0773-63ba-4feb-bef0-9be462ed9d5c&page=queryresults
[0m13:02:38.416534 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 13:02:34.874292 => 13:02:38.415526
[0m13:02:38.421135 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21d4b2fc-e7ef-41fe-bc42-6284e6d40a0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EEE4EBB0>]}
[0m13:02:38.423237 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.58s]
[0m13:02:38.424228 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m13:02:38.436907 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:02:38.439938 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:02:38.441647 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:02:38.443638 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:02:38.445569 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m13:02:38.449193 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m13:02:38.451350 [info ] [MainThread]: 
[0m13:02:38.455352 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.63 seconds (11.63s).
[0m13:02:38.462905 [debug] [MainThread]: Command end result
[0m13:02:38.563056 [info ] [MainThread]: 
[0m13:02:38.568089 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:02:38.570545 [info ] [MainThread]: 
[0m13:02:38.572612 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m13:02:38.580199 [debug] [MainThread]: Command `dbt run` succeeded at 13:02:38.577637 after 17.71 seconds
[0m13:02:38.583249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EA469460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2ED9D4790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2EEEA3670>]}
[0m13:02:38.584270 [debug] [MainThread]: Flushing usage events
[0m14:00:14.000123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBF85E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBF756F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBF756FD30>]}


============================== 14:00:14.027548 | ed18810a-0c0b-4961-a524-5a5f29c9bb8d ==============================
[0m14:00:14.027548 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:14.035677 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m14:00:16.709449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBF7555970>]}
[0m14:00:16.895321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBB40160>]}
[0m14:00:16.900161 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:16.945699 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:17.071856 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:17.071856 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:17.101970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBF57EB0>]}
[0m14:00:17.154531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBE6ED60>]}
[0m14:00:17.161042 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:17.164260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBE6EB80>]}
[0m14:00:17.171739 [info ] [MainThread]: 
[0m14:00:17.175532 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:17.184694 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:17.186307 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:17.191456 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:17.199797 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:18.267765 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:19.318368 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:00:19.321740 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:19.324949 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:19.327864 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:20.183297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:00:20.184982 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:20.203702 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m14:00:20.223435 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:21.116705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBD1EEB0>]}
[0m14:00:21.121943 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:21.125815 [info ] [MainThread]: 
[0m14:00:21.149998 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:21.161075 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:21.151075 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m14:00:21.164187 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m14:00:21.167506 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:21.169221 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:21.171313 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:21.173404 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:21.222258 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:21.243207 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:21.246545 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:21.174990 => 14:00:21.246545
[0m14:00:21.247587 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:21.295851 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:21.213983 => 14:00:21.293746
[0m14:00:21.311266 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:21.407681 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:21.412837 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:21.418407 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:21.422095 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:21.432981 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m14:00:21.501043 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:22.579085 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:713721d6-6033-4bd2-83ab-d88e0d6d66dd&page=queryresults
[0m14:00:22.594240 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8dd06e1a-33ac-4213-830a-1beea4d42dcc&page=queryresults
[0m14:00:23.125874 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:21.352803 => 14:00:23.123774
[0m14:00:23.131141 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD034220>]}
[0m14:00:23.149430 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:21.248113 => 14:00:23.148428
[0m14:00:23.143863 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.96s]
[0m14:00:23.158099 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD057EE0>]}
[0m14:00:23.160043 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:23.161040 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.99s]
[0m14:00:23.165656 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:23.170630 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:23.176220 [info ] [Thread-2  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m14:00:23.178250 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m14:00:23.183252 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:23.186809 [info ] [Thread-1  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m14:00:23.189823 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:23.195377 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m14:00:23.203390 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m14:00:23.232671 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m14:00:23.259527 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:23.264861 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 14:00:23.212039 => 14:00:23.261977
[0m14:00:23.265448 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m14:00:23.270434 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m14:00:23.273522 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:23.197384 => 14:00:23.270434
[0m14:00:23.276281 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:23.289295 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:23.291908 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:23.299387 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m14:00:23.345590 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:23.350414 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:24.194804 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc0b3c56-e4f4-4fd6-9b9c-7edb6d8f52a7&page=queryresults
[0m14:00:24.205006 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f04957aa-45b3-4f87-88e6-1067d665e808&page=queryresults
[0m14:00:24.633216 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:23.278976 => 14:00:24.631875
[0m14:00:24.641575 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBFA8070>]}
[0m14:00:24.645017 [info ] [Thread-2  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m14:00:24.653387 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 14:00:23.266492 => 14:00:24.653387
[0m14:00:24.655971 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:24.659970 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFCFCD370>]}
[0m14:00:24.665587 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:24.669072 [info ] [Thread-1  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m14:00:24.675945 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m14:00:24.671046 [info ] [Thread-2  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m14:00:24.680972 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.685547 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m14:00:24.688548 [info ] [Thread-1  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m14:00:24.691551 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m14:00:24.696132 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m14:00:24.704691 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.718865 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:24.731730 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:24.742337 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 14:00:24.697157 => 14:00:24.737330
[0m14:00:24.744882 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m14:00:24.765128 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:24.769143 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 14:00:24.720860 => 14:00:24.766137
[0m14:00:24.773147 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m14:00:24.788337 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:24.806449 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:24.814979 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m14:00:24.879510 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:24.885831 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m14:00:25.747926 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:656400cb-5f13-4ea7-b175-5f26c3e1ddf8&page=queryresults
[0m14:00:25.769049 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:90130205-a1cd-41ee-9a0c-4e9f7c0785d2&page=queryresults
[0m14:00:26.214133 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 14:00:24.774688 => 14:00:26.211913
[0m14:00:26.215481 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD08EE20>]}
[0m14:00:26.215481 [info ] [Thread-1  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m14:00:26.217157 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m14:00:26.218859 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m14:00:26.219450 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m14:00:26.224795 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_compra)
[0m14:00:26.224795 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m14:00:26.231677 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m14:00:26.237912 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 14:00:24.752970 => 14:00:26.237912
[0m14:00:26.252079 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0B2E20>]}
[0m14:00:26.261790 [info ] [Thread-2  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m14:00:26.264572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 14:00:26.226493 => 14:00:26.264015
[0m14:00:26.269190 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:26.272614 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m14:00:26.277144 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m14:00:26.299941 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m14:00:26.303431 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m14:00:26.310635 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m14:00:26.310635 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m14:00:26.318551 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:26.320209 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:26.326559 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m14:00:26.379978 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 14:00:26.312363 => 14:00:26.378014
[0m14:00:26.383008 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m14:00:26.401111 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:26.405754 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:26.410883 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m14:00:27.262984 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1212657-6d16-4b2c-b975-336b6ca22b07&page=queryresults
[0m14:00:27.390215 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f726f3db-1f39-49c4-b945-f4231562ff32&page=queryresults
[0m14:00:27.677462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 14:00:26.280172 => 14:00:27.675907
[0m14:00:27.680697 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0DFA90>]}
[0m14:00:27.681756 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m14:00:27.684579 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m14:00:27.685226 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:27.686288 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m14:00:27.691008 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m14:00:27.692062 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:27.697918 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:27.700031 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 14:00:27.692062 => 14:00:27.699490
[0m14:00:27.700031 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:27.737193 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:27.741340 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:27.744986 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m14:00:27.841790 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 14:00:26.384582 => 14:00:27.840747
[0m14:00:27.847078 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0EF730>]}
[0m14:00:27.853820 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m14:00:27.857223 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m14:00:27.860489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m14:00:27.865755 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m14:00:27.870682 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m14:00:27.875846 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m14:00:27.899364 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m14:00:27.900514 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 14:00:27.881911 => 14:00:27.900514
[0m14:00:27.902088 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m14:00:27.906304 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m14:00:27.908436 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:27.910553 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m14:00:28.676126 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:089a158f-ceb8-4c07-bcb8-28a6b432bce4&page=queryresults
[0m14:00:28.773629 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7bc3e10-2d23-488c-926d-86c29236b4f4&page=queryresults
[0m14:00:29.095294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 14:00:27.701074 => 14:00:29.095294
[0m14:00:29.096355 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD004670>]}
[0m14:00:29.097814 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m14:00:29.102014 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:29.104124 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:29.106358 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m14:00:29.113703 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m14:00:29.115787 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:29.138806 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:29.160915 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 14:00:27.902088 => 14:00:29.156880
[0m14:00:29.173079 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD00C0A0>]}
[0m14:00:29.174660 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m14:00:29.180251 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m14:00:29.184457 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:29.117874 => 14:00:29.182364
[0m14:00:29.187752 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m14:00:29.192572 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:29.196264 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m14:00:29.215667 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:29.220270 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m14:00:29.226126 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m14:00:29.237748 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m14:00:29.238811 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:29.254950 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:29.255546 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 14:00:29.229501 => 14:00:29.255546
[0m14:00:29.318192 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m14:00:29.332858 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m14:00:29.342434 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:29.351867 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m14:00:30.042250 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72cec6e2-a682-495e-9fcb-3e5346014f76&page=queryresults
[0m14:00:30.356157 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35e8c3d6-5049-46c1-bb46-f758e8fe34fd&page=queryresults
[0m14:00:30.467659 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:29.198376 => 14:00:30.467659
[0m14:00:30.468660 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD057EE0>]}
[0m14:00:30.469595 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m14:00:30.471643 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:30.473581 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m14:00:30.475256 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m14:00:30.480298 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m14:00:30.483307 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m14:00:30.489893 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m14:00:30.491875 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 14:00:30.484834 => 14:00:30.491875
[0m14:00:30.492873 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m14:00:30.503421 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m14:00:30.504948 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:30.511023 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m14:00:30.762445 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 14:00:29.320794 => 14:00:30.761919
[0m14:00:30.764036 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD04BDC0>]}
[0m14:00:30.764558 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m14:00:30.766701 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m14:00:30.768303 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m14:00:30.770940 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m14:00:30.776069 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m14:00:30.776069 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m14:00:30.782448 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m14:00:30.798171 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 14:00:30.777703 => 14:00:30.788071
[0m14:00:30.799788 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m14:00:30.806701 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m14:00:30.812867 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:30.817677 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m14:00:31.316384 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02206063-c3e9-4545-8730-22a2d4be8353&page=queryresults
[0m14:00:31.705817 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 14:00:30.492873 => 14:00:31.705817
[0m14:00:31.707435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD11E1C0>]}
[0m14:00:31.707435 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m14:00:31.711852 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m14:00:31.716633 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:31.720427 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m14:00:31.725588 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m14:00:31.729585 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:31.745804 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:31.749755 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:31.731603 => 14:00:31.748767
[0m14:00:31.750758 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:31.776021 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:31.778938 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0bbd9c96-9ac6-4d65-b9da-dd47dd5930e9&page=queryresults
[0m14:00:32.221475 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 14:00:30.801421 => 14:00:32.219853
[0m14:00:32.221475 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0C1FA0>]}
[0m14:00:32.228025 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m14:00:32.231312 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m14:00:32.525299 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:32.526349 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:33.161990 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6e35097-4cc9-48a6-b96c-4a0742bb43a3&page=queryresults
[0m14:00:36.083437 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:31.750758 => 14:00:36.081411
[0m14:00:36.087006 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBFED4F0>]}
[0m14:00:36.088021 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.36s]
[0m14:00:36.092031 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:36.102037 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:36.107573 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m14:00:36.109215 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m14:00:36.110914 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:36.117652 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:36.119735 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:36.110914 => 14:00:36.119215
[0m14:00:36.120766 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:36.125617 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:36.997887 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:37.000178 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m14:00:37.689711 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e87ed409-4766-4aea-a5fe-5355a8c3a3b7&page=queryresults
[0m14:00:39.934386 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:36.120766 => 14:00:39.934386
[0m14:00:39.935787 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD1A3F40>]}
[0m14:00:39.935787 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 3.83s]
[0m14:00:39.940266 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:39.950590 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:39.952657 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m14:00:39.954720 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m14:00:39.962947 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:39.966249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:39.957949 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m14:00:39.990471 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:39.994653 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m14:00:39.997804 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m14:00:40.014426 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m14:00:40.018485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:39.969891 => 14:00:40.015661
[0m14:00:40.025541 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:40.044525 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:40.089176 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 14:00:40.001376 => 14:00:40.087043
[0m14:00:40.093367 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m14:00:40.105972 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:40.816949 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:40.818501 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:40.856461 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m14:00:40.859157 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m14:00:41.433118 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:deb247bf-3c2b-41a7-a332-6a53066b0c5c&page=queryresults
[0m14:00:41.534627 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2dcb25d8-05d7-4831-8ea4-7ec443e194ba&page=queryresults
[0m14:00:43.779568 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:40.027662 => 14:00:43.779568
[0m14:00:43.781294 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD253EE0>]}
[0m14:00:43.782948 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.82s]
[0m14:00:43.788123 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:43.791884 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m14:00:43.795117 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m14:00:43.800354 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m14:00:43.803776 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m14:00:43.814115 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:43.822100 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 14:00:43.804904 => 14:00:43.819936
[0m14:00:43.825024 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m14:00:43.838260 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:44.558627 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:44.560548 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:44.904973 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 14:00:40.095495 => 14:00:44.904973
[0m14:00:44.909791 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0AC310>]}
[0m14:00:44.914994 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 4.92s]
[0m14:00:44.923547 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m14:00:44.932518 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m14:00:44.934066 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m14:00:44.936322 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m14:00:44.936322 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m14:00:44.943110 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m14:00:44.946036 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9628c268-330f-43f3-b927-8066eb5dc554&page=queryresults
[0m14:00:44.954766 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 14:00:44.937371 => 14:00:44.954130
[0m14:00:44.955372 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m14:00:44.962108 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:45.684341 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m14:00:45.687442 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m14:00:46.377643 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:306cb452-8a52-4a05-afde-8b6da7ab60ef&page=queryresults
[0m14:00:46.996203 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 14:00:43.826770 => 14:00:46.994644
[0m14:00:47.001601 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBFED4F0>]}
[0m14:00:47.003315 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.20s]
[0m14:00:47.007834 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m14:00:47.010617 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:47.014555 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m14:00:47.019247 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m14:00:47.023216 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:47.038784 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m14:00:47.044846 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 14:00:47.024875 => 14:00:47.042566
[0m14:00:47.046057 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:47.064818 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:47.948143 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m14:00:47.954864 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m14:00:48.372469 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c31fb139-33fd-49d7-a86b-27cc461e4614&page=queryresults
[0m14:00:49.082451 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 14:00:44.956488 => 14:00:49.082451
[0m14:00:49.084156 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD13BC10>]}
[0m14:00:49.085530 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.15s]
[0m14:00:49.090106 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m14:00:49.094994 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:49.097759 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m14:00:49.102648 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m14:00:49.104357 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m14:00:49.125037 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:49.127865 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 14:00:49.117196 => 14:00:49.127329
[0m14:00:49.127865 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m14:00:49.134313 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:49.855880 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:49.864574 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m14:00:50.295216 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6d2bb8c-1aba-4b3a-be2f-d3834c89154b&page=queryresults
[0m14:00:50.621376 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 14:00:47.046057 => 14:00:50.619717
[0m14:00:50.626728 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD1C44F0>]}
[0m14:00:50.638892 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.61s]
[0m14:00:50.642554 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:50.645753 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m14:00:50.647400 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m14:00:50.651634 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m14:00:50.653769 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m14:00:50.660023 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m14:00:50.661059 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 14:00:50.654305 => 14:00:50.661059
[0m14:00:50.662089 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m14:00:50.676887 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:51.415071 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m14:00:51.424697 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m14:00:52.056218 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d631e9e9-71f7-4d4d-817d-0ce334b9f3e2&page=queryresults
[0m14:00:52.869290 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 14:00:49.127865 => 14:00:52.867300
[0m14:00:52.872034 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD1A3D90>]}
[0m14:00:52.876751 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.77s]
[0m14:00:52.880939 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:52.887793 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:52.889913 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m14:00:52.896773 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m14:00:52.900035 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:52.908069 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:52.910167 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 14:00:52.900035 => 14:00:52.909639
[0m14:00:52.910686 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:52.913837 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:53.666402 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:53.669645 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m14:00:54.105634 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e48fb3ad-9159-4221-8b31-390e95c949e8&page=queryresults
[0m14:00:54.587223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 14:00:50.664685 => 14:00:54.586629
[0m14:00:54.587754 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0858B0>]}
[0m14:00:55.337275 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 3.94s]
[0m14:00:55.342269 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m14:00:55.345837 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m14:00:55.349117 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m14:00:55.351828 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m14:00:55.353273 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m14:00:55.363563 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m14:00:55.365941 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 14:00:55.353273 => 14:00:55.365941
[0m14:00:55.367600 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m14:00:55.370886 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:56.118754 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m14:00:56.124652 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:56.750427 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5efa50e5-da1a-4aca-81d0-a0dcaa8c7f4b&page=queryresults
[0m14:00:56.930062 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 14:00:52.910686 => 14:00:56.930062
[0m14:00:56.931098 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0DF670>]}
[0m14:00:56.932710 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 4.04s]
[0m14:00:56.936870 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:56.942171 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m14:00:56.945860 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m14:00:56.951036 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m14:00:56.954763 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m14:00:56.980216 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:56.982882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 14:00:56.955809 => 14:00:56.982345
[0m14:00:56.984506 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m14:00:56.989603 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:57.708990 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:57.717635 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m14:00:58.220013 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4d78def1-b842-4f79-a056-92feaaceefae&page=queryresults
[0m14:00:58.989278 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 14:00:55.367600 => 14:00:58.987176
[0m14:00:58.995192 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD26F100>]}
[0m14:00:59.001103 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 3.64s]
[0m14:00:59.007232 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m14:01:01.450376 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 14:00:56.985110 => 14:01:01.448642
[0m14:01:01.463175 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD0EF280>]}
[0m14:01:01.465408 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.51s]
[0m14:01:01.466985 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m14:01:01.469171 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m14:01:01.469707 [info ] [Thread-1  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m14:01:01.472953 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m14:01:01.472953 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m14:01:01.486445 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:01:01.488467 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 14:01:01.472953 => 14:01:01.488467
[0m14:01:01.488467 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m14:01:01.504447 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:01:02.224567 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:01:02.229339 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:01:02.842710 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:472f606a-66d8-43e2-ac47-4e7e2c4aa929&page=queryresults
[0m14:01:07.915196 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 14:01:01.490159 => 14:01:07.915196
[0m14:01:07.916923 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed18810a-0c0b-4961-a524-5a5f29c9bb8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBFE9460>]}
[0m14:01:07.918037 [info ] [Thread-1  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 6.45s]
[0m14:01:07.921032 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m14:01:07.928949 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:07.930594 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:07.930594 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:07.930594 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:01:07.930594 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:01:07.930594 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m14:01:07.932353 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m14:01:07.932353 [info ] [MainThread]: 
[0m14:01:07.933980 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 50.76 seconds (50.76s).
[0m14:01:07.954627 [debug] [MainThread]: Command end result
[0m14:01:07.988061 [info ] [MainThread]: 
[0m14:01:07.991417 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:01:07.995620 [info ] [MainThread]: 
[0m14:01:07.999245 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m14:01:08.002411 [debug] [MainThread]: Command `dbt run` succeeded at 14:01:08.002411 after 54.23 seconds
[0m14:01:08.003451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBF85E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFBD1E040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DBFD1A38E0>]}
[0m14:01:08.004506 [debug] [MainThread]: Flushing usage events
[0m14:01:23.747717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D39F5C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D39E53C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D39E53CD30>]}


============================== 14:01:23.773349 | 0c038829-7a99-46dd-aebf-bff36b6737f2 ==============================
[0m14:01:23.773349 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:01:23.776977 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:01:28.449124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D39E53CD90>]}
[0m14:01:28.980327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2B4FD30>]}
[0m14:01:28.988917 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:01:29.048018 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:01:29.612008 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:01:29.615698 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:01:29.660740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2F27700>]}
[0m14:01:29.740238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2E1D520>]}
[0m14:01:29.742933 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:01:29.746358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2E1D310>]}
[0m14:01:29.762229 [info ] [MainThread]: 
[0m14:01:29.768747 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:01:29.789453 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:01:29.793758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:30.726213 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:01:30.729259 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:30.732809 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m14:01:30.735523 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:31.530768 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:01:31.533235 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:31.556991 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m14:01:31.566441 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:32.519263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2BBEC40>]}
[0m14:01:32.521372 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:01:32.522462 [info ] [MainThread]: 
[0m14:01:32.539949 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:01:32.543678 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m14:01:32.551626 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m14:01:32.555057 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:01:32.611276 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 14:01:32.558912 => 14:01:32.611276
[0m14:01:32.612855 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:01:32.862987 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:01:32.867940 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m14:01:33.802258 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c7b73a3-5fb5-4752-9360-e513b41f0db4&page=queryresults
[0m14:01:35.189303 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m14:01:35.557057 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b7f55cb-163e-4be6-bcb4-17525f1d7f90&page=queryresults
[0m14:01:39.398261 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m14:01:40.307601 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m14:01:40.319566 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m14:01:40.783365 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:250ebcdb-26e6-4e01-b131-257b0600f5b5&page=queryresults
[0m14:01:43.735223 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 14:01:32.613384 => 14:01:43.733633
[0m14:01:43.743251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c038829-7a99-46dd-aebf-bff36b6737f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A3FD41F0>]}
[0m14:01:43.752844 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 11.19s]
[0m14:01:43.758441 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:01:43.774711 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:43.780765 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:43.781783 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:01:43.783774 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m14:01:43.785292 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m14:01:43.791411 [info ] [MainThread]: 
[0m14:01:43.795053 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 14.02 seconds (14.02s).
[0m14:01:43.797179 [debug] [MainThread]: Command end result
[0m14:01:43.873056 [info ] [MainThread]: 
[0m14:01:43.875970 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:01:43.880947 [info ] [MainThread]: 
[0m14:01:43.886536 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:01:43.892562 [debug] [MainThread]: Command `dbt snapshot` succeeded at 14:01:43.890567 after 20.60 seconds
[0m14:01:43.897174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D39F5C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A2B4FD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3A3FD93D0>]}
[0m14:01:43.900180 [debug] [MainThread]: Flushing usage events
[0m14:02:00.860330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B3631430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B25D1640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B25D1AC0>]}


============================== 14:02:00.894774 | c69c17d6-b2cf-413c-836e-799b89ad8fbc ==============================
[0m14:02:00.894774 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:02:00.896853 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:02:05.582889 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B25BF040>]}
[0m14:02:06.172019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B258FF10>]}
[0m14:02:06.175595 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:02:06.258283 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:02:06.937817 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:02:06.940834 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:02:06.988944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B6FB86A0>]}
[0m14:02:07.059755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B6EB34C0>]}
[0m14:02:07.061732 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:02:07.065364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B6EB32B0>]}
[0m14:02:07.076147 [info ] [MainThread]: 
[0m14:02:07.083070 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:02:07.097409 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:02:07.099401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:08.118082 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:02:08.122074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:08.134706 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m14:02:08.136288 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:09.208027 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m14:02:09.212999 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:09.452864 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m14:02:09.458168 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:10.415173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B6C4F220>]}
[0m14:02:10.423256 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:02:10.424809 [info ] [MainThread]: 
[0m14:02:10.449719 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:02:10.453730 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m14:02:10.459323 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m14:02:10.461349 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:02:10.523283 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:02:10.538606 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 14:02:10.465937 => 14:02:10.530940
[0m14:02:10.548806 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:02:10.708635 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:02:12.093541 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:02:12.097082 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m14:02:12.506553 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c930d97-9058-41de-afb6-e9dfdc286468&page=queryresults
[0m14:02:15.299742 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 14:02:10.557492 => 14:02:15.298697
[0m14:02:15.305283 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B807A250>]}
[0m14:02:15.314803 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 4.85s]
[0m14:02:15.333431 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:02:15.346648 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m14:02:15.349060 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m14:02:15.379567 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m14:02:15.383564 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m14:02:15.412183 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m14:02:15.421820 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 14:02:15.385104 => 14:02:15.417828
[0m14:02:15.423846 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m14:02:15.440209 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:02:16.384821 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m14:02:16.391960 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m14:02:16.735765 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a00574fa-f14b-4e47-88c4-2b2052365a69&page=queryresults
[0m14:02:19.014673 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 14:02:15.424832 => 14:02:19.009512
[0m14:02:19.019745 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c69c17d6-b2cf-413c-836e-799b89ad8fbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B802E670>]}
[0m14:02:19.023846 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.64s]
[0m14:02:19.027541 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m14:02:19.033103 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:02:19.034644 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:02:19.037274 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m14:02:19.041344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m14:02:19.043385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m14:02:19.044939 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m14:02:19.045991 [info ] [MainThread]: 
[0m14:02:19.048036 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.97 seconds (11.97s).
[0m14:02:19.063753 [debug] [MainThread]: Command end result
[0m14:02:19.173223 [info ] [MainThread]: 
[0m14:02:19.175981 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:02:19.177226 [info ] [MainThread]: 
[0m14:02:19.181652 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m14:02:19.225685 [debug] [MainThread]: Command `dbt run` succeeded at 14:02:19.224626 after 18.80 seconds
[0m14:02:19.226688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B3631430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B258FF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277B6D894F0>]}
[0m14:02:19.227741 [debug] [MainThread]: Flushing usage events
[0m15:00:15.085471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D95E3133D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D95D2919D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D95D291B80>]}


============================== 15:00:15.101989 | 6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc ==============================
[0m15:00:15.101989 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:15.105210 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:18.136761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D96045AAF0>]}
[0m15:00:18.507148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961983430>]}
[0m15:00:18.511301 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:18.525688 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:19.023880 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:19.025958 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:19.051384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961C78610>]}
[0m15:00:19.094059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961B73430>]}
[0m15:00:19.097338 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:19.100657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961B73250>]}
[0m15:00:19.107118 [info ] [MainThread]: 
[0m15:00:19.111338 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:19.128464 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:19.131131 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:19.136525 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:19.138600 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:20.214387 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:20.934798 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:20.935812 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:20.939638 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:20.944894 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:21.727635 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m15:00:21.731100 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:21.747442 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:21.755858 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:22.623491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9619E4760>]}
[0m15:00:22.624539 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:22.626640 [info ] [MainThread]: 
[0m15:00:22.644867 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:22.648678 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:22.650758 [info ] [Thread-1  ]: 1 of 27 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:00:22.653398 [info ] [Thread-2  ]: 2 of 27 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:00:22.658137 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:22.662021 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:22.666056 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:22.668237 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:22.722747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:22.746473 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:22.753070 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:22.688852 => 15:00:22.750080
[0m15:00:22.757657 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:22.783818 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:22.670356 => 15:00:22.781820
[0m15:00:22.816893 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:22.943678 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:22.963972 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:22.968606 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:22.975587 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:23.075295 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:23.079390 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:00:24.287505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a91da980-90f5-4ec6-a2fc-4ddebd76a329&page=queryresults
[0m15:00:24.289091 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6ef77c9-a173-41e6-9e22-072c37ade406&page=queryresults
[0m15:00:24.862969 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:22.829246 => 15:00:24.846794
[0m15:00:24.861401 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:22.759656 => 15:00:24.860326
[0m15:00:24.868748 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962CEAE20>]}
[0m15:00:24.872950 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962D8B0A0>]}
[0m15:00:24.877162 [info ] [Thread-1  ]: 1 of 27 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 2.21s]
[0m15:00:24.885533 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:24.879730 [info ] [Thread-2  ]: 2 of 27 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 2.21s]
[0m15:00:24.889308 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:24.895126 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:24.899563 [info ] [Thread-1  ]: 3 of 27 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:00:24.904472 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m15:00:24.911535 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:24.914228 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:24.913177 [info ] [Thread-2  ]: 4 of 27 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m15:00:24.929409 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m15:00:24.943036 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m15:00:24.963974 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m15:00:24.956774 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:24.969235 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:24.917427 => 15:00:24.968714
[0m15:00:24.971326 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:24.975528 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 15:00:24.956774 => 15:00:24.972905
[0m15:00:24.989722 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:24.992996 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m15:00:25.016197 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m15:00:25.022756 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:25.034813 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:25.057245 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:25.121164 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m15:00:25.973406 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49670fdd-f895-4a10-a5d6-22db1610887a&page=queryresults
[0m15:00:25.998377 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3711d1f-c477-4a2c-aa1d-edf06d3ff3f1&page=queryresults
[0m15:00:26.399500 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:24.977600 => 15:00:26.399500
[0m15:00:26.403690 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961D06580>]}
[0m15:00:26.405298 [info ] [Thread-1  ]: 3 of 27 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m15:00:26.412176 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:26.420463 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 15:00:24.996668 => 15:00:26.419938
[0m15:00:26.423628 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:26.429154 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962CF2AC0>]}
[0m15:00:26.433508 [info ] [Thread-1  ]: 5 of 27 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m15:00:26.436139 [info ] [Thread-2  ]: 4 of 27 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m15:00:26.440348 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m15:00:26.444580 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m15:00:26.447362 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:00:26.450504 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:00:26.457342 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:26.459442 [info ] [Thread-2  ]: 6 of 27 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:00:26.465850 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m15:00:26.468532 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:00:26.488571 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:26.493166 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:00:26.452399 => 15:00:26.490365
[0m15:00:26.496676 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:00:26.521096 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:00:26.471180 => 15:00:26.521096
[0m15:00:26.522700 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:00:26.539394 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:26.553597 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:26.556789 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:26.566483 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:26.569610 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:00:26.668087 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:27.499474 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ae5a2f3-528a-4d4f-bd27-1575e64cf84a&page=queryresults
[0m15:00:27.533038 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db6b34c0-f9ea-466e-8103-a70c8805ccc1&page=queryresults
[0m15:00:27.930434 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:00:26.499425 => 15:00:27.930434
[0m15:00:27.932012 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DD5BB0>]}
[0m15:00:27.932534 [info ] [Thread-1  ]: 5 of 27 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m15:00:27.936844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:27.939528 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m15:00:27.943334 [info ] [Thread-1  ]: 7 of 27 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m15:00:27.952544 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m15:00:27.958416 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m15:00:27.969418 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m15:00:27.986032 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:00:26.523748 => 15:00:27.985503
[0m15:00:27.987178 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962D36BB0>]}
[0m15:00:27.989797 [info ] [Thread-2  ]: 6 of 27 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m15:00:27.994713 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 15:00:27.959972 => 15:00:27.991419
[0m15:00:28.000584 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:00:28.003915 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m15:00:28.007057 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m15:00:28.018018 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m15:00:28.020121 [info ] [Thread-2  ]: 8 of 27 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m15:00:28.025345 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m15:00:28.029011 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m15:00:28.039022 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:28.041640 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:28.048137 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m15:00:28.119475 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 15:00:28.031103 => 15:00:28.117899
[0m15:00:28.122118 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m15:00:28.132739 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:28.141357 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:28.146922 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m15:00:28.886230 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad9e8a04-e9c8-422c-8e62-72bf3c78a8fc&page=queryresults
[0m15:00:29.009484 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b74a5aae-ce80-42e9-bc6c-7ea5b109170f&page=queryresults
[0m15:00:29.317535 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 15:00:28.010170 => 15:00:29.316425
[0m15:00:29.322409 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961D0C1C0>]}
[0m15:00:29.327435 [info ] [Thread-1  ]: 7 of 27 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m15:00:29.330645 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m15:00:29.332405 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:29.334060 [info ] [Thread-1  ]: 9 of 27 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m15:00:29.339377 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m15:00:29.342393 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:29.358430 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:29.369982 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 15:00:29.344511 => 15:00:29.368952
[0m15:00:29.370500 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:29.390368 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:29.397484 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:29.404692 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m15:00:29.487254 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 15:00:28.124459 => 15:00:29.486724
[0m15:00:29.495322 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962E5D970>]}
[0m15:00:29.517018 [info ] [Thread-2  ]: 8 of 27 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m15:00:29.519066 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m15:00:29.521048 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m15:00:29.524054 [info ] [Thread-2  ]: 10 of 27 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m15:00:29.529690 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m15:00:29.532678 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m15:00:29.546822 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m15:00:29.548364 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 15:00:29.534674 => 15:00:29.548364
[0m15:00:29.549370 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m15:00:29.556379 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m15:00:29.564120 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:29.574704 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m15:00:30.544879 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a4b2928-c1a1-4348-ae40-6e2f6369dc4a&page=queryresults
[0m15:00:30.718995 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:094168a7-e23c-4ffe-b912-5863d26fd962&page=queryresults
[0m15:00:30.977161 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 15:00:29.371015 => 15:00:30.975615
[0m15:00:30.981250 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962D14160>]}
[0m15:00:30.985021 [info ] [Thread-1  ]: 9 of 27 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m15:00:31.001343 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:31.003452 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:31.004501 [info ] [Thread-1  ]: 11 of 27 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m15:00:31.025290 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m15:00:31.025290 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:31.037709 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:31.041508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:31.026904 => 15:00:31.040460
[0m15:00:31.042552 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:31.057731 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:31.059866 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:31.065192 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:31.173397 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 15:00:29.550368 => 15:00:31.172396
[0m15:00:31.175396 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962E5D940>]}
[0m15:00:31.176396 [info ] [Thread-2  ]: 10 of 27 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.65s]
[0m15:00:31.189507 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m15:00:31.192511 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m15:00:31.197029 [info ] [Thread-2  ]: 12 of 27 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m15:00:31.202081 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m15:00:31.205073 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m15:00:31.210621 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m15:00:31.212633 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 15:00:31.206597 => 15:00:31.211665
[0m15:00:31.213626 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m15:00:31.244376 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m15:00:31.246928 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:31.252056 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m15:00:32.030023 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:343b847f-1c8e-4fd2-9244-c57ee2061b5a&page=queryresults
[0m15:00:32.118719 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a138976d-b1f6-4255-a522-864805fafc20&page=queryresults
[0m15:00:32.426546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:31.043080 => 15:00:32.425525
[0m15:00:32.427580 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DD2BB0>]}
[0m15:00:32.428607 [info ] [Thread-1  ]: 11 of 27 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m15:00:32.431197 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:32.432231 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m15:00:32.433855 [info ] [Thread-1  ]: 13 of 27 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m15:00:32.436482 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m15:00:32.437508 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m15:00:32.443871 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m15:00:32.448351 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 15:00:32.437508 => 15:00:32.446674
[0m15:00:32.451501 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m15:00:32.466682 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m15:00:32.469799 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:32.472175 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m15:00:32.575282 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 15:00:31.213626 => 15:00:32.572061
[0m15:00:32.579439 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DDB760>]}
[0m15:00:32.583617 [info ] [Thread-2  ]: 12 of 27 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m15:00:32.587496 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m15:00:32.591199 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_lead_time
[0m15:00:32.592230 [info ] [Thread-2  ]: 14 of 27 START sql view model dbt_dw_stg.stg_lead_time ......................... [RUN]
[0m15:00:32.594335 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_lead_time)
[0m15:00:32.594335 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_lead_time
[0m15:00:32.611807 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_lead_time"
[0m15:00:32.617424 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (compile): 15:00:32.597146 => 15:00:32.614902
[0m15:00:32.618974 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_lead_time
[0m15:00:32.630432 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_lead_time"
[0m15:00:32.631887 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:32.634542 [debug] [Thread-2  ]: On model.shibaribrasil.stg_lead_time: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_lead_time"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
  OPTIONS(
      description=""""""
    )
  as 

select distinct 
       ds_origem_produto
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 15
        when ds_origem_produto in ('Revenda Importada')
          then 25
        else null end qt_lead_time
      ,case 
        when ds_origem_produto in ('Revenda Nacional', 'ProduÃ§Ã£o PrÃ³pria', 'Uso e Consumo')
          then 45
        when ds_origem_produto in ('Revenda Importada')
          then 60
        else null end qt_cobertura_desejada
  from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`;


[0m15:00:33.282977 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1b05d8b-ecc3-468b-b72b-771b87a844bd&page=queryresults
[0m15:00:33.624165 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c1ff0a0-bd08-4fc5-87bf-178e1275c60d&page=queryresults
[0m15:00:33.745582 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 15:00:32.452573 => 15:00:33.744020
[0m15:00:33.749885 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962CE7A30>]}
[0m15:00:33.753024 [info ] [Thread-1  ]: 13 of 27 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m15:00:33.758314 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m15:00:33.760567 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:33.765701 [info ] [Thread-1  ]: 15 of 27 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m15:00:33.773010 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m15:00:33.774054 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:33.797690 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:33.814204 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:33.774054 => 15:00:33.813687
[0m15:00:33.816740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:33.852948 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:34.048172 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_lead_time (execute): 15:00:32.621026 => 15:00:34.048172
[0m15:00:34.049216 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962E8D910>]}
[0m15:00:34.051327 [info ] [Thread-2  ]: 14 of 27 OK created sql view model dbt_dw_stg.stg_lead_time .................... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m15:00:34.055062 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_lead_time
[0m15:00:34.694910 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:34.698351 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:35.295198 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4b058563-b6eb-4b66-be7d-07c896f8a29d&page=queryresults
[0m15:00:38.157215 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:33.818396 => 15:00:38.156696
[0m15:00:38.158764 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961CFC970>]}
[0m15:00:38.159821 [info ] [Thread-1  ]: 15 of 27 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.4 MiB processed)[0m in 4.39s]
[0m15:00:38.162426 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:38.167669 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:38.171908 [info ] [Thread-2  ]: 16 of 27 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m15:00:38.178242 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_lead_time, now model.shibaribrasil.tb_produto)
[0m15:00:38.182160 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:38.192289 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:38.194440 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:38.184813 => 15:00:38.193900
[0m15:00:38.194440 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:38.199462 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:38.929680 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:38.932529 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_lead_time as (
    select distinct
           ds_origem_produto
          ,qt_lead_time
          ,qt_cobertura_desejada
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_lead_time`
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,d.qt_lead_time
          ,d.qt_cobertura_desejada
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
 left join cte_lead_time              as d
        on b.ds_origem_produto = d.ds_origem_produto     
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m15:00:39.622928 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:31f5e52a-d12a-44d8-bd37-4fe5bc7f286a&page=queryresults
[0m15:00:42.735202 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:38.196184 => 15:00:42.734156
[0m15:00:42.739447 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DC6250>]}
[0m15:00:42.743044 [info ] [Thread-2  ]: 16 of 27 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (354.0 rows, 1.9 MiB processed)[0m in 4.56s]
[0m15:00:42.748742 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:42.754718 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:42.761958 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m15:00:42.758445 [info ] [Thread-1  ]: 17 of 27 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:00:42.771552 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:42.765669 [info ] [Thread-2  ]: 18 of 27 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m15:00:42.776981 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:42.778615 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m15:00:42.793023 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m15:00:42.800854 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m15:00:42.807597 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:42.818143 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 15:00:42.793023 => 15:00:42.814549
[0m15:00:42.820768 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:42.780253 => 15:00:42.820239
[0m15:00:42.821822 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m15:00:42.826254 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:42.840386 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:42.872315 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:43.691990 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m15:00:43.699713 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:43.708007 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m15:00:43.714411 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:44.426391 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3665fa36-9d00-46cf-8786-f661c263b44c&page=queryresults
[0m15:00:44.440367 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5306f392-a042-4dad-8268-e970559506fe&page=queryresults
[0m15:00:46.664146 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:42.841387 => 15:00:46.664146
[0m15:00:46.664668 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DF2B80>]}
[0m15:00:46.666259 [info ] [Thread-1  ]: 17 of 27 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 107.2 KiB processed)[0m in 3.90s]
[0m15:00:46.670309 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:46.673983 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m15:00:46.678215 [info ] [Thread-1  ]: 19 of 27 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m15:00:46.683351 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m15:00:46.686576 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m15:00:46.708796 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:46.711894 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 15:00:46.688720 => 15:00:46.711894
[0m15:00:46.713589 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m15:00:46.718556 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:47.298673 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 15:00:42.828463 => 15:00:47.298673
[0m15:00:47.298673 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DC8550>]}
[0m15:00:47.300280 [info ] [Thread-2  ]: 18 of 27 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (153.0 rows, 113.1 KiB processed)[0m in 4.52s]
[0m15:00:47.302363 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m15:00:47.303387 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m15:00:47.306005 [info ] [Thread-2  ]: 20 of 27 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m15:00:47.310723 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m15:00:47.314479 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m15:00:47.340252 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m15:00:47.347280 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 15:00:47.316079 => 15:00:47.343914
[0m15:00:47.350478 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m15:00:47.369387 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:47.464921 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:47.472743 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:47.875446 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2764f64-24c6-4d36-a63b-6deeee30b772&page=queryresults
[0m15:00:48.435518 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m15:00:48.441410 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m15:00:49.136579 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:429a6b75-0870-4462-b201-e265273333d9&page=queryresults
[0m15:00:49.881518 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 15:00:46.715243 => 15:00:49.880518
[0m15:00:49.888066 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D961CFC970>]}
[0m15:00:49.893108 [info ] [Thread-1  ]: 19 of 27 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (354.0 rows, 86.9 KiB processed)[0m in 3.21s]
[0m15:00:49.899691 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m15:00:49.902720 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:49.907216 [info ] [Thread-1  ]: 21 of 27 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m15:00:49.913291 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m15:00:49.916814 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:49.933170 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m15:00:49.935165 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 15:00:49.918849 => 15:00:49.934189
[0m15:00:49.936696 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:50.113080 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:50.945272 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m15:00:50.947469 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m15:00:51.317215 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd78f676-5f66-4c6c-8af3-e6f1a2bb2d52&page=queryresults
[0m15:00:51.964950 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 15:00:47.363469 => 15:00:51.964950
[0m15:00:51.966664 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D963EC9FA0>]}
[0m15:00:51.966664 [info ] [Thread-2  ]: 20 of 27 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.66s]
[0m15:00:51.969317 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m15:00:51.973137 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:51.979010 [info ] [Thread-2  ]: 22 of 27 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m15:00:51.986573 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m15:00:51.988148 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m15:00:52.006303 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:52.007590 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 15:00:51.988148 => 15:00:52.007590
[0m15:00:52.008637 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m15:00:52.010800 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:52.709266 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:52.712994 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m15:00:53.067093 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e66bcdcd-d980-4711-94f2-31edbf167f67&page=queryresults
[0m15:00:53.320792 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 15:00:49.936696 => 15:00:53.319191
[0m15:00:53.325235 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D963F2EDC0>]}
[0m15:00:53.329645 [info ] [Thread-1  ]: 21 of 27 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (153.0 rows, 36.4 KiB processed)[0m in 3.41s]
[0m15:00:53.335232 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:53.340511 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m15:00:53.344732 [info ] [Thread-1  ]: 23 of 27 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m15:00:53.347362 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m15:00:53.348999 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m15:00:53.362398 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m15:00:53.364599 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 15:00:53.348999 => 15:00:53.364599
[0m15:00:53.366227 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m15:00:53.374951 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:54.357637 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m15:00:54.359730 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m15:00:54.997740 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c894e3b-4de5-4bd1-a2d4-623578cd1d88&page=queryresults
[0m15:00:55.048844 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 15:00:52.008637 => 15:00:55.043983
[0m15:00:55.049368 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962EBCCA0>]}
[0m15:00:55.050982 [info ] [Thread-2  ]: 22 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 421.8 KiB processed)[0m in 3.06s]
[0m15:00:55.055720 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:55.064174 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:55.067387 [info ] [Thread-2  ]: 24 of 27 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m15:00:55.069459 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m15:00:55.071015 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:55.094729 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:55.101757 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:00:55.071536 => 15:00:55.099669
[0m15:00:55.102791 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:55.116538 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:55.868481 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:55.876794 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:00:56.281526 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7aebb584-3cd7-4e37-9fd5-46b4206ea75a&page=queryresults
[0m15:00:58.122276 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 15:00:53.366805 => 15:00:58.121246
[0m15:00:58.123378 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D963ED3E80>]}
[0m15:00:58.525661 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:00:55.104009 => 15:00:58.525661
[0m15:00:58.529340 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962D71F40>]}
[0m15:00:58.881440 [info ] [Thread-1  ]: 23 of 27 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (36.0 rows, 108.2 KiB processed)[0m in 4.78s]
[0m15:00:58.884076 [info ] [Thread-2  ]: 24 of 27 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 300.0 KiB processed)[0m in 3.46s]
[0m15:00:58.889517 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m15:00:58.894180 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:58.900513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m15:00:58.905895 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:00:58.909053 [info ] [Thread-1  ]: 25 of 27 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m15:00:58.913363 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m15:00:58.914581 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m15:00:58.926076 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m15:00:58.912314 [info ] [Thread-2  ]: 26 of 27 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m15:00:58.931521 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m15:00:58.937877 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m15:00:58.962012 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:58.964160 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 15:00:58.914581 => 15:00:58.964160
[0m15:00:58.964160 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m15:00:58.969949 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:59.070138 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 15:00:58.948954 => 15:00:59.067087
[0m15:00:59.073137 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m15:00:59.082755 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:59.735333 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m15:00:59.736898 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:59.842737 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:59.851441 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m15:01:00.209825 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6471ca06-34a0-43d2-bf0a-9c7403b89d43&page=queryresults
[0m15:01:00.357430 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41a5c1c9-5991-4afe-9282-7e5b8d225f5c&page=queryresults
[0m15:01:03.063449 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 15:00:59.074138 => 15:01:03.060794
[0m15:01:03.067292 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DDD790>]}
[0m15:01:03.072313 [info ] [Thread-2  ]: 26 of 27 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 126.3 KiB processed)[0m in 4.14s]
[0m15:01:03.077843 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:01:03.082628 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:01:03.087848 [info ] [Thread-2  ]: 27 of 27 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m15:01:03.094198 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m15:01:03.097187 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:01:03.121386 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:01:03.129646 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:01:03.098836 => 15:01:03.128591
[0m15:01:03.133022 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:01:03.158360 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:01:03.864505 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:01:03.867489 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, a.vl_custo_total) vl_custo_total
          ,coalesce(nullif(a.vl_preco_venda_por,0), a.vl_preco_venda) vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.qt_lead_time
          ,a.qt_cobertura_desejada
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
         ,b.qt_lead_time                     as qt_lead_time
         ,b.qt_cobertura_desejada            as qt_cobertura_desejada
         ,b.dt_ultima_ingestao               as dt_ultima_ingestao
     from cte_venda_produto        as a
         ,cte_tempo_mes_atual      as c
         ,cte_tempo_mes_anterior   as d
         ,cte_tempo_tres_meses     as e
left join cte_produto              as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
          ,vl_item
          ,lk_produto_compra
          ,ds_status_compra
          ,nr_seq
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    -- where ds_status_compra in ('EM ABERTO')
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
   select a.cd_produto_bling                                 as cd_produto_bling
         ,a.cd_produto                                       as cd_produto
         ,a.cd_codigo_barras                                 as cd_codigo_barras
         ,a.nm_produto                                       as nm_produto
         ,a.nm_produto_completo                              as nm_produto_completo
         ,a.ds_variacao                                      as ds_variacao
         ,a.ds_subcategoria                                  as ds_subcategoria
         ,a.ds_categoria                                     as ds_categoria
         ,a.ds_classificacao_produto                         as ds_classificacao_produto
         ,a.ds_origem_produto                                as ds_origem_produto
         ,a.qt_lead_time                                     as qt_lead_time
         ,a.qt_cobertura_desejada                            as qt_cobertura_desejada
         ,a.ds_classificacao_abc                             as ds_classificacao_abc
         ,a.vl_percentual_participacao                       as vl_percentual_participacao
         ,if(c.cd_produto_bling  is null, false, true)       as fg_produto_fabricado
         ,a.qt_estoque_minimo                                as qt_estoque_minimo
         ,a.qt_estoque_atual                                 as qt_estoque_atual
         ,a.vl_custo_total                                   as vl_custo_total
         ,a.vl_preco_venda                                   as vl_preco_venda
         ,sum(b.qt_item)                                     as qt_item_compra_pendente
         ,max(b.vl_item)                                     as vl_item_compra_pendente
         ,a.qt_pecas_mes_atual                               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior                            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses                              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias                           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior                             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses                               as qt_dias_tres_meses
         ,a.dt_ultima_ingestao                               as dt_ultima_ingestao
         ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
         ,d.lk_produto_compra                                as lk_produto_compra
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
      and b.ds_status_compra in ('EM ABERTO')
left join cte_compra_produto     as d
       on a.cd_produto_bling = d.cd_produto_bling
      and d.nr_seq = 1
left join cte_produto_fabricado  as c
       on a.cd_produto_bling = c.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.qt_lead_time   
         ,a.qt_cobertura_desejada 
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,c.cd_produto_bling
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
         ,a.dt_ultima_ingestao
         ,d.lk_produto_compra
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:01:04.136749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 15:00:58.965789 => 15:01:04.134064
[0m15:01:04.142151 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962D4A8B0>]}
[0m15:01:04.146350 [info ] [Thread-1  ]: 25 of 27 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (354.0 rows, 99.1 KiB processed)[0m in 5.23s]
[0m15:01:04.151715 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m15:01:04.528278 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:27c6c9e9-74d7-4286-bf4a-5bac4e8863ea&page=queryresults
[0m15:01:08.931712 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:01:03.135672 => 15:01:08.929520
[0m15:01:08.950774 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7e58cd-d8bc-4f47-8dac-7cd9c92e8fdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D962DDFC40>]}
[0m15:01:08.952830 [info ] [Thread-2  ]: 27 of 27 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.3 MiB processed)[0m in 5.86s]
[0m15:01:08.954885 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:01:08.961236 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:01:08.962835 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:01:08.963359 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:01:08.963359 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:01:08.964408 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:01:08.964941 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m15:01:08.964941 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:01:08.965961 [info ] [MainThread]: 
[0m15:01:08.967134 [info ] [MainThread]: Finished running 14 view models, 13 table models in 0 hours 0 minutes and 49.86 seconds (49.86s).
[0m15:01:08.984255 [debug] [MainThread]: Command end result
[0m15:01:09.005721 [info ] [MainThread]: 
[0m15:01:09.006759 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:01:09.009414 [info ] [MainThread]: 
[0m15:01:09.012750 [info ] [MainThread]: Done. PASS=27 WARN=0 ERROR=0 SKIP=0 TOTAL=27
[0m15:01:09.016351 [debug] [MainThread]: Command `dbt run` succeeded at 15:01:09.016351 after 54.19 seconds
[0m15:01:09.017427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D95E3133D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9619E4460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9618A56A0>]}
[0m15:01:09.017427 [debug] [MainThread]: Flushing usage events
[0m15:01:25.567558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002699FD13430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002699EC99940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002699EC99B80>]}


============================== 15:01:25.596637 | 1c7a15ee-4156-4c55-b074-7c884f6accc4 ==============================
[0m15:01:25.596637 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:01:25.598299 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:01:29.158728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A1E5AA60>]}
[0m15:01:29.501627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A337E430>]}
[0m15:01:29.505158 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:01:29.537669 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:01:29.876875 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:01:29.877945 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:01:29.899312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A3677610>]}
[0m15:01:29.953638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A356B430>]}
[0m15:01:29.955670 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:01:29.957241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A356B250>]}
[0m15:01:29.963296 [info ] [MainThread]: 
[0m15:01:29.966864 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:01:29.970935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:01:29.972980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:31.051982 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:01:31.054171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:31.057594 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:01:31.060088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:31.900757 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m15:01:31.906177 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:01:32.040501 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:01:32.056817 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:01:32.807928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002699EC99040>]}
[0m15:01:32.812251 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:01:32.814317 [info ] [MainThread]: 
[0m15:01:32.829819 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:01:32.832492 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m15:01:32.838903 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m15:01:32.840989 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:01:32.908494 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 15:01:32.844271 => 15:01:32.906353
[0m15:01:32.911097 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:01:33.223966 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:01:33.233432 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m15:01:34.162638 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05bee1d9-078c-476c-8b23-57bf09b0aed5&page=queryresults
[0m15:01:35.519464 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m15:01:35.929575 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8acb2f3d-138e-4efe-b5d9-34f6a6b824c6&page=queryresults
[0m15:01:38.383236 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m15:01:39.199779 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m15:01:39.207265 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m15:01:39.648862 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d1ca143-baee-4cde-98cd-92ae735fccdd&page=queryresults
[0m15:01:41.713195 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 15:01:32.912882 => 15:01:41.713195
[0m15:01:41.714742 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c7a15ee-4156-4c55-b074-7c884f6accc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A472A0D0>]}
[0m15:01:41.716279 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 226.3 KiB processed)[0m in 8.88s]
[0m15:01:41.718384 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:01:41.723112 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:01:41.734916 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:01:41.740701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:01:41.746927 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:01:41.749553 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m15:01:41.751128 [info ] [MainThread]: 
[0m15:01:41.753797 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.79 seconds (11.79s).
[0m15:01:41.760161 [debug] [MainThread]: Command end result
[0m15:01:41.836605 [info ] [MainThread]: 
[0m15:01:41.838730 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:01:41.840822 [info ] [MainThread]: 
[0m15:01:41.847613 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:01:41.850211 [debug] [MainThread]: Command `dbt snapshot` succeeded at 15:01:41.850211 after 16.66 seconds
[0m15:01:41.851825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002699FD13430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A337E430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000269A3657FA0>]}
[0m15:01:41.852872 [debug] [MainThread]: Flushing usage events
[0m15:01:53.716702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C34B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C3C589A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C243DD30>]}


============================== 15:01:53.741722 | f9bb7f32-949f-40ee-9aea-70e4758c20f8 ==============================
[0m15:01:53.741722 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:01:53.744404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:01:57.962887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C55F59D0>]}
[0m15:01:58.544683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C5DFB970>]}
[0m15:01:58.555578 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:01:58.609587 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:01:59.203794 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:01:59.204834 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:01:59.255126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6E18550>]}
[0m15:01:59.323022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6D13370>]}
[0m15:01:59.326819 [info ] [MainThread]: Found 29 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:01:59.329005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6D13160>]}
[0m15:01:59.332469 [info ] [MainThread]: 
[0m15:01:59.337707 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:01:59.345678 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:01:59.347792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:00.702575 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:02:00.706880 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:00.714491 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:02:00.721149 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:01.819394 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:02:01.827644 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:02:01.948439 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:02:01.968804 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:02:02.957324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6E24B80>]}
[0m15:02:02.962541 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:02:02.966301 [info ] [MainThread]: 
[0m15:02:02.992727 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:02:02.995884 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m15:02:02.999440 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m15:02:03.001126 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:02:03.050879 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:02:03.058269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 15:02:03.001126 => 15:02:03.057237
[0m15:02:03.065177 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:02:03.142556 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:02:04.172975 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:02:04.175654 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m15:02:04.606131 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0db396e3-499d-471b-96a1-ad2d80676c66&page=queryresults
[0m15:02:07.603385 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 15:02:03.066811 => 15:02:07.602863
[0m15:02:07.605464 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C7E92BE0>]}
[0m15:02:07.608087 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (2.0k rows, 193.1 KiB processed)[0m in 4.61s]
[0m15:02:07.616872 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:02:07.621132 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:02:07.627011 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m15:02:07.633288 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m15:02:07.636977 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:02:07.662984 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:02:07.670653 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:02:07.639040 => 15:02:07.669023
[0m15:02:07.675777 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:02:07.702825 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:02:08.545495 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:02:08.554069 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:02:08.970761 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad2f8fe9-3bf9-4b4a-b03a-331836ca702d&page=queryresults
[0m15:02:10.954942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:02:07.697932 => 15:02:10.953333
[0m15:02:10.956562 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f9bb7f32-949f-40ee-9aea-70e4758c20f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C7EA2BB0>]}
[0m15:02:10.958198 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (474.0 rows, 204.2 KiB processed)[0m in 3.32s]
[0m15:02:10.963452 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:02:10.976906 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:02:10.979572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:02:10.981140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:02:10.984212 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:02:10.984212 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m15:02:10.985239 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:02:10.986796 [info ] [MainThread]: 
[0m15:02:10.989437 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.65 seconds (11.65s).
[0m15:02:10.997850 [debug] [MainThread]: Command end result
[0m15:02:11.071160 [info ] [MainThread]: 
[0m15:02:11.073165 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:02:11.075164 [info ] [MainThread]: 
[0m15:02:11.077759 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m15:02:11.083744 [debug] [MainThread]: Command `dbt run` succeeded at 15:02:11.082744 after 17.79 seconds
[0m15:02:11.086996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C34B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6BEB0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0C6BA34C0>]}
[0m15:02:11.090073 [debug] [MainThread]: Flushing usage events
